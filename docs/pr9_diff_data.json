{
  "pr": 9,
  "base_branch": "main",
  "head_branch": "df-crank-v01-pong-interfaces",
  "head_sha": "48ec8a4",
  "head_sha_full": "48ec8a4cf8ef9b3de27230738e7616cfd874d22f",
  "total_files": 45,
  "total_additions": 2999,
  "total_deletions": 319,
  "files": {
    ".claude/skills/factory-orchestrate/SKILL.md": {
      "additions": 98,
      "deletions": 27,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/.claude/skills/factory-orchestrate/SKILL.md b/.claude/skills/factory-orchestrate/SKILL.md\nindex 449069d..cc2a0c7 100644\n--- a/.claude/skills/factory-orchestrate/SKILL.md\n+++ b/.claude/skills/factory-orchestrate/SKILL.md\n@@ -8,14 +8,24 @@ allowed-tools: Bash, Read, Write, Glob, Grep, Edit\n \n You are the factory orchestrator. You run the convergence loop that turns specs into working software through iterative AI coding + validation.\n \n+## Crank Lifecycle\n+\n+A factory crank progresses through three states:\n+- **IN PROGRESS** \u2014 iterating (Codex coding, gates running, feedback looping)\n+- **CONVERGED** \u2014 ALL scenarios passing, PR created with review pack, pending human merge decision\n+- **COMPLETE** \u2014 factory branch merged to main\n+\n+A crank is NOT complete until the factory branch is merged to main. Convergence is necessary but not sufficient \u2014 the human accept/merge gate is what completes a crank.\n+\n ## Prerequisites\n \n - Chrome is logged into Codex (ChatGPT Plus account)\n - Repository: `joeyfezster/building_ai_w_ai`\n - Branch to base work on: confirm with user or default to `factory/v1`\n-- Satisfaction threshold: confirm with user or default to 80%\n - Max iterations: confirm with user or default to 5\n \n+**Convergence requires ALL scenarios passing.** There is no percentage threshold \u2014 a single failing scenario blocks convergence, regardless of cause (regression, merge conflict, transient issue, or new failure). The factory owns its output quality end-to-end. Never declare convergence with a failing scenario, and never excuse a failure by attributing it to a previous iteration or the base branch.\n+\n ## The Loop\n \n For each iteration:\n@@ -49,42 +59,84 @@ Open the Codex UI in Chrome. Provide:\n \n Codex will create its own branch (named `codex-...`). Wait for it to finish.\n \n-### Step 4: Gate 0 \u2014 Adversarial Code Review (Agent Team)\n+### Step 4: Gate 0 \u2014 Two-Tier Code Review (Script + Agent Team)\n \n-Before merging Codex's changes, run a **full adversarial review via agent teams**. This is the first line of defense \u2014 there is no point sending code to CI or later gates if Gate 0 finds critical issues.\n+Before merging Codex's changes, run a **full two-tier review**. This is the first line of defense \u2014 there is no point sending code to CI or later gates if Gate 0 finds critical issues.\n \n 1. Fetch Codex's branch: `git fetch origin`\n 2. Get the diff: `git diff df-crank-vXX...origin/codex-{branch}`\n \n-3. **Spawn the Gate 0 agent team.** Create a team and launch these agents in parallel:\n+#### Tier 1: Deterministic Tool Checks\n+\n+Run the Gate 0 deterministic runner. This executes all 5 tool checks in parallel and produces a JSON artifact:\n+\n+```bash\n+python scripts/run_gate0.py\n+# Produces: artifacts/factory/gate0_results.json\n+```\n \n-   **Tool agents** (deterministic, Bash-capable \u2014 run ALL simultaneously):\n-   | Agent | What It Runs | What It Catches |\n-   |-------|-------------|-----------------|\n-   | `ruff-agent` | `python scripts/nfr_checks.py --check code_quality` | Lint violations, style, import issues |\n-   | `radon-agent` | `python scripts/nfr_checks.py --check complexity` | Cyclomatic complexity > threshold |\n-   | `vulture-agent` | `python scripts/nfr_checks.py --check dead_code` | Unreachable code, unused functions |\n-   | `bandit-agent` | `python scripts/nfr_checks.py --check security` | Security vulnerabilities |\n-   | `test-quality-agent` | `python scripts/check_test_quality.py` | Vacuous tests, stub assertions, mock abuse |\n+| Check | Tool | What It Catches |\n+|-------|------|-----------------|\n+| `code_quality` | ruff (extended) | Lint violations, style, import issues |\n+| `complexity` | radon | Cyclomatic complexity > threshold |\n+| `dead_code` | vulture | Unreachable code, unused functions |\n+| `security` | bandit | Security vulnerability patterns |\n+| `test_quality` | check_test_quality.py | Vacuous tests, stub assertions, mock abuse |\n \n-   **Semantic reviewer** (LLM-based, runs in parallel with tool agents):\n-   | Agent | What It Reads | What It Catches |\n-   |-------|--------------|-----------------|\n-   | `adversarial-reviewer` | The diff + `.github/codex/prompts/adversarial_review.md` + `docs/code_quality_standards.md` + `/specs/*.md` | Gaming, architectural dishonesty, spec violations, integration gaps, subtle patterns the tools miss |\n+**Tier 1 is necessary but insufficient.** These tools operate at the AST/regex level. They catch the obvious stuff fast \u2014 but a sophisticated agent can game them. Tier 2 builds on tier 1 output.\n \n-4. **Aggregate findings.** Collect all agent outputs. Each finding has a severity: CRITICAL, WARNING, or NIT.\n+#### Tier 2: LLM Semantic Review Agents\n+\n+3. **Spawn the Tier 2 agent team.** Use `TeamCreate` and launch these 4 agents in parallel via the `Task` tool. Each agent receives: the diff, the tier 1 results (`gate0_results.json`), and its paradigm-specific review prompt from `.claude/skills/factory-orchestrate/review-prompts/`.\n+\n+   | Agent | Paradigm Review Prompt | Paradigm |\n+   |-------|----------------------|----------|\n+   | `code-health-reviewer` | `code_health_review.md` | Code quality + complexity + dead code |\n+   | `security-reviewer` | `security_review.md` | Security vulnerabilities |\n+   | `test-integrity-reviewer` | `test_integrity_review.md` | Test quality and integrity |\n+   | `adversarial-reviewer` | `adversarial_review.md` | Holistic: gaming, spec violations, architectural dishonesty |\n+\n+   Each agent also receives: `gate0_results.json` (tier 1 findings) + `docs/code_quality_standards.md` + the diff. The adversarial reviewer additionally receives `/specs/*.md`.\n+\n+4. **Aggregate findings.** Collect all tier 2 agent outputs + tier 1 results. Each finding has a severity: CRITICAL, WARNING, or NIT.\n+\n+5. **Fail-fast rule:** If **any tier** (1 or 2) reports a CRITICAL finding, Gate 0 fails. Do NOT proceed to later gates (1-3). However, **DO merge Codex's changes onto the factory branch** so that iteration N+1 is incremental \u2014 Codex iterates on its own code with feedback, rather than rebuilding from scratch. Compile all findings (from both tiers) as feedback and loop back to Step 3 with specific remediation instructions.\n+\n+   **Gate 0 failure workflow:**\n+   ```bash\n+   # 1. Merge Codex's code (keep it for incremental iteration)\n+   git merge origin/codex-{branch} --no-ff -m \"factory: merge codex iteration N (Gate 0 blocked \u2014 iterating)\"\n+   # 2. Delete Codex's remote branch (consumed by merge, prevent branch pollution)\n+   git push origin --delete codex-{branch}\n+   # 3. Commit feedback file\n+   git add artifacts/factory/feedback_iter_N.md\n+   git commit -m \"factory: Gate 0 feedback for iteration N\"\n+   # 4. Push \u2014 Codex's next run sees its own code + feedback\n+   git push\n+   # 5. Loop back to Step 3 (invoke Codex again)\n+   ```\n \n-5. **Fail-fast rule:** If **any agent** reports a CRITICAL finding, Gate 0 fails. Do NOT merge. Compile all findings (from all agents) as feedback and loop back to Step 3 with specific remediation instructions.\n+   **NEVER revert Codex's merge on Gate 0 failure.** Reverting forces Codex to rebuild from zero, wasting an iteration. The feedback is specific enough to guide incremental fixes. The code is \"wrong but close\" \u2014 keep it and steer.\n \n-**If clean or WARNING-only across all agents**: Proceed to Step 5. WARNING findings are tracked \u2014 they feed into the LLM-as-judge evaluation in Step 10.\n+**If clean or WARNING-only across both tiers**: Proceed to Step 5. WARNING findings are tracked \u2014 they feed into the LLM-as-judge evaluation in Step 10.\n \n-**Why agent teams, not a single reviewer:** The tool agents catch cheap, obvious violations in seconds (dead code, complexity, security). The semantic reviewer catches subtle gaming and architectural dishonesty. Running them in parallel means Gate 0 is both fast AND thorough. A single reviewer doing everything sequentially is slower and more likely to miss things.\n+**Why two tiers, not just tools or just LLMs:** Tools are fast, cheap, and deterministic \u2014 they catch the obvious stuff in seconds. But they operate at the AST/regex level and can be gamed by a sophisticated agent. LLM agents review through the same paradigms at a higher caliber \u2014 they catch semantic dead code, meaningful test gaps, and subtle gaming that tools miss. Running both tiers means Gate 0 is fast AND deep. Neither tier alone is sufficient.\n \n ### Step 5: Merge Codex Changes\n ```bash\n git merge origin/codex-{branch} --no-ff -m \"factory: merge codex iteration N\"\n ```\n \n+### Step 5a: Delete Codex's Remote Branch\n+\n+**Immediately after merging**, delete Codex's branch from origin. The factory is branch-heavy \u2014 stale Codex branches pollute the namespace and create confusion about which branch is current. The code is preserved in the merge commit on the factory branch.\n+\n+```bash\n+git push origin --delete codex-{branch}\n+```\n+\n+This applies to EVERY merge \u2014 whether Gate 0 passes or fails. The Codex branch is consumed by the merge; it has no further purpose.\n+\n ### Step 5b: Check CI Results\n \n After pushing, check CI results. CI runs Gates 1-3 on every push to factory/** branches. Use CI results as early signal before running gates locally.\n@@ -140,9 +192,11 @@ python scripts/run_scenarios.py --timeout 180\n \n Produces `artifacts/factory/scenario_results.json` with satisfaction score.\n \n+**Hard gate: if ANY scenario fails, the crank has NOT converged.** Do not proceed to Step 10. Compile feedback and loop back to Step 3. The satisfaction score is a trajectory metric (is progress being made?) \u2014 it is NOT the convergence criterion. Convergence = zero failures.\n+\n ### Step 10: LLM-as-Judge \u2014 Holistic Evaluation\n \n-You ARE the judge. Don't just check `satisfaction_score >= threshold`. Reason through:\n+You ARE the judge. All scenarios passed \u2014 but passing is necessary, not sufficient. Reason through:\n \n 1. **Satisfaction trajectory**: Is the score improving across iterations? Plateaued? Regressing?\n 2. **Failure patterns**: Are the same scenarios failing repeatedly? Different ones each time?\n@@ -154,6 +208,22 @@ You ARE the judge. Don't just check `satisfaction_score >= threshold`. Reason th\n **If satisfied**: Proceed to Step 11.\n **If not satisfied**: Compile feedback with your holistic assessment, loop to Step 3.\n \n+### Step 10b: Resolve Bot Reviewer Comments\n+\n+After the PR is created, bot reviewers (Copilot, Codex connector) post comments recommending changes. The orchestrator evaluates and routes each one \u2014 the goal is to fix everything now, not carry tech debt.\n+\n+**Workflow:**\n+1. Read all unresolved PR review threads (after CI completes \u2014 bots post after CI).\n+2. **Evaluate each comment.** Bot reviewers can be wrong. For each recommendation, reason about: Is it valid? Is it in scope? What severity does it actually warrant?\n+3. **Route by who can fix it:**\n+   - **Orchestrator's agent team** (non-product: infra, config, dependency compilation, docs, CI): Spawn an agent to fix it directly. Push the fix, resolve the thread.\n+   - **Attractor** (product code OR complex logic OR security issues OR code performance): Synthesize into `artifacts/factory/post_merge_feedback.md` \u2014 preserving the file path, line number, what was flagged, and the orchestrator's assessment. Then loop back to the attractor (new factory iteration via Step 3) with this feedback included.\n+   - **Invalid/false-positive**: Resolve the thread with a reply explaining why.\n+\n+**Every thread resolution MUST include a reply comment** explaining how it was resolved \u2014 what action was taken, by whom (orchestrator vs attractor), and where the evidence lives (commit SHA, feedback file path). Never resolve a thread silently.\n+\n+**Continuity across cranks:** When starting a new factory crank, check `artifacts/factory/post_merge_feedback.md` for items synthesized from the previous iteration's review comments. These must be included in the attractor's seed feedback so they are not dropped.\n+\n ### Step 11: Create PR (Accept/Merge Gate)\n ```bash\n gh pr create \\\n@@ -237,10 +307,11 @@ If after 3+ iterations:\n ## Reference Files\n \n - **Attractor prompt**: `.github/codex/prompts/factory_fix.md`\n-- **Adversarial review**: `.github/codex/prompts/adversarial_review.md`\n+- **Gate 0 tier 1 runner**: `scripts/run_gate0.py` (deterministic tool checks \u2192 `gate0_results.json`)\n+- **Gate 0 tier 2 review prompts**: `.claude/skills/factory-orchestrate/review-prompts/` (all paradigm docs in this directory)\n - **Code quality standards**: `docs/code_quality_standards.md`\n-- **NFR checks script**: `scripts/nfr_checks.py` (Gate 0 tool agents + Gate 2)\n-- **Test quality scanner**: `scripts/check_test_quality.py` (Gate 0 tool agent)\n+- **NFR checks script**: `scripts/nfr_checks.py` (Gate 0 tier 1 static analysis + Gate 2 NFR framework)\n+- **Test quality scanner**: `scripts/check_test_quality.py` (Gate 0 tier 1)\n - **PR review pack skill**: `.claude/skills/pr-review-pack/SKILL.md` (Step 12)\n - **Decision log**: `docs/decisions/decision_log.json` (Step 13, cumulative archive)\n - **Decision persistence**: `scripts/persist_decisions.py` (Step 13)\n@@ -252,11 +323,11 @@ If after 3+ iterations:\n \n ### Layered Defense Against Gaming\n The factory's quality defense is layered \u2014 no single gate is sufficient:\n-1. **Gate 0 tool agents** (agent team, parallel) \u2014 deterministic checks via vulture, radon, bandit, ruff, and `check_test_quality.py`. Catches dead code, complexity, security issues, lint violations, and obvious vacuous test patterns. Fast, cheap, runs in seconds. Risk: regex/AST-level analysis can be fooled by sophisticated gaming.\n-2. **Gate 0 adversarial reviewer** (agent team, parallel with tool agents) \u2014 LLM-based judgment catches subtle gaming, architectural dishonesty, spec violations, and patterns the static tools miss. Reads the full diff against code quality standards and specs.\n+1. **Gate 0 tier 1** (deterministic, `run_gate0.py`) \u2014 all 5 tool checks in parallel (ruff, radon, vulture, bandit, test-quality). Catches dead code, complexity, security issues, lint violations, and obvious vacuous test patterns. Fast, cheap, runs in seconds. Risk: AST/regex-level analysis can be fooled by sophisticated gaming.\n+2. **Gate 0 tier 2** (LLM agent team, parallel) \u2014 4 specialized agents review through the same paradigms at semantic depth. The code-health, security, and test-integrity reviewers build on tier 1 output. The adversarial reviewer reads the full diff holistically against specs and quality standards. Catches what tools miss: semantic dead code, auth bypasses, tests that prove nothing, gaming, architectural dishonesty.\n 3. **Gate 3 holdout scenarios** \u2014 behavioral evaluation against criteria the attractor never sees (ground truth). If the code actually works, gaming doesn't matter.\n \n-The tool agents and semantic reviewer run in parallel at Gate 0 as an agent team. Any CRITICAL finding from any agent stops the pipeline before merge. No single layer is sufficient. Tool agents catch the cheap stuff fast, the adversarial reviewer catches the clever stuff, and holdout scenarios verify actual behavior.\n+Tier 1 and tier 2 run at Gate 0 before merge. Any CRITICAL finding from either tier stops the pipeline. No single layer is sufficient \u2014 tools catch the cheap stuff fast, LLM agents catch the clever stuff, and holdout scenarios verify actual behavior.\n \n ### Iteration \u2192 Commit Model\n Each factory iteration produces ONE commit from Codex (via merge). This provides a clean diff for adversarial review and clear rollback boundaries. The commit message must include the iteration number for traceability.\n",
      "raw": "---\nname: factory-orchestrate\ndescription: Run the dark factory convergence loop. Use when the user says \"run a factory crank\", \"start the factory\", \"orchestrate a crank\", or similar. Orchestrates Codex via browser, manages holdout isolation, runs validation gates, and performs LLM-as-judge evaluation.\nallowed-tools: Bash, Read, Write, Glob, Grep, Edit\n---\n\n# Dark Factory Orchestration \u2014 Claude Code as Orchestrator\n\nYou are the factory orchestrator. You run the convergence loop that turns specs into working software through iterative AI coding + validation.\n\n## Crank Lifecycle\n\nA factory crank progresses through three states:\n- **IN PROGRESS** \u2014 iterating (Codex coding, gates running, feedback looping)\n- **CONVERGED** \u2014 ALL scenarios passing, PR created with review pack, pending human merge decision\n- **COMPLETE** \u2014 factory branch merged to main\n\nA crank is NOT complete until the factory branch is merged to main. Convergence is necessary but not sufficient \u2014 the human accept/merge gate is what completes a crank.\n\n## Prerequisites\n\n- Chrome is logged into Codex (ChatGPT Plus account)\n- Repository: `joeyfezster/building_ai_w_ai`\n- Branch to base work on: confirm with user or default to `factory/v1`\n- Max iterations: confirm with user or default to 5\n\n**Convergence requires ALL scenarios passing.** There is no percentage threshold \u2014 a single failing scenario blocks convergence, regardless of cause (regression, merge conflict, transient issue, or new failure). The factory owns its output quality end-to-end. Never declare convergence with a failing scenario, and never excuse a failure by attributing it to a previous iteration or the base branch.\n\n## The Loop\n\nFor each iteration:\n\n### Step 1: Create Factory Branch\n```bash\n# First crank \u2014 create from base branch\ngit checkout -b df-crank-v01-{descriptor} {base_branch}\ngit push -u origin df-crank-v01-{descriptor}\n```\n\nBranch naming: `df-crank-vXX-{descriptor}` where XX is the crank version.\n\n### Step 2: Strip Holdout\n```bash\npython scripts/strip_holdout.py\ngit push\n```\n\nThis deterministically removes `/scenarios/` and comments out scenario Makefile targets. Codex literally cannot see evaluation criteria.\n\nVerify: `ls scenarios/` should fail (directory gone).\n\n### Step 3: Invoke Codex via Browser\n\nOpen the Codex UI in Chrome. Provide:\n- **Repository**: `joeyfezster/building_ai_w_ai`\n- **Base branch**: `df-crank-vXX-{descriptor}` (the stripped branch)\n- **Prompt**: Contents of `.github/codex/prompts/factory_fix.md` + the latest feedback file (`artifacts/factory/feedback_iter_N.md`)\n- **Versions**: 1\n\nCodex will create its own branch (named `codex-...`). Wait for it to finish.\n\n### Step 4: Gate 0 \u2014 Two-Tier Code Review (Script + Agent Team)\n\nBefore merging Codex's changes, run a **full two-tier review**. This is the first line of defense \u2014 there is no point sending code to CI or later gates if Gate 0 finds critical issues.\n\n1. Fetch Codex's branch: `git fetch origin`\n2. Get the diff: `git diff df-crank-vXX...origin/codex-{branch}`\n\n#### Tier 1: Deterministic Tool Checks\n\nRun the Gate 0 deterministic runner. This executes all 5 tool checks in parallel and produces a JSON artifact:\n\n```bash\npython scripts/run_gate0.py\n# Produces: artifacts/factory/gate0_results.json\n```\n\n| Check | Tool | What It Catches |\n|-------|------|-----------------|\n| `code_quality` | ruff (extended) | Lint violations, style, import issues |\n| `complexity` | radon | Cyclomatic complexity > threshold |\n| `dead_code` | vulture | Unreachable code, unused functions |\n| `security` | bandit | Security vulnerability patterns |\n| `test_quality` | check_test_quality.py | Vacuous tests, stub assertions, mock abuse |\n\n**Tier 1 is necessary but insufficient.** These tools operate at the AST/regex level. They catch the obvious stuff fast \u2014 but a sophisticated agent can game them. Tier 2 builds on tier 1 output.\n\n#### Tier 2: LLM Semantic Review Agents\n\n3. **Spawn the Tier 2 agent team.** Use `TeamCreate` and launch these 4 agents in parallel via the `Task` tool. Each agent receives: the diff, the tier 1 results (`gate0_results.json`), and its paradigm-specific review prompt from `.claude/skills/factory-orchestrate/review-prompts/`.\n\n   | Agent | Paradigm Review Prompt | Paradigm |\n   |-------|----------------------|----------|\n   | `code-health-reviewer` | `code_health_review.md` | Code quality + complexity + dead code |\n   | `security-reviewer` | `security_review.md` | Security vulnerabilities |\n   | `test-integrity-reviewer` | `test_integrity_review.md` | Test quality and integrity |\n   | `adversarial-reviewer` | `adversarial_review.md` | Holistic: gaming, spec violations, architectural dishonesty |\n\n   Each agent also receives: `gate0_results.json` (tier 1 findings) + `docs/code_quality_standards.md` + the diff. The adversarial reviewer additionally receives `/specs/*.md`.\n\n4. **Aggregate findings.** Collect all tier 2 agent outputs + tier 1 results. Each finding has a severity: CRITICAL, WARNING, or NIT.\n\n5. **Fail-fast rule:** If **any tier** (1 or 2) reports a CRITICAL finding, Gate 0 fails. Do NOT proceed to later gates (1-3). However, **DO merge Codex's changes onto the factory branch** so that iteration N+1 is incremental \u2014 Codex iterates on its own code with feedback, rather than rebuilding from scratch. Compile all findings (from both tiers) as feedback and loop back to Step 3 with specific remediation instructions.\n\n   **Gate 0 failure workflow:**\n   ```bash\n   # 1. Merge Codex's code (keep it for incremental iteration)\n   git merge origin/codex-{branch} --no-ff -m \"factory: merge codex iteration N (Gate 0 blocked \u2014 iterating)\"\n   # 2. Delete Codex's remote branch (consumed by merge, prevent branch pollution)\n   git push origin --delete codex-{branch}\n   # 3. Commit feedback file\n   git add artifacts/factory/feedback_iter_N.md\n   git commit -m \"factory: Gate 0 feedback for iteration N\"\n   # 4. Push \u2014 Codex's next run sees its own code + feedback\n   git push\n   # 5. Loop back to Step 3 (invoke Codex again)\n   ```\n\n   **NEVER revert Codex's merge on Gate 0 failure.** Reverting forces Codex to rebuild from zero, wasting an iteration. The feedback is specific enough to guide incremental fixes. The code is \"wrong but close\" \u2014 keep it and steer.\n\n**If clean or WARNING-only across both tiers**: Proceed to Step 5. WARNING findings are tracked \u2014 they feed into the LLM-as-judge evaluation in Step 10.\n\n**Why two tiers, not just tools or just LLMs:** Tools are fast, cheap, and deterministic \u2014 they catch the obvious stuff in seconds. But they operate at the AST/regex level and can be gamed by a sophisticated agent. LLM agents review through the same paradigms at a higher caliber \u2014 they catch semantic dead code, meaningful test gaps, and subtle gaming that tools miss. Running both tiers means Gate 0 is fast AND deep. Neither tier alone is sufficient.\n\n### Step 5: Merge Codex Changes\n```bash\ngit merge origin/codex-{branch} --no-ff -m \"factory: merge codex iteration N\"\n```\n\n### Step 5a: Delete Codex's Remote Branch\n\n**Immediately after merging**, delete Codex's branch from origin. The factory is branch-heavy \u2014 stale Codex branches pollute the namespace and create confusion about which branch is current. The code is preserved in the merge commit on the factory branch.\n\n```bash\ngit push origin --delete codex-{branch}\n```\n\nThis applies to EVERY merge \u2014 whether Gate 0 passes or fails. The Codex branch is consumed by the merge; it has no further purpose.\n\n### Step 5b: Check CI Results\n\nAfter pushing, check CI results. CI runs Gates 1-3 on every push to factory/** branches. Use CI results as early signal before running gates locally.\n\n```bash\n# Wait for CI to complete (typically 2-5 minutes)\ngh run list --branch df-crank-vXX --limit 3\n\n# Check the PR's checks (if PR exists)\ngh pr checks <PR_NUMBER>\n```\n\n**Known `gh pr checks` behavior:**\n- `gh pr checks` shows checks associated with the PR's **merge ref**, not the branch HEAD directly\n- If a bot (GITHUB_TOKEN) pushes a commit that becomes PR HEAD, GitHub does NOT re-trigger CI workflows (prevents infinite loops). The PR may show \"0 checks\" even though CI ran fine on the previous commit.\n- Workaround: If you see stale/missing checks, use `gh run list --branch <branch>` instead \u2014 this shows actual workflow runs regardless of the merge ref.\n- Commits pushed by workflows using `GITHUB_TOKEN` do not trigger other workflows. This is a GitHub safety measure.\n- If CI results conflict with your local gate results, investigate \u2014 don't just ignore the discrepancy.\n\n**If CI fails**: Use the github.com's copilot's 'explain errors' as initial reference, check logs to validate and make up your own mind, compile actionable feedback (yourself), and loop back to Step 3.\n\n### Step 6: Restore Holdout\n```bash\npython scripts/restore_holdout.py\ngit add scenarios/ Makefile\ngit commit -m \"factory: restore holdout scenarios for evaluation\"\n```\n\n### Step 7: Gate 1 \u2014 Deterministic Validation\n```bash\nmake lint && make typecheck && make test\n```\n\n\"test\" = *should be* the FULL pytest suite, including any tests Codex wrote (already reviewed in Gate 0).\n\n**If fail**: Compile feedback (use this script as aid, but make sure you intervene if the feedback doesn't make sense: `python scripts/compile_feedback.py --iteration N`), loop to Step 3.\n\n### Step 8: Gate 2 \u2014 Non-Functional Requirements\n```bash\nmake nfr-check\n```\n\nThis runs all implemented NFR checks (code quality, complexity, dead code, security).\n\nGate 2 is **non-blocking** but findings are tracked and feed into:\n- The feedback for the next Codex iteration\n- Your LLM-as-judge evaluation in Step 10\n\n### Step 9: Gate 3 \u2014 Behavioral Scenarios\n```bash\npython scripts/run_scenarios.py --timeout 180\n```\n\nProduces `artifacts/factory/scenario_results.json` with satisfaction score.\n\n**Hard gate: if ANY scenario fails, the crank has NOT converged.** Do not proceed to Step 10. Compile feedback and loop back to Step 3. The satisfaction score is a trajectory metric (is progress being made?) \u2014 it is NOT the convergence criterion. Convergence = zero failures.\n\n### Step 10: LLM-as-Judge \u2014 Holistic Evaluation\n\nYou ARE the judge. All scenarios passed \u2014 but passing is necessary, not sufficient. Reason through:\n\n1. **Satisfaction trajectory**: Is the score improving across iterations? Plateaued? Regressing?\n2. **Failure patterns**: Are the same scenarios failing repeatedly? Different ones each time?\n3. **Fix quality**: Do Codex's changes look like real solutions or gaming attempts? (Gate 0 caught the obvious ones, but look for subtle patterns across iterations)\n4. **Gate 2 NFR findings**: Even though non-blocking, are there concerning patterns? Growing complexity? Dropping coverage?\n5. **Systemic issues**: Is there something the score doesn't capture? An architectural problem that will cause future failures?\n6. **Documentation currency**: Did this iteration's changes affect documented behavior? Check: Are specs in `/specs/` still accurate? Does the README reflect current state? Are factory docs (`dark_factory.md`, `code_quality_standards.md`) still correct? Stale documentation is technical debt \u2014 flag it in feedback if needed.\n\n**If satisfied**: Proceed to Step 11.\n**If not satisfied**: Compile feedback with your holistic assessment, loop to Step 3.\n\n### Step 10b: Resolve Bot Reviewer Comments\n\nAfter the PR is created, bot reviewers (Copilot, Codex connector) post comments recommending changes. The orchestrator evaluates and routes each one \u2014 the goal is to fix everything now, not carry tech debt.\n\n**Workflow:**\n1. Read all unresolved PR review threads (after CI completes \u2014 bots post after CI).\n2. **Evaluate each comment.** Bot reviewers can be wrong. For each recommendation, reason about: Is it valid? Is it in scope? What severity does it actually warrant?\n3. **Route by who can fix it:**\n   - **Orchestrator's agent team** (non-product: infra, config, dependency compilation, docs, CI): Spawn an agent to fix it directly. Push the fix, resolve the thread.\n   - **Attractor** (product code OR complex logic OR security issues OR code performance): Synthesize into `artifacts/factory/post_merge_feedback.md` \u2014 preserving the file path, line number, what was flagged, and the orchestrator's assessment. Then loop back to the attractor (new factory iteration via Step 3) with this feedback included.\n   - **Invalid/false-positive**: Resolve the thread with a reply explaining why.\n\n**Every thread resolution MUST include a reply comment** explaining how it was resolved \u2014 what action was taken, by whom (orchestrator vs attractor), and where the evidence lives (commit SHA, feedback file path). Never resolve a thread silently.\n\n**Continuity across cranks:** When starting a new factory crank, check `artifacts/factory/post_merge_feedback.md` for items synthesized from the previous iteration's review comments. These must be included in the attractor's seed feedback so they are not dropped.\n\n### Step 11: Create PR (Accept/Merge Gate)\n```bash\ngh pr create \\\n  --title \"[Factory] df-crank-vXX converged at {score}%\" \\\n  --body \"$(cat <<'EOF'\n## Dark Factory \u2014 Converged\n\n**Satisfaction score: {score}%**\n**Iterations: {N}**\n**Gate 2 NFR status: {summary}**\n\n### Accept/Merge Gate\nThis PR was produced by the dark factory convergence loop, orchestrated by Claude Code.\n\n**Before merging, verify:**\n- [ ] Satisfaction score meets your quality bar\n- [ ] Review latest feedback for residual warnings\n- [ ] Gate 2 NFR findings are acceptable\n- [ ] No unexpected files or dependencies introduced\n\n**To merge:** Approve and merge. The factory branch can then be deleted.\n**To reject:** Close this PR and either adjust scenarios/specs or trigger another crank.\nEOF\n)\" \\\n  --label factory-converged --label accept-merge-gate\n```\n\n### Step 12: Generate PR Review Pack\n\nAfter creating the PR, invoke the `/pr-review-pack` skill to generate the interactive HTML review pack. This is how the human project lead reviews the factory's output \u2014 they review the report, not the code.\n\nThe review pack gives the project lead:\n- Architecture diagram showing which zones were touched\n- Adversarial findings (from Gate 0 agent team) graded by file\n- CI performance with health classification\n- Key decisions with zone-level traceability\n- Convergence result (gate-by-gate status)\n- Post-merge items with code snippets and failure/success scenarios\n- Factory history (iteration timeline, gate findings per iteration)\n\n```\n/pr-review-pack {PR_NUMBER}\n```\n\nThe review pack is the artifact that communicates factory status to the human. Without it, the accept/merge gate is a rubber stamp.\n\n### Step 13: Post-Merge Persistence\n\nAfter the project lead merges the PR:\n\n1. **Persist decisions** to the cumulative log:\n   ```bash\n   python scripts/persist_decisions.py --pr {PR_NUMBER}\n   ```\n   The script extracts decisions from the review pack HTML (or from the JSON intermediate if available via `--data`) and appends them to `docs/decisions/decision_log.json`. It is idempotent \u2014 safe to run multiple times.\n\n2. **Create post-merge issues** (if applicable):\n   ```bash\n   python scripts/create_postmerge_issues.py --pr {PR_NUMBER}\n   ```\n\n3. **Commit and push** the updated decision log:\n   ```bash\n   git add docs/decisions/decision_log.json\n   git commit -m \"decisions: persist PR #{PR_NUMBER} decisions\"\n   git push\n   ```\n\n4. **Delete Codex's remote branch** (cleanup):\n   ```bash\n   git push origin --delete codex-{branch}\n   ```\n\n### Stall Protocol\n\nIf after 3+ iterations:\n- Same scenario fails with same error \u2192 the spec or scenario may need adjustment. Escalate to the project lead.\n- Score oscillates without converging \u2192 architectural issue. Escalate.\n- Gate 0 keeps finding critical issues \u2192 attractor needs stronger constraints. Update `factory_fix.md`.\n\n## Reference Files\n\n- **Attractor prompt**: `.github/codex/prompts/factory_fix.md`\n- **Gate 0 tier 1 runner**: `scripts/run_gate0.py` (deterministic tool checks \u2192 `gate0_results.json`)\n- **Gate 0 tier 2 review prompts**: `.claude/skills/factory-orchestrate/review-prompts/` (all paradigm docs in this directory)\n- **Code quality standards**: `docs/code_quality_standards.md`\n- **NFR checks script**: `scripts/nfr_checks.py` (Gate 0 tier 1 static analysis + Gate 2 NFR framework)\n- **Test quality scanner**: `scripts/check_test_quality.py` (Gate 0 tier 1)\n- **PR review pack skill**: `.claude/skills/pr-review-pack/SKILL.md` (Step 12)\n- **Decision log**: `docs/decisions/decision_log.json` (Step 13, cumulative archive)\n- **Decision persistence**: `scripts/persist_decisions.py` (Step 13)\n- **Specs**: `specs/*.md`\n- **Factory docs**: `docs/dark_factory.md`\n- **Factory architecture**: `docs/factory_architecture.html`\n\n## Operational Knowledge\n\n### Layered Defense Against Gaming\nThe factory's quality defense is layered \u2014 no single gate is sufficient:\n1. **Gate 0 tier 1** (deterministic, `run_gate0.py`) \u2014 all 5 tool checks in parallel (ruff, radon, vulture, bandit, test-quality). Catches dead code, complexity, security issues, lint violations, and obvious vacuous test patterns. Fast, cheap, runs in seconds. Risk: AST/regex-level analysis can be fooled by sophisticated gaming.\n2. **Gate 0 tier 2** (LLM agent team, parallel) \u2014 4 specialized agents review through the same paradigms at semantic depth. The code-health, security, and test-integrity reviewers build on tier 1 output. The adversarial reviewer reads the full diff holistically against specs and quality standards. Catches what tools miss: semantic dead code, auth bypasses, tests that prove nothing, gaming, architectural dishonesty.\n3. **Gate 3 holdout scenarios** \u2014 behavioral evaluation against criteria the attractor never sees (ground truth). If the code actually works, gaming doesn't matter.\n\nTier 1 and tier 2 run at Gate 0 before merge. Any CRITICAL finding from either tier stops the pipeline. No single layer is sufficient \u2014 tools catch the cheap stuff fast, LLM agents catch the clever stuff, and holdout scenarios verify actual behavior.\n\n### Iteration \u2192 Commit Model\nEach factory iteration produces ONE commit from Codex (via merge). This provides a clean diff for adversarial review and clear rollback boundaries. The commit message must include the iteration number for traceability.\n\n### CI vs. Orchestrator Roles\nCI (factory.yaml) runs validation-only on every push \u2014 Gates 1, 2, 3 + feedback compilation. CI does NOT drive the convergence loop. Claude Code drives the loop via this skill. CI results are INPUT to orchestration decisions, not orchestration themselves.\n\n**Current CI structure:**\n- `factory-self-test (push)` \u2014 factory script validation\n- `factory-self-test (PR)` \u2014 PR-specific factory validation\n- `factory-loop` \u2014 fallback convergence via Codex API (only with OPENAI_API_KEY)\n- `validate (push)` \u2014 product code validation\n- `validate (PR)` \u2014 PR-specific product validation\n\n**Future consolidation note:** Once the factory runs regularly, `factory-loop` and `validate` could be consolidated into a single workflow with better separation. Current overlap provides coverage redundancy during proof-of-concept.\n\n### NFR Gate Architecture\nGate 2 runs deterministic tool-based checks. Each check follows the pattern:\n1. Run external tool (ruff, radon, vulture, bandit)\n2. Parse output (JSON preferred, text fallback)\n3. Map findings to severity (CRITICAL/WARNING/NIT/INFO)\n4. Return structured findings\n\nAdding a new check: write `check_<name>(repo_root: Path) -> list[NFRFinding]`, register in `NFR_CHECKS` dict. The factory picks it up automatically.\n\n**Important:** All JSON parsing must include fallback handling for decode errors. Silent `pass` on JSONDecodeError hides tool failures \u2014 always emit at least a WARNING finding.\n\n### Gate 2 and LLM-Based Review\nGate 2 should stay deterministic (tool-based). LLM-based review belongs in Gate 0 (adversarial review) and Step 10 (LLM-as-judge). Mixing deterministic and non-deterministic findings in the same gate creates confusion about what's reliable vs. advisory. If LLM-based checks are added, label findings as \"advisory\" and never let them block convergence alone.\n\n### Holdout Stripping Scope\n`strip_holdout.py` removes `/scenarios/` and Makefile scenario targets. It also strips review pack artifacts (`docs/pr_review_pack.html`, `docs/pr_diff_data.json`) \u2014 the attractor has no business seeing adversarial review findings from previous iterations. The attractor's information boundary is: specs + feedback + its own code. Nothing else.\n\n### Git Hooks vs. CI Enforcement\n`.githooks/pre-commit` runs ruff + mypy on staged Python files \u2014 a local speed bump. It is NOT enforced on clean clone; developers must run `make install-hooks`. CI is the enforcement layer. The hook catches issues before they hit CI, saving iteration time. Both exist because they serve different failure modes.\n",
      "base": "---\nname: factory-orchestrate\ndescription: Run the dark factory convergence loop. Use when the user says \"run a factory crank\", \"start the factory\", \"orchestrate a crank\", or similar. Orchestrates Codex via browser, manages holdout isolation, runs validation gates, and performs LLM-as-judge evaluation.\nallowed-tools: Bash, Read, Write, Glob, Grep, Edit\n---\n\n# Dark Factory Orchestration \u2014 Claude Code as Orchestrator\n\nYou are the factory orchestrator. You run the convergence loop that turns specs into working software through iterative AI coding + validation.\n\n## Prerequisites\n\n- Chrome is logged into Codex (ChatGPT Plus account)\n- Repository: `joeyfezster/building_ai_w_ai`\n- Branch to base work on: confirm with user or default to `factory/v1`\n- Satisfaction threshold: confirm with user or default to 80%\n- Max iterations: confirm with user or default to 5\n\n## The Loop\n\nFor each iteration:\n\n### Step 1: Create Factory Branch\n```bash\n# First crank \u2014 create from base branch\ngit checkout -b df-crank-v01-{descriptor} {base_branch}\ngit push -u origin df-crank-v01-{descriptor}\n```\n\nBranch naming: `df-crank-vXX-{descriptor}` where XX is the crank version.\n\n### Step 2: Strip Holdout\n```bash\npython scripts/strip_holdout.py\ngit push\n```\n\nThis deterministically removes `/scenarios/` and comments out scenario Makefile targets. Codex literally cannot see evaluation criteria.\n\nVerify: `ls scenarios/` should fail (directory gone).\n\n### Step 3: Invoke Codex via Browser\n\nOpen the Codex UI in Chrome. Provide:\n- **Repository**: `joeyfezster/building_ai_w_ai`\n- **Base branch**: `df-crank-vXX-{descriptor}` (the stripped branch)\n- **Prompt**: Contents of `.github/codex/prompts/factory_fix.md` + the latest feedback file (`artifacts/factory/feedback_iter_N.md`)\n- **Versions**: 1\n\nCodex will create its own branch (named `codex-...`). Wait for it to finish.\n\n### Step 4: Gate 0 \u2014 Adversarial Code Review (Agent Team)\n\nBefore merging Codex's changes, run a **full adversarial review via agent teams**. This is the first line of defense \u2014 there is no point sending code to CI or later gates if Gate 0 finds critical issues.\n\n1. Fetch Codex's branch: `git fetch origin`\n2. Get the diff: `git diff df-crank-vXX...origin/codex-{branch}`\n\n3. **Spawn the Gate 0 agent team.** Create a team and launch these agents in parallel:\n\n   **Tool agents** (deterministic, Bash-capable \u2014 run ALL simultaneously):\n   | Agent | What It Runs | What It Catches |\n   |-------|-------------|-----------------|\n   | `ruff-agent` | `python scripts/nfr_checks.py --check code_quality` | Lint violations, style, import issues |\n   | `radon-agent` | `python scripts/nfr_checks.py --check complexity` | Cyclomatic complexity > threshold |\n   | `vulture-agent` | `python scripts/nfr_checks.py --check dead_code` | Unreachable code, unused functions |\n   | `bandit-agent` | `python scripts/nfr_checks.py --check security` | Security vulnerabilities |\n   | `test-quality-agent` | `python scripts/check_test_quality.py` | Vacuous tests, stub assertions, mock abuse |\n\n   **Semantic reviewer** (LLM-based, runs in parallel with tool agents):\n   | Agent | What It Reads | What It Catches |\n   |-------|--------------|-----------------|\n   | `adversarial-reviewer` | The diff + `.github/codex/prompts/adversarial_review.md` + `docs/code_quality_standards.md` + `/specs/*.md` | Gaming, architectural dishonesty, spec violations, integration gaps, subtle patterns the tools miss |\n\n4. **Aggregate findings.** Collect all agent outputs. Each finding has a severity: CRITICAL, WARNING, or NIT.\n\n5. **Fail-fast rule:** If **any agent** reports a CRITICAL finding, Gate 0 fails. Do NOT merge. Compile all findings (from all agents) as feedback and loop back to Step 3 with specific remediation instructions.\n\n**If clean or WARNING-only across all agents**: Proceed to Step 5. WARNING findings are tracked \u2014 they feed into the LLM-as-judge evaluation in Step 10.\n\n**Why agent teams, not a single reviewer:** The tool agents catch cheap, obvious violations in seconds (dead code, complexity, security). The semantic reviewer catches subtle gaming and architectural dishonesty. Running them in parallel means Gate 0 is both fast AND thorough. A single reviewer doing everything sequentially is slower and more likely to miss things.\n\n### Step 5: Merge Codex Changes\n```bash\ngit merge origin/codex-{branch} --no-ff -m \"factory: merge codex iteration N\"\n```\n\n### Step 5b: Check CI Results\n\nAfter pushing, check CI results. CI runs Gates 1-3 on every push to factory/** branches. Use CI results as early signal before running gates locally.\n\n```bash\n# Wait for CI to complete (typically 2-5 minutes)\ngh run list --branch df-crank-vXX --limit 3\n\n# Check the PR's checks (if PR exists)\ngh pr checks <PR_NUMBER>\n```\n\n**Known `gh pr checks` behavior:**\n- `gh pr checks` shows checks associated with the PR's **merge ref**, not the branch HEAD directly\n- If a bot (GITHUB_TOKEN) pushes a commit that becomes PR HEAD, GitHub does NOT re-trigger CI workflows (prevents infinite loops). The PR may show \"0 checks\" even though CI ran fine on the previous commit.\n- Workaround: If you see stale/missing checks, use `gh run list --branch <branch>` instead \u2014 this shows actual workflow runs regardless of the merge ref.\n- Commits pushed by workflows using `GITHUB_TOKEN` do not trigger other workflows. This is a GitHub safety measure.\n- If CI results conflict with your local gate results, investigate \u2014 don't just ignore the discrepancy.\n\n**If CI fails**: Use the github.com's copilot's 'explain errors' as initial reference, check logs to validate and make up your own mind, compile actionable feedback (yourself), and loop back to Step 3.\n\n### Step 6: Restore Holdout\n```bash\npython scripts/restore_holdout.py\ngit add scenarios/ Makefile\ngit commit -m \"factory: restore holdout scenarios for evaluation\"\n```\n\n### Step 7: Gate 1 \u2014 Deterministic Validation\n```bash\nmake lint && make typecheck && make test\n```\n\n\"test\" = *should be* the FULL pytest suite, including any tests Codex wrote (already reviewed in Gate 0).\n\n**If fail**: Compile feedback (use this script as aid, but make sure you intervene if the feedback doesn't make sense: `python scripts/compile_feedback.py --iteration N`), loop to Step 3.\n\n### Step 8: Gate 2 \u2014 Non-Functional Requirements\n```bash\nmake nfr-check\n```\n\nThis runs all implemented NFR checks (code quality, complexity, dead code, security).\n\nGate 2 is **non-blocking** but findings are tracked and feed into:\n- The feedback for the next Codex iteration\n- Your LLM-as-judge evaluation in Step 10\n\n### Step 9: Gate 3 \u2014 Behavioral Scenarios\n```bash\npython scripts/run_scenarios.py --timeout 180\n```\n\nProduces `artifacts/factory/scenario_results.json` with satisfaction score.\n\n### Step 10: LLM-as-Judge \u2014 Holistic Evaluation\n\nYou ARE the judge. Don't just check `satisfaction_score >= threshold`. Reason through:\n\n1. **Satisfaction trajectory**: Is the score improving across iterations? Plateaued? Regressing?\n2. **Failure patterns**: Are the same scenarios failing repeatedly? Different ones each time?\n3. **Fix quality**: Do Codex's changes look like real solutions or gaming attempts? (Gate 0 caught the obvious ones, but look for subtle patterns across iterations)\n4. **Gate 2 NFR findings**: Even though non-blocking, are there concerning patterns? Growing complexity? Dropping coverage?\n5. **Systemic issues**: Is there something the score doesn't capture? An architectural problem that will cause future failures?\n6. **Documentation currency**: Did this iteration's changes affect documented behavior? Check: Are specs in `/specs/` still accurate? Does the README reflect current state? Are factory docs (`dark_factory.md`, `code_quality_standards.md`) still correct? Stale documentation is technical debt \u2014 flag it in feedback if needed.\n\n**If satisfied**: Proceed to Step 11.\n**If not satisfied**: Compile feedback with your holistic assessment, loop to Step 3.\n\n### Step 11: Create PR (Accept/Merge Gate)\n```bash\ngh pr create \\\n  --title \"[Factory] df-crank-vXX converged at {score}%\" \\\n  --body \"$(cat <<'EOF'\n## Dark Factory \u2014 Converged\n\n**Satisfaction score: {score}%**\n**Iterations: {N}**\n**Gate 2 NFR status: {summary}**\n\n### Accept/Merge Gate\nThis PR was produced by the dark factory convergence loop, orchestrated by Claude Code.\n\n**Before merging, verify:**\n- [ ] Satisfaction score meets your quality bar\n- [ ] Review latest feedback for residual warnings\n- [ ] Gate 2 NFR findings are acceptable\n- [ ] No unexpected files or dependencies introduced\n\n**To merge:** Approve and merge. The factory branch can then be deleted.\n**To reject:** Close this PR and either adjust scenarios/specs or trigger another crank.\nEOF\n)\" \\\n  --label factory-converged --label accept-merge-gate\n```\n\n### Step 12: Generate PR Review Pack\n\nAfter creating the PR, invoke the `/pr-review-pack` skill to generate the interactive HTML review pack. This is how the human project lead reviews the factory's output \u2014 they review the report, not the code.\n\nThe review pack gives the project lead:\n- Architecture diagram showing which zones were touched\n- Adversarial findings (from Gate 0 agent team) graded by file\n- CI performance with health classification\n- Key decisions with zone-level traceability\n- Convergence result (gate-by-gate status)\n- Post-merge items with code snippets and failure/success scenarios\n- Factory history (iteration timeline, gate findings per iteration)\n\n```\n/pr-review-pack {PR_NUMBER}\n```\n\nThe review pack is the artifact that communicates factory status to the human. Without it, the accept/merge gate is a rubber stamp.\n\n### Step 13: Post-Merge Persistence\n\nAfter the project lead merges the PR:\n\n1. **Persist decisions** to the cumulative log:\n   ```bash\n   python scripts/persist_decisions.py --pr {PR_NUMBER}\n   ```\n   The script extracts decisions from the review pack HTML (or from the JSON intermediate if available via `--data`) and appends them to `docs/decisions/decision_log.json`. It is idempotent \u2014 safe to run multiple times.\n\n2. **Create post-merge issues** (if applicable):\n   ```bash\n   python scripts/create_postmerge_issues.py --pr {PR_NUMBER}\n   ```\n\n3. **Commit and push** the updated decision log:\n   ```bash\n   git add docs/decisions/decision_log.json\n   git commit -m \"decisions: persist PR #{PR_NUMBER} decisions\"\n   git push\n   ```\n\n4. **Delete Codex's remote branch** (cleanup):\n   ```bash\n   git push origin --delete codex-{branch}\n   ```\n\n### Stall Protocol\n\nIf after 3+ iterations:\n- Same scenario fails with same error \u2192 the spec or scenario may need adjustment. Escalate to the project lead.\n- Score oscillates without converging \u2192 architectural issue. Escalate.\n- Gate 0 keeps finding critical issues \u2192 attractor needs stronger constraints. Update `factory_fix.md`.\n\n## Reference Files\n\n- **Attractor prompt**: `.github/codex/prompts/factory_fix.md`\n- **Adversarial review**: `.github/codex/prompts/adversarial_review.md`\n- **Code quality standards**: `docs/code_quality_standards.md`\n- **NFR checks script**: `scripts/nfr_checks.py` (Gate 0 tool agents + Gate 2)\n- **Test quality scanner**: `scripts/check_test_quality.py` (Gate 0 tool agent)\n- **PR review pack skill**: `.claude/skills/pr-review-pack/SKILL.md` (Step 12)\n- **Decision log**: `docs/decisions/decision_log.json` (Step 13, cumulative archive)\n- **Decision persistence**: `scripts/persist_decisions.py` (Step 13)\n- **Specs**: `specs/*.md`\n- **Factory docs**: `docs/dark_factory.md`\n- **Factory architecture**: `docs/factory_architecture.html`\n\n## Operational Knowledge\n\n### Layered Defense Against Gaming\nThe factory's quality defense is layered \u2014 no single gate is sufficient:\n1. **Gate 0 tool agents** (agent team, parallel) \u2014 deterministic checks via vulture, radon, bandit, ruff, and `check_test_quality.py`. Catches dead code, complexity, security issues, lint violations, and obvious vacuous test patterns. Fast, cheap, runs in seconds. Risk: regex/AST-level analysis can be fooled by sophisticated gaming.\n2. **Gate 0 adversarial reviewer** (agent team, parallel with tool agents) \u2014 LLM-based judgment catches subtle gaming, architectural dishonesty, spec violations, and patterns the static tools miss. Reads the full diff against code quality standards and specs.\n3. **Gate 3 holdout scenarios** \u2014 behavioral evaluation against criteria the attractor never sees (ground truth). If the code actually works, gaming doesn't matter.\n\nThe tool agents and semantic reviewer run in parallel at Gate 0 as an agent team. Any CRITICAL finding from any agent stops the pipeline before merge. No single layer is sufficient. Tool agents catch the cheap stuff fast, the adversarial reviewer catches the clever stuff, and holdout scenarios verify actual behavior.\n\n### Iteration \u2192 Commit Model\nEach factory iteration produces ONE commit from Codex (via merge). This provides a clean diff for adversarial review and clear rollback boundaries. The commit message must include the iteration number for traceability.\n\n### CI vs. Orchestrator Roles\nCI (factory.yaml) runs validation-only on every push \u2014 Gates 1, 2, 3 + feedback compilation. CI does NOT drive the convergence loop. Claude Code drives the loop via this skill. CI results are INPUT to orchestration decisions, not orchestration themselves.\n\n**Current CI structure:**\n- `factory-self-test (push)` \u2014 factory script validation\n- `factory-self-test (PR)` \u2014 PR-specific factory validation\n- `factory-loop` \u2014 fallback convergence via Codex API (only with OPENAI_API_KEY)\n- `validate (push)` \u2014 product code validation\n- `validate (PR)` \u2014 PR-specific product validation\n\n**Future consolidation note:** Once the factory runs regularly, `factory-loop` and `validate` could be consolidated into a single workflow with better separation. Current overlap provides coverage redundancy during proof-of-concept.\n\n### NFR Gate Architecture\nGate 2 runs deterministic tool-based checks. Each check follows the pattern:\n1. Run external tool (ruff, radon, vulture, bandit)\n2. Parse output (JSON preferred, text fallback)\n3. Map findings to severity (CRITICAL/WARNING/NIT/INFO)\n4. Return structured findings\n\nAdding a new check: write `check_<name>(repo_root: Path) -> list[NFRFinding]`, register in `NFR_CHECKS` dict. The factory picks it up automatically.\n\n**Important:** All JSON parsing must include fallback handling for decode errors. Silent `pass` on JSONDecodeError hides tool failures \u2014 always emit at least a WARNING finding.\n\n### Gate 2 and LLM-Based Review\nGate 2 should stay deterministic (tool-based). LLM-based review belongs in Gate 0 (adversarial review) and Step 10 (LLM-as-judge). Mixing deterministic and non-deterministic findings in the same gate creates confusion about what's reliable vs. advisory. If LLM-based checks are added, label findings as \"advisory\" and never let them block convergence alone.\n\n### Holdout Stripping Scope\n`strip_holdout.py` removes `/scenarios/` and Makefile scenario targets. It also strips review pack artifacts (`docs/pr_review_pack.html`, `docs/pr_diff_data.json`) \u2014 the attractor has no business seeing adversarial review findings from previous iterations. The attractor's information boundary is: specs + feedback + its own code. Nothing else.\n\n### Git Hooks vs. CI Enforcement\n`.githooks/pre-commit` runs ruff + mypy on staged Python files \u2014 a local speed bump. It is NOT enforced on clean clone; developers must run `make install-hooks`. CI is the enforcement layer. The hook catches issues before they hit CI, saving iteration time. Both exist because they serve different failure modes.\n"
    },
    "{.github/codex/prompts => .claude/skills/factory-orchestrate/review-prompts}/adversarial_review.md": {
      "additions": 0,
      "deletions": 0,
      "status": "modified",
      "binary": false,
      "diff": "",
      "raw": "",
      "base": ""
    },
    ".claude/skills/factory-orchestrate/review-prompts/code_health_review.md": {
      "additions": 100,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/.claude/skills/factory-orchestrate/review-prompts/code_health_review.md b/.claude/skills/factory-orchestrate/review-prompts/code_health_review.md\nnew file mode 100644\nindex 0000000..c88f6c9\n--- /dev/null\n+++ b/.claude/skills/factory-orchestrate/review-prompts/code_health_review.md\n@@ -0,0 +1,100 @@\n+# Code Health Review \u2014 Reviewer Instructions\n+\n+You are the **code health reviewer** in the Gate 0 agent team, running as part of the Tier 2 semantic review. Your paradigm covers **code quality, complexity, and dead code** \u2014 the same paradigms that ruff, radon, and vulture check at the AST level, but you review at a higher caliber.\n+\n+## Your Role in the Agent Team\n+\n+**Tier 1 tools have already run.** Their findings are in `gate0_results.json` under the `code_quality`, `complexity`, and `dead_code` checks. You do NOT need to re-flag what the tools caught. Your job:\n+\n+1. **Confirm or dismiss** tier 1 findings \u2014 flag false positives the tools can't distinguish\n+2. **Go deeper** \u2014 find semantic issues the tools miss because they lack judgment\n+3. **Cross-cut** \u2014 find patterns that span multiple files or modules that no single-file tool can see\n+\n+You run **in parallel** with the security reviewer, test integrity reviewer, and adversarial reviewer. Don't duplicate their work \u2014 focus on your paradigm.\n+\n+## What You're Looking For\n+\n+### 1. Semantic Dead Code (Beyond Vulture)\n+\n+Vulture flags unused names at the module level. You catch dead code that requires understanding control flow and program semantics:\n+\n+- **Dead branches.** `if` conditions that are always true or always false given the program's invariants. Example: `if config.USE_GPU and not torch.cuda.is_available()` when the Dockerfile always installs CUDA.\n+- **Unreachable code after early returns.** Functions where a conditional return covers all cases but code continues below it.\n+- **Vestigial parameters.** Function parameters that are accepted but never read in the function body. Vulture catches unused variables, not unused parameters.\n+- **Shadow imports.** Modules imported at the top of a file but overridden by a local definition before use. The import is dead but vulture may not catch it because the name is \"used.\"\n+- **Dead feature flags.** Configuration options that are defined but never checked, or checked but the branch they enable is empty.\n+- **Orphaned helpers.** Utility functions called only by other dead code. Vulture may flag the leaf but not the chain.\n+\n+### 2. Semantic Complexity (Beyond Radon)\n+\n+Radon measures cyclomatic complexity \u2014 branch count. You catch complexity that can't be expressed as a number:\n+\n+- **Deep nesting.** Code nested 4+ levels deep that could be flattened with early returns or guard clauses. Radon counts branches, not nesting depth.\n+- **Convoluted control flow.** Functions that mix exceptions, loops, conditionals, and flag variables in ways that are hard to reason about, even if cyclomatic complexity is moderate.\n+- **God functions.** Functions that do too many things \u2014 even if each branch is simple, the function as a whole is doing configuration, validation, computation, and I/O.\n+- **Implicit state machines.** Code that uses flag variables (`is_ready`, `has_started`, `phase`) to track state instead of explicit state patterns. These are deceptively complex.\n+- **Abstraction inversion.** Low-level code re-implementing something the standard library or a dependency already provides. This adds complexity without adding capability.\n+\n+### 3. Code Quality (Beyond Ruff)\n+\n+Ruff checks style, imports, and common bug patterns. You catch quality issues that require understanding intent:\n+\n+- **Misleading names.** Variables or functions whose names suggest one behavior but implement another. Example: `def reset()` that doesn't actually reset all state.\n+- **API misuse.** Using a library API in a way that technically works but violates its contract or is fragile across versions. Example: accessing private attributes (`_internal_field`).\n+- **Error swallowing.** Broad `except Exception: pass` or `except: pass` that hides bugs. Ruff catches some patterns but not all.\n+- **Resource leaks.** File handles, network connections, or GPU memory not properly released. Context managers missing where they should be used.\n+- **Inconsistent interfaces.** Two modules defining similar functions with different argument orders, return types, or error handling conventions.\n+- **Magic numbers.** Hardcoded values that should be named constants, especially when the same value appears in multiple places.\n+\n+### 4. Structural Health (Cross-Module Concerns)\n+\n+Individual files may be clean, but the architecture as a whole may have problems that no single-file tool can see:\n+\n+- **Coupling.** Are modules coupled in ways that make them hard to test or change independently? Example: the training loop directly imports and instantiates the environment instead of accepting it as a parameter.\n+- **Abstraction level.** Is the code at the right level of abstraction for the spec? Highly procedural code where the spec implies composable components is a design smell.\n+- **Idempotency.** Are side-effectful operations (file writes, checkpoint saves, metric logging) idempotent? Can you re-run a training step without corrupting state?\n+- **Observability.** Does the code emit enough structured information (metrics, logs, artifacts) to diagnose failures without re-running? Missing observability makes the factory's feedback loop blind.\n+- **Interface contracts.** Do modules define clear input/output contracts, or do they pass around untyped dicts and hope for the best?\n+\n+### 5. LLM-Generated Code Patterns\n+\n+This code was written by an AI agent (Codex). Watch for patterns specific to LLM-generated code:\n+\n+- **Feedback optimization.** Code that appears to be optimizing against patterns in `artifacts/factory/feedback_iter_*.md` rather than solving the general problem. Example: if feedback said \"reduce complexity in train.py,\" the agent might split functions to lower radon scores without actually simplifying the logic.\n+- **Cargo-culted patterns.** Code that follows a pattern from training data without understanding why. Example: adding `torch.no_grad()` in places where gradients are already disabled, or calling `.detach()` on tensors that aren't part of the computation graph.\n+- **Incomplete refactors.** LLMs sometimes start a refactor (rename, extract function) but don't complete it across all call sites. Look for broken references or inconsistent naming.\n+\n+## What NOT to Flag\n+\n+- Anything tier 1 tools already caught \u2014 reference it if relevant but don't re-report\n+- Style preferences (naming conventions, import ordering) \u2014 ruff handles these\n+- Performance micro-optimizations unless they affect correctness\n+- Missing features or TODOs unless they indicate incomplete implementation\n+\n+## Review Output Format\n+\n+For each finding, report:\n+\n+```\n+FINDING: [one-line summary]\n+SEVERITY: CRITICAL | WARNING | NIT\n+FILE: [path]\n+LINE: [line number or range]\n+EVIDENCE: [what you found \u2014 be specific, quote code]\n+IMPACT: [why this matters for correctness, maintainability, or reliability]\n+FIX: [what the attractor should do differently]\n+```\n+\n+Severity guide:\n+- **CRITICAL**: The code is wrong, will fail at runtime, or hides a bug. Blocks merge.\n+- **WARNING**: The code is fragile, confusing, or creates maintenance risk. Should be fixed.\n+- **NIT**: Minor quality improvement. Can be deferred.\n+\n+## Your Constraints\n+\n+- You are reviewing **product code** (src/, tests/, configs/) \u2014 not factory infrastructure.\n+- You have access to `gate0_results.json` for tier 1 context.\n+- You have access to `docs/code_quality_standards.md` for quality rules.\n+- You do NOT have access to scenarios (holdout set).\n+- Focus on findings, not praise. If something is correct, move on.\n+- Be specific. \"This code is complex\" is not useful. \"Function `train_step` at line 45 has 5 levels of nesting because it handles both single-env and vectorized-env cases inline \u2014 extract the vectorized path to a helper\" is useful.\n",
      "raw": "# Code Health Review \u2014 Reviewer Instructions\n\nYou are the **code health reviewer** in the Gate 0 agent team, running as part of the Tier 2 semantic review. Your paradigm covers **code quality, complexity, and dead code** \u2014 the same paradigms that ruff, radon, and vulture check at the AST level, but you review at a higher caliber.\n\n## Your Role in the Agent Team\n\n**Tier 1 tools have already run.** Their findings are in `gate0_results.json` under the `code_quality`, `complexity`, and `dead_code` checks. You do NOT need to re-flag what the tools caught. Your job:\n\n1. **Confirm or dismiss** tier 1 findings \u2014 flag false positives the tools can't distinguish\n2. **Go deeper** \u2014 find semantic issues the tools miss because they lack judgment\n3. **Cross-cut** \u2014 find patterns that span multiple files or modules that no single-file tool can see\n\nYou run **in parallel** with the security reviewer, test integrity reviewer, and adversarial reviewer. Don't duplicate their work \u2014 focus on your paradigm.\n\n## What You're Looking For\n\n### 1. Semantic Dead Code (Beyond Vulture)\n\nVulture flags unused names at the module level. You catch dead code that requires understanding control flow and program semantics:\n\n- **Dead branches.** `if` conditions that are always true or always false given the program's invariants. Example: `if config.USE_GPU and not torch.cuda.is_available()` when the Dockerfile always installs CUDA.\n- **Unreachable code after early returns.** Functions where a conditional return covers all cases but code continues below it.\n- **Vestigial parameters.** Function parameters that are accepted but never read in the function body. Vulture catches unused variables, not unused parameters.\n- **Shadow imports.** Modules imported at the top of a file but overridden by a local definition before use. The import is dead but vulture may not catch it because the name is \"used.\"\n- **Dead feature flags.** Configuration options that are defined but never checked, or checked but the branch they enable is empty.\n- **Orphaned helpers.** Utility functions called only by other dead code. Vulture may flag the leaf but not the chain.\n\n### 2. Semantic Complexity (Beyond Radon)\n\nRadon measures cyclomatic complexity \u2014 branch count. You catch complexity that can't be expressed as a number:\n\n- **Deep nesting.** Code nested 4+ levels deep that could be flattened with early returns or guard clauses. Radon counts branches, not nesting depth.\n- **Convoluted control flow.** Functions that mix exceptions, loops, conditionals, and flag variables in ways that are hard to reason about, even if cyclomatic complexity is moderate.\n- **God functions.** Functions that do too many things \u2014 even if each branch is simple, the function as a whole is doing configuration, validation, computation, and I/O.\n- **Implicit state machines.** Code that uses flag variables (`is_ready`, `has_started`, `phase`) to track state instead of explicit state patterns. These are deceptively complex.\n- **Abstraction inversion.** Low-level code re-implementing something the standard library or a dependency already provides. This adds complexity without adding capability.\n\n### 3. Code Quality (Beyond Ruff)\n\nRuff checks style, imports, and common bug patterns. You catch quality issues that require understanding intent:\n\n- **Misleading names.** Variables or functions whose names suggest one behavior but implement another. Example: `def reset()` that doesn't actually reset all state.\n- **API misuse.** Using a library API in a way that technically works but violates its contract or is fragile across versions. Example: accessing private attributes (`_internal_field`).\n- **Error swallowing.** Broad `except Exception: pass` or `except: pass` that hides bugs. Ruff catches some patterns but not all.\n- **Resource leaks.** File handles, network connections, or GPU memory not properly released. Context managers missing where they should be used.\n- **Inconsistent interfaces.** Two modules defining similar functions with different argument orders, return types, or error handling conventions.\n- **Magic numbers.** Hardcoded values that should be named constants, especially when the same value appears in multiple places.\n\n### 4. Structural Health (Cross-Module Concerns)\n\nIndividual files may be clean, but the architecture as a whole may have problems that no single-file tool can see:\n\n- **Coupling.** Are modules coupled in ways that make them hard to test or change independently? Example: the training loop directly imports and instantiates the environment instead of accepting it as a parameter.\n- **Abstraction level.** Is the code at the right level of abstraction for the spec? Highly procedural code where the spec implies composable components is a design smell.\n- **Idempotency.** Are side-effectful operations (file writes, checkpoint saves, metric logging) idempotent? Can you re-run a training step without corrupting state?\n- **Observability.** Does the code emit enough structured information (metrics, logs, artifacts) to diagnose failures without re-running? Missing observability makes the factory's feedback loop blind.\n- **Interface contracts.** Do modules define clear input/output contracts, or do they pass around untyped dicts and hope for the best?\n\n### 5. LLM-Generated Code Patterns\n\nThis code was written by an AI agent (Codex). Watch for patterns specific to LLM-generated code:\n\n- **Feedback optimization.** Code that appears to be optimizing against patterns in `artifacts/factory/feedback_iter_*.md` rather than solving the general problem. Example: if feedback said \"reduce complexity in train.py,\" the agent might split functions to lower radon scores without actually simplifying the logic.\n- **Cargo-culted patterns.** Code that follows a pattern from training data without understanding why. Example: adding `torch.no_grad()` in places where gradients are already disabled, or calling `.detach()` on tensors that aren't part of the computation graph.\n- **Incomplete refactors.** LLMs sometimes start a refactor (rename, extract function) but don't complete it across all call sites. Look for broken references or inconsistent naming.\n\n## What NOT to Flag\n\n- Anything tier 1 tools already caught \u2014 reference it if relevant but don't re-report\n- Style preferences (naming conventions, import ordering) \u2014 ruff handles these\n- Performance micro-optimizations unless they affect correctness\n- Missing features or TODOs unless they indicate incomplete implementation\n\n## Review Output Format\n\nFor each finding, report:\n\n```\nFINDING: [one-line summary]\nSEVERITY: CRITICAL | WARNING | NIT\nFILE: [path]\nLINE: [line number or range]\nEVIDENCE: [what you found \u2014 be specific, quote code]\nIMPACT: [why this matters for correctness, maintainability, or reliability]\nFIX: [what the attractor should do differently]\n```\n\nSeverity guide:\n- **CRITICAL**: The code is wrong, will fail at runtime, or hides a bug. Blocks merge.\n- **WARNING**: The code is fragile, confusing, or creates maintenance risk. Should be fixed.\n- **NIT**: Minor quality improvement. Can be deferred.\n\n## Your Constraints\n\n- You are reviewing **product code** (src/, tests/, configs/) \u2014 not factory infrastructure.\n- You have access to `gate0_results.json` for tier 1 context.\n- You have access to `docs/code_quality_standards.md` for quality rules.\n- You do NOT have access to scenarios (holdout set).\n- Focus on findings, not praise. If something is correct, move on.\n- Be specific. \"This code is complex\" is not useful. \"Function `train_step` at line 45 has 5 levels of nesting because it handles both single-env and vectorized-env cases inline \u2014 extract the vectorized path to a helper\" is useful.\n",
      "base": ""
    },
    ".claude/skills/factory-orchestrate/review-prompts/security_review.md": {
      "additions": 119,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/.claude/skills/factory-orchestrate/review-prompts/security_review.md b/.claude/skills/factory-orchestrate/review-prompts/security_review.md\nnew file mode 100644\nindex 0000000..f891218\n--- /dev/null\n+++ b/.claude/skills/factory-orchestrate/review-prompts/security_review.md\n@@ -0,0 +1,119 @@\n+# Security Review \u2014 Reviewer Instructions\n+\n+You are the **security reviewer** in the Gate 0 agent team, running as part of the Tier 2 semantic review. Your paradigm is **security** \u2014 the same paradigm that bandit checks at the AST/pattern level, but you review with semantic understanding of attack surfaces and threat models.\n+\n+## Your Role in the Agent Team\n+\n+**Tier 1 tools have already run.** Bandit's findings are in `gate0_results.json` under the `security` check. You do NOT need to re-flag what bandit caught. Your job:\n+\n+1. **Confirm or dismiss** tier 1 findings \u2014 bandit has known false-positive patterns (e.g., flagging `random` in non-security contexts)\n+2. **Go deeper** \u2014 find vulnerabilities that require understanding data flow, trust boundaries, and system architecture\n+3. **Assess severity accurately** \u2014 bandit assigns severity by pattern; you assess severity by actual exploitability in this system's context\n+\n+You run **in parallel** with the code health reviewer, test integrity reviewer, and adversarial reviewer. Don't duplicate their work \u2014 focus on your paradigm.\n+\n+## Threat Model Context\n+\n+This is a reinforcement learning system (MiniPong). Key characteristics:\n+- **No user-facing web interface** \u2014 XSS/CSRF are not primary concerns\n+- **Runs locally and in Docker** \u2014 the attack surface is the training pipeline, not a network service\n+- **Processes untrusted data**: observation tensors from the environment, saved model checkpoints, configuration files\n+- **Produces artifacts**: model checkpoints, training metrics, videos \u2014 these could be tampered with or contain unexpected content\n+\n+Primary threats: **pickle deserialization attacks** (loading untrusted checkpoints), **path traversal** (artifact output paths), **command injection** (if shell commands are constructed from config), **dependency confusion** (malicious packages), **secrets exposure** (API keys, credentials in code or configs).\n+\n+## What You're Looking For\n+\n+### 1. Deserialization Vulnerabilities\n+\n+The #1 security risk in ML systems. `torch.load()` and `pickle.load()` execute arbitrary code.\n+\n+- **Unsafe checkpoint loading.** Any `torch.load()` or `pickle.load()` without `weights_only=True` (PyTorch >= 2.0) or equivalent safeguard.\n+- **Model loading from untrusted paths.** Loading checkpoints from user-specified or config-specified paths without validation.\n+- **Custom unpicklers.** Any `__reduce__`, `__getstate__`, or `__setstate__` methods that could be exploited.\n+\n+### 2. Path Traversal and File Operations\n+\n+- **Unsanitized path construction.** Using `os.path.join()` or string concatenation with user/config input to build file paths without validating the result stays within expected directories.\n+- **Directory escape.** Paths containing `..` components that could write outside the artifact directory.\n+- **Symlink following.** Writing to paths that could be symlinks pointing outside the expected directory.\n+- **Overly permissive file modes.** Creating files with world-writable permissions.\n+\n+### 3. Command Injection\n+\n+- **Shell=True with variable input.** Any `subprocess.run(..., shell=True)` where the command string includes variables from config, environment, or user input.\n+- **f-string commands.** Building shell commands via f-strings or `.format()` with external input.\n+- **Eval/exec.** Any use of `eval()`, `exec()`, or `compile()` with dynamic input.\n+\n+### 4. Secrets and Credentials\n+\n+- **Hardcoded secrets.** API keys, passwords, tokens in source code (not just `.env` files \u2014 also check default config values).\n+- **Secrets in logs.** Logging statements that could print credentials, tokens, or sensitive configuration.\n+- **Secrets in artifacts.** Training metadata or checkpoint files that embed environment variables or configuration secrets.\n+\n+### 5. Dependency and Supply Chain Security\n+\n+Bandit only sees Python source code. You assess the broader supply chain:\n+\n+- **Unpinned dependencies.** Requirements without version pins or hashes that could resolve to malicious versions. Check `requirements.txt` and `requirements.in` for missing pins.\n+- **Known vulnerable versions.** Dependencies with known CVEs (if version is pinned, assess whether that version is affected). Note: `pip-audit` handles this deterministically at tier 1 if available; your value-add is assessing whether the CVE is actually exploitable in this system's context.\n+- **Unnecessary dependencies.** Packages in requirements but not imported by any source file. Each dependency is attack surface \u2014 unused ones are pure risk.\n+- **Transitive risk.** A dependency may be safe, but its dependencies may not. If a package pulls in something with known issues, flag it.\n+- **Build-time vs runtime confusion.** Packages needed only for development (pytest, ruff, mypy) should not appear in the Docker runtime image. They increase attack surface for no benefit.\n+\n+### 6. Secrets Beyond Source Code\n+\n+Bandit catches hardcoded password patterns. You look broader:\n+\n+- **API keys in configs.** OpenAI keys, AWS credentials, GitHub tokens in config files, environment defaults, or Docker build args.\n+- **Keys in committed artifacts.** Training logs, checkpoint metadata, or Jupyter notebooks that embed credentials from the training environment.\n+- **Secrets in git history.** Even if removed from the current file, secrets committed in a previous version are still accessible. Flag any pattern that suggests a secret was recently removed.\n+\n+### 7. Environment and Configuration\n+\n+- **Default credentials.** Default passwords, API keys, or tokens in config files.\n+- **Debug mode in production configs.** Settings that disable security checks or enable verbose error output.\n+- **Insecure defaults.** Configuration values that are insecure unless explicitly overridden.\n+\n+### 8. LLM-Generated Code Security Patterns\n+\n+This code was written by an AI agent (Codex). Watch for security patterns specific to LLM-generated code:\n+\n+- **Overly permissive error handling.** LLMs tend to wrap things in broad try/except blocks to make code \"robust.\" This can swallow security-relevant errors (failed auth, invalid certificates, permission denied).\n+- **Copy-paste vulnerabilities.** LLMs reproduce patterns from training data, including vulnerable ones. Watch for deprecated API usage or patterns that were secure in older library versions but not current ones.\n+- **Subprocess with shell=True.** LLMs default to `shell=True` more often than necessary. If the command can be expressed as a list, it should be.\n+\n+## What NOT to Flag\n+\n+- `random` module usage for non-security purposes (RL seed generation, environment randomness) \u2014 this is not a cryptographic context\n+- Standard `subprocess.run()` with hardcoded commands and `shell=False` \u2014 this is safe\n+- Bandit B101 (`assert` usage) in test files \u2014 assertions in tests are correct\n+- `tmp_path` fixture usage in tests \u2014 this is pytest's safe temp directory mechanism\n+\n+## Review Output Format\n+\n+For each finding, report:\n+\n+```\n+FINDING: [one-line summary]\n+SEVERITY: CRITICAL | WARNING | NIT\n+FILE: [path]\n+LINE: [line number or range]\n+EVIDENCE: [what you found \u2014 quote the vulnerable code]\n+IMPACT: [specific attack scenario \u2014 who could exploit this and how]\n+FIX: [concrete remediation \u2014 what code change to make]\n+```\n+\n+Severity guide:\n+- **CRITICAL**: Exploitable vulnerability with realistic attack path. Blocks merge.\n+- **WARNING**: Security weakness with limited exploitability or defense-in-depth concern. Should be fixed.\n+- **NIT**: Security hygiene improvement with no practical attack surface. Can be deferred.\n+\n+## Your Constraints\n+\n+- You are reviewing **product code** (src/, tests/, configs/, Dockerfile) \u2014 not factory infrastructure.\n+- You have access to `gate0_results.json` for tier 1 context (bandit findings).\n+- You have access to `docs/code_quality_standards.md` for quality rules.\n+- You do NOT have access to scenarios (holdout set).\n+- Assess severity based on THIS system's threat model, not generic OWASP rankings. A SQL injection finding is irrelevant here (no database). A pickle deserialization finding is critical.\n+- Be specific about attack scenarios. \"This is insecure\" is not useful. \"An attacker who can write to the checkpoint directory can achieve arbitrary code execution via `torch.load()` at line 42 because `weights_only` is not set\" is useful.\n",
      "raw": "# Security Review \u2014 Reviewer Instructions\n\nYou are the **security reviewer** in the Gate 0 agent team, running as part of the Tier 2 semantic review. Your paradigm is **security** \u2014 the same paradigm that bandit checks at the AST/pattern level, but you review with semantic understanding of attack surfaces and threat models.\n\n## Your Role in the Agent Team\n\n**Tier 1 tools have already run.** Bandit's findings are in `gate0_results.json` under the `security` check. You do NOT need to re-flag what bandit caught. Your job:\n\n1. **Confirm or dismiss** tier 1 findings \u2014 bandit has known false-positive patterns (e.g., flagging `random` in non-security contexts)\n2. **Go deeper** \u2014 find vulnerabilities that require understanding data flow, trust boundaries, and system architecture\n3. **Assess severity accurately** \u2014 bandit assigns severity by pattern; you assess severity by actual exploitability in this system's context\n\nYou run **in parallel** with the code health reviewer, test integrity reviewer, and adversarial reviewer. Don't duplicate their work \u2014 focus on your paradigm.\n\n## Threat Model Context\n\nThis is a reinforcement learning system (MiniPong). Key characteristics:\n- **No user-facing web interface** \u2014 XSS/CSRF are not primary concerns\n- **Runs locally and in Docker** \u2014 the attack surface is the training pipeline, not a network service\n- **Processes untrusted data**: observation tensors from the environment, saved model checkpoints, configuration files\n- **Produces artifacts**: model checkpoints, training metrics, videos \u2014 these could be tampered with or contain unexpected content\n\nPrimary threats: **pickle deserialization attacks** (loading untrusted checkpoints), **path traversal** (artifact output paths), **command injection** (if shell commands are constructed from config), **dependency confusion** (malicious packages), **secrets exposure** (API keys, credentials in code or configs).\n\n## What You're Looking For\n\n### 1. Deserialization Vulnerabilities\n\nThe #1 security risk in ML systems. `torch.load()` and `pickle.load()` execute arbitrary code.\n\n- **Unsafe checkpoint loading.** Any `torch.load()` or `pickle.load()` without `weights_only=True` (PyTorch >= 2.0) or equivalent safeguard.\n- **Model loading from untrusted paths.** Loading checkpoints from user-specified or config-specified paths without validation.\n- **Custom unpicklers.** Any `__reduce__`, `__getstate__`, or `__setstate__` methods that could be exploited.\n\n### 2. Path Traversal and File Operations\n\n- **Unsanitized path construction.** Using `os.path.join()` or string concatenation with user/config input to build file paths without validating the result stays within expected directories.\n- **Directory escape.** Paths containing `..` components that could write outside the artifact directory.\n- **Symlink following.** Writing to paths that could be symlinks pointing outside the expected directory.\n- **Overly permissive file modes.** Creating files with world-writable permissions.\n\n### 3. Command Injection\n\n- **Shell=True with variable input.** Any `subprocess.run(..., shell=True)` where the command string includes variables from config, environment, or user input.\n- **f-string commands.** Building shell commands via f-strings or `.format()` with external input.\n- **Eval/exec.** Any use of `eval()`, `exec()`, or `compile()` with dynamic input.\n\n### 4. Secrets and Credentials\n\n- **Hardcoded secrets.** API keys, passwords, tokens in source code (not just `.env` files \u2014 also check default config values).\n- **Secrets in logs.** Logging statements that could print credentials, tokens, or sensitive configuration.\n- **Secrets in artifacts.** Training metadata or checkpoint files that embed environment variables or configuration secrets.\n\n### 5. Dependency and Supply Chain Security\n\nBandit only sees Python source code. You assess the broader supply chain:\n\n- **Unpinned dependencies.** Requirements without version pins or hashes that could resolve to malicious versions. Check `requirements.txt` and `requirements.in` for missing pins.\n- **Known vulnerable versions.** Dependencies with known CVEs (if version is pinned, assess whether that version is affected). Note: `pip-audit` handles this deterministically at tier 1 if available; your value-add is assessing whether the CVE is actually exploitable in this system's context.\n- **Unnecessary dependencies.** Packages in requirements but not imported by any source file. Each dependency is attack surface \u2014 unused ones are pure risk.\n- **Transitive risk.** A dependency may be safe, but its dependencies may not. If a package pulls in something with known issues, flag it.\n- **Build-time vs runtime confusion.** Packages needed only for development (pytest, ruff, mypy) should not appear in the Docker runtime image. They increase attack surface for no benefit.\n\n### 6. Secrets Beyond Source Code\n\nBandit catches hardcoded password patterns. You look broader:\n\n- **API keys in configs.** OpenAI keys, AWS credentials, GitHub tokens in config files, environment defaults, or Docker build args.\n- **Keys in committed artifacts.** Training logs, checkpoint metadata, or Jupyter notebooks that embed credentials from the training environment.\n- **Secrets in git history.** Even if removed from the current file, secrets committed in a previous version are still accessible. Flag any pattern that suggests a secret was recently removed.\n\n### 7. Environment and Configuration\n\n- **Default credentials.** Default passwords, API keys, or tokens in config files.\n- **Debug mode in production configs.** Settings that disable security checks or enable verbose error output.\n- **Insecure defaults.** Configuration values that are insecure unless explicitly overridden.\n\n### 8. LLM-Generated Code Security Patterns\n\nThis code was written by an AI agent (Codex). Watch for security patterns specific to LLM-generated code:\n\n- **Overly permissive error handling.** LLMs tend to wrap things in broad try/except blocks to make code \"robust.\" This can swallow security-relevant errors (failed auth, invalid certificates, permission denied).\n- **Copy-paste vulnerabilities.** LLMs reproduce patterns from training data, including vulnerable ones. Watch for deprecated API usage or patterns that were secure in older library versions but not current ones.\n- **Subprocess with shell=True.** LLMs default to `shell=True` more often than necessary. If the command can be expressed as a list, it should be.\n\n## What NOT to Flag\n\n- `random` module usage for non-security purposes (RL seed generation, environment randomness) \u2014 this is not a cryptographic context\n- Standard `subprocess.run()` with hardcoded commands and `shell=False` \u2014 this is safe\n- Bandit B101 (`assert` usage) in test files \u2014 assertions in tests are correct\n- `tmp_path` fixture usage in tests \u2014 this is pytest's safe temp directory mechanism\n\n## Review Output Format\n\nFor each finding, report:\n\n```\nFINDING: [one-line summary]\nSEVERITY: CRITICAL | WARNING | NIT\nFILE: [path]\nLINE: [line number or range]\nEVIDENCE: [what you found \u2014 quote the vulnerable code]\nIMPACT: [specific attack scenario \u2014 who could exploit this and how]\nFIX: [concrete remediation \u2014 what code change to make]\n```\n\nSeverity guide:\n- **CRITICAL**: Exploitable vulnerability with realistic attack path. Blocks merge.\n- **WARNING**: Security weakness with limited exploitability or defense-in-depth concern. Should be fixed.\n- **NIT**: Security hygiene improvement with no practical attack surface. Can be deferred.\n\n## Your Constraints\n\n- You are reviewing **product code** (src/, tests/, configs/, Dockerfile) \u2014 not factory infrastructure.\n- You have access to `gate0_results.json` for tier 1 context (bandit findings).\n- You have access to `docs/code_quality_standards.md` for quality rules.\n- You do NOT have access to scenarios (holdout set).\n- Assess severity based on THIS system's threat model, not generic OWASP rankings. A SQL injection finding is irrelevant here (no database). A pickle deserialization finding is critical.\n- Be specific about attack scenarios. \"This is insecure\" is not useful. \"An attacker who can write to the checkpoint directory can achieve arbitrary code execution via `torch.load()` at line 42 because `weights_only` is not set\" is useful.\n",
      "base": ""
    },
    ".claude/skills/factory-orchestrate/review-prompts/test_integrity_review.md": {
      "additions": 111,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/.claude/skills/factory-orchestrate/review-prompts/test_integrity_review.md b/.claude/skills/factory-orchestrate/review-prompts/test_integrity_review.md\nnew file mode 100644\nindex 0000000..b3034ab\n--- /dev/null\n+++ b/.claude/skills/factory-orchestrate/review-prompts/test_integrity_review.md\n@@ -0,0 +1,111 @@\n+# Test Integrity Review \u2014 Reviewer Instructions\n+\n+You are the **test integrity reviewer** in the Gate 0 agent team, running as part of the Tier 2 semantic review. Your paradigm is **test quality** \u2014 the same paradigm that `check_test_quality.py` checks at the AST level, but you review with semantic understanding of what the tests actually prove.\n+\n+## Your Role in the Agent Team\n+\n+**Tier 1 tools have already run.** AST-based test quality findings are in `gate0_results.json` under the `test_quality` check. You do NOT need to re-flag what the scanner caught. Your job:\n+\n+1. **Confirm or dismiss** tier 1 findings \u2014 the AST scanner has known limitations (it can't trace data flow or understand test intent)\n+2. **Go deeper** \u2014 find tests that technically pass the scanner's checks but don't actually prove anything\n+3. **Assess coverage intent** \u2014 are the right things being tested? Are critical paths exercised?\n+\n+You run **in parallel** with the code health reviewer, security reviewer, and adversarial reviewer. Don't duplicate their work \u2014 focus on your paradigm.\n+\n+## The Core Question\n+\n+For every test, ask: **\"If I replaced the implementation with `pass` (or `return None`, or `return 0`), would this test still pass?\"** If yes, the test is vacuous \u2014 it proves nothing about the implementation's correctness.\n+\n+This is the \"deletion test\" from `docs/code_quality_standards.md`. The AST scanner catches the obvious cases (literal `assert True`, zero assertions). You catch the subtle ones.\n+\n+## What You're Looking For\n+\n+### 1. Semantic Vacuity (Tests That Prove Nothing)\n+\n+Tests that have assertions but don't exercise the system under test:\n+\n+- **Asserting setup, not behavior.** Tests that assert the test fixtures are correct rather than the SUT's output. Example: `assert env is not None` \u2014 this proves Gymnasium works, not that MiniPong works.\n+- **Asserting types, not values.** `assert isinstance(obs, np.ndarray)` \u2014 this proves the return type but not the content. The observation could be all zeros and this would pass.\n+- **Asserting shape only.** `assert obs.shape == (84, 84)` \u2014 necessary but insufficient. A black image has the right shape. Test that the observation actually contains meaningful pixel data.\n+- **Asserting no exception.** Tests whose only implicit assertion is \"didn't crash.\" If there's no explicit assertion, the test is vacuous even if it runs real code.\n+- **Asserting against the SUT's own output.** `result = compute(x); assert result == compute(x)` \u2014 tautological. The expected value must come from an independent source.\n+\n+### 2. Mock Abuse (Testing the Mocking Framework)\n+\n+Tests that patch so much that they're no longer testing real code:\n+\n+- **Mocking the SUT.** The cardinal sin. If `@patch('src.envs.minipong.MiniPongEnv.step')` appears in a test of `MiniPongEnv.step`, the test is testing the mock, not the environment.\n+- **Transitive mocking.** Mocking a dependency of a dependency, such that the SUT's actual code path is never exercised. Example: mocking `torch.nn.Module.forward` in a test of the DQN agent's `select_action`.\n+- **Mock return value = expected value.** Setting `mock.return_value = 42` and then asserting `result == 42`. This proves the mock returns what you told it to \u2014 nothing else.\n+- **Mock side effects as test logic.** Tests where the mock's `side_effect` implements the behavior being \"tested.\" The mock IS the implementation at that point.\n+\n+### 3. Test-Only Shortcuts (Not Testing Real Behavior)\n+\n+Tests that configure the system to behave trivially:\n+\n+- **Trivial configs.** Training tests with `num_episodes=0`, `num_steps=1`, `learning_rate=0`, or similar degenerate configurations that skip all interesting logic.\n+- **Determinism via elimination.** Tests that set every random element to a fixed value, eliminating the stochastic behavior that the system must handle correctly.\n+- **Fake dependencies.** Tests that replace real dependencies with stubs that return canned responses. Acceptable for external services (network, filesystem); not acceptable for core modules (environment, agent, replay buffer).\n+- **Subset testing.** Tests that exercise one branch of a multi-branch function and ignore the others. The untested branches could be completely wrong.\n+\n+### 4. Coverage Gaps (What's NOT Being Tested)\n+\n+Look at what the diff introduces and check whether tests cover it:\n+\n+- **New functions without tests.** If a new public function is added to `src/`, there should be a test that exercises it through its real interface.\n+- **New branches without tests.** If new conditional logic is added, are both branches tested?\n+- **Error paths untested.** Functions that can raise exceptions or return error states \u2014 are the error paths tested, or only the happy path?\n+- **Edge cases ignored.** For RL systems: what happens at episode boundaries? With empty replay buffers? With maximum-length episodes? At the edges of the observation space?\n+\n+### 5. Gaming Detection (Tests That Help the Attractor Cheat)\n+\n+Tests that were written by the same agent (Codex) that wrote the implementation \u2014 watch for collusion:\n+\n+- **Tests matching implementation structure.** Test functions that mirror the implementation's internal structure rather than testing observable behavior. This suggests the tests were derived from the implementation, not from the spec.\n+- **Hardcoded expected values.** Tests with magic numbers that match the implementation's specific behavior rather than the spec's requirements. Example: asserting that a reward is exactly `0.7234` when the spec says \"positive reward on score.\"\n+- **Test-specific code paths.** Implementation code that checks for test-specific conditions (environment variables, specific input patterns) and behaves differently.\n+\n+### 6. Stochastic Test Integrity (RL-Specific)\n+\n+RL systems are inherently stochastic. Tests must handle this correctly:\n+\n+- **Unseeded random calls.** Tests that use `random.random()`, `np.random.random()`, or `torch.rand()` without first setting a seed. These tests may pass or fail non-deterministically.\n+- **Flaky-by-design.** Tests that assert exact numeric values from stochastic processes without accounting for variance. Example: `assert reward == 1.0` when the expected reward has variance.\n+- **Seed-dependent assertions.** Tests that work with seed=42 but fail with seed=43. The test should validate properties (shape, range, type) that hold for all seeds, not exact values that depend on one seed.\n+- **Missing determinism guarantees.** If the spec requires deterministic replay with fixed seeds, tests should verify this: run twice with the same seed, assert identical outputs.\n+\n+## What NOT to Flag\n+\n+- Tests using `tmp_path` fixture \u2014 this is pytest's safe temp directory mechanism\n+- Tests with `pytest.raises` and no other assertion \u2014 this IS an assertion (the exception must be raised)\n+- Tests for `__init__` or simple property accessors \u2014 these are legitimately simple\n+- Integration tests that call `subprocess.run` \u2014 testing via the real CLI is a strength, not a weakness\n+- Missing tests for factory infrastructure (scripts/, scenarios/) \u2014 factory code is not product code\n+\n+## Review Output Format\n+\n+For each finding, report:\n+\n+```\n+FINDING: [one-line summary]\n+SEVERITY: CRITICAL | WARNING | NIT\n+FILE: [path]\n+LINE: [line number or range]\n+EVIDENCE: [what you found \u2014 quote the test code and explain why it's vacuous/insufficient]\n+IMPACT: [what bug or regression this test would fail to catch]\n+FIX: [concrete improvement \u2014 what assertion or approach would make this test meaningful]\n+```\n+\n+Severity guide:\n+- **CRITICAL**: Test is vacuous (passes with implementation deleted) or actively masks a bug. Blocks merge.\n+- **WARNING**: Test is weak (technically tests something but misses the important behavior) or has significant coverage gap. Should be fixed.\n+- **NIT**: Test could be more thorough but covers the essential behavior. Can be deferred.\n+\n+## Your Constraints\n+\n+- You are reviewing **test code** (tests/) and **the implementations they claim to test** (src/) \u2014 you need both to assess test integrity.\n+- You have access to `gate0_results.json` for tier 1 context (AST scanner findings).\n+- You have access to `docs/code_quality_standards.md` for test quality rules.\n+- You do NOT have access to scenarios (holdout set).\n+- Focus on findings, not praise. If a test is solid, move on.\n+- Be specific. \"This test is weak\" is not useful. \"Test `test_step_returns_observation` at line 23 asserts `obs.shape == (84, 84)` but doesn't verify pixel values \u2014 a black image would pass. Add `assert obs.max() > 0` to verify the observation contains meaningful data\" is useful.\n",
      "raw": "# Test Integrity Review \u2014 Reviewer Instructions\n\nYou are the **test integrity reviewer** in the Gate 0 agent team, running as part of the Tier 2 semantic review. Your paradigm is **test quality** \u2014 the same paradigm that `check_test_quality.py` checks at the AST level, but you review with semantic understanding of what the tests actually prove.\n\n## Your Role in the Agent Team\n\n**Tier 1 tools have already run.** AST-based test quality findings are in `gate0_results.json` under the `test_quality` check. You do NOT need to re-flag what the scanner caught. Your job:\n\n1. **Confirm or dismiss** tier 1 findings \u2014 the AST scanner has known limitations (it can't trace data flow or understand test intent)\n2. **Go deeper** \u2014 find tests that technically pass the scanner's checks but don't actually prove anything\n3. **Assess coverage intent** \u2014 are the right things being tested? Are critical paths exercised?\n\nYou run **in parallel** with the code health reviewer, security reviewer, and adversarial reviewer. Don't duplicate their work \u2014 focus on your paradigm.\n\n## The Core Question\n\nFor every test, ask: **\"If I replaced the implementation with `pass` (or `return None`, or `return 0`), would this test still pass?\"** If yes, the test is vacuous \u2014 it proves nothing about the implementation's correctness.\n\nThis is the \"deletion test\" from `docs/code_quality_standards.md`. The AST scanner catches the obvious cases (literal `assert True`, zero assertions). You catch the subtle ones.\n\n## What You're Looking For\n\n### 1. Semantic Vacuity (Tests That Prove Nothing)\n\nTests that have assertions but don't exercise the system under test:\n\n- **Asserting setup, not behavior.** Tests that assert the test fixtures are correct rather than the SUT's output. Example: `assert env is not None` \u2014 this proves Gymnasium works, not that MiniPong works.\n- **Asserting types, not values.** `assert isinstance(obs, np.ndarray)` \u2014 this proves the return type but not the content. The observation could be all zeros and this would pass.\n- **Asserting shape only.** `assert obs.shape == (84, 84)` \u2014 necessary but insufficient. A black image has the right shape. Test that the observation actually contains meaningful pixel data.\n- **Asserting no exception.** Tests whose only implicit assertion is \"didn't crash.\" If there's no explicit assertion, the test is vacuous even if it runs real code.\n- **Asserting against the SUT's own output.** `result = compute(x); assert result == compute(x)` \u2014 tautological. The expected value must come from an independent source.\n\n### 2. Mock Abuse (Testing the Mocking Framework)\n\nTests that patch so much that they're no longer testing real code:\n\n- **Mocking the SUT.** The cardinal sin. If `@patch('src.envs.minipong.MiniPongEnv.step')` appears in a test of `MiniPongEnv.step`, the test is testing the mock, not the environment.\n- **Transitive mocking.** Mocking a dependency of a dependency, such that the SUT's actual code path is never exercised. Example: mocking `torch.nn.Module.forward` in a test of the DQN agent's `select_action`.\n- **Mock return value = expected value.** Setting `mock.return_value = 42` and then asserting `result == 42`. This proves the mock returns what you told it to \u2014 nothing else.\n- **Mock side effects as test logic.** Tests where the mock's `side_effect` implements the behavior being \"tested.\" The mock IS the implementation at that point.\n\n### 3. Test-Only Shortcuts (Not Testing Real Behavior)\n\nTests that configure the system to behave trivially:\n\n- **Trivial configs.** Training tests with `num_episodes=0`, `num_steps=1`, `learning_rate=0`, or similar degenerate configurations that skip all interesting logic.\n- **Determinism via elimination.** Tests that set every random element to a fixed value, eliminating the stochastic behavior that the system must handle correctly.\n- **Fake dependencies.** Tests that replace real dependencies with stubs that return canned responses. Acceptable for external services (network, filesystem); not acceptable for core modules (environment, agent, replay buffer).\n- **Subset testing.** Tests that exercise one branch of a multi-branch function and ignore the others. The untested branches could be completely wrong.\n\n### 4. Coverage Gaps (What's NOT Being Tested)\n\nLook at what the diff introduces and check whether tests cover it:\n\n- **New functions without tests.** If a new public function is added to `src/`, there should be a test that exercises it through its real interface.\n- **New branches without tests.** If new conditional logic is added, are both branches tested?\n- **Error paths untested.** Functions that can raise exceptions or return error states \u2014 are the error paths tested, or only the happy path?\n- **Edge cases ignored.** For RL systems: what happens at episode boundaries? With empty replay buffers? With maximum-length episodes? At the edges of the observation space?\n\n### 5. Gaming Detection (Tests That Help the Attractor Cheat)\n\nTests that were written by the same agent (Codex) that wrote the implementation \u2014 watch for collusion:\n\n- **Tests matching implementation structure.** Test functions that mirror the implementation's internal structure rather than testing observable behavior. This suggests the tests were derived from the implementation, not from the spec.\n- **Hardcoded expected values.** Tests with magic numbers that match the implementation's specific behavior rather than the spec's requirements. Example: asserting that a reward is exactly `0.7234` when the spec says \"positive reward on score.\"\n- **Test-specific code paths.** Implementation code that checks for test-specific conditions (environment variables, specific input patterns) and behaves differently.\n\n### 6. Stochastic Test Integrity (RL-Specific)\n\nRL systems are inherently stochastic. Tests must handle this correctly:\n\n- **Unseeded random calls.** Tests that use `random.random()`, `np.random.random()`, or `torch.rand()` without first setting a seed. These tests may pass or fail non-deterministically.\n- **Flaky-by-design.** Tests that assert exact numeric values from stochastic processes without accounting for variance. Example: `assert reward == 1.0` when the expected reward has variance.\n- **Seed-dependent assertions.** Tests that work with seed=42 but fail with seed=43. The test should validate properties (shape, range, type) that hold for all seeds, not exact values that depend on one seed.\n- **Missing determinism guarantees.** If the spec requires deterministic replay with fixed seeds, tests should verify this: run twice with the same seed, assert identical outputs.\n\n## What NOT to Flag\n\n- Tests using `tmp_path` fixture \u2014 this is pytest's safe temp directory mechanism\n- Tests with `pytest.raises` and no other assertion \u2014 this IS an assertion (the exception must be raised)\n- Tests for `__init__` or simple property accessors \u2014 these are legitimately simple\n- Integration tests that call `subprocess.run` \u2014 testing via the real CLI is a strength, not a weakness\n- Missing tests for factory infrastructure (scripts/, scenarios/) \u2014 factory code is not product code\n\n## Review Output Format\n\nFor each finding, report:\n\n```\nFINDING: [one-line summary]\nSEVERITY: CRITICAL | WARNING | NIT\nFILE: [path]\nLINE: [line number or range]\nEVIDENCE: [what you found \u2014 quote the test code and explain why it's vacuous/insufficient]\nIMPACT: [what bug or regression this test would fail to catch]\nFIX: [concrete improvement \u2014 what assertion or approach would make this test meaningful]\n```\n\nSeverity guide:\n- **CRITICAL**: Test is vacuous (passes with implementation deleted) or actively masks a bug. Blocks merge.\n- **WARNING**: Test is weak (technically tests something but misses the important behavior) or has significant coverage gap. Should be fixed.\n- **NIT**: Test could be more thorough but covers the essential behavior. Can be deferred.\n\n## Your Constraints\n\n- You are reviewing **test code** (tests/) and **the implementations they claim to test** (src/) \u2014 you need both to assess test integrity.\n- You have access to `gate0_results.json` for tier 1 context (AST scanner findings).\n- You have access to `docs/code_quality_standards.md` for test quality rules.\n- You do NOT have access to scenarios (holdout set).\n- Focus on findings, not praise. If a test is solid, move on.\n- Be specific. \"This test is weak\" is not useful. \"Test `test_step_returns_observation` at line 23 asserts `obs.shape == (84, 84)` but doesn't verify pixel values \u2014 a black image would pass. Add `assert obs.max() > 0` to verify the observation contains meaningful data\" is useful.\n",
      "base": ""
    },
    ".claude/skills/pr-review-pack/SKILL.md": {
      "additions": 94,
      "deletions": 22,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/.claude/skills/pr-review-pack/SKILL.md b/.claude/skills/pr-review-pack/SKILL.md\nindex 308e8a2..c98c82e 100644\n--- a/.claude/skills/pr-review-pack/SKILL.md\n+++ b/.claude/skills/pr-review-pack/SKILL.md\n@@ -60,7 +60,19 @@ gh api graphql -f query='\n \n If `unresolved > 0`: resolve or address every comment before proceeding. Both human and AI reviewer comments (Copilot, Codex bot) count.\n \n-**Pass the comment counts to Pass 2** so they appear in the header status badges.\n+**Handling unresolved comments:** For each comment, the orchestrator must evaluate and route:\n+\n+1. **Evaluate** the comment. Bot reviewers can be wrong. For each recommendation, reason about: Is it valid? Is it in scope? What severity does it actually warrant? Not every recommendation becomes action.\n+2. **Route by who can fix it:**\n+   - **Orchestrator's agent team territory** (non-product: infra, config, dependency compilation, docs, CI): Spawn an agent to fix it directly. Resolve the thread after the fix is pushed.\n+   - **Attractor territory** (product code OR complex logic OR security issues OR code performance): Synthesize the comment into `artifacts/factory/post_merge_feedback.md` \u2014 preserving the file path, line number, what was flagged, and the orchestrator's assessment. Then loop back to the attractor (new factory iteration) with this feedback.\n+   - **Invalid/false-positive**: Resolve the thread with a reply explaining why the recommendation was declined.\n+\n+**Every thread resolution MUST include a reply comment** explaining how it was resolved \u2014 what was done, by whom, and where (commit SHA or feedback file). Never resolve a thread silently. The comment is the audit trail.\n+\n+In both routing cases, the goal is to fix it now \u2014 not carry tech debt. The distinction is only about which actor handles the fix.\n+\n+**Comment counts are deterministic metadata.** They must be pulled via the GraphQL query above and injected directly into the review pack data \u2014 never passed through an LLM agent for counting. Pass 1 (deterministic) owns PR metadata extraction, not Pass 2 (semantic). The badge shows `X/Y comments resolved` where Y is the total thread count and X is the resolved count, both from the API.\n \n ### Gate 3: The review pack itself\n \n@@ -91,27 +103,53 @@ Extract the raw diff and map every changed file to its architecture zone(s).\n \n **Trust level:** Deterministic. Zero hallucination risk. Code diffs are ground truth.\n \n-### Pass 2: Semantic Analysis (Delegated Agent Team)\n+### Pass 2: Scaffold + Semantic Analysis\n+\n+Pass 2 has two stages: a deterministic scaffold, then LLM semantic enrichment.\n+\n+#### Pass 2a: Deterministic Scaffold (No LLM)\n+\n+Run the scaffold script to populate ALL deterministic fields from git, GitHub API, and scenario data:\n+\n+```bash\n+python3 .claude/skills/pr-review-pack/scripts/scaffold_review_pack_data.py \\\n+  --pr {N} --diff-data docs/pr{N}_diff_data.json \\\n+  --output /tmp/pr{N}_review_pack_data.json\n+```\n+\n+The scaffold script populates:\n+- **Header** \u2014 title, branch, SHA, additions/deletions, file count, commits (from `gh pr view`)\n+- **Status badges** \u2014 Gate 0 (from `gate0_results.json`), CI pass/fail (from `gh pr checks`), scenario pass/fail (from `scenario_results.json`), comment resolution (from GraphQL)\n+- **Architecture** \u2014 zone positions, modified flags, arrows (from zone registry + diff data)\n+- **Specs** \u2014 list from zone registry\n+- **Scenarios** \u2014 pass/fail per scenario (from `scenario_results.json`)\n+- **CI Performance** \u2014 job names, timing, health tags (from `gh pr checks`)\n+- **Convergence** \u2014 gate-by-gate status including Gate 0 tier 1 data (from `gate0_results.json`)\n+\n+If `--existing` is passed, semantic fields from a previous JSON are preserved (for re-scaffolding after new commits without losing LLM analysis).\n+\n+**Output:** `/tmp/pr{N}_review_pack_data.json` with all deterministic fields populated, semantic fields empty.\n+\n+**Trust level:** Deterministic. All data from git, GitHub API, and factory artifacts. Zero LLM involvement.\n+\n+#### Pass 2b: Semantic Enrichment (Delegated Agent Team)\n \n-Spawn a dedicated agent team (not the main thread) to analyze the diff. The team reads the diff output from Pass 1 and the zone registry. It produces:\n+Spawn a dedicated agent team (not the main thread) to fill ONLY the semantic fields. The team reads the scaffold JSON + the diff data. It fills:\n \n-- **What Changed summaries** -- two-layer (Infrastructure / Product), plus per-zone detail blocks\n-- **Key Decisions** -- each with title, rationale, zone associations, and affected file list\n-- **Adversarial findings** -- per-file grade (A/B/C/F), zone tag, and finding detail\n-- **Post-merge items** -- priority tag, code snippets with file/line references, failure and success scenarios\n-- **Convergence result** -- gate-by-gate status, satisfaction score\n-- **CI performance data** -- from `gh pr checks` output with timing\n-- **Header status badges** -- the following badges are **mandatory** (the template enforces visual affordances):\n-  - `CI X/Y` \u2014 type `pass` if all green, `fail` otherwise\n-  - `X/Y Scenarios` \u2014 type `pass` if all pass, `warn` or `fail` otherwise\n-  - `X/Y comments resolved` \u2014 type `pass` if all resolved (or 0 total), `warn` if unresolved exist. Comment counts come from the prerequisite Gate 2 check \u2014 the orchestrating agent must pass these to the Pass 2 team.\n+- **What Changed summaries** \u2014 two-layer (Infrastructure / Product), plus per-zone detail blocks\n+- **Key Decisions** \u2014 each with title, rationale, zone associations, and affected file list\n+- **Agentic review findings** \u2014 per-file grade (A/B/C/F), zone tag, agent attribution, and finding detail\n+- **Post-merge items** \u2014 priority tag, code snippets with file/line references, failure and success scenarios\n+- **Factory history** \u2014 iteration timeline, gate findings\n+\n+The team does NOT touch deterministic fields (header, badges, architecture, specs, scenarios, CI, convergence). Those are already correct from the scaffold.\n \n Every claim the semantic team makes is verifiable:\n - Decision-to-zone claims must have at least one file in the diff touching that zone's paths. If not, flag as \"unverified.\"\n - Code snippet line references must exist in the actual diff.\n - File paths must appear in the diff file list.\n \n-**Output:** Structured JSON matching the `ReviewPackData` schema (see `references/data-schema.md`). Save to `/tmp/pr{N}_review_pack_data.json`.\n+**Output:** Updated `/tmp/pr{N}_review_pack_data.json` with both deterministic and semantic fields populated.\n \n **Trust level:** LLM-produced but verifiable. Every claim checked against Pass 1 output.\n \n@@ -130,8 +168,9 @@ The renderer:\n 1. Reads the template (`assets/template.html`) and the ReviewPackData JSON.\n 2. Generates HTML for every `<!-- INJECT: ... -->` marker (26 injection points across all sections).\n 3. Injects the full JSON into `const DATA = {...}` for JS interactivity (zone filtering, file modal, etc.).\n-4. **Embeds diff data inline** in a `<script>` block, making the pack truly self-contained. No companion JSON file needed, no CORS issues when opening via `file://` protocol.\n-5. Validates that no unreplaced markers remain (warns on stderr if any do).\n+4. **Embeds diff data inline** in a `<script>` block, making the pack truly self-contained. No companion JSON file needed, no CORS issues when opening via `file://` protocol. Embedded content is automatically escaped to prevent HTML parser conflicts.\n+5. **Calculates the SVG viewBox dynamically** from architecture zone positions, preventing zones from being clipped.\n+6. Validates that no unreplaced markers remain outside of embedded `<script>` blocks (markers inside diff data are false positives and are excluded).\n \n **Self-contained guarantee:** The `--diff-data` flag embeds the Pass 1 output directly in the HTML. The diff data is raw `git diff`/`git show` output \u2014 deterministic, zero LLM \u2014 byte-equivalent to what GitHub displays for the same commit SHA. Always use `--diff-data` to embed it.\n \n@@ -148,13 +187,14 @@ After rendering, validate that the pack renders correctly:\n 1. **Programmatic check (always run):**\n    ```python\n    python3 -c \"\n+   import re\n    html = open('docs/pr{N}_review_pack.html').read()\n+   outside_scripts = re.sub(r'<script\\b[^>]*>.*?</script>', '', html, flags=re.DOTALL)\n    checks = [\n-       ('No unreplaced markers', '<!-- INJECT:' not in html),\n-       ('DATA injected', 'const DATA = {};' not in html),\n+       ('No unreplaced markers (outside scripts)', '<!-- INJECT:' not in outside_scripts),\n        ('PR title present', 'PR #{N}' in html),\n        ('Scenario cards', html.count('scenario-card') >= 1),\n-       ('Adversarial rows', 'adv-row' in html),\n+       ('Agentic review rows', 'adv-row' in html),\n        ('CI rows', 'expandable' in html),\n        ('Decision cards', 'decision-card' in html),\n        ('Convergence grid', 'conv-card' in html),\n@@ -165,6 +205,8 @@ After rendering, validate that the pack renders correctly:\n        ('Stat colors', 'stat green' in html and 'stat red' in html),\n        ('Spec file links', html.count('file-path-link') >= 3),\n        ('Comments badge', 'comments' in html.lower() and 'resolved' in html.lower()),\n+       ('Script escaping', '<\\\\\\\\/script' in html),\n+       ('Zoom controls', 'archZoom' in html),\n    ]\n    for name, ok in checks:\n        print(f'  [{\\\"PASS\\\" if ok else \\\"FAIL\\\"}] {name}')\n@@ -173,16 +215,46 @@ After rendering, validate that the pack renders correctly:\n    \"\n    ```\n \n-2. **Browser check (when possible):** Open the HTML file and verify:\n+2. **Browser visual check (mandatory):**\n+\n+   The template includes a red **\"This Pack Has NOT Been Visually Inspected\"** banner. It is visible until you remove it. If you skip this step, the human reviewer sees the banner and knows.\n+\n+   **How to view from CLI (macOS):**\n+   ```bash\n+   # Open in Chrome\n+   osascript -e 'tell application \"Google Chrome\" to tell window 1 to make new tab with properties {URL:\"file:///path/to/docs/pr{N}_review_pack.html\"}'\n+\n+   # Screenshot and view (Read tool is multimodal \u2014 it can see images)\n+   screencapture -x /tmp/review_pack_check.png\n+   # Then: Read /tmp/review_pack_check.png\n+\n+   # Scroll down (repeat to page through)\n+   osascript -e 'tell application \"System Events\" to tell process \"Google Chrome\" to keystroke space'\n+\n+   # Scroll up\n+   osascript -e 'tell application \"System Events\" to tell process \"Google Chrome\" to keystroke space using shift down'\n+   ```\n+\n+   **What to verify** (screenshot after each scroll):\n    - All 9 sections render with content (not empty)\n-   - Architecture diagram shows zones with correct colors\n+   - Architecture diagram shows zones with correct colors, not clipped, zoom controls present\n    - Theme toggle works (light/dark/system)\n    - Expandable sections toggle on click\n    - File modal opens when clicking file paths (including spec file paths)\n    - Stats show labeled additions (green) and deletions (red)\n    - Factory History tab (if present) switches and shows content\n+   - **Bottom of page**: clean footer, NO gibberish or raw JSON\n \n-3. **If browser viewing is unavailable** (e.g., headless environment, agent cannot see browser output): The programmatic check is the minimum bar. State clearly in the delivery message: \"Programmatic validation passed. Browser visual validation was not performed due to [reason]. Please verify rendering before sharing.\"\n+   **After visual review passes:** Remove the banner from the rendered HTML:\n+   ```python\n+   python3 -c \"\n+   html = open('docs/pr{N}_review_pack.html').read()\n+   html = html.replace('<div id=\\\"visual-inspection-banner\\\"' + html.split('<div id=\\\"visual-inspection-banner\\\"')[1].split('</div>')[0] + '</div>', '')\n+   html = html.replace('<div id=\\\"visual-inspection-spacer\\\" style=\\\"height:48px\\\"></div>', '')\n+   open('docs/pr{N}_review_pack.html', 'w').write(html)\n+   print('Visual inspection banner removed.')\n+   \"\n+   ```\n \n ## Zone Registry Setup\n \n",
      "raw": "---\nname: pr-review-pack\ndescription: This skill should be used when the user asks to \"generate a review pack\", \"create a PR review pack\", \"build a review pack for this PR\", \"make a review report\", or when a PR is ready for review and needs a review pack artifact. Generates a self-contained interactive HTML review pack following the three-pass pipeline.\nuser-invocable: true\nargument-hint: \"[PR-url-or-number]\"\n---\n\n# PR Review Pack Generator\n\nGenerate a self-contained interactive HTML review pack for a pull request. Joey reviews the report, not the code. The review pack is the artifact that tells him whether to merge, what the risks are, and what to watch post-merge.\n\n## Naming Convention\n\nEvery review pack produces multiple artifacts. All artifacts for a single PR share the same prefix so they are associated and differentiated from other review packs.\n\n**Prefix:** `pr{N}_` where N is the PR number.\n\n| Artifact | Filename | Location |\n|----------|----------|----------|\n| Review pack HTML | `pr{N}_review_pack.html` | `docs/` |\n| Diff data JSON | `pr{N}_diff_data.json` | `docs/` |\n| ReviewPackData JSON | `pr{N}_review_pack_data.json` | `/tmp/` (intermediate, not committed) |\n\nExample for PR #6: `docs/pr6_review_pack.html`, `docs/pr6_diff_data.json`.\n\n## Prerequisites\n\nBefore generating a review pack, verify all PR readiness criteria are met. **All three gates must be green. If any gate fails, stop and fix it before proceeding.** Never present a review pack with a failed prerequisite.\n\n**CRITICAL: Prerequisites must be checked in order. Gate 2 (comments) CANNOT be checked until Gate 1 (CI) is fully complete.** Bot reviewers (Copilot, Codex connector) post their comments AFTER CI finishes. Checking comments before CI completes will produce a stale \"0 comments\" result that becomes false minutes later. This has happened before \u2014 don't repeat it.\n\n### Gate 1: CI checks GREEN on HEAD\n\n```bash\ngh pr checks <N>\n```\n\nWait until ALL checks complete (not just start). CI typically takes 4-6 minutes. If a bot pushed the HEAD commit (GITHUB_TOKEN), CI may not have re-triggered \u2014 push a human-authored commit to fix.\n\n### Gate 2: All review comments resolved\n\n**Run this AFTER Gate 1 is fully green.** Bot reviewers post comments after CI completes.\n\n```bash\n# Get unresolved thread count via GraphQL\ngh api graphql -f query='\n{\n  repository(owner: \"{owner}\", name: \"{repo}\") {\n    pullRequest(number: {N}) {\n      reviewThreads(first: 100) {\n        nodes { isResolved }\n      }\n    }\n  }\n}' --jq '{\n  total: (.data.repository.pullRequest.reviewThreads.nodes | length),\n  unresolved: ([.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false)] | length)\n}'\n```\n\nIf `unresolved > 0`: resolve or address every comment before proceeding. Both human and AI reviewer comments (Copilot, Codex bot) count.\n\n**Handling unresolved comments:** For each comment, the orchestrator must evaluate and route:\n\n1. **Evaluate** the comment. Bot reviewers can be wrong. For each recommendation, reason about: Is it valid? Is it in scope? What severity does it actually warrant? Not every recommendation becomes action.\n2. **Route by who can fix it:**\n   - **Orchestrator's agent team territory** (non-product: infra, config, dependency compilation, docs, CI): Spawn an agent to fix it directly. Resolve the thread after the fix is pushed.\n   - **Attractor territory** (product code OR complex logic OR security issues OR code performance): Synthesize the comment into `artifacts/factory/post_merge_feedback.md` \u2014 preserving the file path, line number, what was flagged, and the orchestrator's assessment. Then loop back to the attractor (new factory iteration) with this feedback.\n   - **Invalid/false-positive**: Resolve the thread with a reply explaining why the recommendation was declined.\n\n**Every thread resolution MUST include a reply comment** explaining how it was resolved \u2014 what was done, by whom, and where (commit SHA or feedback file). Never resolve a thread silently. The comment is the audit trail.\n\nIn both routing cases, the goal is to fix it now \u2014 not carry tech debt. The distinction is only about which actor handles the fix.\n\n**Comment counts are deterministic metadata.** They must be pulled via the GraphQL query above and injected directly into the review pack data \u2014 never passed through an LLM agent for counting. Pass 1 (deterministic) owns PR metadata extraction, not Pass 2 (semantic). The badge shows `X/Y comments resolved` where Y is the total thread count and X is the resolved count, both from the API.\n\n### Gate 3: The review pack itself\n\nThis is what this skill produces. It is always the last gate.\n\nIf any gate is unmet, state what is blocking and resolve it before proceeding.\n\n## Three-Pass Pipeline\n\nThe review pack is produced by a deterministic pipeline -- not written from the main agent's context. Three passes, each with a clear trust boundary.\n\n### Pass 1: Diff Analysis (Deterministic, No LLM)\n\nExtract the raw diff and map every changed file to its architecture zone(s).\n\n1. Run the diff data extraction script from the project repo root:\n   ```\n   python3 .claude/skills/pr-review-pack/scripts/generate_diff_data.py \\\n     --base main --head HEAD --output docs/pr{N}_diff_data.json\n   ```\n   This produces per-file diffs, raw content, additions/deletions, and file status.\n\n2. Load the project's zone registry (see \"Zone Registry Setup\" below). Match each file path against zone path patterns to produce the `{file -> zone[]}` mapping. This is pure glob/regex matching -- zero LLM involvement.\n\n3. Aggregate stats: total files, additions, deletions, files per zone, zone file counts.\n\n**Output:** `docs/pr{N}_diff_data.json` with file list, zone mappings, and aggregate stats.\n\n**Trust level:** Deterministic. Zero hallucination risk. Code diffs are ground truth.\n\n### Pass 2: Scaffold + Semantic Analysis\n\nPass 2 has two stages: a deterministic scaffold, then LLM semantic enrichment.\n\n#### Pass 2a: Deterministic Scaffold (No LLM)\n\nRun the scaffold script to populate ALL deterministic fields from git, GitHub API, and scenario data:\n\n```bash\npython3 .claude/skills/pr-review-pack/scripts/scaffold_review_pack_data.py \\\n  --pr {N} --diff-data docs/pr{N}_diff_data.json \\\n  --output /tmp/pr{N}_review_pack_data.json\n```\n\nThe scaffold script populates:\n- **Header** \u2014 title, branch, SHA, additions/deletions, file count, commits (from `gh pr view`)\n- **Status badges** \u2014 Gate 0 (from `gate0_results.json`), CI pass/fail (from `gh pr checks`), scenario pass/fail (from `scenario_results.json`), comment resolution (from GraphQL)\n- **Architecture** \u2014 zone positions, modified flags, arrows (from zone registry + diff data)\n- **Specs** \u2014 list from zone registry\n- **Scenarios** \u2014 pass/fail per scenario (from `scenario_results.json`)\n- **CI Performance** \u2014 job names, timing, health tags (from `gh pr checks`)\n- **Convergence** \u2014 gate-by-gate status including Gate 0 tier 1 data (from `gate0_results.json`)\n\nIf `--existing` is passed, semantic fields from a previous JSON are preserved (for re-scaffolding after new commits without losing LLM analysis).\n\n**Output:** `/tmp/pr{N}_review_pack_data.json` with all deterministic fields populated, semantic fields empty.\n\n**Trust level:** Deterministic. All data from git, GitHub API, and factory artifacts. Zero LLM involvement.\n\n#### Pass 2b: Semantic Enrichment (Delegated Agent Team)\n\nSpawn a dedicated agent team (not the main thread) to fill ONLY the semantic fields. The team reads the scaffold JSON + the diff data. It fills:\n\n- **What Changed summaries** \u2014 two-layer (Infrastructure / Product), plus per-zone detail blocks\n- **Key Decisions** \u2014 each with title, rationale, zone associations, and affected file list\n- **Agentic review findings** \u2014 per-file grade (A/B/C/F), zone tag, agent attribution, and finding detail\n- **Post-merge items** \u2014 priority tag, code snippets with file/line references, failure and success scenarios\n- **Factory history** \u2014 iteration timeline, gate findings\n\nThe team does NOT touch deterministic fields (header, badges, architecture, specs, scenarios, CI, convergence). Those are already correct from the scaffold.\n\nEvery claim the semantic team makes is verifiable:\n- Decision-to-zone claims must have at least one file in the diff touching that zone's paths. If not, flag as \"unverified.\"\n- Code snippet line references must exist in the actual diff.\n- File paths must appear in the diff file list.\n\n**Output:** Updated `/tmp/pr{N}_review_pack_data.json` with both deterministic and semantic fields populated.\n\n**Trust level:** LLM-produced but verifiable. Every claim checked against Pass 1 output.\n\n### Pass 3: Rendering (Deterministic, No LLM)\n\nRun the renderer script to inject the verified JSON into the HTML template. The renderer replaces all `<!-- INJECT: ... -->` markers with generated HTML and injects the DATA JSON for JS interactivity.\n\n```bash\npython3 .claude/skills/pr-review-pack/scripts/render_review_pack.py \\\n  --data /tmp/pr{N}_review_pack_data.json \\\n  --output docs/pr{N}_review_pack.html \\\n  --diff-data docs/pr{N}_diff_data.json\n```\n\nThe renderer:\n1. Reads the template (`assets/template.html`) and the ReviewPackData JSON.\n2. Generates HTML for every `<!-- INJECT: ... -->` marker (26 injection points across all sections).\n3. Injects the full JSON into `const DATA = {...}` for JS interactivity (zone filtering, file modal, etc.).\n4. **Embeds diff data inline** in a `<script>` block, making the pack truly self-contained. No companion JSON file needed, no CORS issues when opening via `file://` protocol. Embedded content is automatically escaped to prevent HTML parser conflicts.\n5. **Calculates the SVG viewBox dynamically** from architecture zone positions, preventing zones from being clipped.\n6. Validates that no unreplaced markers remain outside of embedded `<script>` blocks (markers inside diff data are false positives and are excluded).\n\n**Self-contained guarantee:** The `--diff-data` flag embeds the Pass 1 output directly in the HTML. The diff data is raw `git diff`/`git show` output \u2014 deterministic, zero LLM \u2014 byte-equivalent to what GitHub displays for the same commit SHA. Always use `--diff-data` to embed it.\n\n**Output:** `docs/pr{N}_review_pack.html` -- truly self-contained HTML file. Open in any browser, even via `file://`.\n\n**Trust level:** Deterministic. The renderer renders what the data says, nothing more.\n\n## Visual Validation\n\n**This step is mandatory.** Never deliver a review pack without visual validation.\n\nAfter rendering, validate that the pack renders correctly:\n\n1. **Programmatic check (always run):**\n   ```python\n   python3 -c \"\n   import re\n   html = open('docs/pr{N}_review_pack.html').read()\n   outside_scripts = re.sub(r'<script\\b[^>]*>.*?</script>', '', html, flags=re.DOTALL)\n   checks = [\n       ('No unreplaced markers (outside scripts)', '<!-- INJECT:' not in outside_scripts),\n       ('PR title present', 'PR #{N}' in html),\n       ('Scenario cards', html.count('scenario-card') >= 1),\n       ('Agentic review rows', 'adv-row' in html),\n       ('CI rows', 'expandable' in html),\n       ('Decision cards', 'decision-card' in html),\n       ('Convergence grid', 'conv-card' in html),\n       ('Post-merge items', 'pm-item' in html),\n       ('Diff data inline', 'DIFF_DATA_INLINE' in html),\n       ('No external fetch', \\\"fetch('pr_diff_data.json')\\\" not in html),\n       ('Stat labels', 'additions' in html and 'deletions' in html),\n       ('Stat colors', 'stat green' in html and 'stat red' in html),\n       ('Spec file links', html.count('file-path-link') >= 3),\n       ('Comments badge', 'comments' in html.lower() and 'resolved' in html.lower()),\n       ('Script escaping', '<\\\\\\\\/script' in html),\n       ('Zoom controls', 'archZoom' in html),\n   ]\n   for name, ok in checks:\n       print(f'  [{\\\"PASS\\\" if ok else \\\"FAIL\\\"}] {name}')\n   assert all(ok for _, ok in checks), 'Validation failed!'\n   print(f'All {len(checks)} checks passed.')\n   \"\n   ```\n\n2. **Browser visual check (mandatory):**\n\n   The template includes a red **\"This Pack Has NOT Been Visually Inspected\"** banner. It is visible until you remove it. If you skip this step, the human reviewer sees the banner and knows.\n\n   **How to view from CLI (macOS):**\n   ```bash\n   # Open in Chrome\n   osascript -e 'tell application \"Google Chrome\" to tell window 1 to make new tab with properties {URL:\"file:///path/to/docs/pr{N}_review_pack.html\"}'\n\n   # Screenshot and view (Read tool is multimodal \u2014 it can see images)\n   screencapture -x /tmp/review_pack_check.png\n   # Then: Read /tmp/review_pack_check.png\n\n   # Scroll down (repeat to page through)\n   osascript -e 'tell application \"System Events\" to tell process \"Google Chrome\" to keystroke space'\n\n   # Scroll up\n   osascript -e 'tell application \"System Events\" to tell process \"Google Chrome\" to keystroke space using shift down'\n   ```\n\n   **What to verify** (screenshot after each scroll):\n   - All 9 sections render with content (not empty)\n   - Architecture diagram shows zones with correct colors, not clipped, zoom controls present\n   - Theme toggle works (light/dark/system)\n   - Expandable sections toggle on click\n   - File modal opens when clicking file paths (including spec file paths)\n   - Stats show labeled additions (green) and deletions (red)\n   - Factory History tab (if present) switches and shows content\n   - **Bottom of page**: clean footer, NO gibberish or raw JSON\n\n   **After visual review passes:** Remove the banner from the rendered HTML:\n   ```python\n   python3 -c \"\n   html = open('docs/pr{N}_review_pack.html').read()\n   html = html.replace('<div id=\\\"visual-inspection-banner\\\"' + html.split('<div id=\\\"visual-inspection-banner\\\"')[1].split('</div>')[0] + '</div>', '')\n   html = html.replace('<div id=\\\"visual-inspection-spacer\\\" style=\\\"height:48px\\\"></div>', '')\n   open('docs/pr{N}_review_pack.html', 'w').write(html)\n   print('Visual inspection banner removed.')\n   \"\n   ```\n\n## Zone Registry Setup\n\nEvery project needs a zone registry -- a YAML file mapping file path patterns to named architecture zones. This is the linchpin of deterministic correctness.\n\nLook for the registry at these locations (in order):\n1. `.claude/zone-registry.yaml` in the project repo\n2. `docs/zone-registry.yaml` in the project repo\n3. `CLAUDE.md` inline zone definitions (look for a zones section)\n\nIf no registry exists, create one. Format:\n\n```yaml\nzones:\n  zone-name:\n    paths: [\"src/module/**\", \"tests/test_module*\"]\n    specs: [\"docs/module_spec.md\"]\n    category: product  # product | factory | infra\n    label: \"Module Name\"\n    sublabel: \"brief description\"\n  another-zone:\n    paths: [\".github/workflows/**\"]\n    specs: [\"docs/ci.md\"]\n    category: infra\n    label: \"CI/CD\"\n    sublabel: \"workflows, actions\"\n```\n\nThe registry enables:\n- **File to Zone:** pure path matching (deterministic, no LLM)\n- **Zone to Diagram position:** static lookup from registry category and order\n- **Decision to Zone:** LLM-produced but verifiable -- must have at least one file in the diff touching that zone's paths\n- **CI Job to Zone:** static mapping (which gates cover which zones)\n\n## Quick Start\n\nMinimal steps to generate a review pack for PR #N:\n\n1. **Verify readiness.** Run `gh pr checks <N>` and check comments. All green? Proceed.\n\n2. **Run Pass 1.** From the project repo root:\n   ```bash\n   python3 .claude/skills/pr-review-pack/scripts/generate_diff_data.py \\\n     --base main --head HEAD --output docs/pr{N}_diff_data.json\n   ```\n\n3. **Load zone registry.** Read the project's zone registry file. If it does not exist, create one based on the diff file list and project structure.\n\n4. **Run Pass 2.** Spawn the semantic analysis team. Provide them:\n   - The diff data JSON from Pass 1\n   - The zone registry\n   - The file-to-zone mapping\n   - PR metadata from `gh pr view <N> --json title,number,headRefName,baseRefName,url,commits`\n   - CI check data from `gh pr checks <N>`\n\n   The team produces the `ReviewPackData` JSON. Save to `/tmp/pr{N}_review_pack_data.json`.\n\n5. **Verify Pass 2 output.** For each decision-to-zone claim, confirm at least one file in the diff touches that zone. Flag unverified claims. Confirm code snippet line references exist in the diff.\n\n6. **Run Pass 3.** Render the HTML with embedded diff data:\n   ```bash\n   python3 .claude/skills/pr-review-pack/scripts/render_review_pack.py \\\n     --data /tmp/pr{N}_review_pack_data.json \\\n     --output docs/pr{N}_review_pack.html \\\n     --diff-data docs/pr{N}_diff_data.json\n   ```\n\n7. **Validate.** Run the programmatic validation check. Open in browser if possible.\n\n8. **Deliver.** The HTML file is the review pack. It is fully self-contained \u2014 diff data is embedded inline, no companion files needed.\n\n## Architecture Diagram: Source of Truth (Open Design)\n\nThe architecture diagram in the review pack must have **continuity across PRs**. The \"updated\" diagram after PR N must become the \"baseline\" diagram before PR N+1. This is not about pixel-perfect positioning \u2014 it's about comparing consistent design changes over time.\n\n**Current state:** The zone registry (`.claude/zone-registry.yaml`) defines zones (paths, labels, categories) but NOT diagram layout. The architecture diagram layout (SVG positions, zone relationships) is currently generated ad-hoc by the Pass 2 agent, which means it has no continuity between review packs.\n\n**Rules for the Pass 2 agent:**\n- **Never invent architecture diagram layout from scratch.** Read the zone registry for zone definitions, but get positions from the project's architecture source of truth.\n- If the project has a canonical architecture layout (zone-registry.yaml with `position` fields, or a separate architecture data file), use it.\n- If no layout exists yet, compute positions deterministically (by category row + sequential x placement) and persist them back to the registry so the next review pack inherits the layout.\n- The zone-registry.yaml `position` field is the interim solution. A richer architecture model (multi-granularity, relationships, zoom levels) is a future design need.\n\n**Future direction:** The architecture should evolve into a living project artifact (possibly in `docs/`) that the factory orchestrator maintains and the review pack consumes. The review pack should never be the generator of architecture \u2014 only the renderer.\n\n## File Link Integrity Rule\n\nEvery `file-path-link` element in the review pack must resolve to a useful view when clicked. The template's `openFileModal()` handles two cases:\n\n1. **File is in the diff data:** Shows the diff (side-by-side, unified, or raw). This is the normal case for changed files.\n2. **File is NOT in the diff data:** Shows \"This file was not modified in this PR\" with a prominent \"View on GitHub\" link. This is the correct behavior for spec files, scenario files, and other reference files.\n\n**Never make a file path clickable without verifying the click target resolves gracefully.** The template handles both cases, but if you add new file link patterns outside `openFileModal()`, you must handle the \"not in diff\" case yourself.\n\n## Verification Rule\n\nIf a decision claims to affect zone X but no files in zone X's paths appear in the diff, that claim is flagged as \"unverified\" in the review pack. Unverified claims are rendered with a visual indicator -- never silently included.\n\n## Ground Truth Hierarchy\n\n1. Code diffs (Pass 1 output) -- primary source of truth\n2. Main thread context -- secondary, used only when diff is ambiguous\n3. If there is a conflict between diff and context, the diff wins\n\n## Reference Files\n\nDetailed specifications for each component of the review pack:\n\n| Reference | What It Covers |\n|-----------|---------------|\n| `references/build-spec.md` | **Authoritative build specification** \u2014 full data schema, zone registry spec, section-by-section guide, pipeline delegation, CSS design system, validation checklist. The comprehensive \"what and why.\" |\n| `references/data-schema.md` | Quick-access: TypeScript-style data schema for ReviewPackData |\n| `references/section-guide.md` | Quick-access: section-by-section build reference (all 9 sections + Factory History) |\n| `references/css-design-system.md` | Quick-access: CSS tokens, dark mode, component patterns, layout |\n| `references/validation-checklist.md` | Quick-access: pre-delivery validation checks |\n| `scripts/generate_diff_data.py` | Git diff extraction script (Pass 1) |\n| `scripts/render_review_pack.py` | HTML renderer script (Pass 3) \u2014 injects data into template |\n| `assets/template.html` | HTML template skeleton with `<!-- INJECT: -->` markers and JS interactivity |\n",
      "base": "---\nname: pr-review-pack\ndescription: This skill should be used when the user asks to \"generate a review pack\", \"create a PR review pack\", \"build a review pack for this PR\", \"make a review report\", or when a PR is ready for review and needs a review pack artifact. Generates a self-contained interactive HTML review pack following the three-pass pipeline.\nuser-invocable: true\nargument-hint: \"[PR-url-or-number]\"\n---\n\n# PR Review Pack Generator\n\nGenerate a self-contained interactive HTML review pack for a pull request. Joey reviews the report, not the code. The review pack is the artifact that tells him whether to merge, what the risks are, and what to watch post-merge.\n\n## Naming Convention\n\nEvery review pack produces multiple artifacts. All artifacts for a single PR share the same prefix so they are associated and differentiated from other review packs.\n\n**Prefix:** `pr{N}_` where N is the PR number.\n\n| Artifact | Filename | Location |\n|----------|----------|----------|\n| Review pack HTML | `pr{N}_review_pack.html` | `docs/` |\n| Diff data JSON | `pr{N}_diff_data.json` | `docs/` |\n| ReviewPackData JSON | `pr{N}_review_pack_data.json` | `/tmp/` (intermediate, not committed) |\n\nExample for PR #6: `docs/pr6_review_pack.html`, `docs/pr6_diff_data.json`.\n\n## Prerequisites\n\nBefore generating a review pack, verify all PR readiness criteria are met. **All three gates must be green. If any gate fails, stop and fix it before proceeding.** Never present a review pack with a failed prerequisite.\n\n**CRITICAL: Prerequisites must be checked in order. Gate 2 (comments) CANNOT be checked until Gate 1 (CI) is fully complete.** Bot reviewers (Copilot, Codex connector) post their comments AFTER CI finishes. Checking comments before CI completes will produce a stale \"0 comments\" result that becomes false minutes later. This has happened before \u2014 don't repeat it.\n\n### Gate 1: CI checks GREEN on HEAD\n\n```bash\ngh pr checks <N>\n```\n\nWait until ALL checks complete (not just start). CI typically takes 4-6 minutes. If a bot pushed the HEAD commit (GITHUB_TOKEN), CI may not have re-triggered \u2014 push a human-authored commit to fix.\n\n### Gate 2: All review comments resolved\n\n**Run this AFTER Gate 1 is fully green.** Bot reviewers post comments after CI completes.\n\n```bash\n# Get unresolved thread count via GraphQL\ngh api graphql -f query='\n{\n  repository(owner: \"{owner}\", name: \"{repo}\") {\n    pullRequest(number: {N}) {\n      reviewThreads(first: 100) {\n        nodes { isResolved }\n      }\n    }\n  }\n}' --jq '{\n  total: (.data.repository.pullRequest.reviewThreads.nodes | length),\n  unresolved: ([.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false)] | length)\n}'\n```\n\nIf `unresolved > 0`: resolve or address every comment before proceeding. Both human and AI reviewer comments (Copilot, Codex bot) count.\n\n**Pass the comment counts to Pass 2** so they appear in the header status badges.\n\n### Gate 3: The review pack itself\n\nThis is what this skill produces. It is always the last gate.\n\nIf any gate is unmet, state what is blocking and resolve it before proceeding.\n\n## Three-Pass Pipeline\n\nThe review pack is produced by a deterministic pipeline -- not written from the main agent's context. Three passes, each with a clear trust boundary.\n\n### Pass 1: Diff Analysis (Deterministic, No LLM)\n\nExtract the raw diff and map every changed file to its architecture zone(s).\n\n1. Run the diff data extraction script from the project repo root:\n   ```\n   python3 .claude/skills/pr-review-pack/scripts/generate_diff_data.py \\\n     --base main --head HEAD --output docs/pr{N}_diff_data.json\n   ```\n   This produces per-file diffs, raw content, additions/deletions, and file status.\n\n2. Load the project's zone registry (see \"Zone Registry Setup\" below). Match each file path against zone path patterns to produce the `{file -> zone[]}` mapping. This is pure glob/regex matching -- zero LLM involvement.\n\n3. Aggregate stats: total files, additions, deletions, files per zone, zone file counts.\n\n**Output:** `docs/pr{N}_diff_data.json` with file list, zone mappings, and aggregate stats.\n\n**Trust level:** Deterministic. Zero hallucination risk. Code diffs are ground truth.\n\n### Pass 2: Semantic Analysis (Delegated Agent Team)\n\nSpawn a dedicated agent team (not the main thread) to analyze the diff. The team reads the diff output from Pass 1 and the zone registry. It produces:\n\n- **What Changed summaries** -- two-layer (Infrastructure / Product), plus per-zone detail blocks\n- **Key Decisions** -- each with title, rationale, zone associations, and affected file list\n- **Adversarial findings** -- per-file grade (A/B/C/F), zone tag, and finding detail\n- **Post-merge items** -- priority tag, code snippets with file/line references, failure and success scenarios\n- **Convergence result** -- gate-by-gate status, satisfaction score\n- **CI performance data** -- from `gh pr checks` output with timing\n- **Header status badges** -- the following badges are **mandatory** (the template enforces visual affordances):\n  - `CI X/Y` \u2014 type `pass` if all green, `fail` otherwise\n  - `X/Y Scenarios` \u2014 type `pass` if all pass, `warn` or `fail` otherwise\n  - `X/Y comments resolved` \u2014 type `pass` if all resolved (or 0 total), `warn` if unresolved exist. Comment counts come from the prerequisite Gate 2 check \u2014 the orchestrating agent must pass these to the Pass 2 team.\n\nEvery claim the semantic team makes is verifiable:\n- Decision-to-zone claims must have at least one file in the diff touching that zone's paths. If not, flag as \"unverified.\"\n- Code snippet line references must exist in the actual diff.\n- File paths must appear in the diff file list.\n\n**Output:** Structured JSON matching the `ReviewPackData` schema (see `references/data-schema.md`). Save to `/tmp/pr{N}_review_pack_data.json`.\n\n**Trust level:** LLM-produced but verifiable. Every claim checked against Pass 1 output.\n\n### Pass 3: Rendering (Deterministic, No LLM)\n\nRun the renderer script to inject the verified JSON into the HTML template. The renderer replaces all `<!-- INJECT: ... -->` markers with generated HTML and injects the DATA JSON for JS interactivity.\n\n```bash\npython3 .claude/skills/pr-review-pack/scripts/render_review_pack.py \\\n  --data /tmp/pr{N}_review_pack_data.json \\\n  --output docs/pr{N}_review_pack.html \\\n  --diff-data docs/pr{N}_diff_data.json\n```\n\nThe renderer:\n1. Reads the template (`assets/template.html`) and the ReviewPackData JSON.\n2. Generates HTML for every `<!-- INJECT: ... -->` marker (26 injection points across all sections).\n3. Injects the full JSON into `const DATA = {...}` for JS interactivity (zone filtering, file modal, etc.).\n4. **Embeds diff data inline** in a `<script>` block, making the pack truly self-contained. No companion JSON file needed, no CORS issues when opening via `file://` protocol.\n5. Validates that no unreplaced markers remain (warns on stderr if any do).\n\n**Self-contained guarantee:** The `--diff-data` flag embeds the Pass 1 output directly in the HTML. The diff data is raw `git diff`/`git show` output \u2014 deterministic, zero LLM \u2014 byte-equivalent to what GitHub displays for the same commit SHA. Always use `--diff-data` to embed it.\n\n**Output:** `docs/pr{N}_review_pack.html` -- truly self-contained HTML file. Open in any browser, even via `file://`.\n\n**Trust level:** Deterministic. The renderer renders what the data says, nothing more.\n\n## Visual Validation\n\n**This step is mandatory.** Never deliver a review pack without visual validation.\n\nAfter rendering, validate that the pack renders correctly:\n\n1. **Programmatic check (always run):**\n   ```python\n   python3 -c \"\n   html = open('docs/pr{N}_review_pack.html').read()\n   checks = [\n       ('No unreplaced markers', '<!-- INJECT:' not in html),\n       ('DATA injected', 'const DATA = {};' not in html),\n       ('PR title present', 'PR #{N}' in html),\n       ('Scenario cards', html.count('scenario-card') >= 1),\n       ('Adversarial rows', 'adv-row' in html),\n       ('CI rows', 'expandable' in html),\n       ('Decision cards', 'decision-card' in html),\n       ('Convergence grid', 'conv-card' in html),\n       ('Post-merge items', 'pm-item' in html),\n       ('Diff data inline', 'DIFF_DATA_INLINE' in html),\n       ('No external fetch', \\\"fetch('pr_diff_data.json')\\\" not in html),\n       ('Stat labels', 'additions' in html and 'deletions' in html),\n       ('Stat colors', 'stat green' in html and 'stat red' in html),\n       ('Spec file links', html.count('file-path-link') >= 3),\n       ('Comments badge', 'comments' in html.lower() and 'resolved' in html.lower()),\n   ]\n   for name, ok in checks:\n       print(f'  [{\\\"PASS\\\" if ok else \\\"FAIL\\\"}] {name}')\n   assert all(ok for _, ok in checks), 'Validation failed!'\n   print(f'All {len(checks)} checks passed.')\n   \"\n   ```\n\n2. **Browser check (when possible):** Open the HTML file and verify:\n   - All 9 sections render with content (not empty)\n   - Architecture diagram shows zones with correct colors\n   - Theme toggle works (light/dark/system)\n   - Expandable sections toggle on click\n   - File modal opens when clicking file paths (including spec file paths)\n   - Stats show labeled additions (green) and deletions (red)\n   - Factory History tab (if present) switches and shows content\n\n3. **If browser viewing is unavailable** (e.g., headless environment, agent cannot see browser output): The programmatic check is the minimum bar. State clearly in the delivery message: \"Programmatic validation passed. Browser visual validation was not performed due to [reason]. Please verify rendering before sharing.\"\n\n## Zone Registry Setup\n\nEvery project needs a zone registry -- a YAML file mapping file path patterns to named architecture zones. This is the linchpin of deterministic correctness.\n\nLook for the registry at these locations (in order):\n1. `.claude/zone-registry.yaml` in the project repo\n2. `docs/zone-registry.yaml` in the project repo\n3. `CLAUDE.md` inline zone definitions (look for a zones section)\n\nIf no registry exists, create one. Format:\n\n```yaml\nzones:\n  zone-name:\n    paths: [\"src/module/**\", \"tests/test_module*\"]\n    specs: [\"docs/module_spec.md\"]\n    category: product  # product | factory | infra\n    label: \"Module Name\"\n    sublabel: \"brief description\"\n  another-zone:\n    paths: [\".github/workflows/**\"]\n    specs: [\"docs/ci.md\"]\n    category: infra\n    label: \"CI/CD\"\n    sublabel: \"workflows, actions\"\n```\n\nThe registry enables:\n- **File to Zone:** pure path matching (deterministic, no LLM)\n- **Zone to Diagram position:** static lookup from registry category and order\n- **Decision to Zone:** LLM-produced but verifiable -- must have at least one file in the diff touching that zone's paths\n- **CI Job to Zone:** static mapping (which gates cover which zones)\n\n## Quick Start\n\nMinimal steps to generate a review pack for PR #N:\n\n1. **Verify readiness.** Run `gh pr checks <N>` and check comments. All green? Proceed.\n\n2. **Run Pass 1.** From the project repo root:\n   ```bash\n   python3 .claude/skills/pr-review-pack/scripts/generate_diff_data.py \\\n     --base main --head HEAD --output docs/pr{N}_diff_data.json\n   ```\n\n3. **Load zone registry.** Read the project's zone registry file. If it does not exist, create one based on the diff file list and project structure.\n\n4. **Run Pass 2.** Spawn the semantic analysis team. Provide them:\n   - The diff data JSON from Pass 1\n   - The zone registry\n   - The file-to-zone mapping\n   - PR metadata from `gh pr view <N> --json title,number,headRefName,baseRefName,url,commits`\n   - CI check data from `gh pr checks <N>`\n\n   The team produces the `ReviewPackData` JSON. Save to `/tmp/pr{N}_review_pack_data.json`.\n\n5. **Verify Pass 2 output.** For each decision-to-zone claim, confirm at least one file in the diff touches that zone. Flag unverified claims. Confirm code snippet line references exist in the diff.\n\n6. **Run Pass 3.** Render the HTML with embedded diff data:\n   ```bash\n   python3 .claude/skills/pr-review-pack/scripts/render_review_pack.py \\\n     --data /tmp/pr{N}_review_pack_data.json \\\n     --output docs/pr{N}_review_pack.html \\\n     --diff-data docs/pr{N}_diff_data.json\n   ```\n\n7. **Validate.** Run the programmatic validation check. Open in browser if possible.\n\n8. **Deliver.** The HTML file is the review pack. It is fully self-contained \u2014 diff data is embedded inline, no companion files needed.\n\n## Architecture Diagram: Source of Truth (Open Design)\n\nThe architecture diagram in the review pack must have **continuity across PRs**. The \"updated\" diagram after PR N must become the \"baseline\" diagram before PR N+1. This is not about pixel-perfect positioning \u2014 it's about comparing consistent design changes over time.\n\n**Current state:** The zone registry (`.claude/zone-registry.yaml`) defines zones (paths, labels, categories) but NOT diagram layout. The architecture diagram layout (SVG positions, zone relationships) is currently generated ad-hoc by the Pass 2 agent, which means it has no continuity between review packs.\n\n**Rules for the Pass 2 agent:**\n- **Never invent architecture diagram layout from scratch.** Read the zone registry for zone definitions, but get positions from the project's architecture source of truth.\n- If the project has a canonical architecture layout (zone-registry.yaml with `position` fields, or a separate architecture data file), use it.\n- If no layout exists yet, compute positions deterministically (by category row + sequential x placement) and persist them back to the registry so the next review pack inherits the layout.\n- The zone-registry.yaml `position` field is the interim solution. A richer architecture model (multi-granularity, relationships, zoom levels) is a future design need.\n\n**Future direction:** The architecture should evolve into a living project artifact (possibly in `docs/`) that the factory orchestrator maintains and the review pack consumes. The review pack should never be the generator of architecture \u2014 only the renderer.\n\n## File Link Integrity Rule\n\nEvery `file-path-link` element in the review pack must resolve to a useful view when clicked. The template's `openFileModal()` handles two cases:\n\n1. **File is in the diff data:** Shows the diff (side-by-side, unified, or raw). This is the normal case for changed files.\n2. **File is NOT in the diff data:** Shows \"This file was not modified in this PR\" with a prominent \"View on GitHub\" link. This is the correct behavior for spec files, scenario files, and other reference files.\n\n**Never make a file path clickable without verifying the click target resolves gracefully.** The template handles both cases, but if you add new file link patterns outside `openFileModal()`, you must handle the \"not in diff\" case yourself.\n\n## Verification Rule\n\nIf a decision claims to affect zone X but no files in zone X's paths appear in the diff, that claim is flagged as \"unverified\" in the review pack. Unverified claims are rendered with a visual indicator -- never silently included.\n\n## Ground Truth Hierarchy\n\n1. Code diffs (Pass 1 output) -- primary source of truth\n2. Main thread context -- secondary, used only when diff is ambiguous\n3. If there is a conflict between diff and context, the diff wins\n\n## Reference Files\n\nDetailed specifications for each component of the review pack:\n\n| Reference | What It Covers |\n|-----------|---------------|\n| `references/build-spec.md` | **Authoritative build specification** \u2014 full data schema, zone registry spec, section-by-section guide, pipeline delegation, CSS design system, validation checklist. The comprehensive \"what and why.\" |\n| `references/data-schema.md` | Quick-access: TypeScript-style data schema for ReviewPackData |\n| `references/section-guide.md` | Quick-access: section-by-section build reference (all 9 sections + Factory History) |\n| `references/css-design-system.md` | Quick-access: CSS tokens, dark mode, component patterns, layout |\n| `references/validation-checklist.md` | Quick-access: pre-delivery validation checks |\n| `scripts/generate_diff_data.py` | Git diff extraction script (Pass 1) |\n| `scripts/render_review_pack.py` | HTML renderer script (Pass 3) \u2014 injects data into template |\n| `assets/template.html` | HTML template skeleton with `<!-- INJECT: -->` markers and JS interactivity |\n"
    },
    ".claude/skills/pr-review-pack/assets/template.html": {
      "additions": 79,
      "deletions": 7,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/.claude/skills/pr-review-pack/assets/template.html b/.claude/skills/pr-review-pack/assets/template.html\nindex 6deea9c..1eabea0 100644\n--- a/.claude/skills/pr-review-pack/assets/template.html\n+++ b/.claude/skills/pr-review-pack/assets/template.html\n@@ -44,6 +44,10 @@\n   [data-theme=\"dark\"] .history-event { background: #1f2937; border-color: #374151; }\n   [data-theme=\"dark\"] tr.detail-row td,\n   [data-theme=\"dark\"] .adv-detail-row td { background: #1a2332; }\n+  [data-theme=\"dark\"] .agent-grade-badge { background: #2a3441; }\n+  [data-theme=\"dark\"] .agent-legend-item .agent-abbrev { background: #2a3441; }\n+  [data-theme=\"dark\"] .agent-detail-header .agent-abbrev { background: #2a3441; }\n+  [data-theme=\"dark\"] .agent-detail-entry { border-bottom-color: #2a3441; }\n   [data-theme=\"dark\"] .arch-legend { background: #1f2937; }\n   [data-theme=\"dark\"] .conv-card { border-color: #374151; }\n   [data-theme=\"dark\"] .decision-card { border-color: #374151; }\n@@ -63,6 +67,9 @@\n   [data-theme=\"dark\"] .grade.c { background: #7c2d12; color: #fdba74; }\n   [data-theme=\"dark\"] .grade.f { background: #7f1d1d; color: #fca5a5; }\n   [data-theme=\"dark\"] .grade.na { background: #374151; color: #9ca3af; }\n+  [data-theme=\"dark\"] .review-method-badge.agent-teams { background: #1e3a5f; color: #93c5fd; }\n+  [data-theme=\"dark\"] .review-method-badge.main-agent { background: #374151; color: #9ca3af; }\n+  [data-theme=\"dark\"] .agent-tag { background: #374151; color: #9ca3af; }\n   [data-theme=\"dark\"] .priority.low { background: #1e3a5f; color: #93c5fd; }\n   [data-theme=\"dark\"] .priority.medium { background: #713f12; color: #fde047; }\n   [data-theme=\"dark\"] .priority.cosmetic { background: #374151; color: #9ca3af; }\n@@ -205,6 +212,14 @@\n   .grade.f { background: var(--red-bg); color: #991b1b; }\n   .grade.na { background: var(--gray-bg); color: var(--gray); }\n \n+  /* \u2500\u2500 Review method badge \u2500\u2500 */\n+  .review-method-badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; vertical-align: middle; margin-left: 8px; }\n+  .review-method-badge.agent-teams { background: var(--blue-bg, #dbeafe); color: #1d4ed8; }\n+  .review-method-badge.main-agent { background: var(--gray-bg); color: var(--gray); }\n+\n+  /* \u2500\u2500 Agent badges in agentic review table \u2500\u2500 */\n+  .agent-tag { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 11px; font-weight: 500; background: var(--gray-bg); color: var(--gray); }\n+\n   /* \u2500\u2500 Timing \u2500\u2500 */\n   .time-label { font-family: var(--mono); font-size: 15px; font-weight: 700; }\n   .time-label.normal { color: #166534; }\n@@ -331,7 +346,7 @@\n   .wc-zone-detail.active { display: block; }\n   .wc-zone-detail h4 { font-size: 13px; font-weight: 700; margin-bottom: 6px; }\n \n-  /* \u2500\u2500 Adversarial review enhancements \u2500\u2500 */\n+  /* \u2500\u2500 Agentic review \u2500\u2500 */\n   .adv-scroll { max-height: 500px; overflow-y: auto; }\n   .adv-row { cursor: pointer; transition: max-height 0.3s ease, opacity 0.3s ease; }\n   .adv-row:hover { background: var(--gray-bg); }\n@@ -342,6 +357,26 @@\n   .adv-detail-row.open { display: table-row; }\n   .adv-detail-row td { background: #fafbfc; padding: 12px 20px; font-size: 12px; border-bottom: 1px solid var(--border); }\n \n+  /* Agent grade badges (compact per-file) */\n+  .agent-badges-cell { white-space: nowrap; }\n+  .agent-grade-badge { display: inline-flex; align-items: center; gap: 2px; margin-right: 6px; padding: 1px 4px; border-radius: 4px; background: var(--gray-bg); font-size: 11px; }\n+  .agent-grade-badge .agent-abbrev { font-weight: 700; color: var(--text-muted); font-size: 10px; font-family: var(--mono); }\n+  .agent-grade-badge .grade { font-size: 11px; padding: 0 2px; }\n+\n+  /* Agent legend */\n+  .agent-legend { display: inline-flex; gap: 12px; margin-left: 12px; font-size: 11px; color: var(--text-muted); vertical-align: middle; }\n+  .agent-legend-item { display: inline-flex; align-items: center; gap: 3px; cursor: help; }\n+  .agent-legend-item .agent-abbrev { font-weight: 700; font-family: var(--mono); font-size: 10px; background: var(--gray-bg); padding: 1px 3px; border-radius: 3px; }\n+\n+  /* Per-agent detail breakdown (inside expanded row) */\n+  .agent-detail-entry { padding: 8px 0; border-bottom: 1px solid var(--border); }\n+  .agent-detail-entry:last-child { border-bottom: none; }\n+  .agent-detail-header { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }\n+  .agent-detail-header .agent-abbrev { font-weight: 700; font-family: var(--mono); font-size: 10px; background: var(--gray-bg); padding: 1px 4px; border-radius: 3px; }\n+  .agent-detail-header .grade { font-size: 11px; }\n+  .agent-detail-name { font-size: 11px; color: var(--text-muted); }\n+  .agent-detail-body { font-size: 12px; line-height: 1.5; padding-left: 4px; }\n+\n   /* \u2500\u2500 CI sub-check drill-down \u2500\u2500 */\n   .ci-check-item { padding: 6px 0; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }\n   .ci-check-item:last-child { border-bottom: none; }\n@@ -438,6 +473,11 @@\n </style>\n </head>\n <body>\n+<!-- Visual inspection watermark: visible until removed by the reviewing agent -->\n+<div id=\"visual-inspection-banner\" style=\"position:fixed;top:0;left:0;right:0;z-index:10000;background:#dc2626;color:white;text-align:center;padding:12px 20px;font-weight:700;font-size:15px;font-family:-apple-system,BlinkMacSystemFont,sans-serif;box-shadow:0 2px 8px rgba(0,0,0,0.3);letter-spacing:0.3px\">\n+  This Pack Has NOT Been Visually Inspected\n+</div>\n+<div id=\"visual-inspection-spacer\" style=\"height:48px\"></div>\n <div class=\"container\">\n \n   <!-- \u2550\u2550 DATA INJECTION POINT \u2550\u2550 -->\n@@ -484,6 +524,11 @@\n         <div class=\"arch-controls\">\n           <button class=\"arch-toggle active\" onclick=\"setArchView('update',this)\">Update (this PR)</button>\n           <button class=\"arch-toggle\" onclick=\"setArchView('baseline',this)\">Baseline (before merge)</button>\n+          <span style=\"margin-left:auto;display:inline-flex;gap:4px;align-items:center\">\n+            <button class=\"arch-toggle\" onclick=\"archZoom(-1)\" title=\"Zoom out\">&minus;</button>\n+            <button class=\"arch-toggle\" onclick=\"archZoom(0)\" title=\"Fit to content\">Fit</button>\n+            <button class=\"arch-toggle\" onclick=\"archZoom(1)\" title=\"Zoom in\">+</button>\n+          </span>\n           <span class=\"arch-hint\">Click a zone to filter findings &bull; Click background to reset</span>\n         </div>\n         <svg id=\"arch-diagram\" viewBox=\"0 0 780 360\" style=\"width:100%;max-width:780px;background:#fafbfc;border-radius:8px;border:1px solid var(--border)\">\n@@ -544,20 +589,20 @@\n       </div>\n     </div>\n \n-    <!-- Section: Adversarial Review -->\n+    <!-- Section: Agentic Review -->\n     <div class=\"section\">\n       <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n-        <h2 id=\"adv-header\">Adversarial Review</h2>\n+        <h2 id=\"adv-header\">Agentic Review <!-- INJECT: adversarial review method badge --></h2>\n         <span class=\"chevron\">&#x25BC;</span>\n       </div>\n       <div class=\"section-body\">\n         <div class=\"adv-scroll\">\n-        <div id=\"adv-no-match\" class=\"adv-no-match\">No adversarial findings in this zone.</div>\n+        <div id=\"adv-no-match\" class=\"adv-no-match\">No review findings in this zone.</div>\n         <table id=\"adv-table\">\n-          <thead><tr><th>File</th><th>Grade</th><th>Zone</th><th>Notable</th></tr></thead>\n+          <thead><tr><th>File</th><th>Agents</th><th>Zone</th><th>Notable</th></tr></thead>\n           <tbody>\n-            <!-- INJECT: adversarial finding rows from DATA.adversarialReview.findings -->\n-            <!-- Each row: tr.adv-row[data-zones=\"...\"][data-grade-sort=\"N\"] + tr.adv-detail-row -->\n+            <!-- INJECT: adversarial finding rows from DATA.agenticReview.findings -->\n+            <!-- Each row: tr.adv-row (file-level, grouped) + tr.adv-detail-row (per-agent breakdown) -->\n           </tbody>\n         </table>\n         </div>\n@@ -902,6 +947,33 @@ function setArchView(view, btn) {\n   }\n }\n \n+// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n+// Architecture zoom\n+// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n+let archZoomLevel = 1;\n+const archOriginalViewBox = (function() {\n+  const svg = document.getElementById('arch-diagram');\n+  return svg ? svg.getAttribute('viewBox') : '0 0 780 400';\n+})();\n+\n+function archZoom(direction) {\n+  const svg = document.getElementById('arch-diagram');\n+  if (!svg) return;\n+  const parts = archOriginalViewBox.split(/\\s+/).map(Number);\n+  if (direction === 0) {\n+    archZoomLevel = 1;\n+  } else {\n+    archZoomLevel = Math.max(0.5, Math.min(2.5, archZoomLevel + direction * 0.25));\n+  }\n+  const cx = parts[0] + parts[2] / 2;\n+  const cy = parts[1] + parts[3] / 2;\n+  const newW = parts[2] / archZoomLevel;\n+  const newH = parts[3] / archZoomLevel;\n+  svg.setAttribute('viewBox',\n+    (cx - newW/2).toFixed(0) + ' ' + (cy - newH/2).toFixed(0) + ' ' +\n+    newW.toFixed(0) + ' ' + newH.toFixed(0));\n+}\n+\n // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n // Sticky floating architecture diagram\n // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
      "raw": "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<title><!-- INJECT: header.title --></title>\n<style>\n  :root {\n    --green: #22c55e; --green-bg: #f0fdf4; --green-border: #86efac;\n    --yellow: #eab308; --yellow-bg: #fefce8;\n    --orange: #f97316; --orange-bg: #fff7ed;\n    --red: #ef4444; --red-bg: #fef2f2;\n    --gray: #6b7280; --gray-bg: #f9fafb; --gray-border: #e5e7eb;\n    --blue: #3b82f6; --blue-bg: #eff6ff;\n    --purple: #8b5cf6; --purple-bg: #f5f3ff;\n    --text: #1f2937; --text-secondary: #6b7280; --text-muted: #9ca3af;\n    --border: #e5e7eb; --bg: #f3f4f6;\n    --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;\n  }\n  /* \u2500\u2500 Dark theme overrides \u2500\u2500 */\n  [data-theme=\"dark\"] {\n    --text: #e5e7eb; --text-secondary: #9ca3af; --text-muted: #6b7280;\n    --border: #374151; --bg: #111827;\n    --gray-bg: #1f2937; --gray-border: #374151; --gray: #9ca3af;\n    --green-bg: #064e3b; --green-border: #10b981;\n    --yellow-bg: #713f12; --red-bg: #7f1d1d; --orange-bg: #7c2d12;\n    --blue-bg: #1e3a5f; --purple-bg: #2e1065;\n  }\n  [data-theme=\"dark\"] .header,\n  [data-theme=\"dark\"] .section,\n  [data-theme=\"dark\"] .gate,\n  [data-theme=\"dark\"] .tab-panel,\n  [data-theme=\"dark\"] .tab-bar { background: #1f2937; }\n  [data-theme=\"dark\"] .tab-btn { color: #9ca3af; }\n  [data-theme=\"dark\"] .tab-btn:hover { background: #374151; }\n  [data-theme=\"dark\"] .tab-btn.active { color: #60a5fa; background: #1f2937; }\n  [data-theme=\"dark\"] th { background: #1f2937; color: #9ca3af; }\n  [data-theme=\"dark\"] tr:nth-child(even) td { background: rgba(255,255,255,0.02); }\n  [data-theme=\"dark\"] tr.expandable:hover,\n  [data-theme=\"dark\"] .section-header:hover,\n  [data-theme=\"dark\"] .decision-header:hover,\n  [data-theme=\"dark\"] .pm-header:hover,\n  [data-theme=\"dark\"] .scenario-card:hover { background: #374151; }\n  [data-theme=\"dark\"] .history-event { background: #1f2937; border-color: #374151; }\n  [data-theme=\"dark\"] tr.detail-row td,\n  [data-theme=\"dark\"] .adv-detail-row td { background: #1a2332; }\n  [data-theme=\"dark\"] .agent-grade-badge { background: #2a3441; }\n  [data-theme=\"dark\"] .agent-legend-item .agent-abbrev { background: #2a3441; }\n  [data-theme=\"dark\"] .agent-detail-header .agent-abbrev { background: #2a3441; }\n  [data-theme=\"dark\"] .agent-detail-entry { border-bottom-color: #2a3441; }\n  [data-theme=\"dark\"] .arch-legend { background: #1f2937; }\n  [data-theme=\"dark\"] .conv-card { border-color: #374151; }\n  [data-theme=\"dark\"] .decision-card { border-color: #374151; }\n  [data-theme=\"dark\"] .pm-item { border-color: #374151; }\n  [data-theme=\"dark\"] .scenario-card { border-color: #374151; }\n  [data-theme=\"dark\"] .arch-floating { background: rgba(31,41,55,0.95); }\n  [data-theme=\"dark\"] .code-block { background: #0f172a; }\n  [data-theme=\"dark\"] .gate-popover { background: #1f2937; border-color: #374151; }\n  [data-theme=\"dark\"] .badge.pass { background: #064e3b; color: #34d399; }\n  [data-theme=\"dark\"] .badge.fail { background: #7f1d1d; color: #fca5a5; }\n  [data-theme=\"dark\"] .health-tag.normal { background: #064e3b; color: #34d399; }\n  [data-theme=\"dark\"] .health-tag.acceptable { background: #713f12; color: #fde047; }\n  [data-theme=\"dark\"] .health-tag.watch { background: #7c2d12; color: #fdba74; }\n  [data-theme=\"dark\"] .health-tag.refactor { background: #7f1d1d; color: #fca5a5; }\n  [data-theme=\"dark\"] .grade.a { background: #064e3b; color: #34d399; }\n  [data-theme=\"dark\"] .grade.b { background: #713f12; color: #fde047; }\n  [data-theme=\"dark\"] .grade.c { background: #7c2d12; color: #fdba74; }\n  [data-theme=\"dark\"] .grade.f { background: #7f1d1d; color: #fca5a5; }\n  [data-theme=\"dark\"] .grade.na { background: #374151; color: #9ca3af; }\n  [data-theme=\"dark\"] .review-method-badge.agent-teams { background: #1e3a5f; color: #93c5fd; }\n  [data-theme=\"dark\"] .review-method-badge.main-agent { background: #374151; color: #9ca3af; }\n  [data-theme=\"dark\"] .agent-tag { background: #374151; color: #9ca3af; }\n  [data-theme=\"dark\"] .priority.low { background: #1e3a5f; color: #93c5fd; }\n  [data-theme=\"dark\"] .priority.medium { background: #713f12; color: #fde047; }\n  [data-theme=\"dark\"] .priority.cosmetic { background: #374151; color: #9ca3af; }\n  [data-theme=\"dark\"] .status-badge.pass { background: #064e3b; color: #34d399; }\n  [data-theme=\"dark\"] .status-badge.info { background: #1e3a5f; color: #93c5fd; }\n  [data-theme=\"dark\"] .status-badge.warn { background: #713f12; color: #fde047; }\n  [data-theme=\"dark\"] .status-badge.fail { background: #7f1d1d; color: #fca5a5; }\n  [data-theme=\"dark\"] .zone-tag { background: #1e3a5f; color: #93c5fd; }\n  [data-theme=\"dark\"] .zone-tag.factory { background: #1e3a5f; color: #93c5fd; }\n  [data-theme=\"dark\"] .zone-tag.product { background: #064e3b; color: #6ee7b7; }\n  [data-theme=\"dark\"] .zone-tag.infra { background: #2e1065; color: #c4b5fd; }\n  [data-theme=\"dark\"] .scenario-box.failure { background: #3b1111; border-left-color: #ef4444; }\n  [data-theme=\"dark\"] .scenario-box.success { background: #052e16; border-left-color: #22c55e; }\n  [data-theme=\"dark\"] .ci-check-item:hover { background: #374151; }\n  [data-theme=\"dark\"] .conv-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.3); }\n  [data-theme=\"dark\"] .history-event:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.25); }\n  [data-theme=\"dark\"] .file-path-link { border-bottom-color: #6b7280; }\n  [data-theme=\"dark\"] .file-path-link:hover { border-bottom-color: #60a5fa; color: #60a5fa; }\n  [data-theme=\"dark\"] .stat { background: #1f2937; }\n  [data-theme=\"dark\"] .stat.green { background: #064e3b; color: #34d399; }\n  [data-theme=\"dark\"] .stat.red { background: #7f1d1d; color: #fca5a5; }\n  [data-theme=\"dark\"] #arch-diagram { background: #1a2332; border-color: #374151; }\n  [data-theme=\"dark\"] .history-timeline::before { background: #374151; }\n  [data-theme=\"dark\"] .history-legend { background: #1f2937; }\n  [data-theme=\"dark\"] .conv-card-detail { border-top-color: #374151; }\n\n  /* \u2500\u2500 Light theme diff modal overrides \u2500\u2500 */\n  :root:not([data-theme=\"dark\"]) .file-modal { background: #ffffff; }\n  :root:not([data-theme=\"dark\"]) .file-modal-header { background: #f5f5f5; border-bottom-color: #e0e0e0; }\n  :root:not([data-theme=\"dark\"]) .file-modal-header h3 { color: #333333; }\n  :root:not([data-theme=\"dark\"]) .file-modal-toolbar { background: #fafafa; border-bottom-color: #e0e0e0; }\n  :root:not([data-theme=\"dark\"]) .file-modal-tab { color: #666666; }\n  :root:not([data-theme=\"dark\"]) .file-modal-tab:hover { color: #333333; background: #f0f0f0; }\n  :root:not([data-theme=\"dark\"]) .file-modal-tab.active { color: #1d4ed8; background: #ffffff; border-bottom-color: var(--blue); }\n  :root:not([data-theme=\"dark\"]) .file-modal-body { background: #ffffff; }\n  :root:not([data-theme=\"dark\"]) .file-modal-close { color: #999999; }\n  :root:not([data-theme=\"dark\"]) .file-modal-close:hover { background: #e0e0e0; color: #333333; }\n  :root:not([data-theme=\"dark\"]) .file-modal-github { background: #f0f0f0; border-color: #e0e0e0; color: #333333; }\n  :root:not([data-theme=\"dark\"]) .file-modal-github:hover { background: #e0e0e0; color: #111111; }\n  :root:not([data-theme=\"dark\"]) .fm-stats .fm-add { color: #166534; }\n  :root:not([data-theme=\"dark\"]) .fm-stats .fm-del { color: #991b1b; }\n  :root:not([data-theme=\"dark\"]) .diff-unified .diff-add { background: rgba(34,197,94,0.12); color: #166534; }\n  :root:not([data-theme=\"dark\"]) .diff-unified .diff-del { background: rgba(239,68,68,0.12); color: #991b1b; }\n  :root:not([data-theme=\"dark\"]) .diff-unified .diff-ctx { color: #333333; }\n  :root:not([data-theme=\"dark\"]) .diff-unified .diff-hunk { background: rgba(59,130,246,0.08); color: #2563eb; }\n  :root:not([data-theme=\"dark\"]) .diff-unified .diff-ln { color: #999999; border-right-color: #e0e0e0; }\n  :root:not([data-theme=\"dark\"]) .diff-split .diff-add { background: rgba(34,197,94,0.12); color: #166534; }\n  :root:not([data-theme=\"dark\"]) .diff-split .diff-del { background: rgba(239,68,68,0.12); color: #991b1b; }\n  :root:not([data-theme=\"dark\"]) .diff-split .diff-ctx { color: #333333; }\n  :root:not([data-theme=\"dark\"]) .diff-split .diff-empty { background: #f9f9f9; }\n  :root:not([data-theme=\"dark\"]) .diff-split .diff-ln { color: #999999; }\n  :root:not([data-theme=\"dark\"]) .diff-split .diff-sep { background: #e0e0e0; }\n  :root:not([data-theme=\"dark\"]) .diff-split .diff-hunk td { background: rgba(59,130,246,0.06); color: #2563eb; }\n  :root:not([data-theme=\"dark\"]) .diff-raw td { color: #333333; }\n  :root:not([data-theme=\"dark\"]) .diff-raw .diff-ln { color: #999999; border-right-color: #e0e0e0; }\n  :root:not([data-theme=\"dark\"]) .diff-new-file-banner { background: rgba(34,197,94,0.08); color: #166534; border-bottom-color: #e0e0e0; }\n  :root:not([data-theme=\"dark\"]) .diff-deleted-file-banner { background: rgba(239,68,68,0.08); color: #991b1b; border-bottom-color: #e0e0e0; }\n  :root:not([data-theme=\"dark\"]) .diff-loading { color: #999999; }\n  :root:not([data-theme=\"dark\"]) .diff-error { color: #991b1b; }\n\n  /* \u2500\u2500 Theme toggle \u2500\u2500 */\n  .theme-toggle { display: inline-flex; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-left: 12px; vertical-align: middle; }\n  .theme-toggle button { border: none; background: transparent; padding: 4px 10px; font-size: 14px; cursor: pointer; color: var(--text-secondary); transition: background 0.15s, color 0.15s; line-height: 1; }\n  .theme-toggle button:hover { background: var(--gray-bg); }\n  .theme-toggle button.active { background: var(--blue); color: white; }\n  .theme-toggle button:not(:last-child) { border-right: 1px solid var(--border); }\n\n  * { box-sizing: border-box; margin: 0; padding: 0; }\n  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: var(--text); background: var(--bg); line-height: 1.5; font-size: 14px; }\n  .container { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }\n\n  /* \u2500\u2500 Tabs \u2500\u2500 */\n  .tab-bar { display: flex; gap: 0; background: white; border-radius: 12px 12px 0 0; border: 1px solid var(--border); border-bottom: none; overflow: hidden; }\n  .tab-btn { padding: 12px 24px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; background: transparent; color: var(--text-secondary); border-bottom: 2px solid transparent; transition: all 0.15s; }\n  .tab-btn:hover { background: var(--gray-bg); }\n  .tab-btn.active { color: var(--blue); border-bottom-color: var(--blue); background: white; }\n  .tab-content { display: none; }\n  .tab-content.active { display: block; }\n  .tab-panel { background: white; border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; margin-bottom: 16px; }\n\n  /* \u2500\u2500 Header \u2500\u2500 */\n  .header { background: white; border-radius: 12px; padding: 24px; margin-bottom: 16px; border: 1px solid var(--border); }\n  .header h1 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }\n  .header .meta { font-size: 13px; color: var(--text-secondary); font-family: var(--mono); }\n  .header .meta a { color: var(--blue); text-decoration: none; }\n  .stats { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }\n  .stat { background: var(--gray-bg); border-radius: 8px; padding: 6px 14px; font-size: 13px; font-weight: 500; }\n  .stat .num { font-weight: 700; font-size: 15px; }\n  .stat.green { background: var(--green-bg); color: #166534; }\n  .stat.red { background: #fef2f2; color: #991b1b; }\n\n  /* \u2500\u2500 Gate (removed \u2014 readiness info lives in status badges) \u2500\u2500 */\n  .gate .check-row { display: flex; justify-content: space-between; align-items: center; padding: 7px 0; border-bottom: 1px solid var(--border); font-size: 13px; }\n  .gate .check-row:last-child { border-bottom: none; }\n  .badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }\n  .badge.pass { background: var(--green-bg); color: #166534; }\n  .badge.fail { background: var(--red-bg); color: #991b1b; }\n\n  /* \u2500\u2500 Sections \u2500\u2500 */\n  .section { background: white; border-radius: 12px; margin-bottom: 16px; border: 1px solid var(--border); overflow: hidden; }\n  .section-header { padding: 14px 24px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; transition: background 0.15s; }\n  .section-header:hover { background: var(--gray-bg); }\n  .section-header h2 { font-size: 14px; font-weight: 700; }\n  .section-header .chevron { font-size: 16px; color: var(--text-secondary); transition: transform 0.2s; }\n  .section.collapsed .section-body { display: none; }\n  .section.collapsed .chevron { transform: rotate(-90deg); }\n  .section-body { padding: 0 24px 20px; font-size: 13px; }\n\n  /* \u2500\u2500 Architecture Diagram \u2500\u2500 */\n  .arch-controls { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }\n  .arch-toggle { padding: 5px 14px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid var(--border); background: white; color: var(--text-secondary); }\n  .arch-toggle.active { background: var(--blue); color: white; border-color: var(--blue); }\n  .arch-hint { font-size: 11px; color: var(--text-muted); margin-left: 8px; }\n  .zone-box { cursor: pointer; transition: opacity 0.3s, filter 0.3s; }\n  .zone-box:hover { filter: brightness(0.95); }\n  .zone-box.dimmed { opacity: 0.12; }\n  .zone-box.highlighted { stroke-width: 3; filter: brightness(0.92); }\n  .zone-label { font-size: 11px; font-weight: 600; pointer-events: none; }\n  .zone-sublabel { font-size: 9px; fill: #6b7280; pointer-events: none; }\n  .zone-file-count { font-size: 10px; font-weight: 700; fill: white; pointer-events: none; }\n  .zone-count-bg { pointer-events: none; }\n  .arch-row-label { font-size: 10px; font-weight: 700; fill: #9ca3af; text-transform: uppercase; letter-spacing: 1px; }\n\n  /* \u2500\u2500 Tables \u2500\u2500 */\n  table { width: 100%; border-collapse: collapse; font-size: 13px; }\n  th { text-align: left; padding: 8px 12px; background: var(--gray-bg); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-secondary); border-bottom: 2px solid var(--border); }\n  td { padding: 8px 12px; border-bottom: 1px solid var(--border); vertical-align: top; }\n  tr:last-child td { border-bottom: none; }\n  tr.expandable { cursor: pointer; }\n  tr.expandable:hover { background: var(--gray-bg); }\n  tr.detail-row { display: none; }\n  tr.detail-row.open { display: table-row; }\n  tr.detail-row td { background: #fafbfc; padding: 12px 20px; }\n\n  /* \u2500\u2500 Grade pills \u2500\u2500 */\n  .grade { display: inline-block; width: 28px; height: 28px; line-height: 28px; text-align: center; border-radius: 6px; font-weight: 700; font-size: 12px; }\n  .grade.a { background: var(--green-bg); color: #166534; }\n  .grade.b { background: var(--yellow-bg); color: #854d0e; }\n  .grade.c { background: var(--orange-bg); color: #9a3412; }\n  .grade.f { background: var(--red-bg); color: #991b1b; }\n  .grade.na { background: var(--gray-bg); color: var(--gray); }\n\n  /* \u2500\u2500 Review method badge \u2500\u2500 */\n  .review-method-badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; vertical-align: middle; margin-left: 8px; }\n  .review-method-badge.agent-teams { background: var(--blue-bg, #dbeafe); color: #1d4ed8; }\n  .review-method-badge.main-agent { background: var(--gray-bg); color: var(--gray); }\n\n  /* \u2500\u2500 Agent badges in agentic review table \u2500\u2500 */\n  .agent-tag { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 11px; font-weight: 500; background: var(--gray-bg); color: var(--gray); }\n\n  /* \u2500\u2500 Timing \u2500\u2500 */\n  .time-label { font-family: var(--mono); font-size: 15px; font-weight: 700; }\n  .time-label.normal { color: #166534; }\n  .time-label.acceptable { color: #854d0e; }\n  .time-label.watch { color: #f97316; }\n  .time-label.refactor { color: #ef4444; }\n  [data-theme=\"dark\"] .time-label.normal { color: #34d399; }\n  [data-theme=\"dark\"] .time-label.acceptable { color: #fde047; }\n  [data-theme=\"dark\"] .time-label.watch { color: #fdba74; }\n  [data-theme=\"dark\"] .time-label.refactor { color: #fca5a5; }\n  .time-health-sub { font-size: 10px; font-weight: 500; color: var(--text-muted); margin-top: 1px; }\n  .health-tag { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; padding: 2px 8px; border-radius: 4px; }\n  .health-tag.normal { background: var(--green-bg); color: #166534; }\n  .health-tag.acceptable { background: var(--yellow-bg); color: #854d0e; }\n  .health-tag.watch { background: var(--orange-bg); color: #9a3412; }\n  .health-tag.refactor { background: var(--red-bg); color: #991b1b; }\n\n  /* \u2500\u2500 Decision cards \u2500\u2500 */\n  .decision-card { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; overflow: hidden; }\n  .decision-header { padding: 12px 16px; cursor: pointer; display: flex; gap: 12px; align-items: flex-start; transition: background 0.15s; }\n  .decision-header:hover { background: var(--gray-bg); }\n  .decision-num { font-weight: 700; color: var(--blue); font-size: 14px; min-width: 24px; }\n  .decision-title { font-weight: 600; font-size: 13px; }\n  .decision-rationale { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }\n  .decision-body { display: none; padding: 0 16px 16px; border-top: 1px solid var(--border); }\n  .decision-card.open .decision-body { display: block; }\n  .decision-zones { display: flex; gap: 6px; flex-wrap: wrap; margin: 10px 0; }\n  .zone-tag { font-size: 11px; padding: 2px 8px; border-radius: 4px; font-weight: 600; background: var(--blue-bg); color: #1d4ed8; }\n  .decision-files { margin-top: 10px; }\n  .decision-files table { font-size: 12px; }\n  .decision-files td { padding: 4px 8px; }\n\n  /* \u2500\u2500 Convergence \u2500\u2500 */\n  .convergence-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }\n  .conv-card { border: 1px solid var(--border); border-radius: 8px; padding: 14px; cursor: pointer; transition: box-shadow 0.2s; }\n  .conv-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }\n  .conv-card h4 { font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-secondary); margin-bottom: 8px; }\n  .conv-status { font-size: 20px; font-weight: 700; }\n  .conv-status.passing { color: #166534; }\n  .conv-status.warning { color: #854d0e; }\n  .conv-status.failing { color: #991b1b; }\n  .conv-detail { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }\n  .conv-card-detail { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary); }\n  .conv-card.open .conv-card-detail { display: block; }\n  .conv-card-detail ul { margin: 4px 0 0 16px; list-style: disc; }\n  .conv-card-detail li { margin-bottom: 2px; }\n\n  /* \u2500\u2500 Post-merge \u2500\u2500 */\n  .pm-item { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; overflow: hidden; }\n  .pm-header { padding: 10px 16px; cursor: pointer; display: flex; gap: 10px; align-items: center; transition: background 0.15s; }\n  .pm-header:hover { background: var(--gray-bg); }\n  .pm-body { display: none; padding: 0 16px 16px; border-top: 1px solid var(--border); }\n  .pm-item.open .pm-body { display: block; }\n  .priority { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 4px; white-space: nowrap; }\n  .priority.low { background: var(--blue-bg); color: #1d4ed8; }\n  .priority.medium { background: var(--yellow-bg); color: #854d0e; }\n  .priority.cosmetic { background: var(--gray-bg); color: var(--gray); }\n  .code-block { background: #1e293b; color: #e2e8f0; padding: 12px 16px; border-radius: 6px; font-family: var(--mono); font-size: 12px; line-height: 1.6; overflow-x: auto; margin: 8px 0; white-space: pre; }\n  .scenario-box { padding: 10px 14px; border-radius: 6px; margin: 6px 0; font-size: 12px; }\n  .scenario-box.failure { background: var(--red-bg); border-left: 3px solid var(--red); }\n  .scenario-box.success { background: var(--green-bg); border-left: 3px solid var(--green); }\n  .scenario-label { font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px; }\n\n  /* \u2500\u2500 Spec & Scenarios \u2500\u2500 */\n  .spec-list { list-style: none; padding: 0; }\n  .spec-list li { padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px; display: flex; gap: 8px; align-items: center; }\n  .spec-list li:last-child { border-bottom: none; }\n  .scenario-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }\n  .scenario-card { border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; font-size: 12px; cursor: pointer; transition: background 0.15s; }\n  .scenario-card:hover { background: var(--gray-bg); }\n  .scenario-card .name { font-weight: 600; }\n  .scenario-card .status { font-size: 11px; margin-top: 2px; }\n  .scenario-card-detail { display: none; margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border); font-size: 11px; color: var(--text-secondary); }\n  .scenario-card.open .scenario-card-detail { display: block; }\n  .scenario-card-detail dt { font-weight: 600; color: var(--text); margin-top: 4px; }\n  .scenario-card-detail dd { margin-left: 0; margin-bottom: 2px; }\n  .scenario-category { display: inline-block; padding: 1px 7px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-left: 6px; }\n  .scenario-category.cat-environment { background: #dcfce7; color: #166534; }\n  .scenario-category.cat-training { background: #dbeafe; color: #1d4ed8; }\n  .scenario-category.cat-pipeline { background: #f3e8ff; color: #6d28d9; }\n  .scenario-category.cat-integration { background: #fff7ed; color: #9a3412; }\n  [data-theme=\"dark\"] .scenario-category.cat-environment { background: #064e3b; color: #6ee7b7; }\n  [data-theme=\"dark\"] .scenario-category.cat-training { background: #1e3a5f; color: #93c5fd; }\n  [data-theme=\"dark\"] .scenario-category.cat-pipeline { background: #2e1065; color: #c4b5fd; }\n  [data-theme=\"dark\"] .scenario-category.cat-integration { background: #7c2d12; color: #fdba74; }\n  .scenario-legend { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 10px; font-size: 11px; color: var(--text-secondary); }\n  .scenario-card.zone-dimmed { opacity: 0.35; }\n  .scenario-card.zone-glow { box-shadow: 0 0 0 2px var(--blue); }\n\n  /* \u2500\u2500 Factory History \u2500\u2500 */\n  .history-timeline { position: relative; padding-left: 24px; }\n  .history-timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: var(--border); }\n  .history-event { position: relative; margin-bottom: 16px; padding: 12px 16px; background: white; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: box-shadow 0.2s; }\n  .history-event:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }\n  .history-event::before { content: ''; position: absolute; left: -20px; top: 16px; width: 10px; height: 10px; border-radius: 50%; background: var(--blue); border: 2px solid white; }\n  .history-event.intervention::before { background: var(--orange); }\n  .history-event .event-title { font-weight: 600; font-size: 13px; }\n  .history-event .event-detail { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }\n  .history-event .event-meta { font-size: 11px; color: var(--text-muted); margin-top: 4px; font-family: var(--mono); }\n  .history-event-detail { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary); }\n  .history-event.open .history-event-detail { display: block; }\n  .event-agent { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; background: var(--blue-bg); color: #1d4ed8; margin-left: 4px; }\n  .event-agent.human { background: var(--orange-bg); color: #9a3412; }\n  .history-legend { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 16px; padding: 10px 14px; background: var(--gray-bg); border-radius: 6px; font-size: 11px; color: var(--text-secondary); }\n  .history-legend-item { display: flex; align-items: center; gap: 6px; }\n  .history-legend-dot { width: 10px; height: 10px; border-radius: 50%; }\n\n  /* \u2500\u2500 Footer \u2500\u2500 */\n  .footer { text-align: center; padding: 16px; font-size: 11px; color: var(--text-muted); }\n\n  /* \u2500\u2500 Zone tag color variants \u2500\u2500 */\n  .zone-tag.factory { background: var(--blue-bg); color: #1d4ed8; }\n  .zone-tag.product { background: #dcfce7; color: #166534; }\n  .zone-tag.infra { background: var(--purple-bg); color: #6d28d9; }\n\n  /* \u2500\u2500 Architecture legend \u2500\u2500 */\n  .arch-legend { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 10px; padding: 10px 14px; background: var(--gray-bg); border-radius: 6px; font-size: 11px; color: var(--text-secondary); }\n  .arch-legend-item { display: flex; align-items: center; gap: 6px; }\n  .arch-legend-swatch { width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.1); }\n  .arch-legend-circle { width: 14px; height: 14px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 700; color: white; }\n\n  /* \u2500\u2500 What Changed zone detail blocks \u2500\u2500 */\n  .wc-zone-detail { display: none; padding: 8px 0; }\n  .wc-zone-detail.active { display: block; }\n  .wc-zone-detail h4 { font-size: 13px; font-weight: 700; margin-bottom: 6px; }\n\n  /* \u2500\u2500 Agentic review \u2500\u2500 */\n  .adv-scroll { max-height: 500px; overflow-y: auto; }\n  .adv-row { cursor: pointer; transition: max-height 0.3s ease, opacity 0.3s ease; }\n  .adv-row:hover { background: var(--gray-bg); }\n  .adv-row.collapsed-row { max-height: 24px; opacity: 0.5; overflow: hidden; }\n  .adv-no-match { display: none; padding: 16px; text-align: center; color: var(--text-muted); font-size: 13px; font-style: italic; }\n  .adv-no-match.visible { display: block; }\n  .adv-detail-row { display: none; }\n  .adv-detail-row.open { display: table-row; }\n  .adv-detail-row td { background: #fafbfc; padding: 12px 20px; font-size: 12px; border-bottom: 1px solid var(--border); }\n\n  /* Agent grade badges (compact per-file) */\n  .agent-badges-cell { white-space: nowrap; }\n  .agent-grade-badge { display: inline-flex; align-items: center; gap: 2px; margin-right: 6px; padding: 1px 4px; border-radius: 4px; background: var(--gray-bg); font-size: 11px; }\n  .agent-grade-badge .agent-abbrev { font-weight: 700; color: var(--text-muted); font-size: 10px; font-family: var(--mono); }\n  .agent-grade-badge .grade { font-size: 11px; padding: 0 2px; }\n\n  /* Agent legend */\n  .agent-legend { display: inline-flex; gap: 12px; margin-left: 12px; font-size: 11px; color: var(--text-muted); vertical-align: middle; }\n  .agent-legend-item { display: inline-flex; align-items: center; gap: 3px; cursor: help; }\n  .agent-legend-item .agent-abbrev { font-weight: 700; font-family: var(--mono); font-size: 10px; background: var(--gray-bg); padding: 1px 3px; border-radius: 3px; }\n\n  /* Per-agent detail breakdown (inside expanded row) */\n  .agent-detail-entry { padding: 8px 0; border-bottom: 1px solid var(--border); }\n  .agent-detail-entry:last-child { border-bottom: none; }\n  .agent-detail-header { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }\n  .agent-detail-header .agent-abbrev { font-weight: 700; font-family: var(--mono); font-size: 10px; background: var(--gray-bg); padding: 1px 4px; border-radius: 3px; }\n  .agent-detail-header .grade { font-size: 11px; }\n  .agent-detail-name { font-size: 11px; color: var(--text-muted); }\n  .agent-detail-body { font-size: 12px; line-height: 1.5; padding-left: 4px; }\n\n  /* \u2500\u2500 CI sub-check drill-down \u2500\u2500 */\n  .ci-check-item { padding: 6px 0; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }\n  .ci-check-item:last-child { border-bottom: none; }\n  .ci-check-item:hover { background: #f0f4f8; }\n  .ci-check-summary { font-size: 12px; display: flex; align-items: center; gap: 6px; }\n  .ci-check-summary .chevron-sm { font-size: 10px; color: var(--text-muted); transition: transform 0.2s; display: inline-block; }\n  .ci-check-item.open .chevron-sm { transform: rotate(90deg); }\n  .ci-check-detail { display: none; padding: 6px 0 4px 20px; font-size: 11px; color: var(--text-secondary); }\n  .ci-check-item.open .ci-check-detail { display: block; }\n\n  /* \u2500\u2500 Floating architecture diagram \u2500\u2500 */\n  .arch-floating { position: fixed; top: 16px; right: 16px; width: 40%; max-width: 480px; z-index: 100; background: rgba(255,255,255,0.95); border-radius: 10px; border: 1px solid var(--border); box-shadow: 0 8px 32px rgba(0,0,0,0.12); padding: 10px; transition: opacity 0.3s ease, transform 0.3s ease; opacity: 0; transform: translateX(40px); pointer-events: none; }\n  .arch-floating.visible { opacity: 1; transform: translateX(0); pointer-events: auto; }\n  .arch-floating svg { width: 100%; height: auto; }\n  .arch-floating-close { position: absolute; top: 6px; right: 10px; background: none; border: none; font-size: 16px; cursor: pointer; color: var(--text-muted); z-index: 101; padding: 2px 6px; border-radius: 4px; }\n  .arch-floating-close:hover { background: var(--gray-bg); color: var(--text); }\n\n  /* \u2500\u2500 File path modal \u2500\u2500 */\n  .file-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.45); z-index: 200; justify-content: center; align-items: center; }\n  .file-modal-overlay.visible { display: flex; }\n  .file-modal { background: #1e1e1e; border-radius: 10px; width: 95vw; max-width: 1400px; height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.4); display: flex; flex-direction: column; }\n  .file-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: #2d2d2d; border-bottom: 1px solid #404040; flex-shrink: 0; }\n  .file-modal-header h3 { font-size: 13px; font-family: var(--mono); font-weight: 500; color: #cccccc; }\n  .file-modal-header .fm-stats { font-size: 11px; font-family: var(--mono); margin-left: 12px; }\n  .file-modal-header .fm-stats .fm-add { color: #3fb950; }\n  .file-modal-header .fm-stats .fm-del { color: #f85149; }\n  .file-modal-close { background: none; border: none; font-size: 18px; cursor: pointer; color: #808080; padding: 2px 8px; border-radius: 4px; }\n  .file-modal-close:hover { background: #404040; color: #cccccc; }\n  .file-modal-toolbar { display: flex; justify-content: space-between; align-items: center; padding: 6px 16px; background: #252526; border-bottom: 1px solid #404040; flex-shrink: 0; }\n  .file-modal-tabs { display: flex; gap: 0; }\n  .file-modal-tab { padding: 6px 14px; font-size: 11px; font-weight: 600; cursor: pointer; border: none; background: none; color: #808080; border-bottom: 2px solid transparent; border-radius: 4px 4px 0 0; }\n  .file-modal-tab:hover { color: #cccccc; background: #2d2d2d; }\n  .file-modal-tab.active { color: #ffffff; border-bottom-color: var(--blue); background: #1e1e1e; }\n  .file-modal-github { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: #2d2d2d; border: 1px solid #404040; border-radius: 4px; color: #cccccc; text-decoration: none; font-size: 11px; font-weight: 500; }\n  .file-modal-github:hover { background: #404040; color: white; }\n  .file-modal-body { flex: 1; overflow: auto; background: #1e1e1e; }\n\n  /* \u2500\u2500 Diff rendering \u2500\u2500 */\n  .diff-view { font-family: var(--mono); font-size: 12px; line-height: 1.55; }\n  .diff-unified { width: 100%; border-collapse: collapse; }\n  .diff-unified td { padding: 0 12px; white-space: pre-wrap; word-break: break-all; vertical-align: top; border: none; }\n  .diff-new-file-banner { padding: 8px 16px; background: rgba(63,185,80,0.1); color: #3fb950; font-size: 12px; font-weight: 500; border-bottom: 1px solid #333333; }\n  .diff-deleted-file-banner { padding: 8px 16px; background: rgba(248,81,73,0.1); color: #f85149; font-size: 12px; font-weight: 500; border-bottom: 1px solid #333333; }\n  .diff-unified .diff-ln { width: 50px; min-width: 50px; text-align: right; color: #636363; user-select: none; padding-right: 8px; font-size: 11px; border-right: 1px solid #333333; }\n  .diff-unified .diff-add { background: rgba(63,185,80,0.15); color: #3fb950; }\n  .diff-unified .diff-del { background: rgba(248,81,73,0.15); color: #f85149; }\n  .diff-unified .diff-ctx { color: #cccccc; }\n  .diff-unified .diff-hunk { background: rgba(56,139,253,0.12); color: #58a6ff; padding: 6px 12px; font-style: italic; }\n  .diff-split { width: 100%; border-collapse: collapse; }\n  .diff-split td { padding: 0 6px; white-space: pre; vertical-align: top; border: none; font-family: var(--mono); font-size: 12px; line-height: 1.55; }\n  .diff-split-wrapper { overflow-x: auto; }\n  .diff-split .diff-ln { width: 40px; min-width: 40px; text-align: right; color: #636363; user-select: none; padding-right: 6px; font-size: 11px; }\n  .diff-split .diff-sep { width: 2px; min-width: 2px; background: #2d2d2d; padding: 0; }\n  .diff-split .diff-code-left, .diff-split .diff-code-right { min-width: 0; max-width: 50vw; white-space: pre; overflow-x: auto; }\n  .diff-split .diff-add { background: rgba(63,185,80,0.15); color: #3fb950; }\n  .diff-split .diff-del { background: rgba(248,81,73,0.15); color: #f85149; }\n  .diff-split .diff-ctx { color: #cccccc; }\n  .diff-split .diff-empty { background: #161616; }\n  .diff-split .diff-hunk td { background: rgba(56,139,253,0.08); color: #58a6ff; font-style: italic; padding: 4px 8px; }\n  .diff-raw { color: #cccccc; }\n  .diff-raw table { width: 100%; border-collapse: collapse; }\n  .diff-raw td { padding: 0 12px; white-space: pre-wrap; word-break: break-all; vertical-align: top; border: none; font-family: var(--mono); font-size: 12px; line-height: 1.55; }\n  .diff-raw .diff-ln { width: 50px; min-width: 50px; text-align: right; color: #636363; user-select: none; padding-right: 8px; font-size: 11px; border-right: 1px solid #333333; }\n  .diff-loading { color: #808080; text-align: center; padding: 60px 20px; font-size: 13px; }\n  .diff-error { color: #f85149; text-align: center; padding: 40px 20px; font-size: 13px; }\n  .file-path-link { color: inherit; text-decoration: none; border-bottom: 1px dashed var(--text-muted); cursor: pointer; transition: border-color 0.15s; }\n  .file-path-link:hover { border-bottom-color: var(--blue); color: var(--blue); }\n\n  /* \u2500\u2500 CI Chevron rotation \u2500\u2500 */\n  .ci-chevron { display: inline-block; transition: transform 0.2s; }\n  tr.expandable.ci-open .ci-chevron { transform: rotate(180deg); }\n\n  /* \u2500\u2500 Status badges \u2500\u2500 */\n  .status-row { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }\n  .status-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; }\n  .status-badge.pass { background: var(--green-bg); color: #166534; }\n  .status-badge.info { background: var(--blue-bg); color: #1d4ed8; }\n  .status-badge.warn { background: var(--yellow-bg); color: #854d0e; }\n  .status-badge.fail { background: #fef2f2; color: #991b1b; }\n  .gate-popover { display: none; position: absolute; background: white; border: 1px solid var(--border); border-radius: 6px; padding: 10px 14px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); font-size: 12px; z-index: 50; max-width: 300px; }\n  .gate-popover.visible { display: block; }\n  .gate-clickable { cursor: pointer; border-bottom: 1px dashed var(--text-muted); }\n  .gate-clickable:hover { color: var(--blue); border-bottom-color: var(--blue); }\n  .unverified-flag { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 9px; font-weight: 700; background: var(--orange-bg); color: #9a3412; margin-left: 6px; text-transform: uppercase; }\n\n  @media (max-width: 768px) {\n    .stats { flex-direction: column; gap: 8px; }\n    .convergence-grid { grid-template-columns: 1fr; }\n    .scenario-grid { grid-template-columns: 1fr; }\n    .container { padding: 12px 8px; }\n    .arch-floating { width: 60%; }\n    .file-modal { width: 98vw; height: 95vh; }\n  }\n</style>\n</head>\n<body>\n<!-- Visual inspection watermark: visible until removed by the reviewing agent -->\n<div id=\"visual-inspection-banner\" style=\"position:fixed;top:0;left:0;right:0;z-index:10000;background:#dc2626;color:white;text-align:center;padding:12px 20px;font-weight:700;font-size:15px;font-family:-apple-system,BlinkMacSystemFont,sans-serif;box-shadow:0 2px 8px rgba(0,0,0,0.3);letter-spacing:0.3px\">\n  This Pack Has NOT Been Visually Inspected\n</div>\n<div id=\"visual-inspection-spacer\" style=\"height:48px\"></div>\n<div class=\"container\">\n\n  <!-- \u2550\u2550 DATA INJECTION POINT \u2550\u2550 -->\n  <!-- The rendering script injects the ReviewPackData JSON here -->\n\n  <!-- \u2550\u2550 HEADER \u2550\u2550 -->\n  <div class=\"header\">\n    <h1 id=\"pr-title\"><!-- INJECT: header.title --></h1>\n    <div class=\"meta\">\n      <a id=\"pr-url\" href=\"#\" target=\"_blank\"><!-- INJECT: header.prUrl --></a><br>\n      <span id=\"pr-branch-info\"><!-- INJECT: header.headBranch --> &rarr; <!-- INJECT: header.baseBranch --></span>\n      &nbsp;|&nbsp; HEAD: <code id=\"pr-sha\"><!-- INJECT: header.headSha --></code>\n    </div>\n    <div class=\"stats\" id=\"pr-stats\">\n      <!-- INJECT: stat items for additions, deletions, files, commits -->\n    </div>\n    <div class=\"status-row\" id=\"pr-status-row\">\n      <!-- INJECT: status badges -->\n      <div class=\"theme-toggle\" style=\"margin-left:auto\">\n        <button onclick=\"setTheme('light')\" title=\"Light theme\" data-theme-btn=\"light\">&#x2600;</button>\n        <button onclick=\"setTheme('dark')\" title=\"Dark theme\" data-theme-btn=\"dark\">&#x1F319;</button>\n        <button onclick=\"setTheme('system')\" title=\"System theme\" data-theme-btn=\"system\">&#x2699;</button>\n      </div>\n    </div>\n  </div>\n\n  <!-- \u2550\u2550 TAB BAR \u2550\u2550 -->\n  <div class=\"tab-bar\" id=\"tab-bar\">\n    <button class=\"tab-btn active\" onclick=\"switchTab('review')\">Review</button>\n    <!-- INJECT: Factory History tab button (conditionally, only if factoryHistory is present) -->\n  </div>\n\n  <!-- \u2550\u2550 TAB 1: REVIEW \u2550\u2550 -->\n  <div id=\"tab-review\" class=\"tab-content active\">\n    <div class=\"tab-panel\" style=\"padding:20px 24px\">\n\n    <!-- Section: Architecture -->\n    <div class=\"section\" style=\"border:none;margin-bottom:0\">\n      <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n        <h2>Architecture</h2>\n        <span class=\"chevron\">&#x25BC;</span>\n      </div>\n      <div class=\"section-body\">\n        <div class=\"arch-controls\">\n          <button class=\"arch-toggle active\" onclick=\"setArchView('update',this)\">Update (this PR)</button>\n          <button class=\"arch-toggle\" onclick=\"setArchView('baseline',this)\">Baseline (before merge)</button>\n          <span style=\"margin-left:auto;display:inline-flex;gap:4px;align-items:center\">\n            <button class=\"arch-toggle\" onclick=\"archZoom(-1)\" title=\"Zoom out\">&minus;</button>\n            <button class=\"arch-toggle\" onclick=\"archZoom(0)\" title=\"Fit to content\">Fit</button>\n            <button class=\"arch-toggle\" onclick=\"archZoom(1)\" title=\"Zoom in\">+</button>\n          </span>\n          <span class=\"arch-hint\">Click a zone to filter findings &bull; Click background to reset</span>\n        </div>\n        <svg id=\"arch-diagram\" viewBox=\"0 0 780 360\" style=\"width:100%;max-width:780px;background:#fafbfc;border-radius:8px;border:1px solid var(--border)\">\n          <!-- INJECT: architecture zones, labels, arrows from DATA.architecture -->\n          <!-- Row labels -->\n          <!-- Zone boxes (rect.zone-box[data-zone=\"...\"]) -->\n          <!-- Zone labels (text.zone-label) -->\n          <!-- Zone sublabels (text.zone-sublabel) -->\n          <!-- File count circles (circle.zone-count-bg + text.zone-file-count) -->\n          <!-- Flow arrows (line with marker-end) -->\n        </svg>\n        <div id=\"zone-filter-info\" style=\"margin-top:8px;font-size:12px;color:var(--blue);font-weight:600;display:none\"></div>\n        <div class=\"arch-legend\">\n          <div class=\"arch-legend-item\"><div class=\"arch-legend-circle\" style=\"background:#3b82f6\">3</div> Blue circle = files changed in zone</div>\n          <div class=\"arch-legend-item\"><div class=\"arch-legend-swatch\" style=\"background:#dbeafe;border-color:#3b82f6\"></div> Factory infrastructure</div>\n          <div class=\"arch-legend-item\"><div class=\"arch-legend-swatch\" style=\"background:#dcfce7;border-color:#22c55e\"></div> Product code</div>\n          <div class=\"arch-legend-item\"><div class=\"arch-legend-swatch\" style=\"background:#f3e8ff;border-color:#8b5cf6\"></div> Infrastructure &amp; docs</div>\n          <div class=\"arch-legend-item\" style=\"margin-left:auto;font-style:italic\">Click zone to filter &bull; click background to reset</div>\n        </div>\n      </div>\n    </div>\n\n    </div><!-- end tab-panel -->\n\n    <!-- Section: Spec & Scenarios -->\n    <div class=\"section\">\n      <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n        <h2>Spec &amp; Scenarios</h2>\n        <span class=\"chevron\">&#x25BC;</span>\n      </div>\n      <div class=\"section-body\">\n        <h3 style=\"font-size:13px;margin-bottom:8px\">Specifications</h3>\n        <ul class=\"spec-list\" id=\"spec-list\">\n          <!-- INJECT: specification items from DATA.specs -->\n        </ul>\n        <h3 style=\"font-size:13px;margin:14px 0 8px\">Scenarios</h3>\n        <div class=\"scenario-legend\" id=\"scenario-legend\">\n          <!-- INJECT: scenario category legend items -->\n        </div>\n        <div class=\"scenario-grid\" id=\"scenario-grid\">\n          <!-- INJECT: scenario cards from DATA.scenarios -->\n        </div>\n      </div>\n    </div>\n\n    <!-- Section: What Changed -->\n    <div class=\"section\">\n      <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n        <h2>What Changed</h2>\n        <span class=\"chevron\">&#x25BC;</span>\n      </div>\n      <div class=\"section-body\" id=\"what-changed-body\">\n        <p style=\"margin-bottom:4px;font-size:11px;color:var(--text-muted)\">Generated from <code>git diff</code> by delegated diff-reading agent. Code diffs are ground truth.</p>\n        <div class=\"wc-default\" id=\"wc-default\">\n          <!-- INJECT: whatChanged.defaultSummary.infrastructure and .product -->\n        </div>\n        <!-- INJECT: wc-zone-detail divs for each zone -->\n      </div>\n    </div>\n\n    <!-- Section: Agentic Review -->\n    <div class=\"section\">\n      <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n        <h2 id=\"adv-header\">Agentic Review <!-- INJECT: adversarial review method badge --></h2>\n        <span class=\"chevron\">&#x25BC;</span>\n      </div>\n      <div class=\"section-body\">\n        <div class=\"adv-scroll\">\n        <div id=\"adv-no-match\" class=\"adv-no-match\">No review findings in this zone.</div>\n        <table id=\"adv-table\">\n          <thead><tr><th>File</th><th>Agents</th><th>Zone</th><th>Notable</th></tr></thead>\n          <tbody>\n            <!-- INJECT: adversarial finding rows from DATA.agenticReview.findings -->\n            <!-- Each row: tr.adv-row (file-level, grouped) + tr.adv-detail-row (per-agent breakdown) -->\n          </tbody>\n        </table>\n        </div>\n      </div>\n    </div>\n\n    <!-- Section: CI Performance -->\n    <div class=\"section\">\n      <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n        <h2>CI Performance</h2>\n        <span class=\"chevron\">&#x25BC;</span>\n      </div>\n      <div class=\"section-body\">\n        <table>\n          <thead><tr><th>Check</th><th>Status</th><th>Time</th><th></th></tr></thead>\n          <tbody id=\"ci-table-body\">\n            <!-- INJECT: CI check rows from DATA.ciPerformance -->\n            <!-- Each: tr.expandable + tr.detail-row with sub-checks -->\n          </tbody>\n        </table>\n        <p style=\"margin-top:10px;font-size:11px;color:var(--text-muted)\">\n          <strong>Thresholds:</strong> &#x2713; under 1m = normal &bull; &#x25CB; 1-5m = acceptable &bull; &#x26A0; 5-10m = watch &bull; &#x2716; over 10m = needs refactoring\n        </p>\n      </div>\n    </div>\n\n    <!-- Section: Key Decisions -->\n    <div class=\"section\">\n      <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n        <h2>Key Decisions</h2>\n        <span class=\"chevron\">&#x25BC;</span>\n      </div>\n      <div class=\"section-body\" id=\"decisions-container\">\n        <!-- INJECT: decision cards from DATA.decisions -->\n      </div>\n    </div>\n\n    <!-- Section: Convergence Result -->\n    <div class=\"section\">\n      <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n        <h2>Convergence Result</h2>\n        <span class=\"chevron\">&#x25BC;</span>\n      </div>\n      <div class=\"section-body\">\n        <div class=\"convergence-grid\" id=\"convergence-grid\">\n          <!-- INJECT: convergence gate cards + overall card from DATA.convergence -->\n        </div>\n      </div>\n    </div>\n\n    <!-- Section: Post-Merge Items -->\n    <div class=\"section\">\n      <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n        <h2>Post-Merge Items</h2>\n        <span class=\"chevron\">&#x25BC;</span>\n      </div>\n      <div class=\"section-body\" id=\"post-merge-container\">\n        <!-- INJECT: post-merge items from DATA.postMergeItems -->\n      </div>\n    </div>\n\n  </div><!-- end tab-review -->\n\n  <!-- \u2550\u2550 TAB 2: FACTORY HISTORY (conditional) \u2550\u2550 -->\n  <div id=\"tab-history\" class=\"tab-content\">\n    <div class=\"tab-panel\" style=\"padding:20px 24px\">\n      <h2 style=\"font-size:15px;font-weight:700;margin-bottom:16px\">Factory Convergence History</h2>\n      <div class=\"history-legend\">\n        <div class=\"history-legend-item\"><div class=\"history-legend-dot\" style=\"background:var(--blue)\"></div> Automated event</div>\n        <div class=\"history-legend-item\"><div class=\"history-legend-dot\" style=\"background:var(--orange)\"></div> Human/agent intervention</div>\n        <div class=\"history-legend-item\" style=\"margin-left:auto;font-style:italic\">Click event to expand details</div>\n      </div>\n      <div class=\"convergence-grid\" style=\"margin-bottom:20px\" id=\"history-summary-cards\">\n        <!-- INJECT: iteration count + satisfaction trajectory cards -->\n      </div>\n      <h3 style=\"font-size:13px;font-weight:700;margin-bottom:12px\">Timeline</h3>\n      <div class=\"history-timeline\" id=\"history-timeline\">\n        <!-- INJECT: factory history events from DATA.factoryHistory.timeline -->\n      </div>\n      <h3 style=\"font-size:13px;font-weight:700;margin:20px 0 12px\">Gate Findings by Iteration</h3>\n      <table id=\"gate-findings-table\">\n        <thead><tr><th>Phase</th><th>Gate 1</th><th>Gate 2</th><th>Gate 3</th><th>Action</th></tr></thead>\n        <tbody>\n          <!-- INJECT: gate finding rows from DATA.factoryHistory.gateFindings -->\n        </tbody>\n      </table>\n    </div>\n  </div>\n\n  <div class=\"footer\">\n    Generated by review pack agent &nbsp;|&nbsp; <span id=\"footer-date\"><!-- INJECT: header.generatedAt --></span> &nbsp;|&nbsp; HEAD: <span id=\"footer-sha\"><!-- INJECT: header.headSha --></span><br>\n    <span style=\"font-size:10px\">Deterministic rendering from structured data &bull; Code diffs are ground truth</span>\n  </div>\n\n</div>\n\n<!-- Floating architecture diagram (populated by JS) -->\n<div id=\"arch-floating\" class=\"arch-floating\">\n  <button class=\"arch-floating-close\" onclick=\"dismissFloatingDiagram()\" title=\"Dismiss floating diagram\">&times;</button>\n  <div id=\"arch-floating-content\"></div>\n</div>\n\n<!-- File diff modal -->\n<div id=\"file-modal-overlay\" class=\"file-modal-overlay\" onclick=\"if(event.target===this)closeFileModal()\">\n  <div class=\"file-modal\">\n    <div class=\"file-modal-header\">\n      <div style=\"display:flex;align-items:center;gap:8px;overflow:hidden\">\n        <h3 id=\"file-modal-path\" style=\"white-space:nowrap;overflow:hidden;text-overflow:ellipsis\"></h3>\n        <span id=\"file-modal-stats\" class=\"fm-stats\"></span>\n      </div>\n      <button class=\"file-modal-close\" onclick=\"closeFileModal()\">&times;</button>\n    </div>\n    <div class=\"file-modal-toolbar\">\n      <div class=\"file-modal-tabs\">\n        <button class=\"file-modal-tab active\" data-view=\"side-by-side\" onclick=\"setFileModalTab(this,'side-by-side')\">Side-by-side</button>\n        <button class=\"file-modal-tab\" data-view=\"integrated\" onclick=\"setFileModalTab(this,'integrated')\">Unified</button>\n        <button class=\"file-modal-tab\" data-view=\"raw\" onclick=\"setFileModalTab(this,'raw')\">Raw file</button>\n      </div>\n      <a id=\"file-modal-github-link\" class=\"file-modal-github\" href=\"#\" target=\"_blank\">View on GitHub &rarr;</a>\n    </div>\n    <div class=\"file-modal-body\" id=\"file-modal-body\">\n      <div class=\"diff-loading\">Loading diff data&hellip;</div>\n    </div>\n  </div>\n</div>\n\n<!-- Gate popover -->\n<div id=\"gate-popover\" class=\"gate-popover\"></div>\n\n<script>\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// DATA INJECTION POINT\n// Replace this empty object with the ReviewPackData JSON\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nconst DATA = {};\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Theme switching (Light / Dark / System)\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n(function initTheme() {\n  const stored = localStorage.getItem('pr-pack-theme') || 'system';\n  applyTheme(stored);\n  updateThemeButtons(stored);\n})();\n\nfunction setTheme(theme) {\n  localStorage.setItem('pr-pack-theme', theme);\n  applyTheme(theme);\n  updateThemeButtons(theme);\n}\n\nfunction applyTheme(theme) {\n  if (theme === 'system') {\n    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;\n    document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');\n  } else {\n    document.documentElement.setAttribute('data-theme', theme);\n  }\n}\n\nfunction updateThemeButtons(theme) {\n  document.querySelectorAll('.theme-toggle button').forEach(btn => {\n    btn.classList.toggle('active', btn.getAttribute('data-theme-btn') === theme);\n  });\n}\n\nwindow.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {\n  const stored = localStorage.getItem('pr-pack-theme') || 'system';\n  if (stored === 'system') applyTheme('system');\n});\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Tab switching\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction switchTab(tab) {\n  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));\n  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));\n  document.getElementById('tab-' + tab).classList.add('active');\n  event.target.classList.add('active');\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// CI job detail toggle\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction toggleCIDetail(row) {\n  const detail = row.nextElementSibling;\n  if (detail && detail.classList.contains('detail-row')) {\n    detail.classList.toggle('open');\n    row.classList.toggle('ci-open');\n  }\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Decision card toggle + zone highlighting\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction toggleDecision(card) {\n  const wasOpen = card.classList.contains('open');\n  document.querySelectorAll('.decision-card').forEach(c => c.classList.remove('open'));\n  if (!wasOpen) {\n    card.classList.add('open');\n    const zones = card.dataset.zones.split(' ');\n    highlightZones(zones);\n  } else {\n    resetZones();\n  }\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Adversarial review row toggle\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction toggleAdvDetail(row) {\n  const detail = row.nextElementSibling;\n  if (detail && detail.classList.contains('adv-detail-row')) {\n    detail.classList.toggle('open');\n  }\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Architecture zone highlighting (cross-section filtering)\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlet currentActiveZones = null;\n\nfunction highlightZones(activeZones) {\n  currentActiveZones = activeZones;\n\n  // 1. Highlight zones in main and floating diagrams\n  ['#arch-diagram', '#arch-floating'].forEach(sel => {\n    document.querySelectorAll(sel + ' .zone-box').forEach(box => {\n      const zone = box.dataset.zone;\n      if (activeZones.includes(zone)) {\n        box.classList.remove('dimmed');\n        box.classList.add('highlighted');\n      } else {\n        box.classList.add('dimmed');\n        box.classList.remove('highlighted');\n      }\n    });\n  });\n\n  const info = document.getElementById('zone-filter-info');\n  info.textContent = 'Showing zones: ' + activeZones.join(', ');\n  info.style.display = 'block';\n\n  // 2. Filter adversarial review rows\n  let anyMatch = false;\n  document.querySelectorAll('.adv-row').forEach(row => {\n    const rowZones = row.dataset.zones.split(' ');\n    const match = rowZones.some(z => activeZones.includes(z));\n    row.classList.toggle('collapsed-row', !match);\n    if (match) anyMatch = true;\n    const detailRow = row.nextElementSibling;\n    if (detailRow && detailRow.classList.contains('adv-detail-row')) {\n      if (!match) {\n        detailRow.style.display = 'none';\n        detailRow.classList.remove('open');\n      } else {\n        detailRow.style.display = '';\n      }\n    }\n  });\n  const noMatch = document.getElementById('adv-no-match');\n  if (noMatch) noMatch.classList.toggle('visible', !anyMatch);\n\n  // 3. Filter scenario cards\n  document.querySelectorAll('.scenario-card[data-zone]').forEach(card => {\n    const cardZones = card.dataset.zone.split(' ');\n    const match = cardZones.some(z => activeZones.includes(z));\n    card.classList.toggle('zone-dimmed', !match);\n    card.classList.toggle('zone-glow', match);\n  });\n\n  // 4. Filter What Changed section\n  const wcDefault = document.getElementById('wc-default');\n  if (wcDefault) wcDefault.style.display = 'none';\n  document.querySelectorAll('.wc-zone-detail').forEach(d => {\n    d.classList.toggle('active', activeZones.includes(d.dataset.zone));\n  });\n  if (!document.querySelector('.wc-zone-detail.active') && wcDefault) {\n    wcDefault.style.display = '';\n  }\n}\n\nfunction resetZones() {\n  currentActiveZones = null;\n  document.querySelectorAll('.zone-box').forEach(box => box.classList.remove('dimmed', 'highlighted'));\n  document.getElementById('zone-filter-info').style.display = 'none';\n  document.querySelectorAll('.adv-row').forEach(row => row.classList.remove('collapsed-row'));\n  document.querySelectorAll('.adv-detail-row').forEach(row => row.style.display = '');\n  const noMatch = document.getElementById('adv-no-match');\n  if (noMatch) noMatch.classList.remove('visible');\n  document.querySelectorAll('.scenario-card[data-zone]').forEach(card => card.classList.remove('zone-dimmed', 'zone-glow'));\n  const wcDefault = document.getElementById('wc-default');\n  if (wcDefault) wcDefault.style.display = '';\n  document.querySelectorAll('.wc-zone-detail').forEach(d => d.classList.remove('active'));\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Zone click handlers\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction attachZoneClickHandlers(container) {\n  container.querySelectorAll('.zone-box').forEach(box => {\n    box.addEventListener('click', (e) => {\n      e.stopPropagation();\n      const zone = box.dataset.zone;\n      if (currentActiveZones && currentActiveZones.length === 1 && currentActiveZones[0] === zone) {\n        resetZones();\n      } else {\n        highlightZones([zone]);\n      }\n    });\n  });\n}\n\n// Attach to main diagram\nconst mainDiagram = document.getElementById('arch-diagram');\nif (mainDiagram) {\n  attachZoneClickHandlers(mainDiagram);\n  mainDiagram.addEventListener('click', (e) => {\n    if (e.target.tagName === 'svg' || (e.target.tagName === 'text' && e.target.classList.contains('arch-row-label'))) {\n      resetZones();\n      document.querySelectorAll('.decision-card').forEach(c => c.classList.remove('open'));\n    }\n  });\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Architecture view toggle\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction setArchView(view, btn) {\n  document.querySelectorAll('.arch-toggle').forEach(b => b.classList.remove('active'));\n  btn.classList.add('active');\n  if (view === 'baseline') {\n    document.querySelectorAll('.zone-box').forEach(box => { box.style.opacity = '0.25'; });\n    document.getElementById('zone-filter-info').textContent = 'Baseline view: before merge';\n    document.getElementById('zone-filter-info').style.display = 'block';\n  } else {\n    document.querySelectorAll('.zone-box').forEach(box => {\n      box.style.opacity = '1';\n      box.classList.remove('dimmed', 'highlighted');\n    });\n    document.getElementById('zone-filter-info').style.display = 'none';\n  }\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Architecture zoom\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlet archZoomLevel = 1;\nconst archOriginalViewBox = (function() {\n  const svg = document.getElementById('arch-diagram');\n  return svg ? svg.getAttribute('viewBox') : '0 0 780 400';\n})();\n\nfunction archZoom(direction) {\n  const svg = document.getElementById('arch-diagram');\n  if (!svg) return;\n  const parts = archOriginalViewBox.split(/\\s+/).map(Number);\n  if (direction === 0) {\n    archZoomLevel = 1;\n  } else {\n    archZoomLevel = Math.max(0.5, Math.min(2.5, archZoomLevel + direction * 0.25));\n  }\n  const cx = parts[0] + parts[2] / 2;\n  const cy = parts[1] + parts[3] / 2;\n  const newW = parts[2] / archZoomLevel;\n  const newH = parts[3] / archZoomLevel;\n  svg.setAttribute('viewBox',\n    (cx - newW/2).toFixed(0) + ' ' + (cy - newH/2).toFixed(0) + ' ' +\n    newW.toFixed(0) + ' ' + newH.toFixed(0));\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Sticky floating architecture diagram\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlet floatingDismissed = false;\n\n(function initFloatingDiagram() {\n  const archSection = document.getElementById('arch-diagram');\n  const floatingContainer = document.getElementById('arch-floating');\n  const floatingContent = document.getElementById('arch-floating-content');\n  if (!archSection || !floatingContainer) return;\n\n  const svgClone = archSection.cloneNode(true);\n  svgClone.removeAttribute('id');\n  svgClone.style.width = '100%';\n  svgClone.style.maxWidth = 'none';\n  floatingContent.appendChild(svgClone);\n\n  attachZoneClickHandlers(floatingContainer);\n  svgClone.addEventListener('click', (e) => {\n    if (e.target.tagName === 'svg' || (e.target.tagName === 'text' && e.target.classList.contains('arch-row-label'))) {\n      resetZones();\n    }\n  });\n\n  const observer = new IntersectionObserver((entries) => {\n    entries.forEach(entry => {\n      if (floatingDismissed) return;\n      floatingContainer.classList.toggle('visible', !entry.isIntersecting);\n    });\n  }, { threshold: 0.1 });\n  observer.observe(archSection);\n})();\n\nfunction dismissFloatingDiagram() {\n  floatingDismissed = true;\n  document.getElementById('arch-floating').classList.remove('visible');\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Diff data cache\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlet diffDataCache = null;\nlet diffDataLoading = false;\nlet diffDataCallbacks = [];\n\nfunction loadDiffData(cb) {\n  if (diffDataCache) { cb(diffDataCache); return; }\n  diffDataCallbacks.push(cb);\n  if (diffDataLoading) return;\n  diffDataLoading = true;\n  fetch('pr_diff_data.json')\n    .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })\n    .then(data => {\n      diffDataCache = data;\n      diffDataCallbacks.forEach(fn => fn(data));\n      diffDataCallbacks = [];\n    })\n    .catch(err => {\n      diffDataCallbacks.forEach(fn => fn(null, err));\n      diffDataCallbacks = [];\n    })\n    .finally(() => { diffDataLoading = false; });\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// File diff modal\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlet currentFilePath = null;\nlet currentFileData = null;\nlet currentView = 'side-by-side';\n\nfunction openFileModal(path) {\n  currentFilePath = path;\n  const overlay = document.getElementById('file-modal-overlay');\n  const pathEl = document.getElementById('file-modal-path');\n  const statsEl = document.getElementById('file-modal-stats');\n  const link = document.getElementById('file-modal-github-link');\n  const body = document.getElementById('file-modal-body');\n\n  pathEl.textContent = path;\n  // Build GitHub URL from DATA if available\n  const prUrl = (DATA.header && DATA.header.prUrl) || '';\n  const headBranch = (DATA.header && DATA.header.headBranch) || 'main';\n  const repoUrl = prUrl.replace(/\\/pull\\/\\d+$/, '');\n  link.href = repoUrl + '/blob/' + headBranch + '/' + path;\n\n  document.querySelectorAll('.file-modal-tab').forEach(t => t.classList.remove('active'));\n  const activeTab = document.querySelector('.file-modal-tab[data-view=\"' + currentView + '\"]');\n  if (activeTab) activeTab.classList.add('active');\n\n  statsEl.innerHTML = '';\n  body.innerHTML = '<div class=\"diff-loading\">Loading diff data&hellip;</div>';\n  overlay.classList.add('visible');\n  document.body.style.overflow = 'hidden';\n\n  loadDiffData((data, err) => {\n    if (err || !data) {\n      body.innerHTML = '<div class=\"diff-error\">Failed to load diff data.</div>';\n      return;\n    }\n    currentFileData = data.files[path] || null;\n    if (!currentFileData) {\n      // Check for embedded reference file content (spec files, etc.)\n      var refContent = (typeof REFERENCE_FILES !== 'undefined') && REFERENCE_FILES[path];\n      if (refContent) {\n        currentFileData = { raw: refContent, diff: '', additions: 0, deletions: 0 };\n        statsEl.innerHTML = '<span style=\"color:var(--text-secondary);font-size:12px\">' +\n          'Reference file &mdash; not modified in this PR</span>';\n        // Default to raw view for reference files\n        currentView = 'raw';\n        document.querySelectorAll('.file-modal-tab').forEach(function(t) { t.classList.remove('active'); });\n        var rawTab = document.querySelector('.file-modal-tab[data-view=\"raw\"]');\n        if (rawTab) rawTab.classList.add('active');\n        renderDiffView('raw');\n        return;\n      }\n      var ghLink = link.href;\n      body.innerHTML = '<div style=\"text-align:center;padding:40px 20px\">' +\n        '<div style=\"font-size:14px;color:var(--text-secondary);margin-bottom:16px\">' +\n        'This file was not modified in this PR.</div>' +\n        '<a href=\"' + escapeHtml(ghLink) + '\" target=\"_blank\" ' +\n        'style=\"display:inline-block;padding:10px 24px;background:var(--blue);color:white;' +\n        'border-radius:8px;text-decoration:none;font-weight:600;font-size:14px\">' +\n        'View on GitHub &rarr;</a></div>';\n      return;\n    }\n    statsEl.innerHTML = '<span class=\"fm-add\">+' + currentFileData.additions + '</span> <span class=\"fm-del\">-' + currentFileData.deletions + '</span>';\n    renderDiffView(currentView);\n  });\n}\n\nfunction closeFileModal() {\n  document.getElementById('file-modal-overlay').classList.remove('visible');\n  document.body.style.overflow = '';\n  currentFilePath = null;\n  currentFileData = null;\n}\n\nfunction setFileModalTab(btn, view) {\n  document.querySelectorAll('.file-modal-tab').forEach(t => t.classList.remove('active'));\n  btn.classList.add('active');\n  currentView = view;\n  if (currentFileData) renderDiffView(view);\n}\n\nfunction escapeHtml(s) {\n  const div = document.createElement('div');\n  div.textContent = s;\n  return div.innerHTML;\n}\n\nfunction renderDiffView(view) {\n  const body = document.getElementById('file-modal-body');\n  if (!currentFileData) return;\n  if (view === 'raw') renderRawView(body);\n  else if (view === 'integrated') renderUnifiedView(body);\n  else renderSplitView(body);\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Syntax highlighting (lightweight, no deps)\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction detectLanguage(filePath) {\n  if (!filePath) return 'text';\n  const ext = filePath.split('.').pop().toLowerCase();\n  const map = {\n    'py': 'python', 'yaml': 'yaml', 'yml': 'yaml', 'md': 'markdown',\n    'sh': 'shell', 'bash': 'shell', 'js': 'javascript', 'ts': 'javascript',\n    'jsx': 'javascript', 'tsx': 'javascript',\n  };\n  return map[ext] || 'text';\n}\n\nfunction highlightCode(text, language) {\n  if (language === 'text') return text;\n\n  if (language === 'python') {\n    text = text.replace(/(&#39;&#39;&#39;[\\s\\S]*?&#39;&#39;&#39;|&quot;&quot;&quot;[\\s\\S]*?&quot;&quot;&quot;)/g, '<span style=\"color:#ce9178\">$1</span>');\n    text = text.replace(/((?<!\\\\)&#39;(?:[^\\\\]|\\\\.)*?&#39;|(?<!\\\\)&quot;(?:[^\\\\]|\\\\.)*?&quot;)/g, function(m) {\n      if (m.indexOf('style=') !== -1) return m;\n      return '<span style=\"color:#ce9178\">' + m + '</span>';\n    });\n    text = text.replace(/(#[^\\n]*)/g, function(m) {\n      if (m.indexOf('style=') !== -1) return m;\n      return '<span style=\"color:#6a9955\">' + m + '</span>';\n    });\n    text = text.replace(/(@\\w+)/g, '<span style=\"color:#dcdcaa\">$1</span>');\n    text = text.replace(/\\b(True|False|None)\\b/g, '<span style=\"color:#569cd6\">$1</span>');\n    text = text.replace(/\\b(def|class|import|from|if|else|elif|for|while|return|yield|with|as|try|except|finally|raise|not|and|or|in|is|pass|break|continue|lambda|global|nonlocal|async|await|self)\\b/g, function(m) {\n      return '<span style=\"color:#c586c0\">' + m + '</span>';\n    });\n    text = text.replace(/\\b(\\d+\\.?\\d*(?:e[+-]?\\d+)?)\\b/g, '<span style=\"color:#b5cea8\">$1</span>');\n    return text;\n  }\n\n  if (language === 'yaml') {\n    text = text.replace(/(#[^\\n]*)/g, '<span style=\"color:#6a9955\">$1</span>');\n    text = text.replace(/\\b(true|false|yes|no|on|off)\\b/gi, '<span style=\"color:#569cd6\">$1</span>');\n    text = text.replace(/^(\\s*)([\\w][\\w.-]*?)(:)/gm, '$1<span style=\"color:#9cdcfe\">$2</span>$3');\n    text = text.replace(/(&#39;[^]*?&#39;|&quot;[^]*?&quot;)/g, function(m) {\n      if (m.indexOf('style=') !== -1) return m;\n      return '<span style=\"color:#ce9178\">' + m + '</span>';\n    });\n    return text;\n  }\n\n  if (language === 'markdown') {\n    text = text.replace(/^(#{1,6}\\s.*)$/gm, '<span style=\"color:#569cd6\">$1</span>');\n    text = text.replace(/(\\*\\*[^*]+\\*\\*)/g, '<span style=\"color:#dcdcaa;font-weight:bold\">$1</span>');\n    text = text.replace(/(`[^`]+`)/g, '<span style=\"color:#ce9178\">$1</span>');\n    return text;\n  }\n\n  if (language === 'shell') {\n    text = text.replace(/(#[^\\n]*)/g, '<span style=\"color:#6a9955\">$1</span>');\n    text = text.replace(/(&#39;[^]*?&#39;|&quot;[^]*?&quot;)/g, function(m) {\n      if (m.indexOf('style=') !== -1) return m;\n      return '<span style=\"color:#ce9178\">' + m + '</span>';\n    });\n    text = text.replace(/(\\$\\{?\\w+\\}?)/g, '<span style=\"color:#9cdcfe\">$1</span>');\n    text = text.replace(/\\b(if|then|else|elif|fi|for|do|done|while|case|esac|echo|export|set|source|local|readonly|declare|unset|shift|eval|exec|trap|exit|return|function)\\b/g, '<span style=\"color:#c586c0\">$1</span>');\n    return text;\n  }\n\n  if (language === 'javascript') {\n    text = text.replace(/(&#39;[^]*?&#39;|&quot;[^]*?&quot;|`[^]*?`)/g, function(m) {\n      if (m.indexOf('style=') !== -1) return m;\n      return '<span style=\"color:#ce9178\">' + m + '</span>';\n    });\n    text = text.replace(/(\\/\\/[^\\n]*)/g, function(m) {\n      if (m.indexOf('style=') !== -1) return m;\n      return '<span style=\"color:#6a9955\">' + m + '</span>';\n    });\n    text = text.replace(/\\b(true|false|null|undefined|NaN|Infinity)\\b/g, '<span style=\"color:#569cd6\">$1</span>');\n    text = text.replace(/\\b(const|let|var|function|class|if|else|for|while|do|switch|case|break|continue|return|import|export|from|default|new|this|typeof|instanceof|in|of|try|catch|finally|throw|async|await|yield)\\b/g, '<span style=\"color:#c586c0\">$1</span>');\n    return text;\n  }\n\n  return text;\n}\n\n// \u2500\u2500 Raw file view \u2500\u2500\nfunction renderRawView(container) {\n  const raw = currentFileData.raw || '';\n  if (!raw) {\n    container.innerHTML = '<div class=\"diff-error\">File was deleted or is binary.</div>';\n    return;\n  }\n  const lang = detectLanguage(currentFilePath);\n  const lines = raw.split('\\n');\n  let html = '<div class=\"diff-view diff-raw\"><table>';\n  for (let i = 0; i < lines.length; i++) {\n    const escaped = escapeHtml(lines[i]);\n    const highlighted = highlightCode(escaped, lang);\n    html += '<tr><td class=\"diff-ln\">' + (i + 1) + '</td><td>' + highlighted + '</td></tr>';\n  }\n  html += '</table></div>';\n  container.innerHTML = html;\n}\n\n// \u2500\u2500 Unified (integrated) diff view \u2500\u2500\nfunction renderUnifiedView(container) {\n  const diff = currentFileData.diff || '';\n  if (!diff) { container.innerHTML = '<div class=\"diff-error\">No diff available.</div>'; return; }\n  const lines = diff.split('\\n');\n  let html = '<div class=\"diff-view\"><table class=\"diff-unified\">';\n  let oldLn = 0, newLn = 0;\n\n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i];\n    if (line.startsWith('diff --git') || line.startsWith('index ') || line.startsWith('---') || line.startsWith('+++')) continue;\n    if (isDiffMetaLine(line)) continue;\n    if (line.startsWith('@@')) {\n      const m = line.match(/@@ -(\\d+)(?:,\\d+)? \\+(\\d+)(?:,\\d+)? @@(.*)/);\n      if (m) { oldLn = parseInt(m[1]); newLn = parseInt(m[2]); html += '<tr><td class=\"diff-ln\" colspan=\"2\"></td><td class=\"diff-hunk\">' + escapeHtml(line) + '</td></tr>'; }\n      continue;\n    }\n    if (line.startsWith('+')) { html += '<tr class=\"diff-add\"><td class=\"diff-ln\"></td><td class=\"diff-ln\">' + newLn + '</td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; newLn++; continue; }\n    if (line.startsWith('-')) { html += '<tr class=\"diff-del\"><td class=\"diff-ln\">' + oldLn + '</td><td class=\"diff-ln\"></td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; oldLn++; continue; }\n    if (line.startsWith(' ') || line === '') { html += '<tr class=\"diff-ctx\"><td class=\"diff-ln\">' + oldLn + '</td><td class=\"diff-ln\">' + newLn + '</td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; oldLn++; newLn++; }\n  }\n  html += '</table></div>';\n  container.innerHTML = html;\n}\n\nconst DIFF_SKIP_PATTERNS = [/^new file mode/, /^deleted file mode/, /^old mode/, /^new mode/, /^similarity index/, /^rename from/, /^rename to/, /^Binary files/];\nfunction isDiffMetaLine(line) { return DIFF_SKIP_PATTERNS.some(p => p.test(line)); }\n\n// \u2500\u2500 Side-by-side diff view \u2500\u2500\nfunction renderSplitView(container) {\n  const diff = currentFileData.diff || '';\n  if (!diff) { container.innerHTML = '<div class=\"diff-error\">No diff available.</div>'; return; }\n\n  const isNewFile = currentFileData.status === 'added' || (currentFileData.deletions === 0 && currentFileData.additions > 0);\n  const isDeletedFile = currentFileData.status === 'deleted' || (currentFileData.additions === 0 && currentFileData.deletions > 0);\n\n  if (isNewFile || isDeletedFile) {\n    const bannerClass = isNewFile ? 'diff-new-file-banner' : 'diff-deleted-file-banner';\n    const bannerText = isNewFile ? 'New file &mdash; showing additions' : 'Deleted file &mdash; showing deletions';\n    const lines = diff.split('\\n');\n    let html = '<div class=\"' + bannerClass + '\">' + bannerText + '</div><div class=\"diff-view diff-split-wrapper\"><table class=\"diff-unified\">';\n    let ln = 0;\n    for (let i = 0; i < lines.length; i++) {\n      const line = lines[i];\n      if (line.startsWith('diff --git') || line.startsWith('index ') || line.startsWith('---') || line.startsWith('+++')) continue;\n      if (isDiffMetaLine(line)) continue;\n      if (line.startsWith('@@')) { const m = line.match(/@@ -(\\d+)(?:,\\d+)? \\+(\\d+)(?:,\\d+)? @@(.*)/); if (m) { ln = isNewFile ? parseInt(m[2]) : parseInt(m[1]); html += '<tr><td class=\"diff-ln\"></td><td class=\"diff-hunk\">' + escapeHtml(line) + '</td></tr>'; } continue; }\n      if (isNewFile && line.startsWith('+')) { html += '<tr class=\"diff-add\"><td class=\"diff-ln\">' + ln + '</td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; ln++; }\n      else if (isDeletedFile && line.startsWith('-')) { html += '<tr class=\"diff-del\"><td class=\"diff-ln\">' + ln + '</td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; ln++; }\n      else if (line.startsWith(' ') || line === '') { html += '<tr class=\"diff-ctx\"><td class=\"diff-ln\">' + ln + '</td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; ln++; }\n    }\n    html += '</table></div>';\n    container.innerHTML = html;\n    return;\n  }\n\n  // Parse unified diff into side-by-side pairs\n  const lines = diff.split('\\n');\n  const pairs = [];\n  let oldLn = 0, newLn = 0;\n  const addBuffer = [], delBuffer = [];\n\n  function flushBuffers() {\n    const max = Math.max(addBuffer.length, delBuffer.length);\n    for (let j = 0; j < max; j++) {\n      const hasOld = j < delBuffer.length, hasNew = j < addBuffer.length;\n      pairs.push({ type: hasOld && hasNew ? 'change' : hasNew ? 'add' : 'del', oldLn: hasOld ? delBuffer[j].ln : null, newLn: hasNew ? addBuffer[j].ln : null, oldText: hasOld ? delBuffer[j].text : '', newText: hasNew ? addBuffer[j].text : '' });\n    }\n    addBuffer.length = 0; delBuffer.length = 0;\n  }\n\n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i];\n    if (line.startsWith('diff --git') || line.startsWith('index ') || line.startsWith('---') || line.startsWith('+++')) continue;\n    if (isDiffMetaLine(line)) continue;\n    if (line.startsWith('@@')) { flushBuffers(); const m = line.match(/@@ -(\\d+)(?:,\\d+)? \\+(\\d+)(?:,\\d+)? @@(.*)/); if (m) { oldLn = parseInt(m[1]); newLn = parseInt(m[2]); pairs.push({ type: 'hunk', hunkText: line }); } continue; }\n    if (line.startsWith('+')) { addBuffer.push({ ln: newLn, text: line.slice(1) }); newLn++; }\n    else if (line.startsWith('-')) { delBuffer.push({ ln: oldLn, text: line.slice(1) }); oldLn++; }\n    else { flushBuffers(); pairs.push({ type: 'ctx', oldLn: oldLn, newLn: newLn, oldText: line.slice(1), newText: line.slice(1) }); oldLn++; newLn++; }\n  }\n  flushBuffers();\n\n  let html = '<div class=\"diff-view diff-split-wrapper\"><table class=\"diff-split\">';\n  for (const p of pairs) {\n    if (p.type === 'hunk') { html += '<tr class=\"diff-hunk\"><td colspan=\"5\" style=\"padding:4px 8px;background:rgba(56,139,253,0.08);color:#58a6ff;font-style:italic;font-size:11px\">' + escapeHtml(p.hunkText) + '</td></tr>'; continue; }\n    const leftCls = p.type === 'del' || p.type === 'change' ? ' diff-del' : p.type === 'add' ? ' diff-empty' : ' diff-ctx';\n    const rightCls = p.type === 'add' || p.type === 'change' ? ' diff-add' : p.type === 'del' ? ' diff-empty' : ' diff-ctx';\n    html += '<tr><td class=\"diff-ln' + leftCls + '\">' + (p.oldLn != null ? p.oldLn : '') + '</td><td class=\"diff-code-left' + leftCls + '\">' + (p.type === 'add' ? '' : escapeHtml(p.oldText)) + '</td><td class=\"diff-sep\"></td><td class=\"diff-ln' + rightCls + '\">' + (p.newLn != null ? p.newLn : '') + '</td><td class=\"diff-code-right' + rightCls + '\">' + (p.type === 'del' ? '' : escapeHtml(p.newText)) + '</td></tr>';\n  }\n  html += '</table></div>';\n  container.innerHTML = html;\n}\n\n// Close modal on Escape\ndocument.addEventListener('keydown', (e) => {\n  if (e.key === 'Escape') { closeFileModal(); hideGatePopover(); }\n});\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Gate findings popover\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction showGatePopover(event, text) {\n  event.stopPropagation();\n  const popover = document.getElementById('gate-popover');\n  popover.textContent = '';\n  const lines = text.split('\\\\n');\n  lines.forEach((line, i) => {\n    popover.appendChild(document.createTextNode(line));\n    if (i < lines.length - 1) popover.appendChild(document.createElement('br'));\n  });\n  const rect = event.target.getBoundingClientRect();\n  popover.style.left = rect.left + 'px';\n  popover.style.top = (rect.bottom + 6) + 'px';\n  popover.classList.add('visible');\n  setTimeout(() => { hideGatePopover(); }, 5000);\n}\n\nfunction hideGatePopover() {\n  document.getElementById('gate-popover').classList.remove('visible');\n}\n\ndocument.addEventListener('click', (e) => {\n  if (!e.target.classList.contains('gate-clickable')) hideGatePopover();\n});\n</script>\n</body>\n</html>\n",
      "base": "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<title><!-- INJECT: header.title --></title>\n<style>\n  :root {\n    --green: #22c55e; --green-bg: #f0fdf4; --green-border: #86efac;\n    --yellow: #eab308; --yellow-bg: #fefce8;\n    --orange: #f97316; --orange-bg: #fff7ed;\n    --red: #ef4444; --red-bg: #fef2f2;\n    --gray: #6b7280; --gray-bg: #f9fafb; --gray-border: #e5e7eb;\n    --blue: #3b82f6; --blue-bg: #eff6ff;\n    --purple: #8b5cf6; --purple-bg: #f5f3ff;\n    --text: #1f2937; --text-secondary: #6b7280; --text-muted: #9ca3af;\n    --border: #e5e7eb; --bg: #f3f4f6;\n    --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;\n  }\n  /* \u2500\u2500 Dark theme overrides \u2500\u2500 */\n  [data-theme=\"dark\"] {\n    --text: #e5e7eb; --text-secondary: #9ca3af; --text-muted: #6b7280;\n    --border: #374151; --bg: #111827;\n    --gray-bg: #1f2937; --gray-border: #374151; --gray: #9ca3af;\n    --green-bg: #064e3b; --green-border: #10b981;\n    --yellow-bg: #713f12; --red-bg: #7f1d1d; --orange-bg: #7c2d12;\n    --blue-bg: #1e3a5f; --purple-bg: #2e1065;\n  }\n  [data-theme=\"dark\"] .header,\n  [data-theme=\"dark\"] .section,\n  [data-theme=\"dark\"] .gate,\n  [data-theme=\"dark\"] .tab-panel,\n  [data-theme=\"dark\"] .tab-bar { background: #1f2937; }\n  [data-theme=\"dark\"] .tab-btn { color: #9ca3af; }\n  [data-theme=\"dark\"] .tab-btn:hover { background: #374151; }\n  [data-theme=\"dark\"] .tab-btn.active { color: #60a5fa; background: #1f2937; }\n  [data-theme=\"dark\"] th { background: #1f2937; color: #9ca3af; }\n  [data-theme=\"dark\"] tr:nth-child(even) td { background: rgba(255,255,255,0.02); }\n  [data-theme=\"dark\"] tr.expandable:hover,\n  [data-theme=\"dark\"] .section-header:hover,\n  [data-theme=\"dark\"] .decision-header:hover,\n  [data-theme=\"dark\"] .pm-header:hover,\n  [data-theme=\"dark\"] .scenario-card:hover { background: #374151; }\n  [data-theme=\"dark\"] .history-event { background: #1f2937; border-color: #374151; }\n  [data-theme=\"dark\"] tr.detail-row td,\n  [data-theme=\"dark\"] .adv-detail-row td { background: #1a2332; }\n  [data-theme=\"dark\"] .arch-legend { background: #1f2937; }\n  [data-theme=\"dark\"] .conv-card { border-color: #374151; }\n  [data-theme=\"dark\"] .decision-card { border-color: #374151; }\n  [data-theme=\"dark\"] .pm-item { border-color: #374151; }\n  [data-theme=\"dark\"] .scenario-card { border-color: #374151; }\n  [data-theme=\"dark\"] .arch-floating { background: rgba(31,41,55,0.95); }\n  [data-theme=\"dark\"] .code-block { background: #0f172a; }\n  [data-theme=\"dark\"] .gate-popover { background: #1f2937; border-color: #374151; }\n  [data-theme=\"dark\"] .badge.pass { background: #064e3b; color: #34d399; }\n  [data-theme=\"dark\"] .badge.fail { background: #7f1d1d; color: #fca5a5; }\n  [data-theme=\"dark\"] .health-tag.normal { background: #064e3b; color: #34d399; }\n  [data-theme=\"dark\"] .health-tag.acceptable { background: #713f12; color: #fde047; }\n  [data-theme=\"dark\"] .health-tag.watch { background: #7c2d12; color: #fdba74; }\n  [data-theme=\"dark\"] .health-tag.refactor { background: #7f1d1d; color: #fca5a5; }\n  [data-theme=\"dark\"] .grade.a { background: #064e3b; color: #34d399; }\n  [data-theme=\"dark\"] .grade.b { background: #713f12; color: #fde047; }\n  [data-theme=\"dark\"] .grade.c { background: #7c2d12; color: #fdba74; }\n  [data-theme=\"dark\"] .grade.f { background: #7f1d1d; color: #fca5a5; }\n  [data-theme=\"dark\"] .grade.na { background: #374151; color: #9ca3af; }\n  [data-theme=\"dark\"] .priority.low { background: #1e3a5f; color: #93c5fd; }\n  [data-theme=\"dark\"] .priority.medium { background: #713f12; color: #fde047; }\n  [data-theme=\"dark\"] .priority.cosmetic { background: #374151; color: #9ca3af; }\n  [data-theme=\"dark\"] .status-badge.pass { background: #064e3b; color: #34d399; }\n  [data-theme=\"dark\"] .status-badge.info { background: #1e3a5f; color: #93c5fd; }\n  [data-theme=\"dark\"] .status-badge.warn { background: #713f12; color: #fde047; }\n  [data-theme=\"dark\"] .status-badge.fail { background: #7f1d1d; color: #fca5a5; }\n  [data-theme=\"dark\"] .zone-tag { background: #1e3a5f; color: #93c5fd; }\n  [data-theme=\"dark\"] .zone-tag.factory { background: #1e3a5f; color: #93c5fd; }\n  [data-theme=\"dark\"] .zone-tag.product { background: #064e3b; color: #6ee7b7; }\n  [data-theme=\"dark\"] .zone-tag.infra { background: #2e1065; color: #c4b5fd; }\n  [data-theme=\"dark\"] .scenario-box.failure { background: #3b1111; border-left-color: #ef4444; }\n  [data-theme=\"dark\"] .scenario-box.success { background: #052e16; border-left-color: #22c55e; }\n  [data-theme=\"dark\"] .ci-check-item:hover { background: #374151; }\n  [data-theme=\"dark\"] .conv-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.3); }\n  [data-theme=\"dark\"] .history-event:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.25); }\n  [data-theme=\"dark\"] .file-path-link { border-bottom-color: #6b7280; }\n  [data-theme=\"dark\"] .file-path-link:hover { border-bottom-color: #60a5fa; color: #60a5fa; }\n  [data-theme=\"dark\"] .stat { background: #1f2937; }\n  [data-theme=\"dark\"] .stat.green { background: #064e3b; color: #34d399; }\n  [data-theme=\"dark\"] .stat.red { background: #7f1d1d; color: #fca5a5; }\n  [data-theme=\"dark\"] #arch-diagram { background: #1a2332; border-color: #374151; }\n  [data-theme=\"dark\"] .history-timeline::before { background: #374151; }\n  [data-theme=\"dark\"] .history-legend { background: #1f2937; }\n  [data-theme=\"dark\"] .conv-card-detail { border-top-color: #374151; }\n\n  /* \u2500\u2500 Light theme diff modal overrides \u2500\u2500 */\n  :root:not([data-theme=\"dark\"]) .file-modal { background: #ffffff; }\n  :root:not([data-theme=\"dark\"]) .file-modal-header { background: #f5f5f5; border-bottom-color: #e0e0e0; }\n  :root:not([data-theme=\"dark\"]) .file-modal-header h3 { color: #333333; }\n  :root:not([data-theme=\"dark\"]) .file-modal-toolbar { background: #fafafa; border-bottom-color: #e0e0e0; }\n  :root:not([data-theme=\"dark\"]) .file-modal-tab { color: #666666; }\n  :root:not([data-theme=\"dark\"]) .file-modal-tab:hover { color: #333333; background: #f0f0f0; }\n  :root:not([data-theme=\"dark\"]) .file-modal-tab.active { color: #1d4ed8; background: #ffffff; border-bottom-color: var(--blue); }\n  :root:not([data-theme=\"dark\"]) .file-modal-body { background: #ffffff; }\n  :root:not([data-theme=\"dark\"]) .file-modal-close { color: #999999; }\n  :root:not([data-theme=\"dark\"]) .file-modal-close:hover { background: #e0e0e0; color: #333333; }\n  :root:not([data-theme=\"dark\"]) .file-modal-github { background: #f0f0f0; border-color: #e0e0e0; color: #333333; }\n  :root:not([data-theme=\"dark\"]) .file-modal-github:hover { background: #e0e0e0; color: #111111; }\n  :root:not([data-theme=\"dark\"]) .fm-stats .fm-add { color: #166534; }\n  :root:not([data-theme=\"dark\"]) .fm-stats .fm-del { color: #991b1b; }\n  :root:not([data-theme=\"dark\"]) .diff-unified .diff-add { background: rgba(34,197,94,0.12); color: #166534; }\n  :root:not([data-theme=\"dark\"]) .diff-unified .diff-del { background: rgba(239,68,68,0.12); color: #991b1b; }\n  :root:not([data-theme=\"dark\"]) .diff-unified .diff-ctx { color: #333333; }\n  :root:not([data-theme=\"dark\"]) .diff-unified .diff-hunk { background: rgba(59,130,246,0.08); color: #2563eb; }\n  :root:not([data-theme=\"dark\"]) .diff-unified .diff-ln { color: #999999; border-right-color: #e0e0e0; }\n  :root:not([data-theme=\"dark\"]) .diff-split .diff-add { background: rgba(34,197,94,0.12); color: #166534; }\n  :root:not([data-theme=\"dark\"]) .diff-split .diff-del { background: rgba(239,68,68,0.12); color: #991b1b; }\n  :root:not([data-theme=\"dark\"]) .diff-split .diff-ctx { color: #333333; }\n  :root:not([data-theme=\"dark\"]) .diff-split .diff-empty { background: #f9f9f9; }\n  :root:not([data-theme=\"dark\"]) .diff-split .diff-ln { color: #999999; }\n  :root:not([data-theme=\"dark\"]) .diff-split .diff-sep { background: #e0e0e0; }\n  :root:not([data-theme=\"dark\"]) .diff-split .diff-hunk td { background: rgba(59,130,246,0.06); color: #2563eb; }\n  :root:not([data-theme=\"dark\"]) .diff-raw td { color: #333333; }\n  :root:not([data-theme=\"dark\"]) .diff-raw .diff-ln { color: #999999; border-right-color: #e0e0e0; }\n  :root:not([data-theme=\"dark\"]) .diff-new-file-banner { background: rgba(34,197,94,0.08); color: #166534; border-bottom-color: #e0e0e0; }\n  :root:not([data-theme=\"dark\"]) .diff-deleted-file-banner { background: rgba(239,68,68,0.08); color: #991b1b; border-bottom-color: #e0e0e0; }\n  :root:not([data-theme=\"dark\"]) .diff-loading { color: #999999; }\n  :root:not([data-theme=\"dark\"]) .diff-error { color: #991b1b; }\n\n  /* \u2500\u2500 Theme toggle \u2500\u2500 */\n  .theme-toggle { display: inline-flex; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-left: 12px; vertical-align: middle; }\n  .theme-toggle button { border: none; background: transparent; padding: 4px 10px; font-size: 14px; cursor: pointer; color: var(--text-secondary); transition: background 0.15s, color 0.15s; line-height: 1; }\n  .theme-toggle button:hover { background: var(--gray-bg); }\n  .theme-toggle button.active { background: var(--blue); color: white; }\n  .theme-toggle button:not(:last-child) { border-right: 1px solid var(--border); }\n\n  * { box-sizing: border-box; margin: 0; padding: 0; }\n  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: var(--text); background: var(--bg); line-height: 1.5; font-size: 14px; }\n  .container { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }\n\n  /* \u2500\u2500 Tabs \u2500\u2500 */\n  .tab-bar { display: flex; gap: 0; background: white; border-radius: 12px 12px 0 0; border: 1px solid var(--border); border-bottom: none; overflow: hidden; }\n  .tab-btn { padding: 12px 24px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; background: transparent; color: var(--text-secondary); border-bottom: 2px solid transparent; transition: all 0.15s; }\n  .tab-btn:hover { background: var(--gray-bg); }\n  .tab-btn.active { color: var(--blue); border-bottom-color: var(--blue); background: white; }\n  .tab-content { display: none; }\n  .tab-content.active { display: block; }\n  .tab-panel { background: white; border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; margin-bottom: 16px; }\n\n  /* \u2500\u2500 Header \u2500\u2500 */\n  .header { background: white; border-radius: 12px; padding: 24px; margin-bottom: 16px; border: 1px solid var(--border); }\n  .header h1 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }\n  .header .meta { font-size: 13px; color: var(--text-secondary); font-family: var(--mono); }\n  .header .meta a { color: var(--blue); text-decoration: none; }\n  .stats { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }\n  .stat { background: var(--gray-bg); border-radius: 8px; padding: 6px 14px; font-size: 13px; font-weight: 500; }\n  .stat .num { font-weight: 700; font-size: 15px; }\n  .stat.green { background: var(--green-bg); color: #166534; }\n  .stat.red { background: #fef2f2; color: #991b1b; }\n\n  /* \u2500\u2500 Gate (removed \u2014 readiness info lives in status badges) \u2500\u2500 */\n  .gate .check-row { display: flex; justify-content: space-between; align-items: center; padding: 7px 0; border-bottom: 1px solid var(--border); font-size: 13px; }\n  .gate .check-row:last-child { border-bottom: none; }\n  .badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }\n  .badge.pass { background: var(--green-bg); color: #166534; }\n  .badge.fail { background: var(--red-bg); color: #991b1b; }\n\n  /* \u2500\u2500 Sections \u2500\u2500 */\n  .section { background: white; border-radius: 12px; margin-bottom: 16px; border: 1px solid var(--border); overflow: hidden; }\n  .section-header { padding: 14px 24px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; transition: background 0.15s; }\n  .section-header:hover { background: var(--gray-bg); }\n  .section-header h2 { font-size: 14px; font-weight: 700; }\n  .section-header .chevron { font-size: 16px; color: var(--text-secondary); transition: transform 0.2s; }\n  .section.collapsed .section-body { display: none; }\n  .section.collapsed .chevron { transform: rotate(-90deg); }\n  .section-body { padding: 0 24px 20px; font-size: 13px; }\n\n  /* \u2500\u2500 Architecture Diagram \u2500\u2500 */\n  .arch-controls { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }\n  .arch-toggle { padding: 5px 14px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid var(--border); background: white; color: var(--text-secondary); }\n  .arch-toggle.active { background: var(--blue); color: white; border-color: var(--blue); }\n  .arch-hint { font-size: 11px; color: var(--text-muted); margin-left: 8px; }\n  .zone-box { cursor: pointer; transition: opacity 0.3s, filter 0.3s; }\n  .zone-box:hover { filter: brightness(0.95); }\n  .zone-box.dimmed { opacity: 0.12; }\n  .zone-box.highlighted { stroke-width: 3; filter: brightness(0.92); }\n  .zone-label { font-size: 11px; font-weight: 600; pointer-events: none; }\n  .zone-sublabel { font-size: 9px; fill: #6b7280; pointer-events: none; }\n  .zone-file-count { font-size: 10px; font-weight: 700; fill: white; pointer-events: none; }\n  .zone-count-bg { pointer-events: none; }\n  .arch-row-label { font-size: 10px; font-weight: 700; fill: #9ca3af; text-transform: uppercase; letter-spacing: 1px; }\n\n  /* \u2500\u2500 Tables \u2500\u2500 */\n  table { width: 100%; border-collapse: collapse; font-size: 13px; }\n  th { text-align: left; padding: 8px 12px; background: var(--gray-bg); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-secondary); border-bottom: 2px solid var(--border); }\n  td { padding: 8px 12px; border-bottom: 1px solid var(--border); vertical-align: top; }\n  tr:last-child td { border-bottom: none; }\n  tr.expandable { cursor: pointer; }\n  tr.expandable:hover { background: var(--gray-bg); }\n  tr.detail-row { display: none; }\n  tr.detail-row.open { display: table-row; }\n  tr.detail-row td { background: #fafbfc; padding: 12px 20px; }\n\n  /* \u2500\u2500 Grade pills \u2500\u2500 */\n  .grade { display: inline-block; width: 28px; height: 28px; line-height: 28px; text-align: center; border-radius: 6px; font-weight: 700; font-size: 12px; }\n  .grade.a { background: var(--green-bg); color: #166534; }\n  .grade.b { background: var(--yellow-bg); color: #854d0e; }\n  .grade.c { background: var(--orange-bg); color: #9a3412; }\n  .grade.f { background: var(--red-bg); color: #991b1b; }\n  .grade.na { background: var(--gray-bg); color: var(--gray); }\n\n  /* \u2500\u2500 Timing \u2500\u2500 */\n  .time-label { font-family: var(--mono); font-size: 15px; font-weight: 700; }\n  .time-label.normal { color: #166534; }\n  .time-label.acceptable { color: #854d0e; }\n  .time-label.watch { color: #f97316; }\n  .time-label.refactor { color: #ef4444; }\n  [data-theme=\"dark\"] .time-label.normal { color: #34d399; }\n  [data-theme=\"dark\"] .time-label.acceptable { color: #fde047; }\n  [data-theme=\"dark\"] .time-label.watch { color: #fdba74; }\n  [data-theme=\"dark\"] .time-label.refactor { color: #fca5a5; }\n  .time-health-sub { font-size: 10px; font-weight: 500; color: var(--text-muted); margin-top: 1px; }\n  .health-tag { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; padding: 2px 8px; border-radius: 4px; }\n  .health-tag.normal { background: var(--green-bg); color: #166534; }\n  .health-tag.acceptable { background: var(--yellow-bg); color: #854d0e; }\n  .health-tag.watch { background: var(--orange-bg); color: #9a3412; }\n  .health-tag.refactor { background: var(--red-bg); color: #991b1b; }\n\n  /* \u2500\u2500 Decision cards \u2500\u2500 */\n  .decision-card { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; overflow: hidden; }\n  .decision-header { padding: 12px 16px; cursor: pointer; display: flex; gap: 12px; align-items: flex-start; transition: background 0.15s; }\n  .decision-header:hover { background: var(--gray-bg); }\n  .decision-num { font-weight: 700; color: var(--blue); font-size: 14px; min-width: 24px; }\n  .decision-title { font-weight: 600; font-size: 13px; }\n  .decision-rationale { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }\n  .decision-body { display: none; padding: 0 16px 16px; border-top: 1px solid var(--border); }\n  .decision-card.open .decision-body { display: block; }\n  .decision-zones { display: flex; gap: 6px; flex-wrap: wrap; margin: 10px 0; }\n  .zone-tag { font-size: 11px; padding: 2px 8px; border-radius: 4px; font-weight: 600; background: var(--blue-bg); color: #1d4ed8; }\n  .decision-files { margin-top: 10px; }\n  .decision-files table { font-size: 12px; }\n  .decision-files td { padding: 4px 8px; }\n\n  /* \u2500\u2500 Convergence \u2500\u2500 */\n  .convergence-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }\n  .conv-card { border: 1px solid var(--border); border-radius: 8px; padding: 14px; cursor: pointer; transition: box-shadow 0.2s; }\n  .conv-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }\n  .conv-card h4 { font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-secondary); margin-bottom: 8px; }\n  .conv-status { font-size: 20px; font-weight: 700; }\n  .conv-status.passing { color: #166534; }\n  .conv-status.warning { color: #854d0e; }\n  .conv-status.failing { color: #991b1b; }\n  .conv-detail { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }\n  .conv-card-detail { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary); }\n  .conv-card.open .conv-card-detail { display: block; }\n  .conv-card-detail ul { margin: 4px 0 0 16px; list-style: disc; }\n  .conv-card-detail li { margin-bottom: 2px; }\n\n  /* \u2500\u2500 Post-merge \u2500\u2500 */\n  .pm-item { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; overflow: hidden; }\n  .pm-header { padding: 10px 16px; cursor: pointer; display: flex; gap: 10px; align-items: center; transition: background 0.15s; }\n  .pm-header:hover { background: var(--gray-bg); }\n  .pm-body { display: none; padding: 0 16px 16px; border-top: 1px solid var(--border); }\n  .pm-item.open .pm-body { display: block; }\n  .priority { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 4px; white-space: nowrap; }\n  .priority.low { background: var(--blue-bg); color: #1d4ed8; }\n  .priority.medium { background: var(--yellow-bg); color: #854d0e; }\n  .priority.cosmetic { background: var(--gray-bg); color: var(--gray); }\n  .code-block { background: #1e293b; color: #e2e8f0; padding: 12px 16px; border-radius: 6px; font-family: var(--mono); font-size: 12px; line-height: 1.6; overflow-x: auto; margin: 8px 0; white-space: pre; }\n  .scenario-box { padding: 10px 14px; border-radius: 6px; margin: 6px 0; font-size: 12px; }\n  .scenario-box.failure { background: var(--red-bg); border-left: 3px solid var(--red); }\n  .scenario-box.success { background: var(--green-bg); border-left: 3px solid var(--green); }\n  .scenario-label { font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px; }\n\n  /* \u2500\u2500 Spec & Scenarios \u2500\u2500 */\n  .spec-list { list-style: none; padding: 0; }\n  .spec-list li { padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px; display: flex; gap: 8px; align-items: center; }\n  .spec-list li:last-child { border-bottom: none; }\n  .scenario-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }\n  .scenario-card { border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; font-size: 12px; cursor: pointer; transition: background 0.15s; }\n  .scenario-card:hover { background: var(--gray-bg); }\n  .scenario-card .name { font-weight: 600; }\n  .scenario-card .status { font-size: 11px; margin-top: 2px; }\n  .scenario-card-detail { display: none; margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border); font-size: 11px; color: var(--text-secondary); }\n  .scenario-card.open .scenario-card-detail { display: block; }\n  .scenario-card-detail dt { font-weight: 600; color: var(--text); margin-top: 4px; }\n  .scenario-card-detail dd { margin-left: 0; margin-bottom: 2px; }\n  .scenario-category { display: inline-block; padding: 1px 7px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-left: 6px; }\n  .scenario-category.cat-environment { background: #dcfce7; color: #166534; }\n  .scenario-category.cat-training { background: #dbeafe; color: #1d4ed8; }\n  .scenario-category.cat-pipeline { background: #f3e8ff; color: #6d28d9; }\n  .scenario-category.cat-integration { background: #fff7ed; color: #9a3412; }\n  [data-theme=\"dark\"] .scenario-category.cat-environment { background: #064e3b; color: #6ee7b7; }\n  [data-theme=\"dark\"] .scenario-category.cat-training { background: #1e3a5f; color: #93c5fd; }\n  [data-theme=\"dark\"] .scenario-category.cat-pipeline { background: #2e1065; color: #c4b5fd; }\n  [data-theme=\"dark\"] .scenario-category.cat-integration { background: #7c2d12; color: #fdba74; }\n  .scenario-legend { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 10px; font-size: 11px; color: var(--text-secondary); }\n  .scenario-card.zone-dimmed { opacity: 0.35; }\n  .scenario-card.zone-glow { box-shadow: 0 0 0 2px var(--blue); }\n\n  /* \u2500\u2500 Factory History \u2500\u2500 */\n  .history-timeline { position: relative; padding-left: 24px; }\n  .history-timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: var(--border); }\n  .history-event { position: relative; margin-bottom: 16px; padding: 12px 16px; background: white; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: box-shadow 0.2s; }\n  .history-event:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }\n  .history-event::before { content: ''; position: absolute; left: -20px; top: 16px; width: 10px; height: 10px; border-radius: 50%; background: var(--blue); border: 2px solid white; }\n  .history-event.intervention::before { background: var(--orange); }\n  .history-event .event-title { font-weight: 600; font-size: 13px; }\n  .history-event .event-detail { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }\n  .history-event .event-meta { font-size: 11px; color: var(--text-muted); margin-top: 4px; font-family: var(--mono); }\n  .history-event-detail { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary); }\n  .history-event.open .history-event-detail { display: block; }\n  .event-agent { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; background: var(--blue-bg); color: #1d4ed8; margin-left: 4px; }\n  .event-agent.human { background: var(--orange-bg); color: #9a3412; }\n  .history-legend { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 16px; padding: 10px 14px; background: var(--gray-bg); border-radius: 6px; font-size: 11px; color: var(--text-secondary); }\n  .history-legend-item { display: flex; align-items: center; gap: 6px; }\n  .history-legend-dot { width: 10px; height: 10px; border-radius: 50%; }\n\n  /* \u2500\u2500 Footer \u2500\u2500 */\n  .footer { text-align: center; padding: 16px; font-size: 11px; color: var(--text-muted); }\n\n  /* \u2500\u2500 Zone tag color variants \u2500\u2500 */\n  .zone-tag.factory { background: var(--blue-bg); color: #1d4ed8; }\n  .zone-tag.product { background: #dcfce7; color: #166534; }\n  .zone-tag.infra { background: var(--purple-bg); color: #6d28d9; }\n\n  /* \u2500\u2500 Architecture legend \u2500\u2500 */\n  .arch-legend { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 10px; padding: 10px 14px; background: var(--gray-bg); border-radius: 6px; font-size: 11px; color: var(--text-secondary); }\n  .arch-legend-item { display: flex; align-items: center; gap: 6px; }\n  .arch-legend-swatch { width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.1); }\n  .arch-legend-circle { width: 14px; height: 14px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 700; color: white; }\n\n  /* \u2500\u2500 What Changed zone detail blocks \u2500\u2500 */\n  .wc-zone-detail { display: none; padding: 8px 0; }\n  .wc-zone-detail.active { display: block; }\n  .wc-zone-detail h4 { font-size: 13px; font-weight: 700; margin-bottom: 6px; }\n\n  /* \u2500\u2500 Adversarial review enhancements \u2500\u2500 */\n  .adv-scroll { max-height: 500px; overflow-y: auto; }\n  .adv-row { cursor: pointer; transition: max-height 0.3s ease, opacity 0.3s ease; }\n  .adv-row:hover { background: var(--gray-bg); }\n  .adv-row.collapsed-row { max-height: 24px; opacity: 0.5; overflow: hidden; }\n  .adv-no-match { display: none; padding: 16px; text-align: center; color: var(--text-muted); font-size: 13px; font-style: italic; }\n  .adv-no-match.visible { display: block; }\n  .adv-detail-row { display: none; }\n  .adv-detail-row.open { display: table-row; }\n  .adv-detail-row td { background: #fafbfc; padding: 12px 20px; font-size: 12px; border-bottom: 1px solid var(--border); }\n\n  /* \u2500\u2500 CI sub-check drill-down \u2500\u2500 */\n  .ci-check-item { padding: 6px 0; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }\n  .ci-check-item:last-child { border-bottom: none; }\n  .ci-check-item:hover { background: #f0f4f8; }\n  .ci-check-summary { font-size: 12px; display: flex; align-items: center; gap: 6px; }\n  .ci-check-summary .chevron-sm { font-size: 10px; color: var(--text-muted); transition: transform 0.2s; display: inline-block; }\n  .ci-check-item.open .chevron-sm { transform: rotate(90deg); }\n  .ci-check-detail { display: none; padding: 6px 0 4px 20px; font-size: 11px; color: var(--text-secondary); }\n  .ci-check-item.open .ci-check-detail { display: block; }\n\n  /* \u2500\u2500 Floating architecture diagram \u2500\u2500 */\n  .arch-floating { position: fixed; top: 16px; right: 16px; width: 40%; max-width: 480px; z-index: 100; background: rgba(255,255,255,0.95); border-radius: 10px; border: 1px solid var(--border); box-shadow: 0 8px 32px rgba(0,0,0,0.12); padding: 10px; transition: opacity 0.3s ease, transform 0.3s ease; opacity: 0; transform: translateX(40px); pointer-events: none; }\n  .arch-floating.visible { opacity: 1; transform: translateX(0); pointer-events: auto; }\n  .arch-floating svg { width: 100%; height: auto; }\n  .arch-floating-close { position: absolute; top: 6px; right: 10px; background: none; border: none; font-size: 16px; cursor: pointer; color: var(--text-muted); z-index: 101; padding: 2px 6px; border-radius: 4px; }\n  .arch-floating-close:hover { background: var(--gray-bg); color: var(--text); }\n\n  /* \u2500\u2500 File path modal \u2500\u2500 */\n  .file-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.45); z-index: 200; justify-content: center; align-items: center; }\n  .file-modal-overlay.visible { display: flex; }\n  .file-modal { background: #1e1e1e; border-radius: 10px; width: 95vw; max-width: 1400px; height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.4); display: flex; flex-direction: column; }\n  .file-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: #2d2d2d; border-bottom: 1px solid #404040; flex-shrink: 0; }\n  .file-modal-header h3 { font-size: 13px; font-family: var(--mono); font-weight: 500; color: #cccccc; }\n  .file-modal-header .fm-stats { font-size: 11px; font-family: var(--mono); margin-left: 12px; }\n  .file-modal-header .fm-stats .fm-add { color: #3fb950; }\n  .file-modal-header .fm-stats .fm-del { color: #f85149; }\n  .file-modal-close { background: none; border: none; font-size: 18px; cursor: pointer; color: #808080; padding: 2px 8px; border-radius: 4px; }\n  .file-modal-close:hover { background: #404040; color: #cccccc; }\n  .file-modal-toolbar { display: flex; justify-content: space-between; align-items: center; padding: 6px 16px; background: #252526; border-bottom: 1px solid #404040; flex-shrink: 0; }\n  .file-modal-tabs { display: flex; gap: 0; }\n  .file-modal-tab { padding: 6px 14px; font-size: 11px; font-weight: 600; cursor: pointer; border: none; background: none; color: #808080; border-bottom: 2px solid transparent; border-radius: 4px 4px 0 0; }\n  .file-modal-tab:hover { color: #cccccc; background: #2d2d2d; }\n  .file-modal-tab.active { color: #ffffff; border-bottom-color: var(--blue); background: #1e1e1e; }\n  .file-modal-github { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: #2d2d2d; border: 1px solid #404040; border-radius: 4px; color: #cccccc; text-decoration: none; font-size: 11px; font-weight: 500; }\n  .file-modal-github:hover { background: #404040; color: white; }\n  .file-modal-body { flex: 1; overflow: auto; background: #1e1e1e; }\n\n  /* \u2500\u2500 Diff rendering \u2500\u2500 */\n  .diff-view { font-family: var(--mono); font-size: 12px; line-height: 1.55; }\n  .diff-unified { width: 100%; border-collapse: collapse; }\n  .diff-unified td { padding: 0 12px; white-space: pre-wrap; word-break: break-all; vertical-align: top; border: none; }\n  .diff-new-file-banner { padding: 8px 16px; background: rgba(63,185,80,0.1); color: #3fb950; font-size: 12px; font-weight: 500; border-bottom: 1px solid #333333; }\n  .diff-deleted-file-banner { padding: 8px 16px; background: rgba(248,81,73,0.1); color: #f85149; font-size: 12px; font-weight: 500; border-bottom: 1px solid #333333; }\n  .diff-unified .diff-ln { width: 50px; min-width: 50px; text-align: right; color: #636363; user-select: none; padding-right: 8px; font-size: 11px; border-right: 1px solid #333333; }\n  .diff-unified .diff-add { background: rgba(63,185,80,0.15); color: #3fb950; }\n  .diff-unified .diff-del { background: rgba(248,81,73,0.15); color: #f85149; }\n  .diff-unified .diff-ctx { color: #cccccc; }\n  .diff-unified .diff-hunk { background: rgba(56,139,253,0.12); color: #58a6ff; padding: 6px 12px; font-style: italic; }\n  .diff-split { width: 100%; border-collapse: collapse; }\n  .diff-split td { padding: 0 6px; white-space: pre; vertical-align: top; border: none; font-family: var(--mono); font-size: 12px; line-height: 1.55; }\n  .diff-split-wrapper { overflow-x: auto; }\n  .diff-split .diff-ln { width: 40px; min-width: 40px; text-align: right; color: #636363; user-select: none; padding-right: 6px; font-size: 11px; }\n  .diff-split .diff-sep { width: 2px; min-width: 2px; background: #2d2d2d; padding: 0; }\n  .diff-split .diff-code-left, .diff-split .diff-code-right { min-width: 0; max-width: 50vw; white-space: pre; overflow-x: auto; }\n  .diff-split .diff-add { background: rgba(63,185,80,0.15); color: #3fb950; }\n  .diff-split .diff-del { background: rgba(248,81,73,0.15); color: #f85149; }\n  .diff-split .diff-ctx { color: #cccccc; }\n  .diff-split .diff-empty { background: #161616; }\n  .diff-split .diff-hunk td { background: rgba(56,139,253,0.08); color: #58a6ff; font-style: italic; padding: 4px 8px; }\n  .diff-raw { color: #cccccc; }\n  .diff-raw table { width: 100%; border-collapse: collapse; }\n  .diff-raw td { padding: 0 12px; white-space: pre-wrap; word-break: break-all; vertical-align: top; border: none; font-family: var(--mono); font-size: 12px; line-height: 1.55; }\n  .diff-raw .diff-ln { width: 50px; min-width: 50px; text-align: right; color: #636363; user-select: none; padding-right: 8px; font-size: 11px; border-right: 1px solid #333333; }\n  .diff-loading { color: #808080; text-align: center; padding: 60px 20px; font-size: 13px; }\n  .diff-error { color: #f85149; text-align: center; padding: 40px 20px; font-size: 13px; }\n  .file-path-link { color: inherit; text-decoration: none; border-bottom: 1px dashed var(--text-muted); cursor: pointer; transition: border-color 0.15s; }\n  .file-path-link:hover { border-bottom-color: var(--blue); color: var(--blue); }\n\n  /* \u2500\u2500 CI Chevron rotation \u2500\u2500 */\n  .ci-chevron { display: inline-block; transition: transform 0.2s; }\n  tr.expandable.ci-open .ci-chevron { transform: rotate(180deg); }\n\n  /* \u2500\u2500 Status badges \u2500\u2500 */\n  .status-row { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }\n  .status-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; }\n  .status-badge.pass { background: var(--green-bg); color: #166534; }\n  .status-badge.info { background: var(--blue-bg); color: #1d4ed8; }\n  .status-badge.warn { background: var(--yellow-bg); color: #854d0e; }\n  .status-badge.fail { background: #fef2f2; color: #991b1b; }\n  .gate-popover { display: none; position: absolute; background: white; border: 1px solid var(--border); border-radius: 6px; padding: 10px 14px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); font-size: 12px; z-index: 50; max-width: 300px; }\n  .gate-popover.visible { display: block; }\n  .gate-clickable { cursor: pointer; border-bottom: 1px dashed var(--text-muted); }\n  .gate-clickable:hover { color: var(--blue); border-bottom-color: var(--blue); }\n  .unverified-flag { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 9px; font-weight: 700; background: var(--orange-bg); color: #9a3412; margin-left: 6px; text-transform: uppercase; }\n\n  @media (max-width: 768px) {\n    .stats { flex-direction: column; gap: 8px; }\n    .convergence-grid { grid-template-columns: 1fr; }\n    .scenario-grid { grid-template-columns: 1fr; }\n    .container { padding: 12px 8px; }\n    .arch-floating { width: 60%; }\n    .file-modal { width: 98vw; height: 95vh; }\n  }\n</style>\n</head>\n<body>\n<div class=\"container\">\n\n  <!-- \u2550\u2550 DATA INJECTION POINT \u2550\u2550 -->\n  <!-- The rendering script injects the ReviewPackData JSON here -->\n\n  <!-- \u2550\u2550 HEADER \u2550\u2550 -->\n  <div class=\"header\">\n    <h1 id=\"pr-title\"><!-- INJECT: header.title --></h1>\n    <div class=\"meta\">\n      <a id=\"pr-url\" href=\"#\" target=\"_blank\"><!-- INJECT: header.prUrl --></a><br>\n      <span id=\"pr-branch-info\"><!-- INJECT: header.headBranch --> &rarr; <!-- INJECT: header.baseBranch --></span>\n      &nbsp;|&nbsp; HEAD: <code id=\"pr-sha\"><!-- INJECT: header.headSha --></code>\n    </div>\n    <div class=\"stats\" id=\"pr-stats\">\n      <!-- INJECT: stat items for additions, deletions, files, commits -->\n    </div>\n    <div class=\"status-row\" id=\"pr-status-row\">\n      <!-- INJECT: status badges -->\n      <div class=\"theme-toggle\" style=\"margin-left:auto\">\n        <button onclick=\"setTheme('light')\" title=\"Light theme\" data-theme-btn=\"light\">&#x2600;</button>\n        <button onclick=\"setTheme('dark')\" title=\"Dark theme\" data-theme-btn=\"dark\">&#x1F319;</button>\n        <button onclick=\"setTheme('system')\" title=\"System theme\" data-theme-btn=\"system\">&#x2699;</button>\n      </div>\n    </div>\n  </div>\n\n  <!-- \u2550\u2550 TAB BAR \u2550\u2550 -->\n  <div class=\"tab-bar\" id=\"tab-bar\">\n    <button class=\"tab-btn active\" onclick=\"switchTab('review')\">Review</button>\n    <!-- INJECT: Factory History tab button (conditionally, only if factoryHistory is present) -->\n  </div>\n\n  <!-- \u2550\u2550 TAB 1: REVIEW \u2550\u2550 -->\n  <div id=\"tab-review\" class=\"tab-content active\">\n    <div class=\"tab-panel\" style=\"padding:20px 24px\">\n\n    <!-- Section: Architecture -->\n    <div class=\"section\" style=\"border:none;margin-bottom:0\">\n      <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n        <h2>Architecture</h2>\n        <span class=\"chevron\">&#x25BC;</span>\n      </div>\n      <div class=\"section-body\">\n        <div class=\"arch-controls\">\n          <button class=\"arch-toggle active\" onclick=\"setArchView('update',this)\">Update (this PR)</button>\n          <button class=\"arch-toggle\" onclick=\"setArchView('baseline',this)\">Baseline (before merge)</button>\n          <span class=\"arch-hint\">Click a zone to filter findings &bull; Click background to reset</span>\n        </div>\n        <svg id=\"arch-diagram\" viewBox=\"0 0 780 360\" style=\"width:100%;max-width:780px;background:#fafbfc;border-radius:8px;border:1px solid var(--border)\">\n          <!-- INJECT: architecture zones, labels, arrows from DATA.architecture -->\n          <!-- Row labels -->\n          <!-- Zone boxes (rect.zone-box[data-zone=\"...\"]) -->\n          <!-- Zone labels (text.zone-label) -->\n          <!-- Zone sublabels (text.zone-sublabel) -->\n          <!-- File count circles (circle.zone-count-bg + text.zone-file-count) -->\n          <!-- Flow arrows (line with marker-end) -->\n        </svg>\n        <div id=\"zone-filter-info\" style=\"margin-top:8px;font-size:12px;color:var(--blue);font-weight:600;display:none\"></div>\n        <div class=\"arch-legend\">\n          <div class=\"arch-legend-item\"><div class=\"arch-legend-circle\" style=\"background:#3b82f6\">3</div> Blue circle = files changed in zone</div>\n          <div class=\"arch-legend-item\"><div class=\"arch-legend-swatch\" style=\"background:#dbeafe;border-color:#3b82f6\"></div> Factory infrastructure</div>\n          <div class=\"arch-legend-item\"><div class=\"arch-legend-swatch\" style=\"background:#dcfce7;border-color:#22c55e\"></div> Product code</div>\n          <div class=\"arch-legend-item\"><div class=\"arch-legend-swatch\" style=\"background:#f3e8ff;border-color:#8b5cf6\"></div> Infrastructure &amp; docs</div>\n          <div class=\"arch-legend-item\" style=\"margin-left:auto;font-style:italic\">Click zone to filter &bull; click background to reset</div>\n        </div>\n      </div>\n    </div>\n\n    </div><!-- end tab-panel -->\n\n    <!-- Section: Spec & Scenarios -->\n    <div class=\"section\">\n      <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n        <h2>Spec &amp; Scenarios</h2>\n        <span class=\"chevron\">&#x25BC;</span>\n      </div>\n      <div class=\"section-body\">\n        <h3 style=\"font-size:13px;margin-bottom:8px\">Specifications</h3>\n        <ul class=\"spec-list\" id=\"spec-list\">\n          <!-- INJECT: specification items from DATA.specs -->\n        </ul>\n        <h3 style=\"font-size:13px;margin:14px 0 8px\">Scenarios</h3>\n        <div class=\"scenario-legend\" id=\"scenario-legend\">\n          <!-- INJECT: scenario category legend items -->\n        </div>\n        <div class=\"scenario-grid\" id=\"scenario-grid\">\n          <!-- INJECT: scenario cards from DATA.scenarios -->\n        </div>\n      </div>\n    </div>\n\n    <!-- Section: What Changed -->\n    <div class=\"section\">\n      <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n        <h2>What Changed</h2>\n        <span class=\"chevron\">&#x25BC;</span>\n      </div>\n      <div class=\"section-body\" id=\"what-changed-body\">\n        <p style=\"margin-bottom:4px;font-size:11px;color:var(--text-muted)\">Generated from <code>git diff</code> by delegated diff-reading agent. Code diffs are ground truth.</p>\n        <div class=\"wc-default\" id=\"wc-default\">\n          <!-- INJECT: whatChanged.defaultSummary.infrastructure and .product -->\n        </div>\n        <!-- INJECT: wc-zone-detail divs for each zone -->\n      </div>\n    </div>\n\n    <!-- Section: Adversarial Review -->\n    <div class=\"section\">\n      <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n        <h2 id=\"adv-header\">Adversarial Review</h2>\n        <span class=\"chevron\">&#x25BC;</span>\n      </div>\n      <div class=\"section-body\">\n        <div class=\"adv-scroll\">\n        <div id=\"adv-no-match\" class=\"adv-no-match\">No adversarial findings in this zone.</div>\n        <table id=\"adv-table\">\n          <thead><tr><th>File</th><th>Grade</th><th>Zone</th><th>Notable</th></tr></thead>\n          <tbody>\n            <!-- INJECT: adversarial finding rows from DATA.adversarialReview.findings -->\n            <!-- Each row: tr.adv-row[data-zones=\"...\"][data-grade-sort=\"N\"] + tr.adv-detail-row -->\n          </tbody>\n        </table>\n        </div>\n      </div>\n    </div>\n\n    <!-- Section: CI Performance -->\n    <div class=\"section\">\n      <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n        <h2>CI Performance</h2>\n        <span class=\"chevron\">&#x25BC;</span>\n      </div>\n      <div class=\"section-body\">\n        <table>\n          <thead><tr><th>Check</th><th>Status</th><th>Time</th><th></th></tr></thead>\n          <tbody id=\"ci-table-body\">\n            <!-- INJECT: CI check rows from DATA.ciPerformance -->\n            <!-- Each: tr.expandable + tr.detail-row with sub-checks -->\n          </tbody>\n        </table>\n        <p style=\"margin-top:10px;font-size:11px;color:var(--text-muted)\">\n          <strong>Thresholds:</strong> &#x2713; under 1m = normal &bull; &#x25CB; 1-5m = acceptable &bull; &#x26A0; 5-10m = watch &bull; &#x2716; over 10m = needs refactoring\n        </p>\n      </div>\n    </div>\n\n    <!-- Section: Key Decisions -->\n    <div class=\"section\">\n      <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n        <h2>Key Decisions</h2>\n        <span class=\"chevron\">&#x25BC;</span>\n      </div>\n      <div class=\"section-body\" id=\"decisions-container\">\n        <!-- INJECT: decision cards from DATA.decisions -->\n      </div>\n    </div>\n\n    <!-- Section: Convergence Result -->\n    <div class=\"section\">\n      <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n        <h2>Convergence Result</h2>\n        <span class=\"chevron\">&#x25BC;</span>\n      </div>\n      <div class=\"section-body\">\n        <div class=\"convergence-grid\" id=\"convergence-grid\">\n          <!-- INJECT: convergence gate cards + overall card from DATA.convergence -->\n        </div>\n      </div>\n    </div>\n\n    <!-- Section: Post-Merge Items -->\n    <div class=\"section\">\n      <div class=\"section-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n        <h2>Post-Merge Items</h2>\n        <span class=\"chevron\">&#x25BC;</span>\n      </div>\n      <div class=\"section-body\" id=\"post-merge-container\">\n        <!-- INJECT: post-merge items from DATA.postMergeItems -->\n      </div>\n    </div>\n\n  </div><!-- end tab-review -->\n\n  <!-- \u2550\u2550 TAB 2: FACTORY HISTORY (conditional) \u2550\u2550 -->\n  <div id=\"tab-history\" class=\"tab-content\">\n    <div class=\"tab-panel\" style=\"padding:20px 24px\">\n      <h2 style=\"font-size:15px;font-weight:700;margin-bottom:16px\">Factory Convergence History</h2>\n      <div class=\"history-legend\">\n        <div class=\"history-legend-item\"><div class=\"history-legend-dot\" style=\"background:var(--blue)\"></div> Automated event</div>\n        <div class=\"history-legend-item\"><div class=\"history-legend-dot\" style=\"background:var(--orange)\"></div> Human/agent intervention</div>\n        <div class=\"history-legend-item\" style=\"margin-left:auto;font-style:italic\">Click event to expand details</div>\n      </div>\n      <div class=\"convergence-grid\" style=\"margin-bottom:20px\" id=\"history-summary-cards\">\n        <!-- INJECT: iteration count + satisfaction trajectory cards -->\n      </div>\n      <h3 style=\"font-size:13px;font-weight:700;margin-bottom:12px\">Timeline</h3>\n      <div class=\"history-timeline\" id=\"history-timeline\">\n        <!-- INJECT: factory history events from DATA.factoryHistory.timeline -->\n      </div>\n      <h3 style=\"font-size:13px;font-weight:700;margin:20px 0 12px\">Gate Findings by Iteration</h3>\n      <table id=\"gate-findings-table\">\n        <thead><tr><th>Phase</th><th>Gate 1</th><th>Gate 2</th><th>Gate 3</th><th>Action</th></tr></thead>\n        <tbody>\n          <!-- INJECT: gate finding rows from DATA.factoryHistory.gateFindings -->\n        </tbody>\n      </table>\n    </div>\n  </div>\n\n  <div class=\"footer\">\n    Generated by review pack agent &nbsp;|&nbsp; <span id=\"footer-date\"><!-- INJECT: header.generatedAt --></span> &nbsp;|&nbsp; HEAD: <span id=\"footer-sha\"><!-- INJECT: header.headSha --></span><br>\n    <span style=\"font-size:10px\">Deterministic rendering from structured data &bull; Code diffs are ground truth</span>\n  </div>\n\n</div>\n\n<!-- Floating architecture diagram (populated by JS) -->\n<div id=\"arch-floating\" class=\"arch-floating\">\n  <button class=\"arch-floating-close\" onclick=\"dismissFloatingDiagram()\" title=\"Dismiss floating diagram\">&times;</button>\n  <div id=\"arch-floating-content\"></div>\n</div>\n\n<!-- File diff modal -->\n<div id=\"file-modal-overlay\" class=\"file-modal-overlay\" onclick=\"if(event.target===this)closeFileModal()\">\n  <div class=\"file-modal\">\n    <div class=\"file-modal-header\">\n      <div style=\"display:flex;align-items:center;gap:8px;overflow:hidden\">\n        <h3 id=\"file-modal-path\" style=\"white-space:nowrap;overflow:hidden;text-overflow:ellipsis\"></h3>\n        <span id=\"file-modal-stats\" class=\"fm-stats\"></span>\n      </div>\n      <button class=\"file-modal-close\" onclick=\"closeFileModal()\">&times;</button>\n    </div>\n    <div class=\"file-modal-toolbar\">\n      <div class=\"file-modal-tabs\">\n        <button class=\"file-modal-tab active\" data-view=\"side-by-side\" onclick=\"setFileModalTab(this,'side-by-side')\">Side-by-side</button>\n        <button class=\"file-modal-tab\" data-view=\"integrated\" onclick=\"setFileModalTab(this,'integrated')\">Unified</button>\n        <button class=\"file-modal-tab\" data-view=\"raw\" onclick=\"setFileModalTab(this,'raw')\">Raw file</button>\n      </div>\n      <a id=\"file-modal-github-link\" class=\"file-modal-github\" href=\"#\" target=\"_blank\">View on GitHub &rarr;</a>\n    </div>\n    <div class=\"file-modal-body\" id=\"file-modal-body\">\n      <div class=\"diff-loading\">Loading diff data&hellip;</div>\n    </div>\n  </div>\n</div>\n\n<!-- Gate popover -->\n<div id=\"gate-popover\" class=\"gate-popover\"></div>\n\n<script>\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// DATA INJECTION POINT\n// Replace this empty object with the ReviewPackData JSON\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nconst DATA = {};\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Theme switching (Light / Dark / System)\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n(function initTheme() {\n  const stored = localStorage.getItem('pr-pack-theme') || 'system';\n  applyTheme(stored);\n  updateThemeButtons(stored);\n})();\n\nfunction setTheme(theme) {\n  localStorage.setItem('pr-pack-theme', theme);\n  applyTheme(theme);\n  updateThemeButtons(theme);\n}\n\nfunction applyTheme(theme) {\n  if (theme === 'system') {\n    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;\n    document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');\n  } else {\n    document.documentElement.setAttribute('data-theme', theme);\n  }\n}\n\nfunction updateThemeButtons(theme) {\n  document.querySelectorAll('.theme-toggle button').forEach(btn => {\n    btn.classList.toggle('active', btn.getAttribute('data-theme-btn') === theme);\n  });\n}\n\nwindow.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {\n  const stored = localStorage.getItem('pr-pack-theme') || 'system';\n  if (stored === 'system') applyTheme('system');\n});\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Tab switching\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction switchTab(tab) {\n  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));\n  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));\n  document.getElementById('tab-' + tab).classList.add('active');\n  event.target.classList.add('active');\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// CI job detail toggle\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction toggleCIDetail(row) {\n  const detail = row.nextElementSibling;\n  if (detail && detail.classList.contains('detail-row')) {\n    detail.classList.toggle('open');\n    row.classList.toggle('ci-open');\n  }\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Decision card toggle + zone highlighting\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction toggleDecision(card) {\n  const wasOpen = card.classList.contains('open');\n  document.querySelectorAll('.decision-card').forEach(c => c.classList.remove('open'));\n  if (!wasOpen) {\n    card.classList.add('open');\n    const zones = card.dataset.zones.split(' ');\n    highlightZones(zones);\n  } else {\n    resetZones();\n  }\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Adversarial review row toggle\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction toggleAdvDetail(row) {\n  const detail = row.nextElementSibling;\n  if (detail && detail.classList.contains('adv-detail-row')) {\n    detail.classList.toggle('open');\n  }\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Architecture zone highlighting (cross-section filtering)\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlet currentActiveZones = null;\n\nfunction highlightZones(activeZones) {\n  currentActiveZones = activeZones;\n\n  // 1. Highlight zones in main and floating diagrams\n  ['#arch-diagram', '#arch-floating'].forEach(sel => {\n    document.querySelectorAll(sel + ' .zone-box').forEach(box => {\n      const zone = box.dataset.zone;\n      if (activeZones.includes(zone)) {\n        box.classList.remove('dimmed');\n        box.classList.add('highlighted');\n      } else {\n        box.classList.add('dimmed');\n        box.classList.remove('highlighted');\n      }\n    });\n  });\n\n  const info = document.getElementById('zone-filter-info');\n  info.textContent = 'Showing zones: ' + activeZones.join(', ');\n  info.style.display = 'block';\n\n  // 2. Filter adversarial review rows\n  let anyMatch = false;\n  document.querySelectorAll('.adv-row').forEach(row => {\n    const rowZones = row.dataset.zones.split(' ');\n    const match = rowZones.some(z => activeZones.includes(z));\n    row.classList.toggle('collapsed-row', !match);\n    if (match) anyMatch = true;\n    const detailRow = row.nextElementSibling;\n    if (detailRow && detailRow.classList.contains('adv-detail-row')) {\n      if (!match) {\n        detailRow.style.display = 'none';\n        detailRow.classList.remove('open');\n      } else {\n        detailRow.style.display = '';\n      }\n    }\n  });\n  const noMatch = document.getElementById('adv-no-match');\n  if (noMatch) noMatch.classList.toggle('visible', !anyMatch);\n\n  // 3. Filter scenario cards\n  document.querySelectorAll('.scenario-card[data-zone]').forEach(card => {\n    const cardZones = card.dataset.zone.split(' ');\n    const match = cardZones.some(z => activeZones.includes(z));\n    card.classList.toggle('zone-dimmed', !match);\n    card.classList.toggle('zone-glow', match);\n  });\n\n  // 4. Filter What Changed section\n  const wcDefault = document.getElementById('wc-default');\n  if (wcDefault) wcDefault.style.display = 'none';\n  document.querySelectorAll('.wc-zone-detail').forEach(d => {\n    d.classList.toggle('active', activeZones.includes(d.dataset.zone));\n  });\n  if (!document.querySelector('.wc-zone-detail.active') && wcDefault) {\n    wcDefault.style.display = '';\n  }\n}\n\nfunction resetZones() {\n  currentActiveZones = null;\n  document.querySelectorAll('.zone-box').forEach(box => box.classList.remove('dimmed', 'highlighted'));\n  document.getElementById('zone-filter-info').style.display = 'none';\n  document.querySelectorAll('.adv-row').forEach(row => row.classList.remove('collapsed-row'));\n  document.querySelectorAll('.adv-detail-row').forEach(row => row.style.display = '');\n  const noMatch = document.getElementById('adv-no-match');\n  if (noMatch) noMatch.classList.remove('visible');\n  document.querySelectorAll('.scenario-card[data-zone]').forEach(card => card.classList.remove('zone-dimmed', 'zone-glow'));\n  const wcDefault = document.getElementById('wc-default');\n  if (wcDefault) wcDefault.style.display = '';\n  document.querySelectorAll('.wc-zone-detail').forEach(d => d.classList.remove('active'));\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Zone click handlers\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction attachZoneClickHandlers(container) {\n  container.querySelectorAll('.zone-box').forEach(box => {\n    box.addEventListener('click', (e) => {\n      e.stopPropagation();\n      const zone = box.dataset.zone;\n      if (currentActiveZones && currentActiveZones.length === 1 && currentActiveZones[0] === zone) {\n        resetZones();\n      } else {\n        highlightZones([zone]);\n      }\n    });\n  });\n}\n\n// Attach to main diagram\nconst mainDiagram = document.getElementById('arch-diagram');\nif (mainDiagram) {\n  attachZoneClickHandlers(mainDiagram);\n  mainDiagram.addEventListener('click', (e) => {\n    if (e.target.tagName === 'svg' || (e.target.tagName === 'text' && e.target.classList.contains('arch-row-label'))) {\n      resetZones();\n      document.querySelectorAll('.decision-card').forEach(c => c.classList.remove('open'));\n    }\n  });\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Architecture view toggle\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction setArchView(view, btn) {\n  document.querySelectorAll('.arch-toggle').forEach(b => b.classList.remove('active'));\n  btn.classList.add('active');\n  if (view === 'baseline') {\n    document.querySelectorAll('.zone-box').forEach(box => { box.style.opacity = '0.25'; });\n    document.getElementById('zone-filter-info').textContent = 'Baseline view: before merge';\n    document.getElementById('zone-filter-info').style.display = 'block';\n  } else {\n    document.querySelectorAll('.zone-box').forEach(box => {\n      box.style.opacity = '1';\n      box.classList.remove('dimmed', 'highlighted');\n    });\n    document.getElementById('zone-filter-info').style.display = 'none';\n  }\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Sticky floating architecture diagram\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlet floatingDismissed = false;\n\n(function initFloatingDiagram() {\n  const archSection = document.getElementById('arch-diagram');\n  const floatingContainer = document.getElementById('arch-floating');\n  const floatingContent = document.getElementById('arch-floating-content');\n  if (!archSection || !floatingContainer) return;\n\n  const svgClone = archSection.cloneNode(true);\n  svgClone.removeAttribute('id');\n  svgClone.style.width = '100%';\n  svgClone.style.maxWidth = 'none';\n  floatingContent.appendChild(svgClone);\n\n  attachZoneClickHandlers(floatingContainer);\n  svgClone.addEventListener('click', (e) => {\n    if (e.target.tagName === 'svg' || (e.target.tagName === 'text' && e.target.classList.contains('arch-row-label'))) {\n      resetZones();\n    }\n  });\n\n  const observer = new IntersectionObserver((entries) => {\n    entries.forEach(entry => {\n      if (floatingDismissed) return;\n      floatingContainer.classList.toggle('visible', !entry.isIntersecting);\n    });\n  }, { threshold: 0.1 });\n  observer.observe(archSection);\n})();\n\nfunction dismissFloatingDiagram() {\n  floatingDismissed = true;\n  document.getElementById('arch-floating').classList.remove('visible');\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Diff data cache\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlet diffDataCache = null;\nlet diffDataLoading = false;\nlet diffDataCallbacks = [];\n\nfunction loadDiffData(cb) {\n  if (diffDataCache) { cb(diffDataCache); return; }\n  diffDataCallbacks.push(cb);\n  if (diffDataLoading) return;\n  diffDataLoading = true;\n  fetch('pr_diff_data.json')\n    .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })\n    .then(data => {\n      diffDataCache = data;\n      diffDataCallbacks.forEach(fn => fn(data));\n      diffDataCallbacks = [];\n    })\n    .catch(err => {\n      diffDataCallbacks.forEach(fn => fn(null, err));\n      diffDataCallbacks = [];\n    })\n    .finally(() => { diffDataLoading = false; });\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// File diff modal\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlet currentFilePath = null;\nlet currentFileData = null;\nlet currentView = 'side-by-side';\n\nfunction openFileModal(path) {\n  currentFilePath = path;\n  const overlay = document.getElementById('file-modal-overlay');\n  const pathEl = document.getElementById('file-modal-path');\n  const statsEl = document.getElementById('file-modal-stats');\n  const link = document.getElementById('file-modal-github-link');\n  const body = document.getElementById('file-modal-body');\n\n  pathEl.textContent = path;\n  // Build GitHub URL from DATA if available\n  const prUrl = (DATA.header && DATA.header.prUrl) || '';\n  const headBranch = (DATA.header && DATA.header.headBranch) || 'main';\n  const repoUrl = prUrl.replace(/\\/pull\\/\\d+$/, '');\n  link.href = repoUrl + '/blob/' + headBranch + '/' + path;\n\n  document.querySelectorAll('.file-modal-tab').forEach(t => t.classList.remove('active'));\n  const activeTab = document.querySelector('.file-modal-tab[data-view=\"' + currentView + '\"]');\n  if (activeTab) activeTab.classList.add('active');\n\n  statsEl.innerHTML = '';\n  body.innerHTML = '<div class=\"diff-loading\">Loading diff data&hellip;</div>';\n  overlay.classList.add('visible');\n  document.body.style.overflow = 'hidden';\n\n  loadDiffData((data, err) => {\n    if (err || !data) {\n      body.innerHTML = '<div class=\"diff-error\">Failed to load diff data.</div>';\n      return;\n    }\n    currentFileData = data.files[path] || null;\n    if (!currentFileData) {\n      // Check for embedded reference file content (spec files, etc.)\n      var refContent = (typeof REFERENCE_FILES !== 'undefined') && REFERENCE_FILES[path];\n      if (refContent) {\n        currentFileData = { raw: refContent, diff: '', additions: 0, deletions: 0 };\n        statsEl.innerHTML = '<span style=\"color:var(--text-secondary);font-size:12px\">' +\n          'Reference file &mdash; not modified in this PR</span>';\n        // Default to raw view for reference files\n        currentView = 'raw';\n        document.querySelectorAll('.file-modal-tab').forEach(function(t) { t.classList.remove('active'); });\n        var rawTab = document.querySelector('.file-modal-tab[data-view=\"raw\"]');\n        if (rawTab) rawTab.classList.add('active');\n        renderDiffView('raw');\n        return;\n      }\n      var ghLink = link.href;\n      body.innerHTML = '<div style=\"text-align:center;padding:40px 20px\">' +\n        '<div style=\"font-size:14px;color:var(--text-secondary);margin-bottom:16px\">' +\n        'This file was not modified in this PR.</div>' +\n        '<a href=\"' + escapeHtml(ghLink) + '\" target=\"_blank\" ' +\n        'style=\"display:inline-block;padding:10px 24px;background:var(--blue);color:white;' +\n        'border-radius:8px;text-decoration:none;font-weight:600;font-size:14px\">' +\n        'View on GitHub &rarr;</a></div>';\n      return;\n    }\n    statsEl.innerHTML = '<span class=\"fm-add\">+' + currentFileData.additions + '</span> <span class=\"fm-del\">-' + currentFileData.deletions + '</span>';\n    renderDiffView(currentView);\n  });\n}\n\nfunction closeFileModal() {\n  document.getElementById('file-modal-overlay').classList.remove('visible');\n  document.body.style.overflow = '';\n  currentFilePath = null;\n  currentFileData = null;\n}\n\nfunction setFileModalTab(btn, view) {\n  document.querySelectorAll('.file-modal-tab').forEach(t => t.classList.remove('active'));\n  btn.classList.add('active');\n  currentView = view;\n  if (currentFileData) renderDiffView(view);\n}\n\nfunction escapeHtml(s) {\n  const div = document.createElement('div');\n  div.textContent = s;\n  return div.innerHTML;\n}\n\nfunction renderDiffView(view) {\n  const body = document.getElementById('file-modal-body');\n  if (!currentFileData) return;\n  if (view === 'raw') renderRawView(body);\n  else if (view === 'integrated') renderUnifiedView(body);\n  else renderSplitView(body);\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Syntax highlighting (lightweight, no deps)\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction detectLanguage(filePath) {\n  if (!filePath) return 'text';\n  const ext = filePath.split('.').pop().toLowerCase();\n  const map = {\n    'py': 'python', 'yaml': 'yaml', 'yml': 'yaml', 'md': 'markdown',\n    'sh': 'shell', 'bash': 'shell', 'js': 'javascript', 'ts': 'javascript',\n    'jsx': 'javascript', 'tsx': 'javascript',\n  };\n  return map[ext] || 'text';\n}\n\nfunction highlightCode(text, language) {\n  if (language === 'text') return text;\n\n  if (language === 'python') {\n    text = text.replace(/(&#39;&#39;&#39;[\\s\\S]*?&#39;&#39;&#39;|&quot;&quot;&quot;[\\s\\S]*?&quot;&quot;&quot;)/g, '<span style=\"color:#ce9178\">$1</span>');\n    text = text.replace(/((?<!\\\\)&#39;(?:[^\\\\]|\\\\.)*?&#39;|(?<!\\\\)&quot;(?:[^\\\\]|\\\\.)*?&quot;)/g, function(m) {\n      if (m.indexOf('style=') !== -1) return m;\n      return '<span style=\"color:#ce9178\">' + m + '</span>';\n    });\n    text = text.replace(/(#[^\\n]*)/g, function(m) {\n      if (m.indexOf('style=') !== -1) return m;\n      return '<span style=\"color:#6a9955\">' + m + '</span>';\n    });\n    text = text.replace(/(@\\w+)/g, '<span style=\"color:#dcdcaa\">$1</span>');\n    text = text.replace(/\\b(True|False|None)\\b/g, '<span style=\"color:#569cd6\">$1</span>');\n    text = text.replace(/\\b(def|class|import|from|if|else|elif|for|while|return|yield|with|as|try|except|finally|raise|not|and|or|in|is|pass|break|continue|lambda|global|nonlocal|async|await|self)\\b/g, function(m) {\n      return '<span style=\"color:#c586c0\">' + m + '</span>';\n    });\n    text = text.replace(/\\b(\\d+\\.?\\d*(?:e[+-]?\\d+)?)\\b/g, '<span style=\"color:#b5cea8\">$1</span>');\n    return text;\n  }\n\n  if (language === 'yaml') {\n    text = text.replace(/(#[^\\n]*)/g, '<span style=\"color:#6a9955\">$1</span>');\n    text = text.replace(/\\b(true|false|yes|no|on|off)\\b/gi, '<span style=\"color:#569cd6\">$1</span>');\n    text = text.replace(/^(\\s*)([\\w][\\w.-]*?)(:)/gm, '$1<span style=\"color:#9cdcfe\">$2</span>$3');\n    text = text.replace(/(&#39;[^]*?&#39;|&quot;[^]*?&quot;)/g, function(m) {\n      if (m.indexOf('style=') !== -1) return m;\n      return '<span style=\"color:#ce9178\">' + m + '</span>';\n    });\n    return text;\n  }\n\n  if (language === 'markdown') {\n    text = text.replace(/^(#{1,6}\\s.*)$/gm, '<span style=\"color:#569cd6\">$1</span>');\n    text = text.replace(/(\\*\\*[^*]+\\*\\*)/g, '<span style=\"color:#dcdcaa;font-weight:bold\">$1</span>');\n    text = text.replace(/(`[^`]+`)/g, '<span style=\"color:#ce9178\">$1</span>');\n    return text;\n  }\n\n  if (language === 'shell') {\n    text = text.replace(/(#[^\\n]*)/g, '<span style=\"color:#6a9955\">$1</span>');\n    text = text.replace(/(&#39;[^]*?&#39;|&quot;[^]*?&quot;)/g, function(m) {\n      if (m.indexOf('style=') !== -1) return m;\n      return '<span style=\"color:#ce9178\">' + m + '</span>';\n    });\n    text = text.replace(/(\\$\\{?\\w+\\}?)/g, '<span style=\"color:#9cdcfe\">$1</span>');\n    text = text.replace(/\\b(if|then|else|elif|fi|for|do|done|while|case|esac|echo|export|set|source|local|readonly|declare|unset|shift|eval|exec|trap|exit|return|function)\\b/g, '<span style=\"color:#c586c0\">$1</span>');\n    return text;\n  }\n\n  if (language === 'javascript') {\n    text = text.replace(/(&#39;[^]*?&#39;|&quot;[^]*?&quot;|`[^]*?`)/g, function(m) {\n      if (m.indexOf('style=') !== -1) return m;\n      return '<span style=\"color:#ce9178\">' + m + '</span>';\n    });\n    text = text.replace(/(\\/\\/[^\\n]*)/g, function(m) {\n      if (m.indexOf('style=') !== -1) return m;\n      return '<span style=\"color:#6a9955\">' + m + '</span>';\n    });\n    text = text.replace(/\\b(true|false|null|undefined|NaN|Infinity)\\b/g, '<span style=\"color:#569cd6\">$1</span>');\n    text = text.replace(/\\b(const|let|var|function|class|if|else|for|while|do|switch|case|break|continue|return|import|export|from|default|new|this|typeof|instanceof|in|of|try|catch|finally|throw|async|await|yield)\\b/g, '<span style=\"color:#c586c0\">$1</span>');\n    return text;\n  }\n\n  return text;\n}\n\n// \u2500\u2500 Raw file view \u2500\u2500\nfunction renderRawView(container) {\n  const raw = currentFileData.raw || '';\n  if (!raw) {\n    container.innerHTML = '<div class=\"diff-error\">File was deleted or is binary.</div>';\n    return;\n  }\n  const lang = detectLanguage(currentFilePath);\n  const lines = raw.split('\\n');\n  let html = '<div class=\"diff-view diff-raw\"><table>';\n  for (let i = 0; i < lines.length; i++) {\n    const escaped = escapeHtml(lines[i]);\n    const highlighted = highlightCode(escaped, lang);\n    html += '<tr><td class=\"diff-ln\">' + (i + 1) + '</td><td>' + highlighted + '</td></tr>';\n  }\n  html += '</table></div>';\n  container.innerHTML = html;\n}\n\n// \u2500\u2500 Unified (integrated) diff view \u2500\u2500\nfunction renderUnifiedView(container) {\n  const diff = currentFileData.diff || '';\n  if (!diff) { container.innerHTML = '<div class=\"diff-error\">No diff available.</div>'; return; }\n  const lines = diff.split('\\n');\n  let html = '<div class=\"diff-view\"><table class=\"diff-unified\">';\n  let oldLn = 0, newLn = 0;\n\n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i];\n    if (line.startsWith('diff --git') || line.startsWith('index ') || line.startsWith('---') || line.startsWith('+++')) continue;\n    if (isDiffMetaLine(line)) continue;\n    if (line.startsWith('@@')) {\n      const m = line.match(/@@ -(\\d+)(?:,\\d+)? \\+(\\d+)(?:,\\d+)? @@(.*)/);\n      if (m) { oldLn = parseInt(m[1]); newLn = parseInt(m[2]); html += '<tr><td class=\"diff-ln\" colspan=\"2\"></td><td class=\"diff-hunk\">' + escapeHtml(line) + '</td></tr>'; }\n      continue;\n    }\n    if (line.startsWith('+')) { html += '<tr class=\"diff-add\"><td class=\"diff-ln\"></td><td class=\"diff-ln\">' + newLn + '</td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; newLn++; continue; }\n    if (line.startsWith('-')) { html += '<tr class=\"diff-del\"><td class=\"diff-ln\">' + oldLn + '</td><td class=\"diff-ln\"></td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; oldLn++; continue; }\n    if (line.startsWith(' ') || line === '') { html += '<tr class=\"diff-ctx\"><td class=\"diff-ln\">' + oldLn + '</td><td class=\"diff-ln\">' + newLn + '</td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; oldLn++; newLn++; }\n  }\n  html += '</table></div>';\n  container.innerHTML = html;\n}\n\nconst DIFF_SKIP_PATTERNS = [/^new file mode/, /^deleted file mode/, /^old mode/, /^new mode/, /^similarity index/, /^rename from/, /^rename to/, /^Binary files/];\nfunction isDiffMetaLine(line) { return DIFF_SKIP_PATTERNS.some(p => p.test(line)); }\n\n// \u2500\u2500 Side-by-side diff view \u2500\u2500\nfunction renderSplitView(container) {\n  const diff = currentFileData.diff || '';\n  if (!diff) { container.innerHTML = '<div class=\"diff-error\">No diff available.</div>'; return; }\n\n  const isNewFile = currentFileData.status === 'added' || (currentFileData.deletions === 0 && currentFileData.additions > 0);\n  const isDeletedFile = currentFileData.status === 'deleted' || (currentFileData.additions === 0 && currentFileData.deletions > 0);\n\n  if (isNewFile || isDeletedFile) {\n    const bannerClass = isNewFile ? 'diff-new-file-banner' : 'diff-deleted-file-banner';\n    const bannerText = isNewFile ? 'New file &mdash; showing additions' : 'Deleted file &mdash; showing deletions';\n    const lines = diff.split('\\n');\n    let html = '<div class=\"' + bannerClass + '\">' + bannerText + '</div><div class=\"diff-view diff-split-wrapper\"><table class=\"diff-unified\">';\n    let ln = 0;\n    for (let i = 0; i < lines.length; i++) {\n      const line = lines[i];\n      if (line.startsWith('diff --git') || line.startsWith('index ') || line.startsWith('---') || line.startsWith('+++')) continue;\n      if (isDiffMetaLine(line)) continue;\n      if (line.startsWith('@@')) { const m = line.match(/@@ -(\\d+)(?:,\\d+)? \\+(\\d+)(?:,\\d+)? @@(.*)/); if (m) { ln = isNewFile ? parseInt(m[2]) : parseInt(m[1]); html += '<tr><td class=\"diff-ln\"></td><td class=\"diff-hunk\">' + escapeHtml(line) + '</td></tr>'; } continue; }\n      if (isNewFile && line.startsWith('+')) { html += '<tr class=\"diff-add\"><td class=\"diff-ln\">' + ln + '</td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; ln++; }\n      else if (isDeletedFile && line.startsWith('-')) { html += '<tr class=\"diff-del\"><td class=\"diff-ln\">' + ln + '</td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; ln++; }\n      else if (line.startsWith(' ') || line === '') { html += '<tr class=\"diff-ctx\"><td class=\"diff-ln\">' + ln + '</td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; ln++; }\n    }\n    html += '</table></div>';\n    container.innerHTML = html;\n    return;\n  }\n\n  // Parse unified diff into side-by-side pairs\n  const lines = diff.split('\\n');\n  const pairs = [];\n  let oldLn = 0, newLn = 0;\n  const addBuffer = [], delBuffer = [];\n\n  function flushBuffers() {\n    const max = Math.max(addBuffer.length, delBuffer.length);\n    for (let j = 0; j < max; j++) {\n      const hasOld = j < delBuffer.length, hasNew = j < addBuffer.length;\n      pairs.push({ type: hasOld && hasNew ? 'change' : hasNew ? 'add' : 'del', oldLn: hasOld ? delBuffer[j].ln : null, newLn: hasNew ? addBuffer[j].ln : null, oldText: hasOld ? delBuffer[j].text : '', newText: hasNew ? addBuffer[j].text : '' });\n    }\n    addBuffer.length = 0; delBuffer.length = 0;\n  }\n\n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i];\n    if (line.startsWith('diff --git') || line.startsWith('index ') || line.startsWith('---') || line.startsWith('+++')) continue;\n    if (isDiffMetaLine(line)) continue;\n    if (line.startsWith('@@')) { flushBuffers(); const m = line.match(/@@ -(\\d+)(?:,\\d+)? \\+(\\d+)(?:,\\d+)? @@(.*)/); if (m) { oldLn = parseInt(m[1]); newLn = parseInt(m[2]); pairs.push({ type: 'hunk', hunkText: line }); } continue; }\n    if (line.startsWith('+')) { addBuffer.push({ ln: newLn, text: line.slice(1) }); newLn++; }\n    else if (line.startsWith('-')) { delBuffer.push({ ln: oldLn, text: line.slice(1) }); oldLn++; }\n    else { flushBuffers(); pairs.push({ type: 'ctx', oldLn: oldLn, newLn: newLn, oldText: line.slice(1), newText: line.slice(1) }); oldLn++; newLn++; }\n  }\n  flushBuffers();\n\n  let html = '<div class=\"diff-view diff-split-wrapper\"><table class=\"diff-split\">';\n  for (const p of pairs) {\n    if (p.type === 'hunk') { html += '<tr class=\"diff-hunk\"><td colspan=\"5\" style=\"padding:4px 8px;background:rgba(56,139,253,0.08);color:#58a6ff;font-style:italic;font-size:11px\">' + escapeHtml(p.hunkText) + '</td></tr>'; continue; }\n    const leftCls = p.type === 'del' || p.type === 'change' ? ' diff-del' : p.type === 'add' ? ' diff-empty' : ' diff-ctx';\n    const rightCls = p.type === 'add' || p.type === 'change' ? ' diff-add' : p.type === 'del' ? ' diff-empty' : ' diff-ctx';\n    html += '<tr><td class=\"diff-ln' + leftCls + '\">' + (p.oldLn != null ? p.oldLn : '') + '</td><td class=\"diff-code-left' + leftCls + '\">' + (p.type === 'add' ? '' : escapeHtml(p.oldText)) + '</td><td class=\"diff-sep\"></td><td class=\"diff-ln' + rightCls + '\">' + (p.newLn != null ? p.newLn : '') + '</td><td class=\"diff-code-right' + rightCls + '\">' + (p.type === 'del' ? '' : escapeHtml(p.newText)) + '</td></tr>';\n  }\n  html += '</table></div>';\n  container.innerHTML = html;\n}\n\n// Close modal on Escape\ndocument.addEventListener('keydown', (e) => {\n  if (e.key === 'Escape') { closeFileModal(); hideGatePopover(); }\n});\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// Gate findings popover\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction showGatePopover(event, text) {\n  event.stopPropagation();\n  const popover = document.getElementById('gate-popover');\n  popover.textContent = '';\n  const lines = text.split('\\\\n');\n  lines.forEach((line, i) => {\n    popover.appendChild(document.createTextNode(line));\n    if (i < lines.length - 1) popover.appendChild(document.createElement('br'));\n  });\n  const rect = event.target.getBoundingClientRect();\n  popover.style.left = rect.left + 'px';\n  popover.style.top = (rect.bottom + 6) + 'px';\n  popover.classList.add('visible');\n  setTimeout(() => { hideGatePopover(); }, 5000);\n}\n\nfunction hideGatePopover() {\n  document.getElementById('gate-popover').classList.remove('visible');\n}\n\ndocument.addEventListener('click', (e) => {\n  if (!e.target.classList.contains('gate-clickable')) hideGatePopover();\n});\n</script>\n</body>\n</html>\n"
    },
    ".claude/skills/pr-review-pack/references/build-spec.md": {
      "additions": 40,
      "deletions": 27,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/.claude/skills/pr-review-pack/references/build-spec.md b/.claude/skills/pr-review-pack/references/build-spec.md\nindex 3cb8799..a49de1b 100644\n--- a/.claude/skills/pr-review-pack/references/build-spec.md\n+++ b/.claude/skills/pr-review-pack/references/build-spec.md\n@@ -53,7 +53,7 @@ interface ReviewPackData {\n   specifications: Specification[];\n   scenarios: Scenario[];\n   whatChanged: WhatChanged;\n-  adversarialFindings: AdversarialFinding[];\n+  agenticReview: AgenticReview;\n   ciChecks: CICheck[];\n   decisions: Decision[];\n   convergence: ConvergenceResult;\n@@ -147,17 +147,24 @@ interface WhatChangedZoneDetail {\n }\n ```\n \n-### AdversarialFinding\n+### AgenticReview / AgenticFinding\n \n ```typescript\n-interface AdversarialFinding {\n+interface AgenticReview {\n+  overallGrade: string;             // \"B+\" \u2014 aggregate grade\n+  reviewMethod: \"main-agent\" | \"agent-teams\";\n+  findings: AgenticFinding[];\n+}\n+\n+interface AgenticFinding {\n   file: string;                     // File path or glob: \"src/* (product code)\", \"check_test_quality.py\"\n   grade: \"A\" | \"B+\" | \"B\" | \"C\" | \"F\" | \"N/A\";\n   gradeSortOrder: number;           // 0=N/A, 1=B, 2=B+, 3=A (lower = worse, sorted worst-first)\n   zones: string;                    // Space-separated zone IDs: \"product-rl product-dashboard\"\n   zoneLayer: \"factory\" | \"product\" | \"infra\";  // Determines zone-tag color class\n-  finding: string;                  // One-line summary: \"Stub detection false positive risk\"\n+  notable: string;                  // One-line summary: \"Stub detection false positive risk\"\n   detail: string;                   // Expanded explanation (HTML allowed)\n+  agent: string;                    // Which agent produced this finding (e.g. \"code-health\", \"security\", \"test-integrity\", \"adversarial\")\n }\n ```\n \n@@ -411,7 +418,7 @@ Each zone specifies `x`, `y`, `width`, `height` for its `<rect>` element.\n **Required data fields**: `ArchitectureZone[]` \u2014 every field.\n \n **Interactive behaviors**:\n-- **Zone click**: Click a zone box to filter adversarial review, scenarios, and \"What Changed\" to that zone. Click again (or click SVG background) to reset.\n+- **Zone click**: Click a zone box to filter agentic review, scenarios, and \"What Changed\" to that zone. Click again (or click SVG background) to reset.\n - **Baseline/Update toggle**: Toggle buttons switch between views. Baseline sets all zone boxes to `opacity: 0.25`. Update resets to full opacity.\n - **Floating minimap**: When the inline diagram scrolls out of the viewport (IntersectionObserver, threshold 0.1), a floating copy appears fixed at `top: 16px; right: 16px; width: 40%; max-width: 480px`. The floating diagram has the same zone-click behavior. A dismiss button (X) hides the floating diagram permanently for the session (`floatingDismissed = true`).\n \n@@ -509,46 +516,52 @@ Each zone specifies `x`, `y`, `width`, `height` for its `<rect>` element.\n - Zone detail blocks exist for every zone that has files in the diff.\n - Summary content is consistent with the actual diff \u2014 no files or changes mentioned that don't exist.\n \n-### Section 5: Adversarial Review\n+### Section 5: Agentic Review\n \n-**What it shows**: A scrollable table of graded findings. Columns: File, Grade, Zone, Notable. Rows sorted by severity (worst first). Each row is expandable to show detailed findings.\n+**What it shows**: Per-file grouped table of review findings from multiple specialized agents (code-health, security, test-integrity, adversarial). Each file row shows compact agent grade badges and expands to show per-agent detail.\n \n-**Data source**: Pass 2 (adversarial review agent grades each file/group).\n+**Data source**: Pass 2 (agent team \u2014 each agent reviews through its paradigm).\n \n-**Required data fields**: `AdversarialFinding[]`.\n+**Required data fields**: `AgenticReview` \u2014 `overallGrade`, `reviewMethod`, `findings[]`.\n \n **Interactive behaviors**:\n-- Click a row to toggle its detail row (`.adv-detail-row`).\n-- Zone filtering: When a zone is active, non-matching rows get `.collapsed-row` class (24px max-height, 0.5 opacity, truncated text, grade/zone badges hidden). A \"No adversarial findings in this zone\" message appears if zero rows match.\n+- Click a file row to toggle its detail section (per-agent findings with grade, agent name, and detail text).\n+- Zone filtering: When a zone is active, non-matching rows get `.collapsed-row` class (24px max-height, 0.5 opacity, truncated text, badges hidden). A \"No review findings in this zone\" message appears if zero rows match.\n - Scrollable container: `.adv-scroll` with `max-height: 500px; overflow-y: auto`.\n \n **Visual design**:\n-- Grade pills: `.grade` class (28x28px, 6px border-radius, centered text) with modifiers:\n-  - `.a`: green background/text\n-  - `.b`: yellow background/text\n-  - `.c`: orange background/text\n-  - `.f`: red background/text\n-  - `.na`: gray background/text (not reviewed)\n+- Agent grade badges: `.agent-grade-badge` \u2014 compact inline badges showing `ABBREV:GRADE` (e.g. \"CH:A\", \"SE:B\"). Color-coded by grade (green=A, yellow=B/B+, orange=C, red=F, gray=N/A).\n+- Agent legend: `.agent-legend` below section header \u2014 shows CH=Code Health, SE=Security, TI=Test Integrity, AD=Adversarial.\n - Zone tags: `.zone-tag` with layer-specific modifiers: `.factory` (blue), `.product` (green), `.infra` (purple).\n-- Detail rows: `.adv-detail-row td` with `#fafbfc` background, 12px font, `colspan=\"4\"`.\n+- Detail entries: `.agent-detail-entry` with agent name header and finding body text.\n \n ```html\n <tr class=\"adv-row\" data-zones=\"gate-2-nfr\" data-grade-sort=\"1\" onclick=\"toggleAdvDetail(this)\">\n   <td><code>check_test_quality.py</code></td>\n-  <td><span class=\"grade b\">B</span></td>\n+  <td class=\"agent-badges-cell\">\n+    <span class=\"agent-grade-badge grade-b\">CH:B</span>\n+    <span class=\"agent-grade-badge grade-a\">SE:A</span>\n+    <span class=\"agent-grade-badge grade-a\">TI:A</span>\n+  </td>\n   <td><span class=\"zone-tag factory\">gate-2-nfr</span></td>\n   <td>Stub detection false positive risk</td>\n </tr>\n <tr class=\"adv-detail-row\" data-zones=\"gate-2-nfr\">\n-  <td colspan=\"4\">{finding.detail}</td>\n+  <td colspan=\"4\">\n+    <div class=\"agent-detail-entry\">\n+      <div class=\"agent-detail-header\"><span class=\"agent-grade-badge grade-b\">CH:B</span> Code Health</div>\n+      <div class=\"agent-detail-body\">{finding.detail}</div>\n+    </div>\n+  </td>\n </tr>\n ```\n \n **Validation checks**:\n-- Every file in the diff appears in the adversarial review (individually or grouped).\n+- Every file in the diff appears in the agentic review (individually or grouped).\n - Grade values are one of the defined set: A, B+, B, C, F, N/A.\n - Zone tags on each row match the file's actual zone membership from Pass 1.\n - Rows are sorted by `gradeSortOrder` ascending (worst first).\n+- Every finding has a valid `agent` field.\n \n ### Section 6: CI Performance\n \n@@ -659,7 +672,7 @@ Each zone specifies `x`, `y`, `width`, `height` for its `<rect>` element.\n \n **What it shows**: A list of expandable items ordered by priority. Each item: priority badge + title (collapsed), with code snippet + failure scenario + success/resolution scenario (expanded).\n \n-**Data source**: Pass 2 (adversarial reviewer identifies post-merge risks).\n+**Data source**: Pass 2 (agentic review team identifies post-merge risks).\n \n **Required data fields**: `PostMergeItem[]`.\n \n@@ -782,7 +795,7 @@ Three-button toggle in the header: sun (light), moon (dark), gear (system).\n When a zone is clicked, `highlightZones([zoneId])` is called. This function updates four sections simultaneously:\n \n 1. **Architecture diagram**: Matching zones get `.highlighted` (stroke-width: 3, brightness 0.92). Non-matching zones get `.dimmed` (opacity 0.12). Both inline and floating diagrams update.\n-2. **Adversarial review**: Non-matching rows get `.collapsed-row` (24px, 0.5 opacity, truncated). Matching rows display normally. If zero rows match, show `#adv-no-match` message.\n+2. **Agentic review**: Non-matching rows get `.collapsed-row` (24px, 0.5 opacity, truncated). Matching rows display normally. If zero rows match, show `#adv-no-match` message.\n 3. **Scenario cards**: Non-matching cards get `.zone-dimmed` (opacity 0.35). Matching cards get `.zone-glow` (2px blue box-shadow).\n 4. **What Changed**: Default view hides. Zone-specific detail blocks matching the active zone become visible.\n \n@@ -899,7 +912,7 @@ gh api repos/{owner}/{repo}/pulls/{pr}/reviews --jq '[.[] | select(.state == \"CH\n \n **What the agent produces**:\n 1. `WhatChanged` \u2014 infrastructure and product summaries + per-zone detail blocks\n-2. `AdversarialFinding[]` \u2014 graded review of every file or file group\n+2. `AgenticReview` \u2014 graded review of every file or file group, with per-agent findings\n 3. `Decision[]` \u2014 architectural decisions identified from the diff\n 4. `PostMergeItem[]` \u2014 risks and follow-ups with code snippets\n 5. `Scenario[]` status \u2014 if scenarios exist, run them and report results\n@@ -925,7 +938,7 @@ Summarize what changed in two layers: infrastructure and product.\n For each zone with files in the diff, produce a zone detail block.\n Ground truth: the diff. Do not invent changes not in the diff.\n \n-### adversarialFindings\n+### agenticReview\n Grade every file or logical file group. Use grades:\n - A: Clean, no issues\n - B+: Minor non-blocking concerns\n@@ -1178,7 +1191,7 @@ Every check that must pass before the review pack is delivered to the reviewer.\n - [ ] Every decision-zone claim is verified (file in zone's paths exists in diff). Unverified claims are flagged.\n - [ ] Every code snippet in post-merge items references a real file and valid line range in the diff.\n - [ ] Every file path link in decisions and findings references a file that exists in the diff.\n-- [ ] Adversarial grades are from the defined set: A, B+, B, C, F, N/A.\n+- [ ] Agentic review grades are from the defined set: A, B+, B, C, F, N/A.\n - [ ] Priority values are from the defined set: low, medium, high, cosmetic.\n - [ ] CI health classifications match timing thresholds (<1m=normal, 1-5m=acceptable, 5-10m=watch, >10m=refactor).\n \n@@ -1197,7 +1210,7 @@ Every check that must pass before the review pack is delivered to the reviewer.\n \n ### Content Completeness\n \n-- [ ] Every file in the diff appears in the adversarial review (individually or grouped).\n+- [ ] Every file in the diff appears in the agentic review (individually or grouped).\n - [ ] Every CI check on HEAD SHA is listed.\n - [ ] Every zone with files in the diff has a \"What Changed\" zone detail block.\n - [ ] Scenario count and status match actual evaluation results.\n",
      "raw": "# PR Review Pack \u2014 Build Specification\n\nComprehensive specification for generating interactive PR review packs. This is the authoritative source \u2014 the \"what\" and \"why\" of everything the skill produces.\n\n---\n\n## Implementations\n\n| What | Where |\n|------|-------|\n| This spec | `references/build-spec.md` (you are here) |\n| Skill entry point | `SKILL.md` (always loaded, summarizes pipeline) |\n| Focused references | `references/data-schema.md`, `section-guide.md`, `css-design-system.md`, `validation-checklist.md` |\n| HTML template | `assets/template.html` |\n| Diff extraction script | `scripts/generate_diff_data.py` |\n| v1 reference (PR #5) | `docs/pr_review_pack.html` (in repo root) |\n| High-level PR review pack section | Second brain: `0_claude/development_workflow.md` |\n\n---\n\n## 1. Overview\n\n### What It Is\n\nA self-contained interactive HTML file that lets a human reviewer understand a PR without reading the code. Open it in a browser, read the top-level summary, drill into any section. One read tells you whether to merge, what the risks are, and what to watch post-merge.\n\n### Who It's For\n\nThe PR reviewer (Joey). He reviews the report, not the code. The review pack is the artifact \u2014 generated when all PR readiness criteria are met.\n\n### Core Insight\n\nSeparate **mapping** (deterministic), **analysis** (LLM, but verifiable), and **rendering** (deterministic). Every LLM claim is checked against the zone registry and actual diff. Unverified claims are flagged, not silently rendered.\n\n### Three-Pass Pipeline Summary\n\n| Pass | Type | Input | Output | Intelligence |\n|------|------|-------|--------|-------------|\n| 1 \u2014 Diff Analysis | Deterministic | `git diff main...HEAD`, zone registry | `{file -> zone[]}` mapping, file stats | Zero |\n| 2 \u2014 Semantic Analysis | Delegated agent | Diff output, zone registry, project context | Summaries, decisions, findings, post-merge items | LLM (verifiable) |\n| 3 \u2014 Rendering | Deterministic | Verified JSON from Pass 1+2, HTML template | Self-contained HTML file | Zero |\n\n---\n\n## 2. Data Schema\n\nEvery piece of data that appears in the review pack. TypeScript-style interfaces. The top-level `ReviewPackData` object is injected into the HTML template as a `<script>const DATA = { ... };</script>` block.\n\n```typescript\ninterface ReviewPackData {\n  header: PRHeader;\n  zones: ArchitectureZone[];\n  specifications: Specification[];\n  scenarios: Scenario[];\n  whatChanged: WhatChanged;\n  agenticReview: AgenticReview;\n  ciChecks: CICheck[];\n  decisions: Decision[];\n  convergence: ConvergenceResult;\n  postMergeItems: PostMergeItem[];\n  factoryHistory: FactoryHistory;\n  diffData: DiffData;\n}\n```\n\n### PRHeader\n\n```typescript\ninterface PRHeader {\n  title: string;                    // \"PR #5: Dark Factory v1\"\n  url: string;                      // Full GitHub PR URL\n  sourceBranch: string;             // \"factory/v1\"\n  targetBranch: string;             // \"main\"\n  headSha: string;                  // Short SHA, e.g. \"efbf3d4\"\n  additions: number;                // Total lines added\n  deletions: number;                // Total lines deleted\n  filesChanged: number;             // Total files in diff\n  commits: number;                  // Commit count on branch\n  factorySummary: string | null;    // \"Pre-crank \u00b7 3+validation iterations \u00b7 4 interventions\"\n}\n```\n\n### ArchitectureZone\n\n```typescript\ninterface ArchitectureZone {\n  id: string;                       // \"factory-orchestration\", \"product-rl\"\n  name: string;                     // Display name: \"Orchestration\", \"RL System\"\n  sublabel: string;                 // \"factory.yaml, SKILL.md\"\n  layer: \"factory\" | \"product\" | \"infra\";  // Determines color/row\n  paths: string[];                  // Glob patterns for zone membership\n  specs: string[];                  // Spec files governing this zone\n  fileCount: number;                // Files changed in this zone (from Pass 1)\n  position: ZonePosition;           // SVG layout coordinates\n}\n\ninterface ZonePosition {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n}\n```\n\n### Specification\n\n```typescript\ninterface Specification {\n  path: string;                     // \"specs/system.md\"\n  icon: string;                     // Unicode emoji: \"\ud83d\udcd6\", \"\ud83c\udfed\", \"\u2705\", \"\ud83d\udee1\"\n  description: string;              // \"MiniPong DQN component specifications\"\n}\n```\n\n### Scenario\n\n```typescript\ninterface Scenario {\n  name: string;                     // \"Environment Initialization\"\n  category: string;                 // \"environment\", \"training\", \"pipeline\", \"integration\"\n  zone: string;                     // Space-separated zone IDs: \"product-rl\", \"product-rl infrastructure\"\n  status: \"pass\" | \"advisory\" | \"fail\";\n  detail: ScenarioDetail;\n}\n\ninterface ScenarioDetail {\n  what: string;                     // What the scenario tests\n  how: string;                      // How it's evaluated\n  result: string;                   // Pass/fail description\n}\n```\n\n### WhatChanged\n\n```typescript\ninterface WhatChanged {\n  sourceAttribution: string;        // \"Generated from git diff main...HEAD by delegated diff-reading agent\"\n  infrastructure: string;           // Summary of factory/CI/tooling changes (HTML allowed)\n  product: string;                  // Summary of application code changes (HTML allowed)\n  zoneDetails: WhatChangedZoneDetail[];\n}\n\ninterface WhatChangedZoneDetail {\n  zone: string;                     // Zone ID matching ArchitectureZone.id\n  title: string;                    // \"Factory Orchestration\"\n  description: string;              // HTML description of changes in this zone\n}\n```\n\n### AgenticReview / AgenticFinding\n\n```typescript\ninterface AgenticReview {\n  overallGrade: string;             // \"B+\" \u2014 aggregate grade\n  reviewMethod: \"main-agent\" | \"agent-teams\";\n  findings: AgenticFinding[];\n}\n\ninterface AgenticFinding {\n  file: string;                     // File path or glob: \"src/* (product code)\", \"check_test_quality.py\"\n  grade: \"A\" | \"B+\" | \"B\" | \"C\" | \"F\" | \"N/A\";\n  gradeSortOrder: number;           // 0=N/A, 1=B, 2=B+, 3=A (lower = worse, sorted worst-first)\n  zones: string;                    // Space-separated zone IDs: \"product-rl product-dashboard\"\n  zoneLayer: \"factory\" | \"product\" | \"infra\";  // Determines zone-tag color class\n  notable: string;                  // One-line summary: \"Stub detection false positive risk\"\n  detail: string;                   // Expanded explanation (HTML allowed)\n  agent: string;                    // Which agent produced this finding (e.g. \"code-health\", \"security\", \"test-integrity\", \"adversarial\")\n}\n```\n\n### CICheck\n\n```typescript\ninterface CICheck {\n  name: string;                     // \"factory-self-test\"\n  trigger: string;                  // \"push\", \"PR\", or combined\n  status: \"pass\" | \"fail\";\n  time: string;                     // \"19s\", \"4m 35s\", \"6m 18s\"\n  health: \"normal\" | \"acceptable\" | \"watch\" | \"refactor\";\n  detail: CICheckDetail;\n}\n\ninterface CICheckDetail {\n  coverage: string;                 // \"Factory infrastructure validation\"\n  gates: string;                    // \"Gate 1 (factory scripts only)\"\n  subChecks: CISubCheck[];          // Individual checks within this CI job\n  zones: string[];                  // Zone IDs this job validates\n  specs: string[];                  // Spec file paths\n  note: string | null;              // Warning note, e.g. \"6m18s is in the watch zone...\"\n}\n\ninterface CISubCheck {\n  name: string;                     // \"Lint factory scripts (ruff check)\"\n  command: string | null;           // \"ruff check scripts/ tests/\"\n  description: string;              // What it does\n  source: string | null;            // Test file path if applicable\n  zones: string[];                  // Zone IDs covered by this sub-check\n}\n```\n\n### Decision\n\n```typescript\ninterface Decision {\n  number: number;                   // Sequential: 1, 2, 3...\n  title: string;                    // \"Claude Code orchestrates, CI validates\"\n  rationale: string;                // One-line collapsed view\n  detailHtml: string;               // Full explanation (HTML, rendered in expanded body)\n  zones: string[];                  // Zone IDs affected (drives diagram highlighting)\n  files: DecisionFile[];            // Files associated with this decision\n}\n\ninterface DecisionFile {\n  path: string;                     // \".github/workflows/factory.yaml\"\n  change: string;                   // \"Validation-only mode + convergence PR + guards\"\n}\n```\n\n### ConvergenceResult\n\n```typescript\ninterface ConvergenceResult {\n  gates: ConvergenceGate[];\n  overall: ConvergenceOverall;\n}\n\ninterface ConvergenceGate {\n  name: string;                     // \"Gate 1 \u2014 Deterministic\"\n  status: \"passing\" | \"warning\" | \"failing\";\n  summary: string;                  // \"PASSING\", \"4 FINDINGS\", \"11/12 PASSING\"\n  detail: string;                   // Short description\n  expandedHtml: string;             // Full detail for expanded card (HTML)\n}\n\ninterface ConvergenceOverall {\n  status: \"passing\" | \"warning\" | \"failing\";\n  summary: string;                  // \"READY\"\n  detail: string;                   // Context note\n  expandedHtml: string;             // Full detail for expanded card (HTML)\n}\n```\n\n### PostMergeItem\n\n```typescript\ninterface PostMergeItem {\n  priority: \"low\" | \"medium\" | \"high\" | \"cosmetic\";\n  title: string;                    // \"Makefile regex fragility in strip_holdout.py\"\n  description: string;              // Context paragraph (HTML)\n  codeSnippet: CodeSnippet | null;\n  failureScenario: string;          // What could go wrong\n  successScenario: string;          // What \"fixed\" looks like\n  zones: string[];                  // Affected zone IDs\n}\n\ninterface CodeSnippet {\n  header: string;                   // \"## scripts/strip_holdout.py, lines 72-78\"\n  code: string;                     // Raw code content (rendered in <pre>)\n}\n```\n\n### FactoryHistory\n\n```typescript\ninterface FactoryHistory {\n  summary: FactoryHistorySummary;\n  events: FactoryEvent[];\n  gateFindings: GateFindingRow[];\n}\n\ninterface FactoryHistorySummary {\n  iterations: string;               // \"3 + validation\"\n  iterationsDetail: string;         // \"3 factory-loop iterations...\"\n  trajectory: string;               // \"Pre-crank\"\n  trajectoryDetail: string;         // \"Infrastructure PR \u2014 satisfaction score not applicable...\"\n}\n\ninterface FactoryEvent {\n  title: string;                    // \"Initial Codex output merged to factory/v1\"\n  type: \"automated\" | \"intervention\";\n  agents: EventAgent[];             // Who was involved\n  detail: string;                   // Short description\n  meta: string;                     // \"Commit: 67e5600 \u00b7 Feb 22\"\n  expandedHtml: string;             // Full detail for expanded view (HTML)\n}\n\ninterface EventAgent {\n  name: string;                     // \"CI (automated)\", \"Human (Joey)\", \"Claude Code (main)\"\n  type: \"automated\" | \"human\";      // Determines badge color\n}\n\ninterface GateFindingRow {\n  phase: string;                    // \"Iter 1-3 (factory-loop)\"\n  phasePopover: string;             // Popover text for phase cell\n  gate1: GateFindingCell;\n  gate2: GateFindingCell;\n  gate3: GateFindingCell;\n  action: string;                   // \"State commits pushed (before fix)\"\n}\n\ninterface GateFindingCell {\n  display: string;                  // \"pass\", \"4 findings\", \"11/12\", \"not run\"\n  type: \"pass\" | \"finding\" | \"notrun\";\n  popover: string;                  // Detailed popover text\n}\n```\n\n### DiffData\n\nLoaded asynchronously from a companion JSON file (`pr_diff_data.json`), or embedded inline for fully self-contained packs.\n\n```typescript\ninterface DiffData {\n  files: Record<string, FileDiff>;\n}\n\ninterface FileDiff {\n  additions: number;\n  deletions: number;\n  status: \"added\" | \"modified\" | \"deleted\" | \"renamed\";\n  diff: string;                     // Unified diff text\n  raw: string;                      // Full file content (for raw view)\n}\n```\n\n---\n\n## 3. Architecture Zone Registry Specification\n\nThe zone registry is the linchpin of deterministic correctness. Every project maintains one as a declarative YAML file.\n\n### Registry Format\n\n```yaml\n# .claude/zone_registry.yaml (or project-specific location)\nzones:\n  factory-orchestration:\n    name: \"Orchestration\"\n    sublabel: \"factory.yaml, SKILL.md\"\n    layer: factory\n    paths:\n      - \".claude/skills/factory-orchestrate/**\"\n      - \".github/workflows/factory.yaml\"\n    specs:\n      - \"docs/dark_factory.md\"\n\n  holdout-isolation:\n    name: \"Holdout Isolation\"\n    sublabel: \"strip/restore scripts\"\n    layer: factory\n    paths:\n      - \"scripts/strip_holdout.py\"\n      - \"scripts/restore_holdout.py\"\n      - \"scenarios/**\"\n    specs:\n      - \"docs/factory_validation_strategy.md\"\n\n  product-rl:\n    name: \"RL System\"\n    sublabel: \"envs, rl, agents, train, configs\"\n    layer: product\n    paths:\n      - \"src/envs/**\"\n      - \"src/rl/**\"\n      - \"src/agents/**\"\n      - \"src/train/**\"\n      - \"configs/**\"\n    specs:\n      - \"specs/system.md\"\n```\n\n### How to Define Zones for Any Project\n\n1. Identify the major architecture areas (3-12 zones typical).\n2. Assign each zone a unique kebab-case `id`.\n3. Classify each zone into a `layer`: `factory` (build/CI infrastructure), `product` (application code), or `infra` (supporting infrastructure, docs, configs).\n4. List glob patterns for file paths that belong to each zone. Use `**` for recursive matching. A file can belong to multiple zones.\n5. Link each zone to its governing spec files.\n6. Define SVG positions for the architecture diagram layout.\n\n### Path Pattern Matching Rules\n\n- Patterns use glob syntax: `*` matches within a directory, `**` matches across directories.\n- Matching is performed against the file's path relative to the repo root.\n- A file matches a zone if it matches ANY of that zone's path patterns.\n- A file can match multiple zones \u2014 this is expected (e.g., integration test files may belong to both a product zone and a test zone).\n- Files that match no zone are assigned to a catch-all `unzoned` category and flagged in the review pack.\n\n### Zone-to-Diagram Position Mapping\n\nThe zone registry includes SVG coordinates for rendering. Zones are arranged in rows by layer:\n\n| Layer | Row Label | SVG y range | Fill color | Stroke color |\n|-------|-----------|-------------|------------|-------------|\n| `factory` | \"Factory Infrastructure\" | 36-116 | `#dbeafe` | `#3b82f6` |\n| `product` | \"Product Code\" | 166-246 | `#dcfce7` | `#22c55e` |\n| `infra` | \"Infrastructure & Docs\" | 286-346 | `#f3e8ff` | `#8b5cf6` |\n\nEach zone specifies `x`, `y`, `width`, `height` for its `<rect>` element.\n\n### Verification Rules\n\n1. **File-to-Zone (Pass 1)**: Pure glob matching. No LLM. Zero hallucination risk.\n2. **Decision-to-Zone (Pass 2)**: LLM-produced claim. Verified by checking that at least one file in the diff touches a path in that zone's patterns. Unverified claims get a `[UNVERIFIED]` flag.\n3. **Zone-to-Diagram**: Static lookup from registry. No verification needed.\n4. **CI-to-Zone**: Static mapping defined in the registry or the CI check data. No LLM.\n\n---\n\n## 4. Section-by-Section Build Guide\n\n### Section 1: Architecture (Baseline + Update)\n\n**What it shows**: An inline SVG diagram with all architecture zones arranged in rows by layer. Two toggle views: \"Update (this PR)\" shows zones with file-count badges, \"Baseline (before merge)\" dims all zones to show the pre-merge state. A floating minimap version appears when the inline diagram scrolls out of view.\n\n**Data source**: Pass 1 (zone-to-file mapping, file counts). Zone positions from registry.\n\n**Required data fields**: `ArchitectureZone[]` \u2014 every field.\n\n**Interactive behaviors**:\n- **Zone click**: Click a zone box to filter agentic review, scenarios, and \"What Changed\" to that zone. Click again (or click SVG background) to reset.\n- **Baseline/Update toggle**: Toggle buttons switch between views. Baseline sets all zone boxes to `opacity: 0.25`. Update resets to full opacity.\n- **Floating minimap**: When the inline diagram scrolls out of the viewport (IntersectionObserver, threshold 0.1), a floating copy appears fixed at `top: 16px; right: 16px; width: 40%; max-width: 480px`. The floating diagram has the same zone-click behavior. A dismiss button (X) hides the floating diagram permanently for the session (`floatingDismissed = true`).\n\n**Visual design**:\n- SVG viewBox: `0 0 780 360`.\n- Row labels: `<text>` with class `arch-row-label` (10px, 700 weight, uppercase, `#9ca3af`).\n- Zone boxes: `<rect>` with `rx=\"8\"`, layer-specific fill/stroke.\n- File count badges: `<circle>` with layer-specific fill + `<text>` in white.\n- Flow arrows between factory zones: `<line>` with arrowhead marker.\n- Legend below the diagram: `.arch-legend` with swatches and instructions.\n\n**SVG structure per zone**:\n```html\n<rect class=\"zone-box\" data-zone=\"{id}\" x=\"{x}\" y=\"{y}\" width=\"{w}\" height=\"{h}\"\n      rx=\"8\" fill=\"{layerFill}\" stroke=\"{layerStroke}\" stroke-width=\"1.5\"/>\n<text x=\"{cx}\" y=\"{labelY}\" text-anchor=\"middle\" class=\"zone-label\"\n      fill=\"{layerTextColor}\">{name}</text>\n<text x=\"{cx}\" y=\"{sublabelY}\" text-anchor=\"middle\" class=\"zone-sublabel\">{sublabel}</text>\n<circle class=\"zone-count-bg\" cx=\"{badgeCx}\" cy=\"{badgeCy}\" r=\"{badgeR}\"\n        fill=\"{layerStroke}\"/>\n<text class=\"zone-file-count\" x=\"{badgeCx}\" y=\"{badgeCy + 4}\" text-anchor=\"middle\">\n  {fileCount}\n</text>\n```\n\n**Validation checks**:\n- Every zone in the registry appears in the diagram.\n- File counts match the actual diff (sum of files matching each zone's patterns).\n- Floating diagram is a clone of the inline diagram with identical zone data.\n\n### Section 3: Spec & Scenarios\n\n**What it shows**: Two subsections. \"Specifications\" lists the spec files that drove the work, each with an icon and description. \"Scenarios\" shows a grid of evaluation scenarios with category pills, pass/fail status, and expandable detail cards.\n\n**Data source**: Pass 2 (spec identification, scenario evaluation results). Scenario status from actual test/evaluation runs.\n\n**Required data fields**: `Specification[]`, `Scenario[]`.\n\n**Interactive behaviors**:\n- Scenario cards are clickable \u2014 toggle `.open` class to show/hide the detail panel.\n- When a zone filter is active (from Section 2), scenario cards with non-matching zones get `.zone-dimmed` (opacity 0.35), matching ones get `.zone-glow` (blue box-shadow).\n\n**Visual design**:\n- Specs: `<ul class=\"spec-list\">` with icon + `<code>` path + description per `<li>`.\n- Scenarios: `.scenario-grid` (2-column CSS grid, gap 8px). Each card is `.scenario-card` with `.name`, `.status`, and `.scenario-card-detail` (hidden until `.open`).\n- Category pills: `.scenario-category` with color-coded modifiers:\n  - `.cat-environment`: green (`#dcfce7`/`#166534`)\n  - `.cat-training`: blue (`#dbeafe`/`#1d4ed8`)\n  - `.cat-pipeline`: purple (`#f3e8ff`/`#6d28d9`)\n  - `.cat-integration`: orange (`#fff7ed`/`#9a3412`)\n- Scenario legend: `.scenario-legend` flex row above the grid.\n- Detail panel: `<dl>` with `<dt>What</dt><dd>...</dd>`, `<dt>How</dt>`, `<dt>Result</dt>`.\n\n```html\n<div class=\"scenario-card\" data-zone=\"product-rl\" onclick=\"this.classList.toggle('open')\">\n  <div class=\"name\">Environment Initialization\n    <span class=\"scenario-category cat-environment\">environment</span>\n  </div>\n  <div class=\"status\" style=\"color:var(--green)\">&#x2713; Passing</div>\n  <div class=\"scenario-card-detail\">\n    <dl>\n      <dt>What</dt><dd>{scenario.detail.what}</dd>\n      <dt>How</dt><dd>{scenario.detail.how}</dd>\n      <dt>Result</dt><dd>{scenario.detail.result}</dd>\n    </dl>\n  </div>\n</div>\n```\n\n**Validation checks**:\n- Every spec file listed actually exists in the repo.\n- Scenario count matches actual evaluation output.\n- Status colors match status values (pass=green, advisory=yellow, fail=red).\n\n### Section 4: What Changed\n\n**What it shows**: Two-layer summary of changes. Default view shows infrastructure and product summaries. When a zone filter is active, shows zone-specific detail blocks instead.\n\n**Data source**: Pass 2 (delegated agent reads diff, produces summaries). Code diffs are ground truth \u2014 agent summaries must be consistent with actual diff.\n\n**Required data fields**: `WhatChanged.sourceAttribution`, `WhatChanged.infrastructure`, `WhatChanged.product`, `WhatChanged.zoneDetails[]`.\n\n**Interactive behaviors**:\n- Default view (`.wc-default`) visible when no zone filter active.\n- Zone-specific detail blocks (`.wc-zone-detail[data-zone]`) shown when matching zone filter is active. Multiple can be visible if multiple zones are selected.\n- If a zone filter is active but no zone details match, fall back to default view.\n\n**Visual design**:\n- Source attribution: `<p>` with 11px font, `--text-muted` color, `<code>` for the git command.\n- Infrastructure and product summaries: `<p>` elements with `<strong>` labels and `<code>` for file/tool references.\n- Zone details: `.wc-zone-detail` with `<h4>` heading and `<p>` description.\n\n**Validation checks**:\n- Source attribution always states the data source: \"Generated from `git diff main...HEAD` by delegated diff-reading agent.\"\n- Zone detail blocks exist for every zone that has files in the diff.\n- Summary content is consistent with the actual diff \u2014 no files or changes mentioned that don't exist.\n\n### Section 5: Agentic Review\n\n**What it shows**: Per-file grouped table of review findings from multiple specialized agents (code-health, security, test-integrity, adversarial). Each file row shows compact agent grade badges and expands to show per-agent detail.\n\n**Data source**: Pass 2 (agent team \u2014 each agent reviews through its paradigm).\n\n**Required data fields**: `AgenticReview` \u2014 `overallGrade`, `reviewMethod`, `findings[]`.\n\n**Interactive behaviors**:\n- Click a file row to toggle its detail section (per-agent findings with grade, agent name, and detail text).\n- Zone filtering: When a zone is active, non-matching rows get `.collapsed-row` class (24px max-height, 0.5 opacity, truncated text, badges hidden). A \"No review findings in this zone\" message appears if zero rows match.\n- Scrollable container: `.adv-scroll` with `max-height: 500px; overflow-y: auto`.\n\n**Visual design**:\n- Agent grade badges: `.agent-grade-badge` \u2014 compact inline badges showing `ABBREV:GRADE` (e.g. \"CH:A\", \"SE:B\"). Color-coded by grade (green=A, yellow=B/B+, orange=C, red=F, gray=N/A).\n- Agent legend: `.agent-legend` below section header \u2014 shows CH=Code Health, SE=Security, TI=Test Integrity, AD=Adversarial.\n- Zone tags: `.zone-tag` with layer-specific modifiers: `.factory` (blue), `.product` (green), `.infra` (purple).\n- Detail entries: `.agent-detail-entry` with agent name header and finding body text.\n\n```html\n<tr class=\"adv-row\" data-zones=\"gate-2-nfr\" data-grade-sort=\"1\" onclick=\"toggleAdvDetail(this)\">\n  <td><code>check_test_quality.py</code></td>\n  <td class=\"agent-badges-cell\">\n    <span class=\"agent-grade-badge grade-b\">CH:B</span>\n    <span class=\"agent-grade-badge grade-a\">SE:A</span>\n    <span class=\"agent-grade-badge grade-a\">TI:A</span>\n  </td>\n  <td><span class=\"zone-tag factory\">gate-2-nfr</span></td>\n  <td>Stub detection false positive risk</td>\n</tr>\n<tr class=\"adv-detail-row\" data-zones=\"gate-2-nfr\">\n  <td colspan=\"4\">\n    <div class=\"agent-detail-entry\">\n      <div class=\"agent-detail-header\"><span class=\"agent-grade-badge grade-b\">CH:B</span> Code Health</div>\n      <div class=\"agent-detail-body\">{finding.detail}</div>\n    </div>\n  </td>\n</tr>\n```\n\n**Validation checks**:\n- Every file in the diff appears in the agentic review (individually or grouped).\n- Grade values are one of the defined set: A, B+, B, C, F, N/A.\n- Zone tags on each row match the file's actual zone membership from Pass 1.\n- Rows are sorted by `gradeSortOrder` ascending (worst first).\n- Every finding has a valid `agent` field.\n\n### Section 6: CI Performance\n\n**What it shows**: A table of CI checks with expandable detail rows. Columns: Check, Status, Time, expand chevron. Each job expands to show coverage, gates, sub-checks (themselves expandable), zones, and spec references.\n\n**Data source**: Pass 1 (`gh pr checks` output, CI run timing). Pass 2 (coverage descriptions, zone mapping).\n\n**Required data fields**: `CICheck[]`.\n\n**Interactive behaviors**:\n- Click a row to toggle its detail row. The chevron rotates 180 degrees (`.ci-open .ci-chevron`).\n- Sub-checks within a detail row are independently expandable (`.ci-check-item` toggles `.open`). Each sub-check has its own chevron that rotates 90 degrees.\n\n**Visual design**:\n- Status: `.badge.pass` or `.badge.fail`.\n- Time display: `.time-label` with health-based color modifier:\n  - `.normal` (green): under 1 minute\n  - `.acceptable` (yellow): 1-5 minutes\n  - `.watch` (orange): 5-10 minutes\n  - `.refactor` (red): over 10 minutes\n- Sub-text: `.time-health-sub` (10px, muted) showing the health classification word.\n- Health tag: `.health-tag` with same color modifiers (small uppercase pill).\n- Sub-checks: `.ci-check-item` with `.ci-check-summary` (flex row with small chevron) and `.ci-check-detail` (hidden until `.open`).\n- Time thresholds legend: `<p>` below the table with threshold definitions.\n\n**Validation checks**:\n- Every CI check from `gh pr checks` on HEAD SHA appears.\n- Status matches actual CI results.\n- Time values are accurate.\n- Health classification matches the time thresholds: <1m=normal, 1-5m=acceptable, 5-10m=watch, >10m=refactor.\n\n### Section 7: Key Decisions\n\n**What it shows**: A list of decision cards, each expandable. Collapsed view: number + title + one-line rationale. Expanded view: full explanation, zone tags, and a file table showing affected files with change descriptions.\n\n**Data source**: Pass 2 (agent identifies architectural decisions from diff and commit messages).\n\n**Required data fields**: `Decision[]`.\n\n**Interactive behaviors**:\n- Click a decision header to expand (only one open at a time \u2014 expanding one closes others).\n- When a decision expands, its `data-zones` attribute drives zone highlighting: matching zones get `.highlighted` + `stroke-width: 3` in the diagram, others get `.dimmed` (opacity 0.12).\n- When a decision closes, zones reset.\n- File paths in the decision's file table are clickable \u2014 open the file modal.\n\n**Visual design**:\n- `.decision-card` with 1px border, 8px radius.\n- `.decision-header`: flex row with `.decision-num` (blue, 14px bold), `.decision-title` (13px 600 weight), `.decision-rationale` (12px secondary color).\n- `.decision-body`: hidden until `.open`, bordered top, contains explanation paragraph + `.decision-zones` (flex-wrap zone tags) + `.decision-files` table.\n\n```html\n<div class=\"decision-card\" data-zones=\"factory-orchestration\">\n  <div class=\"decision-header\" onclick=\"toggleDecision(this.parentElement)\">\n    <span class=\"decision-num\">1</span>\n    <div>\n      <div class=\"decision-title\">{decision.title}</div>\n      <div class=\"decision-rationale\">{decision.rationale}</div>\n    </div>\n  </div>\n  <div class=\"decision-body\">\n    <p>{decision.detailHtml}</p>\n    <div class=\"decision-zones\">\n      <span class=\"zone-tag factory\">{zone}</span>\n    </div>\n    <div class=\"decision-files\">\n      <table>\n        <thead><tr><th>File</th><th>Change</th></tr></thead>\n        <tbody>\n          <tr><td><code class=\"file-path-link\">{file.path}</code></td><td>{file.change}</td></tr>\n        </tbody>\n      </table>\n    </div>\n  </div>\n</div>\n```\n\n**Validation checks**:\n- Every decision's zone claims are verified: at least one file in the diff touches a path in that zone's patterns. Unverified claims are flagged `[UNVERIFIED]`.\n- File paths in decision file tables exist in the actual diff.\n- Decisions are numbered sequentially starting from 1.\n\n### Section 8: Convergence Result\n\n**What it shows**: A 2x2 grid of cards showing gate-by-gate status and overall readiness. Each card is expandable. Collapsed: gate name, status value (colored), and short description. Expanded: detailed check lists and context.\n\n**Data source**: Pass 1 (gate pass/fail from test runs), Pass 2 (interpretation and context).\n\n**Required data fields**: `ConvergenceResult.gates[]`, `ConvergenceResult.overall`.\n\n**Interactive behaviors**:\n- Click a card to toggle `.open` and show `.conv-card-detail`.\n\n**Visual design**:\n- `.convergence-grid`: 2-column CSS grid, 12px gap.\n- `.conv-card`: bordered card with `.conv-status` (20px, 700 weight) colored by status:\n  - `.passing`: `#166534`\n  - `.warning`: `#854d0e`\n  - `.failing`: `#991b1b`\n- `.conv-detail`: 12px secondary text below status.\n- `.conv-card-detail`: hidden until `.open`, top-bordered, contains `<ul>` lists and context.\n\n**Validation checks**:\n- Gate statuses match actual test/evaluation run results.\n- Satisfaction scores (if applicable) are computed from real scenario results, not estimated.\n- Overall status is logically consistent with individual gate statuses.\n\n### Section 9: Post-Merge Items\n\n**What it shows**: A list of expandable items ordered by priority. Each item: priority badge + title (collapsed), with code snippet + failure scenario + success/resolution scenario (expanded).\n\n**Data source**: Pass 2 (agentic review team identifies post-merge risks).\n\n**Required data fields**: `PostMergeItem[]`.\n\n**Interactive behaviors**:\n- Click a `.pm-header` to toggle `.pm-body` visibility.\n- File paths in code snippets are clickable (open file modal).\n\n**Visual design**:\n- `.pm-item`: bordered card, 8px radius.\n- `.pm-header`: flex row with `.priority` badge and title.\n- Priority badges: `.priority` (10px, 700 weight, uppercase) with modifiers:\n  - `.low`: blue (`--blue-bg`/`#1d4ed8`)\n  - `.medium`: yellow (`--yellow-bg`/`#854d0e`)\n  - `.high`: red (`--red-bg`/`#991b1b`) \u2014 not present in v1 but defined for future use\n  - `.cosmetic`: gray (`--gray-bg`/`--gray`)\n- Code snippets: `.code-block` \u2014 dark background (`#1e293b`), monospace, 12px, pre-formatted.\n- Failure scenario: `.scenario-box.failure` \u2014 red-tinted background, red left border (3px).\n- Success scenario: `.scenario-box.success` \u2014 green-tinted background, green left border (3px).\n- Both scenarios have `.scenario-label` (11px, 700 weight, uppercase).\n\n```html\n<div class=\"pm-item\">\n  <div class=\"pm-header\" onclick=\"this.parentElement.classList.toggle('open')\">\n    <span class=\"priority medium\">MEDIUM</span>\n    <span>{item.title}</span>\n  </div>\n  <div class=\"pm-body\">\n    <p>{item.description}</p>\n    <div class=\"code-block\">{item.codeSnippet.header}\\n{item.codeSnippet.code}</div>\n    <div class=\"scenario-box failure\">\n      <div class=\"scenario-label\">Failure scenario</div>\n      {item.failureScenario}\n    </div>\n    <div class=\"scenario-box success\">\n      <div class=\"scenario-label\">Resolution</div>\n      {item.successScenario}\n    </div>\n  </div>\n</div>\n```\n\n**Validation checks**:\n- Code snippets reference real files and line ranges that exist in the diff.\n- Priority is one of the defined set: low, medium, high, cosmetic.\n- Failure and success scenarios are concrete and specific \u2014 not generic advice.\n\n### Factory History Tab\n\n**What it shows**: A secondary tab (separate from the Review tab) providing convergence loop visibility. Contains: summary cards (iterations + trajectory), a chronological timeline of events, and a gate findings by iteration table.\n\n**Data source**: Pass 1 (CI run history, commit log), Pass 2 (event interpretation, intervention classification).\n\n**Required data fields**: `FactoryHistory`.\n\n**Interactive behaviors**:\n- Top-level tab switch: \"Review\" and \"Factory History\" buttons in `.tab-bar`.\n- Summary cards (iterations, trajectory) are expandable.\n- Timeline events are expandable (click to toggle `.history-event-detail`).\n- Gate findings cells have popovers \u2014 click a `.gate-clickable` cell to show a positioned popover with detail text. Popovers auto-dismiss after 5 seconds or on Escape/click-outside.\n\n**Visual design**:\n- Tab bar: `.tab-bar` with `.tab-btn` buttons. Active tab: blue text + blue `border-bottom`.\n- Legend: `.history-legend` with colored dots \u2014 blue for automated, orange for interventions.\n- Summary: `.convergence-grid` (2-column) with `.conv-card` cards.\n- Timeline: `.history-timeline` with left-aligned vertical line (`::before` pseudo-element, 2px wide, `--border` color). Events are `.history-event` cards with colored dot indicators (`::before`, 10px circle):\n  - Blue (`--blue`) for automated events\n  - Orange (`--orange`) for interventions (`.history-event.intervention`)\n- Agent badges: `.event-agent` (10px, blue background) with `.human` modifier (orange background).\n- Gate findings table: standard table with `.gate-clickable` cells (dashed underline, cursor pointer). Popovers: `.gate-popover` (absolute positioned, white background, border, shadow).\n\n**Validation checks**:\n- Every commit in the PR branch appears as an event or is covered by an event range.\n- Intervention events are accurately classified (human vs. agent).\n- Gate finding statuses match actual CI results per iteration.\n\n---\n\n## 5. Interactive Features Specification\n\n### Theme Toggle (Light / Dark / System)\n\nThree-button toggle in the header: sun (light), moon (dark), gear (system).\n\n**Persistence**: `localStorage.getItem('pr-pack-theme')` / `localStorage.setItem(...)`. Default: `'system'`.\n\n**Mechanism**: Set `data-theme` attribute on `<html>` element. `'system'` checks `window.matchMedia('(prefers-color-scheme: dark)')` and listens for changes.\n\n**CSS override pattern**: All dark-mode overrides use `[data-theme=\"dark\"]` attribute selector:\n\n```css\n[data-theme=\"dark\"] {\n  --text: #e5e7eb;\n  --text-secondary: #9ca3af;\n  --border: #374151;\n  --bg: #111827;\n  /* ... all token overrides ... */\n}\n[data-theme=\"dark\"] .section { background: #1f2937; }\n```\n\n**Button markup**:\n```html\n<div class=\"theme-toggle\">\n  <button onclick=\"setTheme('light')\" data-theme-btn=\"light\">&#x2600;</button>\n  <button onclick=\"setTheme('dark')\" data-theme-btn=\"dark\">&#x1F319;</button>\n  <button onclick=\"setTheme('system')\" data-theme-btn=\"system\">&#x2699;</button>\n</div>\n```\n\n### Architecture Diagram: Inline View + Floating Minimap\n\n**Inline**: SVG in the Architecture section body. Full-size, interactive.\n\n**Floating minimap**: A cloned copy of the SVG, positioned `fixed` at top-right. Appears via IntersectionObserver when the inline diagram scrolls out of view (threshold 0.1). Animated with CSS transitions: `opacity 0.3s ease, transform 0.3s ease`. Entry: `translateX(40px) -> translateX(0)`. Dismiss button permanently hides it for the session (`floatingDismissed = true`).\n\n**Zone click handlers**: Attached to both inline and floating diagrams. Both share the same `highlightZones()` / `resetZones()` functions, so clicking in either updates both.\n\n### Zone Click Filtering\n\nWhen a zone is clicked, `highlightZones([zoneId])` is called. This function updates four sections simultaneously:\n\n1. **Architecture diagram**: Matching zones get `.highlighted` (stroke-width: 3, brightness 0.92). Non-matching zones get `.dimmed` (opacity 0.12). Both inline and floating diagrams update.\n2. **Agentic review**: Non-matching rows get `.collapsed-row` (24px, 0.5 opacity, truncated). Matching rows display normally. If zero rows match, show `#adv-no-match` message.\n3. **Scenario cards**: Non-matching cards get `.zone-dimmed` (opacity 0.35). Matching cards get `.zone-glow` (2px blue box-shadow).\n4. **What Changed**: Default view hides. Zone-specific detail blocks matching the active zone become visible.\n\n**Reset**: Click the SVG background, click an already-selected zone, or close a decision card. `resetZones()` removes all filter classes and restores default views.\n\n### Decision Zone Highlighting\n\nOpening a decision card calls `highlightZones(decision.zones)`. Only one decision can be open at a time \u2014 opening a new one closes the previous. Closing the last decision calls `resetZones()`.\n\n### File Modal (Diff Viewer)\n\nFull-screen modal triggered by clicking any `.file-path-link` element. Three view tabs: Side-by-side, Unified, Raw file.\n\n**Modal structure**:\n- Overlay: `.file-modal-overlay` (fixed, full viewport, semi-transparent black background). Click overlay to close.\n- Modal: `.file-modal` (95vw, max 1400px, 90vh, flex column).\n- Header: file path (monospace), addition/deletion stats (green/red), close button.\n- Toolbar: view tabs + \"View on GitHub\" link.\n- Body: scrollable diff content.\n\n**Scroll trapping**: When modal opens, `document.body.style.overflow = 'hidden'`. On close, `overflow` resets to `''`.\n\n**View tabs**: User's tab selection persists across modal opens (stored in `currentView` variable, not reset on each open).\n\n**Diff rendering**:\n- **Side-by-side**: Parses unified diff into `{type, oldLn, newLn, oldText, newText}` pairs. Added lines get green background, deleted lines get red, context lines get neutral. New/deleted files show single-pane with a banner (\"New file\", \"Deleted file\").\n- **Unified**: Standard unified diff rendering with old/new line numbers, hunk headers, colored add/del/context lines.\n- **Raw file**: Full file content with line numbers and syntax highlighting.\n\n**Syntax highlighting**: Built-in highlighter for Python, YAML, Markdown, Shell, JavaScript. Pattern-based (regex, not AST). Colors match VS Code dark theme:\n- Strings: `#ce9178`\n- Comments: `#6a9955`\n- Keywords: `#c586c0`\n- Constants: `#569cd6`\n- Numbers: `#b5cea8`\n- Decorators/functions: `#dcdcaa`\n- Variables: `#9cdcfe`\n\n**Close**: Escape key or click overlay or click X button.\n\n**Data loading**: Diff data loaded asynchronously via `fetch('pr_diff_data.json')`. Cached in `diffDataCache` after first load. Generate the companion JSON with a script (e.g., `generate_diff_data.py`).\n\n### Expandable CI Jobs, Decisions, Post-Merge Items\n\nAll three use the same pattern:\n1. Container element (`.expandable` row, `.decision-card`, `.pm-item`).\n2. Click handler toggles a class (`.open`, `.ci-open`).\n3. CSS controls visibility of detail element (`display: none` -> `display: block/table-row`).\n4. Chevron indicator rotates on open state.\n\n### Gate Findings Popovers\n\nCells in the gate findings table are `.gate-clickable`. On click, `showGatePopover(event, text)` positions a `.gate-popover` div below the clicked element. Newlines in popover text are rendered as `<br>`. Auto-dismiss after 5 seconds. Close on Escape or click outside.\n\n---\n\n## 6. Three-Pass Pipeline: Agent Delegation Guide\n\n### Pass 1 \u2014 Diff Analysis (Deterministic)\n\n**Executor**: Shell script or the main agent executing git commands. Zero LLM involvement.\n\n**Commands to run**:\n\n```bash\n# 1. Get the full diff\ngit diff main...HEAD > /tmp/pr_diff.txt\n\n# 2. Get the file list with stats\ngit diff --stat main...HEAD > /tmp/pr_stats.txt\n\n# 3. Get the file list (paths only, with status indicator)\ngit diff --name-status main...HEAD > /tmp/pr_files.txt\n\n# 4. Get PR metadata\ngh pr view <PR_NUMBER> --json title,url,headRefName,baseRefName,commits,additions,deletions,changedFiles,headRefOid\n\n# 5. Get CI check results\ngh pr checks <PR_NUMBER>\n\n# 6. Get comment status\ngh api repos/{owner}/{repo}/pulls/{pr}/comments --jq 'length'\ngh api repos/{owner}/{repo}/pulls/{pr}/reviews --jq '[.[] | select(.state == \"CHANGES_REQUESTED\")] | length'\n```\n\n**Processing**:\n\n1. Load the zone registry (`zone_registry.yaml`).\n2. For each file in the diff, match against zone path patterns. Produce `{file -> zone[]}` mapping.\n3. Count files per zone.\n4. Compute diff stats (additions, deletions, file count).\n5. Classify CI check health based on timing thresholds.\n\n**Output format**: JSON object containing:\n```json\n{\n  \"header\": { \"title\": \"...\", \"url\": \"...\", \"headSha\": \"...\", \"...\" : \"...\" },\n  \"fileZoneMapping\": { \"path/to/file.py\": [\"zone-id-1\", \"zone-id-2\"] },\n  \"zoneFileCounts\": { \"zone-id\": 5 },\n  \"ciChecks\": [ { \"name\": \"...\", \"status\": \"pass\", \"time\": \"19s\", \"health\": \"normal\" } ],\n}\n```\n\n### Pass 2 \u2014 Semantic Analysis (Delegated Agent)\n\n**Executor**: A separate agent instance (not the main thread). Use the `researcher` or `code-reviewer` subagent type. The agent reads the diff and zone registry but does NOT read the main thread's conversation context.\n\n**What the agent reads**:\n1. The full diff (`git diff main...HEAD`)\n2. The zone registry\n3. The file-zone mapping from Pass 1\n4. Project spec files referenced in the zone registry\n5. Commit messages (`git log main...HEAD --oneline`)\n\n**What the agent produces**:\n1. `WhatChanged` \u2014 infrastructure and product summaries + per-zone detail blocks\n2. `AgenticReview` \u2014 graded review of every file or file group, with per-agent findings\n3. `Decision[]` \u2014 architectural decisions identified from the diff\n4. `PostMergeItem[]` \u2014 risks and follow-ups with code snippets\n5. `Scenario[]` status \u2014 if scenarios exist, run them and report results\n6. `ConvergenceResult` \u2014 gate-by-gate status\n7. `FactoryHistory` \u2014 timeline of events (from commit log and CI history)\n\n**Agent prompt template**:\n\n```\nYou are a PR review agent producing structured data for a review pack.\n\n## Inputs\n- Full diff: {diff}\n- Zone registry: {zone_registry}\n- File-zone mapping: {file_zone_mapping}\n- Commit log: {commit_log}\n\n## Task\nProduce a JSON object with these fields:\n\n### whatChanged\nSummarize what changed in two layers: infrastructure and product.\nFor each zone with files in the diff, produce a zone detail block.\nGround truth: the diff. Do not invent changes not in the diff.\n\n### agenticReview\nGrade every file or logical file group. Use grades:\n- A: Clean, no issues\n- B+: Minor non-blocking concerns\n- B: Moderate concerns worth noting\n- C: Issues that should be fixed\n- F: Critical problems\n- N/A: Not reviewed (with justification)\n\nSort by severity (worst first). For each finding, include:\n- file: path or glob\n- grade: letter grade\n- zones: space-separated zone IDs from the mapping\n- finding: one-line summary\n- detail: expanded explanation\n\n### decisions\nIdentify architectural decisions from the diff. For each:\n- title: what was decided\n- rationale: one-line summary of why\n- zones: affected zone IDs (MUST have at least one file in the diff touching that zone's paths)\n- files: file paths and change descriptions\n- detailHtml: full explanation\n\n### postMergeItems\nIdentify risks and follow-ups. For each:\n- priority: low/medium/high/cosmetic\n- title: what needs attention\n- codeSnippet: { header: \"file, lines X-Y\", code: \"actual code\" } \u2014 must reference real code in the diff\n- failureScenario: concrete description of what goes wrong\n- successScenario: concrete description of the resolution\n\n### convergence\nGate-by-gate status with detailed breakdown.\n\n### factoryHistory\nTimeline of events from commit log and CI history.\n\n## Verification Rules\n- Every zone claim on a decision MUST have >= 1 file in the diff touching that zone's paths. If not, mark it [UNVERIFIED].\n- Every code snippet MUST reference actual lines from the diff. Fabricated snippets fail verification.\n- Summaries must be consistent with the actual diff. Do not mention files or changes that are not present.\n```\n\n**Verification rules (applied after agent produces output)**:\n1. Decision-zone claims: For each decision, for each claimed zone, check that at least one file in `decision.files` matches a path pattern in that zone. Flag unverified claims.\n2. Code snippets: For each post-merge item with a code snippet, verify the file exists in the diff and the referenced lines exist. Flag invalid references.\n3. File references: Every file path mentioned in any output must exist in `git diff --name-only main...HEAD`.\n\n### Pass 3 \u2014 Rendering (Deterministic)\n\n**Executor**: Template engine or direct string interpolation. Zero LLM involvement.\n\n**Process**:\n1. Merge Pass 1 and Pass 2 outputs into a single `ReviewPackData` JSON object.\n2. Run verification checks on the merged data. Flag any failures.\n3. Inject the JSON into the HTML template: `<script>const DATA = {json};</script>`.\n4. The template's JavaScript reads `DATA` and renders all sections.\n\n**Template contract**: The HTML template is a pure function of `DATA`. It contains:\n- All CSS (inline in `<style>`).\n- All HTML structure with placeholder containers.\n- All JavaScript that reads `DATA` and populates the DOM.\n- Zero intelligence \u2014 no summarization, no analysis, no decision-making.\n\n**Output**: A single `.html` file. Self-contained. No external dependencies. Opens in any modern browser.\n\n---\n\n## 7. CSS Design System\n\n### CSS Custom Properties (Color Tokens)\n\n```css\n:root {\n  /* Semantic colors */\n  --green: #22c55e;    --green-bg: #f0fdf4;    --green-border: #86efac;\n  --yellow: #eab308;   --yellow-bg: #fefce8;\n  --orange: #f97316;   --orange-bg: #fff7ed;\n  --red: #ef4444;      --red-bg: #fef2f2;\n  --gray: #6b7280;     --gray-bg: #f9fafb;     --gray-border: #e5e7eb;\n  --blue: #3b82f6;     --blue-bg: #eff6ff;\n  --purple: #8b5cf6;   --purple-bg: #f5f3ff;\n\n  /* Text hierarchy */\n  --text: #1f2937;\n  --text-secondary: #6b7280;\n  --text-muted: #9ca3af;\n\n  /* Structure */\n  --border: #e5e7eb;\n  --bg: #f3f4f6;\n\n  /* Typography */\n  --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;\n}\n```\n\n### Dark Mode Override Pattern\n\nAll dark overrides use `[data-theme=\"dark\"]` selector. Override the custom properties first, then override specific component backgrounds:\n\n```css\n[data-theme=\"dark\"] {\n  --text: #e5e7eb;\n  --text-secondary: #9ca3af;\n  --text-muted: #6b7280;\n  --border: #374151;\n  --bg: #111827;\n  --gray-bg: #1f2937;\n  --gray-border: #374151;\n  --gray: #9ca3af;\n  --green-bg: #064e3b;\n  --green-border: #10b981;\n  --yellow-bg: #713f12;\n  --red-bg: #7f1d1d;\n  --orange-bg: #7c2d12;\n  --blue-bg: #1e3a5f;\n  --purple-bg: #2e1065;\n}\n\n/* Component-level overrides (backgrounds that don't use custom properties) */\n[data-theme=\"dark\"] .header,\n[data-theme=\"dark\"] .section,\n[data-theme=\"dark\"] .gate,\n[data-theme=\"dark\"] .tab-panel,\n[data-theme=\"dark\"] .tab-bar { background: #1f2937; }\n```\n\nThe file modal uses a separate override pattern for light theme (since its default styling targets dark):\n```css\n:root:not([data-theme=\"dark\"]) .file-modal { background: #ffffff; }\n:root:not([data-theme=\"dark\"]) .file-modal-header { background: #f5f5f5; }\n/* ... etc */\n```\n\n### Typography\n\n- **Body**: `-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif`. Base: 14px, line-height 1.5.\n- **Monospace**: `var(--mono)` \u2014 SF Mono > Fira Code > Cascadia Code > monospace.\n- **Heading hierarchy**:\n  - Page title: 20px, 700 weight\n  - Section headers: 14px, 700 weight\n  - Sub-headers (within sections): 13px, 700 weight\n  - Body text: 13px, 400/500 weight\n  - Meta text: 11-12px, muted color\n  - Uppercase labels: 10-11px, 600-700 weight, `letter-spacing: 0.3-0.5px`\n- **Table headers**: 11px, 600 weight, uppercase, secondary color, `letter-spacing: 0.3px`.\n\n### Component Patterns\n\n**Badges**:\n```css\n.badge { padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }\n.badge.pass { background: var(--green-bg); color: #166534; }\n.badge.fail { background: var(--red-bg); color: #991b1b; }\n```\n\n**Status badges** (header row):\n```css\n.status-badge { padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; }\n.status-badge.pass { background: var(--green-bg); color: #166534; }\n.status-badge.info { background: var(--blue-bg); color: #1d4ed8; }\n.status-badge.warn { background: var(--yellow-bg); color: #854d0e; }\n```\n\n**Grade pills**:\n```css\n.grade { width: 28px; height: 28px; line-height: 28px; text-align: center;\n         border-radius: 6px; font-weight: 700; font-size: 12px; }\n```\n\n**Zone tags**:\n```css\n.zone-tag { font-size: 11px; padding: 2px 8px; border-radius: 4px; font-weight: 600; }\n.zone-tag.factory { background: var(--blue-bg); color: #1d4ed8; }\n.zone-tag.product { background: #dcfce7; color: #166534; }\n.zone-tag.infra { background: var(--purple-bg); color: #6d28d9; }\n```\n\n**Priority tags**:\n```css\n.priority { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 4px; }\n.priority.low { background: var(--blue-bg); color: #1d4ed8; }\n.priority.medium { background: var(--yellow-bg); color: #854d0e; }\n.priority.cosmetic { background: var(--gray-bg); color: var(--gray); }\n```\n\n**Expandable sections**:\n```css\n.section { border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }\n.section-header { padding: 14px 24px; cursor: pointer; display: flex;\n                  justify-content: space-between; align-items: center; }\n.section-header .chevron { transition: transform 0.2s; }\n.section.collapsed .section-body { display: none; }\n.section.collapsed .chevron { transform: rotate(-90deg); }\n```\n\n**Code blocks** (post-merge items):\n```css\n.code-block { background: #1e293b; color: #e2e8f0; padding: 12px 16px;\n              border-radius: 6px; font-family: var(--mono); font-size: 12px;\n              line-height: 1.6; overflow-x: auto; white-space: pre; }\n```\n\n**Scenario boxes** (failure/success):\n```css\n.scenario-box { padding: 10px 14px; border-radius: 6px; font-size: 12px; }\n.scenario-box.failure { background: var(--red-bg); border-left: 3px solid var(--red); }\n.scenario-box.success { background: var(--green-bg); border-left: 3px solid var(--green); }\n```\n\n### Layout\n\n- **Container**: `max-width: 1100px; margin: 0 auto; padding: 24px 16px`.\n- **Section spacing**: `margin-bottom: 16px` between sections.\n- **Section body padding**: `0 24px 20px`.\n- **Grids**: `.convergence-grid` and `.scenario-grid` use 2-column CSS grid.\n- **Cards**: 1px border, 8px radius, 10-16px padding.\n- **Tables**: `width: 100%; border-collapse: collapse`. Cells: `8px 12px` padding.\n\n### Responsive\n\n```css\n@media (max-width: 768px) {\n  .stats { flex-direction: column; gap: 8px; }\n  .convergence-grid { grid-template-columns: 1fr; }\n  .scenario-grid { grid-template-columns: 1fr; }\n  .container { padding: 12px 8px; }\n  .arch-floating { width: 60%; }\n  .file-modal { width: 98vw; height: 95vh; }\n}\n```\n\n---\n\n## 8. Validation Checklist\n\nEvery check that must pass before the review pack is delivered to the reviewer.\n\n### Data Correctness\n\n- [ ] Zone registry loaded and parsed successfully.\n- [ ] Every file in `git diff --name-only main...HEAD` appears in the file-zone mapping.\n- [ ] Files that match no zone are flagged as `unzoned`.\n- [ ] Zone file counts match actual file count per zone from the diff.\n- [ ] Diff stats (additions, deletions, files, commits) match `gh pr view` output.\n- [ ] HEAD SHA in the header matches the actual HEAD of the PR branch.\n- [ ] CI check statuses match `gh pr checks` output for HEAD SHA.\n- [ ] Comment resolution count matches GitHub API response.\n- [ ] Every decision-zone claim is verified (file in zone's paths exists in diff). Unverified claims are flagged.\n- [ ] Every code snippet in post-merge items references a real file and valid line range in the diff.\n- [ ] Every file path link in decisions and findings references a file that exists in the diff.\n- [ ] Agentic review grades are from the defined set: A, B+, B, C, F, N/A.\n- [ ] Priority values are from the defined set: low, medium, high, cosmetic.\n- [ ] CI health classifications match timing thresholds (<1m=normal, 1-5m=acceptable, 5-10m=watch, >10m=refactor).\n\n### Visual Correctness\n\n- [ ] All 9 sections render without errors in both light and dark themes.\n- [ ] Theme toggle works: light, dark, system. Persists across page reload (localStorage).\n- [ ] Architecture diagram renders with correct zone positions, colors, and file count badges.\n- [ ] Floating minimap appears when scrolling past the inline diagram and disappears when scrolling back.\n- [ ] File modal opens, displays diff in all three views (side-by-side, unified, raw), and closes cleanly.\n- [ ] Scroll trapping works: background does not scroll when modal is open.\n- [ ] All expandable elements (sections, CI jobs, decisions, post-merge items, scenarios, convergence cards, history events) toggle correctly.\n- [ ] Zone click filtering updates all four filtered sections simultaneously.\n- [ ] Factory History tab switches cleanly and renders timeline + gate findings table.\n- [ ] Gate finding popovers position correctly and dismiss on timeout/Escape/click-outside.\n\n### Content Completeness\n\n- [ ] Every file in the diff appears in the agentic review (individually or grouped).\n- [ ] Every CI check on HEAD SHA is listed.\n- [ ] Every zone with files in the diff has a \"What Changed\" zone detail block.\n- [ ] Scenario count and status match actual evaluation results.\n- [ ] Spec list includes all governing specifications referenced in the zone registry.\n- [ ] Factory history covers the full commit range of the PR branch.\n\n### Deterministic Correctness Guarantees\n\n- [ ] File-to-Zone mapping is pure glob matching (no LLM).\n- [ ] Zone-to-Diagram is static registry lookup (no LLM).\n- [ ] Decision-to-Zone claims are LLM-produced but verified against file-zone mapping.\n- [ ] Code snippets are verified against actual diff lines.\n- [ ] CI-to-Zone coverage is statically defined.\n- [ ] Unverified claims are flagged with `[UNVERIFIED]`, not silently rendered.\n- [ ] The renderer (Pass 3) has zero intelligence \u2014 it is a pure template consuming verified data.\n\n---\n\n## 9. Project-Specific vs Universal\n\n### Universal (use across all projects)\n\n| Component | Notes |\n|-----------|-------|\n| HTML template (`assets/template.html`) | Data-driven, project-agnostic |\n| CSS design system | Embedded in template: all tokens, components, responsive rules |\n| Theme toggle JS | Embedded: light/dark/system with localStorage |\n| File modal JS | Embedded: side-by-side/unified/raw diff views |\n| Zone filtering JS | Embedded: cross-section highlight/dim/filter |\n| Expandable component JS | Embedded: sections, cards, rows |\n| Floating minimap JS | Embedded: IntersectionObserver + clone |\n| Pass 1 commands | This spec, Section 6: `git diff`, `gh pr checks`, zone matching |\n| Pass 2 agent prompt | This spec, Section 6: structured output requirements |\n| Pass 3 rendering logic | Template JS: pure `DATA` consumption |\n| Validation checklist | This spec, Section 8: all checks apply universally |\n| Data schema | This spec, Section 2: TypeScript interfaces |\n\n### Project-Specific (defined per project)\n\n| Component | Notes |\n|-----------|-------|\n| Zone registry | Project repo (e.g., `.claude/zone_registry.yaml`): path patterns, zone names, layers, specs |\n| Architecture diagram layout | Zone registry `position` fields: SVG coordinates per zone |\n| Spec file list | Zone registry `specs` fields: which specs govern which zones |\n| Scenario definitions | Project's `scenarios/` directory: holdout evaluation criteria |\n| Scenario categories | Defined by project: category names and colors |\n| CI job descriptions | Project's CI config + zone registry: what each job covers |\n| Factory history format | Project's factory configuration: iteration structure varies by factory type |\n| Diff data generator | Project repo: script to produce `pr_diff_data.json` |\n\n### Extending for New Projects\n\nTo produce a review pack for a new project:\n\n1. Create a zone registry (`zone_registry.yaml`) with the project's architecture zones, path patterns, and SVG positions.\n2. Run Pass 1 using the commands in Section 6 with the project's zone registry.\n3. Run Pass 2 with the agent prompt template, substituting the project's diff and zone data.\n4. Run Pass 3 with the universal HTML template and the merged JSON data.\n5. Run the validation checklist (Section 8) before delivering.\n\nThe template handles all rendering. The project only provides the data and the zone registry.\n\n---\n\n## Footer\n\nThe review pack includes a footer:\n```html\n<div class=\"footer\">\n  Generated by {agent_name} | {date} | HEAD: {headSha}<br>\n  <span style=\"font-size:10px\">Deterministic rendering from structured data &bull; Code diffs are ground truth</span>\n</div>\n```\n\nCSS: `.footer { text-align: center; padding: 16px; font-size: 11px; color: var(--text-muted); }`\n",
      "base": "# PR Review Pack \u2014 Build Specification\n\nComprehensive specification for generating interactive PR review packs. This is the authoritative source \u2014 the \"what\" and \"why\" of everything the skill produces.\n\n---\n\n## Implementations\n\n| What | Where |\n|------|-------|\n| This spec | `references/build-spec.md` (you are here) |\n| Skill entry point | `SKILL.md` (always loaded, summarizes pipeline) |\n| Focused references | `references/data-schema.md`, `section-guide.md`, `css-design-system.md`, `validation-checklist.md` |\n| HTML template | `assets/template.html` |\n| Diff extraction script | `scripts/generate_diff_data.py` |\n| v1 reference (PR #5) | `docs/pr_review_pack.html` (in repo root) |\n| High-level PR review pack section | Second brain: `0_claude/development_workflow.md` |\n\n---\n\n## 1. Overview\n\n### What It Is\n\nA self-contained interactive HTML file that lets a human reviewer understand a PR without reading the code. Open it in a browser, read the top-level summary, drill into any section. One read tells you whether to merge, what the risks are, and what to watch post-merge.\n\n### Who It's For\n\nThe PR reviewer (Joey). He reviews the report, not the code. The review pack is the artifact \u2014 generated when all PR readiness criteria are met.\n\n### Core Insight\n\nSeparate **mapping** (deterministic), **analysis** (LLM, but verifiable), and **rendering** (deterministic). Every LLM claim is checked against the zone registry and actual diff. Unverified claims are flagged, not silently rendered.\n\n### Three-Pass Pipeline Summary\n\n| Pass | Type | Input | Output | Intelligence |\n|------|------|-------|--------|-------------|\n| 1 \u2014 Diff Analysis | Deterministic | `git diff main...HEAD`, zone registry | `{file -> zone[]}` mapping, file stats | Zero |\n| 2 \u2014 Semantic Analysis | Delegated agent | Diff output, zone registry, project context | Summaries, decisions, findings, post-merge items | LLM (verifiable) |\n| 3 \u2014 Rendering | Deterministic | Verified JSON from Pass 1+2, HTML template | Self-contained HTML file | Zero |\n\n---\n\n## 2. Data Schema\n\nEvery piece of data that appears in the review pack. TypeScript-style interfaces. The top-level `ReviewPackData` object is injected into the HTML template as a `<script>const DATA = { ... };</script>` block.\n\n```typescript\ninterface ReviewPackData {\n  header: PRHeader;\n  zones: ArchitectureZone[];\n  specifications: Specification[];\n  scenarios: Scenario[];\n  whatChanged: WhatChanged;\n  adversarialFindings: AdversarialFinding[];\n  ciChecks: CICheck[];\n  decisions: Decision[];\n  convergence: ConvergenceResult;\n  postMergeItems: PostMergeItem[];\n  factoryHistory: FactoryHistory;\n  diffData: DiffData;\n}\n```\n\n### PRHeader\n\n```typescript\ninterface PRHeader {\n  title: string;                    // \"PR #5: Dark Factory v1\"\n  url: string;                      // Full GitHub PR URL\n  sourceBranch: string;             // \"factory/v1\"\n  targetBranch: string;             // \"main\"\n  headSha: string;                  // Short SHA, e.g. \"efbf3d4\"\n  additions: number;                // Total lines added\n  deletions: number;                // Total lines deleted\n  filesChanged: number;             // Total files in diff\n  commits: number;                  // Commit count on branch\n  factorySummary: string | null;    // \"Pre-crank \u00b7 3+validation iterations \u00b7 4 interventions\"\n}\n```\n\n### ArchitectureZone\n\n```typescript\ninterface ArchitectureZone {\n  id: string;                       // \"factory-orchestration\", \"product-rl\"\n  name: string;                     // Display name: \"Orchestration\", \"RL System\"\n  sublabel: string;                 // \"factory.yaml, SKILL.md\"\n  layer: \"factory\" | \"product\" | \"infra\";  // Determines color/row\n  paths: string[];                  // Glob patterns for zone membership\n  specs: string[];                  // Spec files governing this zone\n  fileCount: number;                // Files changed in this zone (from Pass 1)\n  position: ZonePosition;           // SVG layout coordinates\n}\n\ninterface ZonePosition {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n}\n```\n\n### Specification\n\n```typescript\ninterface Specification {\n  path: string;                     // \"specs/system.md\"\n  icon: string;                     // Unicode emoji: \"\ud83d\udcd6\", \"\ud83c\udfed\", \"\u2705\", \"\ud83d\udee1\"\n  description: string;              // \"MiniPong DQN component specifications\"\n}\n```\n\n### Scenario\n\n```typescript\ninterface Scenario {\n  name: string;                     // \"Environment Initialization\"\n  category: string;                 // \"environment\", \"training\", \"pipeline\", \"integration\"\n  zone: string;                     // Space-separated zone IDs: \"product-rl\", \"product-rl infrastructure\"\n  status: \"pass\" | \"advisory\" | \"fail\";\n  detail: ScenarioDetail;\n}\n\ninterface ScenarioDetail {\n  what: string;                     // What the scenario tests\n  how: string;                      // How it's evaluated\n  result: string;                   // Pass/fail description\n}\n```\n\n### WhatChanged\n\n```typescript\ninterface WhatChanged {\n  sourceAttribution: string;        // \"Generated from git diff main...HEAD by delegated diff-reading agent\"\n  infrastructure: string;           // Summary of factory/CI/tooling changes (HTML allowed)\n  product: string;                  // Summary of application code changes (HTML allowed)\n  zoneDetails: WhatChangedZoneDetail[];\n}\n\ninterface WhatChangedZoneDetail {\n  zone: string;                     // Zone ID matching ArchitectureZone.id\n  title: string;                    // \"Factory Orchestration\"\n  description: string;              // HTML description of changes in this zone\n}\n```\n\n### AdversarialFinding\n\n```typescript\ninterface AdversarialFinding {\n  file: string;                     // File path or glob: \"src/* (product code)\", \"check_test_quality.py\"\n  grade: \"A\" | \"B+\" | \"B\" | \"C\" | \"F\" | \"N/A\";\n  gradeSortOrder: number;           // 0=N/A, 1=B, 2=B+, 3=A (lower = worse, sorted worst-first)\n  zones: string;                    // Space-separated zone IDs: \"product-rl product-dashboard\"\n  zoneLayer: \"factory\" | \"product\" | \"infra\";  // Determines zone-tag color class\n  finding: string;                  // One-line summary: \"Stub detection false positive risk\"\n  detail: string;                   // Expanded explanation (HTML allowed)\n}\n```\n\n### CICheck\n\n```typescript\ninterface CICheck {\n  name: string;                     // \"factory-self-test\"\n  trigger: string;                  // \"push\", \"PR\", or combined\n  status: \"pass\" | \"fail\";\n  time: string;                     // \"19s\", \"4m 35s\", \"6m 18s\"\n  health: \"normal\" | \"acceptable\" | \"watch\" | \"refactor\";\n  detail: CICheckDetail;\n}\n\ninterface CICheckDetail {\n  coverage: string;                 // \"Factory infrastructure validation\"\n  gates: string;                    // \"Gate 1 (factory scripts only)\"\n  subChecks: CISubCheck[];          // Individual checks within this CI job\n  zones: string[];                  // Zone IDs this job validates\n  specs: string[];                  // Spec file paths\n  note: string | null;              // Warning note, e.g. \"6m18s is in the watch zone...\"\n}\n\ninterface CISubCheck {\n  name: string;                     // \"Lint factory scripts (ruff check)\"\n  command: string | null;           // \"ruff check scripts/ tests/\"\n  description: string;              // What it does\n  source: string | null;            // Test file path if applicable\n  zones: string[];                  // Zone IDs covered by this sub-check\n}\n```\n\n### Decision\n\n```typescript\ninterface Decision {\n  number: number;                   // Sequential: 1, 2, 3...\n  title: string;                    // \"Claude Code orchestrates, CI validates\"\n  rationale: string;                // One-line collapsed view\n  detailHtml: string;               // Full explanation (HTML, rendered in expanded body)\n  zones: string[];                  // Zone IDs affected (drives diagram highlighting)\n  files: DecisionFile[];            // Files associated with this decision\n}\n\ninterface DecisionFile {\n  path: string;                     // \".github/workflows/factory.yaml\"\n  change: string;                   // \"Validation-only mode + convergence PR + guards\"\n}\n```\n\n### ConvergenceResult\n\n```typescript\ninterface ConvergenceResult {\n  gates: ConvergenceGate[];\n  overall: ConvergenceOverall;\n}\n\ninterface ConvergenceGate {\n  name: string;                     // \"Gate 1 \u2014 Deterministic\"\n  status: \"passing\" | \"warning\" | \"failing\";\n  summary: string;                  // \"PASSING\", \"4 FINDINGS\", \"11/12 PASSING\"\n  detail: string;                   // Short description\n  expandedHtml: string;             // Full detail for expanded card (HTML)\n}\n\ninterface ConvergenceOverall {\n  status: \"passing\" | \"warning\" | \"failing\";\n  summary: string;                  // \"READY\"\n  detail: string;                   // Context note\n  expandedHtml: string;             // Full detail for expanded card (HTML)\n}\n```\n\n### PostMergeItem\n\n```typescript\ninterface PostMergeItem {\n  priority: \"low\" | \"medium\" | \"high\" | \"cosmetic\";\n  title: string;                    // \"Makefile regex fragility in strip_holdout.py\"\n  description: string;              // Context paragraph (HTML)\n  codeSnippet: CodeSnippet | null;\n  failureScenario: string;          // What could go wrong\n  successScenario: string;          // What \"fixed\" looks like\n  zones: string[];                  // Affected zone IDs\n}\n\ninterface CodeSnippet {\n  header: string;                   // \"## scripts/strip_holdout.py, lines 72-78\"\n  code: string;                     // Raw code content (rendered in <pre>)\n}\n```\n\n### FactoryHistory\n\n```typescript\ninterface FactoryHistory {\n  summary: FactoryHistorySummary;\n  events: FactoryEvent[];\n  gateFindings: GateFindingRow[];\n}\n\ninterface FactoryHistorySummary {\n  iterations: string;               // \"3 + validation\"\n  iterationsDetail: string;         // \"3 factory-loop iterations...\"\n  trajectory: string;               // \"Pre-crank\"\n  trajectoryDetail: string;         // \"Infrastructure PR \u2014 satisfaction score not applicable...\"\n}\n\ninterface FactoryEvent {\n  title: string;                    // \"Initial Codex output merged to factory/v1\"\n  type: \"automated\" | \"intervention\";\n  agents: EventAgent[];             // Who was involved\n  detail: string;                   // Short description\n  meta: string;                     // \"Commit: 67e5600 \u00b7 Feb 22\"\n  expandedHtml: string;             // Full detail for expanded view (HTML)\n}\n\ninterface EventAgent {\n  name: string;                     // \"CI (automated)\", \"Human (Joey)\", \"Claude Code (main)\"\n  type: \"automated\" | \"human\";      // Determines badge color\n}\n\ninterface GateFindingRow {\n  phase: string;                    // \"Iter 1-3 (factory-loop)\"\n  phasePopover: string;             // Popover text for phase cell\n  gate1: GateFindingCell;\n  gate2: GateFindingCell;\n  gate3: GateFindingCell;\n  action: string;                   // \"State commits pushed (before fix)\"\n}\n\ninterface GateFindingCell {\n  display: string;                  // \"pass\", \"4 findings\", \"11/12\", \"not run\"\n  type: \"pass\" | \"finding\" | \"notrun\";\n  popover: string;                  // Detailed popover text\n}\n```\n\n### DiffData\n\nLoaded asynchronously from a companion JSON file (`pr_diff_data.json`), or embedded inline for fully self-contained packs.\n\n```typescript\ninterface DiffData {\n  files: Record<string, FileDiff>;\n}\n\ninterface FileDiff {\n  additions: number;\n  deletions: number;\n  status: \"added\" | \"modified\" | \"deleted\" | \"renamed\";\n  diff: string;                     // Unified diff text\n  raw: string;                      // Full file content (for raw view)\n}\n```\n\n---\n\n## 3. Architecture Zone Registry Specification\n\nThe zone registry is the linchpin of deterministic correctness. Every project maintains one as a declarative YAML file.\n\n### Registry Format\n\n```yaml\n# .claude/zone_registry.yaml (or project-specific location)\nzones:\n  factory-orchestration:\n    name: \"Orchestration\"\n    sublabel: \"factory.yaml, SKILL.md\"\n    layer: factory\n    paths:\n      - \".claude/skills/factory-orchestrate/**\"\n      - \".github/workflows/factory.yaml\"\n    specs:\n      - \"docs/dark_factory.md\"\n\n  holdout-isolation:\n    name: \"Holdout Isolation\"\n    sublabel: \"strip/restore scripts\"\n    layer: factory\n    paths:\n      - \"scripts/strip_holdout.py\"\n      - \"scripts/restore_holdout.py\"\n      - \"scenarios/**\"\n    specs:\n      - \"docs/factory_validation_strategy.md\"\n\n  product-rl:\n    name: \"RL System\"\n    sublabel: \"envs, rl, agents, train, configs\"\n    layer: product\n    paths:\n      - \"src/envs/**\"\n      - \"src/rl/**\"\n      - \"src/agents/**\"\n      - \"src/train/**\"\n      - \"configs/**\"\n    specs:\n      - \"specs/system.md\"\n```\n\n### How to Define Zones for Any Project\n\n1. Identify the major architecture areas (3-12 zones typical).\n2. Assign each zone a unique kebab-case `id`.\n3. Classify each zone into a `layer`: `factory` (build/CI infrastructure), `product` (application code), or `infra` (supporting infrastructure, docs, configs).\n4. List glob patterns for file paths that belong to each zone. Use `**` for recursive matching. A file can belong to multiple zones.\n5. Link each zone to its governing spec files.\n6. Define SVG positions for the architecture diagram layout.\n\n### Path Pattern Matching Rules\n\n- Patterns use glob syntax: `*` matches within a directory, `**` matches across directories.\n- Matching is performed against the file's path relative to the repo root.\n- A file matches a zone if it matches ANY of that zone's path patterns.\n- A file can match multiple zones \u2014 this is expected (e.g., integration test files may belong to both a product zone and a test zone).\n- Files that match no zone are assigned to a catch-all `unzoned` category and flagged in the review pack.\n\n### Zone-to-Diagram Position Mapping\n\nThe zone registry includes SVG coordinates for rendering. Zones are arranged in rows by layer:\n\n| Layer | Row Label | SVG y range | Fill color | Stroke color |\n|-------|-----------|-------------|------------|-------------|\n| `factory` | \"Factory Infrastructure\" | 36-116 | `#dbeafe` | `#3b82f6` |\n| `product` | \"Product Code\" | 166-246 | `#dcfce7` | `#22c55e` |\n| `infra` | \"Infrastructure & Docs\" | 286-346 | `#f3e8ff` | `#8b5cf6` |\n\nEach zone specifies `x`, `y`, `width`, `height` for its `<rect>` element.\n\n### Verification Rules\n\n1. **File-to-Zone (Pass 1)**: Pure glob matching. No LLM. Zero hallucination risk.\n2. **Decision-to-Zone (Pass 2)**: LLM-produced claim. Verified by checking that at least one file in the diff touches a path in that zone's patterns. Unverified claims get a `[UNVERIFIED]` flag.\n3. **Zone-to-Diagram**: Static lookup from registry. No verification needed.\n4. **CI-to-Zone**: Static mapping defined in the registry or the CI check data. No LLM.\n\n---\n\n## 4. Section-by-Section Build Guide\n\n### Section 1: Architecture (Baseline + Update)\n\n**What it shows**: An inline SVG diagram with all architecture zones arranged in rows by layer. Two toggle views: \"Update (this PR)\" shows zones with file-count badges, \"Baseline (before merge)\" dims all zones to show the pre-merge state. A floating minimap version appears when the inline diagram scrolls out of view.\n\n**Data source**: Pass 1 (zone-to-file mapping, file counts). Zone positions from registry.\n\n**Required data fields**: `ArchitectureZone[]` \u2014 every field.\n\n**Interactive behaviors**:\n- **Zone click**: Click a zone box to filter adversarial review, scenarios, and \"What Changed\" to that zone. Click again (or click SVG background) to reset.\n- **Baseline/Update toggle**: Toggle buttons switch between views. Baseline sets all zone boxes to `opacity: 0.25`. Update resets to full opacity.\n- **Floating minimap**: When the inline diagram scrolls out of the viewport (IntersectionObserver, threshold 0.1), a floating copy appears fixed at `top: 16px; right: 16px; width: 40%; max-width: 480px`. The floating diagram has the same zone-click behavior. A dismiss button (X) hides the floating diagram permanently for the session (`floatingDismissed = true`).\n\n**Visual design**:\n- SVG viewBox: `0 0 780 360`.\n- Row labels: `<text>` with class `arch-row-label` (10px, 700 weight, uppercase, `#9ca3af`).\n- Zone boxes: `<rect>` with `rx=\"8\"`, layer-specific fill/stroke.\n- File count badges: `<circle>` with layer-specific fill + `<text>` in white.\n- Flow arrows between factory zones: `<line>` with arrowhead marker.\n- Legend below the diagram: `.arch-legend` with swatches and instructions.\n\n**SVG structure per zone**:\n```html\n<rect class=\"zone-box\" data-zone=\"{id}\" x=\"{x}\" y=\"{y}\" width=\"{w}\" height=\"{h}\"\n      rx=\"8\" fill=\"{layerFill}\" stroke=\"{layerStroke}\" stroke-width=\"1.5\"/>\n<text x=\"{cx}\" y=\"{labelY}\" text-anchor=\"middle\" class=\"zone-label\"\n      fill=\"{layerTextColor}\">{name}</text>\n<text x=\"{cx}\" y=\"{sublabelY}\" text-anchor=\"middle\" class=\"zone-sublabel\">{sublabel}</text>\n<circle class=\"zone-count-bg\" cx=\"{badgeCx}\" cy=\"{badgeCy}\" r=\"{badgeR}\"\n        fill=\"{layerStroke}\"/>\n<text class=\"zone-file-count\" x=\"{badgeCx}\" y=\"{badgeCy + 4}\" text-anchor=\"middle\">\n  {fileCount}\n</text>\n```\n\n**Validation checks**:\n- Every zone in the registry appears in the diagram.\n- File counts match the actual diff (sum of files matching each zone's patterns).\n- Floating diagram is a clone of the inline diagram with identical zone data.\n\n### Section 3: Spec & Scenarios\n\n**What it shows**: Two subsections. \"Specifications\" lists the spec files that drove the work, each with an icon and description. \"Scenarios\" shows a grid of evaluation scenarios with category pills, pass/fail status, and expandable detail cards.\n\n**Data source**: Pass 2 (spec identification, scenario evaluation results). Scenario status from actual test/evaluation runs.\n\n**Required data fields**: `Specification[]`, `Scenario[]`.\n\n**Interactive behaviors**:\n- Scenario cards are clickable \u2014 toggle `.open` class to show/hide the detail panel.\n- When a zone filter is active (from Section 2), scenario cards with non-matching zones get `.zone-dimmed` (opacity 0.35), matching ones get `.zone-glow` (blue box-shadow).\n\n**Visual design**:\n- Specs: `<ul class=\"spec-list\">` with icon + `<code>` path + description per `<li>`.\n- Scenarios: `.scenario-grid` (2-column CSS grid, gap 8px). Each card is `.scenario-card` with `.name`, `.status`, and `.scenario-card-detail` (hidden until `.open`).\n- Category pills: `.scenario-category` with color-coded modifiers:\n  - `.cat-environment`: green (`#dcfce7`/`#166534`)\n  - `.cat-training`: blue (`#dbeafe`/`#1d4ed8`)\n  - `.cat-pipeline`: purple (`#f3e8ff`/`#6d28d9`)\n  - `.cat-integration`: orange (`#fff7ed`/`#9a3412`)\n- Scenario legend: `.scenario-legend` flex row above the grid.\n- Detail panel: `<dl>` with `<dt>What</dt><dd>...</dd>`, `<dt>How</dt>`, `<dt>Result</dt>`.\n\n```html\n<div class=\"scenario-card\" data-zone=\"product-rl\" onclick=\"this.classList.toggle('open')\">\n  <div class=\"name\">Environment Initialization\n    <span class=\"scenario-category cat-environment\">environment</span>\n  </div>\n  <div class=\"status\" style=\"color:var(--green)\">&#x2713; Passing</div>\n  <div class=\"scenario-card-detail\">\n    <dl>\n      <dt>What</dt><dd>{scenario.detail.what}</dd>\n      <dt>How</dt><dd>{scenario.detail.how}</dd>\n      <dt>Result</dt><dd>{scenario.detail.result}</dd>\n    </dl>\n  </div>\n</div>\n```\n\n**Validation checks**:\n- Every spec file listed actually exists in the repo.\n- Scenario count matches actual evaluation output.\n- Status colors match status values (pass=green, advisory=yellow, fail=red).\n\n### Section 4: What Changed\n\n**What it shows**: Two-layer summary of changes. Default view shows infrastructure and product summaries. When a zone filter is active, shows zone-specific detail blocks instead.\n\n**Data source**: Pass 2 (delegated agent reads diff, produces summaries). Code diffs are ground truth \u2014 agent summaries must be consistent with actual diff.\n\n**Required data fields**: `WhatChanged.sourceAttribution`, `WhatChanged.infrastructure`, `WhatChanged.product`, `WhatChanged.zoneDetails[]`.\n\n**Interactive behaviors**:\n- Default view (`.wc-default`) visible when no zone filter active.\n- Zone-specific detail blocks (`.wc-zone-detail[data-zone]`) shown when matching zone filter is active. Multiple can be visible if multiple zones are selected.\n- If a zone filter is active but no zone details match, fall back to default view.\n\n**Visual design**:\n- Source attribution: `<p>` with 11px font, `--text-muted` color, `<code>` for the git command.\n- Infrastructure and product summaries: `<p>` elements with `<strong>` labels and `<code>` for file/tool references.\n- Zone details: `.wc-zone-detail` with `<h4>` heading and `<p>` description.\n\n**Validation checks**:\n- Source attribution always states the data source: \"Generated from `git diff main...HEAD` by delegated diff-reading agent.\"\n- Zone detail blocks exist for every zone that has files in the diff.\n- Summary content is consistent with the actual diff \u2014 no files or changes mentioned that don't exist.\n\n### Section 5: Adversarial Review\n\n**What it shows**: A scrollable table of graded findings. Columns: File, Grade, Zone, Notable. Rows sorted by severity (worst first). Each row is expandable to show detailed findings.\n\n**Data source**: Pass 2 (adversarial review agent grades each file/group).\n\n**Required data fields**: `AdversarialFinding[]`.\n\n**Interactive behaviors**:\n- Click a row to toggle its detail row (`.adv-detail-row`).\n- Zone filtering: When a zone is active, non-matching rows get `.collapsed-row` class (24px max-height, 0.5 opacity, truncated text, grade/zone badges hidden). A \"No adversarial findings in this zone\" message appears if zero rows match.\n- Scrollable container: `.adv-scroll` with `max-height: 500px; overflow-y: auto`.\n\n**Visual design**:\n- Grade pills: `.grade` class (28x28px, 6px border-radius, centered text) with modifiers:\n  - `.a`: green background/text\n  - `.b`: yellow background/text\n  - `.c`: orange background/text\n  - `.f`: red background/text\n  - `.na`: gray background/text (not reviewed)\n- Zone tags: `.zone-tag` with layer-specific modifiers: `.factory` (blue), `.product` (green), `.infra` (purple).\n- Detail rows: `.adv-detail-row td` with `#fafbfc` background, 12px font, `colspan=\"4\"`.\n\n```html\n<tr class=\"adv-row\" data-zones=\"gate-2-nfr\" data-grade-sort=\"1\" onclick=\"toggleAdvDetail(this)\">\n  <td><code>check_test_quality.py</code></td>\n  <td><span class=\"grade b\">B</span></td>\n  <td><span class=\"zone-tag factory\">gate-2-nfr</span></td>\n  <td>Stub detection false positive risk</td>\n</tr>\n<tr class=\"adv-detail-row\" data-zones=\"gate-2-nfr\">\n  <td colspan=\"4\">{finding.detail}</td>\n</tr>\n```\n\n**Validation checks**:\n- Every file in the diff appears in the adversarial review (individually or grouped).\n- Grade values are one of the defined set: A, B+, B, C, F, N/A.\n- Zone tags on each row match the file's actual zone membership from Pass 1.\n- Rows are sorted by `gradeSortOrder` ascending (worst first).\n\n### Section 6: CI Performance\n\n**What it shows**: A table of CI checks with expandable detail rows. Columns: Check, Status, Time, expand chevron. Each job expands to show coverage, gates, sub-checks (themselves expandable), zones, and spec references.\n\n**Data source**: Pass 1 (`gh pr checks` output, CI run timing). Pass 2 (coverage descriptions, zone mapping).\n\n**Required data fields**: `CICheck[]`.\n\n**Interactive behaviors**:\n- Click a row to toggle its detail row. The chevron rotates 180 degrees (`.ci-open .ci-chevron`).\n- Sub-checks within a detail row are independently expandable (`.ci-check-item` toggles `.open`). Each sub-check has its own chevron that rotates 90 degrees.\n\n**Visual design**:\n- Status: `.badge.pass` or `.badge.fail`.\n- Time display: `.time-label` with health-based color modifier:\n  - `.normal` (green): under 1 minute\n  - `.acceptable` (yellow): 1-5 minutes\n  - `.watch` (orange): 5-10 minutes\n  - `.refactor` (red): over 10 minutes\n- Sub-text: `.time-health-sub` (10px, muted) showing the health classification word.\n- Health tag: `.health-tag` with same color modifiers (small uppercase pill).\n- Sub-checks: `.ci-check-item` with `.ci-check-summary` (flex row with small chevron) and `.ci-check-detail` (hidden until `.open`).\n- Time thresholds legend: `<p>` below the table with threshold definitions.\n\n**Validation checks**:\n- Every CI check from `gh pr checks` on HEAD SHA appears.\n- Status matches actual CI results.\n- Time values are accurate.\n- Health classification matches the time thresholds: <1m=normal, 1-5m=acceptable, 5-10m=watch, >10m=refactor.\n\n### Section 7: Key Decisions\n\n**What it shows**: A list of decision cards, each expandable. Collapsed view: number + title + one-line rationale. Expanded view: full explanation, zone tags, and a file table showing affected files with change descriptions.\n\n**Data source**: Pass 2 (agent identifies architectural decisions from diff and commit messages).\n\n**Required data fields**: `Decision[]`.\n\n**Interactive behaviors**:\n- Click a decision header to expand (only one open at a time \u2014 expanding one closes others).\n- When a decision expands, its `data-zones` attribute drives zone highlighting: matching zones get `.highlighted` + `stroke-width: 3` in the diagram, others get `.dimmed` (opacity 0.12).\n- When a decision closes, zones reset.\n- File paths in the decision's file table are clickable \u2014 open the file modal.\n\n**Visual design**:\n- `.decision-card` with 1px border, 8px radius.\n- `.decision-header`: flex row with `.decision-num` (blue, 14px bold), `.decision-title` (13px 600 weight), `.decision-rationale` (12px secondary color).\n- `.decision-body`: hidden until `.open`, bordered top, contains explanation paragraph + `.decision-zones` (flex-wrap zone tags) + `.decision-files` table.\n\n```html\n<div class=\"decision-card\" data-zones=\"factory-orchestration\">\n  <div class=\"decision-header\" onclick=\"toggleDecision(this.parentElement)\">\n    <span class=\"decision-num\">1</span>\n    <div>\n      <div class=\"decision-title\">{decision.title}</div>\n      <div class=\"decision-rationale\">{decision.rationale}</div>\n    </div>\n  </div>\n  <div class=\"decision-body\">\n    <p>{decision.detailHtml}</p>\n    <div class=\"decision-zones\">\n      <span class=\"zone-tag factory\">{zone}</span>\n    </div>\n    <div class=\"decision-files\">\n      <table>\n        <thead><tr><th>File</th><th>Change</th></tr></thead>\n        <tbody>\n          <tr><td><code class=\"file-path-link\">{file.path}</code></td><td>{file.change}</td></tr>\n        </tbody>\n      </table>\n    </div>\n  </div>\n</div>\n```\n\n**Validation checks**:\n- Every decision's zone claims are verified: at least one file in the diff touches a path in that zone's patterns. Unverified claims are flagged `[UNVERIFIED]`.\n- File paths in decision file tables exist in the actual diff.\n- Decisions are numbered sequentially starting from 1.\n\n### Section 8: Convergence Result\n\n**What it shows**: A 2x2 grid of cards showing gate-by-gate status and overall readiness. Each card is expandable. Collapsed: gate name, status value (colored), and short description. Expanded: detailed check lists and context.\n\n**Data source**: Pass 1 (gate pass/fail from test runs), Pass 2 (interpretation and context).\n\n**Required data fields**: `ConvergenceResult.gates[]`, `ConvergenceResult.overall`.\n\n**Interactive behaviors**:\n- Click a card to toggle `.open` and show `.conv-card-detail`.\n\n**Visual design**:\n- `.convergence-grid`: 2-column CSS grid, 12px gap.\n- `.conv-card`: bordered card with `.conv-status` (20px, 700 weight) colored by status:\n  - `.passing`: `#166534`\n  - `.warning`: `#854d0e`\n  - `.failing`: `#991b1b`\n- `.conv-detail`: 12px secondary text below status.\n- `.conv-card-detail`: hidden until `.open`, top-bordered, contains `<ul>` lists and context.\n\n**Validation checks**:\n- Gate statuses match actual test/evaluation run results.\n- Satisfaction scores (if applicable) are computed from real scenario results, not estimated.\n- Overall status is logically consistent with individual gate statuses.\n\n### Section 9: Post-Merge Items\n\n**What it shows**: A list of expandable items ordered by priority. Each item: priority badge + title (collapsed), with code snippet + failure scenario + success/resolution scenario (expanded).\n\n**Data source**: Pass 2 (adversarial reviewer identifies post-merge risks).\n\n**Required data fields**: `PostMergeItem[]`.\n\n**Interactive behaviors**:\n- Click a `.pm-header` to toggle `.pm-body` visibility.\n- File paths in code snippets are clickable (open file modal).\n\n**Visual design**:\n- `.pm-item`: bordered card, 8px radius.\n- `.pm-header`: flex row with `.priority` badge and title.\n- Priority badges: `.priority` (10px, 700 weight, uppercase) with modifiers:\n  - `.low`: blue (`--blue-bg`/`#1d4ed8`)\n  - `.medium`: yellow (`--yellow-bg`/`#854d0e`)\n  - `.high`: red (`--red-bg`/`#991b1b`) \u2014 not present in v1 but defined for future use\n  - `.cosmetic`: gray (`--gray-bg`/`--gray`)\n- Code snippets: `.code-block` \u2014 dark background (`#1e293b`), monospace, 12px, pre-formatted.\n- Failure scenario: `.scenario-box.failure` \u2014 red-tinted background, red left border (3px).\n- Success scenario: `.scenario-box.success` \u2014 green-tinted background, green left border (3px).\n- Both scenarios have `.scenario-label` (11px, 700 weight, uppercase).\n\n```html\n<div class=\"pm-item\">\n  <div class=\"pm-header\" onclick=\"this.parentElement.classList.toggle('open')\">\n    <span class=\"priority medium\">MEDIUM</span>\n    <span>{item.title}</span>\n  </div>\n  <div class=\"pm-body\">\n    <p>{item.description}</p>\n    <div class=\"code-block\">{item.codeSnippet.header}\\n{item.codeSnippet.code}</div>\n    <div class=\"scenario-box failure\">\n      <div class=\"scenario-label\">Failure scenario</div>\n      {item.failureScenario}\n    </div>\n    <div class=\"scenario-box success\">\n      <div class=\"scenario-label\">Resolution</div>\n      {item.successScenario}\n    </div>\n  </div>\n</div>\n```\n\n**Validation checks**:\n- Code snippets reference real files and line ranges that exist in the diff.\n- Priority is one of the defined set: low, medium, high, cosmetic.\n- Failure and success scenarios are concrete and specific \u2014 not generic advice.\n\n### Factory History Tab\n\n**What it shows**: A secondary tab (separate from the Review tab) providing convergence loop visibility. Contains: summary cards (iterations + trajectory), a chronological timeline of events, and a gate findings by iteration table.\n\n**Data source**: Pass 1 (CI run history, commit log), Pass 2 (event interpretation, intervention classification).\n\n**Required data fields**: `FactoryHistory`.\n\n**Interactive behaviors**:\n- Top-level tab switch: \"Review\" and \"Factory History\" buttons in `.tab-bar`.\n- Summary cards (iterations, trajectory) are expandable.\n- Timeline events are expandable (click to toggle `.history-event-detail`).\n- Gate findings cells have popovers \u2014 click a `.gate-clickable` cell to show a positioned popover with detail text. Popovers auto-dismiss after 5 seconds or on Escape/click-outside.\n\n**Visual design**:\n- Tab bar: `.tab-bar` with `.tab-btn` buttons. Active tab: blue text + blue `border-bottom`.\n- Legend: `.history-legend` with colored dots \u2014 blue for automated, orange for interventions.\n- Summary: `.convergence-grid` (2-column) with `.conv-card` cards.\n- Timeline: `.history-timeline` with left-aligned vertical line (`::before` pseudo-element, 2px wide, `--border` color). Events are `.history-event` cards with colored dot indicators (`::before`, 10px circle):\n  - Blue (`--blue`) for automated events\n  - Orange (`--orange`) for interventions (`.history-event.intervention`)\n- Agent badges: `.event-agent` (10px, blue background) with `.human` modifier (orange background).\n- Gate findings table: standard table with `.gate-clickable` cells (dashed underline, cursor pointer). Popovers: `.gate-popover` (absolute positioned, white background, border, shadow).\n\n**Validation checks**:\n- Every commit in the PR branch appears as an event or is covered by an event range.\n- Intervention events are accurately classified (human vs. agent).\n- Gate finding statuses match actual CI results per iteration.\n\n---\n\n## 5. Interactive Features Specification\n\n### Theme Toggle (Light / Dark / System)\n\nThree-button toggle in the header: sun (light), moon (dark), gear (system).\n\n**Persistence**: `localStorage.getItem('pr-pack-theme')` / `localStorage.setItem(...)`. Default: `'system'`.\n\n**Mechanism**: Set `data-theme` attribute on `<html>` element. `'system'` checks `window.matchMedia('(prefers-color-scheme: dark)')` and listens for changes.\n\n**CSS override pattern**: All dark-mode overrides use `[data-theme=\"dark\"]` attribute selector:\n\n```css\n[data-theme=\"dark\"] {\n  --text: #e5e7eb;\n  --text-secondary: #9ca3af;\n  --border: #374151;\n  --bg: #111827;\n  /* ... all token overrides ... */\n}\n[data-theme=\"dark\"] .section { background: #1f2937; }\n```\n\n**Button markup**:\n```html\n<div class=\"theme-toggle\">\n  <button onclick=\"setTheme('light')\" data-theme-btn=\"light\">&#x2600;</button>\n  <button onclick=\"setTheme('dark')\" data-theme-btn=\"dark\">&#x1F319;</button>\n  <button onclick=\"setTheme('system')\" data-theme-btn=\"system\">&#x2699;</button>\n</div>\n```\n\n### Architecture Diagram: Inline View + Floating Minimap\n\n**Inline**: SVG in the Architecture section body. Full-size, interactive.\n\n**Floating minimap**: A cloned copy of the SVG, positioned `fixed` at top-right. Appears via IntersectionObserver when the inline diagram scrolls out of view (threshold 0.1). Animated with CSS transitions: `opacity 0.3s ease, transform 0.3s ease`. Entry: `translateX(40px) -> translateX(0)`. Dismiss button permanently hides it for the session (`floatingDismissed = true`).\n\n**Zone click handlers**: Attached to both inline and floating diagrams. Both share the same `highlightZones()` / `resetZones()` functions, so clicking in either updates both.\n\n### Zone Click Filtering\n\nWhen a zone is clicked, `highlightZones([zoneId])` is called. This function updates four sections simultaneously:\n\n1. **Architecture diagram**: Matching zones get `.highlighted` (stroke-width: 3, brightness 0.92). Non-matching zones get `.dimmed` (opacity 0.12). Both inline and floating diagrams update.\n2. **Adversarial review**: Non-matching rows get `.collapsed-row` (24px, 0.5 opacity, truncated). Matching rows display normally. If zero rows match, show `#adv-no-match` message.\n3. **Scenario cards**: Non-matching cards get `.zone-dimmed` (opacity 0.35). Matching cards get `.zone-glow` (2px blue box-shadow).\n4. **What Changed**: Default view hides. Zone-specific detail blocks matching the active zone become visible.\n\n**Reset**: Click the SVG background, click an already-selected zone, or close a decision card. `resetZones()` removes all filter classes and restores default views.\n\n### Decision Zone Highlighting\n\nOpening a decision card calls `highlightZones(decision.zones)`. Only one decision can be open at a time \u2014 opening a new one closes the previous. Closing the last decision calls `resetZones()`.\n\n### File Modal (Diff Viewer)\n\nFull-screen modal triggered by clicking any `.file-path-link` element. Three view tabs: Side-by-side, Unified, Raw file.\n\n**Modal structure**:\n- Overlay: `.file-modal-overlay` (fixed, full viewport, semi-transparent black background). Click overlay to close.\n- Modal: `.file-modal` (95vw, max 1400px, 90vh, flex column).\n- Header: file path (monospace), addition/deletion stats (green/red), close button.\n- Toolbar: view tabs + \"View on GitHub\" link.\n- Body: scrollable diff content.\n\n**Scroll trapping**: When modal opens, `document.body.style.overflow = 'hidden'`. On close, `overflow` resets to `''`.\n\n**View tabs**: User's tab selection persists across modal opens (stored in `currentView` variable, not reset on each open).\n\n**Diff rendering**:\n- **Side-by-side**: Parses unified diff into `{type, oldLn, newLn, oldText, newText}` pairs. Added lines get green background, deleted lines get red, context lines get neutral. New/deleted files show single-pane with a banner (\"New file\", \"Deleted file\").\n- **Unified**: Standard unified diff rendering with old/new line numbers, hunk headers, colored add/del/context lines.\n- **Raw file**: Full file content with line numbers and syntax highlighting.\n\n**Syntax highlighting**: Built-in highlighter for Python, YAML, Markdown, Shell, JavaScript. Pattern-based (regex, not AST). Colors match VS Code dark theme:\n- Strings: `#ce9178`\n- Comments: `#6a9955`\n- Keywords: `#c586c0`\n- Constants: `#569cd6`\n- Numbers: `#b5cea8`\n- Decorators/functions: `#dcdcaa`\n- Variables: `#9cdcfe`\n\n**Close**: Escape key or click overlay or click X button.\n\n**Data loading**: Diff data loaded asynchronously via `fetch('pr_diff_data.json')`. Cached in `diffDataCache` after first load. Generate the companion JSON with a script (e.g., `generate_diff_data.py`).\n\n### Expandable CI Jobs, Decisions, Post-Merge Items\n\nAll three use the same pattern:\n1. Container element (`.expandable` row, `.decision-card`, `.pm-item`).\n2. Click handler toggles a class (`.open`, `.ci-open`).\n3. CSS controls visibility of detail element (`display: none` -> `display: block/table-row`).\n4. Chevron indicator rotates on open state.\n\n### Gate Findings Popovers\n\nCells in the gate findings table are `.gate-clickable`. On click, `showGatePopover(event, text)` positions a `.gate-popover` div below the clicked element. Newlines in popover text are rendered as `<br>`. Auto-dismiss after 5 seconds. Close on Escape or click outside.\n\n---\n\n## 6. Three-Pass Pipeline: Agent Delegation Guide\n\n### Pass 1 \u2014 Diff Analysis (Deterministic)\n\n**Executor**: Shell script or the main agent executing git commands. Zero LLM involvement.\n\n**Commands to run**:\n\n```bash\n# 1. Get the full diff\ngit diff main...HEAD > /tmp/pr_diff.txt\n\n# 2. Get the file list with stats\ngit diff --stat main...HEAD > /tmp/pr_stats.txt\n\n# 3. Get the file list (paths only, with status indicator)\ngit diff --name-status main...HEAD > /tmp/pr_files.txt\n\n# 4. Get PR metadata\ngh pr view <PR_NUMBER> --json title,url,headRefName,baseRefName,commits,additions,deletions,changedFiles,headRefOid\n\n# 5. Get CI check results\ngh pr checks <PR_NUMBER>\n\n# 6. Get comment status\ngh api repos/{owner}/{repo}/pulls/{pr}/comments --jq 'length'\ngh api repos/{owner}/{repo}/pulls/{pr}/reviews --jq '[.[] | select(.state == \"CHANGES_REQUESTED\")] | length'\n```\n\n**Processing**:\n\n1. Load the zone registry (`zone_registry.yaml`).\n2. For each file in the diff, match against zone path patterns. Produce `{file -> zone[]}` mapping.\n3. Count files per zone.\n4. Compute diff stats (additions, deletions, file count).\n5. Classify CI check health based on timing thresholds.\n\n**Output format**: JSON object containing:\n```json\n{\n  \"header\": { \"title\": \"...\", \"url\": \"...\", \"headSha\": \"...\", \"...\" : \"...\" },\n  \"fileZoneMapping\": { \"path/to/file.py\": [\"zone-id-1\", \"zone-id-2\"] },\n  \"zoneFileCounts\": { \"zone-id\": 5 },\n  \"ciChecks\": [ { \"name\": \"...\", \"status\": \"pass\", \"time\": \"19s\", \"health\": \"normal\" } ],\n}\n```\n\n### Pass 2 \u2014 Semantic Analysis (Delegated Agent)\n\n**Executor**: A separate agent instance (not the main thread). Use the `researcher` or `code-reviewer` subagent type. The agent reads the diff and zone registry but does NOT read the main thread's conversation context.\n\n**What the agent reads**:\n1. The full diff (`git diff main...HEAD`)\n2. The zone registry\n3. The file-zone mapping from Pass 1\n4. Project spec files referenced in the zone registry\n5. Commit messages (`git log main...HEAD --oneline`)\n\n**What the agent produces**:\n1. `WhatChanged` \u2014 infrastructure and product summaries + per-zone detail blocks\n2. `AdversarialFinding[]` \u2014 graded review of every file or file group\n3. `Decision[]` \u2014 architectural decisions identified from the diff\n4. `PostMergeItem[]` \u2014 risks and follow-ups with code snippets\n5. `Scenario[]` status \u2014 if scenarios exist, run them and report results\n6. `ConvergenceResult` \u2014 gate-by-gate status\n7. `FactoryHistory` \u2014 timeline of events (from commit log and CI history)\n\n**Agent prompt template**:\n\n```\nYou are a PR review agent producing structured data for a review pack.\n\n## Inputs\n- Full diff: {diff}\n- Zone registry: {zone_registry}\n- File-zone mapping: {file_zone_mapping}\n- Commit log: {commit_log}\n\n## Task\nProduce a JSON object with these fields:\n\n### whatChanged\nSummarize what changed in two layers: infrastructure and product.\nFor each zone with files in the diff, produce a zone detail block.\nGround truth: the diff. Do not invent changes not in the diff.\n\n### adversarialFindings\nGrade every file or logical file group. Use grades:\n- A: Clean, no issues\n- B+: Minor non-blocking concerns\n- B: Moderate concerns worth noting\n- C: Issues that should be fixed\n- F: Critical problems\n- N/A: Not reviewed (with justification)\n\nSort by severity (worst first). For each finding, include:\n- file: path or glob\n- grade: letter grade\n- zones: space-separated zone IDs from the mapping\n- finding: one-line summary\n- detail: expanded explanation\n\n### decisions\nIdentify architectural decisions from the diff. For each:\n- title: what was decided\n- rationale: one-line summary of why\n- zones: affected zone IDs (MUST have at least one file in the diff touching that zone's paths)\n- files: file paths and change descriptions\n- detailHtml: full explanation\n\n### postMergeItems\nIdentify risks and follow-ups. For each:\n- priority: low/medium/high/cosmetic\n- title: what needs attention\n- codeSnippet: { header: \"file, lines X-Y\", code: \"actual code\" } \u2014 must reference real code in the diff\n- failureScenario: concrete description of what goes wrong\n- successScenario: concrete description of the resolution\n\n### convergence\nGate-by-gate status with detailed breakdown.\n\n### factoryHistory\nTimeline of events from commit log and CI history.\n\n## Verification Rules\n- Every zone claim on a decision MUST have >= 1 file in the diff touching that zone's paths. If not, mark it [UNVERIFIED].\n- Every code snippet MUST reference actual lines from the diff. Fabricated snippets fail verification.\n- Summaries must be consistent with the actual diff. Do not mention files or changes that are not present.\n```\n\n**Verification rules (applied after agent produces output)**:\n1. Decision-zone claims: For each decision, for each claimed zone, check that at least one file in `decision.files` matches a path pattern in that zone. Flag unverified claims.\n2. Code snippets: For each post-merge item with a code snippet, verify the file exists in the diff and the referenced lines exist. Flag invalid references.\n3. File references: Every file path mentioned in any output must exist in `git diff --name-only main...HEAD`.\n\n### Pass 3 \u2014 Rendering (Deterministic)\n\n**Executor**: Template engine or direct string interpolation. Zero LLM involvement.\n\n**Process**:\n1. Merge Pass 1 and Pass 2 outputs into a single `ReviewPackData` JSON object.\n2. Run verification checks on the merged data. Flag any failures.\n3. Inject the JSON into the HTML template: `<script>const DATA = {json};</script>`.\n4. The template's JavaScript reads `DATA` and renders all sections.\n\n**Template contract**: The HTML template is a pure function of `DATA`. It contains:\n- All CSS (inline in `<style>`).\n- All HTML structure with placeholder containers.\n- All JavaScript that reads `DATA` and populates the DOM.\n- Zero intelligence \u2014 no summarization, no analysis, no decision-making.\n\n**Output**: A single `.html` file. Self-contained. No external dependencies. Opens in any modern browser.\n\n---\n\n## 7. CSS Design System\n\n### CSS Custom Properties (Color Tokens)\n\n```css\n:root {\n  /* Semantic colors */\n  --green: #22c55e;    --green-bg: #f0fdf4;    --green-border: #86efac;\n  --yellow: #eab308;   --yellow-bg: #fefce8;\n  --orange: #f97316;   --orange-bg: #fff7ed;\n  --red: #ef4444;      --red-bg: #fef2f2;\n  --gray: #6b7280;     --gray-bg: #f9fafb;     --gray-border: #e5e7eb;\n  --blue: #3b82f6;     --blue-bg: #eff6ff;\n  --purple: #8b5cf6;   --purple-bg: #f5f3ff;\n\n  /* Text hierarchy */\n  --text: #1f2937;\n  --text-secondary: #6b7280;\n  --text-muted: #9ca3af;\n\n  /* Structure */\n  --border: #e5e7eb;\n  --bg: #f3f4f6;\n\n  /* Typography */\n  --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;\n}\n```\n\n### Dark Mode Override Pattern\n\nAll dark overrides use `[data-theme=\"dark\"]` selector. Override the custom properties first, then override specific component backgrounds:\n\n```css\n[data-theme=\"dark\"] {\n  --text: #e5e7eb;\n  --text-secondary: #9ca3af;\n  --text-muted: #6b7280;\n  --border: #374151;\n  --bg: #111827;\n  --gray-bg: #1f2937;\n  --gray-border: #374151;\n  --gray: #9ca3af;\n  --green-bg: #064e3b;\n  --green-border: #10b981;\n  --yellow-bg: #713f12;\n  --red-bg: #7f1d1d;\n  --orange-bg: #7c2d12;\n  --blue-bg: #1e3a5f;\n  --purple-bg: #2e1065;\n}\n\n/* Component-level overrides (backgrounds that don't use custom properties) */\n[data-theme=\"dark\"] .header,\n[data-theme=\"dark\"] .section,\n[data-theme=\"dark\"] .gate,\n[data-theme=\"dark\"] .tab-panel,\n[data-theme=\"dark\"] .tab-bar { background: #1f2937; }\n```\n\nThe file modal uses a separate override pattern for light theme (since its default styling targets dark):\n```css\n:root:not([data-theme=\"dark\"]) .file-modal { background: #ffffff; }\n:root:not([data-theme=\"dark\"]) .file-modal-header { background: #f5f5f5; }\n/* ... etc */\n```\n\n### Typography\n\n- **Body**: `-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif`. Base: 14px, line-height 1.5.\n- **Monospace**: `var(--mono)` \u2014 SF Mono > Fira Code > Cascadia Code > monospace.\n- **Heading hierarchy**:\n  - Page title: 20px, 700 weight\n  - Section headers: 14px, 700 weight\n  - Sub-headers (within sections): 13px, 700 weight\n  - Body text: 13px, 400/500 weight\n  - Meta text: 11-12px, muted color\n  - Uppercase labels: 10-11px, 600-700 weight, `letter-spacing: 0.3-0.5px`\n- **Table headers**: 11px, 600 weight, uppercase, secondary color, `letter-spacing: 0.3px`.\n\n### Component Patterns\n\n**Badges**:\n```css\n.badge { padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }\n.badge.pass { background: var(--green-bg); color: #166534; }\n.badge.fail { background: var(--red-bg); color: #991b1b; }\n```\n\n**Status badges** (header row):\n```css\n.status-badge { padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; }\n.status-badge.pass { background: var(--green-bg); color: #166534; }\n.status-badge.info { background: var(--blue-bg); color: #1d4ed8; }\n.status-badge.warn { background: var(--yellow-bg); color: #854d0e; }\n```\n\n**Grade pills**:\n```css\n.grade { width: 28px; height: 28px; line-height: 28px; text-align: center;\n         border-radius: 6px; font-weight: 700; font-size: 12px; }\n```\n\n**Zone tags**:\n```css\n.zone-tag { font-size: 11px; padding: 2px 8px; border-radius: 4px; font-weight: 600; }\n.zone-tag.factory { background: var(--blue-bg); color: #1d4ed8; }\n.zone-tag.product { background: #dcfce7; color: #166534; }\n.zone-tag.infra { background: var(--purple-bg); color: #6d28d9; }\n```\n\n**Priority tags**:\n```css\n.priority { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 4px; }\n.priority.low { background: var(--blue-bg); color: #1d4ed8; }\n.priority.medium { background: var(--yellow-bg); color: #854d0e; }\n.priority.cosmetic { background: var(--gray-bg); color: var(--gray); }\n```\n\n**Expandable sections**:\n```css\n.section { border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }\n.section-header { padding: 14px 24px; cursor: pointer; display: flex;\n                  justify-content: space-between; align-items: center; }\n.section-header .chevron { transition: transform 0.2s; }\n.section.collapsed .section-body { display: none; }\n.section.collapsed .chevron { transform: rotate(-90deg); }\n```\n\n**Code blocks** (post-merge items):\n```css\n.code-block { background: #1e293b; color: #e2e8f0; padding: 12px 16px;\n              border-radius: 6px; font-family: var(--mono); font-size: 12px;\n              line-height: 1.6; overflow-x: auto; white-space: pre; }\n```\n\n**Scenario boxes** (failure/success):\n```css\n.scenario-box { padding: 10px 14px; border-radius: 6px; font-size: 12px; }\n.scenario-box.failure { background: var(--red-bg); border-left: 3px solid var(--red); }\n.scenario-box.success { background: var(--green-bg); border-left: 3px solid var(--green); }\n```\n\n### Layout\n\n- **Container**: `max-width: 1100px; margin: 0 auto; padding: 24px 16px`.\n- **Section spacing**: `margin-bottom: 16px` between sections.\n- **Section body padding**: `0 24px 20px`.\n- **Grids**: `.convergence-grid` and `.scenario-grid` use 2-column CSS grid.\n- **Cards**: 1px border, 8px radius, 10-16px padding.\n- **Tables**: `width: 100%; border-collapse: collapse`. Cells: `8px 12px` padding.\n\n### Responsive\n\n```css\n@media (max-width: 768px) {\n  .stats { flex-direction: column; gap: 8px; }\n  .convergence-grid { grid-template-columns: 1fr; }\n  .scenario-grid { grid-template-columns: 1fr; }\n  .container { padding: 12px 8px; }\n  .arch-floating { width: 60%; }\n  .file-modal { width: 98vw; height: 95vh; }\n}\n```\n\n---\n\n## 8. Validation Checklist\n\nEvery check that must pass before the review pack is delivered to the reviewer.\n\n### Data Correctness\n\n- [ ] Zone registry loaded and parsed successfully.\n- [ ] Every file in `git diff --name-only main...HEAD` appears in the file-zone mapping.\n- [ ] Files that match no zone are flagged as `unzoned`.\n- [ ] Zone file counts match actual file count per zone from the diff.\n- [ ] Diff stats (additions, deletions, files, commits) match `gh pr view` output.\n- [ ] HEAD SHA in the header matches the actual HEAD of the PR branch.\n- [ ] CI check statuses match `gh pr checks` output for HEAD SHA.\n- [ ] Comment resolution count matches GitHub API response.\n- [ ] Every decision-zone claim is verified (file in zone's paths exists in diff). Unverified claims are flagged.\n- [ ] Every code snippet in post-merge items references a real file and valid line range in the diff.\n- [ ] Every file path link in decisions and findings references a file that exists in the diff.\n- [ ] Adversarial grades are from the defined set: A, B+, B, C, F, N/A.\n- [ ] Priority values are from the defined set: low, medium, high, cosmetic.\n- [ ] CI health classifications match timing thresholds (<1m=normal, 1-5m=acceptable, 5-10m=watch, >10m=refactor).\n\n### Visual Correctness\n\n- [ ] All 9 sections render without errors in both light and dark themes.\n- [ ] Theme toggle works: light, dark, system. Persists across page reload (localStorage).\n- [ ] Architecture diagram renders with correct zone positions, colors, and file count badges.\n- [ ] Floating minimap appears when scrolling past the inline diagram and disappears when scrolling back.\n- [ ] File modal opens, displays diff in all three views (side-by-side, unified, raw), and closes cleanly.\n- [ ] Scroll trapping works: background does not scroll when modal is open.\n- [ ] All expandable elements (sections, CI jobs, decisions, post-merge items, scenarios, convergence cards, history events) toggle correctly.\n- [ ] Zone click filtering updates all four filtered sections simultaneously.\n- [ ] Factory History tab switches cleanly and renders timeline + gate findings table.\n- [ ] Gate finding popovers position correctly and dismiss on timeout/Escape/click-outside.\n\n### Content Completeness\n\n- [ ] Every file in the diff appears in the adversarial review (individually or grouped).\n- [ ] Every CI check on HEAD SHA is listed.\n- [ ] Every zone with files in the diff has a \"What Changed\" zone detail block.\n- [ ] Scenario count and status match actual evaluation results.\n- [ ] Spec list includes all governing specifications referenced in the zone registry.\n- [ ] Factory history covers the full commit range of the PR branch.\n\n### Deterministic Correctness Guarantees\n\n- [ ] File-to-Zone mapping is pure glob matching (no LLM).\n- [ ] Zone-to-Diagram is static registry lookup (no LLM).\n- [ ] Decision-to-Zone claims are LLM-produced but verified against file-zone mapping.\n- [ ] Code snippets are verified against actual diff lines.\n- [ ] CI-to-Zone coverage is statically defined.\n- [ ] Unverified claims are flagged with `[UNVERIFIED]`, not silently rendered.\n- [ ] The renderer (Pass 3) has zero intelligence \u2014 it is a pure template consuming verified data.\n\n---\n\n## 9. Project-Specific vs Universal\n\n### Universal (use across all projects)\n\n| Component | Notes |\n|-----------|-------|\n| HTML template (`assets/template.html`) | Data-driven, project-agnostic |\n| CSS design system | Embedded in template: all tokens, components, responsive rules |\n| Theme toggle JS | Embedded: light/dark/system with localStorage |\n| File modal JS | Embedded: side-by-side/unified/raw diff views |\n| Zone filtering JS | Embedded: cross-section highlight/dim/filter |\n| Expandable component JS | Embedded: sections, cards, rows |\n| Floating minimap JS | Embedded: IntersectionObserver + clone |\n| Pass 1 commands | This spec, Section 6: `git diff`, `gh pr checks`, zone matching |\n| Pass 2 agent prompt | This spec, Section 6: structured output requirements |\n| Pass 3 rendering logic | Template JS: pure `DATA` consumption |\n| Validation checklist | This spec, Section 8: all checks apply universally |\n| Data schema | This spec, Section 2: TypeScript interfaces |\n\n### Project-Specific (defined per project)\n\n| Component | Notes |\n|-----------|-------|\n| Zone registry | Project repo (e.g., `.claude/zone_registry.yaml`): path patterns, zone names, layers, specs |\n| Architecture diagram layout | Zone registry `position` fields: SVG coordinates per zone |\n| Spec file list | Zone registry `specs` fields: which specs govern which zones |\n| Scenario definitions | Project's `scenarios/` directory: holdout evaluation criteria |\n| Scenario categories | Defined by project: category names and colors |\n| CI job descriptions | Project's CI config + zone registry: what each job covers |\n| Factory history format | Project's factory configuration: iteration structure varies by factory type |\n| Diff data generator | Project repo: script to produce `pr_diff_data.json` |\n\n### Extending for New Projects\n\nTo produce a review pack for a new project:\n\n1. Create a zone registry (`zone_registry.yaml`) with the project's architecture zones, path patterns, and SVG positions.\n2. Run Pass 1 using the commands in Section 6 with the project's zone registry.\n3. Run Pass 2 with the agent prompt template, substituting the project's diff and zone data.\n4. Run Pass 3 with the universal HTML template and the merged JSON data.\n5. Run the validation checklist (Section 8) before delivering.\n\nThe template handles all rendering. The project only provides the data and the zone registry.\n\n---\n\n## Footer\n\nThe review pack includes a footer:\n```html\n<div class=\"footer\">\n  Generated by {agent_name} | {date} | HEAD: {headSha}<br>\n  <span style=\"font-size:10px\">Deterministic rendering from structured data &bull; Code diffs are ground truth</span>\n</div>\n```\n\nCSS: `.footer { text-align: center; padding: 16px; font-size: 11px; color: var(--text-muted); }`\n"
    },
    ".claude/skills/pr-review-pack/references/css-design-system.md": {
      "additions": 1,
      "deletions": 1,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/.claude/skills/pr-review-pack/references/css-design-system.md b/.claude/skills/pr-review-pack/references/css-design-system.md\nindex 68cc9d4..8350e0b 100644\n--- a/.claude/skills/pr-review-pack/references/css-design-system.md\n+++ b/.claude/skills/pr-review-pack/references/css-design-system.md\n@@ -310,4 +310,4 @@ Zone state classes:\n | Floating diagram | opacity, transform | 0.3s ease |\n | Hover backgrounds | background | 0.15s |\n | CI chevron | transform (rotation) | 0.2s |\n-| Adversarial row collapse | max-height, opacity, padding | 0.3s ease |\n+| Agentic row collapse | max-height, opacity, padding | 0.3s ease |\n",
      "raw": "# PR Review Pack CSS Design System\n\nComplete design system reference for the review pack HTML template. Covers custom properties, theme system, and component patterns.\n\n## Color Tokens\n\n### Light Theme (`:root`)\n\n```css\n/* Semantic colors */\n--green: #22c55e;     --green-bg: #f0fdf4;     --green-border: #86efac;\n--yellow: #eab308;    --yellow-bg: #fefce8;\n--orange: #f97316;    --orange-bg: #fff7ed;\n--red: #ef4444;       --red-bg: #fef2f2;\n--gray: #6b7280;      --gray-bg: #f9fafb;      --gray-border: #e5e7eb;\n--blue: #3b82f6;      --blue-bg: #eff6ff;\n--purple: #8b5cf6;    --purple-bg: #f5f3ff;\n\n/* Typography */\n--text: #1f2937;\n--text-secondary: #6b7280;\n--text-muted: #9ca3af;\n\n/* Structure */\n--border: #e5e7eb;\n--bg: #f3f4f6;\n\n/* Font stack */\n--mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;\n```\n\n### Dark Theme (`[data-theme=\"dark\"]`)\n\n```css\n--text: #e5e7eb;      --text-secondary: #9ca3af;   --text-muted: #6b7280;\n--border: #374151;    --bg: #111827;\n--gray-bg: #1f2937;   --gray-border: #374151;       --gray: #9ca3af;\n--green-bg: #064e3b;  --green-border: #10b981;\n--yellow-bg: #713f12;\n--red-bg: #7f1d1d;\n--orange-bg: #7c2d12;\n--blue-bg: #1e3a5f;\n--purple-bg: #2e1065;\n```\n\n### Dark Theme Surface Overrides\n\nThese selectors override `background` to `#1f2937` for card-like surfaces:\n\n```\n.header, .section, .gate, .tab-panel, .tab-bar\n```\n\nAdditional dark theme selectors for specific components:\n\n| Selector | Property | Value |\n|----------|----------|-------|\n| `.tab-btn` | color | `#9ca3af` |\n| `.tab-btn:hover` | background | `#374151` |\n| `.tab-btn.active` | color, background | `#60a5fa`, `#1f2937` |\n| `th` | background, color | `#1f2937`, `#9ca3af` |\n| `tr:nth-child(even) td` | background | `rgba(255,255,255,0.02)` |\n| `.arch-floating` | background | `rgba(31,41,55,0.95)` |\n| `.code-block` | background | `#0f172a` |\n| `#arch-diagram` | background, border-color | `#1a2332`, `#374151` |\n\n## Theme System\n\nThree modes: Light, Dark, System (follows OS preference).\n\n### Implementation\n\n```javascript\n// Initialize from localStorage on page load\n(function initTheme() {\n  const stored = localStorage.getItem('pr-pack-theme') || 'system';\n  applyTheme(stored);\n  updateThemeButtons(stored);\n})();\n\n// Apply theme to document root\nfunction applyTheme(theme) {\n  if (theme === 'system') {\n    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;\n    document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');\n  } else {\n    document.documentElement.setAttribute('data-theme', theme);\n  }\n}\n```\n\n### Toggle UI\n\n```html\n<div class=\"theme-toggle\">\n  <button data-theme-btn=\"light\" title=\"Light theme\">&#x2600;</button>\n  <button data-theme-btn=\"dark\" title=\"Dark theme\">&#x1F319;</button>\n  <button data-theme-btn=\"system\" title=\"System theme\">&#x2699;</button>\n</div>\n```\n\nActive button gets `.active` class (blue background, white text). Persisted to `localStorage` key `pr-pack-theme`.\n\n## Layout Patterns\n\n### Container\n```css\n.container { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }\n```\n\n### Tab System\n```css\n.tab-bar { display: flex; background: white; border-radius: 12px 12px 0 0; border: 1px solid var(--border); }\n.tab-btn { padding: 12px 24px; font-size: 13px; font-weight: 600; border-bottom: 2px solid transparent; }\n.tab-btn.active { color: var(--blue); border-bottom-color: var(--blue); }\n.tab-panel { background: white; border: 1px solid var(--border); border-radius: 0 0 12px 12px; }\n```\n\n### Section (Collapsible)\n```css\n.section { background: white; border-radius: 12px; border: 1px solid var(--border); }\n.section-header { padding: 14px 24px; cursor: pointer; display: flex; justify-content: space-between; }\n.section.collapsed .section-body { display: none; }\n.section.collapsed .chevron { transform: rotate(-90deg); }\n.section-body { padding: 0 24px 20px; font-size: 13px; }\n```\n\n### Convergence Grid\n```css\n.convergence-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }\n```\n\n### Scenario Grid\n```css\n.scenario-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }\n```\n\n### Responsive (max-width: 768px)\n```css\n.stats { flex-direction: column; }\n.convergence-grid { grid-template-columns: 1fr; }\n.scenario-grid { grid-template-columns: 1fr; }\n.container { padding: 12px 8px; }\n.arch-floating { width: 60%; }\n.file-modal { width: 98vw; height: 95vh; }\n```\n\n## Component Patterns\n\n### Badge (pass/fail)\n```css\n.badge { display: inline-flex; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }\n.badge.pass { background: var(--green-bg); color: #166534; }\n.badge.fail { background: var(--red-bg); color: #991b1b; }\n```\n\n### Grade Pills\n```css\n.grade { width: 28px; height: 28px; line-height: 28px; text-align: center; border-radius: 6px; font-weight: 700; font-size: 12px; }\n.grade.a { background: var(--green-bg); color: #166534; }\n.grade.b { background: var(--yellow-bg); color: #854d0e; }\n.grade.c { background: var(--orange-bg); color: #9a3412; }\n.grade.f { background: var(--red-bg); color: #991b1b; }\n.grade.na { background: var(--gray-bg); color: var(--gray); }\n```\n\n### Health Tags (CI timing)\n```css\n.health-tag { font-size: 10px; font-weight: 600; text-transform: uppercase; padding: 2px 8px; border-radius: 4px; }\n.health-tag.normal { background: var(--green-bg); color: #166534; }\n.health-tag.acceptable { background: var(--yellow-bg); color: #854d0e; }\n.health-tag.watch { background: var(--orange-bg); color: #9a3412; }\n.health-tag.refactor { background: var(--red-bg); color: #991b1b; }\n```\n\n### Time Labels (CI timing, large)\n```css\n.time-label { font-family: var(--mono); font-size: 15px; font-weight: 700; }\n.time-label.normal { color: #166534; }\n.time-label.acceptable { color: #854d0e; }\n.time-label.watch { color: #f97316; }\n.time-label.refactor { color: #ef4444; }\n```\n\n### Priority Tags (Post-merge)\n```css\n.priority { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 4px; }\n.priority.low { background: var(--blue-bg); color: #1d4ed8; }\n.priority.medium { background: var(--yellow-bg); color: #854d0e; }\n.priority.cosmetic { background: var(--gray-bg); color: var(--gray); }\n```\n\n### Zone Tags\n```css\n.zone-tag { font-size: 11px; padding: 2px 8px; border-radius: 4px; font-weight: 600; background: var(--blue-bg); color: #1d4ed8; }\n.zone-tag.factory { background: var(--blue-bg); color: #1d4ed8; }\n.zone-tag.product { background: #dcfce7; color: #166534; }\n.zone-tag.infra { background: var(--purple-bg); color: #6d28d9; }\n```\n\n### Status Badges (Header)\n```css\n.status-badge { display: inline-flex; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; }\n.status-badge.pass { background: var(--green-bg); color: #166534; }\n.status-badge.info { background: var(--blue-bg); color: #1d4ed8; }\n.status-badge.warn { background: var(--yellow-bg); color: #854d0e; }\n```\n\n### Scenario Category Pills\n```css\n.scenario-category { padding: 1px 7px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; }\n.scenario-category.cat-environment { background: #dcfce7; color: #166534; }\n.scenario-category.cat-training { background: #dbeafe; color: #1d4ed8; }\n.scenario-category.cat-pipeline { background: #f3e8ff; color: #6d28d9; }\n.scenario-category.cat-integration { background: #fff7ed; color: #9a3412; }\n```\n\n### Code Block\n```css\n.code-block { background: #1e293b; color: #e2e8f0; padding: 12px 16px; border-radius: 6px; font-family: var(--mono); font-size: 12px; line-height: 1.6; overflow-x: auto; white-space: pre; }\n```\n\n### Scenario Boxes (failure/success)\n```css\n.scenario-box { padding: 10px 14px; border-radius: 6px; margin: 6px 0; font-size: 12px; }\n.scenario-box.failure { background: var(--red-bg); border-left: 3px solid var(--red); }\n.scenario-box.success { background: var(--green-bg); border-left: 3px solid var(--green); }\n.scenario-label { font-weight: 700; font-size: 11px; text-transform: uppercase; margin-bottom: 4px; }\n```\n\n### Expandable Cards (Decisions, Post-Merge)\n```css\n/* Decision cards */\n.decision-card { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; }\n.decision-header { padding: 12px 16px; cursor: pointer; display: flex; gap: 12px; }\n.decision-body { display: none; padding: 0 16px 16px; border-top: 1px solid var(--border); }\n.decision-card.open .decision-body { display: block; }\n\n/* Post-merge items */\n.pm-item { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; }\n.pm-header { padding: 10px 16px; cursor: pointer; display: flex; gap: 10px; }\n.pm-body { display: none; padding: 0 16px 16px; border-top: 1px solid var(--border); }\n.pm-item.open .pm-body { display: block; }\n```\n\n### File Path Links\n```css\n.file-path-link { color: inherit; text-decoration: none; border-bottom: 1px dashed var(--text-muted); cursor: pointer; }\n.file-path-link:hover { border-bottom-color: var(--blue); color: var(--blue); }\n```\n\n### Floating Architecture Diagram\n```css\n.arch-floating { position: fixed; top: 16px; right: 16px; width: 40%; max-width: 480px; z-index: 100;\n  background: rgba(255,255,255,0.95); border-radius: 10px; border: 1px solid var(--border);\n  box-shadow: 0 8px 32px rgba(0,0,0,0.12); padding: 10px;\n  opacity: 0; transform: translateX(40px); pointer-events: none;\n  transition: opacity 0.3s ease, transform 0.3s ease; }\n.arch-floating.visible { opacity: 1; transform: translateX(0); pointer-events: auto; }\n```\n\n### File Diff Modal\n```css\n.file-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0;\n  background: rgba(0,0,0,0.45); z-index: 200; display: none; justify-content: center; align-items: center; }\n.file-modal-overlay.visible { display: flex; }\n.file-modal { border-radius: 10px; width: 95vw; max-width: 1400px; height: 90vh;\n  overflow: hidden; display: flex; flex-direction: column; }\n```\n\nThe file modal uses VS Code-inspired dark styling for diffs. Light theme overrides are applied via `:root:not([data-theme=\"dark\"])` selectors for all diff-related classes.\n\n### Diff Color Scheme\n\n**Dark mode (default for modal):**\n- Added lines: `rgba(63,185,80,0.15)` bg, `#3fb950` text\n- Deleted lines: `rgba(248,81,73,0.15)` bg, `#f85149` text\n- Context lines: `#cccccc` text\n- Hunk headers: `rgba(56,139,253,0.12)` bg, `#58a6ff` text\n- Line numbers: `#636363`\n\n**Light mode:**\n- Added lines: `rgba(34,197,94,0.12)` bg, `#166534` text\n- Deleted lines: `rgba(239,68,68,0.12)` bg, `#991b1b` text\n- Context lines: `#333333` text\n- Hunk headers: `rgba(59,130,246,0.08)` bg, `#2563eb` text\n- Line numbers: `#999999`\n\n## Architecture Diagram Zone Colors\n\nZone boxes in the SVG use these fill/stroke pairs by category:\n\n| Category | Fill | Stroke | Label Fill | Count Circle |\n|----------|------|--------|------------|-------------|\n| factory | `#dbeafe` | `#3b82f6` | `#1d4ed8` | `#3b82f6` |\n| product | `#dcfce7` | `#22c55e` | `#166534` | `#22c55e` |\n| infra | `#f3e8ff` | `#8b5cf6` | `#6d28d9` | `#8b5cf6` |\n\nZone state classes:\n- Default: no extra classes\n- `.dimmed`: `opacity: 0.12` (zone is not part of active filter)\n- `.highlighted`: `stroke-width: 3; filter: brightness(0.92)` (zone is part of active filter)\n\n## Animation & Transitions\n\n| Element | Property | Duration |\n|---------|----------|----------|\n| Zone boxes | opacity, filter | 0.3s |\n| Sections collapse | chevron rotation | 0.2s |\n| Floating diagram | opacity, transform | 0.3s ease |\n| Hover backgrounds | background | 0.15s |\n| CI chevron | transform (rotation) | 0.2s |\n| Agentic row collapse | max-height, opacity, padding | 0.3s ease |\n",
      "base": "# PR Review Pack CSS Design System\n\nComplete design system reference for the review pack HTML template. Covers custom properties, theme system, and component patterns.\n\n## Color Tokens\n\n### Light Theme (`:root`)\n\n```css\n/* Semantic colors */\n--green: #22c55e;     --green-bg: #f0fdf4;     --green-border: #86efac;\n--yellow: #eab308;    --yellow-bg: #fefce8;\n--orange: #f97316;    --orange-bg: #fff7ed;\n--red: #ef4444;       --red-bg: #fef2f2;\n--gray: #6b7280;      --gray-bg: #f9fafb;      --gray-border: #e5e7eb;\n--blue: #3b82f6;      --blue-bg: #eff6ff;\n--purple: #8b5cf6;    --purple-bg: #f5f3ff;\n\n/* Typography */\n--text: #1f2937;\n--text-secondary: #6b7280;\n--text-muted: #9ca3af;\n\n/* Structure */\n--border: #e5e7eb;\n--bg: #f3f4f6;\n\n/* Font stack */\n--mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;\n```\n\n### Dark Theme (`[data-theme=\"dark\"]`)\n\n```css\n--text: #e5e7eb;      --text-secondary: #9ca3af;   --text-muted: #6b7280;\n--border: #374151;    --bg: #111827;\n--gray-bg: #1f2937;   --gray-border: #374151;       --gray: #9ca3af;\n--green-bg: #064e3b;  --green-border: #10b981;\n--yellow-bg: #713f12;\n--red-bg: #7f1d1d;\n--orange-bg: #7c2d12;\n--blue-bg: #1e3a5f;\n--purple-bg: #2e1065;\n```\n\n### Dark Theme Surface Overrides\n\nThese selectors override `background` to `#1f2937` for card-like surfaces:\n\n```\n.header, .section, .gate, .tab-panel, .tab-bar\n```\n\nAdditional dark theme selectors for specific components:\n\n| Selector | Property | Value |\n|----------|----------|-------|\n| `.tab-btn` | color | `#9ca3af` |\n| `.tab-btn:hover` | background | `#374151` |\n| `.tab-btn.active` | color, background | `#60a5fa`, `#1f2937` |\n| `th` | background, color | `#1f2937`, `#9ca3af` |\n| `tr:nth-child(even) td` | background | `rgba(255,255,255,0.02)` |\n| `.arch-floating` | background | `rgba(31,41,55,0.95)` |\n| `.code-block` | background | `#0f172a` |\n| `#arch-diagram` | background, border-color | `#1a2332`, `#374151` |\n\n## Theme System\n\nThree modes: Light, Dark, System (follows OS preference).\n\n### Implementation\n\n```javascript\n// Initialize from localStorage on page load\n(function initTheme() {\n  const stored = localStorage.getItem('pr-pack-theme') || 'system';\n  applyTheme(stored);\n  updateThemeButtons(stored);\n})();\n\n// Apply theme to document root\nfunction applyTheme(theme) {\n  if (theme === 'system') {\n    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;\n    document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');\n  } else {\n    document.documentElement.setAttribute('data-theme', theme);\n  }\n}\n```\n\n### Toggle UI\n\n```html\n<div class=\"theme-toggle\">\n  <button data-theme-btn=\"light\" title=\"Light theme\">&#x2600;</button>\n  <button data-theme-btn=\"dark\" title=\"Dark theme\">&#x1F319;</button>\n  <button data-theme-btn=\"system\" title=\"System theme\">&#x2699;</button>\n</div>\n```\n\nActive button gets `.active` class (blue background, white text). Persisted to `localStorage` key `pr-pack-theme`.\n\n## Layout Patterns\n\n### Container\n```css\n.container { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }\n```\n\n### Tab System\n```css\n.tab-bar { display: flex; background: white; border-radius: 12px 12px 0 0; border: 1px solid var(--border); }\n.tab-btn { padding: 12px 24px; font-size: 13px; font-weight: 600; border-bottom: 2px solid transparent; }\n.tab-btn.active { color: var(--blue); border-bottom-color: var(--blue); }\n.tab-panel { background: white; border: 1px solid var(--border); border-radius: 0 0 12px 12px; }\n```\n\n### Section (Collapsible)\n```css\n.section { background: white; border-radius: 12px; border: 1px solid var(--border); }\n.section-header { padding: 14px 24px; cursor: pointer; display: flex; justify-content: space-between; }\n.section.collapsed .section-body { display: none; }\n.section.collapsed .chevron { transform: rotate(-90deg); }\n.section-body { padding: 0 24px 20px; font-size: 13px; }\n```\n\n### Convergence Grid\n```css\n.convergence-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }\n```\n\n### Scenario Grid\n```css\n.scenario-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }\n```\n\n### Responsive (max-width: 768px)\n```css\n.stats { flex-direction: column; }\n.convergence-grid { grid-template-columns: 1fr; }\n.scenario-grid { grid-template-columns: 1fr; }\n.container { padding: 12px 8px; }\n.arch-floating { width: 60%; }\n.file-modal { width: 98vw; height: 95vh; }\n```\n\n## Component Patterns\n\n### Badge (pass/fail)\n```css\n.badge { display: inline-flex; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }\n.badge.pass { background: var(--green-bg); color: #166534; }\n.badge.fail { background: var(--red-bg); color: #991b1b; }\n```\n\n### Grade Pills\n```css\n.grade { width: 28px; height: 28px; line-height: 28px; text-align: center; border-radius: 6px; font-weight: 700; font-size: 12px; }\n.grade.a { background: var(--green-bg); color: #166534; }\n.grade.b { background: var(--yellow-bg); color: #854d0e; }\n.grade.c { background: var(--orange-bg); color: #9a3412; }\n.grade.f { background: var(--red-bg); color: #991b1b; }\n.grade.na { background: var(--gray-bg); color: var(--gray); }\n```\n\n### Health Tags (CI timing)\n```css\n.health-tag { font-size: 10px; font-weight: 600; text-transform: uppercase; padding: 2px 8px; border-radius: 4px; }\n.health-tag.normal { background: var(--green-bg); color: #166534; }\n.health-tag.acceptable { background: var(--yellow-bg); color: #854d0e; }\n.health-tag.watch { background: var(--orange-bg); color: #9a3412; }\n.health-tag.refactor { background: var(--red-bg); color: #991b1b; }\n```\n\n### Time Labels (CI timing, large)\n```css\n.time-label { font-family: var(--mono); font-size: 15px; font-weight: 700; }\n.time-label.normal { color: #166534; }\n.time-label.acceptable { color: #854d0e; }\n.time-label.watch { color: #f97316; }\n.time-label.refactor { color: #ef4444; }\n```\n\n### Priority Tags (Post-merge)\n```css\n.priority { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 4px; }\n.priority.low { background: var(--blue-bg); color: #1d4ed8; }\n.priority.medium { background: var(--yellow-bg); color: #854d0e; }\n.priority.cosmetic { background: var(--gray-bg); color: var(--gray); }\n```\n\n### Zone Tags\n```css\n.zone-tag { font-size: 11px; padding: 2px 8px; border-radius: 4px; font-weight: 600; background: var(--blue-bg); color: #1d4ed8; }\n.zone-tag.factory { background: var(--blue-bg); color: #1d4ed8; }\n.zone-tag.product { background: #dcfce7; color: #166534; }\n.zone-tag.infra { background: var(--purple-bg); color: #6d28d9; }\n```\n\n### Status Badges (Header)\n```css\n.status-badge { display: inline-flex; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; }\n.status-badge.pass { background: var(--green-bg); color: #166534; }\n.status-badge.info { background: var(--blue-bg); color: #1d4ed8; }\n.status-badge.warn { background: var(--yellow-bg); color: #854d0e; }\n```\n\n### Scenario Category Pills\n```css\n.scenario-category { padding: 1px 7px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; }\n.scenario-category.cat-environment { background: #dcfce7; color: #166534; }\n.scenario-category.cat-training { background: #dbeafe; color: #1d4ed8; }\n.scenario-category.cat-pipeline { background: #f3e8ff; color: #6d28d9; }\n.scenario-category.cat-integration { background: #fff7ed; color: #9a3412; }\n```\n\n### Code Block\n```css\n.code-block { background: #1e293b; color: #e2e8f0; padding: 12px 16px; border-radius: 6px; font-family: var(--mono); font-size: 12px; line-height: 1.6; overflow-x: auto; white-space: pre; }\n```\n\n### Scenario Boxes (failure/success)\n```css\n.scenario-box { padding: 10px 14px; border-radius: 6px; margin: 6px 0; font-size: 12px; }\n.scenario-box.failure { background: var(--red-bg); border-left: 3px solid var(--red); }\n.scenario-box.success { background: var(--green-bg); border-left: 3px solid var(--green); }\n.scenario-label { font-weight: 700; font-size: 11px; text-transform: uppercase; margin-bottom: 4px; }\n```\n\n### Expandable Cards (Decisions, Post-Merge)\n```css\n/* Decision cards */\n.decision-card { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; }\n.decision-header { padding: 12px 16px; cursor: pointer; display: flex; gap: 12px; }\n.decision-body { display: none; padding: 0 16px 16px; border-top: 1px solid var(--border); }\n.decision-card.open .decision-body { display: block; }\n\n/* Post-merge items */\n.pm-item { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; }\n.pm-header { padding: 10px 16px; cursor: pointer; display: flex; gap: 10px; }\n.pm-body { display: none; padding: 0 16px 16px; border-top: 1px solid var(--border); }\n.pm-item.open .pm-body { display: block; }\n```\n\n### File Path Links\n```css\n.file-path-link { color: inherit; text-decoration: none; border-bottom: 1px dashed var(--text-muted); cursor: pointer; }\n.file-path-link:hover { border-bottom-color: var(--blue); color: var(--blue); }\n```\n\n### Floating Architecture Diagram\n```css\n.arch-floating { position: fixed; top: 16px; right: 16px; width: 40%; max-width: 480px; z-index: 100;\n  background: rgba(255,255,255,0.95); border-radius: 10px; border: 1px solid var(--border);\n  box-shadow: 0 8px 32px rgba(0,0,0,0.12); padding: 10px;\n  opacity: 0; transform: translateX(40px); pointer-events: none;\n  transition: opacity 0.3s ease, transform 0.3s ease; }\n.arch-floating.visible { opacity: 1; transform: translateX(0); pointer-events: auto; }\n```\n\n### File Diff Modal\n```css\n.file-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0;\n  background: rgba(0,0,0,0.45); z-index: 200; display: none; justify-content: center; align-items: center; }\n.file-modal-overlay.visible { display: flex; }\n.file-modal { border-radius: 10px; width: 95vw; max-width: 1400px; height: 90vh;\n  overflow: hidden; display: flex; flex-direction: column; }\n```\n\nThe file modal uses VS Code-inspired dark styling for diffs. Light theme overrides are applied via `:root:not([data-theme=\"dark\"])` selectors for all diff-related classes.\n\n### Diff Color Scheme\n\n**Dark mode (default for modal):**\n- Added lines: `rgba(63,185,80,0.15)` bg, `#3fb950` text\n- Deleted lines: `rgba(248,81,73,0.15)` bg, `#f85149` text\n- Context lines: `#cccccc` text\n- Hunk headers: `rgba(56,139,253,0.12)` bg, `#58a6ff` text\n- Line numbers: `#636363`\n\n**Light mode:**\n- Added lines: `rgba(34,197,94,0.12)` bg, `#166534` text\n- Deleted lines: `rgba(239,68,68,0.12)` bg, `#991b1b` text\n- Context lines: `#333333` text\n- Hunk headers: `rgba(59,130,246,0.08)` bg, `#2563eb` text\n- Line numbers: `#999999`\n\n## Architecture Diagram Zone Colors\n\nZone boxes in the SVG use these fill/stroke pairs by category:\n\n| Category | Fill | Stroke | Label Fill | Count Circle |\n|----------|------|--------|------------|-------------|\n| factory | `#dbeafe` | `#3b82f6` | `#1d4ed8` | `#3b82f6` |\n| product | `#dcfce7` | `#22c55e` | `#166534` | `#22c55e` |\n| infra | `#f3e8ff` | `#8b5cf6` | `#6d28d9` | `#8b5cf6` |\n\nZone state classes:\n- Default: no extra classes\n- `.dimmed`: `opacity: 0.12` (zone is not part of active filter)\n- `.highlighted`: `stroke-width: 3; filter: brightness(0.92)` (zone is part of active filter)\n\n## Animation & Transitions\n\n| Element | Property | Duration |\n|---------|----------|----------|\n| Zone boxes | opacity, filter | 0.3s |\n| Sections collapse | chevron rotation | 0.2s |\n| Floating diagram | opacity, transform | 0.3s ease |\n| Hover backgrounds | background | 0.15s |\n| CI chevron | transform (rotation) | 0.2s |\n| Adversarial row collapse | max-height, opacity, padding | 0.3s ease |\n"
    },
    ".claude/skills/pr-review-pack/references/data-schema.md": {
      "additions": 8,
      "deletions": 6,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/.claude/skills/pr-review-pack/references/data-schema.md b/.claude/skills/pr-review-pack/references/data-schema.md\nindex 6d6e701..7f1fe0e 100644\n--- a/.claude/skills/pr-review-pack/references/data-schema.md\n+++ b/.claude/skills/pr-review-pack/references/data-schema.md\n@@ -11,7 +11,7 @@ interface ReviewPackData {\n   specs: Specification[];\n   scenarios: Scenario[];\n   whatChanged: WhatChanged;\n-  adversarialReview: AdversarialReview;\n+  agenticReview: AgenticReview;\n   ciPerformance: CICheck[];\n   decisions: Decision[];\n   convergence: ConvergenceResult;\n@@ -103,7 +103,7 @@ interface Specification {\n interface Scenario {\n   name: string;                     // \"Environment Initialization\"\n   category: ScenarioCategory;\n-  status: \"passing\" | \"failing\" | \"advisory\";\n+  status: \"pass\" | \"passing\" | \"fail\" | \"failing\" | \"advisory\";  // renderer accepts both short and long forms\n   zone: string;                     // space-separated zone IDs for filtering\n   detail: ScenarioDetail;\n }\n@@ -137,21 +137,23 @@ interface WhatChangedZoneDetail {\n }\n ```\n \n-## Adversarial Review\n+## Agentic Review\n \n ```typescript\n-interface AdversarialReview {\n+interface AgenticReview {\n   overallGrade: string;             // \"B+\" \u2014 aggregate grade\n-  findings: AdversarialFinding[];\n+  reviewMethod: \"main-agent\" | \"agent-teams\";  // how the review was performed\n+  findings: AgenticFinding[];\n }\n \n-interface AdversarialFinding {\n+interface AgenticFinding {\n   file: string;                     // file path or glob pattern (e.g. \"src/*\")\n   grade: \"A\" | \"B\" | \"B+\" | \"C\" | \"F\" | \"N/A\";\n   zones: string;                    // space-separated zone IDs\n   notable: string;                  // one-line summary of finding\n   detail: string;                   // full explanation (HTML-safe)\n   gradeSortOrder: number;           // 0=N/A, 1=B, 2=B+, 3=A (for severity sort)\n+  agent: string;                    // which agent produced this finding (e.g. \"code-health\", \"security\", \"test-integrity\", \"adversarial\")\n }\n ```\n \n",
      "raw": "# PR Review Pack Data Schema\n\nComplete TypeScript-style interfaces for the `ReviewPackData` object. This is the JSON structure that Pass 2 produces and Pass 3 (the HTML template) consumes.\n\n## Top-Level Container\n\n```typescript\ninterface ReviewPackData {\n  header: PRHeader;\n  architecture: ArchitectureData;\n  specs: Specification[];\n  scenarios: Scenario[];\n  whatChanged: WhatChanged;\n  agenticReview: AgenticReview;\n  ciPerformance: CICheck[];\n  decisions: Decision[];\n  convergence: ConvergenceResult;\n  postMergeItems: PostMergeItem[];\n  factoryHistory: FactoryHistory | null;  // null if not a factory PR\n}\n```\n\n## PR Header\n\n```typescript\ninterface PRHeader {\n  title: string;                    // \"PR #5: Dark Factory v1\"\n  prNumber: number;                 // 5\n  prUrl: string;                    // full GitHub PR URL\n  headBranch: string;               // \"factory/v1\"\n  baseBranch: string;               // \"main\"\n  headSha: string;                  // short SHA, e.g. \"efbf3d4\"\n  additions: number;                // total lines added\n  deletions: number;                // total lines deleted\n  filesChanged: number;             // total files changed\n  commits: number;                  // total commits in PR\n  statusBadges: StatusBadge[];      // top-level status indicators\n  generatedAt: string;              // ISO 8601 timestamp\n  generatedBy: string;              // \"dark factory review agent\"\n}\n\ninterface StatusBadge {\n  label: string;                    // \"CI 5/5\"\n  type: \"pass\" | \"info\" | \"warn\" | \"fail\";  // determines color\n  icon: string;                     // Unicode character, e.g. \"\\u2713\"\n}\n\n// Required badges (Pass 2 must always include these):\n// 1. CI: \"CI X/Y\"         \u2192 pass if all green, fail otherwise\n// 2. Scenarios: \"X/Y Scenarios\" \u2192 pass if all pass, warn/fail otherwise\n// 3. Comments: \"X/Y comments resolved\" \u2192 pass if all resolved (or 0 total),\n//              warn if unresolved exist. Use fail if prerequisite was not met.\n// Additional badges (Gate 2 findings, etc.) are optional.\n```\n\n## Architecture\n\n```typescript\ninterface ArchitectureData {\n  zones: ArchitectureZone[];\n  arrows: ArchitectureArrow[];      // flow arrows between zones\n  rowLabels: RowLabel[];            // \"Factory Infrastructure\", \"Product Code\", etc.\n}\n\ninterface ArchitectureZone {\n  id: string;                       // \"factory-orchestration\" \u2014 matches zone registry key\n  label: string;                    // \"Orchestration\"\n  sublabel: string;                 // \"factory.yaml, SKILL.md\"\n  category: \"factory\" | \"product\" | \"infra\";\n  fileCount: number;                // files changed in this zone\n  position: ZonePosition;           // SVG coordinates\n  specs: string[];                  // linked spec file paths\n  isModified: boolean;              // true if any file in this zone is in the diff\n}\n\ninterface ZonePosition {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n}\n\ninterface ArchitectureArrow {\n  from: { x: number; y: number };\n  to: { x: number; y: number };\n}\n\ninterface RowLabel {\n  text: string;                     // \"Factory Infrastructure\"\n  position: { x: number; y: number };\n}\n```\n\n## Specifications and Scenarios\n\n```typescript\ninterface Specification {\n  path: string;                     // \"specs/system.md\"\n  icon: string;                     // Unicode emoji\n  description: string;              // \"MiniPong DQN component specifications\"\n}\n\ninterface Scenario {\n  name: string;                     // \"Environment Initialization\"\n  category: ScenarioCategory;\n  status: \"pass\" | \"passing\" | \"fail\" | \"failing\" | \"advisory\";  // renderer accepts both short and long forms\n  zone: string;                     // space-separated zone IDs for filtering\n  detail: ScenarioDetail;\n}\n\ntype ScenarioCategory = \"environment\" | \"training\" | \"pipeline\" | \"integration\";\n\ninterface ScenarioDetail {\n  what: string;                     // what the scenario tests\n  how: string;                      // how it is evaluated\n  result: string;                   // pass/fail with explanation\n}\n```\n\n## What Changed\n\n```typescript\ninterface WhatChanged {\n  defaultSummary: WhatChangedLayer;\n  zoneDetails: WhatChangedZoneDetail[];\n}\n\ninterface WhatChangedLayer {\n  infrastructure: string;           // HTML-safe summary of factory/CI/tooling changes\n  product: string;                  // HTML-safe summary of application code changes\n}\n\ninterface WhatChangedZoneDetail {\n  zoneId: string;                   // matches ArchitectureZone.id\n  title: string;                    // \"Factory Orchestration\"\n  description: string;              // HTML-safe description of changes in this zone\n}\n```\n\n## Agentic Review\n\n```typescript\ninterface AgenticReview {\n  overallGrade: string;             // \"B+\" \u2014 aggregate grade\n  reviewMethod: \"main-agent\" | \"agent-teams\";  // how the review was performed\n  findings: AgenticFinding[];\n}\n\ninterface AgenticFinding {\n  file: string;                     // file path or glob pattern (e.g. \"src/*\")\n  grade: \"A\" | \"B\" | \"B+\" | \"C\" | \"F\" | \"N/A\";\n  zones: string;                    // space-separated zone IDs\n  notable: string;                  // one-line summary of finding\n  detail: string;                   // full explanation (HTML-safe)\n  gradeSortOrder: number;           // 0=N/A, 1=B, 2=B+, 3=A (for severity sort)\n  agent: string;                    // which agent produced this finding (e.g. \"code-health\", \"security\", \"test-integrity\", \"adversarial\")\n}\n```\n\n## CI Performance\n\n```typescript\ninterface CICheck {\n  name: string;                     // \"factory-self-test\"\n  trigger: string;                  // \"(push)\" or \"(PR)\"\n  status: \"pass\" | \"fail\";\n  time: string;                     // \"19s\", \"4m 35s\"\n  timeSeconds: number;              // for health classification\n  healthTag: HealthTag;\n  detail: CICheckDetail;\n}\n\ntype HealthTag = \"normal\" | \"acceptable\" | \"watch\" | \"refactor\";\n// normal: < 60s, acceptable: 60-300s, watch: 300-600s, refactor: > 600s\n\ninterface CICheckDetail {\n  coverage: string;                 // what the job covers\n  gates: string;                    // which gates it validates\n  zones: string[];                  // zone IDs this job covers\n  specRefs: string[];               // spec file paths\n  checks: CISubCheck[];             // individual checks within the job\n  notes: string | null;             // additional context\n}\n\ninterface CISubCheck {\n  label: string;                    // \"Lint factory scripts (ruff check)\"\n  detail: string;                   // HTML-safe explanation\n  zones: string[];                  // zone IDs this sub-check covers\n}\n```\n\n## Key Decisions\n\n```typescript\ninterface Decision {\n  number: number;                   // sequential, starting from 1\n  title: string;                    // \"Claude Code orchestrates, CI validates\"\n  rationale: string;                // one-line summary\n  body: string;                     // full explanation (HTML-safe)\n  zones: string;                    // space-separated zone IDs\n  files: DecisionFile[];            // files affected by this decision\n  verified: boolean;                // true if zone claim is verified against diff\n}\n\ninterface DecisionFile {\n  path: string;                     // file path\n  change: string;                   // one-line description of what changed\n}\n```\n\n## Convergence Result\n\n```typescript\ninterface ConvergenceResult {\n  gates: ConvergenceGate[];\n  overall: ConvergenceOverall;\n}\n\ninterface ConvergenceGate {\n  name: string;                     // \"Gate 1 -- Deterministic\"\n  status: \"passing\" | \"warning\" | \"failing\";\n  statusText: string;               // \"PASSING\", \"4 FINDINGS\", \"11/12 PASSING\"\n  summary: string;                  // one-line summary\n  detail: string;                   // HTML-safe expanded detail\n}\n\ninterface ConvergenceOverall {\n  status: \"passing\" | \"warning\" | \"failing\";\n  statusText: string;               // \"READY\"\n  summary: string;\n  detail: string;\n}\n```\n\n## Post-Merge Items\n\n```typescript\ninterface PostMergeItem {\n  priority: \"medium\" | \"low\" | \"cosmetic\";\n  title: string;                    // one-line title (HTML-safe, may contain <code>)\n  description: string;              // context paragraph (HTML-safe)\n  codeSnippet: CodeSnippet | null;  // code block with file reference\n  failureScenario: string;          // what could go wrong\n  successScenario: string;          // what \"fixed\" looks like\n  zones: string[];                  // affected zone IDs\n}\n\ninterface CodeSnippet {\n  file: string;                     // \"scripts/strip_holdout.py\"\n  lineRange: string;                // \"lines 72-78\"\n  code: string;                     // raw code (will be rendered in <pre>)\n}\n```\n\n## Factory History\n\n```typescript\ninterface FactoryHistory {\n  iterationCount: string;           // \"3 + validation\"\n  satisfactionTrajectory: string;   // \"Pre-crank\" or score trajectory\n  satisfactionDetail: string;       // expanded explanation\n  timeline: FactoryEvent[];\n  gateFindings: GateFindingRow[];\n}\n\ninterface FactoryEvent {\n  title: string;                    // event title\n  detail: string;                   // summary description\n  meta: string;                     // \"Commit: 67e5600 . Feb 22\"\n  expandedDetail: string;           // HTML-safe drill-down content\n  type: \"automated\" | \"intervention\";\n  agent: AgentBadge;\n}\n\ninterface AgentBadge {\n  label: string;                    // \"CI (automated)\" or \"Human (Joey)\"\n  type: \"automated\" | \"human\";\n}\n\ninterface GateFindingRow {\n  phase: string;                    // \"Iter 1-3 (factory-loop)\"\n  gate1: GateFindingCell;\n  gate2: GateFindingCell;\n  gate3: GateFindingCell;\n  action: string;                   // \"State commits pushed (before fix)\"\n  phasePopover: string;             // text for popover on phase click\n}\n\ninterface GateFindingCell {\n  status: \"pass\" | \"fail\" | \"not-run\" | \"advisory\";\n  label: string;                    // \"pass\", \"4 findings\", \"11/12\"\n  popover: string;                  // text for popover on click\n}\n```\n\n## Diff Data (Separate File)\n\nThe diff data is loaded separately via fetch (not embedded in the main DATA object). It lives alongside the HTML as `pr_diff_data.json`.\n\n```typescript\ninterface DiffData {\n  pr: number;\n  base_branch: string;\n  head_branch: string;\n  head_sha: string;\n  total_files: number;\n  total_additions: number;\n  total_deletions: number;\n  files: Record<string, FileDiffData>;\n}\n\ninterface FileDiffData {\n  additions: number;\n  deletions: number;\n  status: \"added\" | \"modified\" | \"deleted\" | \"renamed\";\n  binary: boolean;\n  diff: string;                     // unified diff output\n  raw: string;                      // full file content from HEAD\n  base: string;                     // full file content from base branch (empty if new file)\n}\n```\n\n## Zone Registry (Project-Level Config)\n\nNot part of ReviewPackData but consumed by Pass 1 for file-to-zone mapping.\n\n```typescript\ninterface ZoneRegistry {\n  zones: Record<string, ZoneDefinition>;\n}\n\ninterface ZoneDefinition {\n  paths: string[];                  // glob patterns matching files in this zone\n  specs: string[];                  // spec file paths for this zone\n  category: \"factory\" | \"product\" | \"infra\";\n  label: string;                    // display label for SVG diagram\n  sublabel: string;                 // secondary label for SVG diagram\n}\n```\n",
      "base": "# PR Review Pack Data Schema\n\nComplete TypeScript-style interfaces for the `ReviewPackData` object. This is the JSON structure that Pass 2 produces and Pass 3 (the HTML template) consumes.\n\n## Top-Level Container\n\n```typescript\ninterface ReviewPackData {\n  header: PRHeader;\n  architecture: ArchitectureData;\n  specs: Specification[];\n  scenarios: Scenario[];\n  whatChanged: WhatChanged;\n  adversarialReview: AdversarialReview;\n  ciPerformance: CICheck[];\n  decisions: Decision[];\n  convergence: ConvergenceResult;\n  postMergeItems: PostMergeItem[];\n  factoryHistory: FactoryHistory | null;  // null if not a factory PR\n}\n```\n\n## PR Header\n\n```typescript\ninterface PRHeader {\n  title: string;                    // \"PR #5: Dark Factory v1\"\n  prNumber: number;                 // 5\n  prUrl: string;                    // full GitHub PR URL\n  headBranch: string;               // \"factory/v1\"\n  baseBranch: string;               // \"main\"\n  headSha: string;                  // short SHA, e.g. \"efbf3d4\"\n  additions: number;                // total lines added\n  deletions: number;                // total lines deleted\n  filesChanged: number;             // total files changed\n  commits: number;                  // total commits in PR\n  statusBadges: StatusBadge[];      // top-level status indicators\n  generatedAt: string;              // ISO 8601 timestamp\n  generatedBy: string;              // \"dark factory review agent\"\n}\n\ninterface StatusBadge {\n  label: string;                    // \"CI 5/5\"\n  type: \"pass\" | \"info\" | \"warn\" | \"fail\";  // determines color\n  icon: string;                     // Unicode character, e.g. \"\\u2713\"\n}\n\n// Required badges (Pass 2 must always include these):\n// 1. CI: \"CI X/Y\"         \u2192 pass if all green, fail otherwise\n// 2. Scenarios: \"X/Y Scenarios\" \u2192 pass if all pass, warn/fail otherwise\n// 3. Comments: \"X/Y comments resolved\" \u2192 pass if all resolved (or 0 total),\n//              warn if unresolved exist. Use fail if prerequisite was not met.\n// Additional badges (Gate 2 findings, etc.) are optional.\n```\n\n## Architecture\n\n```typescript\ninterface ArchitectureData {\n  zones: ArchitectureZone[];\n  arrows: ArchitectureArrow[];      // flow arrows between zones\n  rowLabels: RowLabel[];            // \"Factory Infrastructure\", \"Product Code\", etc.\n}\n\ninterface ArchitectureZone {\n  id: string;                       // \"factory-orchestration\" \u2014 matches zone registry key\n  label: string;                    // \"Orchestration\"\n  sublabel: string;                 // \"factory.yaml, SKILL.md\"\n  category: \"factory\" | \"product\" | \"infra\";\n  fileCount: number;                // files changed in this zone\n  position: ZonePosition;           // SVG coordinates\n  specs: string[];                  // linked spec file paths\n  isModified: boolean;              // true if any file in this zone is in the diff\n}\n\ninterface ZonePosition {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n}\n\ninterface ArchitectureArrow {\n  from: { x: number; y: number };\n  to: { x: number; y: number };\n}\n\ninterface RowLabel {\n  text: string;                     // \"Factory Infrastructure\"\n  position: { x: number; y: number };\n}\n```\n\n## Specifications and Scenarios\n\n```typescript\ninterface Specification {\n  path: string;                     // \"specs/system.md\"\n  icon: string;                     // Unicode emoji\n  description: string;              // \"MiniPong DQN component specifications\"\n}\n\ninterface Scenario {\n  name: string;                     // \"Environment Initialization\"\n  category: ScenarioCategory;\n  status: \"passing\" | \"failing\" | \"advisory\";\n  zone: string;                     // space-separated zone IDs for filtering\n  detail: ScenarioDetail;\n}\n\ntype ScenarioCategory = \"environment\" | \"training\" | \"pipeline\" | \"integration\";\n\ninterface ScenarioDetail {\n  what: string;                     // what the scenario tests\n  how: string;                      // how it is evaluated\n  result: string;                   // pass/fail with explanation\n}\n```\n\n## What Changed\n\n```typescript\ninterface WhatChanged {\n  defaultSummary: WhatChangedLayer;\n  zoneDetails: WhatChangedZoneDetail[];\n}\n\ninterface WhatChangedLayer {\n  infrastructure: string;           // HTML-safe summary of factory/CI/tooling changes\n  product: string;                  // HTML-safe summary of application code changes\n}\n\ninterface WhatChangedZoneDetail {\n  zoneId: string;                   // matches ArchitectureZone.id\n  title: string;                    // \"Factory Orchestration\"\n  description: string;              // HTML-safe description of changes in this zone\n}\n```\n\n## Adversarial Review\n\n```typescript\ninterface AdversarialReview {\n  overallGrade: string;             // \"B+\" \u2014 aggregate grade\n  findings: AdversarialFinding[];\n}\n\ninterface AdversarialFinding {\n  file: string;                     // file path or glob pattern (e.g. \"src/*\")\n  grade: \"A\" | \"B\" | \"B+\" | \"C\" | \"F\" | \"N/A\";\n  zones: string;                    // space-separated zone IDs\n  notable: string;                  // one-line summary of finding\n  detail: string;                   // full explanation (HTML-safe)\n  gradeSortOrder: number;           // 0=N/A, 1=B, 2=B+, 3=A (for severity sort)\n}\n```\n\n## CI Performance\n\n```typescript\ninterface CICheck {\n  name: string;                     // \"factory-self-test\"\n  trigger: string;                  // \"(push)\" or \"(PR)\"\n  status: \"pass\" | \"fail\";\n  time: string;                     // \"19s\", \"4m 35s\"\n  timeSeconds: number;              // for health classification\n  healthTag: HealthTag;\n  detail: CICheckDetail;\n}\n\ntype HealthTag = \"normal\" | \"acceptable\" | \"watch\" | \"refactor\";\n// normal: < 60s, acceptable: 60-300s, watch: 300-600s, refactor: > 600s\n\ninterface CICheckDetail {\n  coverage: string;                 // what the job covers\n  gates: string;                    // which gates it validates\n  zones: string[];                  // zone IDs this job covers\n  specRefs: string[];               // spec file paths\n  checks: CISubCheck[];             // individual checks within the job\n  notes: string | null;             // additional context\n}\n\ninterface CISubCheck {\n  label: string;                    // \"Lint factory scripts (ruff check)\"\n  detail: string;                   // HTML-safe explanation\n  zones: string[];                  // zone IDs this sub-check covers\n}\n```\n\n## Key Decisions\n\n```typescript\ninterface Decision {\n  number: number;                   // sequential, starting from 1\n  title: string;                    // \"Claude Code orchestrates, CI validates\"\n  rationale: string;                // one-line summary\n  body: string;                     // full explanation (HTML-safe)\n  zones: string;                    // space-separated zone IDs\n  files: DecisionFile[];            // files affected by this decision\n  verified: boolean;                // true if zone claim is verified against diff\n}\n\ninterface DecisionFile {\n  path: string;                     // file path\n  change: string;                   // one-line description of what changed\n}\n```\n\n## Convergence Result\n\n```typescript\ninterface ConvergenceResult {\n  gates: ConvergenceGate[];\n  overall: ConvergenceOverall;\n}\n\ninterface ConvergenceGate {\n  name: string;                     // \"Gate 1 -- Deterministic\"\n  status: \"passing\" | \"warning\" | \"failing\";\n  statusText: string;               // \"PASSING\", \"4 FINDINGS\", \"11/12 PASSING\"\n  summary: string;                  // one-line summary\n  detail: string;                   // HTML-safe expanded detail\n}\n\ninterface ConvergenceOverall {\n  status: \"passing\" | \"warning\" | \"failing\";\n  statusText: string;               // \"READY\"\n  summary: string;\n  detail: string;\n}\n```\n\n## Post-Merge Items\n\n```typescript\ninterface PostMergeItem {\n  priority: \"medium\" | \"low\" | \"cosmetic\";\n  title: string;                    // one-line title (HTML-safe, may contain <code>)\n  description: string;              // context paragraph (HTML-safe)\n  codeSnippet: CodeSnippet | null;  // code block with file reference\n  failureScenario: string;          // what could go wrong\n  successScenario: string;          // what \"fixed\" looks like\n  zones: string[];                  // affected zone IDs\n}\n\ninterface CodeSnippet {\n  file: string;                     // \"scripts/strip_holdout.py\"\n  lineRange: string;                // \"lines 72-78\"\n  code: string;                     // raw code (will be rendered in <pre>)\n}\n```\n\n## Factory History\n\n```typescript\ninterface FactoryHistory {\n  iterationCount: string;           // \"3 + validation\"\n  satisfactionTrajectory: string;   // \"Pre-crank\" or score trajectory\n  satisfactionDetail: string;       // expanded explanation\n  timeline: FactoryEvent[];\n  gateFindings: GateFindingRow[];\n}\n\ninterface FactoryEvent {\n  title: string;                    // event title\n  detail: string;                   // summary description\n  meta: string;                     // \"Commit: 67e5600 . Feb 22\"\n  expandedDetail: string;           // HTML-safe drill-down content\n  type: \"automated\" | \"intervention\";\n  agent: AgentBadge;\n}\n\ninterface AgentBadge {\n  label: string;                    // \"CI (automated)\" or \"Human (Joey)\"\n  type: \"automated\" | \"human\";\n}\n\ninterface GateFindingRow {\n  phase: string;                    // \"Iter 1-3 (factory-loop)\"\n  gate1: GateFindingCell;\n  gate2: GateFindingCell;\n  gate3: GateFindingCell;\n  action: string;                   // \"State commits pushed (before fix)\"\n  phasePopover: string;             // text for popover on phase click\n}\n\ninterface GateFindingCell {\n  status: \"pass\" | \"fail\" | \"not-run\" | \"advisory\";\n  label: string;                    // \"pass\", \"4 findings\", \"11/12\"\n  popover: string;                  // text for popover on click\n}\n```\n\n## Diff Data (Separate File)\n\nThe diff data is loaded separately via fetch (not embedded in the main DATA object). It lives alongside the HTML as `pr_diff_data.json`.\n\n```typescript\ninterface DiffData {\n  pr: number;\n  base_branch: string;\n  head_branch: string;\n  head_sha: string;\n  total_files: number;\n  total_additions: number;\n  total_deletions: number;\n  files: Record<string, FileDiffData>;\n}\n\ninterface FileDiffData {\n  additions: number;\n  deletions: number;\n  status: \"added\" | \"modified\" | \"deleted\" | \"renamed\";\n  binary: boolean;\n  diff: string;                     // unified diff output\n  raw: string;                      // full file content from HEAD\n  base: string;                     // full file content from base branch (empty if new file)\n}\n```\n\n## Zone Registry (Project-Level Config)\n\nNot part of ReviewPackData but consumed by Pass 1 for file-to-zone mapping.\n\n```typescript\ninterface ZoneRegistry {\n  zones: Record<string, ZoneDefinition>;\n}\n\ninterface ZoneDefinition {\n  paths: string[];                  // glob patterns matching files in this zone\n  specs: string[];                  // spec file paths for this zone\n  category: \"factory\" | \"product\" | \"infra\";\n  label: string;                    // display label for SVG diagram\n  sublabel: string;                 // secondary label for SVG diagram\n}\n```\n"
    },
    ".claude/skills/pr-review-pack/references/section-guide.md": {
      "additions": 17,
      "deletions": 10,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/.claude/skills/pr-review-pack/references/section-guide.md b/.claude/skills/pr-review-pack/references/section-guide.md\nindex b093313..b212745 100644\n--- a/.claude/skills/pr-review-pack/references/section-guide.md\n+++ b/.claude/skills/pr-review-pack/references/section-guide.md\n@@ -25,7 +25,7 @@ Section-by-section reference for building the review pack. Each section document\n - `infra`: fill `#f3e8ff`, stroke `#8b5cf6`, label fill `#6d28d9`, count circle `#8b5cf6`\n \n **Interactive behaviors:**\n-- **Zone click:** Highlights the clicked zone, dims all others, filters Adversarial Review, Scenarios, and What Changed sections to show only that zone's content. Click same zone again to reset.\n+- **Zone click:** Highlights the clicked zone, dims all others, filters Agentic Review, Scenarios, and What Changed sections to show only that zone's content. Click same zone again to reset.\n - **Background click:** Resets all zone filtering.\n - **Baseline/Update toggle:** Baseline sets all zone boxes to opacity 0.25. Update restores full opacity.\n - **Floating diagram:** When the main architecture diagram scrolls out of view, a floating minimap appears at top-right. It has the same click behaviors. Dismissible via X button.\n@@ -94,22 +94,29 @@ Section-by-section reference for building the review pack. Each section document\n \n ---\n \n-## Section 5: Adversarial Review\n+## Section 5: Agentic Review\n \n-**What it shows:** Graded table of adversarial findings per file or file group.\n+**What it shows:** Per-file grouped table of review findings from multiple specialized agents (code-health, security, test-integrity, adversarial), with compact grade badges per agent and expandable detail.\n \n-**Data source:** Pass 2 (adversarial reviewer agent).\n+**Data source:** Pass 2 (agent team \u2014 each agent reviews through its paradigm).\n \n **Required fields:**\n-- `adversarialReview.overallGrade` -- aggregate grade for section header\n-- `adversarialReview.findings[]` -- file, grade, zones, notable, detail, gradeSortOrder\n+- `agenticReview.overallGrade` -- aggregate grade for section header\n+- `agenticReview.reviewMethod` -- `\"main-agent\"` or `\"agent-teams\"` \u2014 rendered as a badge in the section header\n+- `agenticReview.findings[]` -- file, grade, zones, notable, detail, gradeSortOrder, agent\n \n **HTML structure:**\n-- `.section` with header showing \"Adversarial Review -- Grade: {overallGrade}\"\n+- `.section` with header showing \"Agentic Review -- Grade: {overallGrade}\" + review method badge + agent legend\n - `.adv-scroll` wrapper (max-height 500px, overflow scroll)\n-- `<table id=\"adv-table\">` with thead (File | Grade | Zone | Notable)\n-- Alternating `.adv-row` (clickable) and `.adv-detail-row` (hidden until clicked)\n+- `<table id=\"adv-table\">` with thead (File | Agents | Zone | Notable)\n+- Per-file rows (`.adv-row`, clickable) with compact agent grade badges (e.g. CH:A SE:B TI:A AD:B+)\n+- `.adv-detail-row` (hidden until clicked) containing per-agent detail entries\n - `#adv-no-match` message (shown when zone filter has no matches)\n+- `.agent-legend` showing abbreviation\u2192full-name mapping (CH=Code Health, SE=Security, TI=Test Integrity, AD=Adversarial)\n+\n+**Review method badge rendering:**\n+- `main-agent`: `.review-method-badge.main-agent` (gray, indicates single-agent review)\n+- `agent-teams`: `.review-method-badge.agent-teams` (blue, indicates parallel team review)\n \n **Grade rendering:**\n - A: `.grade.a` (green)\n@@ -219,7 +226,7 @@ Section-by-section reference for building the review pack. Each section document\n \n **What it shows:** Prioritized list of items to address after merge.\n \n-**Data source:** Pass 2 (adversarial reviewer + semantic analysis team).\n+**Data source:** Pass 2 (agentic review team + semantic analysis team).\n \n **Required fields:**\n - `postMergeItems[]` -- priority, title, description, codeSnippet, failureScenario, successScenario, zones\n",
      "raw": "# PR Review Pack Section Guide\n\nSection-by-section reference for building the review pack. Each section documents what it shows, where the data comes from, required fields, interactive behaviors, and validation rules.\n\n## Section 1: Architecture (Baseline + Update)\n\n**What it shows:** Two SVG diagrams showing system architecture zones. \"Update\" shows the PR-modified zones highlighted. \"Baseline\" dims all zones to show the pre-merge state.\n\n**Data source:** Pass 1 (zone registry + file-to-zone mapping). Zone positions and labels are static from the registry.\n\n**Required fields:**\n- `architecture.zones[]` -- each zone with id, label, sublabel, category, fileCount, position, isModified\n- `architecture.arrows[]` -- flow arrows (factory pipeline direction)\n- `architecture.rowLabels[]` -- row header text and position\n\n**HTML structure:** Collapsible `.section` containing:\n- `.arch-controls` with Baseline/Update toggle buttons\n- `<svg>` with `viewBox=\"0 0 780 360\"` containing zone boxes, labels, count badges, arrows\n- `#zone-filter-info` for active filter display\n- `.arch-legend` with color swatches\n\n**Zone box rendering per category:**\n- `factory`: fill `#dbeafe`, stroke `#3b82f6`, label fill `#1d4ed8`, count circle `#3b82f6`\n- `product`: fill `#dcfce7`, stroke `#22c55e`, label fill `#166534`, count circle `#22c55e`\n- `infra`: fill `#f3e8ff`, stroke `#8b5cf6`, label fill `#6d28d9`, count circle `#8b5cf6`\n\n**Interactive behaviors:**\n- **Zone click:** Highlights the clicked zone, dims all others, filters Agentic Review, Scenarios, and What Changed sections to show only that zone's content. Click same zone again to reset.\n- **Background click:** Resets all zone filtering.\n- **Baseline/Update toggle:** Baseline sets all zone boxes to opacity 0.25. Update restores full opacity.\n- **Floating diagram:** When the main architecture diagram scrolls out of view, a floating minimap appears at top-right. It has the same click behaviors. Dismissible via X button.\n\n**Validation rules:**\n- Every zone in the registry must appear in the SVG\n- fileCount must match actual count from Pass 1 diff\n- Only zones with isModified=true show count badges in Update view\n\n---\n\n## Section 3: Spec & Scenarios\n\n**What it shows:** Which specifications drove this work and which behavioral scenarios evaluate it.\n\n**Data source:** Pass 2 (semantic team identifies relevant specs and scenario results).\n\n**Required fields:**\n- `specs[]` -- path, icon, description for each specification\n- `scenarios[]` -- name, category, status, zone, detail (what/how/result)\n\n**HTML structure:**\n- `<ul class=\"spec-list\">` for specifications (icon + code path + description)\n- `.scenario-legend` with category color pills\n- `.scenario-grid` (2-column grid) of `.scenario-card` items\n\n**Scenario category CSS classes:**\n- `cat-environment`: green (#dcfce7 / #166534)\n- `cat-training`: blue (#dbeafe / #1d4ed8)\n- `cat-pipeline`: purple (#f3e8ff / #6d28d9)\n- `cat-integration`: orange (#fff7ed / #9a3412)\n\n**Interactive behaviors:**\n- **Scenario card click:** Toggles open/closed. When open, shows a `<dl>` with What/How/Result.\n- **Zone filtering:** When a zone is active, scenario cards matching that zone get `.zone-glow` (blue ring), non-matching cards get `.zone-dimmed` (opacity 0.35).\n\n**Validation rules:**\n- Every scenario must have a non-empty zone attribute (for filtering)\n- Status must be one of: passing, failing, advisory\n- Spec file paths must exist in the repository\n\n---\n\n## Section 4: What Changed\n\n**What it shows:** Two-layer summary of changes: Infrastructure and Product. When a zone is selected, shows zone-specific detail instead.\n\n**Data source:** Pass 2 (delegated diff-reading agent). NOT from main thread context. Code diffs are ground truth.\n\n**Required fields:**\n- `whatChanged.defaultSummary.infrastructure` -- HTML-safe summary\n- `whatChanged.defaultSummary.product` -- HTML-safe summary\n- `whatChanged.zoneDetails[]` -- zoneId, title, description for each zone\n\n**HTML structure:**\n- `#wc-default` div with Infrastructure and Product paragraphs (shown by default)\n- `.wc-zone-detail[data-zone=\"...\"]` divs for each zone (hidden by default, shown when zone is active)\n\n**Interactive behaviors:**\n- When a zone is active via architecture diagram click, `#wc-default` hides and the matching `.wc-zone-detail` shows.\n- When zones are reset, `#wc-default` reappears and all zone details hide.\n\n**Validation rules:**\n- Every zone that has files in the diff should have a corresponding zone detail\n- Summaries must describe actual changes from the diff, not from main thread context\n\n---\n\n## Section 5: Agentic Review\n\n**What it shows:** Per-file grouped table of review findings from multiple specialized agents (code-health, security, test-integrity, adversarial), with compact grade badges per agent and expandable detail.\n\n**Data source:** Pass 2 (agent team \u2014 each agent reviews through its paradigm).\n\n**Required fields:**\n- `agenticReview.overallGrade` -- aggregate grade for section header\n- `agenticReview.reviewMethod` -- `\"main-agent\"` or `\"agent-teams\"` \u2014 rendered as a badge in the section header\n- `agenticReview.findings[]` -- file, grade, zones, notable, detail, gradeSortOrder, agent\n\n**HTML structure:**\n- `.section` with header showing \"Agentic Review -- Grade: {overallGrade}\" + review method badge + agent legend\n- `.adv-scroll` wrapper (max-height 500px, overflow scroll)\n- `<table id=\"adv-table\">` with thead (File | Agents | Zone | Notable)\n- Per-file rows (`.adv-row`, clickable) with compact agent grade badges (e.g. CH:A SE:B TI:A AD:B+)\n- `.adv-detail-row` (hidden until clicked) containing per-agent detail entries\n- `#adv-no-match` message (shown when zone filter has no matches)\n- `.agent-legend` showing abbreviation\u2192full-name mapping (CH=Code Health, SE=Security, TI=Test Integrity, AD=Adversarial)\n\n**Review method badge rendering:**\n- `main-agent`: `.review-method-badge.main-agent` (gray, indicates single-agent review)\n- `agent-teams`: `.review-method-badge.agent-teams` (blue, indicates parallel team review)\n\n**Grade rendering:**\n- A: `.grade.a` (green)\n- B/B+: `.grade.b` (yellow)\n- C: `.grade.c` (orange)\n- F: `.grade.f` (red)\n- N/A: `.grade.na` (gray)\n\n**Interactive behaviors:**\n- **Row click:** Toggles the adjacent `.adv-detail-row` open/closed.\n- **Zone filtering:** Non-matching rows get `.collapsed-row` (shrunk, faded). Their detail rows are hidden. If no rows match the active zone, `#adv-no-match` appears.\n\n**Validation rules:**\n- Rows must be sorted by severity (most severe first): N/A, F, C, B, B+, A\n- Every finding must have a valid zone that exists in the architecture\n- Grade must be one of: A, B, B+, C, F, N/A\n\n---\n\n## Section 6: CI Performance\n\n**What it shows:** Expandable table of CI jobs with status, timing, and health classification.\n\n**Data source:** Pass 1 (`gh pr checks` output) + Pass 2 (semantic detail about what each job covers).\n\n**Required fields:**\n- `ciPerformance[]` -- name, trigger, status, time, timeSeconds, healthTag, detail\n\n**HTML structure:**\n- `<table>` with thead (Check | Status | Time | chevron)\n- Alternating `tr.expandable` (clickable) and `tr.detail-row` (hidden)\n- Expandable rows contain sub-checks as `.ci-check-item` divs with their own expand/collapse\n\n**Time health rendering:**\n- `normal` (< 60s): green check icon, `.health-tag.normal`\n- `acceptable` (60-300s): circle icon, `.health-tag.acceptable`\n- `watch` (300-600s): warning icon, `.health-tag.watch`\n- `refactor` (> 600s): X icon, `.health-tag.refactor`\n\n**Interactive behaviors:**\n- **Row click:** Toggles the detail row open/closed. Chevron rotates.\n- **Sub-check click:** Each `.ci-check-item` toggles its own `.ci-check-detail` independently.\n\n**Validation rules:**\n- Health tag must match the timeSeconds classification thresholds\n- All CI jobs reported by `gh pr checks` must appear\n- Zone tags in sub-checks must reference valid zones from the registry\n\n---\n\n## Section 7: Key Decisions\n\n**What it shows:** Expandable decision cards with zone highlighting and filtered file lists.\n\n**Data source:** Pass 2 (semantic analysis team). Zone claims verified against diff in Pass 2 verification step.\n\n**Required fields:**\n- `decisions[]` -- number, title, rationale, body, zones, files[], verified\n\n**HTML structure:**\n- `.decision-card[data-zones=\"...\"]` with:\n  - `.decision-header` (clickable): number, title, rationale\n  - `.decision-body` (hidden): full explanation, `.decision-zones` tags, `.decision-files` table\n\n**Interactive behaviors:**\n- **Card click:** Opens the decision card, closes all others. When open, calls `highlightZones()` to highlight this decision's zones in the architecture diagram and filter other sections.\n- **Close:** Clicking an open card closes it and calls `resetZones()`.\n- **File path click:** Opens the file modal with diff/raw/split view for that file.\n\n**Validation rules:**\n- Each decision's zone claim must be verified: at least one file in the diff touches that zone's paths\n- Unverified claims must be visually flagged (not silently rendered)\n- Decision numbers must be sequential starting from 1\n- File paths in the decision's file list must appear in the diff\n\n---\n\n## Section 8: Convergence Result\n\n**What it shows:** Gate-by-gate status with expandable detail cards.\n\n**Data source:** Pass 2 (convergence analysis from gate outputs).\n\n**Required fields:**\n- `convergence.gates[]` -- name, status, statusText, summary, detail\n- `convergence.overall` -- status, statusText, summary, detail\n\n**HTML structure:**\n- `.convergence-grid` (2x2 grid of `.conv-card` items)\n- Each card: `<h4>` (gate name), `.conv-status` (large status text), `.conv-detail` (summary), `.conv-card-detail` (hidden drill-down)\n\n**Status rendering:**\n- `passing`: `.conv-status.passing` (green)\n- `warning`: `.conv-status.warning` (yellow)\n- `failing`: `.conv-status.failing` (red)\n\n**Interactive behaviors:**\n- **Card click:** Toggles the `.conv-card-detail` drill-down visible/hidden.\n\n**Validation rules:**\n- Overall status must be consistent with individual gate statuses\n- If any gate is \"failing\", overall cannot be \"passing\"\n\n---\n\n## Section 9: Post-Merge Items\n\n**What it shows:** Prioritized list of items to address after merge.\n\n**Data source:** Pass 2 (agentic review team + semantic analysis team).\n\n**Required fields:**\n- `postMergeItems[]` -- priority, title, description, codeSnippet, failureScenario, successScenario, zones\n\n**HTML structure:**\n- `.pm-item` with:\n  - `.pm-header` (clickable): `.priority` tag + title\n  - `.pm-body` (hidden): description paragraph, `.code-block` snippet, `.scenario-box.failure`, `.scenario-box.success`\n\n**Priority rendering:**\n- `medium`: `.priority.medium` (yellow)\n- `low`: `.priority.low` (blue)\n- `cosmetic`: `.priority.cosmetic` (gray)\n\n**Interactive behaviors:**\n- **Header click:** Toggles the `.pm-body` visible/hidden.\n- **File path click:** Inside code snippets, file paths can link to the file modal.\n\n**Validation rules:**\n- Code snippet line references must exist in the actual diff\n- File paths in code snippets must appear in the diff file list\n- Priority must be one of: medium, low, cosmetic\n\n---\n\n## Factory History (Tab 2)\n\n**What it shows:** Convergence loop visibility -- iterations, interventions, gate findings over time.\n\n**Data source:** Pass 2 (factory history reconstruction from commit log and CI data).\n\n**Required fields:**\n- `factoryHistory.iterationCount`\n- `factoryHistory.satisfactionTrajectory`\n- `factoryHistory.timeline[]` -- each event with title, detail, meta, expandedDetail, type, agent\n- `factoryHistory.gateFindings[]` -- phase-by-phase gate results\n\n**HTML structure:**\n- Summary cards (`.convergence-grid`): iteration count + satisfaction trajectory\n- `.history-timeline` with `.history-event` items (timeline with vertical line and dots)\n- `#gate-findings-table` with gate results per iteration/phase\n\n**Event type rendering:**\n- `automated`: blue dot (`.history-event` default)\n- `intervention`: orange dot (`.history-event.intervention`)\n\n**Agent badge rendering:**\n- `automated`: `.event-agent` (blue)\n- `human`: `.event-agent.human` (orange)\n\n**Interactive behaviors:**\n- **Event click:** Toggles `.history-event-detail` drill-down.\n- **Gate finding click:** Shows popover (`.gate-popover`) with detailed gate result explanation. Auto-dismisses after 5 seconds.\n\n**Validation rules:**\n- Timeline events should be in chronological order\n- Gate findings must reference gates that exist in the convergence section\n- If factoryHistory is null, the \"Factory History\" tab should not appear in the tab bar\n",
      "base": "# PR Review Pack Section Guide\n\nSection-by-section reference for building the review pack. Each section documents what it shows, where the data comes from, required fields, interactive behaviors, and validation rules.\n\n## Section 1: Architecture (Baseline + Update)\n\n**What it shows:** Two SVG diagrams showing system architecture zones. \"Update\" shows the PR-modified zones highlighted. \"Baseline\" dims all zones to show the pre-merge state.\n\n**Data source:** Pass 1 (zone registry + file-to-zone mapping). Zone positions and labels are static from the registry.\n\n**Required fields:**\n- `architecture.zones[]` -- each zone with id, label, sublabel, category, fileCount, position, isModified\n- `architecture.arrows[]` -- flow arrows (factory pipeline direction)\n- `architecture.rowLabels[]` -- row header text and position\n\n**HTML structure:** Collapsible `.section` containing:\n- `.arch-controls` with Baseline/Update toggle buttons\n- `<svg>` with `viewBox=\"0 0 780 360\"` containing zone boxes, labels, count badges, arrows\n- `#zone-filter-info` for active filter display\n- `.arch-legend` with color swatches\n\n**Zone box rendering per category:**\n- `factory`: fill `#dbeafe`, stroke `#3b82f6`, label fill `#1d4ed8`, count circle `#3b82f6`\n- `product`: fill `#dcfce7`, stroke `#22c55e`, label fill `#166534`, count circle `#22c55e`\n- `infra`: fill `#f3e8ff`, stroke `#8b5cf6`, label fill `#6d28d9`, count circle `#8b5cf6`\n\n**Interactive behaviors:**\n- **Zone click:** Highlights the clicked zone, dims all others, filters Adversarial Review, Scenarios, and What Changed sections to show only that zone's content. Click same zone again to reset.\n- **Background click:** Resets all zone filtering.\n- **Baseline/Update toggle:** Baseline sets all zone boxes to opacity 0.25. Update restores full opacity.\n- **Floating diagram:** When the main architecture diagram scrolls out of view, a floating minimap appears at top-right. It has the same click behaviors. Dismissible via X button.\n\n**Validation rules:**\n- Every zone in the registry must appear in the SVG\n- fileCount must match actual count from Pass 1 diff\n- Only zones with isModified=true show count badges in Update view\n\n---\n\n## Section 3: Spec & Scenarios\n\n**What it shows:** Which specifications drove this work and which behavioral scenarios evaluate it.\n\n**Data source:** Pass 2 (semantic team identifies relevant specs and scenario results).\n\n**Required fields:**\n- `specs[]` -- path, icon, description for each specification\n- `scenarios[]` -- name, category, status, zone, detail (what/how/result)\n\n**HTML structure:**\n- `<ul class=\"spec-list\">` for specifications (icon + code path + description)\n- `.scenario-legend` with category color pills\n- `.scenario-grid` (2-column grid) of `.scenario-card` items\n\n**Scenario category CSS classes:**\n- `cat-environment`: green (#dcfce7 / #166534)\n- `cat-training`: blue (#dbeafe / #1d4ed8)\n- `cat-pipeline`: purple (#f3e8ff / #6d28d9)\n- `cat-integration`: orange (#fff7ed / #9a3412)\n\n**Interactive behaviors:**\n- **Scenario card click:** Toggles open/closed. When open, shows a `<dl>` with What/How/Result.\n- **Zone filtering:** When a zone is active, scenario cards matching that zone get `.zone-glow` (blue ring), non-matching cards get `.zone-dimmed` (opacity 0.35).\n\n**Validation rules:**\n- Every scenario must have a non-empty zone attribute (for filtering)\n- Status must be one of: passing, failing, advisory\n- Spec file paths must exist in the repository\n\n---\n\n## Section 4: What Changed\n\n**What it shows:** Two-layer summary of changes: Infrastructure and Product. When a zone is selected, shows zone-specific detail instead.\n\n**Data source:** Pass 2 (delegated diff-reading agent). NOT from main thread context. Code diffs are ground truth.\n\n**Required fields:**\n- `whatChanged.defaultSummary.infrastructure` -- HTML-safe summary\n- `whatChanged.defaultSummary.product` -- HTML-safe summary\n- `whatChanged.zoneDetails[]` -- zoneId, title, description for each zone\n\n**HTML structure:**\n- `#wc-default` div with Infrastructure and Product paragraphs (shown by default)\n- `.wc-zone-detail[data-zone=\"...\"]` divs for each zone (hidden by default, shown when zone is active)\n\n**Interactive behaviors:**\n- When a zone is active via architecture diagram click, `#wc-default` hides and the matching `.wc-zone-detail` shows.\n- When zones are reset, `#wc-default` reappears and all zone details hide.\n\n**Validation rules:**\n- Every zone that has files in the diff should have a corresponding zone detail\n- Summaries must describe actual changes from the diff, not from main thread context\n\n---\n\n## Section 5: Adversarial Review\n\n**What it shows:** Graded table of adversarial findings per file or file group.\n\n**Data source:** Pass 2 (adversarial reviewer agent).\n\n**Required fields:**\n- `adversarialReview.overallGrade` -- aggregate grade for section header\n- `adversarialReview.findings[]` -- file, grade, zones, notable, detail, gradeSortOrder\n\n**HTML structure:**\n- `.section` with header showing \"Adversarial Review -- Grade: {overallGrade}\"\n- `.adv-scroll` wrapper (max-height 500px, overflow scroll)\n- `<table id=\"adv-table\">` with thead (File | Grade | Zone | Notable)\n- Alternating `.adv-row` (clickable) and `.adv-detail-row` (hidden until clicked)\n- `#adv-no-match` message (shown when zone filter has no matches)\n\n**Grade rendering:**\n- A: `.grade.a` (green)\n- B/B+: `.grade.b` (yellow)\n- C: `.grade.c` (orange)\n- F: `.grade.f` (red)\n- N/A: `.grade.na` (gray)\n\n**Interactive behaviors:**\n- **Row click:** Toggles the adjacent `.adv-detail-row` open/closed.\n- **Zone filtering:** Non-matching rows get `.collapsed-row` (shrunk, faded). Their detail rows are hidden. If no rows match the active zone, `#adv-no-match` appears.\n\n**Validation rules:**\n- Rows must be sorted by severity (most severe first): N/A, F, C, B, B+, A\n- Every finding must have a valid zone that exists in the architecture\n- Grade must be one of: A, B, B+, C, F, N/A\n\n---\n\n## Section 6: CI Performance\n\n**What it shows:** Expandable table of CI jobs with status, timing, and health classification.\n\n**Data source:** Pass 1 (`gh pr checks` output) + Pass 2 (semantic detail about what each job covers).\n\n**Required fields:**\n- `ciPerformance[]` -- name, trigger, status, time, timeSeconds, healthTag, detail\n\n**HTML structure:**\n- `<table>` with thead (Check | Status | Time | chevron)\n- Alternating `tr.expandable` (clickable) and `tr.detail-row` (hidden)\n- Expandable rows contain sub-checks as `.ci-check-item` divs with their own expand/collapse\n\n**Time health rendering:**\n- `normal` (< 60s): green check icon, `.health-tag.normal`\n- `acceptable` (60-300s): circle icon, `.health-tag.acceptable`\n- `watch` (300-600s): warning icon, `.health-tag.watch`\n- `refactor` (> 600s): X icon, `.health-tag.refactor`\n\n**Interactive behaviors:**\n- **Row click:** Toggles the detail row open/closed. Chevron rotates.\n- **Sub-check click:** Each `.ci-check-item` toggles its own `.ci-check-detail` independently.\n\n**Validation rules:**\n- Health tag must match the timeSeconds classification thresholds\n- All CI jobs reported by `gh pr checks` must appear\n- Zone tags in sub-checks must reference valid zones from the registry\n\n---\n\n## Section 7: Key Decisions\n\n**What it shows:** Expandable decision cards with zone highlighting and filtered file lists.\n\n**Data source:** Pass 2 (semantic analysis team). Zone claims verified against diff in Pass 2 verification step.\n\n**Required fields:**\n- `decisions[]` -- number, title, rationale, body, zones, files[], verified\n\n**HTML structure:**\n- `.decision-card[data-zones=\"...\"]` with:\n  - `.decision-header` (clickable): number, title, rationale\n  - `.decision-body` (hidden): full explanation, `.decision-zones` tags, `.decision-files` table\n\n**Interactive behaviors:**\n- **Card click:** Opens the decision card, closes all others. When open, calls `highlightZones()` to highlight this decision's zones in the architecture diagram and filter other sections.\n- **Close:** Clicking an open card closes it and calls `resetZones()`.\n- **File path click:** Opens the file modal with diff/raw/split view for that file.\n\n**Validation rules:**\n- Each decision's zone claim must be verified: at least one file in the diff touches that zone's paths\n- Unverified claims must be visually flagged (not silently rendered)\n- Decision numbers must be sequential starting from 1\n- File paths in the decision's file list must appear in the diff\n\n---\n\n## Section 8: Convergence Result\n\n**What it shows:** Gate-by-gate status with expandable detail cards.\n\n**Data source:** Pass 2 (convergence analysis from gate outputs).\n\n**Required fields:**\n- `convergence.gates[]` -- name, status, statusText, summary, detail\n- `convergence.overall` -- status, statusText, summary, detail\n\n**HTML structure:**\n- `.convergence-grid` (2x2 grid of `.conv-card` items)\n- Each card: `<h4>` (gate name), `.conv-status` (large status text), `.conv-detail` (summary), `.conv-card-detail` (hidden drill-down)\n\n**Status rendering:**\n- `passing`: `.conv-status.passing` (green)\n- `warning`: `.conv-status.warning` (yellow)\n- `failing`: `.conv-status.failing` (red)\n\n**Interactive behaviors:**\n- **Card click:** Toggles the `.conv-card-detail` drill-down visible/hidden.\n\n**Validation rules:**\n- Overall status must be consistent with individual gate statuses\n- If any gate is \"failing\", overall cannot be \"passing\"\n\n---\n\n## Section 9: Post-Merge Items\n\n**What it shows:** Prioritized list of items to address after merge.\n\n**Data source:** Pass 2 (adversarial reviewer + semantic analysis team).\n\n**Required fields:**\n- `postMergeItems[]` -- priority, title, description, codeSnippet, failureScenario, successScenario, zones\n\n**HTML structure:**\n- `.pm-item` with:\n  - `.pm-header` (clickable): `.priority` tag + title\n  - `.pm-body` (hidden): description paragraph, `.code-block` snippet, `.scenario-box.failure`, `.scenario-box.success`\n\n**Priority rendering:**\n- `medium`: `.priority.medium` (yellow)\n- `low`: `.priority.low` (blue)\n- `cosmetic`: `.priority.cosmetic` (gray)\n\n**Interactive behaviors:**\n- **Header click:** Toggles the `.pm-body` visible/hidden.\n- **File path click:** Inside code snippets, file paths can link to the file modal.\n\n**Validation rules:**\n- Code snippet line references must exist in the actual diff\n- File paths in code snippets must appear in the diff file list\n- Priority must be one of: medium, low, cosmetic\n\n---\n\n## Factory History (Tab 2)\n\n**What it shows:** Convergence loop visibility -- iterations, interventions, gate findings over time.\n\n**Data source:** Pass 2 (factory history reconstruction from commit log and CI data).\n\n**Required fields:**\n- `factoryHistory.iterationCount`\n- `factoryHistory.satisfactionTrajectory`\n- `factoryHistory.timeline[]` -- each event with title, detail, meta, expandedDetail, type, agent\n- `factoryHistory.gateFindings[]` -- phase-by-phase gate results\n\n**HTML structure:**\n- Summary cards (`.convergence-grid`): iteration count + satisfaction trajectory\n- `.history-timeline` with `.history-event` items (timeline with vertical line and dots)\n- `#gate-findings-table` with gate results per iteration/phase\n\n**Event type rendering:**\n- `automated`: blue dot (`.history-event` default)\n- `intervention`: orange dot (`.history-event.intervention`)\n\n**Agent badge rendering:**\n- `automated`: `.event-agent` (blue)\n- `human`: `.event-agent.human` (orange)\n\n**Interactive behaviors:**\n- **Event click:** Toggles `.history-event-detail` drill-down.\n- **Gate finding click:** Shows popover (`.gate-popover`) with detailed gate result explanation. Auto-dismisses after 5 seconds.\n\n**Validation rules:**\n- Timeline events should be in chronological order\n- Gate findings must reference gates that exist in the convergence section\n- If factoryHistory is null, the \"Factory History\" tab should not appear in the tab bar\n"
    },
    ".claude/skills/pr-review-pack/references/validation-checklist.md": {
      "additions": 24,
      "deletions": 11,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/.claude/skills/pr-review-pack/references/validation-checklist.md b/.claude/skills/pr-review-pack/references/validation-checklist.md\nindex 0ba7069..80328db 100644\n--- a/.claude/skills/pr-review-pack/references/validation-checklist.md\n+++ b/.claude/skills/pr-review-pack/references/validation-checklist.md\n@@ -29,11 +29,13 @@ Pre-delivery checks to run before handing the review pack to Joey. Organized by\n - [ ] Line ranges in code snippets correspond to actual lines in the diff\n - [ ] Code snippet content matches the actual file content (not fabricated)\n \n-### Pass 2 Verification -- Adversarial Review\n-- [ ] Every adversarial finding references files in the diff\n+### Pass 2 Verification -- Agentic Review\n+- [ ] Every agentic finding references files in the diff\n - [ ] Zone tags on findings match valid zones from the registry\n - [ ] Grades are valid values: A, B, B+, C, F, or N/A\n - [ ] Findings are sorted by severity (most severe first)\n+- [ ] `reviewMethod` is set to `\"main-agent\"` or `\"agent-teams\"` (must accurately reflect how review was performed)\n+- [ ] Every finding has an `agent` field identifying which agent produced it (code-health, security, test-integrity, adversarial)\n \n ### CI Data Verification\n - [ ] CI check names match `gh pr checks` output\n@@ -58,9 +60,11 @@ Pre-delivery checks to run before handing the review pack to Joey. Organized by\n \n ### Architecture Diagram\n - [ ] All zones from the registry appear in the SVG\n+- [ ] No zones are clipped or out of bounds (viewBox fits all content)\n - [ ] Zone labels and sublabels are readable\n - [ ] File count circles show correct numbers\n - [ ] Zone colors match category (blue=factory, green=product, purple=infra)\n+- [ ] Zoom controls (+/\u2212/Fit) work correctly\n - [ ] Baseline view dims all zones\n - [ ] Update view shows all zones at full opacity\n - [ ] Floating diagram appears when main diagram scrolls out of view\n@@ -103,7 +107,7 @@ Pre-delivery checks to run before handing the review pack to Joey. Organized by\n - [ ] Section 1: Architecture diagram with all zones\n - [ ] Section 3: Specs listed, Scenarios with status\n - [ ] Section 4: What Changed with Infrastructure and Product layers\n-- [ ] Section 5: Adversarial Review with graded findings\n+- [ ] Section 5: Agentic Review with graded findings\n - [ ] Section 6: CI Performance with all jobs\n - [ ] Section 7: Key Decisions (at least one)\n - [ ] Section 8: Convergence Result with gate-by-gate status\n@@ -141,16 +145,25 @@ These are the core trust properties. If any fails, the review pack is unreliable\n - [ ] **Unverified claims are flagged** -- not silently rendered\n - [ ] **The renderer has zero intelligence** -- pure template consuming verified data\n \n+## Embedded Content Safety\n+\n+- [ ] No literal `</script>` in embedded diff data or reference files (must be escaped as `<\\/script`)\n+- [ ] No visible gibberish or raw JSON at the bottom of the page\n+- [ ] File modal opens and shows diffs (not stuck on \"Loading diff data...\")\n+\n ## Pre-Delivery Final Check\n \n Before delivering to Joey:\n \n 1. Open the HTML in a browser\n-2. Click through all expandable sections -- do they open and close?\n-3. Click a zone in the architecture diagram -- does filtering work?\n-4. Click a file path -- does the diff modal open with correct content?\n-5. Toggle dark mode -- does everything remain readable?\n-6. Scroll past the architecture section -- does the floating diagram appear?\n-7. Switch to Factory History tab (if present) -- does it render correctly?\n-8. Check header status badges -- are CI, Scenarios, and Comments all green?\n-9. Verify the HEAD SHA in the header matches the actual PR HEAD\n+2. **The red \"This Pack Has NOT Been Visually Inspected\" banner should be visible** -- this confirms the template rendered correctly. Remove it (delete the `#visual-inspection-banner` and `#visual-inspection-spacer` elements) only after completing all visual checks below.\n+3. Click through all expandable sections -- do they open and close?\n+4. Click a zone in the architecture diagram -- does filtering work?\n+5. Click a file path -- does the diff modal open with correct content?\n+6. Toggle dark mode -- does everything remain readable?\n+7. Scroll past the architecture section -- does the floating diagram appear?\n+8. Switch to Factory History tab (if present) -- does it render correctly?\n+9. Check header status badges -- are CI, Scenarios, and Comments all green?\n+10. Verify the HEAD SHA in the header matches the actual PR HEAD\n+11. Scroll to the very bottom -- no gibberish or raw data visible?\n+12. Remove the visual inspection banner and spacer from the HTML\n",
      "raw": "# PR Review Pack Validation Checklist\n\nPre-delivery checks to run before handing the review pack to Joey. Organized by validation category.\n\n## Data Correctness\n\n### Pass 1 Verification\n- [ ] `git diff --numstat` file count matches `header.filesChanged`\n- [ ] Total additions/deletions match `header.additions` / `header.deletions`\n- [ ] `header.headSha` matches the actual HEAD of the PR branch\n- [ ] Every file in the diff appears in the diff data JSON\n- [ ] File status (added/modified/deleted/renamed) matches `git diff --name-status` output\n- [ ] Binary files are correctly identified (additions/deletions show as 0)\n\n### Zone Mapping Verification\n- [ ] Every changed file maps to at least one zone (no orphan files)\n- [ ] Zone file counts in architecture diagram match actual file-to-zone mapping\n- [ ] No zone claims files that are not in the diff\n- [ ] Zone path patterns are syntactically valid globs\n\n### Pass 2 Verification -- Decision Claims\n- [ ] Every decision-to-zone claim is verified: at least one file in the diff touches that zone's paths\n- [ ] Unverified decision-zone claims are flagged with a visual indicator\n- [ ] Decision file lists contain only files that appear in the diff\n- [ ] Decision numbers are sequential (1, 2, 3...) with no gaps\n\n### Pass 2 Verification -- Code Snippets\n- [ ] Every code snippet references a file that exists in the diff\n- [ ] Line ranges in code snippets correspond to actual lines in the diff\n- [ ] Code snippet content matches the actual file content (not fabricated)\n\n### Pass 2 Verification -- Agentic Review\n- [ ] Every agentic finding references files in the diff\n- [ ] Zone tags on findings match valid zones from the registry\n- [ ] Grades are valid values: A, B, B+, C, F, or N/A\n- [ ] Findings are sorted by severity (most severe first)\n- [ ] `reviewMethod` is set to `\"main-agent\"` or `\"agent-teams\"` (must accurately reflect how review was performed)\n- [ ] Every finding has an `agent` field identifying which agent produced it (code-health, security, test-integrity, adversarial)\n\n### CI Data Verification\n- [ ] CI check names match `gh pr checks` output\n- [ ] CI check statuses match actual results\n- [ ] Timing values are reasonable (not negative, not wildly inflated)\n- [ ] Health tags match timing thresholds: <60s=normal, 60-300s=acceptable, 300-600s=watch, >600s=refactor\n\n## Visual Correctness\n\n### Layout\n- [ ] HTML file opens without errors in Chrome, Firefox, Safari\n- [ ] Container is centered and max-width is 1100px\n- [ ] All sections render without horizontal overflow\n- [ ] Responsive breakpoint (768px) does not break layout\n\n### Theme System\n- [ ] Light theme renders with correct colors\n- [ ] Dark theme renders with correct colors (no white-on-white or dark-on-dark text)\n- [ ] System theme follows OS preference\n- [ ] Theme toggle buttons show correct active state\n- [ ] Theme persists across page reload (localStorage)\n\n### Architecture Diagram\n- [ ] All zones from the registry appear in the SVG\n- [ ] No zones are clipped or out of bounds (viewBox fits all content)\n- [ ] Zone labels and sublabels are readable\n- [ ] File count circles show correct numbers\n- [ ] Zone colors match category (blue=factory, green=product, purple=infra)\n- [ ] Zoom controls (+/\u2212/Fit) work correctly\n- [ ] Baseline view dims all zones\n- [ ] Update view shows all zones at full opacity\n- [ ] Floating diagram appears when main diagram scrolls out of view\n- [ ] Floating diagram dismiss button works\n\n### Interactive Elements\n- [ ] Section headers toggle collapse/expand\n- [ ] Chevron rotates on collapse\n- [ ] Zone click highlights the zone and filters other sections\n- [ ] Zone click on same zone resets (toggle behavior)\n- [ ] Background click on SVG resets zone filtering\n- [ ] Decision card expand/collapse works\n- [ ] Decision expand triggers zone highlighting\n- [ ] CI row expand/collapse works with chevron rotation\n- [ ] CI sub-check expand/collapse works independently\n- [ ] Post-merge item expand/collapse works\n- [ ] Convergence card expand/collapse works\n- [ ] Scenario card expand/collapse works\n- [ ] Factory history event expand/collapse works\n- [ ] Gate finding popover appears on click and auto-dismisses\n\n### File Modal\n- [ ] File path links open the modal\n- [ ] Modal shows file path in header\n- [ ] Addition/deletion stats appear in modal header\n- [ ] Side-by-side view renders correctly\n- [ ] Unified view renders correctly\n- [ ] Raw file view renders correctly\n- [ ] View tab selection persists across files (not reset to default)\n- [ ] \"View on GitHub\" link is correct\n- [ ] Modal closes on X button click\n- [ ] Modal closes on Escape key\n- [ ] Modal closes on overlay click\n- [ ] Scroll is trapped inside modal (background does not scroll)\n\n## Content Completeness\n\n### Required Sections (Review Tab)\n- [ ] Header status badges present (CI, Scenarios, Comments)\n- [ ] Section 1: Architecture diagram with all zones\n- [ ] Section 3: Specs listed, Scenarios with status\n- [ ] Section 4: What Changed with Infrastructure and Product layers\n- [ ] Section 5: Agentic Review with graded findings\n- [ ] Section 6: CI Performance with all jobs\n- [ ] Section 7: Key Decisions (at least one)\n- [ ] Section 8: Convergence Result with gate-by-gate status\n- [ ] Section 9: Post-Merge Items (can be empty if none)\n\n### Factory History Tab (if applicable)\n- [ ] Iteration count card present\n- [ ] Satisfaction trajectory card present\n- [ ] Timeline with events in chronological order\n- [ ] Gate findings table with per-iteration results\n- [ ] Legend with automated/intervention color coding\n- [ ] If not a factory PR, the Factory History tab does not appear\n\n### Header\n- [ ] PR title is correct\n- [ ] PR URL links to the actual PR\n- [ ] Branch info shows head -> base\n- [ ] HEAD SHA is correct and matches CI checks\n- [ ] Stats (additions, deletions, files, commits) are accurate\n- [ ] Status badges reflect actual CI and comment state\n\n### Footer\n- [ ] Generated timestamp is current\n- [ ] HEAD SHA matches header\n\n## Deterministic Correctness Guarantees\n\nThese are the core trust properties. If any fails, the review pack is unreliable.\n\n- [ ] **File-to-Zone mapping is deterministic** -- pure path matching against registry, no LLM involvement\n- [ ] **Zone-to-Diagram is static** -- registry defines positions, no runtime computation\n- [ ] **Decision-to-Zone claims are LLM-produced but verified** -- every claim checked against files-in-zone\n- [ ] **Code snippets are verified** -- line numbers exist in the actual diff\n- [ ] **CI coverage is statically defined** -- job-to-gate-to-zone mapping from config\n- [ ] **Unverified claims are flagged** -- not silently rendered\n- [ ] **The renderer has zero intelligence** -- pure template consuming verified data\n\n## Embedded Content Safety\n\n- [ ] No literal `</script>` in embedded diff data or reference files (must be escaped as `<\\/script`)\n- [ ] No visible gibberish or raw JSON at the bottom of the page\n- [ ] File modal opens and shows diffs (not stuck on \"Loading diff data...\")\n\n## Pre-Delivery Final Check\n\nBefore delivering to Joey:\n\n1. Open the HTML in a browser\n2. **The red \"This Pack Has NOT Been Visually Inspected\" banner should be visible** -- this confirms the template rendered correctly. Remove it (delete the `#visual-inspection-banner` and `#visual-inspection-spacer` elements) only after completing all visual checks below.\n3. Click through all expandable sections -- do they open and close?\n4. Click a zone in the architecture diagram -- does filtering work?\n5. Click a file path -- does the diff modal open with correct content?\n6. Toggle dark mode -- does everything remain readable?\n7. Scroll past the architecture section -- does the floating diagram appear?\n8. Switch to Factory History tab (if present) -- does it render correctly?\n9. Check header status badges -- are CI, Scenarios, and Comments all green?\n10. Verify the HEAD SHA in the header matches the actual PR HEAD\n11. Scroll to the very bottom -- no gibberish or raw data visible?\n12. Remove the visual inspection banner and spacer from the HTML\n",
      "base": "# PR Review Pack Validation Checklist\n\nPre-delivery checks to run before handing the review pack to Joey. Organized by validation category.\n\n## Data Correctness\n\n### Pass 1 Verification\n- [ ] `git diff --numstat` file count matches `header.filesChanged`\n- [ ] Total additions/deletions match `header.additions` / `header.deletions`\n- [ ] `header.headSha` matches the actual HEAD of the PR branch\n- [ ] Every file in the diff appears in the diff data JSON\n- [ ] File status (added/modified/deleted/renamed) matches `git diff --name-status` output\n- [ ] Binary files are correctly identified (additions/deletions show as 0)\n\n### Zone Mapping Verification\n- [ ] Every changed file maps to at least one zone (no orphan files)\n- [ ] Zone file counts in architecture diagram match actual file-to-zone mapping\n- [ ] No zone claims files that are not in the diff\n- [ ] Zone path patterns are syntactically valid globs\n\n### Pass 2 Verification -- Decision Claims\n- [ ] Every decision-to-zone claim is verified: at least one file in the diff touches that zone's paths\n- [ ] Unverified decision-zone claims are flagged with a visual indicator\n- [ ] Decision file lists contain only files that appear in the diff\n- [ ] Decision numbers are sequential (1, 2, 3...) with no gaps\n\n### Pass 2 Verification -- Code Snippets\n- [ ] Every code snippet references a file that exists in the diff\n- [ ] Line ranges in code snippets correspond to actual lines in the diff\n- [ ] Code snippet content matches the actual file content (not fabricated)\n\n### Pass 2 Verification -- Adversarial Review\n- [ ] Every adversarial finding references files in the diff\n- [ ] Zone tags on findings match valid zones from the registry\n- [ ] Grades are valid values: A, B, B+, C, F, or N/A\n- [ ] Findings are sorted by severity (most severe first)\n\n### CI Data Verification\n- [ ] CI check names match `gh pr checks` output\n- [ ] CI check statuses match actual results\n- [ ] Timing values are reasonable (not negative, not wildly inflated)\n- [ ] Health tags match timing thresholds: <60s=normal, 60-300s=acceptable, 300-600s=watch, >600s=refactor\n\n## Visual Correctness\n\n### Layout\n- [ ] HTML file opens without errors in Chrome, Firefox, Safari\n- [ ] Container is centered and max-width is 1100px\n- [ ] All sections render without horizontal overflow\n- [ ] Responsive breakpoint (768px) does not break layout\n\n### Theme System\n- [ ] Light theme renders with correct colors\n- [ ] Dark theme renders with correct colors (no white-on-white or dark-on-dark text)\n- [ ] System theme follows OS preference\n- [ ] Theme toggle buttons show correct active state\n- [ ] Theme persists across page reload (localStorage)\n\n### Architecture Diagram\n- [ ] All zones from the registry appear in the SVG\n- [ ] Zone labels and sublabels are readable\n- [ ] File count circles show correct numbers\n- [ ] Zone colors match category (blue=factory, green=product, purple=infra)\n- [ ] Baseline view dims all zones\n- [ ] Update view shows all zones at full opacity\n- [ ] Floating diagram appears when main diagram scrolls out of view\n- [ ] Floating diagram dismiss button works\n\n### Interactive Elements\n- [ ] Section headers toggle collapse/expand\n- [ ] Chevron rotates on collapse\n- [ ] Zone click highlights the zone and filters other sections\n- [ ] Zone click on same zone resets (toggle behavior)\n- [ ] Background click on SVG resets zone filtering\n- [ ] Decision card expand/collapse works\n- [ ] Decision expand triggers zone highlighting\n- [ ] CI row expand/collapse works with chevron rotation\n- [ ] CI sub-check expand/collapse works independently\n- [ ] Post-merge item expand/collapse works\n- [ ] Convergence card expand/collapse works\n- [ ] Scenario card expand/collapse works\n- [ ] Factory history event expand/collapse works\n- [ ] Gate finding popover appears on click and auto-dismisses\n\n### File Modal\n- [ ] File path links open the modal\n- [ ] Modal shows file path in header\n- [ ] Addition/deletion stats appear in modal header\n- [ ] Side-by-side view renders correctly\n- [ ] Unified view renders correctly\n- [ ] Raw file view renders correctly\n- [ ] View tab selection persists across files (not reset to default)\n- [ ] \"View on GitHub\" link is correct\n- [ ] Modal closes on X button click\n- [ ] Modal closes on Escape key\n- [ ] Modal closes on overlay click\n- [ ] Scroll is trapped inside modal (background does not scroll)\n\n## Content Completeness\n\n### Required Sections (Review Tab)\n- [ ] Header status badges present (CI, Scenarios, Comments)\n- [ ] Section 1: Architecture diagram with all zones\n- [ ] Section 3: Specs listed, Scenarios with status\n- [ ] Section 4: What Changed with Infrastructure and Product layers\n- [ ] Section 5: Adversarial Review with graded findings\n- [ ] Section 6: CI Performance with all jobs\n- [ ] Section 7: Key Decisions (at least one)\n- [ ] Section 8: Convergence Result with gate-by-gate status\n- [ ] Section 9: Post-Merge Items (can be empty if none)\n\n### Factory History Tab (if applicable)\n- [ ] Iteration count card present\n- [ ] Satisfaction trajectory card present\n- [ ] Timeline with events in chronological order\n- [ ] Gate findings table with per-iteration results\n- [ ] Legend with automated/intervention color coding\n- [ ] If not a factory PR, the Factory History tab does not appear\n\n### Header\n- [ ] PR title is correct\n- [ ] PR URL links to the actual PR\n- [ ] Branch info shows head -> base\n- [ ] HEAD SHA is correct and matches CI checks\n- [ ] Stats (additions, deletions, files, commits) are accurate\n- [ ] Status badges reflect actual CI and comment state\n\n### Footer\n- [ ] Generated timestamp is current\n- [ ] HEAD SHA matches header\n\n## Deterministic Correctness Guarantees\n\nThese are the core trust properties. If any fails, the review pack is unreliable.\n\n- [ ] **File-to-Zone mapping is deterministic** -- pure path matching against registry, no LLM involvement\n- [ ] **Zone-to-Diagram is static** -- registry defines positions, no runtime computation\n- [ ] **Decision-to-Zone claims are LLM-produced but verified** -- every claim checked against files-in-zone\n- [ ] **Code snippets are verified** -- line numbers exist in the actual diff\n- [ ] **CI coverage is statically defined** -- job-to-gate-to-zone mapping from config\n- [ ] **Unverified claims are flagged** -- not silently rendered\n- [ ] **The renderer has zero intelligence** -- pure template consuming verified data\n\n## Pre-Delivery Final Check\n\nBefore delivering to Joey:\n\n1. Open the HTML in a browser\n2. Click through all expandable sections -- do they open and close?\n3. Click a zone in the architecture diagram -- does filtering work?\n4. Click a file path -- does the diff modal open with correct content?\n5. Toggle dark mode -- does everything remain readable?\n6. Scroll past the architecture section -- does the floating diagram appear?\n7. Switch to Factory History tab (if present) -- does it render correctly?\n8. Check header status badges -- are CI, Scenarios, and Comments all green?\n9. Verify the HEAD SHA in the header matches the actual PR HEAD\n"
    },
    ".claude/skills/pr-review-pack/scripts/render_review_pack.py": {
      "additions": 236,
      "deletions": 30,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/.claude/skills/pr-review-pack/scripts/render_review_pack.py b/.claude/skills/pr-review-pack/scripts/render_review_pack.py\nindex c3bdc81..05136f9 100644\n--- a/.claude/skills/pr-review-pack/scripts/render_review_pack.py\n+++ b/.claude/skills/pr-review-pack/scripts/render_review_pack.py\n@@ -31,6 +31,22 @@ LAYER_COLORS = {\n \n GRADE_CLASS = {\"A\": \"a\", \"B+\": \"b\", \"B\": \"b\", \"C\": \"c\", \"F\": \"f\", \"N/A\": \"na\"}\n \n+# Agent abbreviations for compact badges\n+AGENT_ABBREV = {\n+    \"code-health\": \"CH\",\n+    \"security\": \"SE\",\n+    \"test-integrity\": \"TI\",\n+    \"adversarial\": \"AD\",\n+    \"code-health-reviewer\": \"CH\",\n+    \"security-reviewer\": \"SE\",\n+    \"test-integrity-reviewer\": \"TI\",\n+    \"adversarial-reviewer\": \"AD\",\n+    \"main\": \"MA\",\n+    \"main-agent\": \"MA\",\n+}\n+\n+GRADE_SORT = {\"F\": 0, \"C\": 1, \"B\": 2, \"B+\": 3, \"A\": 4, \"N/A\": 5}\n+\n HEALTH_CLASS = {\n     \"normal\": \"normal\",\n     \"acceptable\": \"acceptable\",\n@@ -47,7 +63,9 @@ CATEGORY_CLASS = {\n \n STATUS_STYLE = {\n     \"passing\": (\"var(--green)\", \"&#x2713;\", \"Passing\"),\n+    \"pass\": (\"var(--green)\", \"&#x2713;\", \"Pass\"),\n     \"failing\": (\"var(--red)\", \"&#x2717;\", \"Failing\"),\n+    \"fail\": (\"var(--red)\", \"&#x2717;\", \"Fail\"),\n     \"advisory\": (\"var(--yellow)\", \"&#x26A0;\", \"Advisory\"),\n }\n \n@@ -205,6 +223,17 @@ def render_scenario_cards(scenarios: list[dict]) -> str:\n         cat_class = CATEGORY_CLASS.get(s.get(\"category\", \"\"), \"\")\n         zone = s.get(\"zone\", \"\")\n         d = s.get(\"detail\", {})\n+        # detail may be a dict {what, how, result} or a plain string\n+        if isinstance(d, str):\n+            detail_html = f'<p>{esc(d)}</p>' if d else ''\n+        else:\n+            detail_html = (\n+                f'<dl>\\n'\n+                f'      <dt>What</dt><dd>{esc(d.get(\"what\", \"\"))}</dd>\\n'\n+                f'      <dt>How</dt><dd>{esc(d.get(\"how\", \"\"))}</dd>\\n'\n+                f'      <dt>Result</dt><dd>{esc(d.get(\"result\", \"\"))}</dd>\\n'\n+                f'    </dl>'\n+            )\n         cards.append(\n             f'<div class=\"scenario-card\" data-zone=\"{esc(zone)}\" '\n             f'onclick=\"this.classList.toggle(\\'open\\')\">\\n'\n@@ -214,11 +243,7 @@ def render_scenario_cards(scenarios: list[dict]) -> str:\n             f'  </div>\\n'\n             f'  <div class=\"status\" style=\"color:{color}\">{icon} {text}</div>\\n'\n             f'  <div class=\"scenario-card-detail\">\\n'\n-            f'    <dl>\\n'\n-            f'      <dt>What</dt><dd>{esc(d.get(\"what\", \"\"))}</dd>\\n'\n-            f'      <dt>How</dt><dd>{esc(d.get(\"how\", \"\"))}</dd>\\n'\n-            f'      <dt>Result</dt><dd>{esc(d.get(\"result\", \"\"))}</dd>\\n'\n-            f'    </dl>\\n'\n+            f'    {detail_html}\\n'\n             f'  </div>\\n'\n             f'</div>'\n         )\n@@ -251,30 +276,117 @@ def render_what_changed_zones(wc: dict) -> str:\n     return \"\\n        \".join(divs)\n \n \n-def render_adversarial_rows(adv: dict) -> str:\n+def render_agentic_method_badge(review: dict) -> str:\n+    method = review.get(\"reviewMethod\", \"main-agent\")\n+    css = \"agent-teams\" if method == \"agent-teams\" else \"main-agent\"\n+    label = \"Agent Teams\" if method == \"agent-teams\" else \"Main Agent\"\n+    return f'<span class=\"review-method-badge {css}\">{label}</span>'\n+\n+\n+def render_agentic_legend() -> str:\n+    \"\"\"Render compact legend for agent abbreviations.\"\"\"\n+    entries = [\n+        (\"CH\", \"Code Health\", \"code quality + complexity + dead code\"),\n+        (\"SE\", \"Security\", \"vulnerabilities beyond bandit\"),\n+        (\"TI\", \"Test Integrity\", \"test quality beyond AST scanner\"),\n+        (\"AD\", \"Adversarial\", \"gaming, spec violations, architecture\"),\n+    ]\n+    items = []\n+    for abbrev, name, desc in entries:\n+        items.append(\n+            f'<span class=\"agent-legend-item\" title=\"{esc(desc)}\">'\n+            f'<span class=\"agent-abbrev\">{abbrev}</span> {esc(name)}</span>'\n+        )\n+    return (\n+        '<div class=\"agent-legend\">'\n+        + \" \".join(items)\n+        + \"</div>\"\n+    )\n+\n+\n+def render_agentic_rows(review: dict) -> str:\n+    \"\"\"Render agentic review rows grouped by file.\n+\n+    Each file gets one master row with compact agent grade badges.\n+    Expanding shows per-agent detail.\n+    \"\"\"\n+    from collections import OrderedDict\n+\n+    findings = review.get(\"findings\", [])\n+    if not findings:\n+        return \"\"\n+\n+    # Group by file, preserving order of first appearance\n+    by_file: OrderedDict[str, list[dict]] = OrderedDict()\n+    for f in findings:\n+        filepath = f.get(\"file\", \"unknown\")\n+        by_file.setdefault(filepath, []).append(f)\n+\n     rows = []\n-    for f in adv.get(\"findings\", []):\n-        grade = f.get(\"grade\", \"N/A\")\n-        grade_css = GRADE_CLASS.get(grade, \"na\")\n-        zones = f.get(\"zones\", \"\")\n-        sort_order = f.get(\"gradeSortOrder\", 0)\n-        # detail may contain HTML\n+    for filepath, file_findings in by_file.items():\n+        # Worst grade determines file sort order\n+        worst_sort = min(f.get(\"gradeSortOrder\", 99) for f in file_findings)\n+        zones = file_findings[0].get(\"zones\", \"\")\n+\n+        # Compact agent badges: CH:A  SE:B  TI:A  AD:B\n+        badges = []\n+        for f in file_findings:\n+            agent_name = f.get(\"agent\", \"\") or \"main\"\n+            abbrev = AGENT_ABBREV.get(agent_name, agent_name[:2].upper() if agent_name else \"?\")\n+            grade = f.get(\"grade\", \"N/A\")\n+            grade_css = GRADE_CLASS.get(grade, \"na\")\n+            badges.append(\n+                f'<span class=\"agent-grade-badge\">'\n+                f'<span class=\"agent-abbrev\">{esc(abbrev)}</span>'\n+                f'<span class=\"grade {grade_css}\">{esc(grade)}</span>'\n+                f'</span>'\n+            )\n+        badges_html = \" \".join(badges)\n+\n+        # Most notable finding for the summary column\n+        notable_finding = min(file_findings, key=lambda f: GRADE_SORT.get(f.get(\"grade\", \"N/A\"), 5))\n+        notable_text = notable_finding.get(\"notable\", \"\")\n+\n+        # Master row (one per file)\n         rows.append(\n             f'<tr class=\"adv-row\" data-zones=\"{esc(zones)}\" '\n-            f'data-grade-sort=\"{sort_order}\" onclick=\"toggleAdvDetail(this)\">\\n'\n+            f'data-grade-sort=\"{worst_sort}\" onclick=\"toggleAdvDetail(this)\">\\n'\n             f'  <td><code class=\"file-path-link\" '\n             f\"onclick=\\\"event.stopPropagation();\"\n-            f\"openFileModal('{esc(f['file'])}')\\\">\"\n-            f'{esc(f[\"file\"])}</code></td>\\n'\n-            f'  <td><span class=\"grade {grade_css}\">{esc(grade)}</span></td>\\n'\n+            f\"openFileModal('{esc(filepath)}')\\\">\"\n+            f'{esc(filepath)}</code></td>\\n'\n+            f'  <td class=\"agent-badges-cell\">{badges_html}</td>\\n'\n             f'  <td><span class=\"zone-tag {layer_tag_class(\"product\")}\">'\n             f'{esc(zones)}</span></td>\\n'\n-            f'  <td>{esc(f.get(\"notable\", \"\"))}</td>\\n'\n+            f'  <td>{esc(notable_text)}</td>\\n'\n             f'</tr>\\n'\n+        )\n+\n+        # Detail row: per-agent breakdown\n+        detail_parts = []\n+        for f in file_findings:\n+            agent_name = f.get(\"agent\", \"\") or \"main\"\n+            abbrev = AGENT_ABBREV.get(agent_name, agent_name[:2].upper() if agent_name else \"?\")\n+            grade = f.get(\"grade\", \"N/A\")\n+            grade_css = GRADE_CLASS.get(grade, \"na\")\n+            detail_text = f.get(\"detail\", \"\") or f.get(\"notable\", \"\")\n+            detail_parts.append(\n+                f'<div class=\"agent-detail-entry\">'\n+                f'<span class=\"agent-detail-header\">'\n+                f'<span class=\"agent-abbrev\">{esc(abbrev)}</span>'\n+                f'<span class=\"grade {grade_css}\">{esc(grade)}</span>'\n+                f'<span class=\"agent-detail-name\">{esc(agent_name)}</span>'\n+                f'</span>'\n+                f'<div class=\"agent-detail-body\">{detail_text}</div>'\n+                f'</div>'\n+            )\n+\n+        rows.append(\n             f'<tr class=\"adv-detail-row\" data-zones=\"{esc(zones)}\">\\n'\n-            f'  <td colspan=\"4\">{f.get(\"detail\", \"\")}</td>\\n'\n+            f'  <td colspan=\"4\">{\"\".join(detail_parts)}</td>\\n'\n             f'</tr>'\n         )\n+\n     return \"\\n            \".join(rows)\n \n \n@@ -568,6 +680,60 @@ def render_gate_findings_rows(findings: list[dict]) -> str:\n # \u2500\u2500 Main render pipeline \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n \n \n+def _escape_script_closing(text: str) -> str:\n+    \"\"\"Escape </script> sequences so embedded JSON doesn't break HTML parsing.\n+\n+    The HTML parser scans for </script> to close <script> blocks regardless\n+    of JavaScript string context. If raw file content (e.g., template.html)\n+    contains </script>, the browser closes the <script> tag prematurely,\n+    corrupting the page. Replacing </script with <\\\\/script is safe \u2014 the\n+    JS engine interprets \\\\/ as / but the HTML parser no longer sees a\n+    closing tag.\n+    \"\"\"\n+    return text.replace(\"</script\", r\"<\\/script\").replace(\"</Script\", r\"<\\/Script\")\n+\n+\n+def _calculate_viewbox(arch: dict) -> str:\n+    \"\"\"Calculate SVG viewBox from architecture zone positions.\n+\n+    Returns a viewBox string that fits all zones, labels, and arrows\n+    with padding. The left margin accounts for row labels rendered\n+    with text-anchor='end'.\n+    \"\"\"\n+    if not arch or not arch.get(\"zones\"):\n+        return \"0 0 780 360\"  # fallback default\n+\n+    min_x, min_y = float(\"inf\"), float(\"inf\")\n+    max_x, max_y = float(\"-inf\"), float(\"-inf\")\n+\n+    for zone in arch.get(\"zones\", []):\n+        pos = zone.get(\"position\", {})\n+        x, y = pos.get(\"x\", 0), pos.get(\"y\", 0)\n+        w, h = pos.get(\"width\", 120), pos.get(\"height\", 70)\n+        min_x = min(min_x, x)\n+        min_y = min(min_y, y)\n+        max_x = max(max_x, x + w)\n+        max_y = max(max_y, y + h)\n+\n+    for arrow in arch.get(\"arrows\", []):\n+        for endpoint in (\"from\", \"to\"):\n+            pt = arrow.get(endpoint, {})\n+            max_x = max(max_x, pt.get(\"x\", 0))\n+            max_y = max(max_y, pt.get(\"y\", 0))\n+\n+    # Row labels sit at small x with text-anchor=\"end\", extending left.\n+    # Reserve ~120px to the left of min_x for label text.\n+    label_margin = 120\n+    pad = 20  # general padding\n+\n+    vb_x = min(min_x - label_margin, 0) - pad\n+    vb_y = min(min_y, 0) - pad\n+    vb_w = max_x - vb_x + pad\n+    vb_h = max_y - vb_y + pad\n+\n+    return f\"{vb_x:.0f} {vb_y:.0f} {vb_w:.0f} {vb_h:.0f}\"\n+\n+\n def render(\n     data_path: str | Path,\n     output_path: str | Path,\n@@ -641,8 +807,12 @@ def render(\n         \"<!-- INJECT: wc-zone-detail divs for each zone -->\": (\n             render_what_changed_zones(data.get(\"whatChanged\", {}))\n         ),\n-        \"<!-- INJECT: adversarial finding rows from DATA.adversarialReview.findings -->\": (\n-            render_adversarial_rows(data.get(\"adversarialReview\", {}))\n+        \"<!-- INJECT: adversarial review method badge -->\": (\n+            render_agentic_method_badge(data.get(\"agenticReview\", {}))\n+            + render_agentic_legend()\n+        ),\n+        \"<!-- INJECT: adversarial finding rows from DATA.agenticReview.findings -->\": (\n+            render_agentic_rows(data.get(\"agenticReview\", {}))\n         ),\n         \"<!-- INJECT: CI check rows from DATA.ciPerformance -->\": render_ci_rows(\n             data.get(\"ciPerformance\", [])\n@@ -688,6 +858,20 @@ def render(\n     ):\n         template = template.replace(hint, \"\")\n \n+    # \u2500\u2500 Dynamic SVG viewBox from architecture data \u2500\u2500\n+    arch_data = data.get(\"architecture\", {})\n+    viewbox = _calculate_viewbox(arch_data)\n+    template = template.replace(\n+        'viewBox=\"0 0 780 360\"',\n+        f'viewBox=\"{viewbox}\"',\n+    )\n+    vb_parts = viewbox.split()\n+    vb_width = float(vb_parts[2])\n+    template = template.replace(\n+        \"max-width:780px\",\n+        f\"max-width:{max(780, int(vb_width))}px\",\n+    )\n+\n     # \u2500\u2500 Inject DATA JSON for JS interactivity \u2500\u2500\n     data_json = json.dumps(data, indent=2)\n     template = template.replace(\"const DATA = {};\", f\"const DATA = {data_json};\")\n@@ -710,11 +894,12 @@ def render(\n             if full.exists():\n                 ref_files[spec_path] = full.read_text(encoding=\"utf-8\")\n     if ref_files:\n+        safe_ref_json = _escape_script_closing(json.dumps(ref_files))\n         ref_inject = (\n             \"<script>\\n\"\n             \"// Reference file content embedded by render_review_pack.py\\n\"\n             \"// These files are not in the diff but are viewable in raw mode.\\n\"\n-            f\"const REFERENCE_FILES = {json.dumps(ref_files)};\\n\"\n+            f\"const REFERENCE_FILES = {safe_ref_json};\\n\"\n             \"</script>\\n\"\n         )\n         template = template.replace(\n@@ -733,15 +918,22 @@ def render(\n     # Trust chain: generate_diff_data.py runs `git diff` and `git show`\n     # \u2014 deterministic git CLI output, zero LLM, byte-equivalent to\n     # what GitHub displays for the same commit SHA.\n+    #\n+    # CRITICAL: The diff data may contain raw file content (e.g.,\n+    # template.html) with literal </script> tags. The HTML parser\n+    # does not understand JS string context \u2014 it would close the\n+    # <script> block prematurely, rendering the rest as visible text.\n+    # _escape_script_closing() prevents this.\n     if diff_data_json is not None:\n+        safe_diff_json = _escape_script_closing(diff_data_json)\n         # Inject diff data as a global variable\n         diff_inject = (\n-            f\"<script>\\n\"\n-            f\"// Diff data embedded inline by render_review_pack.py\\n\"\n-            f\"// Source: generate_diff_data.py (Pass 1, deterministic)\\n\"\n-            f\"// Trust: raw git diff/show output, zero LLM involvement\\n\"\n-            f\"const DIFF_DATA_INLINE = {diff_data_json};\\n\"\n-            f\"</script>\\n\"\n+            \"<script>\\n\"\n+            \"// Diff data embedded inline by render_review_pack.py\\n\"\n+            \"// Source: generate_diff_data.py (Pass 1, deterministic)\\n\"\n+            \"// Trust: raw git diff/show output, zero LLM involvement\\n\"\n+            f\"const DIFF_DATA_INLINE = {safe_diff_json};\\n\"\n+            \"</script>\\n\"\n         )\n         # Insert before the main <script> block\n         template = template.replace(\n@@ -765,12 +957,26 @@ def render(\n     print(f\"Rendered: {out} ({size_kb:.0f} KB)\")\n \n     # \u2500\u2500 Quick sanity check: any unreplaced markers? \u2500\u2500\n+    # Count markers OUTSIDE of embedded content (diff data, reference files)\n+    # to avoid false positives from SKILL.md/template.html diffs.\n     remaining = template.count(\"<!-- INJECT:\")\n     if remaining > 0:\n-        print(\n-            f\"WARNING: {remaining} unreplaced <!-- INJECT: --> markers remain!\",\n-            file=sys.stderr,\n+        # Check if all remaining markers are inside <script> blocks (embedded data)\n+        import re\n+\n+        outside_script = re.sub(\n+            r\"<script\\b[^>]*>.*?</script>\",\n+            \"\",\n+            template,\n+            flags=re.DOTALL,\n         )\n+        real_remaining = outside_script.count(\"<!-- INJECT:\")\n+        if real_remaining > 0:\n+            print(\n+                f\"WARNING: {real_remaining} unreplaced <!-- INJECT: --> \"\n+                f\"markers remain in HTML content!\",\n+                file=sys.stderr,\n+            )\n \n \n def main() -> None:\n",
      "raw": "#!/usr/bin/env python3\n\"\"\"Pass 3 renderer: inject ReviewPackData into the HTML template.\n\nReads the template HTML and a ReviewPackData JSON file, generates HTML for\nevery <!-- INJECT: ... --> marker, and produces a self-contained HTML file.\n\nThis is deterministic rendering \u2014 zero LLM involvement.\n\nUsage:\n    python3 render_review_pack.py --data review_pack_data.json --output docs/pr6_review_pack.html\n    python3 render_review_pack.py --data data.json --output out.html \\\n      --diff-data-filename pr6_diff_data.json\n\"\"\"\nfrom __future__ import annotations\n\nimport argparse\nimport html\nimport json\nimport sys\nfrom pathlib import Path\n\nTEMPLATE_PATH = Path(__file__).parent.parent / \"assets\" / \"template.html\"\n\n# \u2500\u2500 Color / class maps \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nLAYER_COLORS = {\n    \"factory\": {\"fill\": \"#dbeafe\", \"stroke\": \"#3b82f6\", \"text\": \"#1d4ed8\"},\n    \"product\": {\"fill\": \"#dcfce7\", \"stroke\": \"#22c55e\", \"text\": \"#166534\"},\n    \"infra\": {\"fill\": \"#f3e8ff\", \"stroke\": \"#8b5cf6\", \"text\": \"#6d28d9\"},\n}\n\nGRADE_CLASS = {\"A\": \"a\", \"B+\": \"b\", \"B\": \"b\", \"C\": \"c\", \"F\": \"f\", \"N/A\": \"na\"}\n\n# Agent abbreviations for compact badges\nAGENT_ABBREV = {\n    \"code-health\": \"CH\",\n    \"security\": \"SE\",\n    \"test-integrity\": \"TI\",\n    \"adversarial\": \"AD\",\n    \"code-health-reviewer\": \"CH\",\n    \"security-reviewer\": \"SE\",\n    \"test-integrity-reviewer\": \"TI\",\n    \"adversarial-reviewer\": \"AD\",\n    \"main\": \"MA\",\n    \"main-agent\": \"MA\",\n}\n\nGRADE_SORT = {\"F\": 0, \"C\": 1, \"B\": 2, \"B+\": 3, \"A\": 4, \"N/A\": 5}\n\nHEALTH_CLASS = {\n    \"normal\": \"normal\",\n    \"acceptable\": \"acceptable\",\n    \"watch\": \"watch\",\n    \"refactor\": \"refactor\",\n}\n\nCATEGORY_CLASS = {\n    \"environment\": \"cat-environment\",\n    \"training\": \"cat-training\",\n    \"pipeline\": \"cat-pipeline\",\n    \"integration\": \"cat-integration\",\n}\n\nSTATUS_STYLE = {\n    \"passing\": (\"var(--green)\", \"&#x2713;\", \"Passing\"),\n    \"pass\": (\"var(--green)\", \"&#x2713;\", \"Pass\"),\n    \"failing\": (\"var(--red)\", \"&#x2717;\", \"Failing\"),\n    \"fail\": (\"var(--red)\", \"&#x2717;\", \"Fail\"),\n    \"advisory\": (\"var(--yellow)\", \"&#x26A0;\", \"Advisory\"),\n}\n\n\n# \u2500\u2500 Helpers \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\ndef esc(text: str) -> str:\n    \"\"\"HTML-escape plain text.\"\"\"\n    return html.escape(str(text))\n\n\ndef layer_tag_class(category: str) -> str:\n    \"\"\"Map zone category to CSS class for zone-tag.\"\"\"\n    return {\"factory\": \"factory\", \"product\": \"product\", \"infra\": \"infra\"}.get(\n        category, \"product\"\n    )\n\n\n# \u2500\u2500 Section renderers \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\ndef render_stat_items(header: dict) -> str:\n    commits = header.get(\"commits\", 0)\n    additions = header.get(\"additions\", 0)\n    deletions = header.get(\"deletions\", 0)\n    files = header.get(\"filesChanged\", 0)\n    return \"\\n      \".join([\n        f'<span class=\"stat green\">'\n        f'<span class=\"num\">+{additions}</span> additions</span>',\n        f'<span class=\"stat red\">'\n        f'<span class=\"num\">&minus;{deletions}</span> deletions</span>',\n        f'<span class=\"stat\">'\n        f'<span class=\"num\">{files}</span> files</span>',\n        f'<span class=\"stat\">'\n        f'<span class=\"num\">{commits}</span>'\n        f' commit{\"s\" if commits != 1 else \"\"}</span>',\n    ])\n\n\ndef render_status_badges(header: dict) -> str:\n    badges = []\n    for b in header.get(\"statusBadges\", []):\n        icon = b.get(\"icon\", \"\")\n        badges.append(\n            f'<span class=\"status-badge {b[\"type\"]}\">{icon} {esc(b[\"label\"])}</span>'\n        )\n    return \"\\n      \".join(badges)\n\n\ndef render_factory_history_tab_button(data: dict) -> str:\n    if data.get(\"factoryHistory\"):\n        return (\n            '<button class=\"tab-btn\" onclick=\"switchTab(\\'history\\')\">'\n            \"Factory History</button>\"\n        )\n    return \"\"\n\n\ndef render_architecture_svg(arch: dict) -> str:\n    parts: list[str] = []\n\n    # Arrowhead marker (defined once)\n    parts.append(\n        '<defs><marker id=\"arrowhead\" markerWidth=\"8\" markerHeight=\"6\" '\n        'refX=\"8\" refY=\"3\" orient=\"auto\">'\n        '<path d=\"M0,0 L8,3 L0,6 Z\" fill=\"#9ca3af\"/></marker></defs>'\n    )\n\n    # Row labels\n    for label in arch.get(\"rowLabels\", []):\n        x, y = label[\"position\"][\"x\"], label[\"position\"][\"y\"]\n        parts.append(\n            f'<text x=\"{x}\" y=\"{y}\" text-anchor=\"end\" '\n            f'class=\"arch-row-label\">{esc(label[\"text\"])}</text>'\n        )\n\n    # Zone boxes + labels + sublabels + file count badges\n    for zone in arch.get(\"zones\", []):\n        pos = zone[\"position\"]\n        cat = zone.get(\"category\", \"product\")\n        colors = LAYER_COLORS.get(cat, LAYER_COLORS[\"product\"])\n        x, y, w, h = pos[\"x\"], pos[\"y\"], pos[\"width\"], pos[\"height\"]\n        cx = x + w / 2\n        label_y = y + h / 2 - 4\n        sublabel_y = y + h / 2 + 10\n        opacity = \"1\" if zone.get(\"isModified\") else \"0.6\"\n\n        parts.append(\n            f'<rect class=\"zone-box\" data-zone=\"{esc(zone[\"id\"])}\" '\n            f'x=\"{x}\" y=\"{y}\" width=\"{w}\" height=\"{h}\" rx=\"8\" '\n            f'fill=\"{colors[\"fill\"]}\" stroke=\"{colors[\"stroke\"]}\" '\n            f'stroke-width=\"1.5\" style=\"cursor:pointer;opacity:{opacity}\"/>'\n        )\n        parts.append(\n            f'<text x=\"{cx}\" y=\"{label_y}\" text-anchor=\"middle\" '\n            f'class=\"zone-label\" fill=\"{colors[\"text\"]}\" '\n            f'style=\"pointer-events:none\">{esc(zone[\"label\"])}</text>'\n        )\n        parts.append(\n            f'<text x=\"{cx}\" y=\"{sublabel_y}\" text-anchor=\"middle\" '\n            f'class=\"zone-sublabel\" style=\"pointer-events:none\">'\n            f'{esc(zone[\"sublabel\"])}</text>'\n        )\n        fc = zone.get(\"fileCount\", 0)\n        if fc > 0:\n            bcx, bcy = x + w - 8, y + 8\n            parts.append(\n                f'<circle class=\"zone-count-bg\" cx=\"{bcx}\" cy=\"{bcy}\" '\n                f'r=\"10\" fill=\"{colors[\"stroke\"]}\"/>'\n            )\n            parts.append(\n                f'<text class=\"zone-file-count\" x=\"{bcx}\" y=\"{bcy + 4}\" '\n                f'text-anchor=\"middle\" fill=\"white\" '\n                f'style=\"pointer-events:none\">{fc}</text>'\n            )\n\n    # Flow arrows\n    for arrow in arch.get(\"arrows\", []):\n        fx, fy = arrow[\"from\"][\"x\"], arrow[\"from\"][\"y\"]\n        tx, ty = arrow[\"to\"][\"x\"], arrow[\"to\"][\"y\"]\n        parts.append(\n            f'<line x1=\"{fx}\" y1=\"{fy}\" x2=\"{tx}\" y2=\"{ty}\" '\n            f'stroke=\"#9ca3af\" stroke-width=\"1.5\" marker-end=\"url(#arrowhead)\"/>'\n        )\n    return \"\\n          \".join(parts)\n\n\ndef render_spec_list(specs: list[dict]) -> str:\n    items = []\n    for s in specs:\n        path = s[\"path\"]\n        items.append(\n            f'<li>{s.get(\"icon\", \"\\U0001F4C4\")} '\n            f'<code class=\"file-path-link\" '\n            f\"onclick=\\\"openFileModal('{esc(path)}')\\\">\"\n            f'{esc(path)}</code> &mdash; '\n            f'{esc(s[\"description\"])}</li>'\n        )\n    return \"\\n          \".join(items)\n\n\ndef render_scenario_legend(scenarios: list[dict]) -> str:\n    categories = sorted({s.get(\"category\", \"\") for s in scenarios})\n    return \" \".join(\n        f'<span class=\"scenario-category {CATEGORY_CLASS.get(c, \"\")}\">{esc(c)}</span>'\n        for c in categories\n    )\n\n\ndef render_scenario_cards(scenarios: list[dict]) -> str:\n    cards = []\n    for s in scenarios:\n        color, icon, text = STATUS_STYLE.get(\n            s[\"status\"], (\"var(--gray)\", \"?\", s[\"status\"])\n        )\n        cat_class = CATEGORY_CLASS.get(s.get(\"category\", \"\"), \"\")\n        zone = s.get(\"zone\", \"\")\n        d = s.get(\"detail\", {})\n        # detail may be a dict {what, how, result} or a plain string\n        if isinstance(d, str):\n            detail_html = f'<p>{esc(d)}</p>' if d else ''\n        else:\n            detail_html = (\n                f'<dl>\\n'\n                f'      <dt>What</dt><dd>{esc(d.get(\"what\", \"\"))}</dd>\\n'\n                f'      <dt>How</dt><dd>{esc(d.get(\"how\", \"\"))}</dd>\\n'\n                f'      <dt>Result</dt><dd>{esc(d.get(\"result\", \"\"))}</dd>\\n'\n                f'    </dl>'\n            )\n        cards.append(\n            f'<div class=\"scenario-card\" data-zone=\"{esc(zone)}\" '\n            f'onclick=\"this.classList.toggle(\\'open\\')\">\\n'\n            f'  <div class=\"name\">{esc(s[\"name\"])}\\n'\n            f'    <span class=\"scenario-category {cat_class}\">'\n            f'{esc(s.get(\"category\", \"\"))}</span>\\n'\n            f'  </div>\\n'\n            f'  <div class=\"status\" style=\"color:{color}\">{icon} {text}</div>\\n'\n            f'  <div class=\"scenario-card-detail\">\\n'\n            f'    {detail_html}\\n'\n            f'  </div>\\n'\n            f'</div>'\n        )\n    return \"\\n          \".join(cards)\n\n\ndef render_what_changed_default(wc: dict) -> str:\n    \"\"\"Infrastructure + product summaries. These fields may contain HTML.\"\"\"\n    default = wc.get(\"defaultSummary\", {})\n    parts = []\n    infra = default.get(\"infrastructure\", \"\")\n    if infra:\n        parts.append(f'<p><strong>Infrastructure:</strong> {infra}</p>')\n    product = default.get(\"product\", \"\")\n    if product:\n        parts.append(f'<p><strong>Product:</strong> {product}</p>')\n    return \"\\n          \".join(parts)\n\n\ndef render_what_changed_zones(wc: dict) -> str:\n    divs = []\n    for z in wc.get(\"zoneDetails\", []):\n        # description may contain HTML\n        divs.append(\n            f'<div class=\"wc-zone-detail\" data-zone=\"{esc(z[\"zoneId\"])}\">\\n'\n            f'  <h4>{esc(z[\"title\"])}</h4>\\n'\n            f'  <p>{z[\"description\"]}</p>\\n'\n            f'</div>'\n        )\n    return \"\\n        \".join(divs)\n\n\ndef render_agentic_method_badge(review: dict) -> str:\n    method = review.get(\"reviewMethod\", \"main-agent\")\n    css = \"agent-teams\" if method == \"agent-teams\" else \"main-agent\"\n    label = \"Agent Teams\" if method == \"agent-teams\" else \"Main Agent\"\n    return f'<span class=\"review-method-badge {css}\">{label}</span>'\n\n\ndef render_agentic_legend() -> str:\n    \"\"\"Render compact legend for agent abbreviations.\"\"\"\n    entries = [\n        (\"CH\", \"Code Health\", \"code quality + complexity + dead code\"),\n        (\"SE\", \"Security\", \"vulnerabilities beyond bandit\"),\n        (\"TI\", \"Test Integrity\", \"test quality beyond AST scanner\"),\n        (\"AD\", \"Adversarial\", \"gaming, spec violations, architecture\"),\n    ]\n    items = []\n    for abbrev, name, desc in entries:\n        items.append(\n            f'<span class=\"agent-legend-item\" title=\"{esc(desc)}\">'\n            f'<span class=\"agent-abbrev\">{abbrev}</span> {esc(name)}</span>'\n        )\n    return (\n        '<div class=\"agent-legend\">'\n        + \" \".join(items)\n        + \"</div>\"\n    )\n\n\ndef render_agentic_rows(review: dict) -> str:\n    \"\"\"Render agentic review rows grouped by file.\n\n    Each file gets one master row with compact agent grade badges.\n    Expanding shows per-agent detail.\n    \"\"\"\n    from collections import OrderedDict\n\n    findings = review.get(\"findings\", [])\n    if not findings:\n        return \"\"\n\n    # Group by file, preserving order of first appearance\n    by_file: OrderedDict[str, list[dict]] = OrderedDict()\n    for f in findings:\n        filepath = f.get(\"file\", \"unknown\")\n        by_file.setdefault(filepath, []).append(f)\n\n    rows = []\n    for filepath, file_findings in by_file.items():\n        # Worst grade determines file sort order\n        worst_sort = min(f.get(\"gradeSortOrder\", 99) for f in file_findings)\n        zones = file_findings[0].get(\"zones\", \"\")\n\n        # Compact agent badges: CH:A  SE:B  TI:A  AD:B\n        badges = []\n        for f in file_findings:\n            agent_name = f.get(\"agent\", \"\") or \"main\"\n            abbrev = AGENT_ABBREV.get(agent_name, agent_name[:2].upper() if agent_name else \"?\")\n            grade = f.get(\"grade\", \"N/A\")\n            grade_css = GRADE_CLASS.get(grade, \"na\")\n            badges.append(\n                f'<span class=\"agent-grade-badge\">'\n                f'<span class=\"agent-abbrev\">{esc(abbrev)}</span>'\n                f'<span class=\"grade {grade_css}\">{esc(grade)}</span>'\n                f'</span>'\n            )\n        badges_html = \" \".join(badges)\n\n        # Most notable finding for the summary column\n        notable_finding = min(file_findings, key=lambda f: GRADE_SORT.get(f.get(\"grade\", \"N/A\"), 5))\n        notable_text = notable_finding.get(\"notable\", \"\")\n\n        # Master row (one per file)\n        rows.append(\n            f'<tr class=\"adv-row\" data-zones=\"{esc(zones)}\" '\n            f'data-grade-sort=\"{worst_sort}\" onclick=\"toggleAdvDetail(this)\">\\n'\n            f'  <td><code class=\"file-path-link\" '\n            f\"onclick=\\\"event.stopPropagation();\"\n            f\"openFileModal('{esc(filepath)}')\\\">\"\n            f'{esc(filepath)}</code></td>\\n'\n            f'  <td class=\"agent-badges-cell\">{badges_html}</td>\\n'\n            f'  <td><span class=\"zone-tag {layer_tag_class(\"product\")}\">'\n            f'{esc(zones)}</span></td>\\n'\n            f'  <td>{esc(notable_text)}</td>\\n'\n            f'</tr>\\n'\n        )\n\n        # Detail row: per-agent breakdown\n        detail_parts = []\n        for f in file_findings:\n            agent_name = f.get(\"agent\", \"\") or \"main\"\n            abbrev = AGENT_ABBREV.get(agent_name, agent_name[:2].upper() if agent_name else \"?\")\n            grade = f.get(\"grade\", \"N/A\")\n            grade_css = GRADE_CLASS.get(grade, \"na\")\n            detail_text = f.get(\"detail\", \"\") or f.get(\"notable\", \"\")\n            detail_parts.append(\n                f'<div class=\"agent-detail-entry\">'\n                f'<span class=\"agent-detail-header\">'\n                f'<span class=\"agent-abbrev\">{esc(abbrev)}</span>'\n                f'<span class=\"grade {grade_css}\">{esc(grade)}</span>'\n                f'<span class=\"agent-detail-name\">{esc(agent_name)}</span>'\n                f'</span>'\n                f'<div class=\"agent-detail-body\">{detail_text}</div>'\n                f'</div>'\n            )\n\n        rows.append(\n            f'<tr class=\"adv-detail-row\" data-zones=\"{esc(zones)}\">\\n'\n            f'  <td colspan=\"4\">{\"\".join(detail_parts)}</td>\\n'\n            f'</tr>'\n        )\n\n    return \"\\n            \".join(rows)\n\n\ndef render_ci_rows(ci_checks: list[dict]) -> str:\n    rows = []\n    for ci in ci_checks:\n        status_css = \"pass\" if ci[\"status\"] == \"pass\" else \"fail\"\n        health_css = HEALTH_CLASS.get(ci.get(\"healthTag\", \"normal\"), \"normal\")\n        detail = ci.get(\"detail\", {})\n\n        # Sub-checks\n        sub_html = \"\"\n        for chk in detail.get(\"checks\", []):\n            sub_html += (\n                '<div class=\"ci-check-item\" '\n                \"onclick=\\\"event.stopPropagation();this.classList.toggle('open')\\\">\\n\"\n                f'  <div class=\"ci-check-summary\">'\n                f'<span class=\"ci-sub-chevron\">&#x25B6;</span> '\n                f'{esc(chk[\"label\"])}</div>\\n'\n                f'  <div class=\"ci-check-detail\">{chk.get(\"detail\", \"\")}</div>\\n'\n                \"</div>\\n\"\n            )\n\n        zones_html = \" \".join(\n            f'<span class=\"zone-tag product\">{esc(z)}</span>'\n            for z in detail.get(\"zones\", [])\n        )\n        specs_html = \" \".join(\n            f'<code>{esc(s)}</code>' for s in detail.get(\"specRefs\", [])\n        )\n        notes_html = (\n            f'<p style=\"margin-top:6px;font-style:italic;font-size:12px;'\n            f'color:var(--text-muted)\">{esc(detail[\"notes\"])}</p>'\n            if detail.get(\"notes\")\n            else \"\"\n        )\n\n        rows.append(\n            f'<tr class=\"expandable\" onclick=\"toggleCIDetail(this)\">\\n'\n            f'  <td><strong>{esc(ci[\"name\"])}</strong> '\n            f'<small style=\"color:var(--text-muted)\">'\n            f'{esc(ci.get(\"trigger\", \"\"))}</small></td>\\n'\n            f'  <td><span class=\"badge {status_css}\">{esc(ci[\"status\"])}</span></td>\\n'\n            f'  <td><span class=\"time-label {health_css}\">{esc(ci[\"time\"])}</span>'\n            f'<br><span class=\"time-health-sub\">'\n            f'{esc(ci.get(\"healthTag\", \"\"))}</span></td>\\n'\n            f'  <td class=\"ci-chevron\">&#x25BC;</td>\\n'\n            f'</tr>\\n'\n            f'<tr class=\"detail-row\">\\n'\n            f'  <td colspan=\"4\">\\n'\n            f'    <p><strong>Coverage:</strong> {esc(detail.get(\"coverage\", \"\"))}</p>\\n'\n            f'    <p><strong>Gates:</strong> {esc(detail.get(\"gates\", \"\"))}</p>\\n'\n            f'    {sub_html}'\n            f'    <div style=\"margin-top:6px\">Zones: {zones_html}</div>\\n'\n            + (f'    <div>Specs: {specs_html}</div>\\n' if specs_html else \"\")\n            + f'    {notes_html}\\n'\n            f'  </td>\\n'\n            f'</tr>'\n        )\n    return \"\\n            \".join(rows)\n\n\ndef render_decision_cards(decisions: list[dict]) -> str:\n    cards = []\n    for d in decisions:\n        zones_str = d.get(\"zones\", \"\")\n        verified = d.get(\"verified\", True)\n        unverified = (\n            ' <span style=\"color:var(--red);font-size:11px\">[UNVERIFIED]</span>'\n            if not verified\n            else \"\"\n        )\n        zone_tags = \" \".join(\n            f'<span class=\"zone-tag product\">{esc(z)}</span>'\n            for z in zones_str.split()\n        )\n\n        files_html = \"\"\n        if d.get(\"files\"):\n            file_rows = \"\"\n            for f in d[\"files\"]:\n                file_rows += (\n                    f'<tr><td><code class=\"file-path-link\" '\n                    f\"onclick=\\\"event.stopPropagation();\"\n                    f\"openFileModal('{esc(f['path'])}')\\\">\"\n                    f'{esc(f[\"path\"])}</code></td>'\n                    f'<td>{esc(f[\"change\"])}</td></tr>\\n'\n                )\n            files_html = (\n                '<table style=\"width:100%;margin-top:8px\">'\n                \"<thead><tr><th>File</th><th>Change</th></tr></thead>\"\n                f\"<tbody>{file_rows}</tbody></table>\"\n            )\n\n        # body may contain HTML\n        cards.append(\n            f'<div class=\"decision-card\" data-zones=\"{esc(zones_str)}\">\\n'\n            f'  <div class=\"decision-header\" '\n            f'onclick=\"toggleDecision(this.parentElement)\">\\n'\n            f'    <span class=\"decision-num\">{d[\"number\"]}</span>\\n'\n            f\"    <div>\\n\"\n            f'      <div class=\"decision-title\">'\n            f'{esc(d[\"title\"])}{unverified}</div>\\n'\n            f'      <div class=\"decision-rationale\">'\n            f'{esc(d[\"rationale\"])}</div>\\n'\n            f\"    </div>\\n\"\n            f\"  </div>\\n\"\n            f'  <div class=\"decision-body\">\\n'\n            f'    <p>{d.get(\"body\", \"\")}</p>\\n'\n            f'    <div class=\"decision-zones\">{zone_tags}</div>\\n'\n            f'    <div class=\"decision-files\">{files_html}</div>\\n'\n            f\"  </div>\\n\"\n            f\"</div>\"\n        )\n    return \"\\n        \".join(cards)\n\n\ndef render_convergence_grid(convergence: dict) -> str:\n    cards = []\n    for gate in convergence.get(\"gates\", []):\n        st = gate.get(\"status\", \"passing\")\n        # detail may contain HTML\n        cards.append(\n            f'<div class=\"conv-card\" onclick=\"this.classList.toggle(\\'open\\')\">\\n'\n            f'  <div class=\"conv-name\">{esc(gate[\"name\"])}</div>\\n'\n            f'  <div class=\"conv-status {st}\">{esc(gate[\"statusText\"])}</div>\\n'\n            f'  <div class=\"conv-detail\">{esc(gate[\"summary\"])}</div>\\n'\n            f'  <div class=\"conv-card-detail\">{gate.get(\"detail\", \"\")}</div>\\n'\n            f\"</div>\"\n        )\n    overall = convergence.get(\"overall\", {})\n    if overall:\n        st = overall.get(\"status\", \"passing\")\n        cards.append(\n            f'<div class=\"conv-card\" onclick=\"this.classList.toggle(\\'open\\')\">\\n'\n            f'  <div class=\"conv-name\">Overall</div>\\n'\n            f'  <div class=\"conv-status {st}\">{esc(overall[\"statusText\"])}</div>\\n'\n            f'  <div class=\"conv-detail\">{esc(overall[\"summary\"])}</div>\\n'\n            f'  <div class=\"conv-card-detail\">{overall.get(\"detail\", \"\")}</div>\\n'\n            f\"</div>\"\n        )\n    return \"\\n          \".join(cards)\n\n\ndef render_post_merge_items(items: list[dict]) -> str:\n    rendered = []\n    for item in items:\n        priority = item.get(\"priority\", \"low\")\n\n        code_html = \"\"\n        if item.get(\"codeSnippet\"):\n            cs = item[\"codeSnippet\"]\n            header = f'## {cs.get(\"file\", \"\")}'\n            if cs.get(\"lineRange\"):\n                header += f', {cs[\"lineRange\"]}'\n            code_html = (\n                f'<div class=\"code-block\">'\n                f'{esc(header)}\\n{esc(cs.get(\"code\", \"\"))}</div>'\n            )\n\n        zones_html = \" \".join(\n            f'<span class=\"zone-tag product\">{esc(z)}</span>'\n            for z in item.get(\"zones\", [])\n        )\n\n        # title and description may contain HTML\n        rendered.append(\n            f'<div class=\"pm-item\">\\n'\n            f'  <div class=\"pm-header\" '\n            f\"onclick=\\\"this.parentElement.classList.toggle('open')\\\">\\n\"\n            f'    <span class=\"priority {priority}\">'\n            f\"{esc(priority.upper())}</span>\\n\"\n            f'    <span>{item.get(\"title\", \"\")}</span>\\n'\n            f\"  </div>\\n\"\n            f'  <div class=\"pm-body\">\\n'\n            f'    <p>{item.get(\"description\", \"\")}</p>\\n'\n            f\"    {code_html}\\n\"\n            f'    <div class=\"scenario-box failure\">\\n'\n            f'      <div class=\"scenario-label\">Failure scenario</div>\\n'\n            f'      {esc(item.get(\"failureScenario\", \"\"))}\\n'\n            f\"    </div>\\n\"\n            f'    <div class=\"scenario-box success\">\\n'\n            f'      <div class=\"scenario-label\">Resolution</div>\\n'\n            f'      {esc(item.get(\"successScenario\", \"\"))}\\n'\n            f\"    </div>\\n\"\n            f'    <div style=\"margin-top:6px\">{zones_html}</div>\\n'\n            f\"  </div>\\n\"\n            f\"</div>\"\n        )\n    return \"\\n        \".join(rendered)\n\n\ndef render_history_summary_cards(history: dict) -> str:\n    return \"\\n        \".join([\n        (\n            f'<div class=\"conv-card\" onclick=\"this.classList.toggle(\\'open\\')\">\\n'\n            f'  <div class=\"conv-name\">Iterations</div>\\n'\n            f'  <div class=\"conv-status passing\">'\n            f'{esc(history.get(\"iterationCount\", \"\"))}</div>\\n'\n            f'  <div class=\"conv-detail\">Factory convergence iterations</div>\\n'\n            f'  <div class=\"conv-card-detail\">'\n            f'{esc(history.get(\"satisfactionDetail\", \"\"))}</div>\\n'\n            f\"</div>\"\n        ),\n        (\n            f'<div class=\"conv-card\" onclick=\"this.classList.toggle(\\'open\\')\">\\n'\n            f'  <div class=\"conv-name\">Satisfaction</div>\\n'\n            f'  <div class=\"conv-status passing\">'\n            f'{esc(history.get(\"satisfactionTrajectory\", \"\"))}</div>\\n'\n            f'  <div class=\"conv-detail\">Scenario satisfaction trajectory</div>\\n'\n            f'  <div class=\"conv-card-detail\">'\n            f'{esc(history.get(\"satisfactionDetail\", \"\"))}</div>\\n'\n            f\"</div>\"\n        ),\n    ])\n\n\ndef render_history_timeline(events: list[dict]) -> str:\n    rendered = []\n    for ev in events:\n        ev_class = \"intervention\" if ev.get(\"type\") == \"intervention\" else \"\"\n        agent = ev.get(\"agent\", {})\n        agent_class = \"human\" if agent.get(\"type\") == \"human\" else \"\"\n        # expandedDetail may contain HTML\n        rendered.append(\n            f'<div class=\"history-event {ev_class}\" '\n            f'onclick=\"this.classList.toggle(\\'open\\')\">\\n'\n            f'  <div class=\"history-event-header\">\\n'\n            f'    <div class=\"history-event-title\">{esc(ev[\"title\"])}</div>\\n'\n            f'    <span class=\"event-agent {agent_class}\">'\n            f'{esc(agent.get(\"label\", \"\"))}</span>\\n'\n            f\"  </div>\\n\"\n            f'  <div class=\"history-event-detail-summary\">'\n            f'{esc(ev.get(\"detail\", \"\"))}</div>\\n'\n            f'  <div class=\"history-event-meta\">'\n            f'{esc(ev.get(\"meta\", \"\"))}</div>\\n'\n            f'  <div class=\"history-event-detail\">'\n            f'{ev.get(\"expandedDetail\", \"\")}</div>\\n'\n            f\"</div>\"\n        )\n    return \"\\n        \".join(rendered)\n\n\ndef _escape_popover(text: str) -> str:\n    \"\"\"Escape popover text for safe embedding in onclick JS attribute.\"\"\"\n    return (\n        text.replace(\"\\\\\", \"\\\\\\\\\")\n        .replace(\"'\", \"\\\\'\")\n        .replace('\"', \"&quot;\")\n        .replace(\"\\n\", \"\\\\n\")\n    )\n\n\ndef render_gate_findings_rows(findings: list[dict]) -> str:\n    rows = []\n    for row in findings:\n\n        def cell_html(cell: dict) -> str:\n            status = cell.get(\"status\", \"not-run\")\n            label = cell.get(\"label\", \"\")\n            popover = _escape_popover(cell.get(\"popover\", \"\"))\n            css_map = {\"pass\": \"pass\", \"fail\": \"fail\", \"advisory\": \"info\"}\n            css = css_map.get(status, \"\")\n            click = (\n                f\" class=\\\"gate-clickable\\\" \"\n                f\"onclick=\\\"showGatePopover(event, '{popover}')\\\"\"\n                if popover\n                else \"\"\n            )\n            return f\"<td{click}><span class=\\\"badge {css}\\\">{esc(label)}</span></td>\"\n\n        phase_popover = _escape_popover(row.get(\"phasePopover\", \"\"))\n        phase_click = (\n            f\" class=\\\"gate-clickable\\\" \"\n            f\"onclick=\\\"showGatePopover(event, '{phase_popover}')\\\"\"\n            if phase_popover\n            else \"\"\n        )\n        rows.append(\n            f\"<tr>\\n\"\n            f\"  <td{phase_click}>{esc(row['phase'])}</td>\\n\"\n            f\"  {cell_html(row['gate1'])}\\n\"\n            f\"  {cell_html(row['gate2'])}\\n\"\n            f\"  {cell_html(row['gate3'])}\\n\"\n            f\"  <td>{esc(row.get('action', ''))}</td>\\n\"\n            f\"</tr>\"\n        )\n    return \"\\n          \".join(rows)\n\n\n# \u2500\u2500 Main render pipeline \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n\ndef _escape_script_closing(text: str) -> str:\n    \"\"\"Escape </script> sequences so embedded JSON doesn't break HTML parsing.\n\n    The HTML parser scans for </script> to close <script> blocks regardless\n    of JavaScript string context. If raw file content (e.g., template.html)\n    contains </script>, the browser closes the <script> tag prematurely,\n    corrupting the page. Replacing </script with <\\\\/script is safe \u2014 the\n    JS engine interprets \\\\/ as / but the HTML parser no longer sees a\n    closing tag.\n    \"\"\"\n    return text.replace(\"</script\", r\"<\\/script\").replace(\"</Script\", r\"<\\/Script\")\n\n\ndef _calculate_viewbox(arch: dict) -> str:\n    \"\"\"Calculate SVG viewBox from architecture zone positions.\n\n    Returns a viewBox string that fits all zones, labels, and arrows\n    with padding. The left margin accounts for row labels rendered\n    with text-anchor='end'.\n    \"\"\"\n    if not arch or not arch.get(\"zones\"):\n        return \"0 0 780 360\"  # fallback default\n\n    min_x, min_y = float(\"inf\"), float(\"inf\")\n    max_x, max_y = float(\"-inf\"), float(\"-inf\")\n\n    for zone in arch.get(\"zones\", []):\n        pos = zone.get(\"position\", {})\n        x, y = pos.get(\"x\", 0), pos.get(\"y\", 0)\n        w, h = pos.get(\"width\", 120), pos.get(\"height\", 70)\n        min_x = min(min_x, x)\n        min_y = min(min_y, y)\n        max_x = max(max_x, x + w)\n        max_y = max(max_y, y + h)\n\n    for arrow in arch.get(\"arrows\", []):\n        for endpoint in (\"from\", \"to\"):\n            pt = arrow.get(endpoint, {})\n            max_x = max(max_x, pt.get(\"x\", 0))\n            max_y = max(max_y, pt.get(\"y\", 0))\n\n    # Row labels sit at small x with text-anchor=\"end\", extending left.\n    # Reserve ~120px to the left of min_x for label text.\n    label_margin = 120\n    pad = 20  # general padding\n\n    vb_x = min(min_x - label_margin, 0) - pad\n    vb_y = min(min_y, 0) - pad\n    vb_w = max_x - vb_x + pad\n    vb_h = max_y - vb_y + pad\n\n    return f\"{vb_x:.0f} {vb_y:.0f} {vb_w:.0f} {vb_h:.0f}\"\n\n\ndef render(\n    data_path: str | Path,\n    output_path: str | Path,\n    diff_data_path: str | Path | None = None,\n) -> None:\n    \"\"\"Render the review pack HTML from template + data.\n\n    Args:\n        data_path: Path to ReviewPackData JSON (Pass 2 output).\n        output_path: Where to write the rendered HTML.\n        diff_data_path: Path to diff data JSON (Pass 1 output).\n            If provided, the diff data is embedded inline in the HTML,\n            making the pack truly self-contained (no companion file\n            needed, no CORS issues with file:// protocol).\n            Generated by generate_diff_data.py \u2014 deterministic git\n            output, zero LLM involvement.\n    \"\"\"\n    template = TEMPLATE_PATH.read_text(encoding=\"utf-8\")\n    data = json.loads(Path(data_path).read_text(encoding=\"utf-8\"))\n\n    header = data.get(\"header\", {})\n\n    # Load diff data for inline embedding\n    diff_data_json: str | None = None\n    if diff_data_path is not None:\n        dd_path = Path(diff_data_path)\n        if dd_path.exists():\n            diff_data_json = dd_path.read_text(encoding=\"utf-8\")\n            # Verify it's valid JSON (deterministic \u2014 no transform)\n            json.loads(diff_data_json)\n            print(f\"Embedding diff data inline ({dd_path.stat().st_size / 1024:.0f} KB)\")\n        else:\n            print(\n                f\"WARNING: diff data file not found: {dd_path}\",\n                file=sys.stderr,\n            )\n\n    # \u2500\u2500 Text injection map (marker \u2192 replacement) \u2500\u2500\n    replacements: dict[str, str] = {\n        # Simple text fields\n        \"<!-- INJECT: header.title -->\": esc(header.get(\"title\", \"\")),\n        \"<!-- INJECT: header.prUrl -->\": esc(header.get(\"prUrl\", \"\")),\n        \"<!-- INJECT: header.headBranch -->\": esc(header.get(\"headBranch\", \"\")),\n        \"<!-- INJECT: header.baseBranch -->\": esc(header.get(\"baseBranch\", \"\")),\n        \"<!-- INJECT: header.headSha -->\": esc(header.get(\"headSha\", \"\")),\n        \"<!-- INJECT: header.generatedAt -->\": esc(header.get(\"generatedAt\", \"\")),\n        # Complex section injections\n        \"<!-- INJECT: stat items for additions, deletions, files, commits -->\": (\n            render_stat_items(header)\n        ),\n        \"<!-- INJECT: status badges -->\": render_status_badges(header),\n        \"<!-- INJECT: Factory History tab button \"\n        \"(conditionally, only if factoryHistory is present) -->\": (\n            render_factory_history_tab_button(data)\n        ),\n        \"<!-- INJECT: architecture zones, labels, arrows from DATA.architecture -->\": (\n            render_architecture_svg(data.get(\"architecture\", {}))\n        ),\n        \"<!-- INJECT: specification items from DATA.specs -->\": render_spec_list(\n            data.get(\"specs\", [])\n        ),\n        \"<!-- INJECT: scenario category legend items -->\": render_scenario_legend(\n            data.get(\"scenarios\", [])\n        ),\n        \"<!-- INJECT: scenario cards from DATA.scenarios -->\": render_scenario_cards(\n            data.get(\"scenarios\", [])\n        ),\n        \"<!-- INJECT: whatChanged.defaultSummary.infrastructure and .product -->\": (\n            render_what_changed_default(data.get(\"whatChanged\", {}))\n        ),\n        \"<!-- INJECT: wc-zone-detail divs for each zone -->\": (\n            render_what_changed_zones(data.get(\"whatChanged\", {}))\n        ),\n        \"<!-- INJECT: adversarial review method badge -->\": (\n            render_agentic_method_badge(data.get(\"agenticReview\", {}))\n            + render_agentic_legend()\n        ),\n        \"<!-- INJECT: adversarial finding rows from DATA.agenticReview.findings -->\": (\n            render_agentic_rows(data.get(\"agenticReview\", {}))\n        ),\n        \"<!-- INJECT: CI check rows from DATA.ciPerformance -->\": render_ci_rows(\n            data.get(\"ciPerformance\", [])\n        ),\n        \"<!-- INJECT: decision cards from DATA.decisions -->\": render_decision_cards(\n            data.get(\"decisions\", [])\n        ),\n        \"<!-- INJECT: convergence gate cards + overall card from DATA.convergence -->\": (\n            render_convergence_grid(data.get(\"convergence\", {}))\n        ),\n        \"<!-- INJECT: post-merge items from DATA.postMergeItems -->\": (\n            render_post_merge_items(data.get(\"postMergeItems\", []))\n        ),\n    }\n\n    # Factory history (conditional)\n    history = data.get(\"factoryHistory\")\n    if history:\n        replacements[\n            \"<!-- INJECT: iteration count + satisfaction trajectory cards -->\"\n        ] = render_history_summary_cards(history)\n        replacements[\n            \"<!-- INJECT: factory history events from DATA.factoryHistory.timeline -->\"\n        ] = render_history_timeline(history.get(\"timeline\", []))\n        replacements[\n            \"<!-- INJECT: gate finding rows from DATA.factoryHistory.gateFindings -->\"\n        ] = render_gate_findings_rows(history.get(\"gateFindings\", []))\n\n    # \u2500\u2500 Apply all replacements \u2500\u2500\n    for marker, content in replacements.items():\n        template = template.replace(marker, content)\n\n    # Clean up sub-comment hints (not injection points, just guidance)\n    for hint in (\n        '<!-- Row labels -->',\n        '<!-- Zone boxes (rect.zone-box[data-zone=\"...\"]) -->',\n        '<!-- Zone labels (text.zone-label) -->',\n        '<!-- Zone sublabels (text.zone-sublabel) -->',\n        '<!-- File count circles (circle.zone-count-bg + text.zone-file-count) -->',\n        '<!-- Flow arrows (line with marker-end) -->',\n        '<!-- Each row: tr.adv-row[data-zones=\"...\"][data-grade-sort=\"N\"] + tr.adv-detail-row -->',\n        '<!-- Each: tr.expandable + tr.detail-row with sub-checks -->',\n    ):\n        template = template.replace(hint, \"\")\n\n    # \u2500\u2500 Dynamic SVG viewBox from architecture data \u2500\u2500\n    arch_data = data.get(\"architecture\", {})\n    viewbox = _calculate_viewbox(arch_data)\n    template = template.replace(\n        'viewBox=\"0 0 780 360\"',\n        f'viewBox=\"{viewbox}\"',\n    )\n    vb_parts = viewbox.split()\n    vb_width = float(vb_parts[2])\n    template = template.replace(\n        \"max-width:780px\",\n        f\"max-width:{max(780, int(vb_width))}px\",\n    )\n\n    # \u2500\u2500 Inject DATA JSON for JS interactivity \u2500\u2500\n    data_json = json.dumps(data, indent=2)\n    template = template.replace(\"const DATA = {};\", f\"const DATA = {data_json};\")\n\n    # \u2500\u2500 Fix PR URL href \u2500\u2500\n    pr_url = header.get(\"prUrl\", \"#\")\n    template = template.replace(\n        'id=\"pr-url\" href=\"#\"', f'id=\"pr-url\" href=\"{esc(pr_url)}\"'\n    )\n\n    # \u2500\u2500 Embed reference file content for non-diff files \u2500\u2500\n    # Spec files, scenario files, etc. aren't in the diff data but users\n    # still need to view their raw content via the file modal.\n    ref_files: dict[str, str] = {}\n    repo_root = Path.cwd()\n    for spec in data.get(\"specs\", []):\n        spec_path = spec.get(\"path\", \"\")\n        if spec_path:\n            full = repo_root / spec_path\n            if full.exists():\n                ref_files[spec_path] = full.read_text(encoding=\"utf-8\")\n    if ref_files:\n        safe_ref_json = _escape_script_closing(json.dumps(ref_files))\n        ref_inject = (\n            \"<script>\\n\"\n            \"// Reference file content embedded by render_review_pack.py\\n\"\n            \"// These files are not in the diff but are viewable in raw mode.\\n\"\n            f\"const REFERENCE_FILES = {safe_ref_json};\\n\"\n            \"</script>\\n\"\n        )\n        template = template.replace(\n            \"<script>\\n// \u2550\u2550\u2550\",\n            ref_inject + \"<script>\\n// \u2550\u2550\u2550\",\n            1,\n        )\n        print(f\"Embedded {len(ref_files)} reference file(s) for raw view\")\n\n    # \u2500\u2500 Embed diff data inline for self-contained pack \u2500\u2500\n    # The template's loadDiffData() fetches pr_diff_data.json via fetch().\n    # This fails on file:// protocol due to CORS. To make the pack truly\n    # self-contained, we embed the diff data in a <script> block and\n    # replace the fetch with an immediate callback.\n    #\n    # Trust chain: generate_diff_data.py runs `git diff` and `git show`\n    # \u2014 deterministic git CLI output, zero LLM, byte-equivalent to\n    # what GitHub displays for the same commit SHA.\n    #\n    # CRITICAL: The diff data may contain raw file content (e.g.,\n    # template.html) with literal </script> tags. The HTML parser\n    # does not understand JS string context \u2014 it would close the\n    # <script> block prematurely, rendering the rest as visible text.\n    # _escape_script_closing() prevents this.\n    if diff_data_json is not None:\n        safe_diff_json = _escape_script_closing(diff_data_json)\n        # Inject diff data as a global variable\n        diff_inject = (\n            \"<script>\\n\"\n            \"// Diff data embedded inline by render_review_pack.py\\n\"\n            \"// Source: generate_diff_data.py (Pass 1, deterministic)\\n\"\n            \"// Trust: raw git diff/show output, zero LLM involvement\\n\"\n            f\"const DIFF_DATA_INLINE = {safe_diff_json};\\n\"\n            \"</script>\\n\"\n        )\n        # Insert before the main <script> block\n        template = template.replace(\n            \"<script>\\n// \u2550\u2550\u2550\",\n            diff_inject + \"<script>\\n// \u2550\u2550\u2550\",\n            1,\n        )\n        # Replace fetch-based loading with inline data\n        template = template.replace(\n            \"fetch('pr_diff_data.json')\",\n            \"Promise.resolve(new Response(JSON.stringify(\"\n            \"DIFF_DATA_INLINE)))\",\n        )\n\n    # \u2500\u2500 Write output \u2500\u2500\n    out = Path(output_path)\n    out.parent.mkdir(parents=True, exist_ok=True)\n    out.write_text(template, encoding=\"utf-8\")\n\n    size_kb = out.stat().st_size / 1024\n    print(f\"Rendered: {out} ({size_kb:.0f} KB)\")\n\n    # \u2500\u2500 Quick sanity check: any unreplaced markers? \u2500\u2500\n    # Count markers OUTSIDE of embedded content (diff data, reference files)\n    # to avoid false positives from SKILL.md/template.html diffs.\n    remaining = template.count(\"<!-- INJECT:\")\n    if remaining > 0:\n        # Check if all remaining markers are inside <script> blocks (embedded data)\n        import re\n\n        outside_script = re.sub(\n            r\"<script\\b[^>]*>.*?</script>\",\n            \"\",\n            template,\n            flags=re.DOTALL,\n        )\n        real_remaining = outside_script.count(\"<!-- INJECT:\")\n        if real_remaining > 0:\n            print(\n                f\"WARNING: {real_remaining} unreplaced <!-- INJECT: --> \"\n                f\"markers remain in HTML content!\",\n                file=sys.stderr,\n            )\n\n\ndef main() -> None:\n    parser = argparse.ArgumentParser(\n        description=\"Render PR review pack HTML from template + data (Pass 3).\"\n    )\n    parser.add_argument(\n        \"--data\", required=True, help=\"Path to ReviewPackData JSON file\"\n    )\n    parser.add_argument(\"--output\", required=True, help=\"Output HTML file path\")\n    parser.add_argument(\n        \"--diff-data\",\n        default=None,\n        help=(\n            \"Path to diff data JSON (Pass 1 output). \"\n            \"Embeds inline for self-contained pack.\"\n        ),\n    )\n    args = parser.parse_args()\n    render(args.data, args.output, args.diff_data)\n\n\nif __name__ == \"__main__\":\n    main()\n",
      "base": "#!/usr/bin/env python3\n\"\"\"Pass 3 renderer: inject ReviewPackData into the HTML template.\n\nReads the template HTML and a ReviewPackData JSON file, generates HTML for\nevery <!-- INJECT: ... --> marker, and produces a self-contained HTML file.\n\nThis is deterministic rendering \u2014 zero LLM involvement.\n\nUsage:\n    python3 render_review_pack.py --data review_pack_data.json --output docs/pr6_review_pack.html\n    python3 render_review_pack.py --data data.json --output out.html \\\n      --diff-data-filename pr6_diff_data.json\n\"\"\"\nfrom __future__ import annotations\n\nimport argparse\nimport html\nimport json\nimport sys\nfrom pathlib import Path\n\nTEMPLATE_PATH = Path(__file__).parent.parent / \"assets\" / \"template.html\"\n\n# \u2500\u2500 Color / class maps \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nLAYER_COLORS = {\n    \"factory\": {\"fill\": \"#dbeafe\", \"stroke\": \"#3b82f6\", \"text\": \"#1d4ed8\"},\n    \"product\": {\"fill\": \"#dcfce7\", \"stroke\": \"#22c55e\", \"text\": \"#166534\"},\n    \"infra\": {\"fill\": \"#f3e8ff\", \"stroke\": \"#8b5cf6\", \"text\": \"#6d28d9\"},\n}\n\nGRADE_CLASS = {\"A\": \"a\", \"B+\": \"b\", \"B\": \"b\", \"C\": \"c\", \"F\": \"f\", \"N/A\": \"na\"}\n\nHEALTH_CLASS = {\n    \"normal\": \"normal\",\n    \"acceptable\": \"acceptable\",\n    \"watch\": \"watch\",\n    \"refactor\": \"refactor\",\n}\n\nCATEGORY_CLASS = {\n    \"environment\": \"cat-environment\",\n    \"training\": \"cat-training\",\n    \"pipeline\": \"cat-pipeline\",\n    \"integration\": \"cat-integration\",\n}\n\nSTATUS_STYLE = {\n    \"passing\": (\"var(--green)\", \"&#x2713;\", \"Passing\"),\n    \"failing\": (\"var(--red)\", \"&#x2717;\", \"Failing\"),\n    \"advisory\": (\"var(--yellow)\", \"&#x26A0;\", \"Advisory\"),\n}\n\n\n# \u2500\u2500 Helpers \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\ndef esc(text: str) -> str:\n    \"\"\"HTML-escape plain text.\"\"\"\n    return html.escape(str(text))\n\n\ndef layer_tag_class(category: str) -> str:\n    \"\"\"Map zone category to CSS class for zone-tag.\"\"\"\n    return {\"factory\": \"factory\", \"product\": \"product\", \"infra\": \"infra\"}.get(\n        category, \"product\"\n    )\n\n\n# \u2500\u2500 Section renderers \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\ndef render_stat_items(header: dict) -> str:\n    commits = header.get(\"commits\", 0)\n    additions = header.get(\"additions\", 0)\n    deletions = header.get(\"deletions\", 0)\n    files = header.get(\"filesChanged\", 0)\n    return \"\\n      \".join([\n        f'<span class=\"stat green\">'\n        f'<span class=\"num\">+{additions}</span> additions</span>',\n        f'<span class=\"stat red\">'\n        f'<span class=\"num\">&minus;{deletions}</span> deletions</span>',\n        f'<span class=\"stat\">'\n        f'<span class=\"num\">{files}</span> files</span>',\n        f'<span class=\"stat\">'\n        f'<span class=\"num\">{commits}</span>'\n        f' commit{\"s\" if commits != 1 else \"\"}</span>',\n    ])\n\n\ndef render_status_badges(header: dict) -> str:\n    badges = []\n    for b in header.get(\"statusBadges\", []):\n        icon = b.get(\"icon\", \"\")\n        badges.append(\n            f'<span class=\"status-badge {b[\"type\"]}\">{icon} {esc(b[\"label\"])}</span>'\n        )\n    return \"\\n      \".join(badges)\n\n\ndef render_factory_history_tab_button(data: dict) -> str:\n    if data.get(\"factoryHistory\"):\n        return (\n            '<button class=\"tab-btn\" onclick=\"switchTab(\\'history\\')\">'\n            \"Factory History</button>\"\n        )\n    return \"\"\n\n\ndef render_architecture_svg(arch: dict) -> str:\n    parts: list[str] = []\n\n    # Arrowhead marker (defined once)\n    parts.append(\n        '<defs><marker id=\"arrowhead\" markerWidth=\"8\" markerHeight=\"6\" '\n        'refX=\"8\" refY=\"3\" orient=\"auto\">'\n        '<path d=\"M0,0 L8,3 L0,6 Z\" fill=\"#9ca3af\"/></marker></defs>'\n    )\n\n    # Row labels\n    for label in arch.get(\"rowLabels\", []):\n        x, y = label[\"position\"][\"x\"], label[\"position\"][\"y\"]\n        parts.append(\n            f'<text x=\"{x}\" y=\"{y}\" text-anchor=\"end\" '\n            f'class=\"arch-row-label\">{esc(label[\"text\"])}</text>'\n        )\n\n    # Zone boxes + labels + sublabels + file count badges\n    for zone in arch.get(\"zones\", []):\n        pos = zone[\"position\"]\n        cat = zone.get(\"category\", \"product\")\n        colors = LAYER_COLORS.get(cat, LAYER_COLORS[\"product\"])\n        x, y, w, h = pos[\"x\"], pos[\"y\"], pos[\"width\"], pos[\"height\"]\n        cx = x + w / 2\n        label_y = y + h / 2 - 4\n        sublabel_y = y + h / 2 + 10\n        opacity = \"1\" if zone.get(\"isModified\") else \"0.6\"\n\n        parts.append(\n            f'<rect class=\"zone-box\" data-zone=\"{esc(zone[\"id\"])}\" '\n            f'x=\"{x}\" y=\"{y}\" width=\"{w}\" height=\"{h}\" rx=\"8\" '\n            f'fill=\"{colors[\"fill\"]}\" stroke=\"{colors[\"stroke\"]}\" '\n            f'stroke-width=\"1.5\" style=\"cursor:pointer;opacity:{opacity}\"/>'\n        )\n        parts.append(\n            f'<text x=\"{cx}\" y=\"{label_y}\" text-anchor=\"middle\" '\n            f'class=\"zone-label\" fill=\"{colors[\"text\"]}\" '\n            f'style=\"pointer-events:none\">{esc(zone[\"label\"])}</text>'\n        )\n        parts.append(\n            f'<text x=\"{cx}\" y=\"{sublabel_y}\" text-anchor=\"middle\" '\n            f'class=\"zone-sublabel\" style=\"pointer-events:none\">'\n            f'{esc(zone[\"sublabel\"])}</text>'\n        )\n        fc = zone.get(\"fileCount\", 0)\n        if fc > 0:\n            bcx, bcy = x + w - 8, y + 8\n            parts.append(\n                f'<circle class=\"zone-count-bg\" cx=\"{bcx}\" cy=\"{bcy}\" '\n                f'r=\"10\" fill=\"{colors[\"stroke\"]}\"/>'\n            )\n            parts.append(\n                f'<text class=\"zone-file-count\" x=\"{bcx}\" y=\"{bcy + 4}\" '\n                f'text-anchor=\"middle\" fill=\"white\" '\n                f'style=\"pointer-events:none\">{fc}</text>'\n            )\n\n    # Flow arrows\n    for arrow in arch.get(\"arrows\", []):\n        fx, fy = arrow[\"from\"][\"x\"], arrow[\"from\"][\"y\"]\n        tx, ty = arrow[\"to\"][\"x\"], arrow[\"to\"][\"y\"]\n        parts.append(\n            f'<line x1=\"{fx}\" y1=\"{fy}\" x2=\"{tx}\" y2=\"{ty}\" '\n            f'stroke=\"#9ca3af\" stroke-width=\"1.5\" marker-end=\"url(#arrowhead)\"/>'\n        )\n    return \"\\n          \".join(parts)\n\n\ndef render_spec_list(specs: list[dict]) -> str:\n    items = []\n    for s in specs:\n        path = s[\"path\"]\n        items.append(\n            f'<li>{s.get(\"icon\", \"\\U0001F4C4\")} '\n            f'<code class=\"file-path-link\" '\n            f\"onclick=\\\"openFileModal('{esc(path)}')\\\">\"\n            f'{esc(path)}</code> &mdash; '\n            f'{esc(s[\"description\"])}</li>'\n        )\n    return \"\\n          \".join(items)\n\n\ndef render_scenario_legend(scenarios: list[dict]) -> str:\n    categories = sorted({s.get(\"category\", \"\") for s in scenarios})\n    return \" \".join(\n        f'<span class=\"scenario-category {CATEGORY_CLASS.get(c, \"\")}\">{esc(c)}</span>'\n        for c in categories\n    )\n\n\ndef render_scenario_cards(scenarios: list[dict]) -> str:\n    cards = []\n    for s in scenarios:\n        color, icon, text = STATUS_STYLE.get(\n            s[\"status\"], (\"var(--gray)\", \"?\", s[\"status\"])\n        )\n        cat_class = CATEGORY_CLASS.get(s.get(\"category\", \"\"), \"\")\n        zone = s.get(\"zone\", \"\")\n        d = s.get(\"detail\", {})\n        cards.append(\n            f'<div class=\"scenario-card\" data-zone=\"{esc(zone)}\" '\n            f'onclick=\"this.classList.toggle(\\'open\\')\">\\n'\n            f'  <div class=\"name\">{esc(s[\"name\"])}\\n'\n            f'    <span class=\"scenario-category {cat_class}\">'\n            f'{esc(s.get(\"category\", \"\"))}</span>\\n'\n            f'  </div>\\n'\n            f'  <div class=\"status\" style=\"color:{color}\">{icon} {text}</div>\\n'\n            f'  <div class=\"scenario-card-detail\">\\n'\n            f'    <dl>\\n'\n            f'      <dt>What</dt><dd>{esc(d.get(\"what\", \"\"))}</dd>\\n'\n            f'      <dt>How</dt><dd>{esc(d.get(\"how\", \"\"))}</dd>\\n'\n            f'      <dt>Result</dt><dd>{esc(d.get(\"result\", \"\"))}</dd>\\n'\n            f'    </dl>\\n'\n            f'  </div>\\n'\n            f'</div>'\n        )\n    return \"\\n          \".join(cards)\n\n\ndef render_what_changed_default(wc: dict) -> str:\n    \"\"\"Infrastructure + product summaries. These fields may contain HTML.\"\"\"\n    default = wc.get(\"defaultSummary\", {})\n    parts = []\n    infra = default.get(\"infrastructure\", \"\")\n    if infra:\n        parts.append(f'<p><strong>Infrastructure:</strong> {infra}</p>')\n    product = default.get(\"product\", \"\")\n    if product:\n        parts.append(f'<p><strong>Product:</strong> {product}</p>')\n    return \"\\n          \".join(parts)\n\n\ndef render_what_changed_zones(wc: dict) -> str:\n    divs = []\n    for z in wc.get(\"zoneDetails\", []):\n        # description may contain HTML\n        divs.append(\n            f'<div class=\"wc-zone-detail\" data-zone=\"{esc(z[\"zoneId\"])}\">\\n'\n            f'  <h4>{esc(z[\"title\"])}</h4>\\n'\n            f'  <p>{z[\"description\"]}</p>\\n'\n            f'</div>'\n        )\n    return \"\\n        \".join(divs)\n\n\ndef render_adversarial_rows(adv: dict) -> str:\n    rows = []\n    for f in adv.get(\"findings\", []):\n        grade = f.get(\"grade\", \"N/A\")\n        grade_css = GRADE_CLASS.get(grade, \"na\")\n        zones = f.get(\"zones\", \"\")\n        sort_order = f.get(\"gradeSortOrder\", 0)\n        # detail may contain HTML\n        rows.append(\n            f'<tr class=\"adv-row\" data-zones=\"{esc(zones)}\" '\n            f'data-grade-sort=\"{sort_order}\" onclick=\"toggleAdvDetail(this)\">\\n'\n            f'  <td><code class=\"file-path-link\" '\n            f\"onclick=\\\"event.stopPropagation();\"\n            f\"openFileModal('{esc(f['file'])}')\\\">\"\n            f'{esc(f[\"file\"])}</code></td>\\n'\n            f'  <td><span class=\"grade {grade_css}\">{esc(grade)}</span></td>\\n'\n            f'  <td><span class=\"zone-tag {layer_tag_class(\"product\")}\">'\n            f'{esc(zones)}</span></td>\\n'\n            f'  <td>{esc(f.get(\"notable\", \"\"))}</td>\\n'\n            f'</tr>\\n'\n            f'<tr class=\"adv-detail-row\" data-zones=\"{esc(zones)}\">\\n'\n            f'  <td colspan=\"4\">{f.get(\"detail\", \"\")}</td>\\n'\n            f'</tr>'\n        )\n    return \"\\n            \".join(rows)\n\n\ndef render_ci_rows(ci_checks: list[dict]) -> str:\n    rows = []\n    for ci in ci_checks:\n        status_css = \"pass\" if ci[\"status\"] == \"pass\" else \"fail\"\n        health_css = HEALTH_CLASS.get(ci.get(\"healthTag\", \"normal\"), \"normal\")\n        detail = ci.get(\"detail\", {})\n\n        # Sub-checks\n        sub_html = \"\"\n        for chk in detail.get(\"checks\", []):\n            sub_html += (\n                '<div class=\"ci-check-item\" '\n                \"onclick=\\\"event.stopPropagation();this.classList.toggle('open')\\\">\\n\"\n                f'  <div class=\"ci-check-summary\">'\n                f'<span class=\"ci-sub-chevron\">&#x25B6;</span> '\n                f'{esc(chk[\"label\"])}</div>\\n'\n                f'  <div class=\"ci-check-detail\">{chk.get(\"detail\", \"\")}</div>\\n'\n                \"</div>\\n\"\n            )\n\n        zones_html = \" \".join(\n            f'<span class=\"zone-tag product\">{esc(z)}</span>'\n            for z in detail.get(\"zones\", [])\n        )\n        specs_html = \" \".join(\n            f'<code>{esc(s)}</code>' for s in detail.get(\"specRefs\", [])\n        )\n        notes_html = (\n            f'<p style=\"margin-top:6px;font-style:italic;font-size:12px;'\n            f'color:var(--text-muted)\">{esc(detail[\"notes\"])}</p>'\n            if detail.get(\"notes\")\n            else \"\"\n        )\n\n        rows.append(\n            f'<tr class=\"expandable\" onclick=\"toggleCIDetail(this)\">\\n'\n            f'  <td><strong>{esc(ci[\"name\"])}</strong> '\n            f'<small style=\"color:var(--text-muted)\">'\n            f'{esc(ci.get(\"trigger\", \"\"))}</small></td>\\n'\n            f'  <td><span class=\"badge {status_css}\">{esc(ci[\"status\"])}</span></td>\\n'\n            f'  <td><span class=\"time-label {health_css}\">{esc(ci[\"time\"])}</span>'\n            f'<br><span class=\"time-health-sub\">'\n            f'{esc(ci.get(\"healthTag\", \"\"))}</span></td>\\n'\n            f'  <td class=\"ci-chevron\">&#x25BC;</td>\\n'\n            f'</tr>\\n'\n            f'<tr class=\"detail-row\">\\n'\n            f'  <td colspan=\"4\">\\n'\n            f'    <p><strong>Coverage:</strong> {esc(detail.get(\"coverage\", \"\"))}</p>\\n'\n            f'    <p><strong>Gates:</strong> {esc(detail.get(\"gates\", \"\"))}</p>\\n'\n            f'    {sub_html}'\n            f'    <div style=\"margin-top:6px\">Zones: {zones_html}</div>\\n'\n            + (f'    <div>Specs: {specs_html}</div>\\n' if specs_html else \"\")\n            + f'    {notes_html}\\n'\n            f'  </td>\\n'\n            f'</tr>'\n        )\n    return \"\\n            \".join(rows)\n\n\ndef render_decision_cards(decisions: list[dict]) -> str:\n    cards = []\n    for d in decisions:\n        zones_str = d.get(\"zones\", \"\")\n        verified = d.get(\"verified\", True)\n        unverified = (\n            ' <span style=\"color:var(--red);font-size:11px\">[UNVERIFIED]</span>'\n            if not verified\n            else \"\"\n        )\n        zone_tags = \" \".join(\n            f'<span class=\"zone-tag product\">{esc(z)}</span>'\n            for z in zones_str.split()\n        )\n\n        files_html = \"\"\n        if d.get(\"files\"):\n            file_rows = \"\"\n            for f in d[\"files\"]:\n                file_rows += (\n                    f'<tr><td><code class=\"file-path-link\" '\n                    f\"onclick=\\\"event.stopPropagation();\"\n                    f\"openFileModal('{esc(f['path'])}')\\\">\"\n                    f'{esc(f[\"path\"])}</code></td>'\n                    f'<td>{esc(f[\"change\"])}</td></tr>\\n'\n                )\n            files_html = (\n                '<table style=\"width:100%;margin-top:8px\">'\n                \"<thead><tr><th>File</th><th>Change</th></tr></thead>\"\n                f\"<tbody>{file_rows}</tbody></table>\"\n            )\n\n        # body may contain HTML\n        cards.append(\n            f'<div class=\"decision-card\" data-zones=\"{esc(zones_str)}\">\\n'\n            f'  <div class=\"decision-header\" '\n            f'onclick=\"toggleDecision(this.parentElement)\">\\n'\n            f'    <span class=\"decision-num\">{d[\"number\"]}</span>\\n'\n            f\"    <div>\\n\"\n            f'      <div class=\"decision-title\">'\n            f'{esc(d[\"title\"])}{unverified}</div>\\n'\n            f'      <div class=\"decision-rationale\">'\n            f'{esc(d[\"rationale\"])}</div>\\n'\n            f\"    </div>\\n\"\n            f\"  </div>\\n\"\n            f'  <div class=\"decision-body\">\\n'\n            f'    <p>{d.get(\"body\", \"\")}</p>\\n'\n            f'    <div class=\"decision-zones\">{zone_tags}</div>\\n'\n            f'    <div class=\"decision-files\">{files_html}</div>\\n'\n            f\"  </div>\\n\"\n            f\"</div>\"\n        )\n    return \"\\n        \".join(cards)\n\n\ndef render_convergence_grid(convergence: dict) -> str:\n    cards = []\n    for gate in convergence.get(\"gates\", []):\n        st = gate.get(\"status\", \"passing\")\n        # detail may contain HTML\n        cards.append(\n            f'<div class=\"conv-card\" onclick=\"this.classList.toggle(\\'open\\')\">\\n'\n            f'  <div class=\"conv-name\">{esc(gate[\"name\"])}</div>\\n'\n            f'  <div class=\"conv-status {st}\">{esc(gate[\"statusText\"])}</div>\\n'\n            f'  <div class=\"conv-detail\">{esc(gate[\"summary\"])}</div>\\n'\n            f'  <div class=\"conv-card-detail\">{gate.get(\"detail\", \"\")}</div>\\n'\n            f\"</div>\"\n        )\n    overall = convergence.get(\"overall\", {})\n    if overall:\n        st = overall.get(\"status\", \"passing\")\n        cards.append(\n            f'<div class=\"conv-card\" onclick=\"this.classList.toggle(\\'open\\')\">\\n'\n            f'  <div class=\"conv-name\">Overall</div>\\n'\n            f'  <div class=\"conv-status {st}\">{esc(overall[\"statusText\"])}</div>\\n'\n            f'  <div class=\"conv-detail\">{esc(overall[\"summary\"])}</div>\\n'\n            f'  <div class=\"conv-card-detail\">{overall.get(\"detail\", \"\")}</div>\\n'\n            f\"</div>\"\n        )\n    return \"\\n          \".join(cards)\n\n\ndef render_post_merge_items(items: list[dict]) -> str:\n    rendered = []\n    for item in items:\n        priority = item.get(\"priority\", \"low\")\n\n        code_html = \"\"\n        if item.get(\"codeSnippet\"):\n            cs = item[\"codeSnippet\"]\n            header = f'## {cs.get(\"file\", \"\")}'\n            if cs.get(\"lineRange\"):\n                header += f', {cs[\"lineRange\"]}'\n            code_html = (\n                f'<div class=\"code-block\">'\n                f'{esc(header)}\\n{esc(cs.get(\"code\", \"\"))}</div>'\n            )\n\n        zones_html = \" \".join(\n            f'<span class=\"zone-tag product\">{esc(z)}</span>'\n            for z in item.get(\"zones\", [])\n        )\n\n        # title and description may contain HTML\n        rendered.append(\n            f'<div class=\"pm-item\">\\n'\n            f'  <div class=\"pm-header\" '\n            f\"onclick=\\\"this.parentElement.classList.toggle('open')\\\">\\n\"\n            f'    <span class=\"priority {priority}\">'\n            f\"{esc(priority.upper())}</span>\\n\"\n            f'    <span>{item.get(\"title\", \"\")}</span>\\n'\n            f\"  </div>\\n\"\n            f'  <div class=\"pm-body\">\\n'\n            f'    <p>{item.get(\"description\", \"\")}</p>\\n'\n            f\"    {code_html}\\n\"\n            f'    <div class=\"scenario-box failure\">\\n'\n            f'      <div class=\"scenario-label\">Failure scenario</div>\\n'\n            f'      {esc(item.get(\"failureScenario\", \"\"))}\\n'\n            f\"    </div>\\n\"\n            f'    <div class=\"scenario-box success\">\\n'\n            f'      <div class=\"scenario-label\">Resolution</div>\\n'\n            f'      {esc(item.get(\"successScenario\", \"\"))}\\n'\n            f\"    </div>\\n\"\n            f'    <div style=\"margin-top:6px\">{zones_html}</div>\\n'\n            f\"  </div>\\n\"\n            f\"</div>\"\n        )\n    return \"\\n        \".join(rendered)\n\n\ndef render_history_summary_cards(history: dict) -> str:\n    return \"\\n        \".join([\n        (\n            f'<div class=\"conv-card\" onclick=\"this.classList.toggle(\\'open\\')\">\\n'\n            f'  <div class=\"conv-name\">Iterations</div>\\n'\n            f'  <div class=\"conv-status passing\">'\n            f'{esc(history.get(\"iterationCount\", \"\"))}</div>\\n'\n            f'  <div class=\"conv-detail\">Factory convergence iterations</div>\\n'\n            f'  <div class=\"conv-card-detail\">'\n            f'{esc(history.get(\"satisfactionDetail\", \"\"))}</div>\\n'\n            f\"</div>\"\n        ),\n        (\n            f'<div class=\"conv-card\" onclick=\"this.classList.toggle(\\'open\\')\">\\n'\n            f'  <div class=\"conv-name\">Satisfaction</div>\\n'\n            f'  <div class=\"conv-status passing\">'\n            f'{esc(history.get(\"satisfactionTrajectory\", \"\"))}</div>\\n'\n            f'  <div class=\"conv-detail\">Scenario satisfaction trajectory</div>\\n'\n            f'  <div class=\"conv-card-detail\">'\n            f'{esc(history.get(\"satisfactionDetail\", \"\"))}</div>\\n'\n            f\"</div>\"\n        ),\n    ])\n\n\ndef render_history_timeline(events: list[dict]) -> str:\n    rendered = []\n    for ev in events:\n        ev_class = \"intervention\" if ev.get(\"type\") == \"intervention\" else \"\"\n        agent = ev.get(\"agent\", {})\n        agent_class = \"human\" if agent.get(\"type\") == \"human\" else \"\"\n        # expandedDetail may contain HTML\n        rendered.append(\n            f'<div class=\"history-event {ev_class}\" '\n            f'onclick=\"this.classList.toggle(\\'open\\')\">\\n'\n            f'  <div class=\"history-event-header\">\\n'\n            f'    <div class=\"history-event-title\">{esc(ev[\"title\"])}</div>\\n'\n            f'    <span class=\"event-agent {agent_class}\">'\n            f'{esc(agent.get(\"label\", \"\"))}</span>\\n'\n            f\"  </div>\\n\"\n            f'  <div class=\"history-event-detail-summary\">'\n            f'{esc(ev.get(\"detail\", \"\"))}</div>\\n'\n            f'  <div class=\"history-event-meta\">'\n            f'{esc(ev.get(\"meta\", \"\"))}</div>\\n'\n            f'  <div class=\"history-event-detail\">'\n            f'{ev.get(\"expandedDetail\", \"\")}</div>\\n'\n            f\"</div>\"\n        )\n    return \"\\n        \".join(rendered)\n\n\ndef _escape_popover(text: str) -> str:\n    \"\"\"Escape popover text for safe embedding in onclick JS attribute.\"\"\"\n    return (\n        text.replace(\"\\\\\", \"\\\\\\\\\")\n        .replace(\"'\", \"\\\\'\")\n        .replace('\"', \"&quot;\")\n        .replace(\"\\n\", \"\\\\n\")\n    )\n\n\ndef render_gate_findings_rows(findings: list[dict]) -> str:\n    rows = []\n    for row in findings:\n\n        def cell_html(cell: dict) -> str:\n            status = cell.get(\"status\", \"not-run\")\n            label = cell.get(\"label\", \"\")\n            popover = _escape_popover(cell.get(\"popover\", \"\"))\n            css_map = {\"pass\": \"pass\", \"fail\": \"fail\", \"advisory\": \"info\"}\n            css = css_map.get(status, \"\")\n            click = (\n                f\" class=\\\"gate-clickable\\\" \"\n                f\"onclick=\\\"showGatePopover(event, '{popover}')\\\"\"\n                if popover\n                else \"\"\n            )\n            return f\"<td{click}><span class=\\\"badge {css}\\\">{esc(label)}</span></td>\"\n\n        phase_popover = _escape_popover(row.get(\"phasePopover\", \"\"))\n        phase_click = (\n            f\" class=\\\"gate-clickable\\\" \"\n            f\"onclick=\\\"showGatePopover(event, '{phase_popover}')\\\"\"\n            if phase_popover\n            else \"\"\n        )\n        rows.append(\n            f\"<tr>\\n\"\n            f\"  <td{phase_click}>{esc(row['phase'])}</td>\\n\"\n            f\"  {cell_html(row['gate1'])}\\n\"\n            f\"  {cell_html(row['gate2'])}\\n\"\n            f\"  {cell_html(row['gate3'])}\\n\"\n            f\"  <td>{esc(row.get('action', ''))}</td>\\n\"\n            f\"</tr>\"\n        )\n    return \"\\n          \".join(rows)\n\n\n# \u2500\u2500 Main render pipeline \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n\ndef render(\n    data_path: str | Path,\n    output_path: str | Path,\n    diff_data_path: str | Path | None = None,\n) -> None:\n    \"\"\"Render the review pack HTML from template + data.\n\n    Args:\n        data_path: Path to ReviewPackData JSON (Pass 2 output).\n        output_path: Where to write the rendered HTML.\n        diff_data_path: Path to diff data JSON (Pass 1 output).\n            If provided, the diff data is embedded inline in the HTML,\n            making the pack truly self-contained (no companion file\n            needed, no CORS issues with file:// protocol).\n            Generated by generate_diff_data.py \u2014 deterministic git\n            output, zero LLM involvement.\n    \"\"\"\n    template = TEMPLATE_PATH.read_text(encoding=\"utf-8\")\n    data = json.loads(Path(data_path).read_text(encoding=\"utf-8\"))\n\n    header = data.get(\"header\", {})\n\n    # Load diff data for inline embedding\n    diff_data_json: str | None = None\n    if diff_data_path is not None:\n        dd_path = Path(diff_data_path)\n        if dd_path.exists():\n            diff_data_json = dd_path.read_text(encoding=\"utf-8\")\n            # Verify it's valid JSON (deterministic \u2014 no transform)\n            json.loads(diff_data_json)\n            print(f\"Embedding diff data inline ({dd_path.stat().st_size / 1024:.0f} KB)\")\n        else:\n            print(\n                f\"WARNING: diff data file not found: {dd_path}\",\n                file=sys.stderr,\n            )\n\n    # \u2500\u2500 Text injection map (marker \u2192 replacement) \u2500\u2500\n    replacements: dict[str, str] = {\n        # Simple text fields\n        \"<!-- INJECT: header.title -->\": esc(header.get(\"title\", \"\")),\n        \"<!-- INJECT: header.prUrl -->\": esc(header.get(\"prUrl\", \"\")),\n        \"<!-- INJECT: header.headBranch -->\": esc(header.get(\"headBranch\", \"\")),\n        \"<!-- INJECT: header.baseBranch -->\": esc(header.get(\"baseBranch\", \"\")),\n        \"<!-- INJECT: header.headSha -->\": esc(header.get(\"headSha\", \"\")),\n        \"<!-- INJECT: header.generatedAt -->\": esc(header.get(\"generatedAt\", \"\")),\n        # Complex section injections\n        \"<!-- INJECT: stat items for additions, deletions, files, commits -->\": (\n            render_stat_items(header)\n        ),\n        \"<!-- INJECT: status badges -->\": render_status_badges(header),\n        \"<!-- INJECT: Factory History tab button \"\n        \"(conditionally, only if factoryHistory is present) -->\": (\n            render_factory_history_tab_button(data)\n        ),\n        \"<!-- INJECT: architecture zones, labels, arrows from DATA.architecture -->\": (\n            render_architecture_svg(data.get(\"architecture\", {}))\n        ),\n        \"<!-- INJECT: specification items from DATA.specs -->\": render_spec_list(\n            data.get(\"specs\", [])\n        ),\n        \"<!-- INJECT: scenario category legend items -->\": render_scenario_legend(\n            data.get(\"scenarios\", [])\n        ),\n        \"<!-- INJECT: scenario cards from DATA.scenarios -->\": render_scenario_cards(\n            data.get(\"scenarios\", [])\n        ),\n        \"<!-- INJECT: whatChanged.defaultSummary.infrastructure and .product -->\": (\n            render_what_changed_default(data.get(\"whatChanged\", {}))\n        ),\n        \"<!-- INJECT: wc-zone-detail divs for each zone -->\": (\n            render_what_changed_zones(data.get(\"whatChanged\", {}))\n        ),\n        \"<!-- INJECT: adversarial finding rows from DATA.adversarialReview.findings -->\": (\n            render_adversarial_rows(data.get(\"adversarialReview\", {}))\n        ),\n        \"<!-- INJECT: CI check rows from DATA.ciPerformance -->\": render_ci_rows(\n            data.get(\"ciPerformance\", [])\n        ),\n        \"<!-- INJECT: decision cards from DATA.decisions -->\": render_decision_cards(\n            data.get(\"decisions\", [])\n        ),\n        \"<!-- INJECT: convergence gate cards + overall card from DATA.convergence -->\": (\n            render_convergence_grid(data.get(\"convergence\", {}))\n        ),\n        \"<!-- INJECT: post-merge items from DATA.postMergeItems -->\": (\n            render_post_merge_items(data.get(\"postMergeItems\", []))\n        ),\n    }\n\n    # Factory history (conditional)\n    history = data.get(\"factoryHistory\")\n    if history:\n        replacements[\n            \"<!-- INJECT: iteration count + satisfaction trajectory cards -->\"\n        ] = render_history_summary_cards(history)\n        replacements[\n            \"<!-- INJECT: factory history events from DATA.factoryHistory.timeline -->\"\n        ] = render_history_timeline(history.get(\"timeline\", []))\n        replacements[\n            \"<!-- INJECT: gate finding rows from DATA.factoryHistory.gateFindings -->\"\n        ] = render_gate_findings_rows(history.get(\"gateFindings\", []))\n\n    # \u2500\u2500 Apply all replacements \u2500\u2500\n    for marker, content in replacements.items():\n        template = template.replace(marker, content)\n\n    # Clean up sub-comment hints (not injection points, just guidance)\n    for hint in (\n        '<!-- Row labels -->',\n        '<!-- Zone boxes (rect.zone-box[data-zone=\"...\"]) -->',\n        '<!-- Zone labels (text.zone-label) -->',\n        '<!-- Zone sublabels (text.zone-sublabel) -->',\n        '<!-- File count circles (circle.zone-count-bg + text.zone-file-count) -->',\n        '<!-- Flow arrows (line with marker-end) -->',\n        '<!-- Each row: tr.adv-row[data-zones=\"...\"][data-grade-sort=\"N\"] + tr.adv-detail-row -->',\n        '<!-- Each: tr.expandable + tr.detail-row with sub-checks -->',\n    ):\n        template = template.replace(hint, \"\")\n\n    # \u2500\u2500 Inject DATA JSON for JS interactivity \u2500\u2500\n    data_json = json.dumps(data, indent=2)\n    template = template.replace(\"const DATA = {};\", f\"const DATA = {data_json};\")\n\n    # \u2500\u2500 Fix PR URL href \u2500\u2500\n    pr_url = header.get(\"prUrl\", \"#\")\n    template = template.replace(\n        'id=\"pr-url\" href=\"#\"', f'id=\"pr-url\" href=\"{esc(pr_url)}\"'\n    )\n\n    # \u2500\u2500 Embed reference file content for non-diff files \u2500\u2500\n    # Spec files, scenario files, etc. aren't in the diff data but users\n    # still need to view their raw content via the file modal.\n    ref_files: dict[str, str] = {}\n    repo_root = Path.cwd()\n    for spec in data.get(\"specs\", []):\n        spec_path = spec.get(\"path\", \"\")\n        if spec_path:\n            full = repo_root / spec_path\n            if full.exists():\n                ref_files[spec_path] = full.read_text(encoding=\"utf-8\")\n    if ref_files:\n        ref_inject = (\n            \"<script>\\n\"\n            \"// Reference file content embedded by render_review_pack.py\\n\"\n            \"// These files are not in the diff but are viewable in raw mode.\\n\"\n            f\"const REFERENCE_FILES = {json.dumps(ref_files)};\\n\"\n            \"</script>\\n\"\n        )\n        template = template.replace(\n            \"<script>\\n// \u2550\u2550\u2550\",\n            ref_inject + \"<script>\\n// \u2550\u2550\u2550\",\n            1,\n        )\n        print(f\"Embedded {len(ref_files)} reference file(s) for raw view\")\n\n    # \u2500\u2500 Embed diff data inline for self-contained pack \u2500\u2500\n    # The template's loadDiffData() fetches pr_diff_data.json via fetch().\n    # This fails on file:// protocol due to CORS. To make the pack truly\n    # self-contained, we embed the diff data in a <script> block and\n    # replace the fetch with an immediate callback.\n    #\n    # Trust chain: generate_diff_data.py runs `git diff` and `git show`\n    # \u2014 deterministic git CLI output, zero LLM, byte-equivalent to\n    # what GitHub displays for the same commit SHA.\n    if diff_data_json is not None:\n        # Inject diff data as a global variable\n        diff_inject = (\n            f\"<script>\\n\"\n            f\"// Diff data embedded inline by render_review_pack.py\\n\"\n            f\"// Source: generate_diff_data.py (Pass 1, deterministic)\\n\"\n            f\"// Trust: raw git diff/show output, zero LLM involvement\\n\"\n            f\"const DIFF_DATA_INLINE = {diff_data_json};\\n\"\n            f\"</script>\\n\"\n        )\n        # Insert before the main <script> block\n        template = template.replace(\n            \"<script>\\n// \u2550\u2550\u2550\",\n            diff_inject + \"<script>\\n// \u2550\u2550\u2550\",\n            1,\n        )\n        # Replace fetch-based loading with inline data\n        template = template.replace(\n            \"fetch('pr_diff_data.json')\",\n            \"Promise.resolve(new Response(JSON.stringify(\"\n            \"DIFF_DATA_INLINE)))\",\n        )\n\n    # \u2500\u2500 Write output \u2500\u2500\n    out = Path(output_path)\n    out.parent.mkdir(parents=True, exist_ok=True)\n    out.write_text(template, encoding=\"utf-8\")\n\n    size_kb = out.stat().st_size / 1024\n    print(f\"Rendered: {out} ({size_kb:.0f} KB)\")\n\n    # \u2500\u2500 Quick sanity check: any unreplaced markers? \u2500\u2500\n    remaining = template.count(\"<!-- INJECT:\")\n    if remaining > 0:\n        print(\n            f\"WARNING: {remaining} unreplaced <!-- INJECT: --> markers remain!\",\n            file=sys.stderr,\n        )\n\n\ndef main() -> None:\n    parser = argparse.ArgumentParser(\n        description=\"Render PR review pack HTML from template + data (Pass 3).\"\n    )\n    parser.add_argument(\n        \"--data\", required=True, help=\"Path to ReviewPackData JSON file\"\n    )\n    parser.add_argument(\"--output\", required=True, help=\"Output HTML file path\")\n    parser.add_argument(\n        \"--diff-data\",\n        default=None,\n        help=(\n            \"Path to diff data JSON (Pass 1 output). \"\n            \"Embeds inline for self-contained pack.\"\n        ),\n    )\n    args = parser.parse_args()\n    render(args.data, args.output, args.diff_data)\n\n\nif __name__ == \"__main__\":\n    main()\n"
    },
    ".claude/skills/pr-review-pack/scripts/scaffold_review_pack_data.py": {
      "additions": 559,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/.claude/skills/pr-review-pack/scripts/scaffold_review_pack_data.py b/.claude/skills/pr-review-pack/scripts/scaffold_review_pack_data.py\nnew file mode 100644\nindex 0000000..041b92c\n--- /dev/null\n+++ b/.claude/skills/pr-review-pack/scripts/scaffold_review_pack_data.py\n@@ -0,0 +1,559 @@\n+#!/usr/bin/env python3\n+\"\"\"Scaffold ReviewPackData JSON with all deterministic fields.\n+\n+Populates header, architecture, specs, scenarios, ciPerformance, and\n+convergence gates from git/gh/scenario data.  Semantic fields (decisions,\n+agenticReview, whatChanged, postMergeItems, factoryHistory) are left\n+empty for the Pass 2 LLM agent to fill \u2014 or preserved from an existing\n+JSON via --existing.\n+\n+Usage:\n+    # Fresh scaffold (Pass 2 agent fills semantic fields):\n+    python scaffold_review_pack_data.py \\\\\n+        --pr 9 --diff-data docs/pr9_diff_data.json --output /tmp/pr9_review_pack_data.json\n+\n+    # Update deterministic fields, keep semantic analysis from previous run:\n+    python scaffold_review_pack_data.py \\\\\n+        --pr 9 --diff-data docs/pr9_diff_data.json \\\\\n+        --existing /tmp/pr9_review_pack_data.json --output /tmp/pr9_review_pack_data.json\n+\"\"\"\n+\n+from __future__ import annotations\n+\n+import argparse\n+import json\n+import subprocess\n+import sys\n+import time\n+from datetime import UTC\n+from fnmatch import fnmatch\n+from pathlib import Path\n+\n+import yaml\n+\n+# \u2500\u2500 Zone position layout \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+# Deterministic: category \u2192 row, sequential x within row.\n+ROW_Y = {\"factory\": 30, \"product\": 160, \"infra\": 290}\n+ROW_LABELS = [\n+    {\"text\": \"INFRASTRUCTURE\", \"position\": {\"x\": -95, \"y\": ROW_Y[\"factory\"] + 5}},\n+    {\"text\": \"PRODUCT CODE\", \"position\": {\"x\": -95, \"y\": ROW_Y[\"product\"] + 5}},\n+    {\"text\": \"INFRA\", \"position\": {\"x\": -95, \"y\": ROW_Y[\"infra\"] + 5}},\n+]\n+ZONE_WIDTH = 120\n+ZONE_HEIGHT = 70\n+ZONE_GAP = 10\n+X_START = 20\n+\n+\n+# \u2500\u2500 Helpers \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+\n+def run_gh(args: list[str]) -> str:\n+    \"\"\"Run a gh CLI command and return stdout.\"\"\"\n+    result = subprocess.run(\n+        [\"gh\"] + args, capture_output=True, text=True, timeout=30\n+    )\n+    if result.returncode != 0:\n+        print(f\"WARNING: gh {' '.join(args)} failed: {result.stderr}\", file=sys.stderr)\n+        return \"\"\n+    return result.stdout.strip()\n+\n+\n+def match_file_to_zones(filepath: str, zones: dict) -> list[str]:\n+    \"\"\"Match a file path to zone IDs using glob patterns.\"\"\"\n+    matched = []\n+    for zone_id, zone_def in zones.items():\n+        for pattern in zone_def.get(\"paths\", []):\n+            if fnmatch(filepath, pattern):\n+                matched.append(zone_id)\n+                break\n+    return matched\n+\n+\n+def health_tag(seconds: float) -> str:\n+    if seconds < 60:\n+        return \"normal\"\n+    if seconds < 300:\n+        return \"acceptable\"\n+    if seconds < 600:\n+        return \"watch\"\n+    return \"refactor\"\n+\n+\n+def format_time(seconds: float) -> str:\n+    if seconds < 60:\n+        return f\"{seconds:.0f}s\"\n+    m, s = divmod(int(seconds), 60)\n+    return f\"{m}m {s}s\"\n+\n+\n+def parse_ci_time(started: str, completed: str) -> float:\n+    \"\"\"Parse ISO timestamps and return duration in seconds.\"\"\"\n+    from datetime import datetime\n+    fmt = \"%Y-%m-%dT%H:%M:%SZ\"\n+    try:\n+        start = datetime.strptime(started, fmt).replace(tzinfo=UTC)\n+        end = datetime.strptime(completed, fmt).replace(tzinfo=UTC)\n+        return max((end - start).total_seconds(), 0)\n+    except (ValueError, TypeError):\n+        return 0\n+\n+\n+# \u2500\u2500 Builders \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+\n+def build_header(pr_number: int, diff_data: dict, pr_meta: dict,\n+                 scenario_data: dict | None, ci_checks: list,\n+                 comment_counts: dict, gate0_data: dict | None) -> dict:\n+    \"\"\"Build the header section from deterministic sources.\"\"\"\n+    # Gate 0 badge\n+    if gate0_data:\n+        summary = gate0_data.get(\"summary\", {})\n+        has_critical = summary.get(\"has_critical\", False)\n+        g0_type = \"fail\" if has_critical else \"pass\"\n+        crit = summary.get(\"critical_findings\", 0)\n+        warn = summary.get(\"warning_findings\", 0)\n+        g0_label = f\"Gate 0: {crit} critical, {warn} warn\"\n+        g0_icon = \"\\u2717\" if has_critical else \"\\u2713\"\n+    else:\n+        g0_type = \"warn\"\n+        g0_label = \"Gate 0 NOT RUN\"\n+        g0_icon = \"\\u26a0\"\n+\n+    # CI badge\n+    ci_total = len(ci_checks)\n+    ci_pass = sum(1 for c in ci_checks if c.get(\"state\") == \"SUCCESS\")\n+    ci_type = \"pass\" if ci_pass == ci_total else \"fail\"\n+\n+    # Scenario badge\n+    if scenario_data:\n+        sc_pass = scenario_data.get(\"passed\", 0)\n+        sc_total = scenario_data.get(\"total\", 0)\n+    else:\n+        sc_pass = sc_total = 0\n+    if sc_pass == sc_total and sc_total > 0:\n+        sc_type = \"pass\"\n+    else:\n+        sc_type = \"warn\" if sc_pass > 0 else \"fail\"\n+\n+    # Comment badge\n+    total_comments = comment_counts.get(\"total\", 0)\n+    unresolved = comment_counts.get(\"unresolved\", 0)\n+    resolved = total_comments - unresolved\n+    cm_type = \"pass\" if unresolved == 0 else \"warn\"\n+\n+    commits_list = pr_meta.get(\"commits\", [])\n+    if isinstance(commits_list, list):\n+        num_commits = len(commits_list)\n+    else:\n+        num_commits = int(pr_meta.get(\"commits\", 0))\n+\n+    return {\n+        \"title\": pr_meta.get(\"title\", f\"PR #{pr_number}\"),\n+        \"prNumber\": pr_number,\n+        \"prUrl\": pr_meta.get(\"url\", f\"https://github.com/joeyfezster/building_ai_w_ai/pull/{pr_number}\"),\n+        \"headBranch\": pr_meta.get(\"headRefName\", \"\"),\n+        \"baseBranch\": pr_meta.get(\"baseRefName\", \"main\"),\n+        \"headSha\": pr_meta.get(\"headRefOid\", diff_data.get(\"head_sha\", \"\"))[:7],\n+        \"additions\": diff_data.get(\"total_additions\", pr_meta.get(\"additions\", 0)),\n+        \"deletions\": diff_data.get(\"total_deletions\", pr_meta.get(\"deletions\", 0)),\n+        \"filesChanged\": diff_data.get(\"total_files\", pr_meta.get(\"changedFiles\", 0)),\n+        \"commits\": num_commits,\n+        \"statusBadges\": [\n+            {\"label\": g0_label, \"type\": g0_type,\n+             \"icon\": g0_icon},\n+            {\"label\": f\"CI {ci_pass}/{ci_total}\",\n+             \"type\": ci_type,\n+             \"icon\": \"\\u2713\" if ci_type == \"pass\" else \"\\u2717\"},\n+            {\"label\": f\"{sc_pass}/{sc_total} Scenarios\",\n+             \"type\": sc_type,\n+             \"icon\": \"\\u2713\" if sc_type == \"pass\" else \"\\u26a0\"},\n+            {\"label\": f\"{resolved}/{total_comments} comments resolved\",\n+             \"type\": cm_type,\n+             \"icon\": \"\\u2713\" if cm_type == \"pass\" else \"\\u26a0\"},\n+        ],\n+        \"generatedAt\": time.strftime(\"%Y-%m-%dT%H:%M:%SZ\", time.gmtime()),\n+        \"generatedBy\": \"dark factory review agent\",\n+    }\n+\n+\n+def build_architecture(zones_registry: dict, diff_data: dict) -> dict:\n+    \"\"\"Build architecture diagram data from zone registry + diff.\"\"\"\n+    files = diff_data.get(\"files\", {})\n+    # Count files per zone\n+    zone_file_counts: dict[str, int] = {}\n+    zone_modified: dict[str, bool] = {}\n+    for filepath in files:\n+        matched = match_file_to_zones(filepath, zones_registry)\n+        for z in matched:\n+            zone_file_counts[z] = zone_file_counts.get(z, 0) + 1\n+            zone_modified[z] = True\n+\n+    # Layout: group by category row, sequential x placement\n+    category_x: dict[str, int] = {}\n+    arch_zones = []\n+    for zone_id, zone_def in zones_registry.items():\n+        cat = zone_def.get(\"category\", \"product\")\n+        x = category_x.get(cat, X_START)\n+        y = ROW_Y.get(cat, ROW_Y[\"product\"])\n+        arch_zones.append({\n+            \"id\": zone_id,\n+            \"label\": zone_def.get(\"label\", zone_id),\n+            \"sublabel\": zone_def.get(\"sublabel\", \"\"),\n+            \"category\": cat,\n+            \"fileCount\": zone_file_counts.get(zone_id, 0),\n+            \"position\": {\"x\": x, \"y\": y, \"width\": ZONE_WIDTH, \"height\": ZONE_HEIGHT},\n+            \"specs\": zone_def.get(\"specs\", []),\n+            \"isModified\": zone_modified.get(zone_id, False),\n+        })\n+        category_x[cat] = x + ZONE_WIDTH + ZONE_GAP\n+\n+    # Simple arrow: factory \u2192 first product zone (if both exist)\n+    arrows = []\n+    factory_zones = [z for z in arch_zones if z[\"category\"] == \"factory\"]\n+    product_zones = [z for z in arch_zones if z[\"category\"] == \"product\"]\n+    if factory_zones and product_zones:\n+        fz = factory_zones[0][\"position\"]\n+        pz = product_zones[0][\"position\"]\n+        arrows.append({\n+            \"from\": {\"x\": fz[\"x\"] + fz[\"width\"] // 2, \"y\": fz[\"y\"] + fz[\"height\"]},\n+            \"to\": {\"x\": pz[\"x\"] + pz[\"width\"] // 2, \"y\": pz[\"y\"]},\n+        })\n+    # Chain product zones left-to-right\n+    for i in range(len(product_zones) - 1):\n+        p1 = product_zones[i][\"position\"]\n+        p2 = product_zones[i + 1][\"position\"]\n+        arrows.append({\n+            \"from\": {\"x\": p1[\"x\"] + p1[\"width\"], \"y\": p1[\"y\"] + p1[\"height\"] // 2},\n+            \"to\": {\"x\": p2[\"x\"], \"y\": p2[\"y\"] + p2[\"height\"] // 2},\n+        })\n+\n+    return {\"zones\": arch_zones, \"arrows\": arrows, \"rowLabels\": ROW_LABELS}\n+\n+\n+def build_specs(zones_registry: dict) -> list[dict]:\n+    \"\"\"Build specs list from zone registry.\"\"\"\n+    seen: set[str] = set()\n+    specs = []\n+    for zone_def in zones_registry.values():\n+        for spec_path in zone_def.get(\"specs\", []):\n+            if spec_path not in seen:\n+                seen.add(spec_path)\n+                specs.append({\n+                    \"path\": spec_path,\n+                    \"icon\": \"\\U0001f4cb\",\n+                    \"description\": Path(spec_path).stem.replace(\"_\", \" \").title(),\n+                })\n+    return specs\n+\n+\n+def build_scenarios(scenario_data: dict | None) -> list[dict]:\n+    \"\"\"Build scenarios from scenario_results.json.\"\"\"\n+    if not scenario_data:\n+        return []\n+    scenarios = []\n+    category_zone_map = {\n+        \"environment\": \"environment\",\n+        \"training\": \"training\",\n+        \"pipeline\": \"training\",\n+        \"integration\": \"config\",\n+        \"dashboard\": \"dashboard\",\n+    }\n+    for r in scenario_data.get(\"results\", []):\n+        cat = r.get(\"category\", \"integration\")\n+        scenarios.append({\n+            \"name\": r[\"name\"],\n+            \"category\": cat,\n+            \"status\": \"pass\" if r[\"passed\"] else \"fail\",\n+            \"zone\": category_zone_map.get(cat, \"\"),\n+            \"detail\": {\n+                \"what\": r.get(\"name\", \"\"),\n+                \"how\": f\"Exit code {r.get('exit_code', '?')}, {r.get('duration_seconds', 0):.1f}s\",\n+                \"result\": r.get(\"stdout\", \"\").strip()[:200] if r[\"passed\"]\n+                else r.get(\"error_summary\", r.get(\"stderr\", \"\").strip()[:200]),\n+            },\n+        })\n+    return scenarios\n+\n+\n+def build_ci_performance(ci_checks_raw: list[dict]) -> list[dict]:\n+    \"\"\"Build CI performance from gh pr checks --json output.\"\"\"\n+    checks = []\n+    for c in ci_checks_raw:\n+        dur = parse_ci_time(c.get(\"startedAt\", \"\"), c.get(\"completedAt\", \"\"))\n+        name = c.get(\"name\", \"unknown\")\n+        # Determine trigger from link URL or context\n+        trigger = \"(PR)\" if \"pull_request\" in c.get(\"link\", \"\") else \"(push)\"\n+        checks.append({\n+            \"name\": name,\n+            \"trigger\": trigger,\n+            \"status\": \"pass\" if c.get(\"state\") == \"SUCCESS\" else \"fail\",\n+            \"time\": format_time(dur),\n+            \"timeSeconds\": round(dur),\n+            \"healthTag\": health_tag(dur),\n+            \"detail\": {\n+                \"coverage\": f\"{name} job\",\n+                \"gates\": \"\",\n+                \"zones\": [],\n+                \"specRefs\": [],\n+                \"checks\": [],\n+                \"notes\": None,\n+            },\n+        })\n+    return checks\n+\n+\n+def build_convergence(scenario_data: dict | None, ci_checks: list,\n+                      gate0_data: dict | None) -> dict:\n+    \"\"\"Build convergence gates from deterministic data.\"\"\"\n+    # Gate 0 \u2014 from gate0_results.json (tier 1 deterministic)\n+    if gate0_data:\n+        g0_summary = gate0_data.get(\"summary\", {})\n+        gate0_pass = not g0_summary.get(\"has_critical\", False)\n+        g0_checks = g0_summary.get(\"total_checks\", 0)\n+        g0_passed = g0_summary.get(\"passed\", 0)\n+        g0_criticals = g0_summary.get(\"critical_findings\", 0)\n+        g0_warnings = g0_summary.get(\"warning_findings\", 0)\n+        g0_status_text = (\n+            f\"Tier 1: {g0_passed}/{g0_checks} checks, \"\n+            f\"{g0_criticals} critical, {g0_warnings} warn\"\n+        )\n+        g0_elapsed = gate0_data.get(\"total_elapsed_s\", \"?\")\n+        g0_detail = f\"Deterministic tool checks ran in {g0_elapsed}s (parallel).\"\n+    else:\n+        gate0_pass = False\n+        g0_status_text = \"NOT RUN\"\n+        g0_detail = \"gate0_results.json not found. Run: python scripts/run_gate0.py\"\n+\n+    # Gate 1 \u2014 we can only say pass/fail based on CI validate job\n+    validate_jobs = [c for c in ci_checks if c.get(\"name\") == \"validate\"]\n+    gate1_pass = all(c.get(\"state\") == \"SUCCESS\" for c in validate_jobs) if validate_jobs else False\n+\n+    # Gate 3 \u2014 from scenarios\n+    if scenario_data:\n+        sc_pass = scenario_data.get(\"passed\", 0)\n+        sc_total = scenario_data.get(\"total\", 0)\n+        gate3_pass = sc_pass == sc_total and sc_total > 0\n+    else:\n+        sc_pass = sc_total = 0\n+        gate3_pass = False\n+\n+    all_pass = gate0_pass and gate1_pass and gate3_pass\n+\n+    return {\n+        \"gates\": [\n+            {\n+                \"name\": \"Gate 0 \\u2014 Two-Tier Review\",\n+                \"status\": \"passing\" if gate0_pass else \"failing\",\n+                \"statusText\": g0_status_text,\n+                \"summary\": g0_detail,\n+                \"detail\": \"\",\n+            },\n+            {\n+                \"name\": \"Gate 1 \\u2014 Deterministic\",\n+                \"status\": \"passing\" if gate1_pass else \"failing\",\n+                \"statusText\": \"PASSING\" if gate1_pass else \"FAILING\",\n+                \"summary\": \"\",\n+                \"detail\": \"\",\n+            },\n+            {\n+                \"name\": \"Gate 2 \\u2014 NFR\",\n+                \"status\": \"passing\",\n+                \"statusText\": \"PASS\",\n+                \"summary\": \"\",\n+                \"detail\": \"\",\n+            },\n+            {\n+                \"name\": \"Gate 3 \\u2014 Scenarios\",\n+                \"status\": \"passing\" if gate3_pass else \"failing\",\n+                \"statusText\": f\"{sc_pass}/{sc_total} ({sc_pass * 100 // max(sc_total, 1)}%)\",\n+                \"summary\": f\"{sc_pass} of {sc_total} holdout scenarios pass.\",\n+                \"detail\": \"\",\n+            },\n+        ],\n+        \"overall\": {\n+            \"status\": \"passing\" if all_pass else \"failing\",\n+            \"statusText\": \"READY TO MERGE\" if all_pass else \"NOT READY\",\n+            \"summary\": f\"All gates pass. {sc_pass}/{sc_total} scenario satisfaction.\"\n+            if all_pass\n+            else f\"Gates not all passing. {sc_pass}/{sc_total} scenarios.\",\n+            \"detail\": \"\",\n+        },\n+    }\n+\n+\n+# \u2500\u2500 Main \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+\n+def scaffold(pr_number: int, diff_data_path: str, zone_registry_path: str,\n+             scenario_results_path: str | None, gate0_results_path: str | None,\n+             existing_path: str | None, output_path: str) -> None:\n+    # Load inputs\n+    diff_data = json.loads(Path(diff_data_path).read_text())\n+    zones_registry = yaml.safe_load(Path(zone_registry_path).read_text()).get(\"zones\", {})\n+\n+    scenario_data = None\n+    if scenario_results_path and Path(scenario_results_path).exists():\n+        scenario_data = json.loads(Path(scenario_results_path).read_text())\n+\n+    gate0_data = None\n+    if gate0_results_path and Path(gate0_results_path).exists():\n+        gate0_data = json.loads(Path(gate0_results_path).read_text())\n+\n+    # Load existing JSON for semantic field preservation\n+    existing: dict | None = None\n+    if existing_path and Path(existing_path).exists():\n+        existing = json.loads(Path(existing_path).read_text())\n+        # Migrate legacy key: adversarialReview \u2192 agenticReview\n+        if \"adversarialReview\" in existing and \"agenticReview\" not in existing:\n+            existing[\"agenticReview\"] = existing.pop(\"adversarialReview\")\n+\n+    # Fetch PR metadata and CI checks from GitHub\n+    pr_meta_raw = run_gh([\n+        \"pr\", \"view\", str(pr_number), \"--json\",\n+        \"title,number,headRefName,baseRefName,headRefOid,url,commits,additions,deletions,changedFiles\"\n+    ])\n+    pr_meta = json.loads(pr_meta_raw) if pr_meta_raw else {}\n+\n+    ci_raw = run_gh([\n+        \"pr\", \"checks\", str(pr_number), \"--json\", \"name,state,startedAt,completedAt,link\"\n+    ])\n+    ci_checks = json.loads(ci_raw) if ci_raw else []\n+\n+    # Fetch comment counts\n+    comment_query = f'''{{\n+      repository(owner: \"joeyfezster\", name: \"building_ai_w_ai\") {{\n+        pullRequest(number: {pr_number}) {{\n+          reviewThreads(first: 100) {{\n+            nodes {{ isResolved }}\n+          }}\n+        }}\n+      }}\n+    }}'''\n+    comment_raw = run_gh([\n+        \"api\", \"graphql\", \"-f\", f\"query={comment_query}\",\n+        \"--jq\", \"\"\"{\n+  total: (.data.repository.pullRequest.reviewThreads.nodes\n+    | length),\n+  unresolved: ([\n+    .data.repository.pullRequest.reviewThreads.nodes[]\n+    | select(.isResolved == false)] | length)\n+}\"\"\"\n+    ])\n+    comment_counts = json.loads(comment_raw) if comment_raw else {\"total\": 0, \"unresolved\": 0}\n+\n+    # Build deterministic sections\n+    header = build_header(\n+        pr_number, diff_data, pr_meta, scenario_data,\n+        ci_checks, comment_counts, gate0_data,\n+    )\n+    architecture = build_architecture(zones_registry, diff_data)\n+    specs = build_specs(zones_registry)\n+    scenarios = build_scenarios(scenario_data)\n+    ci_perf = build_ci_performance(ci_checks)\n+    convergence = build_convergence(scenario_data, ci_checks, gate0_data)\n+\n+    # Semantic fields: preserve from existing or leave empty\n+    semantic_defaults = {\n+        \"whatChanged\": {\"defaultSummary\": {\"infrastructure\": \"\", \"product\": \"\"}, \"zoneDetails\": []},\n+        \"agenticReview\": {\"overallGrade\": \"\", \"reviewMethod\": \"main-agent\", \"findings\": []},\n+        \"decisions\": [],\n+        \"postMergeItems\": [],\n+        \"factoryHistory\": None,\n+    }\n+\n+    result: dict = {\n+        \"header\": header,\n+        \"architecture\": architecture,\n+        \"specs\": specs,\n+        \"scenarios\": scenarios,\n+        \"whatChanged\": (\n+            existing.get(\"whatChanged\", semantic_defaults[\"whatChanged\"])\n+            if existing else semantic_defaults[\"whatChanged\"]\n+        ),\n+        \"agenticReview\": (\n+            existing.get(\"agenticReview\", semantic_defaults[\"agenticReview\"])\n+            if existing else semantic_defaults[\"agenticReview\"]\n+        ),\n+        \"ciPerformance\": ci_perf,\n+        \"decisions\": (\n+            existing.get(\"decisions\", semantic_defaults[\"decisions\"])\n+            if existing else semantic_defaults[\"decisions\"]\n+        ),\n+        \"convergence\": convergence,\n+        \"postMergeItems\": (\n+            existing.get(\"postMergeItems\", semantic_defaults[\"postMergeItems\"])\n+            if existing else semantic_defaults[\"postMergeItems\"]\n+        ),\n+        \"factoryHistory\": (\n+            existing.get(\"factoryHistory\", semantic_defaults[\"factoryHistory\"])\n+            if existing else semantic_defaults[\"factoryHistory\"]\n+        ),\n+    }\n+\n+    # If existing has richer convergence gate details, merge them\n+    if existing:\n+        for i, gate in enumerate(result[\"convergence\"][\"gates\"]):\n+            existing_gates = existing.get(\"convergence\", {}).get(\"gates\", [])\n+            if i < len(existing_gates):\n+                eg = existing_gates[i]\n+                # Preserve semantic detail/summary if our computed version is empty\n+                if not gate[\"detail\"] and eg.get(\"detail\"):\n+                    gate[\"detail\"] = eg[\"detail\"]\n+                if not gate[\"summary\"] and eg.get(\"summary\"):\n+                    gate[\"summary\"] = eg[\"summary\"]\n+        existing_overall = existing.get(\"convergence\", {}).get(\"overall\", {})\n+        if not result[\"convergence\"][\"overall\"][\"detail\"] and existing_overall.get(\"detail\"):\n+            result[\"convergence\"][\"overall\"][\"detail\"] = existing_overall[\"detail\"]\n+\n+    # Write output\n+    Path(output_path).parent.mkdir(parents=True, exist_ok=True)\n+    Path(output_path).write_text(json.dumps(result, indent=2) + \"\\n\")\n+\n+    # Report\n+    det_fields = [\"header\", \"architecture\", \"specs\", \"scenarios\", \"ciPerformance\"]\n+    sem_fields = [\"whatChanged\", \"agenticReview\", \"decisions\", \"postMergeItems\", \"factoryHistory\"]\n+    sem_source = \"preserved from existing\" if existing else \"empty (for Pass 2 agent)\"\n+\n+    print(f\"Scaffolded: {output_path}\")\n+    print(f\"  Deterministic: {', '.join(det_fields)}\")\n+    print(f\"  Convergence: gates computed, overall {'merged' if existing else 'computed'}\")\n+    print(f\"  Semantic ({sem_source}): {', '.join(sem_fields)}\")\n+    h = header\n+    print(\n+        f\"  Header: {h['filesChanged']} files, \"\n+        f\"+{h['additions']}/-{h['deletions']}, \"\n+        f\"{h['commits']} commits\"\n+    )\n+    print(f\"  Scenarios: {header['statusBadges'][1]['label']}\")\n+    print(f\"  CI: {header['statusBadges'][0]['label']}\")\n+\n+\n+def main() -> None:\n+    parser = argparse.ArgumentParser(\n+        description=\"Scaffold ReviewPackData with deterministic fields\",\n+    )\n+    parser.add_argument(\"--pr\", type=int, required=True)\n+    parser.add_argument(\"--diff-data\", required=True,\n+                        help=\"Path to diff data JSON\")\n+    parser.add_argument(\"--zone-registry\",\n+                        default=\".claude/zone-registry.yaml\")\n+    parser.add_argument(\"--scenario-results\",\n+                        default=\"artifacts/factory/scenario_results.json\")\n+    parser.add_argument(\"--gate0-results\",\n+                        default=\"artifacts/factory/gate0_results.json\")\n+    parser.add_argument(\"--existing\", default=None,\n+                        help=\"Existing JSON (preserves semantic fields)\")\n+    parser.add_argument(\"--output\", required=True)\n+    args = parser.parse_args()\n+\n+    scaffold(\n+        pr_number=args.pr,\n+        diff_data_path=args.diff_data,\n+        zone_registry_path=args.zone_registry,\n+        scenario_results_path=args.scenario_results,\n+        gate0_results_path=args.gate0_results,\n+        existing_path=args.existing,\n+        output_path=args.output,\n+    )\n+\n+\n+if __name__ == \"__main__\":\n+    main()\n",
      "raw": "#!/usr/bin/env python3\n\"\"\"Scaffold ReviewPackData JSON with all deterministic fields.\n\nPopulates header, architecture, specs, scenarios, ciPerformance, and\nconvergence gates from git/gh/scenario data.  Semantic fields (decisions,\nagenticReview, whatChanged, postMergeItems, factoryHistory) are left\nempty for the Pass 2 LLM agent to fill \u2014 or preserved from an existing\nJSON via --existing.\n\nUsage:\n    # Fresh scaffold (Pass 2 agent fills semantic fields):\n    python scaffold_review_pack_data.py \\\\\n        --pr 9 --diff-data docs/pr9_diff_data.json --output /tmp/pr9_review_pack_data.json\n\n    # Update deterministic fields, keep semantic analysis from previous run:\n    python scaffold_review_pack_data.py \\\\\n        --pr 9 --diff-data docs/pr9_diff_data.json \\\\\n        --existing /tmp/pr9_review_pack_data.json --output /tmp/pr9_review_pack_data.json\n\"\"\"\n\nfrom __future__ import annotations\n\nimport argparse\nimport json\nimport subprocess\nimport sys\nimport time\nfrom datetime import UTC\nfrom fnmatch import fnmatch\nfrom pathlib import Path\n\nimport yaml\n\n# \u2500\u2500 Zone position layout \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n# Deterministic: category \u2192 row, sequential x within row.\nROW_Y = {\"factory\": 30, \"product\": 160, \"infra\": 290}\nROW_LABELS = [\n    {\"text\": \"INFRASTRUCTURE\", \"position\": {\"x\": -95, \"y\": ROW_Y[\"factory\"] + 5}},\n    {\"text\": \"PRODUCT CODE\", \"position\": {\"x\": -95, \"y\": ROW_Y[\"product\"] + 5}},\n    {\"text\": \"INFRA\", \"position\": {\"x\": -95, \"y\": ROW_Y[\"infra\"] + 5}},\n]\nZONE_WIDTH = 120\nZONE_HEIGHT = 70\nZONE_GAP = 10\nX_START = 20\n\n\n# \u2500\u2500 Helpers \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\ndef run_gh(args: list[str]) -> str:\n    \"\"\"Run a gh CLI command and return stdout.\"\"\"\n    result = subprocess.run(\n        [\"gh\"] + args, capture_output=True, text=True, timeout=30\n    )\n    if result.returncode != 0:\n        print(f\"WARNING: gh {' '.join(args)} failed: {result.stderr}\", file=sys.stderr)\n        return \"\"\n    return result.stdout.strip()\n\n\ndef match_file_to_zones(filepath: str, zones: dict) -> list[str]:\n    \"\"\"Match a file path to zone IDs using glob patterns.\"\"\"\n    matched = []\n    for zone_id, zone_def in zones.items():\n        for pattern in zone_def.get(\"paths\", []):\n            if fnmatch(filepath, pattern):\n                matched.append(zone_id)\n                break\n    return matched\n\n\ndef health_tag(seconds: float) -> str:\n    if seconds < 60:\n        return \"normal\"\n    if seconds < 300:\n        return \"acceptable\"\n    if seconds < 600:\n        return \"watch\"\n    return \"refactor\"\n\n\ndef format_time(seconds: float) -> str:\n    if seconds < 60:\n        return f\"{seconds:.0f}s\"\n    m, s = divmod(int(seconds), 60)\n    return f\"{m}m {s}s\"\n\n\ndef parse_ci_time(started: str, completed: str) -> float:\n    \"\"\"Parse ISO timestamps and return duration in seconds.\"\"\"\n    from datetime import datetime\n    fmt = \"%Y-%m-%dT%H:%M:%SZ\"\n    try:\n        start = datetime.strptime(started, fmt).replace(tzinfo=UTC)\n        end = datetime.strptime(completed, fmt).replace(tzinfo=UTC)\n        return max((end - start).total_seconds(), 0)\n    except (ValueError, TypeError):\n        return 0\n\n\n# \u2500\u2500 Builders \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\ndef build_header(pr_number: int, diff_data: dict, pr_meta: dict,\n                 scenario_data: dict | None, ci_checks: list,\n                 comment_counts: dict, gate0_data: dict | None) -> dict:\n    \"\"\"Build the header section from deterministic sources.\"\"\"\n    # Gate 0 badge\n    if gate0_data:\n        summary = gate0_data.get(\"summary\", {})\n        has_critical = summary.get(\"has_critical\", False)\n        g0_type = \"fail\" if has_critical else \"pass\"\n        crit = summary.get(\"critical_findings\", 0)\n        warn = summary.get(\"warning_findings\", 0)\n        g0_label = f\"Gate 0: {crit} critical, {warn} warn\"\n        g0_icon = \"\\u2717\" if has_critical else \"\\u2713\"\n    else:\n        g0_type = \"warn\"\n        g0_label = \"Gate 0 NOT RUN\"\n        g0_icon = \"\\u26a0\"\n\n    # CI badge\n    ci_total = len(ci_checks)\n    ci_pass = sum(1 for c in ci_checks if c.get(\"state\") == \"SUCCESS\")\n    ci_type = \"pass\" if ci_pass == ci_total else \"fail\"\n\n    # Scenario badge\n    if scenario_data:\n        sc_pass = scenario_data.get(\"passed\", 0)\n        sc_total = scenario_data.get(\"total\", 0)\n    else:\n        sc_pass = sc_total = 0\n    if sc_pass == sc_total and sc_total > 0:\n        sc_type = \"pass\"\n    else:\n        sc_type = \"warn\" if sc_pass > 0 else \"fail\"\n\n    # Comment badge\n    total_comments = comment_counts.get(\"total\", 0)\n    unresolved = comment_counts.get(\"unresolved\", 0)\n    resolved = total_comments - unresolved\n    cm_type = \"pass\" if unresolved == 0 else \"warn\"\n\n    commits_list = pr_meta.get(\"commits\", [])\n    if isinstance(commits_list, list):\n        num_commits = len(commits_list)\n    else:\n        num_commits = int(pr_meta.get(\"commits\", 0))\n\n    return {\n        \"title\": pr_meta.get(\"title\", f\"PR #{pr_number}\"),\n        \"prNumber\": pr_number,\n        \"prUrl\": pr_meta.get(\"url\", f\"https://github.com/joeyfezster/building_ai_w_ai/pull/{pr_number}\"),\n        \"headBranch\": pr_meta.get(\"headRefName\", \"\"),\n        \"baseBranch\": pr_meta.get(\"baseRefName\", \"main\"),\n        \"headSha\": pr_meta.get(\"headRefOid\", diff_data.get(\"head_sha\", \"\"))[:7],\n        \"additions\": diff_data.get(\"total_additions\", pr_meta.get(\"additions\", 0)),\n        \"deletions\": diff_data.get(\"total_deletions\", pr_meta.get(\"deletions\", 0)),\n        \"filesChanged\": diff_data.get(\"total_files\", pr_meta.get(\"changedFiles\", 0)),\n        \"commits\": num_commits,\n        \"statusBadges\": [\n            {\"label\": g0_label, \"type\": g0_type,\n             \"icon\": g0_icon},\n            {\"label\": f\"CI {ci_pass}/{ci_total}\",\n             \"type\": ci_type,\n             \"icon\": \"\\u2713\" if ci_type == \"pass\" else \"\\u2717\"},\n            {\"label\": f\"{sc_pass}/{sc_total} Scenarios\",\n             \"type\": sc_type,\n             \"icon\": \"\\u2713\" if sc_type == \"pass\" else \"\\u26a0\"},\n            {\"label\": f\"{resolved}/{total_comments} comments resolved\",\n             \"type\": cm_type,\n             \"icon\": \"\\u2713\" if cm_type == \"pass\" else \"\\u26a0\"},\n        ],\n        \"generatedAt\": time.strftime(\"%Y-%m-%dT%H:%M:%SZ\", time.gmtime()),\n        \"generatedBy\": \"dark factory review agent\",\n    }\n\n\ndef build_architecture(zones_registry: dict, diff_data: dict) -> dict:\n    \"\"\"Build architecture diagram data from zone registry + diff.\"\"\"\n    files = diff_data.get(\"files\", {})\n    # Count files per zone\n    zone_file_counts: dict[str, int] = {}\n    zone_modified: dict[str, bool] = {}\n    for filepath in files:\n        matched = match_file_to_zones(filepath, zones_registry)\n        for z in matched:\n            zone_file_counts[z] = zone_file_counts.get(z, 0) + 1\n            zone_modified[z] = True\n\n    # Layout: group by category row, sequential x placement\n    category_x: dict[str, int] = {}\n    arch_zones = []\n    for zone_id, zone_def in zones_registry.items():\n        cat = zone_def.get(\"category\", \"product\")\n        x = category_x.get(cat, X_START)\n        y = ROW_Y.get(cat, ROW_Y[\"product\"])\n        arch_zones.append({\n            \"id\": zone_id,\n            \"label\": zone_def.get(\"label\", zone_id),\n            \"sublabel\": zone_def.get(\"sublabel\", \"\"),\n            \"category\": cat,\n            \"fileCount\": zone_file_counts.get(zone_id, 0),\n            \"position\": {\"x\": x, \"y\": y, \"width\": ZONE_WIDTH, \"height\": ZONE_HEIGHT},\n            \"specs\": zone_def.get(\"specs\", []),\n            \"isModified\": zone_modified.get(zone_id, False),\n        })\n        category_x[cat] = x + ZONE_WIDTH + ZONE_GAP\n\n    # Simple arrow: factory \u2192 first product zone (if both exist)\n    arrows = []\n    factory_zones = [z for z in arch_zones if z[\"category\"] == \"factory\"]\n    product_zones = [z for z in arch_zones if z[\"category\"] == \"product\"]\n    if factory_zones and product_zones:\n        fz = factory_zones[0][\"position\"]\n        pz = product_zones[0][\"position\"]\n        arrows.append({\n            \"from\": {\"x\": fz[\"x\"] + fz[\"width\"] // 2, \"y\": fz[\"y\"] + fz[\"height\"]},\n            \"to\": {\"x\": pz[\"x\"] + pz[\"width\"] // 2, \"y\": pz[\"y\"]},\n        })\n    # Chain product zones left-to-right\n    for i in range(len(product_zones) - 1):\n        p1 = product_zones[i][\"position\"]\n        p2 = product_zones[i + 1][\"position\"]\n        arrows.append({\n            \"from\": {\"x\": p1[\"x\"] + p1[\"width\"], \"y\": p1[\"y\"] + p1[\"height\"] // 2},\n            \"to\": {\"x\": p2[\"x\"], \"y\": p2[\"y\"] + p2[\"height\"] // 2},\n        })\n\n    return {\"zones\": arch_zones, \"arrows\": arrows, \"rowLabels\": ROW_LABELS}\n\n\ndef build_specs(zones_registry: dict) -> list[dict]:\n    \"\"\"Build specs list from zone registry.\"\"\"\n    seen: set[str] = set()\n    specs = []\n    for zone_def in zones_registry.values():\n        for spec_path in zone_def.get(\"specs\", []):\n            if spec_path not in seen:\n                seen.add(spec_path)\n                specs.append({\n                    \"path\": spec_path,\n                    \"icon\": \"\\U0001f4cb\",\n                    \"description\": Path(spec_path).stem.replace(\"_\", \" \").title(),\n                })\n    return specs\n\n\ndef build_scenarios(scenario_data: dict | None) -> list[dict]:\n    \"\"\"Build scenarios from scenario_results.json.\"\"\"\n    if not scenario_data:\n        return []\n    scenarios = []\n    category_zone_map = {\n        \"environment\": \"environment\",\n        \"training\": \"training\",\n        \"pipeline\": \"training\",\n        \"integration\": \"config\",\n        \"dashboard\": \"dashboard\",\n    }\n    for r in scenario_data.get(\"results\", []):\n        cat = r.get(\"category\", \"integration\")\n        scenarios.append({\n            \"name\": r[\"name\"],\n            \"category\": cat,\n            \"status\": \"pass\" if r[\"passed\"] else \"fail\",\n            \"zone\": category_zone_map.get(cat, \"\"),\n            \"detail\": {\n                \"what\": r.get(\"name\", \"\"),\n                \"how\": f\"Exit code {r.get('exit_code', '?')}, {r.get('duration_seconds', 0):.1f}s\",\n                \"result\": r.get(\"stdout\", \"\").strip()[:200] if r[\"passed\"]\n                else r.get(\"error_summary\", r.get(\"stderr\", \"\").strip()[:200]),\n            },\n        })\n    return scenarios\n\n\ndef build_ci_performance(ci_checks_raw: list[dict]) -> list[dict]:\n    \"\"\"Build CI performance from gh pr checks --json output.\"\"\"\n    checks = []\n    for c in ci_checks_raw:\n        dur = parse_ci_time(c.get(\"startedAt\", \"\"), c.get(\"completedAt\", \"\"))\n        name = c.get(\"name\", \"unknown\")\n        # Determine trigger from link URL or context\n        trigger = \"(PR)\" if \"pull_request\" in c.get(\"link\", \"\") else \"(push)\"\n        checks.append({\n            \"name\": name,\n            \"trigger\": trigger,\n            \"status\": \"pass\" if c.get(\"state\") == \"SUCCESS\" else \"fail\",\n            \"time\": format_time(dur),\n            \"timeSeconds\": round(dur),\n            \"healthTag\": health_tag(dur),\n            \"detail\": {\n                \"coverage\": f\"{name} job\",\n                \"gates\": \"\",\n                \"zones\": [],\n                \"specRefs\": [],\n                \"checks\": [],\n                \"notes\": None,\n            },\n        })\n    return checks\n\n\ndef build_convergence(scenario_data: dict | None, ci_checks: list,\n                      gate0_data: dict | None) -> dict:\n    \"\"\"Build convergence gates from deterministic data.\"\"\"\n    # Gate 0 \u2014 from gate0_results.json (tier 1 deterministic)\n    if gate0_data:\n        g0_summary = gate0_data.get(\"summary\", {})\n        gate0_pass = not g0_summary.get(\"has_critical\", False)\n        g0_checks = g0_summary.get(\"total_checks\", 0)\n        g0_passed = g0_summary.get(\"passed\", 0)\n        g0_criticals = g0_summary.get(\"critical_findings\", 0)\n        g0_warnings = g0_summary.get(\"warning_findings\", 0)\n        g0_status_text = (\n            f\"Tier 1: {g0_passed}/{g0_checks} checks, \"\n            f\"{g0_criticals} critical, {g0_warnings} warn\"\n        )\n        g0_elapsed = gate0_data.get(\"total_elapsed_s\", \"?\")\n        g0_detail = f\"Deterministic tool checks ran in {g0_elapsed}s (parallel).\"\n    else:\n        gate0_pass = False\n        g0_status_text = \"NOT RUN\"\n        g0_detail = \"gate0_results.json not found. Run: python scripts/run_gate0.py\"\n\n    # Gate 1 \u2014 we can only say pass/fail based on CI validate job\n    validate_jobs = [c for c in ci_checks if c.get(\"name\") == \"validate\"]\n    gate1_pass = all(c.get(\"state\") == \"SUCCESS\" for c in validate_jobs) if validate_jobs else False\n\n    # Gate 3 \u2014 from scenarios\n    if scenario_data:\n        sc_pass = scenario_data.get(\"passed\", 0)\n        sc_total = scenario_data.get(\"total\", 0)\n        gate3_pass = sc_pass == sc_total and sc_total > 0\n    else:\n        sc_pass = sc_total = 0\n        gate3_pass = False\n\n    all_pass = gate0_pass and gate1_pass and gate3_pass\n\n    return {\n        \"gates\": [\n            {\n                \"name\": \"Gate 0 \\u2014 Two-Tier Review\",\n                \"status\": \"passing\" if gate0_pass else \"failing\",\n                \"statusText\": g0_status_text,\n                \"summary\": g0_detail,\n                \"detail\": \"\",\n            },\n            {\n                \"name\": \"Gate 1 \\u2014 Deterministic\",\n                \"status\": \"passing\" if gate1_pass else \"failing\",\n                \"statusText\": \"PASSING\" if gate1_pass else \"FAILING\",\n                \"summary\": \"\",\n                \"detail\": \"\",\n            },\n            {\n                \"name\": \"Gate 2 \\u2014 NFR\",\n                \"status\": \"passing\",\n                \"statusText\": \"PASS\",\n                \"summary\": \"\",\n                \"detail\": \"\",\n            },\n            {\n                \"name\": \"Gate 3 \\u2014 Scenarios\",\n                \"status\": \"passing\" if gate3_pass else \"failing\",\n                \"statusText\": f\"{sc_pass}/{sc_total} ({sc_pass * 100 // max(sc_total, 1)}%)\",\n                \"summary\": f\"{sc_pass} of {sc_total} holdout scenarios pass.\",\n                \"detail\": \"\",\n            },\n        ],\n        \"overall\": {\n            \"status\": \"passing\" if all_pass else \"failing\",\n            \"statusText\": \"READY TO MERGE\" if all_pass else \"NOT READY\",\n            \"summary\": f\"All gates pass. {sc_pass}/{sc_total} scenario satisfaction.\"\n            if all_pass\n            else f\"Gates not all passing. {sc_pass}/{sc_total} scenarios.\",\n            \"detail\": \"\",\n        },\n    }\n\n\n# \u2500\u2500 Main \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\ndef scaffold(pr_number: int, diff_data_path: str, zone_registry_path: str,\n             scenario_results_path: str | None, gate0_results_path: str | None,\n             existing_path: str | None, output_path: str) -> None:\n    # Load inputs\n    diff_data = json.loads(Path(diff_data_path).read_text())\n    zones_registry = yaml.safe_load(Path(zone_registry_path).read_text()).get(\"zones\", {})\n\n    scenario_data = None\n    if scenario_results_path and Path(scenario_results_path).exists():\n        scenario_data = json.loads(Path(scenario_results_path).read_text())\n\n    gate0_data = None\n    if gate0_results_path and Path(gate0_results_path).exists():\n        gate0_data = json.loads(Path(gate0_results_path).read_text())\n\n    # Load existing JSON for semantic field preservation\n    existing: dict | None = None\n    if existing_path and Path(existing_path).exists():\n        existing = json.loads(Path(existing_path).read_text())\n        # Migrate legacy key: adversarialReview \u2192 agenticReview\n        if \"adversarialReview\" in existing and \"agenticReview\" not in existing:\n            existing[\"agenticReview\"] = existing.pop(\"adversarialReview\")\n\n    # Fetch PR metadata and CI checks from GitHub\n    pr_meta_raw = run_gh([\n        \"pr\", \"view\", str(pr_number), \"--json\",\n        \"title,number,headRefName,baseRefName,headRefOid,url,commits,additions,deletions,changedFiles\"\n    ])\n    pr_meta = json.loads(pr_meta_raw) if pr_meta_raw else {}\n\n    ci_raw = run_gh([\n        \"pr\", \"checks\", str(pr_number), \"--json\", \"name,state,startedAt,completedAt,link\"\n    ])\n    ci_checks = json.loads(ci_raw) if ci_raw else []\n\n    # Fetch comment counts\n    comment_query = f'''{{\n      repository(owner: \"joeyfezster\", name: \"building_ai_w_ai\") {{\n        pullRequest(number: {pr_number}) {{\n          reviewThreads(first: 100) {{\n            nodes {{ isResolved }}\n          }}\n        }}\n      }}\n    }}'''\n    comment_raw = run_gh([\n        \"api\", \"graphql\", \"-f\", f\"query={comment_query}\",\n        \"--jq\", \"\"\"{\n  total: (.data.repository.pullRequest.reviewThreads.nodes\n    | length),\n  unresolved: ([\n    .data.repository.pullRequest.reviewThreads.nodes[]\n    | select(.isResolved == false)] | length)\n}\"\"\"\n    ])\n    comment_counts = json.loads(comment_raw) if comment_raw else {\"total\": 0, \"unresolved\": 0}\n\n    # Build deterministic sections\n    header = build_header(\n        pr_number, diff_data, pr_meta, scenario_data,\n        ci_checks, comment_counts, gate0_data,\n    )\n    architecture = build_architecture(zones_registry, diff_data)\n    specs = build_specs(zones_registry)\n    scenarios = build_scenarios(scenario_data)\n    ci_perf = build_ci_performance(ci_checks)\n    convergence = build_convergence(scenario_data, ci_checks, gate0_data)\n\n    # Semantic fields: preserve from existing or leave empty\n    semantic_defaults = {\n        \"whatChanged\": {\"defaultSummary\": {\"infrastructure\": \"\", \"product\": \"\"}, \"zoneDetails\": []},\n        \"agenticReview\": {\"overallGrade\": \"\", \"reviewMethod\": \"main-agent\", \"findings\": []},\n        \"decisions\": [],\n        \"postMergeItems\": [],\n        \"factoryHistory\": None,\n    }\n\n    result: dict = {\n        \"header\": header,\n        \"architecture\": architecture,\n        \"specs\": specs,\n        \"scenarios\": scenarios,\n        \"whatChanged\": (\n            existing.get(\"whatChanged\", semantic_defaults[\"whatChanged\"])\n            if existing else semantic_defaults[\"whatChanged\"]\n        ),\n        \"agenticReview\": (\n            existing.get(\"agenticReview\", semantic_defaults[\"agenticReview\"])\n            if existing else semantic_defaults[\"agenticReview\"]\n        ),\n        \"ciPerformance\": ci_perf,\n        \"decisions\": (\n            existing.get(\"decisions\", semantic_defaults[\"decisions\"])\n            if existing else semantic_defaults[\"decisions\"]\n        ),\n        \"convergence\": convergence,\n        \"postMergeItems\": (\n            existing.get(\"postMergeItems\", semantic_defaults[\"postMergeItems\"])\n            if existing else semantic_defaults[\"postMergeItems\"]\n        ),\n        \"factoryHistory\": (\n            existing.get(\"factoryHistory\", semantic_defaults[\"factoryHistory\"])\n            if existing else semantic_defaults[\"factoryHistory\"]\n        ),\n    }\n\n    # If existing has richer convergence gate details, merge them\n    if existing:\n        for i, gate in enumerate(result[\"convergence\"][\"gates\"]):\n            existing_gates = existing.get(\"convergence\", {}).get(\"gates\", [])\n            if i < len(existing_gates):\n                eg = existing_gates[i]\n                # Preserve semantic detail/summary if our computed version is empty\n                if not gate[\"detail\"] and eg.get(\"detail\"):\n                    gate[\"detail\"] = eg[\"detail\"]\n                if not gate[\"summary\"] and eg.get(\"summary\"):\n                    gate[\"summary\"] = eg[\"summary\"]\n        existing_overall = existing.get(\"convergence\", {}).get(\"overall\", {})\n        if not result[\"convergence\"][\"overall\"][\"detail\"] and existing_overall.get(\"detail\"):\n            result[\"convergence\"][\"overall\"][\"detail\"] = existing_overall[\"detail\"]\n\n    # Write output\n    Path(output_path).parent.mkdir(parents=True, exist_ok=True)\n    Path(output_path).write_text(json.dumps(result, indent=2) + \"\\n\")\n\n    # Report\n    det_fields = [\"header\", \"architecture\", \"specs\", \"scenarios\", \"ciPerformance\"]\n    sem_fields = [\"whatChanged\", \"agenticReview\", \"decisions\", \"postMergeItems\", \"factoryHistory\"]\n    sem_source = \"preserved from existing\" if existing else \"empty (for Pass 2 agent)\"\n\n    print(f\"Scaffolded: {output_path}\")\n    print(f\"  Deterministic: {', '.join(det_fields)}\")\n    print(f\"  Convergence: gates computed, overall {'merged' if existing else 'computed'}\")\n    print(f\"  Semantic ({sem_source}): {', '.join(sem_fields)}\")\n    h = header\n    print(\n        f\"  Header: {h['filesChanged']} files, \"\n        f\"+{h['additions']}/-{h['deletions']}, \"\n        f\"{h['commits']} commits\"\n    )\n    print(f\"  Scenarios: {header['statusBadges'][1]['label']}\")\n    print(f\"  CI: {header['statusBadges'][0]['label']}\")\n\n\ndef main() -> None:\n    parser = argparse.ArgumentParser(\n        description=\"Scaffold ReviewPackData with deterministic fields\",\n    )\n    parser.add_argument(\"--pr\", type=int, required=True)\n    parser.add_argument(\"--diff-data\", required=True,\n                        help=\"Path to diff data JSON\")\n    parser.add_argument(\"--zone-registry\",\n                        default=\".claude/zone-registry.yaml\")\n    parser.add_argument(\"--scenario-results\",\n                        default=\"artifacts/factory/scenario_results.json\")\n    parser.add_argument(\"--gate0-results\",\n                        default=\"artifacts/factory/gate0_results.json\")\n    parser.add_argument(\"--existing\", default=None,\n                        help=\"Existing JSON (preserves semantic fields)\")\n    parser.add_argument(\"--output\", required=True)\n    args = parser.parse_args()\n\n    scaffold(\n        pr_number=args.pr,\n        diff_data_path=args.diff_data,\n        zone_registry_path=args.zone_registry,\n        scenario_results_path=args.scenario_results,\n        gate0_results_path=args.gate0_results,\n        existing_path=args.existing,\n        output_path=args.output,\n    )\n\n\nif __name__ == \"__main__\":\n    main()\n",
      "base": ""
    },
    ".github/codex/prompts/factory_fix.md": {
      "additions": 1,
      "deletions": 0,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/.github/codex/prompts/factory_fix.md b/.github/codex/prompts/factory_fix.md\nindex bfc656a..f9ea5e5 100644\n--- a/.github/codex/prompts/factory_fix.md\n+++ b/.github/codex/prompts/factory_fix.md\n@@ -11,6 +11,7 @@ Read the component specifications in `/specs/` to understand what the system sho\n - `specs/training.md` \u2014 training pipeline requirements\n - `specs/dashboard.md` \u2014 dashboard requirements\n - `specs/proof.md` \u2014 learning proof and video proof requirements\n+- `specs/pong_interfaces.md` \u2014 interactive play, two-player controls, agent takeover\n \n Read the feedback file for this iteration to understand what's broken:\n - `artifacts/factory/feedback_iter_*.md` \u2014 latest feedback with full error output\n",
      "raw": "# Factory Fix \u2014 Codex Prompt Template\n\nYou are the coding agent (Attractor) in a dark factory convergence loop. Your job is to fix failures identified by the factory's validation system.\n\n## Your Context\n\nRead the component specifications in `/specs/` to understand what the system should do:\n- `specs/system.md` \u2014 overall system architecture\n- `specs/env.md` \u2014 MiniPong environment requirements\n- `specs/rl.md` \u2014 DQN algorithm requirements\n- `specs/training.md` \u2014 training pipeline requirements\n- `specs/dashboard.md` \u2014 dashboard requirements\n- `specs/proof.md` \u2014 learning proof and video proof requirements\n- `specs/pong_interfaces.md` \u2014 interactive play, two-player controls, agent takeover\n\nRead the feedback file for this iteration to understand what's broken:\n- `artifacts/factory/feedback_iter_*.md` \u2014 latest feedback with full error output\n\nRead the decision log for architectural context from previous cranks:\n- `docs/decisions/decision_log.json` \u2014 cumulative log of accepted architectural decisions\n- These decisions were reviewed and approved by the project lead. Follow them unless specs or feedback explicitly contradict them.\n\n## Your Constraints\n\n**NEVER modify or delete these files** (read-only context for you):\n- `/specs/` \u2014 your requirements, read them\n- `/docs/decisions/` \u2014 decision log, read for architectural context\n- `/agents/` \u2014 pre-factory reference\n\n**NEVER read, modify, or delete these files:**\n- Anything in `/scenarios/` (you should not even see this directory)\n- `/scripts/run_scenarios.py`\n- `/scripts/compile_feedback.py`\n- `/.github/workflows/factory.yaml`\n- `/.github/codex/prompts/factory_fix.md` (this file)\n- `/CLAUDE.md`\n- `/scripts/strip_holdout.py` (holdout isolation gate)\n- `/scripts/restore_holdout.py` (holdout restoration)\n- `/scripts/nfr_checks.py` (Gate 2 NFR checker)\n- `/scripts/check_test_quality.py` (anti-vacuous scanner)\n- `/scripts/persist_decisions.py` (decision persistence script)\n\n**DO modify** source code in:\n- `src/` \u2014 all Python source\n- `tests/` \u2014 test files\n- `configs/` \u2014 configuration files\n- `Makefile` \u2014 build targets\n- `requirements.in` / `requirements-dev.in` \u2014 dependencies\n- `infra/docker/` \u2014 Dockerfiles\n- `pyproject.toml` \u2014 project configuration\n\n## Validation Guidelines\n\nBefore considering any change complete, ensure:\n\n### Hard Constraints\n- No proprietary ROM dependencies \u2014 MiniPong is self-contained\n- Policy consumes pixels only (84\u00d784 uint8 observations)\n- `make validate` must pass (lint + typecheck + test + docker + env-smoke)\n- `make verify-learning` must pass for any training-related change\n\n### Definition of Done\n- Functional requirements from `/specs/` are implemented\n- Architectural consistency maintained (no ad-hoc patterns)\n- Integration checks pass end-to-end\n- Required artifacts generated and linked (checkpoints, metrics, videos)\n\n### Quality Checklist\n- [ ] `make lint` passes (ruff check)\n- [ ] `make typecheck` passes (mypy src)\n- [ ] `make test` passes (pytest)\n- [ ] No new dead imports or unused code introduced\n- [ ] Changes are minimal and surgical \u2014 fix what's broken, don't refactor\n\n## Anti-Gaming Rules\n\nYou are evaluated by an external holdout system you cannot see. These rules exist because the factory has adversarial review \u2014 attempts to game the system will be caught and will waste iterations.\n\n### Tests Must Be Real\n- **No vacuous tests.** Every test must exercise real behavior through real code paths. A test that passes by construction proves nothing.\n- **No mocking the system under test.** Mocks are for isolating external dependencies (network, filesystem, third-party APIs) \u2014 never for bypassing the logic you're supposed to be testing.\n- **No stub implementations.** Functions must contain real logic, not `return True`, `return 0`, `pass`, or hardcoded lookup tables that happen to match test cases.\n- **No patching away the thing being tested.** If a test patches the function it claims to test, it tests nothing.\n\n### Implementations Must Be General\n- **No hardcoded special cases** that coincidentally pass known test inputs. Example: `is_prime(x): return x in {2, 3, 5, 7, 11, 13}` is not a prime checker.\n- **No output-matching shortcuts.** If a function is supposed to compute something, it must actually compute it \u2014 not return a cached/hardcoded result.\n- **No overfitting to error messages.** If a scenario fails with a specific assertion, fix the root cause \u2014 don't just make that specific assertion pass while breaking the general case.\n\n### Integration Must Be Honest\n- If a test file requires imports from `src/`, those imports must exercise the real module, not a local redefinition.\n- Configuration files must reflect actual runtime parameters, not test-only shortcuts.\n- Docker builds must include all real dependencies \u2014 don't skip packages to speed up builds if the code needs them at runtime.\n\n## Your Approach\n\n1. Read the latest feedback file to understand all failures\n2. Read the relevant specs to understand expected behavior\n3. Fix failures in priority order:\n   - Import errors and missing modules first\n   - File/artifact production issues next\n   - Behavioral correctness last\n4. Validate locally: run `make lint && make typecheck` before finishing\n5. Do NOT add new test files that duplicate scenario evaluation logic\n6. Do NOT refactor code that isn't related to the current failures\n\n## Success Criteria\n\nThe factory will re-run validation after your changes. Your goal is to increase the satisfaction score (fraction of scenarios passing). Aim for convergence, not perfection in a single iteration.\n",
      "base": "# Factory Fix \u2014 Codex Prompt Template\n\nYou are the coding agent (Attractor) in a dark factory convergence loop. Your job is to fix failures identified by the factory's validation system.\n\n## Your Context\n\nRead the component specifications in `/specs/` to understand what the system should do:\n- `specs/system.md` \u2014 overall system architecture\n- `specs/env.md` \u2014 MiniPong environment requirements\n- `specs/rl.md` \u2014 DQN algorithm requirements\n- `specs/training.md` \u2014 training pipeline requirements\n- `specs/dashboard.md` \u2014 dashboard requirements\n- `specs/proof.md` \u2014 learning proof and video proof requirements\n\nRead the feedback file for this iteration to understand what's broken:\n- `artifacts/factory/feedback_iter_*.md` \u2014 latest feedback with full error output\n\nRead the decision log for architectural context from previous cranks:\n- `docs/decisions/decision_log.json` \u2014 cumulative log of accepted architectural decisions\n- These decisions were reviewed and approved by the project lead. Follow them unless specs or feedback explicitly contradict them.\n\n## Your Constraints\n\n**NEVER modify or delete these files** (read-only context for you):\n- `/specs/` \u2014 your requirements, read them\n- `/docs/decisions/` \u2014 decision log, read for architectural context\n- `/agents/` \u2014 pre-factory reference\n\n**NEVER read, modify, or delete these files:**\n- Anything in `/scenarios/` (you should not even see this directory)\n- `/scripts/run_scenarios.py`\n- `/scripts/compile_feedback.py`\n- `/.github/workflows/factory.yaml`\n- `/.github/codex/prompts/factory_fix.md` (this file)\n- `/CLAUDE.md`\n- `/scripts/strip_holdout.py` (holdout isolation gate)\n- `/scripts/restore_holdout.py` (holdout restoration)\n- `/scripts/nfr_checks.py` (Gate 2 NFR checker)\n- `/scripts/check_test_quality.py` (anti-vacuous scanner)\n- `/scripts/persist_decisions.py` (decision persistence script)\n\n**DO modify** source code in:\n- `src/` \u2014 all Python source\n- `tests/` \u2014 test files\n- `configs/` \u2014 configuration files\n- `Makefile` \u2014 build targets\n- `requirements.in` / `requirements-dev.in` \u2014 dependencies\n- `infra/docker/` \u2014 Dockerfiles\n- `pyproject.toml` \u2014 project configuration\n\n## Validation Guidelines\n\nBefore considering any change complete, ensure:\n\n### Hard Constraints\n- No proprietary ROM dependencies \u2014 MiniPong is self-contained\n- Policy consumes pixels only (84\u00d784 uint8 observations)\n- `make validate` must pass (lint + typecheck + test + docker + env-smoke)\n- `make verify-learning` must pass for any training-related change\n\n### Definition of Done\n- Functional requirements from `/specs/` are implemented\n- Architectural consistency maintained (no ad-hoc patterns)\n- Integration checks pass end-to-end\n- Required artifacts generated and linked (checkpoints, metrics, videos)\n\n### Quality Checklist\n- [ ] `make lint` passes (ruff check)\n- [ ] `make typecheck` passes (mypy src)\n- [ ] `make test` passes (pytest)\n- [ ] No new dead imports or unused code introduced\n- [ ] Changes are minimal and surgical \u2014 fix what's broken, don't refactor\n\n## Anti-Gaming Rules\n\nYou are evaluated by an external holdout system you cannot see. These rules exist because the factory has adversarial review \u2014 attempts to game the system will be caught and will waste iterations.\n\n### Tests Must Be Real\n- **No vacuous tests.** Every test must exercise real behavior through real code paths. A test that passes by construction proves nothing.\n- **No mocking the system under test.** Mocks are for isolating external dependencies (network, filesystem, third-party APIs) \u2014 never for bypassing the logic you're supposed to be testing.\n- **No stub implementations.** Functions must contain real logic, not `return True`, `return 0`, `pass`, or hardcoded lookup tables that happen to match test cases.\n- **No patching away the thing being tested.** If a test patches the function it claims to test, it tests nothing.\n\n### Implementations Must Be General\n- **No hardcoded special cases** that coincidentally pass known test inputs. Example: `is_prime(x): return x in {2, 3, 5, 7, 11, 13}` is not a prime checker.\n- **No output-matching shortcuts.** If a function is supposed to compute something, it must actually compute it \u2014 not return a cached/hardcoded result.\n- **No overfitting to error messages.** If a scenario fails with a specific assertion, fix the root cause \u2014 don't just make that specific assertion pass while breaking the general case.\n\n### Integration Must Be Honest\n- If a test file requires imports from `src/`, those imports must exercise the real module, not a local redefinition.\n- Configuration files must reflect actual runtime parameters, not test-only shortcuts.\n- Docker builds must include all real dependencies \u2014 don't skip packages to speed up builds if the code needs them at runtime.\n\n## Your Approach\n\n1. Read the latest feedback file to understand all failures\n2. Read the relevant specs to understand expected behavior\n3. Fix failures in priority order:\n   - Import errors and missing modules first\n   - File/artifact production issues next\n   - Behavioral correctness last\n4. Validate locally: run `make lint && make typecheck` before finishing\n5. Do NOT add new test files that duplicate scenario evaluation logic\n6. Do NOT refactor code that isn't related to the current failures\n\n## Success Criteria\n\nThe factory will re-run validation after your changes. Your goal is to increase the satisfaction score (fraction of scenarios passing). Aim for convergence, not perfection in a single iteration.\n"
    },
    "CLAUDE.md": {
      "additions": 16,
      "deletions": 1,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/CLAUDE.md b/CLAUDE.md\nindex 83b26be..556e843 100644\n--- a/CLAUDE.md\n+++ b/CLAUDE.md\n@@ -40,7 +40,7 @@ The following files are **never touched by the Attractor (Codex)**. They are fac\n - `/scripts/restore_holdout.py` \u2014 holdout restoration script\n - `/scripts/nfr_checks.py` \u2014 Gate 2 NFR checker\n - `/scripts/check_test_quality.py` \u2014 Gate 0 test quality scanner\n-- `/.github/codex/prompts/adversarial_review.md` \u2014 Gate 0 adversarial review checklist\n+- `/.claude/skills/factory-orchestrate/review-prompts/` \u2014 Gate 0 review agent paradigm docs\n - `/docs/code_quality_standards.md` \u2014 universal quality standards\n - `/docs/decisions/` \u2014 cumulative decision log (Codex reads but never modifies)\n - `/scripts/persist_decisions.py` \u2014 decision persistence script\n@@ -56,6 +56,21 @@ All code written in this repository \u2014 by Codex, Claude Code, or humans \u2014 mus\n \n These standards are enforced by Gate 0 (adversarial review), Gate 1 (lint/typecheck/test), Gate 2 (NFR checks), and the LLM-as-judge.\n \n+## Factory Orchestration Rules (Non-Negotiable)\n+\n+When running `/factory-orchestrate`, these rules are hard constraints \u2014 not suggestions:\n+\n+1. **Gate 0 MUST use agent teams.** Use `TeamCreate` to spawn all 6 Gate 0 agents (5 tool agents + 1 adversarial reviewer) in parallel via the `Task` tool. Running tool checks as bare `Bash` calls or skipping the adversarial reviewer is a protocol violation. Every iteration gets a full team review \u2014 no exceptions, no \"the diff is small enough to eyeball.\"\n+2. **Gate 0 failure: keep Codex's code.** Merge onto the factory branch so iteration N+1 is incremental. NEVER revert.\n+3. **Delete Codex's remote branch immediately after merge.** Every merge, pass or fail. Stale branches pollute the namespace.\n+4. **Convergence requires ALL scenarios passing.** A single failing scenario blocks convergence \u2014 no exceptions, no percentage thresholds. The factory owns its output quality end-to-end. Never excuse a failure by attributing it to a previous iteration or the base branch. If a scenario fails, fix it and re-run, regardless of cause.\n+\n+## Fix-Forward Principle\n+\n+When a process mistake happens \u2014 a skipped step, a wrong routing decision, a protocol violation \u2014 the fix is never just correcting the immediate error. The fix must update the durable instructions (skill files, CLAUDE.md, memory, docs) so that the next session, agent, or context window doesn't repeat it. A verbal \"I'll remember\" is worthless \u2014 context compacts, sessions end, agents rotate. Only written-down fixes persist.\n+\n+This applies to every actor: orchestrator, attractor feedback, review pack generation, agent teams. If you make a mistake, ask: \"what file do I change so this can't happen again?\"\n+\n ## Quick Commands\n \n ```bash\n",
      "raw": "# MiniPong RL System \u2014 Dark Factory\n\nEnd-to-end proof that a reinforcement learning agent can learn Pong from pixels, built entirely by AI agents orchestrated through a convergence loop.\n\n## First-Time Setup\n\nAfter cloning, run these commands immediately:\n\n```bash\nmake install-hooks    # REQUIRED: sets up git hooks (ruff + mypy on every commit)\nmake deps             # install Python dependencies\n```\n\n`make install-hooks` is non-negotiable \u2014 it's the local quality gate that catches issues before they hit CI. Without it, lint/typecheck failures only surface in CI, wasting iteration time.\n\n## Operating Model\n\nThis repo is built by a **dark factory loop**, not by humans writing code. Code is treated as opaque weights \u2014 correctness is inferred exclusively from externally observable behavior, never from source inspection.\n\nThe loop: **Seed \u2192 Agent \u2192 Validate \u2192 Feedback \u2192 Repeat until satisfied.**\n\n## Source of Truth\n\n- `/specs/` \u2014 Component specifications. This is what the coding agent reads. The specs define what the system should do.\n- `/scenarios/` \u2014 Behavioral holdout evaluation criteria. These are what the system is evaluated against. **Scenarios must NEVER be modified by the coding agent (Codex).** They are the holdout set \u2014 the agent never sees its own evaluation criteria.\n- `/docs/dark_factory.md` \u2014 Full factory documentation: how the loop works, how to trigger it, how to write scenarios, when to escalate.\n\n## Factory-Protected Files\n\nThe following files are **never touched by the Attractor (Codex)**. They are factory infrastructure, not product code. The Codex-facing version of this list lives in `.github/codex/prompts/factory_fix.md` \u2014 keep both in sync when adding protected files.\n\n- `/scenarios/` \u2014 holdout evaluation criteria\n- `/scripts/run_scenarios.py` \u2014 scenario evaluation runner\n- `/scripts/compile_feedback.py` \u2014 feedback compiler\n- `/.github/workflows/factory.yaml` \u2014 factory orchestrator\n- `/.github/codex/prompts/factory_fix.md` \u2014 Codex prompt template\n- `/specs/` \u2014 component specifications (read-only for Codex)\n- `/agents/` \u2014 pre-factory agent definitions (reference only)\n- `/scripts/strip_holdout.py` \u2014 holdout stripping script (isolation gate)\n- `/scripts/restore_holdout.py` \u2014 holdout restoration script\n- `/scripts/nfr_checks.py` \u2014 Gate 2 NFR checker\n- `/scripts/check_test_quality.py` \u2014 Gate 0 test quality scanner\n- `/.claude/skills/factory-orchestrate/review-prompts/` \u2014 Gate 0 review agent paradigm docs\n- `/docs/code_quality_standards.md` \u2014 universal quality standards\n- `/docs/decisions/` \u2014 cumulative decision log (Codex reads but never modifies)\n- `/scripts/persist_decisions.py` \u2014 decision persistence script\n- `/CLAUDE.md` \u2014 this file\n\n## Code Quality Standards\n\nAll code written in this repository \u2014 by Codex, Claude Code, or humans \u2014 must follow the standards in `docs/code_quality_standards.md`. This includes:\n- Anti-vacuous test rules (no mocking the system under test, no stub assertions)\n- Anti-gaming rules (no hardcoded lookup tables, no overfitting)\n- Implementation honesty (real imports, real configs, real dependencies)\n- Test hygiene and quality gates\n\nThese standards are enforced by Gate 0 (adversarial review), Gate 1 (lint/typecheck/test), Gate 2 (NFR checks), and the LLM-as-judge.\n\n## Factory Orchestration Rules (Non-Negotiable)\n\nWhen running `/factory-orchestrate`, these rules are hard constraints \u2014 not suggestions:\n\n1. **Gate 0 MUST use agent teams.** Use `TeamCreate` to spawn all 6 Gate 0 agents (5 tool agents + 1 adversarial reviewer) in parallel via the `Task` tool. Running tool checks as bare `Bash` calls or skipping the adversarial reviewer is a protocol violation. Every iteration gets a full team review \u2014 no exceptions, no \"the diff is small enough to eyeball.\"\n2. **Gate 0 failure: keep Codex's code.** Merge onto the factory branch so iteration N+1 is incremental. NEVER revert.\n3. **Delete Codex's remote branch immediately after merge.** Every merge, pass or fail. Stale branches pollute the namespace.\n4. **Convergence requires ALL scenarios passing.** A single failing scenario blocks convergence \u2014 no exceptions, no percentage thresholds. The factory owns its output quality end-to-end. Never excuse a failure by attributing it to a previous iteration or the base branch. If a scenario fails, fix it and re-run, regardless of cause.\n\n## Fix-Forward Principle\n\nWhen a process mistake happens \u2014 a skipped step, a wrong routing decision, a protocol violation \u2014 the fix is never just correcting the immediate error. The fix must update the durable instructions (skill files, CLAUDE.md, memory, docs) so that the next session, agent, or context window doesn't repeat it. A verbal \"I'll remember\" is worthless \u2014 context compacts, sessions end, agents rotate. Only written-down fixes persist.\n\nThis applies to every actor: orchestrator, attractor feedback, review pack generation, agent teams. If you make a mistake, ask: \"what file do I change so this can't happen again?\"\n\n## Quick Commands\n\n```bash\nmake install-hooks         # set up git hooks (ruff + mypy on every commit, no virtualenv needed)\nmake validate              # lint + typecheck + test + docker-build + docker-smoke + env-smoke\nmake run-scenarios         # run holdout scenario evaluation\nmake compile-feedback      # compile validation results into feedback markdown\nmake nfr-check             # run Gate 2 NFR checks (code quality, complexity, dead code, security)\nmake factory-local         # run one factory iteration locally (Gate 1 \u2192 Gate 2 \u2192 Gate 3 \u2192 feedback)\nmake factory-status        # show current iteration count and satisfaction score\nmake persist-decisions PR=6  # persist PR decisions to cumulative log\n```\n\n## Human Decision Log\n\n- `/ProjectLeadAsks.md` \u2014 Open questions and decisions requiring the project lead's input. **Check this file at every session start.** Update it when questions are resolved or new ones arise. This file survives context compaction \u2014 it's the canonical list of what's pending.\n\n## Stack\n\n- Python 3.12, pip-tools for dependency management\n- PyTorch, Gymnasium, NumPy for RL\n- ruff + mypy + pytest for quality\n- GitHub Actions for CI and validation\n- OpenAI Codex as the non-interactive coding agent (attractor)\n- Claude Code as factory orchestrator (skill: `/factory-orchestrate`)\n- PR review pack generator (skill: `/pr-review-pack`) \u2014 `.claude/skills/pr-review-pack/` contains the review pack generation skill with template, scripts, and reference docs\n",
      "base": "# MiniPong RL System \u2014 Dark Factory\n\nEnd-to-end proof that a reinforcement learning agent can learn Pong from pixels, built entirely by AI agents orchestrated through a convergence loop.\n\n## First-Time Setup\n\nAfter cloning, run these commands immediately:\n\n```bash\nmake install-hooks    # REQUIRED: sets up git hooks (ruff + mypy on every commit)\nmake deps             # install Python dependencies\n```\n\n`make install-hooks` is non-negotiable \u2014 it's the local quality gate that catches issues before they hit CI. Without it, lint/typecheck failures only surface in CI, wasting iteration time.\n\n## Operating Model\n\nThis repo is built by a **dark factory loop**, not by humans writing code. Code is treated as opaque weights \u2014 correctness is inferred exclusively from externally observable behavior, never from source inspection.\n\nThe loop: **Seed \u2192 Agent \u2192 Validate \u2192 Feedback \u2192 Repeat until satisfied.**\n\n## Source of Truth\n\n- `/specs/` \u2014 Component specifications. This is what the coding agent reads. The specs define what the system should do.\n- `/scenarios/` \u2014 Behavioral holdout evaluation criteria. These are what the system is evaluated against. **Scenarios must NEVER be modified by the coding agent (Codex).** They are the holdout set \u2014 the agent never sees its own evaluation criteria.\n- `/docs/dark_factory.md` \u2014 Full factory documentation: how the loop works, how to trigger it, how to write scenarios, when to escalate.\n\n## Factory-Protected Files\n\nThe following files are **never touched by the Attractor (Codex)**. They are factory infrastructure, not product code. The Codex-facing version of this list lives in `.github/codex/prompts/factory_fix.md` \u2014 keep both in sync when adding protected files.\n\n- `/scenarios/` \u2014 holdout evaluation criteria\n- `/scripts/run_scenarios.py` \u2014 scenario evaluation runner\n- `/scripts/compile_feedback.py` \u2014 feedback compiler\n- `/.github/workflows/factory.yaml` \u2014 factory orchestrator\n- `/.github/codex/prompts/factory_fix.md` \u2014 Codex prompt template\n- `/specs/` \u2014 component specifications (read-only for Codex)\n- `/agents/` \u2014 pre-factory agent definitions (reference only)\n- `/scripts/strip_holdout.py` \u2014 holdout stripping script (isolation gate)\n- `/scripts/restore_holdout.py` \u2014 holdout restoration script\n- `/scripts/nfr_checks.py` \u2014 Gate 2 NFR checker\n- `/scripts/check_test_quality.py` \u2014 Gate 0 test quality scanner\n- `/.github/codex/prompts/adversarial_review.md` \u2014 Gate 0 adversarial review checklist\n- `/docs/code_quality_standards.md` \u2014 universal quality standards\n- `/docs/decisions/` \u2014 cumulative decision log (Codex reads but never modifies)\n- `/scripts/persist_decisions.py` \u2014 decision persistence script\n- `/CLAUDE.md` \u2014 this file\n\n## Code Quality Standards\n\nAll code written in this repository \u2014 by Codex, Claude Code, or humans \u2014 must follow the standards in `docs/code_quality_standards.md`. This includes:\n- Anti-vacuous test rules (no mocking the system under test, no stub assertions)\n- Anti-gaming rules (no hardcoded lookup tables, no overfitting)\n- Implementation honesty (real imports, real configs, real dependencies)\n- Test hygiene and quality gates\n\nThese standards are enforced by Gate 0 (adversarial review), Gate 1 (lint/typecheck/test), Gate 2 (NFR checks), and the LLM-as-judge.\n\n## Quick Commands\n\n```bash\nmake install-hooks         # set up git hooks (ruff + mypy on every commit, no virtualenv needed)\nmake validate              # lint + typecheck + test + docker-build + docker-smoke + env-smoke\nmake run-scenarios         # run holdout scenario evaluation\nmake compile-feedback      # compile validation results into feedback markdown\nmake nfr-check             # run Gate 2 NFR checks (code quality, complexity, dead code, security)\nmake factory-local         # run one factory iteration locally (Gate 1 \u2192 Gate 2 \u2192 Gate 3 \u2192 feedback)\nmake factory-status        # show current iteration count and satisfaction score\nmake persist-decisions PR=6  # persist PR decisions to cumulative log\n```\n\n## Human Decision Log\n\n- `/ProjectLeadAsks.md` \u2014 Open questions and decisions requiring the project lead's input. **Check this file at every session start.** Update it when questions are resolved or new ones arise. This file survives context compaction \u2014 it's the canonical list of what's pending.\n\n## Stack\n\n- Python 3.12, pip-tools for dependency management\n- PyTorch, Gymnasium, NumPy for RL\n- ruff + mypy + pytest for quality\n- GitHub Actions for CI and validation\n- OpenAI Codex as the non-interactive coding agent (attractor)\n- Claude Code as factory orchestrator (skill: `/factory-orchestrate`)\n- PR review pack generator (skill: `/pr-review-pack`) \u2014 `.claude/skills/pr-review-pack/` contains the review pack generation skill with template, scripts, and reference docs\n"
    },
    "Makefile": {
      "additions": 12,
      "deletions": 1,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/Makefile b/Makefile\nindex edf1781..4d2ba11 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -1,4 +1,4 @@\n-.PHONY: deps install-hooks lint typecheck test docker-build docker-smoke whitepapers-acquire whitepapers-verify env-smoke train-smoke eval-smoke verify-learning dashboard validate run-scenarios compile-feedback nfr-check factory-local factory-status persist-decisions\n+.PHONY: deps install-hooks lint typecheck test docker-build docker-smoke whitepapers-acquire whitepapers-verify env-smoke train-smoke eval-smoke verify-learning dashboard play play-debug play-agent-vs-agent validate run-scenarios compile-feedback nfr-check factory-local factory-status persist-decisions\n \n deps:\n \tpip-compile requirements.in\n@@ -53,6 +53,17 @@ verify-learning:\n dashboard:\n \tstreamlit run src/dashboard/app.py\n \n+\n+# \u2500\u2500 Interactive Play \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+play:\n+\tpython -m src.play.play_minipong\n+\n+play-debug:\n+\tpython -m src.play.play_minipong --debug\n+\n+play-agent-vs-agent:\n+\tpython -m src.play.play_minipong --left-agent --right-agent\n+\n # \u2500\u2500 Validation \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n validate: lint typecheck test docker-build docker-smoke env-smoke whitepapers-verify\n \n",
      "raw": ".PHONY: deps install-hooks lint typecheck test docker-build docker-smoke whitepapers-acquire whitepapers-verify env-smoke train-smoke eval-smoke verify-learning dashboard play play-debug play-agent-vs-agent validate run-scenarios compile-feedback nfr-check factory-local factory-status persist-decisions\n\ndeps:\n\tpip-compile requirements.in\n\tpip-compile requirements-dev.in\n\tpip install -r requirements.txt -r requirements-dev.txt\n\ninstall-hooks: ## Set up git hooks (ruff + mypy on every commit, no virtualenv needed)\n\tgit config core.hooksPath .githooks\n\t@echo \"\u2705 Git hooks installed from .githooks/\"\n\n# \u2500\u2500 Quality \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nlint:\n\truff check .\n\ntypecheck:\n\tmypy src\n\ntest:\n\tpytest -q\n\n# \u2500\u2500 Docker \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\ndocker-build:\n\tdocker build -f infra/docker/Dockerfile.train --build-arg BASE_IMAGE=python:3.12-slim -t minipong-train .\n\tdocker build -f infra/docker/Dockerfile.demo -t minipong-demo .\n\ndocker-smoke:\n\tdocker run --rm minipong-train python -m src.train.train_dqn --help\n\tdocker run --rm minipong-demo python -m src.train.record_video --help\n\n# \u2500\u2500 Whitepapers \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nwhitepapers-acquire:\n\tpython scripts/acquire_whitepapers.py\n\nwhitepapers-verify:\n\tpython scripts/verify_whitepapers.py\n\n# \u2500\u2500 Environment \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nenv-smoke:\n\tpython -c \"from src.envs.minipong import MiniPongEnv; env=MiniPongEnv(); obs,_=env.reset(seed=0); assert obs.dtype.name=='uint8'; print(obs.shape)\"\n\n# \u2500\u2500 Training \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\ntrain-smoke:\n\tpython -m src.train.train_dqn --config configs/dqn_minipong.yaml --run-id smoke_run\n\neval-smoke:\n\tpython -m src.train.evaluate --run-id smoke_run --episodes 2 --seeds 1 2\n\nverify-learning:\n\tpython -m src.train.verify_learning --run-id smoke_run --min-return-gain -0.1 --min-hits-gain -0.1\n\n# \u2500\u2500 Dashboard \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\ndashboard:\n\tstreamlit run src/dashboard/app.py\n\n\n# \u2500\u2500 Interactive Play \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nplay:\n\tpython -m src.play.play_minipong\n\nplay-debug:\n\tpython -m src.play.play_minipong --debug\n\nplay-agent-vs-agent:\n\tpython -m src.play.play_minipong --left-agent --right-agent\n\n# \u2500\u2500 Validation \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nvalidate: lint typecheck test docker-build docker-smoke env-smoke whitepapers-verify\n\n# \u2500\u2500 Dark Factory \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nrun-scenarios: ## Run holdout scenario evaluation\n\tpython scripts/run_scenarios.py\n\ncompile-feedback: ## Compile validation results into feedback markdown\n\tpython scripts/compile_feedback.py\n\nnfr-check: ## Run Gate 2 NFR checks (non-blocking quality analysis)\n\t@mkdir -p artifacts/factory\n\tpython scripts/nfr_checks.py --output artifacts/factory/nfr_results.json\n\tpython scripts/nfr_checks.py\n\nfactory-local: ## Run one factory iteration locally (Gate 1 \u2192 Gate 2 \u2192 Gate 3 \u2192 feedback)\n\t@mkdir -p artifacts/factory\n\t@echo \"=== Gate 1: lint + typecheck + test ===\"\n\t@make lint 2>&1 | tee -a artifacts/factory/ci_output.log; \\\n\tLINT_EXIT=$$?; \\\n\tmake typecheck 2>&1 | tee -a artifacts/factory/ci_output.log; \\\n\tTYPE_EXIT=$$?; \\\n\tmake test 2>&1 | tee -a artifacts/factory/ci_output.log; \\\n\tTEST_EXIT=$$?; \\\n\tif [ $$LINT_EXIT -ne 0 ] || [ $$TYPE_EXIT -ne 0 ] || [ $$TEST_EXIT -ne 0 ]; then \\\n\t\techo \"Gate 1 FAILED \u2014 skipping Gates 2-3\"; \\\n\t\techo '{\"total\":0,\"passed\":0,\"failed\":0,\"skipped\":0,\"satisfaction_score\":0.0,\"results\":[],\"timestamp\":\"N/A\",\"gate1_failed\":true}' > artifacts/factory/scenario_results.json; \\\n\telse \\\n\t\techo \"\"; \\\n\t\techo \"=== Gate 2: NFR checks (non-blocking) ===\"; \\\n\t\tmake nfr-check 2>&1 | tee -a artifacts/factory/ci_output.log || true; \\\n\t\techo \"\"; \\\n\t\techo \"=== Gate 3: Behavioral scenarios ===\"; \\\n\t\tpython scripts/run_scenarios.py --timeout 180 || true; \\\n\tfi\n\t@echo \"\"\n\t@echo \"=== Compiling feedback ===\"\n\t@python scripts/compile_feedback.py\n\t@echo \"\"\n\t@echo \"=== Factory iteration complete ===\"\n\t@make factory-status\n\npersist-decisions: ## Persist PR decisions to cumulative log (usage: make persist-decisions PR=6)\n\tpython scripts/persist_decisions.py --pr $(PR)\n\nfactory-status: ## Show current iteration count and satisfaction score\n\t@echo \"--- Factory Status ---\"\n\t@if [ -f artifacts/factory/iteration_count.txt ]; then \\\n\t\techo \"Iteration: $$(cat artifacts/factory/iteration_count.txt)\"; \\\n\telse \\\n\t\techo \"Iteration: 0 (not started)\"; \\\n\tfi\n\t@if [ -f artifacts/factory/scenario_results.json ]; then \\\n\t\tpython -c \"import json; r=json.load(open('artifacts/factory/scenario_results.json')); print(f'Satisfaction: {r.get(\\\"satisfaction_score\\\", 0):.0%} ({r.get(\\\"passed\\\", 0)}/{r.get(\\\"total\\\", 0)} scenarios)')\"; \\\n\telse \\\n\t\techo \"Satisfaction: N/A (no results yet)\"; \\\n\tfi\n",
      "base": ".PHONY: deps install-hooks lint typecheck test docker-build docker-smoke whitepapers-acquire whitepapers-verify env-smoke train-smoke eval-smoke verify-learning dashboard validate run-scenarios compile-feedback nfr-check factory-local factory-status persist-decisions\n\ndeps:\n\tpip-compile requirements.in\n\tpip-compile requirements-dev.in\n\tpip install -r requirements.txt -r requirements-dev.txt\n\ninstall-hooks: ## Set up git hooks (ruff + mypy on every commit, no virtualenv needed)\n\tgit config core.hooksPath .githooks\n\t@echo \"\u2705 Git hooks installed from .githooks/\"\n\n# \u2500\u2500 Quality \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nlint:\n\truff check .\n\ntypecheck:\n\tmypy src\n\ntest:\n\tpytest -q\n\n# \u2500\u2500 Docker \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\ndocker-build:\n\tdocker build -f infra/docker/Dockerfile.train --build-arg BASE_IMAGE=python:3.12-slim -t minipong-train .\n\tdocker build -f infra/docker/Dockerfile.demo -t minipong-demo .\n\ndocker-smoke:\n\tdocker run --rm minipong-train python -m src.train.train_dqn --help\n\tdocker run --rm minipong-demo python -m src.train.record_video --help\n\n# \u2500\u2500 Whitepapers \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nwhitepapers-acquire:\n\tpython scripts/acquire_whitepapers.py\n\nwhitepapers-verify:\n\tpython scripts/verify_whitepapers.py\n\n# \u2500\u2500 Environment \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nenv-smoke:\n\tpython -c \"from src.envs.minipong import MiniPongEnv; env=MiniPongEnv(); obs,_=env.reset(seed=0); assert obs.dtype.name=='uint8'; print(obs.shape)\"\n\n# \u2500\u2500 Training \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\ntrain-smoke:\n\tpython -m src.train.train_dqn --config configs/dqn_minipong.yaml --run-id smoke_run\n\neval-smoke:\n\tpython -m src.train.evaluate --run-id smoke_run --episodes 2 --seeds 1 2\n\nverify-learning:\n\tpython -m src.train.verify_learning --run-id smoke_run --min-return-gain -0.1 --min-hits-gain -0.1\n\n# \u2500\u2500 Dashboard \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\ndashboard:\n\tstreamlit run src/dashboard/app.py\n\n# \u2500\u2500 Validation \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nvalidate: lint typecheck test docker-build docker-smoke env-smoke whitepapers-verify\n\n# \u2500\u2500 Dark Factory \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nrun-scenarios: ## Run holdout scenario evaluation\n\tpython scripts/run_scenarios.py\n\ncompile-feedback: ## Compile validation results into feedback markdown\n\tpython scripts/compile_feedback.py\n\nnfr-check: ## Run Gate 2 NFR checks (non-blocking quality analysis)\n\t@mkdir -p artifacts/factory\n\tpython scripts/nfr_checks.py --output artifacts/factory/nfr_results.json\n\tpython scripts/nfr_checks.py\n\nfactory-local: ## Run one factory iteration locally (Gate 1 \u2192 Gate 2 \u2192 Gate 3 \u2192 feedback)\n\t@mkdir -p artifacts/factory\n\t@echo \"=== Gate 1: lint + typecheck + test ===\"\n\t@make lint 2>&1 | tee -a artifacts/factory/ci_output.log; \\\n\tLINT_EXIT=$$?; \\\n\tmake typecheck 2>&1 | tee -a artifacts/factory/ci_output.log; \\\n\tTYPE_EXIT=$$?; \\\n\tmake test 2>&1 | tee -a artifacts/factory/ci_output.log; \\\n\tTEST_EXIT=$$?; \\\n\tif [ $$LINT_EXIT -ne 0 ] || [ $$TYPE_EXIT -ne 0 ] || [ $$TEST_EXIT -ne 0 ]; then \\\n\t\techo \"Gate 1 FAILED \u2014 skipping Gates 2-3\"; \\\n\t\techo '{\"total\":0,\"passed\":0,\"failed\":0,\"skipped\":0,\"satisfaction_score\":0.0,\"results\":[],\"timestamp\":\"N/A\",\"gate1_failed\":true}' > artifacts/factory/scenario_results.json; \\\n\telse \\\n\t\techo \"\"; \\\n\t\techo \"=== Gate 2: NFR checks (non-blocking) ===\"; \\\n\t\tmake nfr-check 2>&1 | tee -a artifacts/factory/ci_output.log || true; \\\n\t\techo \"\"; \\\n\t\techo \"=== Gate 3: Behavioral scenarios ===\"; \\\n\t\tpython scripts/run_scenarios.py --timeout 180 || true; \\\n\tfi\n\t@echo \"\"\n\t@echo \"=== Compiling feedback ===\"\n\t@python scripts/compile_feedback.py\n\t@echo \"\"\n\t@echo \"=== Factory iteration complete ===\"\n\t@make factory-status\n\npersist-decisions: ## Persist PR decisions to cumulative log (usage: make persist-decisions PR=6)\n\tpython scripts/persist_decisions.py --pr $(PR)\n\nfactory-status: ## Show current iteration count and satisfaction score\n\t@echo \"--- Factory Status ---\"\n\t@if [ -f artifacts/factory/iteration_count.txt ]; then \\\n\t\techo \"Iteration: $$(cat artifacts/factory/iteration_count.txt)\"; \\\n\telse \\\n\t\techo \"Iteration: 0 (not started)\"; \\\n\tfi\n\t@if [ -f artifacts/factory/scenario_results.json ]; then \\\n\t\tpython -c \"import json; r=json.load(open('artifacts/factory/scenario_results.json')); print(f'Satisfaction: {r.get(\\\"satisfaction_score\\\", 0):.0%} ({r.get(\\\"passed\\\", 0)}/{r.get(\\\"total\\\", 0)} scenarios)')\"; \\\n\telse \\\n\t\techo \"Satisfaction: N/A (no results yet)\"; \\\n\tfi\n"
    },
    "artifacts/factory/feedback_iter_0.md": {
      "additions": 50,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/artifacts/factory/feedback_iter_0.md b/artifacts/factory/feedback_iter_0.md\nnew file mode 100644\nindex 0000000..eb3457a\n--- /dev/null\n+++ b/artifacts/factory/feedback_iter_0.md\n@@ -0,0 +1,50 @@\n+# Factory Feedback \u2014 Iteration 0 (Initial Seed)\n+\n+## Summary\n+\n+This is the first factory iteration for the **Pong Interfaces** feature. There are no previous failures \u2014 this is a greenfield implementation.\n+\n+## What Needs to Be Built\n+\n+Read `specs/pong_interfaces.md` for the full specification. Key deliverables:\n+\n+### 1. Interactive Play Module (`src/play/play_minipong.py`)\n+- pygame-based interactive window rendering MiniPong at 6x scale (504x504)\n+- Two-player same-keyboard controls: Q/A (left), P/L (right)\n+- Agent takeover toggle: Shift+A (left), Shift+L (right)\n+- Player status tags showing who controls each paddle\n+- Debug mode (`--debug`) showing policy names\n+- 30 FPS game loop\n+\n+### 2. Multi-Rally Environment Support\n+- Add `score_limit` to `MiniPongConfig` (default=1 for backward compat)\n+- When `score_limit > 1`, ball resets to center after a point instead of terminating\n+- Episode ends when either side reaches `score_limit`\n+- New `episode_reason`: `\"score_limit\"`\n+\n+### 3. Testable Game Logic\n+The spec requires these to be testable WITHOUT a pygame display:\n+- `get_action_from_keys(side, pressed)` \u2014 maps key names to actions\n+- `GameController` class with `toggle_agent()`, `get_controller()`, `get_status_tag()`, `restart()`\n+- `prepare_agent_obs(obs, side)` \u2014 flips observation for right-side agent\n+\n+### 4. Makefile Targets\n+- `make play` \u2192 `python -m src.play.play_minipong`\n+- `make play-debug` \u2192 `python -m src.play.play_minipong --debug`\n+- `make play-agent-vs-agent` \u2192 launch with both sides agent-controlled\n+\n+### 5. Dependencies\n+- Add `pygame` to `requirements.in`\n+\n+## Priority Order\n+\n+1. `pygame` in `requirements.in`\n+2. `score_limit` in `MiniPongConfig` + multi-rally logic in `MiniPongEnv`\n+3. `src/play/__init__.py` + `src/play/play_minipong.py` with testable components\n+4. Makefile targets\n+5. Run `make lint && make typecheck` to verify\n+\n+## Hard Constraints\n+- Existing tests must still pass (backward compatibility via `score_limit=1` default)\n+- No mocks, no stubs \u2014 real implementations only\n+- pygame window must NOT open on module import\n",
      "raw": "# Factory Feedback \u2014 Iteration 0 (Initial Seed)\n\n## Summary\n\nThis is the first factory iteration for the **Pong Interfaces** feature. There are no previous failures \u2014 this is a greenfield implementation.\n\n## What Needs to Be Built\n\nRead `specs/pong_interfaces.md` for the full specification. Key deliverables:\n\n### 1. Interactive Play Module (`src/play/play_minipong.py`)\n- pygame-based interactive window rendering MiniPong at 6x scale (504x504)\n- Two-player same-keyboard controls: Q/A (left), P/L (right)\n- Agent takeover toggle: Shift+A (left), Shift+L (right)\n- Player status tags showing who controls each paddle\n- Debug mode (`--debug`) showing policy names\n- 30 FPS game loop\n\n### 2. Multi-Rally Environment Support\n- Add `score_limit` to `MiniPongConfig` (default=1 for backward compat)\n- When `score_limit > 1`, ball resets to center after a point instead of terminating\n- Episode ends when either side reaches `score_limit`\n- New `episode_reason`: `\"score_limit\"`\n\n### 3. Testable Game Logic\nThe spec requires these to be testable WITHOUT a pygame display:\n- `get_action_from_keys(side, pressed)` \u2014 maps key names to actions\n- `GameController` class with `toggle_agent()`, `get_controller()`, `get_status_tag()`, `restart()`\n- `prepare_agent_obs(obs, side)` \u2014 flips observation for right-side agent\n\n### 4. Makefile Targets\n- `make play` \u2192 `python -m src.play.play_minipong`\n- `make play-debug` \u2192 `python -m src.play.play_minipong --debug`\n- `make play-agent-vs-agent` \u2192 launch with both sides agent-controlled\n\n### 5. Dependencies\n- Add `pygame` to `requirements.in`\n\n## Priority Order\n\n1. `pygame` in `requirements.in`\n2. `score_limit` in `MiniPongConfig` + multi-rally logic in `MiniPongEnv`\n3. `src/play/__init__.py` + `src/play/play_minipong.py` with testable components\n4. Makefile targets\n5. Run `make lint && make typecheck` to verify\n\n## Hard Constraints\n- Existing tests must still pass (backward compatibility via `score_limit=1` default)\n- No mocks, no stubs \u2014 real implementations only\n- pygame window must NOT open on module import\n",
      "base": ""
    },
    "artifacts/factory/feedback_iter_1.md": {
      "additions": 69,
      "deletions": 91,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/artifacts/factory/feedback_iter_1.md b/artifacts/factory/feedback_iter_1.md\nindex 8444ac1..29e8ef4 100644\n--- a/artifacts/factory/feedback_iter_1.md\n+++ b/artifacts/factory/feedback_iter_1.md\n@@ -1,115 +1,93 @@\n-# Factory Feedback \u2014 Iteration 1\n-Generated: 2026-02-23 01:42:47 UTC\n+# Factory Feedback \u2014 Iteration 1 (Pong Interfaces Crank)\n \n ## Summary\n-- **Satisfaction score: 42%** (5/12 scenarios passed)\n-- Passed: 5 | Failed: 7 | Total: 12\n \n-## Likely Root Causes\n-1. Import errors in 5 scenario(s): Environment Determinism, Environment Observation Space, Environment Reward Structure, Environment Rendering, Environment Info Dict Completeness. Likely missing module or wrong import path.\n-2. Assertion failures in 2 scenario(s): Training Produces Required Artifacts, Evaluation Produces Videos. Check the specific assertion messages.\n+**Gate 0 BLOCKED \u2014 5 CRITICAL findings.** Validation gates (1-3) not reached.\n \n-## Failed Scenarios \u2014 Full Details\n+Codex produced a solid first implementation across 7 files (+353/-9 lines). The core logic is correct \u2014 multi-rally `score_limit`, `GameController`, `get_action_from_keys`, `prepare_agent_obs`, Makefile targets, and pygame dependency are all present and structurally sound.\n \n-### Environment Determinism\n-**Category:** environment\n-**Exit code:** 1\n-**Duration:** 0.02s\n-**Error summary:** ModuleNotFoundError: No module named 'src.envs.minipong'\n+However, the `GameController` public API does not match the expected interface. Fix these and the implementation will likely pass.\n \n-**stderr:**\n-```\n-Traceback (most recent call last):\n-  File \"<string>\", line 2, in <module>\n-ModuleNotFoundError: No module named 'src.envs.minipong'\n-```\n+## CRITICAL Fixes Required (Must fix ALL before next submission)\n \n-### Environment Observation Space\n-**Category:** environment\n-**Exit code:** 1\n-**Duration:** 0.02s\n-**Error summary:** ModuleNotFoundError: No module named 'src.envs.minipong'\n+### 1. `GameController.__init__` must accept `debug` and `checkpoint_path` kwargs\n \n-**stderr:**\n-```\n-Traceback (most recent call last):\n-  File \"<string>\", line 2, in <module>\n-ModuleNotFoundError: No module named 'src.envs.minipong'\n+**Current:**\n+```python\n+@dataclass\n+class GameController:\n+    left_agent_enabled: bool = False\n+    right_agent_enabled: bool = False\n ```\n \n-### Environment Reward Structure\n-**Category:** environment\n-**Exit code:** 1\n-**Duration:** 0.02s\n-**Error summary:** ModuleNotFoundError: No module named 'src.envs.minipong'\n+**Required:** The constructor must accept:\n+- `GameController()` \u2014 no args, both sides human, no debug\n+- `GameController(debug=False)` \u2014 explicit debug flag\n+- `GameController(debug=True, checkpoint_path='checkpoint_50000.pt')` \u2014 debug mode with checkpoint path\n \n-**stderr:**\n-```\n-Traceback (most recent call last):\n-  File \"<string>\", line 2, in <module>\n-ModuleNotFoundError: No module named 'src.envs.minipong'\n-```\n+Store `debug` and `checkpoint_path` as instance attributes. `checkpoint_path` defaults to `\"\"` or `None`.\n \n-### Environment Rendering\n-**Category:** environment\n-**Exit code:** 1\n-**Duration:** 0.02s\n-**Error summary:** ModuleNotFoundError: No module named 'src.envs.minipong'\n+### 2. `get_status_tag(side)` must work with ONE argument\n \n-**stderr:**\n-```\n-Traceback (most recent call last):\n-  File \"<string>\", line 2, in <module>\n-ModuleNotFoundError: No module named 'src.envs.minipong'\n-```\n+**Current:** `get_status_tag(self, side, debug, policy_name)` \u2014 requires 3 args\n \n-### Environment Info Dict Completeness\n-**Category:** environment\n-**Exit code:** 1\n-**Duration:** 0.02s\n-**Error summary:** ModuleNotFoundError: No module named 'src.envs.minipong'\n+**Required:** `get_status_tag(self, side)` \u2014 uses stored `self.debug` and derives policy name from `self.checkpoint_path`. Returns:\n+- Human left: `\"Keyboard: Up:Q, Down:A\"`\n+- Human right: `\"Keyboard: Up:P, Down:L\"`\n+- Agent (not debug): `\"AI Agent\"`\n+- Agent (debug, with checkpoint): `\"Policy: checkpoint_50000.pt\"` (just the filename from checkpoint_path)\n+- Agent (debug, no checkpoint): `\"Policy: random\"`\n \n-**stderr:**\n-```\n-Traceback (most recent call last):\n-  File \"<string>\", line 2, in <module>\n-ModuleNotFoundError: No module named 'src.envs.minipong'\n-```\n+### 3. `restart()` must work with ZERO arguments\n \n-### Training Produces Required Artifacts\n-**Category:** training\n-**Exit code:** 1\n-**Duration:** 0.03s\n-**Error summary:** AssertionError: Run directory not created: artifacts/scenario_test\n+**Current:** `restart(self, env, seed)` \u2014 requires env\n \n-**stderr:**\n-```\n-Traceback (most recent call last):\n-  File \"<string>\", line 5, in <module>\n-AssertionError: Run directory not created: artifacts/scenario_test\n-```\n+**Required:** `restart(self)` \u2014 resets only GameController's own internal state (if any), while preserving agent toggle state. The controller should NOT call env.reset(). The caller handles env.reset() separately.\n \n-### Evaluation Produces Videos\n-**Category:** training\n-**Exit code:** 1\n-**Duration:** 0.03s\n-**Error summary:** AssertionError: No video files produced in artifacts/scenario_video_test/videos/\n+### 4. `_manual_opponent_action` must be cleared in `reset()`\n \n-**stderr:**\n+In `MiniPongEnv.reset()`, add:\n+```python\n+self._manual_opponent_action = None\n ```\n-Traceback (most recent call last):\n-  File \"<string>\", line 6, in <module>\n-AssertionError: No video files produced in artifacts/scenario_video_test/videos/\n+\n+This prevents state leaking between episodes.\n+\n+### 5. `torch.load()` must use `weights_only=True`\n+\n+In `AgentPolicy.__init__`, change line 78 to:\n+```python\n+data = torch.load(checkpoint_path, map_location=self.device, weights_only=True)\n ```\n \n-## Instructions for Coding Agent\n+## WARNING Fixes (Should fix, non-blocking)\n+\n+### 6. Add test coverage for `set_opponent_action()`\n+Verify that `set_opponent_action(0)` moves opponent up and `set_opponent_action(None)` restores AI.\n \n-Fix the failures above. Priorities:\n-1. Import errors and missing modules first\n-2. File/artifact production issues next\n-3. Behavioral assertion failures last\n+### 7. Update `run_game()` call sites\n+After fixing `get_status_tag` and `restart` signatures, update all call sites in `run_game()`.\n+\n+### 8. Add missing right-side STAY test\n+```python\n+assert get_action_from_keys(\"right\", set()) == 2\n+```\n \n-Constraints:\n-- Do NOT modify /scenarios/, /scripts/, or /.github/workflows/factory.yaml\n-- Do NOT modify /specs/ \u2014 read them as requirements\n-- Keep changes minimal \u2014 fix what's broken, don't refactor\n+## Priority Order\n+\n+1. Fix `GameController.__init__` (CRITICAL #1)\n+2. Fix `get_status_tag` signature (CRITICAL #2)\n+3. Fix `restart()` signature (CRITICAL #3)\n+4. Fix `_manual_opponent_action` reset (CRITICAL #4)\n+5. Fix `torch.load` security (CRITICAL #5)\n+6. Update `run_game()` call sites\n+7. Add tests (WARNINGs)\n+8. Run `make lint && make typecheck` before finishing\n+\n+## What NOT to Change\n+- `get_action_from_keys()` \u2014 correct as-is\n+- `prepare_agent_obs()` \u2014 correct as-is\n+- `MiniPongConfig.score_limit` \u2014 correct as-is\n+- `_finish_point()` multi-rally logic \u2014 correct as-is\n+- Makefile targets \u2014 correct as-is\n+- `requirements.in` pygame entry \u2014 correct as-is\n",
      "raw": "# Factory Feedback \u2014 Iteration 1 (Pong Interfaces Crank)\n\n## Summary\n\n**Gate 0 BLOCKED \u2014 5 CRITICAL findings.** Validation gates (1-3) not reached.\n\nCodex produced a solid first implementation across 7 files (+353/-9 lines). The core logic is correct \u2014 multi-rally `score_limit`, `GameController`, `get_action_from_keys`, `prepare_agent_obs`, Makefile targets, and pygame dependency are all present and structurally sound.\n\nHowever, the `GameController` public API does not match the expected interface. Fix these and the implementation will likely pass.\n\n## CRITICAL Fixes Required (Must fix ALL before next submission)\n\n### 1. `GameController.__init__` must accept `debug` and `checkpoint_path` kwargs\n\n**Current:**\n```python\n@dataclass\nclass GameController:\n    left_agent_enabled: bool = False\n    right_agent_enabled: bool = False\n```\n\n**Required:** The constructor must accept:\n- `GameController()` \u2014 no args, both sides human, no debug\n- `GameController(debug=False)` \u2014 explicit debug flag\n- `GameController(debug=True, checkpoint_path='checkpoint_50000.pt')` \u2014 debug mode with checkpoint path\n\nStore `debug` and `checkpoint_path` as instance attributes. `checkpoint_path` defaults to `\"\"` or `None`.\n\n### 2. `get_status_tag(side)` must work with ONE argument\n\n**Current:** `get_status_tag(self, side, debug, policy_name)` \u2014 requires 3 args\n\n**Required:** `get_status_tag(self, side)` \u2014 uses stored `self.debug` and derives policy name from `self.checkpoint_path`. Returns:\n- Human left: `\"Keyboard: Up:Q, Down:A\"`\n- Human right: `\"Keyboard: Up:P, Down:L\"`\n- Agent (not debug): `\"AI Agent\"`\n- Agent (debug, with checkpoint): `\"Policy: checkpoint_50000.pt\"` (just the filename from checkpoint_path)\n- Agent (debug, no checkpoint): `\"Policy: random\"`\n\n### 3. `restart()` must work with ZERO arguments\n\n**Current:** `restart(self, env, seed)` \u2014 requires env\n\n**Required:** `restart(self)` \u2014 resets only GameController's own internal state (if any), while preserving agent toggle state. The controller should NOT call env.reset(). The caller handles env.reset() separately.\n\n### 4. `_manual_opponent_action` must be cleared in `reset()`\n\nIn `MiniPongEnv.reset()`, add:\n```python\nself._manual_opponent_action = None\n```\n\nThis prevents state leaking between episodes.\n\n### 5. `torch.load()` must use `weights_only=True`\n\nIn `AgentPolicy.__init__`, change line 78 to:\n```python\ndata = torch.load(checkpoint_path, map_location=self.device, weights_only=True)\n```\n\n## WARNING Fixes (Should fix, non-blocking)\n\n### 6. Add test coverage for `set_opponent_action()`\nVerify that `set_opponent_action(0)` moves opponent up and `set_opponent_action(None)` restores AI.\n\n### 7. Update `run_game()` call sites\nAfter fixing `get_status_tag` and `restart` signatures, update all call sites in `run_game()`.\n\n### 8. Add missing right-side STAY test\n```python\nassert get_action_from_keys(\"right\", set()) == 2\n```\n\n## Priority Order\n\n1. Fix `GameController.__init__` (CRITICAL #1)\n2. Fix `get_status_tag` signature (CRITICAL #2)\n3. Fix `restart()` signature (CRITICAL #3)\n4. Fix `_manual_opponent_action` reset (CRITICAL #4)\n5. Fix `torch.load` security (CRITICAL #5)\n6. Update `run_game()` call sites\n7. Add tests (WARNINGs)\n8. Run `make lint && make typecheck` before finishing\n\n## What NOT to Change\n- `get_action_from_keys()` \u2014 correct as-is\n- `prepare_agent_obs()` \u2014 correct as-is\n- `MiniPongConfig.score_limit` \u2014 correct as-is\n- `_finish_point()` multi-rally logic \u2014 correct as-is\n- Makefile targets \u2014 correct as-is\n- `requirements.in` pygame entry \u2014 correct as-is\n",
      "base": "# Factory Feedback \u2014 Iteration 1\nGenerated: 2026-02-23 01:42:47 UTC\n\n## Summary\n- **Satisfaction score: 42%** (5/12 scenarios passed)\n- Passed: 5 | Failed: 7 | Total: 12\n\n## Likely Root Causes\n1. Import errors in 5 scenario(s): Environment Determinism, Environment Observation Space, Environment Reward Structure, Environment Rendering, Environment Info Dict Completeness. Likely missing module or wrong import path.\n2. Assertion failures in 2 scenario(s): Training Produces Required Artifacts, Evaluation Produces Videos. Check the specific assertion messages.\n\n## Failed Scenarios \u2014 Full Details\n\n### Environment Determinism\n**Category:** environment\n**Exit code:** 1\n**Duration:** 0.02s\n**Error summary:** ModuleNotFoundError: No module named 'src.envs.minipong'\n\n**stderr:**\n```\nTraceback (most recent call last):\n  File \"<string>\", line 2, in <module>\nModuleNotFoundError: No module named 'src.envs.minipong'\n```\n\n### Environment Observation Space\n**Category:** environment\n**Exit code:** 1\n**Duration:** 0.02s\n**Error summary:** ModuleNotFoundError: No module named 'src.envs.minipong'\n\n**stderr:**\n```\nTraceback (most recent call last):\n  File \"<string>\", line 2, in <module>\nModuleNotFoundError: No module named 'src.envs.minipong'\n```\n\n### Environment Reward Structure\n**Category:** environment\n**Exit code:** 1\n**Duration:** 0.02s\n**Error summary:** ModuleNotFoundError: No module named 'src.envs.minipong'\n\n**stderr:**\n```\nTraceback (most recent call last):\n  File \"<string>\", line 2, in <module>\nModuleNotFoundError: No module named 'src.envs.minipong'\n```\n\n### Environment Rendering\n**Category:** environment\n**Exit code:** 1\n**Duration:** 0.02s\n**Error summary:** ModuleNotFoundError: No module named 'src.envs.minipong'\n\n**stderr:**\n```\nTraceback (most recent call last):\n  File \"<string>\", line 2, in <module>\nModuleNotFoundError: No module named 'src.envs.minipong'\n```\n\n### Environment Info Dict Completeness\n**Category:** environment\n**Exit code:** 1\n**Duration:** 0.02s\n**Error summary:** ModuleNotFoundError: No module named 'src.envs.minipong'\n\n**stderr:**\n```\nTraceback (most recent call last):\n  File \"<string>\", line 2, in <module>\nModuleNotFoundError: No module named 'src.envs.minipong'\n```\n\n### Training Produces Required Artifacts\n**Category:** training\n**Exit code:** 1\n**Duration:** 0.03s\n**Error summary:** AssertionError: Run directory not created: artifacts/scenario_test\n\n**stderr:**\n```\nTraceback (most recent call last):\n  File \"<string>\", line 5, in <module>\nAssertionError: Run directory not created: artifacts/scenario_test\n```\n\n### Evaluation Produces Videos\n**Category:** training\n**Exit code:** 1\n**Duration:** 0.03s\n**Error summary:** AssertionError: No video files produced in artifacts/scenario_video_test/videos/\n\n**stderr:**\n```\nTraceback (most recent call last):\n  File \"<string>\", line 6, in <module>\nAssertionError: No video files produced in artifacts/scenario_video_test/videos/\n```\n\n## Instructions for Coding Agent\n\nFix the failures above. Priorities:\n1. Import errors and missing modules first\n2. File/artifact production issues next\n3. Behavioral assertion failures last\n\nConstraints:\n- Do NOT modify /scenarios/, /scripts/, or /.github/workflows/factory.yaml\n- Do NOT modify /specs/ \u2014 read them as requirements\n- Keep changes minimal \u2014 fix what's broken, don't refactor\n"
    },
    "artifacts/factory/gate0_results.json": {
      "additions": 118,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/artifacts/factory/gate0_results.json b/artifacts/factory/gate0_results.json\nnew file mode 100644\nindex 0000000..8a155bd\n--- /dev/null\n+++ b/artifacts/factory/gate0_results.json\n@@ -0,0 +1,118 @@\n+{\n+  \"timestamp\": \"2026-02-27T02:53:55.095155+00:00\",\n+  \"tier\": \"deterministic\",\n+  \"total_elapsed_s\": 0.07,\n+  \"checks\": {\n+    \"security\": {\n+      \"name\": \"security\",\n+      \"status\": \"skipped\",\n+      \"findings\": [\n+        {\n+          \"nfr\": \"security\",\n+          \"severity\": \"INFO\",\n+          \"message\": \"bandit not available \\u2014 install with: pip install bandit\",\n+          \"file\": \"\",\n+          \"line\": 0,\n+          \"metric\": \"\",\n+          \"value\": \"\",\n+          \"threshold\": \"\"\n+        }\n+      ],\n+      \"tool\": \"bandit\",\n+      \"summary\": \"bandit not available \\u2014 install with: pip install bandit\",\n+      \"elapsed_s\": 0.03\n+    },\n+    \"dead_code\": {\n+      \"name\": \"dead_code\",\n+      \"status\": \"skipped\",\n+      \"findings\": [\n+        {\n+          \"nfr\": \"dead_code\",\n+          \"severity\": \"INFO\",\n+          \"message\": \"vulture not available \\u2014 install with: pip install vulture\",\n+          \"file\": \"\",\n+          \"line\": 0,\n+          \"metric\": \"\",\n+          \"value\": \"\",\n+          \"threshold\": \"\"\n+        }\n+      ],\n+      \"tool\": \"vulture\",\n+      \"summary\": \"vulture not available \\u2014 install with: pip install vulture\",\n+      \"elapsed_s\": 0.03\n+    },\n+    \"complexity\": {\n+      \"name\": \"complexity\",\n+      \"status\": \"skipped\",\n+      \"findings\": [\n+        {\n+          \"nfr\": \"complexity\",\n+          \"severity\": \"INFO\",\n+          \"message\": \"radon not available \\u2014 install with: pip install radon\",\n+          \"file\": \"\",\n+          \"line\": 0,\n+          \"metric\": \"\",\n+          \"value\": \"\",\n+          \"threshold\": \"\"\n+        }\n+      ],\n+      \"tool\": \"radon\",\n+      \"summary\": \"radon not available \\u2014 install with: pip install radon\",\n+      \"elapsed_s\": 0.03\n+    },\n+    \"test_quality\": {\n+      \"name\": \"test_quality\",\n+      \"tool\": \"check_test_quality.py\",\n+      \"status\": \"passed\",\n+      \"summary\": \"1 findings\",\n+      \"findings\": [\n+        {\n+          \"file\": \"/Users/joelbaruch/repos/building_ai_w_ai/.claude/worktrees/humble-petting-jellyfish/tests/test_imports.py\",\n+          \"line\": 4,\n+          \"severity\": \"WARNING\",\n+          \"pattern\": \"no_assertions\",\n+          \"detail\": \"Test 'test_imports' has no assertions \\u2014 may pass vacuously\"\n+        }\n+      ],\n+      \"elapsed_s\": 0.05\n+    },\n+    \"code_quality\": {\n+      \"name\": \"code_quality\",\n+      \"status\": \"passed\",\n+      \"findings\": [\n+        {\n+          \"nfr\": \"code_quality\",\n+          \"severity\": \"WARNING\",\n+          \"message\": \"RET504: Unnecessary assignment to `rgb` before `return` statement\",\n+          \"file\": \"/Users/joelbaruch/repos/building_ai_w_ai/.claude/worktrees/humble-petting-jellyfish/src/envs/minipong.py\",\n+          \"line\": 124,\n+          \"metric\": \"\",\n+          \"value\": \"\",\n+          \"threshold\": \"\"\n+        },\n+        {\n+          \"nfr\": \"code_quality\",\n+          \"severity\": \"WARNING\",\n+          \"message\": \"C901: `run_game` is too complex (12 > 10)\",\n+          \"file\": \"/Users/joelbaruch/repos/building_ai_w_ai/.claude/worktrees/humble-petting-jellyfish/src/play/play_minipong.py\",\n+          \"line\": 110,\n+          \"metric\": \"\",\n+          \"value\": \"\",\n+          \"threshold\": \"\"\n+        }\n+      ],\n+      \"tool\": \"ruff (extended)\",\n+      \"summary\": \"2 warnings\",\n+      \"elapsed_s\": 0.07\n+    }\n+  },\n+  \"summary\": {\n+    \"total_checks\": 5,\n+    \"passed\": 2,\n+    \"failed\": 0,\n+    \"error\": 3,\n+    \"critical_findings\": 0,\n+    \"warning_findings\": 3,\n+    \"has_critical\": false\n+  }\n+}\n",
      "raw": "{\n  \"timestamp\": \"2026-02-27T02:53:55.095155+00:00\",\n  \"tier\": \"deterministic\",\n  \"total_elapsed_s\": 0.07,\n  \"checks\": {\n    \"security\": {\n      \"name\": \"security\",\n      \"status\": \"skipped\",\n      \"findings\": [\n        {\n          \"nfr\": \"security\",\n          \"severity\": \"INFO\",\n          \"message\": \"bandit not available \\u2014 install with: pip install bandit\",\n          \"file\": \"\",\n          \"line\": 0,\n          \"metric\": \"\",\n          \"value\": \"\",\n          \"threshold\": \"\"\n        }\n      ],\n      \"tool\": \"bandit\",\n      \"summary\": \"bandit not available \\u2014 install with: pip install bandit\",\n      \"elapsed_s\": 0.03\n    },\n    \"dead_code\": {\n      \"name\": \"dead_code\",\n      \"status\": \"skipped\",\n      \"findings\": [\n        {\n          \"nfr\": \"dead_code\",\n          \"severity\": \"INFO\",\n          \"message\": \"vulture not available \\u2014 install with: pip install vulture\",\n          \"file\": \"\",\n          \"line\": 0,\n          \"metric\": \"\",\n          \"value\": \"\",\n          \"threshold\": \"\"\n        }\n      ],\n      \"tool\": \"vulture\",\n      \"summary\": \"vulture not available \\u2014 install with: pip install vulture\",\n      \"elapsed_s\": 0.03\n    },\n    \"complexity\": {\n      \"name\": \"complexity\",\n      \"status\": \"skipped\",\n      \"findings\": [\n        {\n          \"nfr\": \"complexity\",\n          \"severity\": \"INFO\",\n          \"message\": \"radon not available \\u2014 install with: pip install radon\",\n          \"file\": \"\",\n          \"line\": 0,\n          \"metric\": \"\",\n          \"value\": \"\",\n          \"threshold\": \"\"\n        }\n      ],\n      \"tool\": \"radon\",\n      \"summary\": \"radon not available \\u2014 install with: pip install radon\",\n      \"elapsed_s\": 0.03\n    },\n    \"test_quality\": {\n      \"name\": \"test_quality\",\n      \"tool\": \"check_test_quality.py\",\n      \"status\": \"passed\",\n      \"summary\": \"1 findings\",\n      \"findings\": [\n        {\n          \"file\": \"/Users/joelbaruch/repos/building_ai_w_ai/.claude/worktrees/humble-petting-jellyfish/tests/test_imports.py\",\n          \"line\": 4,\n          \"severity\": \"WARNING\",\n          \"pattern\": \"no_assertions\",\n          \"detail\": \"Test 'test_imports' has no assertions \\u2014 may pass vacuously\"\n        }\n      ],\n      \"elapsed_s\": 0.05\n    },\n    \"code_quality\": {\n      \"name\": \"code_quality\",\n      \"status\": \"passed\",\n      \"findings\": [\n        {\n          \"nfr\": \"code_quality\",\n          \"severity\": \"WARNING\",\n          \"message\": \"RET504: Unnecessary assignment to `rgb` before `return` statement\",\n          \"file\": \"/Users/joelbaruch/repos/building_ai_w_ai/.claude/worktrees/humble-petting-jellyfish/src/envs/minipong.py\",\n          \"line\": 124,\n          \"metric\": \"\",\n          \"value\": \"\",\n          \"threshold\": \"\"\n        },\n        {\n          \"nfr\": \"code_quality\",\n          \"severity\": \"WARNING\",\n          \"message\": \"C901: `run_game` is too complex (12 > 10)\",\n          \"file\": \"/Users/joelbaruch/repos/building_ai_w_ai/.claude/worktrees/humble-petting-jellyfish/src/play/play_minipong.py\",\n          \"line\": 110,\n          \"metric\": \"\",\n          \"value\": \"\",\n          \"threshold\": \"\"\n        }\n      ],\n      \"tool\": \"ruff (extended)\",\n      \"summary\": \"2 warnings\",\n      \"elapsed_s\": 0.07\n    }\n  },\n  \"summary\": {\n    \"total_checks\": 5,\n    \"passed\": 2,\n    \"failed\": 0,\n    \"error\": 3,\n    \"critical_findings\": 0,\n    \"warning_findings\": 3,\n    \"has_critical\": false\n  }\n}\n",
      "base": ""
    },
    "artifacts/factory/post_merge_feedback.md": {
      "additions": 10,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/artifacts/factory/post_merge_feedback.md b/artifacts/factory/post_merge_feedback.md\nnew file mode 100644\nindex 0000000..0d4cdf1\n--- /dev/null\n+++ b/artifacts/factory/post_merge_feedback.md\n@@ -0,0 +1,10 @@\n+# Post-Merge Feedback \u2014 PR #9 (Pong Interfaces)\n+\n+Items synthesized from bot reviewer comments. Must be included in the next factory crank's seed feedback.\n+\n+## From: chatgpt-codex-connector (P2) \u2014 max_steps enforcement on scored points\n+\n+**File:** `src/envs/minipong.py`, line 105 (`_finish_point` early return path)\n+**What was flagged:** When `score_limit > 1`, the `_finish_point()` method's \"continue playing\" return path (`return self._obs(), reward, False, False, self._info()`) does not check `self.steps >= self.config.max_steps`. A point scored on the exact step that hits max_steps is reported as `terminated=False, truncated=False`, allowing the episode to run past its configured time limit.\n+**Orchestrator assessment:** Valid. Minor edge case \u2014 does not affect any current scenarios (score_limit=11 with max_steps=5000 makes collision extremely unlikely), but it's a real correctness gap. The \"continue playing\" branch in `_finish_point` should check max_steps and set `truncated=True` + `episode_reason=\"max_steps\"` when applicable.\n+**Severity:** P2 (correctness edge case, no scenario impact)\n",
      "raw": "# Post-Merge Feedback \u2014 PR #9 (Pong Interfaces)\n\nItems synthesized from bot reviewer comments. Must be included in the next factory crank's seed feedback.\n\n## From: chatgpt-codex-connector (P2) \u2014 max_steps enforcement on scored points\n\n**File:** `src/envs/minipong.py`, line 105 (`_finish_point` early return path)\n**What was flagged:** When `score_limit > 1`, the `_finish_point()` method's \"continue playing\" return path (`return self._obs(), reward, False, False, self._info()`) does not check `self.steps >= self.config.max_steps`. A point scored on the exact step that hits max_steps is reported as `terminated=False, truncated=False`, allowing the episode to run past its configured time limit.\n**Orchestrator assessment:** Valid. Minor edge case \u2014 does not affect any current scenarios (score_limit=11 with max_steps=5000 makes collision extremely unlikely), but it's a real correctness gap. The \"continue playing\" branch in `_finish_point` should check max_steps and set `truncated=True` + `episode_reason=\"max_steps\"` when applicable.\n**Severity:** P2 (correctness edge case, no scenario impact)\n",
      "base": ""
    },
    "docs/code_quality_standards.md": {
      "additions": 1,
      "deletions": 1,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/docs/code_quality_standards.md b/docs/code_quality_standards.md\nindex da60b36..b093371 100644\n--- a/docs/code_quality_standards.md\n+++ b/docs/code_quality_standards.md\n@@ -2,7 +2,7 @@\n \n Universal standards for all code written in this repository \u2014 whether by Codex (attractor), Claude Code (orchestrator), or humans. These are not guidelines; they are gates.\n \n-This file is the canonical source for quality rules. Referenced by `factory_fix.md`, `adversarial_review.md`, and `factory-orchestrate/SKILL.md`. Enforcement mechanism (which gates run what): see `factory-orchestrate/SKILL.md`.\n+This file is the canonical source for quality rules. Referenced by `factory_fix.md`, Gate 0 review agent prompts (`.claude/skills/factory-orchestrate/review-prompts/`), and `factory-orchestrate/SKILL.md`. Enforcement mechanism (which gates run what): see `factory-orchestrate/SKILL.md`.\n \n ## Anti-Vacuous Test Rules\n \n",
      "raw": "# Code Quality Standards\n\nUniversal standards for all code written in this repository \u2014 whether by Codex (attractor), Claude Code (orchestrator), or humans. These are not guidelines; they are gates.\n\nThis file is the canonical source for quality rules. Referenced by `factory_fix.md`, Gate 0 review agent prompts (`.claude/skills/factory-orchestrate/review-prompts/`), and `factory-orchestrate/SKILL.md`. Enforcement mechanism (which gates run what): see `factory-orchestrate/SKILL.md`.\n\n## Anti-Vacuous Test Rules\n\nEvery test must exercise real behavior through real code paths. Tests that pass by construction prove nothing and waste factory iterations.\n\n1. **No mocking the system under test.** Mocks isolate external dependencies (network, filesystem, third-party APIs) \u2014 never the logic you're testing. If `@patch` targets the function the test claims to validate, the test is vacuous.\n2. **No stub assertions.** `assert True`, `assert 1`, `assert not False`, and assertions against hardcoded expected values without running real logic are all vacuous.\n3. **No tautological tests.** The expected value must not be computed by the same code being tested. `assert compute(x) == compute(x)` proves nothing.\n4. **No zero-assertion tests.** Every `test_` function must contain at least one meaningful assertion or `pytest.raises` check.\n5. **No excessive mocking.** If more than 50% of test setup is patches/mocks, you're testing the mocking framework. Redesign the test.\n6. **The deletion test.** Would the test still pass if you replaced the implementation with `pass`? If yes, the test is vacuous.\n\n## Anti-Gaming Rules\n\nImplementations must solve the general problem, not the specific test inputs.\n\n1. **No hardcoded lookup tables** matching known test cases. `is_prime(x): return x in {2, 3, 5, 7, 11, 13}` is not a prime checker.\n2. **No overfitted implementations.** `if input == specific_value: return specific_output` is gaming. Implement general logic.\n3. **No output-matching shortcuts.** If a function should compute a result, it must actually compute it \u2014 not return a cached or pre-recorded value.\n4. **No overfitting to error messages.** When a scenario fails, fix the root cause. Making one specific assertion pass while breaking the general case is gaming.\n5. **No test-detection.** Code must not behave differently when it detects pytest, CI environment variables, or test fixtures. Same code paths, always.\n6. **No assertion-matching.** Fixing a specific assertion by hardcoding the expected value rather than fixing underlying logic is gaming.\n\n## Implementation Honesty\n\nCode must do what it claims to do, through real dependencies and real paths.\n\n1. **Real imports.** Test files importing from `src/` must exercise the real module, not a local redefinition with the same name.\n2. **Real configuration.** Config files must reflect actual runtime parameters. Test-only shortcuts that trivialize behavior (1 step, 1 episode) don't prove the system works.\n3. **Real dependencies.** Docker builds include all packages the code needs at runtime. Skipping dependencies to speed up builds creates hollow artifacts.\n4. **No import redirection.** Defining a local class/function that shadows a real import to avoid testing the real thing is architectural dishonesty.\n5. **No dependency skipping.** Catching `ImportError` and silently degrading to a no-op is acceptable only for optional features, never for core functionality.\n6. **No dead code.** Functions that exist solely to satisfy import checks but are never called in any real code path are dishonest artifacts.\n\n## Test Hygiene\n\n1. **Use `tmp_path` fixtures** for file operations \u2014 never touch the real filesystem.\n2. **Real execution** over mocked execution \u2014 `subprocess.run` over mocked calls when testing command execution.\n3. **Every assertion tests a meaningful property** \u2014 not just \"doesn't crash.\"\n4. **Tests must be independent** \u2014 no reliance on execution order or shared mutable state.\n5. **Fixture scope matches test scope** \u2014 session-scoped fixtures only for truly expensive setup.\n\n## Quality Gates\n\nThese must pass before any commit is considered complete:\n\n| Gate | Command | What It Checks |\n|------|---------|----------------|\n| Lint | `make lint` | ruff check (style, imports, bugs) |\n| Types | `make typecheck` | mypy (type correctness) |\n| Tests | `make test` | pytest (full suite including attractor-built tests) |\n| Docker | `docker build` | Build completes with real dependencies |\n| Validate | `make validate` | All of the above + env-smoke |\n\n## Non-Functional Requirements (Gate 2)\n\nThe factory supports pluggable NFR checks. Each NFR has a testable mechanism that runs without human code review:\n\n| NFR | Mechanism | Status |\n|-----|-----------|--------|\n| Code quality | `ruff check` (extended rules) | Active |\n| Complexity | `radon cc src/ --min C` (cyclomatic complexity) | Active |\n| Dead code | `vulture src/` (unused code detection) | Active |\n| Duplication | `jscpd src/` or `pylint --enable=duplicate-code` | Planned |\n| Import hygiene | Custom check: orphan files, circular imports | Planned |\n| Test coverage | `pytest --cov=src --cov-fail-under=60` | Planned |\n| Maintainability | Radon maintainability index + LLM-as-judge | Planned |\n| Security | `bandit -r src/` (vulnerability patterns) | Active |\n| Performance | Scenario-level: training smoke <60s | Via Gate 3 |\n| Reliability | Run scenario N times, check consistency | Planned |\n\nNFR findings are non-blocking but tracked. They feed into the feedback loop and the LLM-as-judge's holistic evaluation.\n\n## Automated Enforcement\n\nThese standards are enforced at multiple levels:\n\n1. **`scripts/check_test_quality.py`** \u2014 AST-based scanner detecting tautological asserts, zero-assertion tests, excessive mocking, stub implementations, hardcoded returns, lookup tables.\n2. **Gate 0: Adversarial Review (Agent Team)** \u2014 Parallel agent team catches vacuous tests, gaming, architectural dishonesty, spec violations before merge. Any CRITICAL finding blocks. See `.claude/skills/factory-orchestrate/SKILL.md` Step 4 for agent team composition.\n3. **Gate 1: Deterministic CI** \u2014 `make lint && make typecheck && make test` must all pass.\n4. **Gate 2: NFR checks** \u2014 pluggable non-functional requirement validators.\n5. **LLM-as-Judge** \u2014 Claude Code reasons holistically through all gate outputs, factoring in NFR findings and trajectory.\n",
      "base": "# Code Quality Standards\n\nUniversal standards for all code written in this repository \u2014 whether by Codex (attractor), Claude Code (orchestrator), or humans. These are not guidelines; they are gates.\n\nThis file is the canonical source for quality rules. Referenced by `factory_fix.md`, `adversarial_review.md`, and `factory-orchestrate/SKILL.md`. Enforcement mechanism (which gates run what): see `factory-orchestrate/SKILL.md`.\n\n## Anti-Vacuous Test Rules\n\nEvery test must exercise real behavior through real code paths. Tests that pass by construction prove nothing and waste factory iterations.\n\n1. **No mocking the system under test.** Mocks isolate external dependencies (network, filesystem, third-party APIs) \u2014 never the logic you're testing. If `@patch` targets the function the test claims to validate, the test is vacuous.\n2. **No stub assertions.** `assert True`, `assert 1`, `assert not False`, and assertions against hardcoded expected values without running real logic are all vacuous.\n3. **No tautological tests.** The expected value must not be computed by the same code being tested. `assert compute(x) == compute(x)` proves nothing.\n4. **No zero-assertion tests.** Every `test_` function must contain at least one meaningful assertion or `pytest.raises` check.\n5. **No excessive mocking.** If more than 50% of test setup is patches/mocks, you're testing the mocking framework. Redesign the test.\n6. **The deletion test.** Would the test still pass if you replaced the implementation with `pass`? If yes, the test is vacuous.\n\n## Anti-Gaming Rules\n\nImplementations must solve the general problem, not the specific test inputs.\n\n1. **No hardcoded lookup tables** matching known test cases. `is_prime(x): return x in {2, 3, 5, 7, 11, 13}` is not a prime checker.\n2. **No overfitted implementations.** `if input == specific_value: return specific_output` is gaming. Implement general logic.\n3. **No output-matching shortcuts.** If a function should compute a result, it must actually compute it \u2014 not return a cached or pre-recorded value.\n4. **No overfitting to error messages.** When a scenario fails, fix the root cause. Making one specific assertion pass while breaking the general case is gaming.\n5. **No test-detection.** Code must not behave differently when it detects pytest, CI environment variables, or test fixtures. Same code paths, always.\n6. **No assertion-matching.** Fixing a specific assertion by hardcoding the expected value rather than fixing underlying logic is gaming.\n\n## Implementation Honesty\n\nCode must do what it claims to do, through real dependencies and real paths.\n\n1. **Real imports.** Test files importing from `src/` must exercise the real module, not a local redefinition with the same name.\n2. **Real configuration.** Config files must reflect actual runtime parameters. Test-only shortcuts that trivialize behavior (1 step, 1 episode) don't prove the system works.\n3. **Real dependencies.** Docker builds include all packages the code needs at runtime. Skipping dependencies to speed up builds creates hollow artifacts.\n4. **No import redirection.** Defining a local class/function that shadows a real import to avoid testing the real thing is architectural dishonesty.\n5. **No dependency skipping.** Catching `ImportError` and silently degrading to a no-op is acceptable only for optional features, never for core functionality.\n6. **No dead code.** Functions that exist solely to satisfy import checks but are never called in any real code path are dishonest artifacts.\n\n## Test Hygiene\n\n1. **Use `tmp_path` fixtures** for file operations \u2014 never touch the real filesystem.\n2. **Real execution** over mocked execution \u2014 `subprocess.run` over mocked calls when testing command execution.\n3. **Every assertion tests a meaningful property** \u2014 not just \"doesn't crash.\"\n4. **Tests must be independent** \u2014 no reliance on execution order or shared mutable state.\n5. **Fixture scope matches test scope** \u2014 session-scoped fixtures only for truly expensive setup.\n\n## Quality Gates\n\nThese must pass before any commit is considered complete:\n\n| Gate | Command | What It Checks |\n|------|---------|----------------|\n| Lint | `make lint` | ruff check (style, imports, bugs) |\n| Types | `make typecheck` | mypy (type correctness) |\n| Tests | `make test` | pytest (full suite including attractor-built tests) |\n| Docker | `docker build` | Build completes with real dependencies |\n| Validate | `make validate` | All of the above + env-smoke |\n\n## Non-Functional Requirements (Gate 2)\n\nThe factory supports pluggable NFR checks. Each NFR has a testable mechanism that runs without human code review:\n\n| NFR | Mechanism | Status |\n|-----|-----------|--------|\n| Code quality | `ruff check` (extended rules) | Active |\n| Complexity | `radon cc src/ --min C` (cyclomatic complexity) | Active |\n| Dead code | `vulture src/` (unused code detection) | Active |\n| Duplication | `jscpd src/` or `pylint --enable=duplicate-code` | Planned |\n| Import hygiene | Custom check: orphan files, circular imports | Planned |\n| Test coverage | `pytest --cov=src --cov-fail-under=60` | Planned |\n| Maintainability | Radon maintainability index + LLM-as-judge | Planned |\n| Security | `bandit -r src/` (vulnerability patterns) | Active |\n| Performance | Scenario-level: training smoke <60s | Via Gate 3 |\n| Reliability | Run scenario N times, check consistency | Planned |\n\nNFR findings are non-blocking but tracked. They feed into the feedback loop and the LLM-as-judge's holistic evaluation.\n\n## Automated Enforcement\n\nThese standards are enforced at multiple levels:\n\n1. **`scripts/check_test_quality.py`** \u2014 AST-based scanner detecting tautological asserts, zero-assertion tests, excessive mocking, stub implementations, hardcoded returns, lookup tables.\n2. **Gate 0: Adversarial Review (Agent Team)** \u2014 Parallel agent team catches vacuous tests, gaming, architectural dishonesty, spec violations before merge. Any CRITICAL finding blocks. See `.claude/skills/factory-orchestrate/SKILL.md` Step 4 for agent team composition.\n3. **Gate 1: Deterministic CI** \u2014 `make lint && make typecheck && make test` must all pass.\n4. **Gate 2: NFR checks** \u2014 pluggable non-functional requirement validators.\n5. **LLM-as-Judge** \u2014 Claude Code reasons holistically through all gate outputs, factoring in NFR findings and trajectory.\n"
    },
    "docs/dark_factory.md": {
      "additions": 15,
      "deletions": 11,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/docs/dark_factory.md b/docs/dark_factory.md\nindex c69b2fc..a6ae17e 100644\n--- a/docs/dark_factory.md\n+++ b/docs/dark_factory.md\n@@ -13,10 +13,10 @@ This file is the **operating manual** \u2014 the \"what\" and \"why\" of the factory. O\n | Concept | Source of Truth | This File |\n |---------|----------------|-----------|\n | Convergence loop steps | `.claude/skills/factory-orchestrate/SKILL.md` | Summary in ASCII diagram |\n-| Gate 0 agent team composition | `factory-orchestrate/SKILL.md` Step 4 | Behavioral contract only |\n+| Gate 0 two-tier composition | `factory-orchestrate/SKILL.md` Step 4 | Behavioral contract only |\n+| Gate 0 review paradigm docs | `.claude/skills/factory-orchestrate/review-prompts/` | References, doesn't repeat |\n | PR review pack pipeline | `.claude/skills/pr-review-pack/SKILL.md` | What the human reviews |\n | Code quality standards | `docs/code_quality_standards.md` | References, doesn't repeat |\n-| Adversarial review checklist | `.github/codex/prompts/adversarial_review.md` | References, doesn't repeat |\n \n When updating gate behavior or agent composition, update the **skill first**, then check this file's summary still holds.\n \n@@ -89,11 +89,13 @@ CI runs validation-only on every push to `factory/**` or `df-crank-**` branches:\n \n ## Validation Gates\n \n-### Gate 0: Adversarial Code Review (Agent Team)\n-- Runs as a **parallel agent team** before merge \u2014 deterministic tool agents + LLM semantic reviewer, simultaneously\n-- **Fail-fast rule:** Any CRITICAL finding from any agent \u2192 stop. Do NOT merge. Compile findings as feedback and loop back to Codex. No point sending to CI or later gates.\n-- Clean or WARNING-only across all agents \u2192 proceed to merge + Gate 1\n-- Full agent team composition and execution: see `factory-orchestrate/SKILL.md` Step 4\n+### Gate 0: Two-Tier Code Review (Script + Agent Team)\n+- **Tier 1 (deterministic):** `scripts/run_gate0.py` runs all 5 tool checks in parallel (ruff, radon, vulture, bandit, test-quality). Produces `artifacts/factory/gate0_results.json`. Fast, cheap, catches the obvious stuff.\n+- **Tier 2 (LLM semantic):** 4 specialized agents review the same paradigms at semantic depth, building on tier 1 output. Agents: code-health, security, test-integrity, adversarial. Paradigm prompts: `.claude/skills/factory-orchestrate/review-prompts/`\n+- **Fail-fast rule:** Any CRITICAL finding from either tier \u2192 stop. Do NOT proceed to Gates 1-3.\n+- **On Gate 0 failure:** Merge Codex's code anyway (so iteration N+1 is incremental), commit feedback, push, and loop. Never revert \u2014 Codex iterates on its own code with feedback, not from scratch.\n+- Clean or WARNING-only across both tiers \u2192 proceed to merge + Gate 1\n+- Full two-tier composition and execution: see `factory-orchestrate/SKILL.md` Step 4\n \n ### Gate 1: Deterministic CI\n - `make lint` \u2014 ruff check\n@@ -240,6 +242,7 @@ Escalate to interactive debugging (Claude Code) when:\n \n ```\n artifacts/factory/\n+\u251c\u2500\u2500 gate0_results.json       # Gate 0 tier 1 tool check results (gitignored)\n \u251c\u2500\u2500 scenario_results.json    # Latest run results (gitignored)\n \u251c\u2500\u2500 ci_output.log            # Latest CI output (gitignored)\n \u251c\u2500\u2500 iteration_count.txt      # Current iteration number (committed)\n@@ -254,7 +257,7 @@ Architecture decisions that are correct for the current proof-of-concept but sho\n |----------|--------------|-------------------|--------|\n | Separate factory-loop + validate CI workflows | Overlap provides redundancy | Factory running regularly with stable gates | Consolidate into single workflow with clear separation |\n | `.devcontainer` setup | Not yet configured | Multiple developers or CI environments diverging | Add devcontainer with pinned Python, deps, hooks |\n-| Gate 2 checks are tool-only | Deterministic, reliable | Need for architectural or design-level quality checks | Add LLM-based advisory checks (clearly labeled non-deterministic) |\n+| Gate 2 NFR framework is code-review only | Static analysis checks (ruff, radon, vulture, bandit) | System deployed to infrastructure environments | Add infrastructure-level NFR checks: elasticity, scaling, deployment health |\n | Post-merge items tracked in review pack only | PR review pack captures items | Items getting lost after merge | `scripts/create_postmerge_issues.py` creates GH issues automatically |\n | Manual `make install-hooks` required | Prominent in docs, not enforced | New contributors missing it | `.devcontainer` or CI check that validates hooks are installed |\n \n@@ -268,11 +271,12 @@ Architecture decisions that are correct for the current proof-of-concept but sho\n | `/scripts/compile_feedback.py` | Factory | Feedback generation |\n | `/scripts/strip_holdout.py` | Factory | Holdout stripping (isolation gate) |\n | `/scripts/restore_holdout.py` | Factory | Holdout restoration |\n-| `/scripts/nfr_checks.py` | Factory | Gate 0 tool agents + Gate 2 NFR checker |\n-| `/scripts/check_test_quality.py` | Factory | Gate 0 tool agent \u2014 vacuous test detection |\n+| `/scripts/run_gate0.py` | Factory | Gate 0 tier 1 \u2014 parallel deterministic tool runner |\n+| `/scripts/nfr_checks.py` | Factory | Gate 0 tier 1 checks + Gate 2 NFR framework |\n+| `/scripts/check_test_quality.py` | Factory | Gate 0 tier 1 \u2014 vacuous test detection |\n | `/.github/workflows/factory.yaml` | Factory | CI validation on push |\n | `/.github/codex/prompts/factory_fix.md` | Factory | Codex instruction template |\n-| `/.github/codex/prompts/adversarial_review.md` | Factory | Gate 0 semantic reviewer checklist |\n+| `/.claude/skills/factory-orchestrate/review-prompts/` | Factory | Gate 0 review agent paradigm docs (adversarial, code-health, security, test-integrity) |\n | `/.claude/skills/factory-orchestrate/` | Factory | Claude Code orchestration skill |\n | `/.claude/skills/pr-review-pack/` | Factory | PR review pack generation (accept/merge gate) |\n | `/docs/code_quality_standards.md` | Factory | Universal code quality standards |\n",
      "raw": "# Dark Factory \u2014 Operating Manual\n\n## What Is This\n\nThe dark factory is a convergence loop that turns a one-shot AI code generation into working software through automated validation and feedback. Code is never reviewed by humans \u2014 correctness is inferred from externally observable behavior.\n\nThe pattern: **Seed \u2192 Agent \u2192 Validate \u2192 Feedback \u2192 Repeat until satisfied.**\n\n## Cross-References (DRY)\n\nThis file is the **operating manual** \u2014 the \"what\" and \"why\" of the factory. Operational detail lives in the skills:\n\n| Concept | Source of Truth | This File |\n|---------|----------------|-----------|\n| Convergence loop steps | `.claude/skills/factory-orchestrate/SKILL.md` | Summary in ASCII diagram |\n| Gate 0 two-tier composition | `factory-orchestrate/SKILL.md` Step 4 | Behavioral contract only |\n| Gate 0 review paradigm docs | `.claude/skills/factory-orchestrate/review-prompts/` | References, doesn't repeat |\n| PR review pack pipeline | `.claude/skills/pr-review-pack/SKILL.md` | What the human reviews |\n| Code quality standards | `docs/code_quality_standards.md` | References, doesn't repeat |\n\nWhen updating gate behavior or agent composition, update the **skill first**, then check this file's summary still holds.\n\n## Architecture\n\n**Claude Code is the factory orchestrator.** It drives the convergence loop, invokes Codex via browser, runs adversarial review, and makes holistic judgment calls. CI provides background validation on every push \u2014 it validates, it doesn't orchestrate.\n\n### Claude Code as Orchestrator (Primary)\n\nClaude Code runs the convergence loop via the `/factory-orchestrate` skill, using browser automation to invoke Codex through the ChatGPT Plus UI.\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502               HUMAN (Project Lead)               \u2502\n\u2502  Authors specs (/specs/) and scenarios           \u2502\n\u2502  Invokes /factory-orchestrate skill              \u2502\n\u2502  Reviews PR at accept/merge gate                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n             \u2502\n             \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502         CLAUDE CODE (Orchestrator)               \u2502\n\u2502         .claude/skills/factory-orchestrate        \u2502\n\u2502                                                   \u2502\n\u2502  for each iteration:                              \u2502\n\u2502    1. Create df-crank-vXX branch                  \u2502\n\u2502    2. strip_holdout.py \u2192 remove /scenarios/       \u2502\n\u2502    3. Push stripped branch to origin               \u2502\n\u2502    4. Invoke Codex via browser (Codex UI)          \u2502\n\u2502       \u2192 Codex creates its own codex-... branch     \u2502\n\u2502    5. Gate 0: Adversarial review (agent team)       \u2502\n\u2502    6. Merge Codex changes onto factory branch      \u2502\n\u2502    7. restore_holdout.py \u2192 restore /scenarios/     \u2502\n\u2502    8. Gate 1: make lint && typecheck && test        \u2502\n\u2502    9. Gate 2: NFR checks (non-blocking)            \u2502\n\u2502   10. Gate 3: Behavioral scenarios                 \u2502\n\u2502   11. LLM-as-judge: holistic evaluation            \u2502\n\u2502   12. If satisfied \u2192 PR. If not \u2192 feedback \u2192 loop  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n             \u2502                  \u25b2\n             \u2502 stripped branch   \u2502 codex-... branch\n             \u25bc                  \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              CODEX (Attractor)                    \u2502\n\u2502  Reads: /specs/, feedback_iter_N.md               \u2502\n\u2502  Writes: src/, tests/, configs/, Makefile         \u2502\n\u2502  NEVER sees: /scenarios/ (stripped from branch)    \u2502\n\u2502  NEVER touches: factory infrastructure             \u2502\n\u2502  Creates own branch: codex-...                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n### CI Validation on Push (Background)\n\nCI runs validation-only on every push to `factory/**` or `df-crank-**` branches: Gate 1 (lint/typecheck/test), Gate 2 (NFR checks), and Gate 3 (behavioral scenarios). Claude Code reads these CI results as input to its orchestration decisions. If an `OPENAI_API_KEY` secret is available, CI can also run a fallback convergence loop with Codex API \u2014 but browser orchestration is the primary path.\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502            CI VALIDATION                          \u2502\n\u2502        .github/workflows/factory.yaml             \u2502\n\u2502                                                   \u2502\n\u2502  On push to factory/** or df-crank-** branches:   \u2502\n\u2502    1. Gate 1: lint + typecheck + test              \u2502\n\u2502    2. Gate 2: NFR checks                           \u2502\n\u2502    3. Gate 3: Behavioral scenarios                 \u2502\n\u2502    4. Compile feedback                             \u2502\n\u2502  Claude Code reads CI results and decides next     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n## Validation Gates\n\n### Gate 0: Two-Tier Code Review (Script + Agent Team)\n- **Tier 1 (deterministic):** `scripts/run_gate0.py` runs all 5 tool checks in parallel (ruff, radon, vulture, bandit, test-quality). Produces `artifacts/factory/gate0_results.json`. Fast, cheap, catches the obvious stuff.\n- **Tier 2 (LLM semantic):** 4 specialized agents review the same paradigms at semantic depth, building on tier 1 output. Agents: code-health, security, test-integrity, adversarial. Paradigm prompts: `.claude/skills/factory-orchestrate/review-prompts/`\n- **Fail-fast rule:** Any CRITICAL finding from either tier \u2192 stop. Do NOT proceed to Gates 1-3.\n- **On Gate 0 failure:** Merge Codex's code anyway (so iteration N+1 is incremental), commit feedback, push, and loop. Never revert \u2014 Codex iterates on its own code with feedback, not from scratch.\n- Clean or WARNING-only across both tiers \u2192 proceed to merge + Gate 1\n- Full two-tier composition and execution: see `factory-orchestrate/SKILL.md` Step 4\n\n### Gate 1: Deterministic CI\n- `make lint` \u2014 ruff check\n- `make typecheck` \u2014 mypy\n- `make test` \u2014 full pytest suite (including tests the attractor wrote, already reviewed by Gate 0)\n\nIf any fail, Gates 2-3 are skipped. The agent gets the CI errors directly.\n\n### Gate 2: Non-Functional Requirements (NFRs)\n- `make nfr-check` \u2014 extensible framework (`scripts/nfr_checks.py`)\n- **Active checks:** code quality (ruff extended), complexity (radon), dead code (vulture), security (bandit)\n- **Planned checks:** duplication, import hygiene, coverage, maintainability, reliability\n- Non-blocking \u2014 findings feed into feedback and LLM-as-judge evaluation\n- Adding a new check: write a function, register in `NFR_CHECKS` dict\n\n### Gate 3: Behavioral Scenarios\n- `scripts/run_scenarios.py` executes holdout scenarios from `/scenarios/`\n- Each scenario runs an evaluation command and checks pass criteria\n- Results produce a satisfaction score: `passed / total`\n\n### LLM-as-Judge (Claude Code orchestrated)\n- Claude Code reasons holistically through ALL gate outputs\n- Not just \"score >= threshold\" \u2014 considers trajectory, systemic issues, Gate 2 warnings\n- Factors in: Are fixes real or is Codex gaming? Do patterns make sense?\n- Holistic go/no-go decision for creating the PR\n\n## Scenario Isolation (Branch Stripping)\n\nThe factory hides `/scenarios/` from Codex using **branch stripping** \u2014 scenarios are physically removed from the branch Codex works on.\n\n### How it works\n1. `scripts/strip_holdout.py` removes `/scenarios/` and comments out Makefile scenario targets\n2. Commits with marker `[factory:holdout-stripped]`\n3. Verifies no scenario files remain on the branch\n4. Stripped branch is pushed to origin \u2014 Codex only ever sees this branch\n5. After Codex finishes, `scripts/restore_holdout.py` restores from `origin/main`\n\n### Why branch stripping (not filesystem shuffle)\nThe previous approach (`mv scenarios /tmp/`) was security theater \u2014 Codex runs in the same job and can read `/tmp/`. Branch stripping is a real gate: scenarios literally don't exist on the branch Codex sees. There's nothing to read, no path to guess, no hidden directory to discover.\n\n### Scripts\n- `scripts/strip_holdout.py` \u2014 deterministic removal, supports `--dry-run` and `--no-commit`\n- `scripts/restore_holdout.py` \u2014 deterministic restoration from a git ref, supports `--ref` and `--dry-run`\n- Both are factory-protected files (never modified by Codex)\n\n## How to Trigger the Factory\n\n### Claude Code Orchestrated (primary)\n```\n# Invoke the factory orchestration skill:\n/factory-orchestrate\n```\nClaude Code handles the full loop: branch creation, holdout stripping, Codex invocation (via browser), adversarial review, validation, LLM judgment, and PR creation.\n\n### GitHub Actions (CI validation on push)\n```\n# Automatic: push to factory/** or df-crank-** branches triggers CI validation\n# Manual: Actions \u2192 Dark Factory \u2192 Run workflow\ngh workflow run factory.yaml -f max_iterations=5 -f satisfaction_threshold=0.80\n```\nCI runs Gates 1-3 + feedback compilation. Claude Code reads the results.\n\n### Local (testing the plumbing)\n```bash\nmake factory-local    # One iteration: Gate 1 \u2192 Gate 2 \u2192 Gate 3 \u2192 feedback\nmake factory-status   # Show current iteration and satisfaction score\nmake nfr-check        # Just run Gate 2 NFR checks\n```\n\n### Individual components\n```bash\nmake run-scenarios        # Just run scenarios\nmake compile-feedback     # Just compile feedback from latest results\n```\n\n## How to Write a New Scenario\n\nCreate a markdown file in `/scenarios/` with this structure:\n\n```markdown\n# Scenario: [descriptive name]\n\n## Category\n[environment | training | pipeline | dashboard | integration]\n\n## Preconditions\n- [what must be true before evaluation]\n\n## Behavioral Expectation\n[what the system should do, from observer perspective]\n\n## Evaluation Method\n\\```bash\n[command that tests the behavior]\n\\```\n\n## Pass Criteria\n[specific condition for passing]\n\n## Evidence Required\n- [what to capture as proof]\n```\n\nThe evaluation method is a bash command that exits 0 on pass, non-zero on fail. Keep commands self-contained \u2014 they run in the repo root with PYTHONPATH set.\n\n## How to Read Feedback\n\nFeedback files are at `artifacts/factory/feedback_iter_N.md`. Each contains:\n- **Summary** \u2014 satisfaction score and pass/fail counts\n- **Convergence trajectory** \u2014 how scores changed across iterations\n- **Likely root causes** \u2014 pattern-matched from error types\n- **Full error details** \u2014 every failed scenario with complete stdout/stderr\n- **Instructions** \u2014 prioritized fix guidance for the coding agent\n\n## Accept/Merge Gate\n\nThe factory **never auto-merges** to main. When the convergence loop meets the satisfaction threshold, it creates (or updates) a PR with the `factory-converged` and `accept-merge-gate` labels. This is the single human decision point in the entire loop.\n\nAfter creating the PR, the orchestrator generates a **PR review pack** via the `/pr-review-pack` skill \u2014 a self-contained interactive HTML file. The project lead reviews the report, not the code. Build specification and three-pass pipeline: see `pr-review-pack/SKILL.md`.\n\n**What the project lead reviews (via the review pack):**\n- Architecture diagram showing which zones were touched\n- Adversarial findings from the Gate 0 agent team, graded by file\n- CI performance with health classification\n- Key decisions with zone-level traceability\n- Convergence result \u2014 gate-by-gate status and satisfaction score\n- Post-merge items with code snippets and failure/success scenarios\n- Factory history \u2014 iteration timeline, intervention log, gate findings per iteration\n\n**To accept:** Approve and merge the PR. The factory branch can be deleted.\n**To reject:** Close the PR and either adjust scenarios/specs or trigger another factory run.\n\nThe accept/merge gate exists because code produced by the factory was never reviewed by humans during production. The review pack provides structured visibility into what the factory did and why. The merge decision is always human.\n\n## When to Escalate\n\nEscalate to interactive debugging (Claude Code) when:\n- The factory has stalled for 3+ iterations with no score improvement\n- The same scenario keeps failing with the same error pattern\n- Gate 1 failures persist (the code doesn't even pass lint/typecheck)\n- A scenario requires architectural changes the agent can't figure out from error messages alone\n\n## Factory State\n\n```\nartifacts/factory/\n\u251c\u2500\u2500 gate0_results.json       # Gate 0 tier 1 tool check results (gitignored)\n\u251c\u2500\u2500 scenario_results.json    # Latest run results (gitignored)\n\u251c\u2500\u2500 ci_output.log            # Latest CI output (gitignored)\n\u251c\u2500\u2500 iteration_count.txt      # Current iteration number (committed)\n\u2514\u2500\u2500 feedback_iter_*.md       # All feedback files (committed \u2014 Codex reads these)\n```\n\n## Known Evolution Paths\n\nArchitecture decisions that are correct for the current proof-of-concept but should be revisited as the factory matures:\n\n| Decision | Current State | Evolution Trigger | Target |\n|----------|--------------|-------------------|--------|\n| Separate factory-loop + validate CI workflows | Overlap provides redundancy | Factory running regularly with stable gates | Consolidate into single workflow with clear separation |\n| `.devcontainer` setup | Not yet configured | Multiple developers or CI environments diverging | Add devcontainer with pinned Python, deps, hooks |\n| Gate 2 NFR framework is code-review only | Static analysis checks (ruff, radon, vulture, bandit) | System deployed to infrastructure environments | Add infrastructure-level NFR checks: elasticity, scaling, deployment health |\n| Post-merge items tracked in review pack only | PR review pack captures items | Items getting lost after merge | `scripts/create_postmerge_issues.py` creates GH issues automatically |\n| Manual `make install-hooks` required | Prominent in docs, not enforced | New contributors missing it | `.devcontainer` or CI check that validates hooks are installed |\n\n## Key Files\n\n| File | Owner | Purpose |\n|------|-------|---------|\n| `/specs/*.md` | Human | What the system should do |\n| `/scenarios/*.md` | Human | How to evaluate (holdout) |\n| `/scripts/run_scenarios.py` | Factory | Scenario evaluation engine |\n| `/scripts/compile_feedback.py` | Factory | Feedback generation |\n| `/scripts/strip_holdout.py` | Factory | Holdout stripping (isolation gate) |\n| `/scripts/restore_holdout.py` | Factory | Holdout restoration |\n| `/scripts/run_gate0.py` | Factory | Gate 0 tier 1 \u2014 parallel deterministic tool runner |\n| `/scripts/nfr_checks.py` | Factory | Gate 0 tier 1 checks + Gate 2 NFR framework |\n| `/scripts/check_test_quality.py` | Factory | Gate 0 tier 1 \u2014 vacuous test detection |\n| `/.github/workflows/factory.yaml` | Factory | CI validation on push |\n| `/.github/codex/prompts/factory_fix.md` | Factory | Codex instruction template |\n| `/.claude/skills/factory-orchestrate/review-prompts/` | Factory | Gate 0 review agent paradigm docs (adversarial, code-health, security, test-integrity) |\n| `/.claude/skills/factory-orchestrate/` | Factory | Claude Code orchestration skill |\n| `/.claude/skills/pr-review-pack/` | Factory | PR review pack generation (accept/merge gate) |\n| `/docs/code_quality_standards.md` | Factory | Universal code quality standards |\n| `/docs/factory_architecture.html` | Factory | Interactive architecture diagram |\n| `/CLAUDE.md` | Factory | Repo-level context for Claude Code |\n| `/artifacts/factory/feedback_iter_*.md` | Factory | Iteration feedback (Codex reads) |\n",
      "base": "# Dark Factory \u2014 Operating Manual\n\n## What Is This\n\nThe dark factory is a convergence loop that turns a one-shot AI code generation into working software through automated validation and feedback. Code is never reviewed by humans \u2014 correctness is inferred from externally observable behavior.\n\nThe pattern: **Seed \u2192 Agent \u2192 Validate \u2192 Feedback \u2192 Repeat until satisfied.**\n\n## Cross-References (DRY)\n\nThis file is the **operating manual** \u2014 the \"what\" and \"why\" of the factory. Operational detail lives in the skills:\n\n| Concept | Source of Truth | This File |\n|---------|----------------|-----------|\n| Convergence loop steps | `.claude/skills/factory-orchestrate/SKILL.md` | Summary in ASCII diagram |\n| Gate 0 agent team composition | `factory-orchestrate/SKILL.md` Step 4 | Behavioral contract only |\n| PR review pack pipeline | `.claude/skills/pr-review-pack/SKILL.md` | What the human reviews |\n| Code quality standards | `docs/code_quality_standards.md` | References, doesn't repeat |\n| Adversarial review checklist | `.github/codex/prompts/adversarial_review.md` | References, doesn't repeat |\n\nWhen updating gate behavior or agent composition, update the **skill first**, then check this file's summary still holds.\n\n## Architecture\n\n**Claude Code is the factory orchestrator.** It drives the convergence loop, invokes Codex via browser, runs adversarial review, and makes holistic judgment calls. CI provides background validation on every push \u2014 it validates, it doesn't orchestrate.\n\n### Claude Code as Orchestrator (Primary)\n\nClaude Code runs the convergence loop via the `/factory-orchestrate` skill, using browser automation to invoke Codex through the ChatGPT Plus UI.\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502               HUMAN (Project Lead)               \u2502\n\u2502  Authors specs (/specs/) and scenarios           \u2502\n\u2502  Invokes /factory-orchestrate skill              \u2502\n\u2502  Reviews PR at accept/merge gate                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n             \u2502\n             \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502         CLAUDE CODE (Orchestrator)               \u2502\n\u2502         .claude/skills/factory-orchestrate        \u2502\n\u2502                                                   \u2502\n\u2502  for each iteration:                              \u2502\n\u2502    1. Create df-crank-vXX branch                  \u2502\n\u2502    2. strip_holdout.py \u2192 remove /scenarios/       \u2502\n\u2502    3. Push stripped branch to origin               \u2502\n\u2502    4. Invoke Codex via browser (Codex UI)          \u2502\n\u2502       \u2192 Codex creates its own codex-... branch     \u2502\n\u2502    5. Gate 0: Adversarial review (agent team)       \u2502\n\u2502    6. Merge Codex changes onto factory branch      \u2502\n\u2502    7. restore_holdout.py \u2192 restore /scenarios/     \u2502\n\u2502    8. Gate 1: make lint && typecheck && test        \u2502\n\u2502    9. Gate 2: NFR checks (non-blocking)            \u2502\n\u2502   10. Gate 3: Behavioral scenarios                 \u2502\n\u2502   11. LLM-as-judge: holistic evaluation            \u2502\n\u2502   12. If satisfied \u2192 PR. If not \u2192 feedback \u2192 loop  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n             \u2502                  \u25b2\n             \u2502 stripped branch   \u2502 codex-... branch\n             \u25bc                  \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              CODEX (Attractor)                    \u2502\n\u2502  Reads: /specs/, feedback_iter_N.md               \u2502\n\u2502  Writes: src/, tests/, configs/, Makefile         \u2502\n\u2502  NEVER sees: /scenarios/ (stripped from branch)    \u2502\n\u2502  NEVER touches: factory infrastructure             \u2502\n\u2502  Creates own branch: codex-...                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n### CI Validation on Push (Background)\n\nCI runs validation-only on every push to `factory/**` or `df-crank-**` branches: Gate 1 (lint/typecheck/test), Gate 2 (NFR checks), and Gate 3 (behavioral scenarios). Claude Code reads these CI results as input to its orchestration decisions. If an `OPENAI_API_KEY` secret is available, CI can also run a fallback convergence loop with Codex API \u2014 but browser orchestration is the primary path.\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502            CI VALIDATION                          \u2502\n\u2502        .github/workflows/factory.yaml             \u2502\n\u2502                                                   \u2502\n\u2502  On push to factory/** or df-crank-** branches:   \u2502\n\u2502    1. Gate 1: lint + typecheck + test              \u2502\n\u2502    2. Gate 2: NFR checks                           \u2502\n\u2502    3. Gate 3: Behavioral scenarios                 \u2502\n\u2502    4. Compile feedback                             \u2502\n\u2502  Claude Code reads CI results and decides next     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n## Validation Gates\n\n### Gate 0: Adversarial Code Review (Agent Team)\n- Runs as a **parallel agent team** before merge \u2014 deterministic tool agents + LLM semantic reviewer, simultaneously\n- **Fail-fast rule:** Any CRITICAL finding from any agent \u2192 stop. Do NOT merge. Compile findings as feedback and loop back to Codex. No point sending to CI or later gates.\n- Clean or WARNING-only across all agents \u2192 proceed to merge + Gate 1\n- Full agent team composition and execution: see `factory-orchestrate/SKILL.md` Step 4\n\n### Gate 1: Deterministic CI\n- `make lint` \u2014 ruff check\n- `make typecheck` \u2014 mypy\n- `make test` \u2014 full pytest suite (including tests the attractor wrote, already reviewed by Gate 0)\n\nIf any fail, Gates 2-3 are skipped. The agent gets the CI errors directly.\n\n### Gate 2: Non-Functional Requirements (NFRs)\n- `make nfr-check` \u2014 extensible framework (`scripts/nfr_checks.py`)\n- **Active checks:** code quality (ruff extended), complexity (radon), dead code (vulture), security (bandit)\n- **Planned checks:** duplication, import hygiene, coverage, maintainability, reliability\n- Non-blocking \u2014 findings feed into feedback and LLM-as-judge evaluation\n- Adding a new check: write a function, register in `NFR_CHECKS` dict\n\n### Gate 3: Behavioral Scenarios\n- `scripts/run_scenarios.py` executes holdout scenarios from `/scenarios/`\n- Each scenario runs an evaluation command and checks pass criteria\n- Results produce a satisfaction score: `passed / total`\n\n### LLM-as-Judge (Claude Code orchestrated)\n- Claude Code reasons holistically through ALL gate outputs\n- Not just \"score >= threshold\" \u2014 considers trajectory, systemic issues, Gate 2 warnings\n- Factors in: Are fixes real or is Codex gaming? Do patterns make sense?\n- Holistic go/no-go decision for creating the PR\n\n## Scenario Isolation (Branch Stripping)\n\nThe factory hides `/scenarios/` from Codex using **branch stripping** \u2014 scenarios are physically removed from the branch Codex works on.\n\n### How it works\n1. `scripts/strip_holdout.py` removes `/scenarios/` and comments out Makefile scenario targets\n2. Commits with marker `[factory:holdout-stripped]`\n3. Verifies no scenario files remain on the branch\n4. Stripped branch is pushed to origin \u2014 Codex only ever sees this branch\n5. After Codex finishes, `scripts/restore_holdout.py` restores from `origin/main`\n\n### Why branch stripping (not filesystem shuffle)\nThe previous approach (`mv scenarios /tmp/`) was security theater \u2014 Codex runs in the same job and can read `/tmp/`. Branch stripping is a real gate: scenarios literally don't exist on the branch Codex sees. There's nothing to read, no path to guess, no hidden directory to discover.\n\n### Scripts\n- `scripts/strip_holdout.py` \u2014 deterministic removal, supports `--dry-run` and `--no-commit`\n- `scripts/restore_holdout.py` \u2014 deterministic restoration from a git ref, supports `--ref` and `--dry-run`\n- Both are factory-protected files (never modified by Codex)\n\n## How to Trigger the Factory\n\n### Claude Code Orchestrated (primary)\n```\n# Invoke the factory orchestration skill:\n/factory-orchestrate\n```\nClaude Code handles the full loop: branch creation, holdout stripping, Codex invocation (via browser), adversarial review, validation, LLM judgment, and PR creation.\n\n### GitHub Actions (CI validation on push)\n```\n# Automatic: push to factory/** or df-crank-** branches triggers CI validation\n# Manual: Actions \u2192 Dark Factory \u2192 Run workflow\ngh workflow run factory.yaml -f max_iterations=5 -f satisfaction_threshold=0.80\n```\nCI runs Gates 1-3 + feedback compilation. Claude Code reads the results.\n\n### Local (testing the plumbing)\n```bash\nmake factory-local    # One iteration: Gate 1 \u2192 Gate 2 \u2192 Gate 3 \u2192 feedback\nmake factory-status   # Show current iteration and satisfaction score\nmake nfr-check        # Just run Gate 2 NFR checks\n```\n\n### Individual components\n```bash\nmake run-scenarios        # Just run scenarios\nmake compile-feedback     # Just compile feedback from latest results\n```\n\n## How to Write a New Scenario\n\nCreate a markdown file in `/scenarios/` with this structure:\n\n```markdown\n# Scenario: [descriptive name]\n\n## Category\n[environment | training | pipeline | dashboard | integration]\n\n## Preconditions\n- [what must be true before evaluation]\n\n## Behavioral Expectation\n[what the system should do, from observer perspective]\n\n## Evaluation Method\n\\```bash\n[command that tests the behavior]\n\\```\n\n## Pass Criteria\n[specific condition for passing]\n\n## Evidence Required\n- [what to capture as proof]\n```\n\nThe evaluation method is a bash command that exits 0 on pass, non-zero on fail. Keep commands self-contained \u2014 they run in the repo root with PYTHONPATH set.\n\n## How to Read Feedback\n\nFeedback files are at `artifacts/factory/feedback_iter_N.md`. Each contains:\n- **Summary** \u2014 satisfaction score and pass/fail counts\n- **Convergence trajectory** \u2014 how scores changed across iterations\n- **Likely root causes** \u2014 pattern-matched from error types\n- **Full error details** \u2014 every failed scenario with complete stdout/stderr\n- **Instructions** \u2014 prioritized fix guidance for the coding agent\n\n## Accept/Merge Gate\n\nThe factory **never auto-merges** to main. When the convergence loop meets the satisfaction threshold, it creates (or updates) a PR with the `factory-converged` and `accept-merge-gate` labels. This is the single human decision point in the entire loop.\n\nAfter creating the PR, the orchestrator generates a **PR review pack** via the `/pr-review-pack` skill \u2014 a self-contained interactive HTML file. The project lead reviews the report, not the code. Build specification and three-pass pipeline: see `pr-review-pack/SKILL.md`.\n\n**What the project lead reviews (via the review pack):**\n- Architecture diagram showing which zones were touched\n- Adversarial findings from the Gate 0 agent team, graded by file\n- CI performance with health classification\n- Key decisions with zone-level traceability\n- Convergence result \u2014 gate-by-gate status and satisfaction score\n- Post-merge items with code snippets and failure/success scenarios\n- Factory history \u2014 iteration timeline, intervention log, gate findings per iteration\n\n**To accept:** Approve and merge the PR. The factory branch can be deleted.\n**To reject:** Close the PR and either adjust scenarios/specs or trigger another factory run.\n\nThe accept/merge gate exists because code produced by the factory was never reviewed by humans during production. The review pack provides structured visibility into what the factory did and why. The merge decision is always human.\n\n## When to Escalate\n\nEscalate to interactive debugging (Claude Code) when:\n- The factory has stalled for 3+ iterations with no score improvement\n- The same scenario keeps failing with the same error pattern\n- Gate 1 failures persist (the code doesn't even pass lint/typecheck)\n- A scenario requires architectural changes the agent can't figure out from error messages alone\n\n## Factory State\n\n```\nartifacts/factory/\n\u251c\u2500\u2500 scenario_results.json    # Latest run results (gitignored)\n\u251c\u2500\u2500 ci_output.log            # Latest CI output (gitignored)\n\u251c\u2500\u2500 iteration_count.txt      # Current iteration number (committed)\n\u2514\u2500\u2500 feedback_iter_*.md       # All feedback files (committed \u2014 Codex reads these)\n```\n\n## Known Evolution Paths\n\nArchitecture decisions that are correct for the current proof-of-concept but should be revisited as the factory matures:\n\n| Decision | Current State | Evolution Trigger | Target |\n|----------|--------------|-------------------|--------|\n| Separate factory-loop + validate CI workflows | Overlap provides redundancy | Factory running regularly with stable gates | Consolidate into single workflow with clear separation |\n| `.devcontainer` setup | Not yet configured | Multiple developers or CI environments diverging | Add devcontainer with pinned Python, deps, hooks |\n| Gate 2 checks are tool-only | Deterministic, reliable | Need for architectural or design-level quality checks | Add LLM-based advisory checks (clearly labeled non-deterministic) |\n| Post-merge items tracked in review pack only | PR review pack captures items | Items getting lost after merge | `scripts/create_postmerge_issues.py` creates GH issues automatically |\n| Manual `make install-hooks` required | Prominent in docs, not enforced | New contributors missing it | `.devcontainer` or CI check that validates hooks are installed |\n\n## Key Files\n\n| File | Owner | Purpose |\n|------|-------|---------|\n| `/specs/*.md` | Human | What the system should do |\n| `/scenarios/*.md` | Human | How to evaluate (holdout) |\n| `/scripts/run_scenarios.py` | Factory | Scenario evaluation engine |\n| `/scripts/compile_feedback.py` | Factory | Feedback generation |\n| `/scripts/strip_holdout.py` | Factory | Holdout stripping (isolation gate) |\n| `/scripts/restore_holdout.py` | Factory | Holdout restoration |\n| `/scripts/nfr_checks.py` | Factory | Gate 0 tool agents + Gate 2 NFR checker |\n| `/scripts/check_test_quality.py` | Factory | Gate 0 tool agent \u2014 vacuous test detection |\n| `/.github/workflows/factory.yaml` | Factory | CI validation on push |\n| `/.github/codex/prompts/factory_fix.md` | Factory | Codex instruction template |\n| `/.github/codex/prompts/adversarial_review.md` | Factory | Gate 0 semantic reviewer checklist |\n| `/.claude/skills/factory-orchestrate/` | Factory | Claude Code orchestration skill |\n| `/.claude/skills/pr-review-pack/` | Factory | PR review pack generation (accept/merge gate) |\n| `/docs/code_quality_standards.md` | Factory | Universal code quality standards |\n| `/docs/factory_architecture.html` | Factory | Interactive architecture diagram |\n| `/CLAUDE.md` | Factory | Repo-level context for Claude Code |\n| `/artifacts/factory/feedback_iter_*.md` | Factory | Iteration feedback (Codex reads) |\n"
    },
    "docs/factory_architecture.html": {
      "additions": 5,
      "deletions": 6,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/docs/factory_architecture.html b/docs/factory_architecture.html\nindex cbc9a0b..e61bdf0 100644\n--- a/docs/factory_architecture.html\n+++ b/docs/factory_architecture.html\n@@ -438,15 +438,14 @@ const C = {\n     boundary: 'Codex works on the stripped branch \\u2014 cannot access scenarios or adversarial findings by design.'\n   },\n   'step-gate0': {\n-    title: 'Gate 0: Adversarial Review (Agent Team)',\n-    desc: 'Runs as a parallel agent team before merge. Tool agents (ruff, radon, vulture, bandit, check_test_quality.py) run deterministic checks simultaneously. The semantic adversarial reviewer reads the diff against code_quality_standards.md, adversarial_review.md, and /specs/. All agents have full authority \\u2014 any CRITICAL finding from any agent blocks the pipeline. No point sending to CI or later gates if Gate 0 finds issues.',\n+    title: 'Gate 0: Two-Tier Code Review (Script + Agent Team)',\n+    desc: 'Tier 1: scripts/run_gate0.py runs all 5 deterministic tool checks in parallel (ruff, radon, vulture, bandit, test-quality) and produces gate0_results.json. Tier 2: 4 LLM agents (code-health, security, test-integrity, adversarial) review the same paradigms at semantic depth, building on tier 1 output. Any CRITICAL finding from either tier blocks the pipeline.',\n     files: [\n-      { n: 'scripts/nfr_checks.py (tool agents)', c: 'factory' },\n-      { n: 'scripts/check_test_quality.py (tool agent)', c: 'factory' },\n-      { n: '.github/codex/prompts/adversarial_review.md', c: 'factory' },\n+      { n: 'scripts/run_gate0.py (tier 1 runner)', c: 'factory' },\n+      { n: '.claude/skills/factory-orchestrate/review-prompts/ (tier 2 agent docs)', c: 'factory' },\n       { n: 'docs/code_quality_standards.md', c: 'factory' },\n     ],\n-    tags: [{ t: 'Gate 0', c: 'gate' }, { t: 'Agent Team', c: 'info' }, { t: 'Fail-Fast', c: 'boundary' }],\n+    tags: [{ t: 'Gate 0', c: 'gate' }, { t: 'Two-Tier', c: 'info' }, { t: 'Fail-Fast', c: 'boundary' }],\n     boundary: 'Layered defense: tool agents catch cheap/obvious violations fast, semantic reviewer catches subtle gaming and architectural dishonesty. Both run in parallel. Gate 3 holdout scenarios verify actual behavior as ground truth.'\n   },\n   'step-gate1': {\n",
      "raw": "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<title>Dark Factory \u2014 Architecture</title>\n<style>\n  :root {\n    --green: #22c55e; --green-bg: #f0fdf4; --green-border: #86efac;\n    --yellow: #eab308; --yellow-bg: #fefce8;\n    --orange: #f97316; --orange-bg: #fff7ed; --orange-border: #fdba74;\n    --red: #ef4444; --red-bg: #fef2f2;\n    --gray: #6b7280; --gray-bg: #f9fafb; --gray-border: #e5e7eb;\n    --blue: #3b82f6; --blue-bg: #eff6ff; --blue-border: #93c5fd;\n    --purple: #8b5cf6; --purple-bg: #f5f3ff; --purple-border: #c4b5fd;\n    --text: #1f2937; --text-secondary: #6b7280; --text-muted: #9ca3af;\n    --border: #e5e7eb; --bg: #f3f4f6; --surface: #ffffff;\n    --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;\n    --factory-fill: #dbeafe; --factory-stroke: #3b82f6;\n    --product-fill: #dcfce7; --product-stroke: #22c55e;\n    --human-fill: #ffedd5; --human-stroke: #f97316;\n    --attractor-fill: #ede9fe; --attractor-stroke: #8b5cf6;\n    --ci-fill: #f3f4f6; --ci-stroke: #6b7280;\n  }\n  [data-theme=\"dark\"] {\n    --text: #e5e7eb; --text-secondary: #9ca3af; --text-muted: #6b7280;\n    --border: #374151; --bg: #111827; --surface: #1f2937;\n    --gray-bg: #1f2937; --gray-border: #374151; --gray: #9ca3af;\n    --green-bg: #064e3b; --green-border: #10b981;\n    --yellow-bg: #713f12; --red-bg: #7f1d1d; --orange-bg: #7c2d12;\n    --blue-bg: #1e3a5f; --blue-border: #60a5fa;\n    --purple-bg: #2e1065; --purple-border: #a78bfa;\n    --factory-fill: #1e3a5f; --factory-stroke: #60a5fa;\n    --product-fill: #064e3b; --product-stroke: #34d399;\n    --human-fill: #7c2d12; --human-stroke: #fb923c;\n    --attractor-fill: #2e1065; --attractor-stroke: #a78bfa;\n    --ci-fill: #374151; --ci-stroke: #9ca3af;\n  }\n\n  * { box-sizing: border-box; margin: 0; padding: 0; }\n  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: var(--text); background: var(--bg); line-height: 1.5; font-size: 14px; }\n  .container { max-width: 1240px; margin: 0 auto; padding: 24px 16px; }\n\n  /* Header */\n  .header { background: var(--surface); border-radius: 12px; padding: 24px; margin-bottom: 20px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: flex-start; }\n  .header h1 { font-size: 22px; font-weight: 700; margin-bottom: 2px; }\n  .header .subtitle { font-size: 14px; color: var(--text-secondary); }\n  .theme-toggle { display: inline-flex; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }\n  .theme-toggle button { border: none; background: transparent; padding: 5px 11px; font-size: 14px; cursor: pointer; color: var(--text-secondary); transition: background 0.15s, color 0.15s; line-height: 1; }\n  .theme-toggle button:hover { background: var(--gray-bg); }\n  .theme-toggle button.active { background: var(--blue); color: white; }\n  .theme-toggle button:not(:last-child) { border-right: 1px solid var(--border); }\n\n  /* Legend */\n  .legend { background: var(--surface); border-radius: 12px; padding: 14px 24px; margin-bottom: 20px; border: 1px solid var(--border); display: flex; gap: 24px; flex-wrap: wrap; align-items: center; }\n  .legend-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-right: 4px; }\n  .legend-item { display: flex; align-items: center; gap: 7px; font-size: 13px; font-weight: 500; }\n  .legend-swatch { width: 14px; height: 14px; border-radius: 4px; border: 2px solid; }\n\n  /* Main layout */\n  .layout { display: grid; grid-template-columns: 1fr 340px; gap: 20px; align-items: start; }\n  @media (max-width: 960px) { .layout { grid-template-columns: 1fr; } }\n\n  /* Diagram */\n  .diagram-wrap { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); padding: 16px; overflow: hidden; }\n  .diagram-wrap svg { width: 100%; height: auto; display: block; }\n  .diagram-wrap svg text { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }\n\n  /* Detail panel */\n  .panel { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; position: sticky; top: 24px; }\n  .panel-header { padding: 14px 20px; border-bottom: 1px solid var(--border); }\n  .panel-header h2 { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }\n  .panel-body { padding: 20px; }\n  .panel-empty { padding: 40px 20px; text-align: center; color: var(--text-muted); font-size: 13px; }\n  .detail-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; }\n  .detail-desc { font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.6; }\n  .detail-section { margin-bottom: 14px; }\n  .detail-section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 6px; }\n  .detail-list { list-style: none; padding: 0; }\n  .detail-list li { font-size: 12px; font-family: var(--mono); color: var(--text-secondary); padding: 3px 0; display: flex; align-items: center; gap: 8px; }\n  .detail-list li::before { content: ''; width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }\n  .detail-list li.factory::before { background: var(--blue); }\n  .detail-list li.product::before { background: var(--green); }\n  .detail-list li.human::before { background: var(--orange); }\n  .detail-list li.attractor::before { background: var(--purple); }\n  .detail-list li.ci::before { background: var(--gray); }\n  .detail-tag { display: inline-block; font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 4px; margin-right: 4px; margin-bottom: 4px; }\n  .detail-tag.gate { background: var(--blue-bg); color: var(--blue); }\n  .detail-tag.boundary { background: var(--red-bg); color: var(--red); }\n  .detail-tag.info { background: var(--gray-bg); color: var(--gray); }\n\n  /* Sidebar sections */\n  .sidebar-section { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); margin-top: 16px; overflow: hidden; }\n  .sidebar-header { padding: 14px 20px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; transition: background 0.15s; }\n  .sidebar-header:hover { background: var(--gray-bg); }\n  .sidebar-header h3 { font-size: 13px; font-weight: 700; }\n  .sidebar-header .chevron { font-size: 14px; color: var(--text-secondary); transition: transform 0.2s; }\n  .sidebar-section.collapsed .sidebar-body { display: none; }\n  .sidebar-section.collapsed .chevron { transform: rotate(-90deg); }\n  .sidebar-body { padding: 16px 20px; font-size: 13px; }\n  .defense-layer { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }\n  .defense-layer:last-child { border-bottom: none; }\n  .defense-num { width: 22px; height: 22px; border-radius: 50%; background: var(--blue); color: white; font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }\n  .defense-text { font-size: 12px; line-height: 1.5; }\n  .defense-text strong { font-weight: 600; }\n  .boundary-item { padding: 8px 0; border-bottom: 1px solid var(--border); }\n  .boundary-item:last-child { border-bottom: none; }\n  .boundary-label { font-size: 12px; font-weight: 600; margin-bottom: 2px; }\n  .boundary-desc { font-size: 12px; color: var(--text-secondary); }\n  .agent-item { display: flex; align-items: flex-start; gap: 8px; padding: 7px 0; }\n  .agent-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 5px; }\n  .agent-name { font-size: 12px; font-weight: 600; }\n  .agent-role { font-size: 11px; color: var(--text-secondary); }\n\n  /* Footer */\n  .footer { text-align: center; padding: 24px; font-size: 12px; color: var(--text-muted); }\n\n  /* SVG interactive */\n  .node { cursor: pointer; transition: filter 0.15s, opacity 0.15s; }\n  .node:hover { filter: brightness(0.94); }\n  .node.active { filter: brightness(0.88); }\n  .node.dimmed { opacity: 0.2; }\n</style>\n</head>\n<body>\n\n<div class=\"container\">\n\n  <div class=\"header\">\n    <div>\n      <h1>Dark Factory &mdash; Architecture</h1>\n      <div class=\"subtitle\">Claude Code + Agent Teams Orchestration Model</div>\n    </div>\n    <div class=\"theme-toggle\" id=\"themeToggle\">\n      <button onclick=\"setTheme('light')\" title=\"Light\">&#9788;</button>\n      <button onclick=\"setTheme('dark')\" title=\"Dark\">&#9790;</button>\n      <button onclick=\"setTheme('system')\" title=\"System\" class=\"active\">&#9881;</button>\n    </div>\n  </div>\n\n  <div class=\"legend\">\n    <span class=\"legend-title\">Color Key</span>\n    <div class=\"legend-item\"><div class=\"legend-swatch\" style=\"background:var(--factory-fill);border-color:var(--factory-stroke)\"></div>Factory Infrastructure</div>\n    <div class=\"legend-item\"><div class=\"legend-swatch\" style=\"background:var(--product-fill);border-color:var(--product-stroke)\"></div>Product Code</div>\n    <div class=\"legend-item\"><div class=\"legend-swatch\" style=\"background:var(--human-fill);border-color:var(--human-stroke)\"></div>Human Actions</div>\n    <div class=\"legend-item\"><div class=\"legend-swatch\" style=\"background:var(--attractor-fill);border-color:var(--attractor-stroke)\"></div>Attractor (Codex)</div>\n    <div class=\"legend-item\"><div class=\"legend-swatch\" style=\"background:var(--ci-fill);border-color:var(--ci-stroke)\"></div>CI Background</div>\n  </div>\n\n  <div class=\"layout\">\n\n    <!-- SVG Diagram -->\n    <div class=\"diagram-wrap\">\n      <svg viewBox=\"0 0 760 740\" xmlns=\"http://www.w3.org/2000/svg\" id=\"archSvg\">\n        <defs>\n          <marker id=\"arr\" viewBox=\"0 0 10 7\" refX=\"9\" refY=\"3.5\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto-start-reverse\"><path d=\"M0,0 L10,3.5 L0,7z\" fill=\"var(--text-muted)\"/></marker>\n          <marker id=\"arrBlue\" viewBox=\"0 0 10 7\" refX=\"9\" refY=\"3.5\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto-start-reverse\"><path d=\"M0,0 L10,3.5 L0,7z\" fill=\"var(--factory-stroke)\"/></marker>\n          <marker id=\"arrPurple\" viewBox=\"0 0 10 7\" refX=\"9\" refY=\"3.5\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto-start-reverse\"><path d=\"M0,0 L10,3.5 L0,7z\" fill=\"var(--attractor-stroke)\"/></marker>\n          <marker id=\"arrOrange\" viewBox=\"0 0 10 7\" refX=\"9\" refY=\"3.5\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto-start-reverse\"><path d=\"M0,0 L10,3.5 L0,7z\" fill=\"var(--orange)\"/></marker>\n          <marker id=\"arrGreen\" viewBox=\"0 0 10 7\" refX=\"9\" refY=\"3.5\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto-start-reverse\"><path d=\"M0,0 L10,3.5 L0,7z\" fill=\"var(--product-stroke)\"/></marker>\n          <filter id=\"ds\" x=\"-3%\" y=\"-3%\" width=\"106%\" height=\"106%\"><feDropShadow dx=\"0\" dy=\"1\" stdDeviation=\"2\" flood-opacity=\"0.07\"/></filter>\n        </defs>\n\n        <!-- ===== HUMAN ===== -->\n        <g class=\"node\" data-id=\"human\" onclick=\"showDetail('human')\" filter=\"url(#ds)\">\n          <rect x=\"200\" y=\"14\" width=\"360\" height=\"58\" rx=\"10\" fill=\"var(--human-fill)\" stroke=\"var(--human-stroke)\" stroke-width=\"2\"/>\n          <text x=\"380\" y=\"38\" text-anchor=\"middle\" font-size=\"14\" font-weight=\"700\" fill=\"var(--text)\">Human (Project Lead)</text>\n          <text x=\"380\" y=\"56\" text-anchor=\"middle\" font-size=\"10.5\" fill=\"var(--text-secondary)\">Authors /specs/ + /scenarios/ &#x2022; Invokes /factory-orchestrate &#x2022; Reviews PR</text>\n        </g>\n\n        <!-- Human -> Orchestrator -->\n        <line x1=\"380\" y1=\"72\" x2=\"380\" y2=\"98\" stroke=\"var(--text-muted)\" stroke-width=\"1.5\" marker-end=\"url(#arr)\"/>\n\n        <!-- ===== ORCHESTRATOR ===== -->\n        <g class=\"node\" data-id=\"orchestrator\" onclick=\"showDetail('orchestrator')\" filter=\"url(#ds)\">\n          <rect x=\"80\" y=\"100\" width=\"600\" height=\"50\" rx=\"10\" fill=\"var(--factory-fill)\" stroke=\"var(--factory-stroke)\" stroke-width=\"2\"/>\n          <text x=\"380\" y=\"122\" text-anchor=\"middle\" font-size=\"14\" font-weight=\"700\" fill=\"var(--text)\">Claude Code (Orchestrator)</text>\n          <text x=\"380\" y=\"140\" text-anchor=\"middle\" font-size=\"10.5\" fill=\"var(--text-secondary)\">.claude/skills/factory-orchestrate &#x2014; drives the convergence loop</text>\n        </g>\n\n        <!-- ===== CONVERGENCE LOOP BORDER ===== -->\n        <rect x=\"40\" y=\"166\" width=\"680\" height=\"432\" rx=\"12\" fill=\"none\" stroke=\"var(--factory-stroke)\" stroke-width=\"1\" stroke-dasharray=\"6,4\" opacity=\"0.35\"/>\n        <text x=\"58\" y=\"185\" font-size=\"10\" font-weight=\"700\" fill=\"var(--factory-stroke)\" opacity=\"0.6\" letter-spacing=\"0.8\">CONVERGENCE LOOP</text>\n\n        <!-- Step 1-3: Branch + Strip + Push -->\n        <g class=\"node\" data-id=\"step-branch\" onclick=\"showDetail('step-branch')\" filter=\"url(#ds)\">\n          <rect x=\"56\" y=\"198\" width=\"210\" height=\"56\" rx=\"8\" fill=\"var(--factory-fill)\" stroke=\"var(--factory-stroke)\" stroke-width=\"1.5\"/>\n          <circle cx=\"76\" cy=\"216\" r=\"10\" fill=\"var(--factory-stroke)\"/><text x=\"76\" y=\"220\" text-anchor=\"middle\" font-size=\"10\" font-weight=\"700\" fill=\"white\">1</text>\n          <text x=\"170\" y=\"220\" text-anchor=\"middle\" font-size=\"12\" font-weight=\"600\" fill=\"var(--text)\">Create Branch + Strip</text>\n          <text x=\"166\" y=\"240\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">df-crank-vXX &#x2022; strip_holdout.py &#x2022; push</text>\n        </g>\n\n        <!-- Arrow 1 -> 4 -->\n        <line x1=\"266\" y1=\"226\" x2=\"296\" y2=\"226\" stroke=\"var(--factory-stroke)\" stroke-width=\"1.5\" marker-end=\"url(#arrBlue)\"/>\n\n        <!-- Step 4: Invoke Codex -->\n        <g class=\"node\" data-id=\"step-codex\" onclick=\"showDetail('step-codex')\" filter=\"url(#ds)\">\n          <rect x=\"298\" y=\"198\" width=\"200\" height=\"56\" rx=\"8\" fill=\"var(--attractor-fill)\" stroke=\"var(--attractor-stroke)\" stroke-width=\"1.5\"/>\n          <circle cx=\"318\" cy=\"216\" r=\"10\" fill=\"var(--attractor-stroke)\"/><text x=\"318\" y=\"220\" text-anchor=\"middle\" font-size=\"10\" font-weight=\"700\" fill=\"white\">4</text>\n          <text x=\"406\" y=\"218\" text-anchor=\"middle\" font-size=\"12\" font-weight=\"600\" fill=\"var(--text)\">Invoke Codex</text>\n          <text x=\"398\" y=\"240\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">Browser automation &#x2022; ChatGPT Plus UI</text>\n        </g>\n\n        <!-- Arrow 4 -> Codex actor -->\n        <line x1=\"498\" y1=\"226\" x2=\"524\" y2=\"226\" stroke=\"var(--attractor-stroke)\" stroke-width=\"1.5\" marker-end=\"url(#arrPurple)\"/>\n\n        <!-- Codex Actor -->\n        <g class=\"node\" data-id=\"codex\" onclick=\"showDetail('codex')\" filter=\"url(#ds)\">\n          <rect x=\"526\" y=\"198\" width=\"178\" height=\"56\" rx=\"8\" fill=\"var(--attractor-fill)\" stroke=\"var(--attractor-stroke)\" stroke-width=\"2\"/>\n          <text x=\"615\" y=\"222\" text-anchor=\"middle\" font-size=\"13\" font-weight=\"700\" fill=\"var(--text)\">Codex (Attractor)</text>\n          <text x=\"615\" y=\"240\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">Creates codex-... branch</text>\n        </g>\n\n        <!-- Info boundary box around Codex -->\n        <rect x=\"518\" y=\"190\" width=\"194\" height=\"72\" rx=\"6\" fill=\"none\" stroke=\"var(--red)\" stroke-width=\"1.5\" stroke-dasharray=\"4,3\" opacity=\"0.45\"/>\n        <text x=\"615\" y=\"186\" text-anchor=\"middle\" font-size=\"8.5\" font-weight=\"700\" fill=\"var(--red)\" opacity=\"0.6\" letter-spacing=\"0.3\">INFORMATION BOUNDARY</text>\n\n        <!-- Codex -> Gate 0 -->\n        <path d=\"M615,254 L615,282\" stroke=\"var(--attractor-stroke)\" stroke-width=\"1.5\" fill=\"none\" marker-end=\"url(#arrPurple)\"/>\n\n        <!-- Step 6: Gate 0 -->\n        <g class=\"node\" data-id=\"step-gate0\" onclick=\"showDetail('step-gate0')\" filter=\"url(#ds)\">\n          <rect x=\"260\" y=\"284\" width=\"340\" height=\"56\" rx=\"8\" fill=\"var(--factory-fill)\" stroke=\"var(--factory-stroke)\" stroke-width=\"1.5\"/>\n          <circle cx=\"280\" cy=\"302\" r=\"10\" fill=\"var(--factory-stroke)\"/><text x=\"280\" y=\"306\" text-anchor=\"middle\" font-size=\"10\" font-weight=\"700\" fill=\"white\">4</text>\n          <text x=\"438\" y=\"304\" text-anchor=\"middle\" font-size=\"12\" font-weight=\"600\" fill=\"var(--text)\">Gate 0: Adversarial Review (Agent Team)</text>\n          <text x=\"430\" y=\"326\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">Tool agents (parallel) + semantic reviewer &#x2022; fail-fast on CRITICAL &#x2022; then merge</text>\n        </g>\n\n        <!-- Gate 0 -> Restore + Gate 1 -->\n        <path d=\"M430,340 L430,364\" stroke=\"var(--factory-stroke)\" stroke-width=\"1.5\" fill=\"none\" marker-end=\"url(#arrBlue)\"/>\n\n        <!-- Step 8-9: Restore + Gate 1 -->\n        <g class=\"node\" data-id=\"step-gate1\" onclick=\"showDetail('step-gate1')\" filter=\"url(#ds)\">\n          <rect x=\"56\" y=\"366\" width=\"300\" height=\"56\" rx=\"8\" fill=\"var(--product-fill)\" stroke=\"var(--product-stroke)\" stroke-width=\"1.5\"/>\n          <circle cx=\"76\" cy=\"384\" r=\"10\" fill=\"var(--product-stroke)\"/><text x=\"76\" y=\"388\" text-anchor=\"middle\" font-size=\"10\" font-weight=\"700\" fill=\"white\">8</text>\n          <text x=\"214\" y=\"386\" text-anchor=\"middle\" font-size=\"12\" font-weight=\"600\" fill=\"var(--text)\">Restore Holdout + Gate 1</text>\n          <text x=\"206\" y=\"406\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">restore_holdout.py &#x2022; make lint &#x2022; typecheck &#x2022; test</text>\n        </g>\n\n        <!-- Step 10-11: Gate 2 + Gate 3 -->\n        <g class=\"node\" data-id=\"step-gate23\" onclick=\"showDetail('step-gate23')\" filter=\"url(#ds)\">\n          <rect x=\"370\" y=\"366\" width=\"334\" height=\"56\" rx=\"8\" fill=\"var(--product-fill)\" stroke=\"var(--product-stroke)\" stroke-width=\"1.5\"/>\n          <circle cx=\"390\" cy=\"384\" r=\"10\" fill=\"var(--product-stroke)\"/><text x=\"390\" y=\"388\" text-anchor=\"middle\" font-size=\"10\" font-weight=\"700\" fill=\"white\">10</text>\n          <text x=\"545\" y=\"386\" text-anchor=\"middle\" font-size=\"12\" font-weight=\"600\" fill=\"var(--text)\">Gate 2 (NFR) + Gate 3 (Holdout)</text>\n          <text x=\"537\" y=\"406\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">nfr_checks.py &#x2022; run_scenarios.py &#x2022; satisfaction score</text>\n        </g>\n\n        <!-- Arrows between gate rows -->\n        <line x1=\"356\" y1=\"394\" x2=\"370\" y2=\"394\" stroke=\"var(--product-stroke)\" stroke-width=\"1.5\" marker-end=\"url(#arrGreen)\"/>\n\n        <!-- Gates -> LLM Judge -->\n        <path d=\"M206,422 L206,448\" stroke=\"var(--factory-stroke)\" stroke-width=\"1.5\" fill=\"none\" marker-end=\"url(#arrBlue)\"/>\n        <path d=\"M537,422 L537,448\" stroke=\"var(--factory-stroke)\" stroke-width=\"1.5\" fill=\"none\" marker-end=\"url(#arrBlue)\"/>\n\n        <!-- Step 12: LLM-as-Judge -->\n        <g class=\"node\" data-id=\"step-judge\" onclick=\"showDetail('step-judge')\" filter=\"url(#ds)\">\n          <rect x=\"160\" y=\"450\" width=\"440\" height=\"52\" rx=\"8\" fill=\"var(--factory-fill)\" stroke=\"var(--factory-stroke)\" stroke-width=\"2\"/>\n          <circle cx=\"180\" cy=\"470\" r=\"10\" fill=\"var(--factory-stroke)\"/><text x=\"180\" y=\"474\" text-anchor=\"middle\" font-size=\"10\" font-weight=\"700\" fill=\"white\">12</text>\n          <text x=\"388\" y=\"472\" text-anchor=\"middle\" font-size=\"13\" font-weight=\"700\" fill=\"var(--text)\">LLM-as-Judge: Holistic Evaluation</text>\n          <text x=\"380\" y=\"490\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">Trajectory &#x2022; systemic issues &#x2022; gaming detection &#x2022; go/no-go</text>\n        </g>\n\n        <!-- Judge -> Decision diamond -->\n        <path d=\"M380,502 L380,524\" stroke=\"var(--factory-stroke)\" stroke-width=\"1.5\" fill=\"none\" marker-end=\"url(#arrBlue)\"/>\n\n        <!-- Decision diamond -->\n        <g class=\"node\" data-id=\"step-decision\" onclick=\"showDetail('step-decision')\">\n          <polygon points=\"380,526 418,550 380,574 342,550\" fill=\"var(--factory-fill)\" stroke=\"var(--factory-stroke)\" stroke-width=\"2\"/>\n          <text x=\"380\" y=\"554\" text-anchor=\"middle\" font-size=\"11\" font-weight=\"700\" fill=\"var(--text)\">13</text>\n        </g>\n\n        <!-- Satisfied path -> PR -->\n        <g class=\"node\" data-id=\"step-pr\" onclick=\"showDetail('step-pr')\" filter=\"url(#ds)\">\n          <rect x=\"478\" y=\"534\" width=\"218\" height=\"44\" rx=\"8\" fill=\"var(--human-fill)\" stroke=\"var(--human-stroke)\" stroke-width=\"2\"/>\n          <text x=\"587\" y=\"553\" text-anchor=\"middle\" font-size=\"12\" font-weight=\"700\" fill=\"var(--text)\">Create PR</text>\n          <text x=\"587\" y=\"569\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">Accept / Merge Gate (human)</text>\n        </g>\n        <line x1=\"418\" y1=\"550\" x2=\"476\" y2=\"550\" stroke=\"var(--human-stroke)\" stroke-width=\"1.5\" marker-end=\"url(#arr)\"/>\n        <text x=\"440\" y=\"542\" font-size=\"9\" fill=\"var(--green)\" font-weight=\"700\">SATISFIED</text>\n\n        <!-- Feedback loop arrow: left side, back to step 1 -->\n        <path d=\"M342,550 L66,550 L66,226 L56,226\" stroke=\"var(--orange)\" stroke-width=\"2.5\" fill=\"none\" stroke-dasharray=\"7,4\"/>\n        <polygon points=\"56,219 70,226 56,233\" fill=\"var(--orange)\"/>\n        <text x=\"82\" y=\"544\" font-size=\"9\" fill=\"var(--orange)\" font-weight=\"700\">FEEDBACK LOOP</text>\n        <text x=\"56\" y=\"500\" font-size=\"8.5\" fill=\"var(--orange)\" opacity=\"0.7\" transform=\"rotate(-90,56,500)\">compile feedback &#x2192; loop</text>\n\n        <!-- ===== CI BACKGROUND ===== -->\n        <g class=\"node\" data-id=\"ci\" onclick=\"showDetail('ci')\" filter=\"url(#ds)\">\n          <rect x=\"56\" y=\"614\" width=\"648\" height=\"54\" rx=\"10\" fill=\"var(--ci-fill)\" stroke=\"var(--ci-stroke)\" stroke-width=\"1.5\" stroke-dasharray=\"6,3\"/>\n          <text x=\"380\" y=\"636\" text-anchor=\"middle\" font-size=\"13\" font-weight=\"700\" fill=\"var(--text)\">CI Validation (Background)</text>\n          <text x=\"380\" y=\"654\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">Runs on push to factory/** or df-crank-** &#x2022; Gates 1-3 &#x2022; feedback compilation</text>\n        </g>\n        <!-- CI dashed link to loop -->\n        <path d=\"M380,614 L380,598\" stroke=\"var(--ci-stroke)\" stroke-width=\"1\" stroke-dasharray=\"3,3\" marker-end=\"url(#arr)\"/>\n        <text x=\"395\" y=\"610\" font-size=\"8\" fill=\"var(--text-muted)\">reads results</text>\n\n        <!-- Step numbers guide at bottom -->\n        <text x=\"380\" y=\"698\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-muted)\">1-2: branch + strip &#x2022; 3: invoke Codex &#x2022; 4: Gate 0 agent team &#x2022; 5: merge &#x2022; 6-7: restore + Gate 1 &#x2022; 8-9: Gates 2-3 &#x2022; 10: LLM judge &#x2022; 11-12: PR + review pack</text>\n      </svg>\n    </div>\n\n    <!-- Right Column -->\n    <div>\n      <!-- Detail Panel -->\n      <div class=\"panel\" id=\"detailPanel\">\n        <div class=\"panel-header\"><h2>Component Detail</h2></div>\n        <div class=\"panel-empty\" id=\"panelEmpty\">Click any component in the diagram to see its details, key files, and information boundary notes.</div>\n        <div class=\"panel-body\" id=\"panelBody\" style=\"display:none\"></div>\n      </div>\n\n      <!-- Layered Defense -->\n      <div class=\"sidebar-section\">\n        <div class=\"sidebar-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n          <h3>Layered Defense</h3><span class=\"chevron\">&#9660;</span>\n        </div>\n        <div class=\"sidebar-body\">\n          <div class=\"defense-layer\">\n            <div class=\"defense-num\">1</div>\n            <div class=\"defense-text\"><strong>Gate 0: Tool Agents</strong> &mdash; Deterministic, parallel. ruff (lint), radon (complexity), vulture (dead code), bandit (security), check_test_quality.py (vacuous tests). Fast, cheap, catches obvious violations in seconds.</div>\n          </div>\n          <div class=\"defense-layer\">\n            <div class=\"defense-num\">2</div>\n            <div class=\"defense-text\"><strong>Gate 0: Semantic Reviewer</strong> &mdash; LLM judgment, runs in parallel with tool agents. Catches subtle gaming, architectural dishonesty, spec violations, integration gaps the tools miss.</div>\n          </div>\n          <div class=\"defense-layer\">\n            <div class=\"defense-num\">3</div>\n            <div class=\"defense-text\"><strong>Gate 3: Holdout Scenarios</strong> &mdash; Ground truth. The attractor never sees these criteria. Verifies actual behavior against human-authored expectations.</div>\n          </div>\n        </div>\n      </div>\n\n      <!-- Information Boundaries -->\n      <div class=\"sidebar-section\">\n        <div class=\"sidebar-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n          <h3>Information Boundaries</h3><span class=\"chevron\">&#9660;</span>\n        </div>\n        <div class=\"sidebar-body\">\n          <div class=\"boundary-item\">\n            <div class=\"boundary-label\" style=\"color:var(--green)\">Codex CAN see</div>\n            <div class=\"boundary-desc\">/specs/, feedback_iter_N.md, its own code, src/, tests/, Makefile</div>\n          </div>\n          <div class=\"boundary-item\">\n            <div class=\"boundary-label\" style=\"color:var(--red)\">Codex NEVER sees</div>\n            <div class=\"boundary-desc\">/scenarios/ (stripped), pr_review_pack.html, pr_diff_data.json, adversarial findings</div>\n          </div>\n          <div class=\"boundary-item\">\n            <div class=\"boundary-label\" style=\"color:var(--blue)\">Mechanism</div>\n            <div class=\"boundary-desc\">Branch stripping &mdash; scenarios physically absent from the pushed branch. Not filesystem hiding; a real information gate.</div>\n          </div>\n        </div>\n      </div>\n\n      <!-- Agent Teams -->\n      <div class=\"sidebar-section\">\n        <div class=\"sidebar-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n          <h3>Claude Code Agent Teams</h3><span class=\"chevron\">&#9660;</span>\n        </div>\n        <div class=\"sidebar-body\">\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--blue)\"></div><div><div class=\"agent-name\">Main Orchestrator</div><div class=\"agent-role\">Drives convergence loop, invokes Codex via browser, holistic decisions</div></div></div>\n          <div style=\"margin:8px 0 4px;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px\">Gate 0 Agent Team (parallel)</div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--blue)\"></div><div><div class=\"agent-name\">ruff-agent</div><div class=\"agent-role\">Lint violations, style, import issues</div></div></div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--blue)\"></div><div><div class=\"agent-name\">radon-agent</div><div class=\"agent-role\">Cyclomatic complexity &gt; threshold</div></div></div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--blue)\"></div><div><div class=\"agent-name\">vulture-agent</div><div class=\"agent-role\">Unreachable code, unused functions</div></div></div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--blue)\"></div><div><div class=\"agent-name\">bandit-agent</div><div class=\"agent-role\">Security vulnerabilities</div></div></div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--blue)\"></div><div><div class=\"agent-name\">test-quality-agent</div><div class=\"agent-role\">Vacuous tests, stub assertions, mock abuse</div></div></div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--red)\"></div><div><div class=\"agent-name\">adversarial-reviewer</div><div class=\"agent-role\">Semantic review &mdash; gaming, architectural dishonesty, spec violations</div></div></div>\n          <div style=\"margin:8px 0 4px;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px\">PR Review Pack</div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--purple)\"></div><div><div class=\"agent-name\">Diff Analysis Agent</div><div class=\"agent-role\">Pass 1 &mdash; deterministic file-to-zone mapping</div></div></div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--green)\"></div><div><div class=\"agent-name\">Semantic Analysis Agent</div><div class=\"agent-role\">Pass 2 &mdash; what-changed summaries, decisions, findings</div></div></div>\n          <div style=\"margin:8px 0 4px;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px\">Documentation</div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--orange)\"></div><div><div class=\"agent-name\">Documentation Sweep</div><div class=\"agent-role\">Ensures all affected documentation layers are updated before PR ships</div></div></div>\n        </div>\n      </div>\n    </div>\n\n  </div>\n\n  <div class=\"footer\">Architecture as of PR #5 (factory/v1 &rarr; main) &mdash; Gate 0 agent team + PR review pack skill added</div>\n\n</div>\n\n<script>\nconst C = {\n  human: {\n    title: 'Human (Project Lead)',\n    desc: 'The single human in the loop. Authors specifications that define what the system should do and scenarios that define how to evaluate it. Invokes the factory via the /factory-orchestrate skill in Claude Code. Reviews the final PR at the accept/merge gate \\u2014 the only point where a human decision is required.',\n    files: [\n      { n: '/specs/*.md', c: 'human' },\n      { n: '/scenarios/*.md', c: 'human' },\n    ],\n    tags: [{ t: 'Accept/Merge Gate', c: 'gate' }],\n    boundary: 'Owns scenarios \\u2014 the ground truth that the attractor never sees. The merge decision is always human; the factory never auto-merges.'\n  },\n  orchestrator: {\n    title: 'Claude Code (Orchestrator)',\n    desc: 'The factory orchestrator. Runs the entire convergence loop via the /factory-orchestrate skill. Uses browser automation to invoke Codex through ChatGPT Plus \\u2014 no API key needed. Drives adversarial review (Gate 0), makes holistic judgment calls (LLM-as-Judge), creates PRs. CI provides background validation; Claude Code orchestrates.',\n    files: [\n      { n: '.claude/skills/factory-orchestrate/', c: 'factory' },\n      { n: 'scripts/strip_holdout.py', c: 'factory' },\n      { n: 'scripts/restore_holdout.py', c: 'factory' },\n      { n: 'scripts/compile_feedback.py', c: 'factory' },\n      { n: 'docs/code_quality_standards.md', c: 'factory' },\n      { n: 'CLAUDE.md', c: 'factory' },\n    ],\n    tags: [{ t: 'Gate 0', c: 'gate' }, { t: 'LLM-as-Judge', c: 'gate' }, { t: 'Orchestrator', c: 'info' }],\n    boundary: 'Full visibility \\u2014 sees everything including scenarios, adversarial findings, and all gate outputs across all iterations.'\n  },\n  codex: {\n    title: 'Codex (Attractor)',\n    desc: 'The code generator. Invoked via browser automation through the ChatGPT Plus UI. Works on a stripped branch where scenarios have been physically removed. Reads specs and iteration feedback to produce code. Creates its own codex-... branch. Never touches factory infrastructure.',\n    files: [\n      { n: '/specs/*.md (reads)', c: 'human' },\n      { n: 'artifacts/factory/feedback_iter_N.md (reads)', c: 'factory' },\n      { n: 'src/, tests/, configs/, Makefile (writes)', c: 'product' },\n      { n: '.github/codex/prompts/factory_fix.md', c: 'factory' },\n    ],\n    tags: [{ t: 'Information Boundary', c: 'boundary' }, { t: 'Attractor', c: 'info' }],\n    boundary: 'NEVER sees /scenarios/, pr_review_pack.html, pr_diff_data.json, or adversarial findings. Branch stripping creates a real information gate \\u2014 files do not exist on the branch Codex works on.'\n  },\n  'step-branch': {\n    title: 'Steps 1\\u20133: Branch + Strip + Push',\n    desc: 'Creates a new df-crank-vXX branch. Runs strip_holdout.py to remove /scenarios/ and review pack artifacts. Commits with marker [factory:holdout-stripped]. Pushes the stripped branch to origin. This is where the information boundary is created.',\n    files: [\n      { n: 'scripts/strip_holdout.py', c: 'factory' },\n      { n: 'scripts/restore_holdout.py', c: 'factory' },\n    ],\n    tags: [{ t: 'Information Boundary', c: 'boundary' }, { t: 'Branch Stripping', c: 'info' }],\n    boundary: 'Scenarios physically absent from the pushed branch. Not filesystem hiding \\u2014 a real gate. There is nothing to read, no path to guess, no hidden directory to discover.'\n  },\n  'step-codex': {\n    title: 'Step 4: Invoke Codex via Browser',\n    desc: 'Claude Code uses browser automation (MCP tools) to invoke Codex through the ChatGPT Plus UI. No API key needed \\u2014 browser automation is the primary path. Codex reads specs and prior feedback, produces code on its own codex-... branch.',\n    files: [\n      { n: '.claude/skills/factory-orchestrate/', c: 'factory' },\n      { n: '.github/codex/prompts/factory_fix.md', c: 'factory' },\n    ],\n    tags: [{ t: 'Browser Automation', c: 'info' }],\n    boundary: 'Codex works on the stripped branch \\u2014 cannot access scenarios or adversarial findings by design.'\n  },\n  'step-gate0': {\n    title: 'Gate 0: Two-Tier Code Review (Script + Agent Team)',\n    desc: 'Tier 1: scripts/run_gate0.py runs all 5 deterministic tool checks in parallel (ruff, radon, vulture, bandit, test-quality) and produces gate0_results.json. Tier 2: 4 LLM agents (code-health, security, test-integrity, adversarial) review the same paradigms at semantic depth, building on tier 1 output. Any CRITICAL finding from either tier blocks the pipeline.',\n    files: [\n      { n: 'scripts/run_gate0.py (tier 1 runner)', c: 'factory' },\n      { n: '.claude/skills/factory-orchestrate/review-prompts/ (tier 2 agent docs)', c: 'factory' },\n      { n: 'docs/code_quality_standards.md', c: 'factory' },\n    ],\n    tags: [{ t: 'Gate 0', c: 'gate' }, { t: 'Two-Tier', c: 'info' }, { t: 'Fail-Fast', c: 'boundary' }],\n    boundary: 'Layered defense: tool agents catch cheap/obvious violations fast, semantic reviewer catches subtle gaming and architectural dishonesty. Both run in parallel. Gate 3 holdout scenarios verify actual behavior as ground truth.'\n  },\n  'step-gate1': {\n    title: 'Steps 8\\u20139: Restore Holdout + Gate 1',\n    desc: 'Restores holdout scenarios from origin/main using restore_holdout.py (intentionally does NOT restore review pack artifacts). Then runs deterministic Gate 1: make lint (ruff), make typecheck (mypy), make test (pytest). If any fail, Gates 2\\u20133 are skipped.',\n    files: [\n      { n: 'scripts/restore_holdout.py', c: 'factory' },\n      { n: 'Makefile (lint, typecheck, test)', c: 'product' },\n    ],\n    tags: [{ t: 'Gate 1', c: 'gate' }, { t: 'Deterministic', c: 'info' }],\n    boundary: 'Scenarios restored here \\u2014 but only after Codex can no longer see the branch.'\n  },\n  'step-gate23': {\n    title: 'Steps 10\\u201311: Gate 2 + Gate 3',\n    desc: 'Gate 2: NFR checks via nfr_checks.py \\u2014 code quality (ruff extended), complexity (radon), dead code (vulture), security (bandit). Non-blocking; feeds into LLM evaluation. Gate 3: Behavioral scenarios via run_scenarios.py \\u2014 executes holdout scenarios. Produces a satisfaction score: passed / total.',\n    files: [\n      { n: 'scripts/nfr_checks.py', c: 'factory' },\n      { n: 'scripts/run_scenarios.py', c: 'factory' },\n      { n: '/scenarios/*.md', c: 'human' },\n    ],\n    tags: [{ t: 'Gate 2 (non-blocking)', c: 'gate' }, { t: 'Gate 3 (holdout)', c: 'gate' }, { t: 'Defense Layer 3', c: 'boundary' }],\n    boundary: 'Gate 3 is the ground truth \\u2014 scenarios the attractor never saw. Defense layer 3: verifies actual behavior against human-authored expectations.'\n  },\n  'step-judge': {\n    title: 'Step 12: LLM-as-Judge',\n    desc: 'Claude Code reasons holistically through ALL gate outputs. Not just \"score >= threshold\" \\u2014 considers trajectory across iterations, systemic issues, Gate 2 warnings, whether fixes are real or whether Codex is gaming. Makes the holistic go/no-go decision.',\n    files: [\n      { n: 'artifacts/factory/feedback_iter_*.md', c: 'factory' },\n      { n: 'artifacts/factory/scenario_results.json', c: 'factory' },\n    ],\n    tags: [{ t: 'LLM-as-Judge', c: 'gate' }, { t: 'Holistic Decision', c: 'info' }],\n    boundary: 'Full visibility into all gates, all iterations, all findings. The judge sees everything the attractor does not.'\n  },\n  'step-decision': {\n    title: 'Step 13: Converge or Loop',\n    desc: 'The decision point. If the LLM-as-Judge is satisfied: create a PR with factory-converged and accept-merge-gate labels. If not: compile detailed feedback into feedback_iter_N.md and loop back to step 1 with a new branch version.',\n    files: [\n      { n: 'artifacts/factory/feedback_iter_N.md', c: 'factory' },\n      { n: 'scripts/compile_feedback.py', c: 'factory' },\n    ],\n    tags: [{ t: 'Decision Point', c: 'info' }],\n    boundary: 'Feedback file is visible to Codex in the next iteration \\u2014 but stripped of scenario details and adversarial findings.'\n  },\n  'step-pr': {\n    title: 'Accept / Merge Gate + PR Review Pack',\n    desc: 'The single human decision point. The factory creates a PR, then generates a PR review pack via the /pr-review-pack skill \\u2014 a self-contained interactive HTML file. Joey reviews the report, not the code. The review pack provides architecture diagrams, adversarial findings, CI performance, key decisions, convergence status, and post-merge items.',\n    files: [\n      { n: '.claude/skills/pr-review-pack/ (skill)', c: 'factory' },\n      { n: 'docs/pr_review_pack.html (output)', c: 'factory' },\n      { n: 'docs/pr_diff_data.json (output)', c: 'factory' },\n    ],\n    tags: [{ t: 'Human Gate', c: 'gate' }, { t: 'Never Auto-Merges', c: 'boundary' }],\n    boundary: 'Code was never reviewed by humans during production. The PR review pack is the artifact that communicates factory status to the human. Without it, the accept/merge gate is a rubber stamp.'\n  },\n  ci: {\n    title: 'CI Validation (Background)',\n    desc: 'GitHub Actions (.github/workflows/factory.yaml) runs validation on every push to factory/** or df-crank-** branches. Executes Gates 1\\u20133 plus feedback compilation. CI validates \\u2014 it does not orchestrate. Claude Code reads CI results as input to its decisions.',\n    files: [\n      { n: '.github/workflows/factory.yaml', c: 'ci' },\n      { n: 'scripts/run_scenarios.py', c: 'factory' },\n      { n: 'scripts/compile_feedback.py', c: 'factory' },\n      { n: 'scripts/nfr_checks.py', c: 'factory' },\n    ],\n    tags: [{ t: 'Gates 1\\u20133', c: 'gate' }, { t: 'Background Validation', c: 'info' }],\n    boundary: 'Runs on pushed branches. CI does not orchestrate \\u2014 it provides signal that the orchestrator consumes.'\n  }\n};\n\nfunction showDetail(id) {\n  const c = C[id];\n  if (!c) return;\n  document.querySelectorAll('.node').forEach(n => {\n    n.classList.remove('active','dimmed');\n    if (n.dataset.id !== id) n.classList.add('dimmed');\n  });\n  const active = document.querySelector('.node[data-id=\"'+id+'\"]');\n  if (active) active.classList.add('active');\n  document.getElementById('panelEmpty').style.display = 'none';\n  const body = document.getElementById('panelBody');\n  body.style.display = 'block';\n  const tags = c.tags.map(t => '<span class=\"detail-tag '+t.c+'\">'+t.t+'</span>').join('');\n  const files = c.files.map(f => '<li class=\"'+f.c+'\">'+f.n+'</li>').join('');\n  body.innerHTML =\n    '<div class=\"detail-title\">'+c.title+'</div>'+\n    '<div class=\"detail-desc\">'+c.desc+'</div>'+\n    (tags ? '<div style=\"margin-bottom:14px\">'+tags+'</div>' : '')+\n    (c.files.length ? '<div class=\"detail-section\"><div class=\"detail-section-title\">Key Files</div><ul class=\"detail-list\">'+files+'</ul></div>' : '')+\n    (c.boundary ? '<div class=\"detail-section\"><div class=\"detail-section-title\">Information Boundary</div><div style=\"font-size:12px;color:var(--text-secondary);line-height:1.6\">'+c.boundary+'</div></div>' : '');\n}\n\ndocument.getElementById('archSvg').addEventListener('click', function(e) {\n  if (!e.target.closest('.node')) {\n    document.querySelectorAll('.node').forEach(n => n.classList.remove('active','dimmed'));\n    document.getElementById('panelEmpty').style.display = 'block';\n    document.getElementById('panelBody').style.display = 'none';\n  }\n});\n\nfunction setTheme(m) {\n  document.querySelectorAll('.theme-toggle button').forEach(b => b.classList.remove('active'));\n  const btns = document.querySelectorAll('.theme-toggle button');\n  if (m==='light') { document.documentElement.setAttribute('data-theme','light'); btns[0].classList.add('active'); }\n  else if (m==='dark') { document.documentElement.setAttribute('data-theme','dark'); btns[1].classList.add('active'); }\n  else { document.documentElement.removeAttribute('data-theme'); btns[2].classList.add('active'); applySys(); }\n  localStorage.setItem('archTheme',m);\n}\nfunction applySys() {\n  if (window.matchMedia('(prefers-color-scheme:dark)').matches) document.documentElement.setAttribute('data-theme','dark');\n  else document.documentElement.removeAttribute('data-theme');\n}\n(function(){\n  var s = localStorage.getItem('archTheme') || 'system';\n  setTheme(s);\n  window.matchMedia('(prefers-color-scheme:dark)').addEventListener('change', function(){\n    if ((localStorage.getItem('archTheme')||'system')==='system') applySys();\n  });\n})();\n</script>\n</body>\n</html>\n",
      "base": "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<title>Dark Factory \u2014 Architecture</title>\n<style>\n  :root {\n    --green: #22c55e; --green-bg: #f0fdf4; --green-border: #86efac;\n    --yellow: #eab308; --yellow-bg: #fefce8;\n    --orange: #f97316; --orange-bg: #fff7ed; --orange-border: #fdba74;\n    --red: #ef4444; --red-bg: #fef2f2;\n    --gray: #6b7280; --gray-bg: #f9fafb; --gray-border: #e5e7eb;\n    --blue: #3b82f6; --blue-bg: #eff6ff; --blue-border: #93c5fd;\n    --purple: #8b5cf6; --purple-bg: #f5f3ff; --purple-border: #c4b5fd;\n    --text: #1f2937; --text-secondary: #6b7280; --text-muted: #9ca3af;\n    --border: #e5e7eb; --bg: #f3f4f6; --surface: #ffffff;\n    --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;\n    --factory-fill: #dbeafe; --factory-stroke: #3b82f6;\n    --product-fill: #dcfce7; --product-stroke: #22c55e;\n    --human-fill: #ffedd5; --human-stroke: #f97316;\n    --attractor-fill: #ede9fe; --attractor-stroke: #8b5cf6;\n    --ci-fill: #f3f4f6; --ci-stroke: #6b7280;\n  }\n  [data-theme=\"dark\"] {\n    --text: #e5e7eb; --text-secondary: #9ca3af; --text-muted: #6b7280;\n    --border: #374151; --bg: #111827; --surface: #1f2937;\n    --gray-bg: #1f2937; --gray-border: #374151; --gray: #9ca3af;\n    --green-bg: #064e3b; --green-border: #10b981;\n    --yellow-bg: #713f12; --red-bg: #7f1d1d; --orange-bg: #7c2d12;\n    --blue-bg: #1e3a5f; --blue-border: #60a5fa;\n    --purple-bg: #2e1065; --purple-border: #a78bfa;\n    --factory-fill: #1e3a5f; --factory-stroke: #60a5fa;\n    --product-fill: #064e3b; --product-stroke: #34d399;\n    --human-fill: #7c2d12; --human-stroke: #fb923c;\n    --attractor-fill: #2e1065; --attractor-stroke: #a78bfa;\n    --ci-fill: #374151; --ci-stroke: #9ca3af;\n  }\n\n  * { box-sizing: border-box; margin: 0; padding: 0; }\n  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: var(--text); background: var(--bg); line-height: 1.5; font-size: 14px; }\n  .container { max-width: 1240px; margin: 0 auto; padding: 24px 16px; }\n\n  /* Header */\n  .header { background: var(--surface); border-radius: 12px; padding: 24px; margin-bottom: 20px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: flex-start; }\n  .header h1 { font-size: 22px; font-weight: 700; margin-bottom: 2px; }\n  .header .subtitle { font-size: 14px; color: var(--text-secondary); }\n  .theme-toggle { display: inline-flex; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }\n  .theme-toggle button { border: none; background: transparent; padding: 5px 11px; font-size: 14px; cursor: pointer; color: var(--text-secondary); transition: background 0.15s, color 0.15s; line-height: 1; }\n  .theme-toggle button:hover { background: var(--gray-bg); }\n  .theme-toggle button.active { background: var(--blue); color: white; }\n  .theme-toggle button:not(:last-child) { border-right: 1px solid var(--border); }\n\n  /* Legend */\n  .legend { background: var(--surface); border-radius: 12px; padding: 14px 24px; margin-bottom: 20px; border: 1px solid var(--border); display: flex; gap: 24px; flex-wrap: wrap; align-items: center; }\n  .legend-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-right: 4px; }\n  .legend-item { display: flex; align-items: center; gap: 7px; font-size: 13px; font-weight: 500; }\n  .legend-swatch { width: 14px; height: 14px; border-radius: 4px; border: 2px solid; }\n\n  /* Main layout */\n  .layout { display: grid; grid-template-columns: 1fr 340px; gap: 20px; align-items: start; }\n  @media (max-width: 960px) { .layout { grid-template-columns: 1fr; } }\n\n  /* Diagram */\n  .diagram-wrap { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); padding: 16px; overflow: hidden; }\n  .diagram-wrap svg { width: 100%; height: auto; display: block; }\n  .diagram-wrap svg text { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }\n\n  /* Detail panel */\n  .panel { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; position: sticky; top: 24px; }\n  .panel-header { padding: 14px 20px; border-bottom: 1px solid var(--border); }\n  .panel-header h2 { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }\n  .panel-body { padding: 20px; }\n  .panel-empty { padding: 40px 20px; text-align: center; color: var(--text-muted); font-size: 13px; }\n  .detail-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; }\n  .detail-desc { font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.6; }\n  .detail-section { margin-bottom: 14px; }\n  .detail-section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 6px; }\n  .detail-list { list-style: none; padding: 0; }\n  .detail-list li { font-size: 12px; font-family: var(--mono); color: var(--text-secondary); padding: 3px 0; display: flex; align-items: center; gap: 8px; }\n  .detail-list li::before { content: ''; width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }\n  .detail-list li.factory::before { background: var(--blue); }\n  .detail-list li.product::before { background: var(--green); }\n  .detail-list li.human::before { background: var(--orange); }\n  .detail-list li.attractor::before { background: var(--purple); }\n  .detail-list li.ci::before { background: var(--gray); }\n  .detail-tag { display: inline-block; font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 4px; margin-right: 4px; margin-bottom: 4px; }\n  .detail-tag.gate { background: var(--blue-bg); color: var(--blue); }\n  .detail-tag.boundary { background: var(--red-bg); color: var(--red); }\n  .detail-tag.info { background: var(--gray-bg); color: var(--gray); }\n\n  /* Sidebar sections */\n  .sidebar-section { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); margin-top: 16px; overflow: hidden; }\n  .sidebar-header { padding: 14px 20px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; transition: background 0.15s; }\n  .sidebar-header:hover { background: var(--gray-bg); }\n  .sidebar-header h3 { font-size: 13px; font-weight: 700; }\n  .sidebar-header .chevron { font-size: 14px; color: var(--text-secondary); transition: transform 0.2s; }\n  .sidebar-section.collapsed .sidebar-body { display: none; }\n  .sidebar-section.collapsed .chevron { transform: rotate(-90deg); }\n  .sidebar-body { padding: 16px 20px; font-size: 13px; }\n  .defense-layer { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }\n  .defense-layer:last-child { border-bottom: none; }\n  .defense-num { width: 22px; height: 22px; border-radius: 50%; background: var(--blue); color: white; font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }\n  .defense-text { font-size: 12px; line-height: 1.5; }\n  .defense-text strong { font-weight: 600; }\n  .boundary-item { padding: 8px 0; border-bottom: 1px solid var(--border); }\n  .boundary-item:last-child { border-bottom: none; }\n  .boundary-label { font-size: 12px; font-weight: 600; margin-bottom: 2px; }\n  .boundary-desc { font-size: 12px; color: var(--text-secondary); }\n  .agent-item { display: flex; align-items: flex-start; gap: 8px; padding: 7px 0; }\n  .agent-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 5px; }\n  .agent-name { font-size: 12px; font-weight: 600; }\n  .agent-role { font-size: 11px; color: var(--text-secondary); }\n\n  /* Footer */\n  .footer { text-align: center; padding: 24px; font-size: 12px; color: var(--text-muted); }\n\n  /* SVG interactive */\n  .node { cursor: pointer; transition: filter 0.15s, opacity 0.15s; }\n  .node:hover { filter: brightness(0.94); }\n  .node.active { filter: brightness(0.88); }\n  .node.dimmed { opacity: 0.2; }\n</style>\n</head>\n<body>\n\n<div class=\"container\">\n\n  <div class=\"header\">\n    <div>\n      <h1>Dark Factory &mdash; Architecture</h1>\n      <div class=\"subtitle\">Claude Code + Agent Teams Orchestration Model</div>\n    </div>\n    <div class=\"theme-toggle\" id=\"themeToggle\">\n      <button onclick=\"setTheme('light')\" title=\"Light\">&#9788;</button>\n      <button onclick=\"setTheme('dark')\" title=\"Dark\">&#9790;</button>\n      <button onclick=\"setTheme('system')\" title=\"System\" class=\"active\">&#9881;</button>\n    </div>\n  </div>\n\n  <div class=\"legend\">\n    <span class=\"legend-title\">Color Key</span>\n    <div class=\"legend-item\"><div class=\"legend-swatch\" style=\"background:var(--factory-fill);border-color:var(--factory-stroke)\"></div>Factory Infrastructure</div>\n    <div class=\"legend-item\"><div class=\"legend-swatch\" style=\"background:var(--product-fill);border-color:var(--product-stroke)\"></div>Product Code</div>\n    <div class=\"legend-item\"><div class=\"legend-swatch\" style=\"background:var(--human-fill);border-color:var(--human-stroke)\"></div>Human Actions</div>\n    <div class=\"legend-item\"><div class=\"legend-swatch\" style=\"background:var(--attractor-fill);border-color:var(--attractor-stroke)\"></div>Attractor (Codex)</div>\n    <div class=\"legend-item\"><div class=\"legend-swatch\" style=\"background:var(--ci-fill);border-color:var(--ci-stroke)\"></div>CI Background</div>\n  </div>\n\n  <div class=\"layout\">\n\n    <!-- SVG Diagram -->\n    <div class=\"diagram-wrap\">\n      <svg viewBox=\"0 0 760 740\" xmlns=\"http://www.w3.org/2000/svg\" id=\"archSvg\">\n        <defs>\n          <marker id=\"arr\" viewBox=\"0 0 10 7\" refX=\"9\" refY=\"3.5\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto-start-reverse\"><path d=\"M0,0 L10,3.5 L0,7z\" fill=\"var(--text-muted)\"/></marker>\n          <marker id=\"arrBlue\" viewBox=\"0 0 10 7\" refX=\"9\" refY=\"3.5\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto-start-reverse\"><path d=\"M0,0 L10,3.5 L0,7z\" fill=\"var(--factory-stroke)\"/></marker>\n          <marker id=\"arrPurple\" viewBox=\"0 0 10 7\" refX=\"9\" refY=\"3.5\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto-start-reverse\"><path d=\"M0,0 L10,3.5 L0,7z\" fill=\"var(--attractor-stroke)\"/></marker>\n          <marker id=\"arrOrange\" viewBox=\"0 0 10 7\" refX=\"9\" refY=\"3.5\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto-start-reverse\"><path d=\"M0,0 L10,3.5 L0,7z\" fill=\"var(--orange)\"/></marker>\n          <marker id=\"arrGreen\" viewBox=\"0 0 10 7\" refX=\"9\" refY=\"3.5\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto-start-reverse\"><path d=\"M0,0 L10,3.5 L0,7z\" fill=\"var(--product-stroke)\"/></marker>\n          <filter id=\"ds\" x=\"-3%\" y=\"-3%\" width=\"106%\" height=\"106%\"><feDropShadow dx=\"0\" dy=\"1\" stdDeviation=\"2\" flood-opacity=\"0.07\"/></filter>\n        </defs>\n\n        <!-- ===== HUMAN ===== -->\n        <g class=\"node\" data-id=\"human\" onclick=\"showDetail('human')\" filter=\"url(#ds)\">\n          <rect x=\"200\" y=\"14\" width=\"360\" height=\"58\" rx=\"10\" fill=\"var(--human-fill)\" stroke=\"var(--human-stroke)\" stroke-width=\"2\"/>\n          <text x=\"380\" y=\"38\" text-anchor=\"middle\" font-size=\"14\" font-weight=\"700\" fill=\"var(--text)\">Human (Project Lead)</text>\n          <text x=\"380\" y=\"56\" text-anchor=\"middle\" font-size=\"10.5\" fill=\"var(--text-secondary)\">Authors /specs/ + /scenarios/ &#x2022; Invokes /factory-orchestrate &#x2022; Reviews PR</text>\n        </g>\n\n        <!-- Human -> Orchestrator -->\n        <line x1=\"380\" y1=\"72\" x2=\"380\" y2=\"98\" stroke=\"var(--text-muted)\" stroke-width=\"1.5\" marker-end=\"url(#arr)\"/>\n\n        <!-- ===== ORCHESTRATOR ===== -->\n        <g class=\"node\" data-id=\"orchestrator\" onclick=\"showDetail('orchestrator')\" filter=\"url(#ds)\">\n          <rect x=\"80\" y=\"100\" width=\"600\" height=\"50\" rx=\"10\" fill=\"var(--factory-fill)\" stroke=\"var(--factory-stroke)\" stroke-width=\"2\"/>\n          <text x=\"380\" y=\"122\" text-anchor=\"middle\" font-size=\"14\" font-weight=\"700\" fill=\"var(--text)\">Claude Code (Orchestrator)</text>\n          <text x=\"380\" y=\"140\" text-anchor=\"middle\" font-size=\"10.5\" fill=\"var(--text-secondary)\">.claude/skills/factory-orchestrate &#x2014; drives the convergence loop</text>\n        </g>\n\n        <!-- ===== CONVERGENCE LOOP BORDER ===== -->\n        <rect x=\"40\" y=\"166\" width=\"680\" height=\"432\" rx=\"12\" fill=\"none\" stroke=\"var(--factory-stroke)\" stroke-width=\"1\" stroke-dasharray=\"6,4\" opacity=\"0.35\"/>\n        <text x=\"58\" y=\"185\" font-size=\"10\" font-weight=\"700\" fill=\"var(--factory-stroke)\" opacity=\"0.6\" letter-spacing=\"0.8\">CONVERGENCE LOOP</text>\n\n        <!-- Step 1-3: Branch + Strip + Push -->\n        <g class=\"node\" data-id=\"step-branch\" onclick=\"showDetail('step-branch')\" filter=\"url(#ds)\">\n          <rect x=\"56\" y=\"198\" width=\"210\" height=\"56\" rx=\"8\" fill=\"var(--factory-fill)\" stroke=\"var(--factory-stroke)\" stroke-width=\"1.5\"/>\n          <circle cx=\"76\" cy=\"216\" r=\"10\" fill=\"var(--factory-stroke)\"/><text x=\"76\" y=\"220\" text-anchor=\"middle\" font-size=\"10\" font-weight=\"700\" fill=\"white\">1</text>\n          <text x=\"170\" y=\"220\" text-anchor=\"middle\" font-size=\"12\" font-weight=\"600\" fill=\"var(--text)\">Create Branch + Strip</text>\n          <text x=\"166\" y=\"240\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">df-crank-vXX &#x2022; strip_holdout.py &#x2022; push</text>\n        </g>\n\n        <!-- Arrow 1 -> 4 -->\n        <line x1=\"266\" y1=\"226\" x2=\"296\" y2=\"226\" stroke=\"var(--factory-stroke)\" stroke-width=\"1.5\" marker-end=\"url(#arrBlue)\"/>\n\n        <!-- Step 4: Invoke Codex -->\n        <g class=\"node\" data-id=\"step-codex\" onclick=\"showDetail('step-codex')\" filter=\"url(#ds)\">\n          <rect x=\"298\" y=\"198\" width=\"200\" height=\"56\" rx=\"8\" fill=\"var(--attractor-fill)\" stroke=\"var(--attractor-stroke)\" stroke-width=\"1.5\"/>\n          <circle cx=\"318\" cy=\"216\" r=\"10\" fill=\"var(--attractor-stroke)\"/><text x=\"318\" y=\"220\" text-anchor=\"middle\" font-size=\"10\" font-weight=\"700\" fill=\"white\">4</text>\n          <text x=\"406\" y=\"218\" text-anchor=\"middle\" font-size=\"12\" font-weight=\"600\" fill=\"var(--text)\">Invoke Codex</text>\n          <text x=\"398\" y=\"240\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">Browser automation &#x2022; ChatGPT Plus UI</text>\n        </g>\n\n        <!-- Arrow 4 -> Codex actor -->\n        <line x1=\"498\" y1=\"226\" x2=\"524\" y2=\"226\" stroke=\"var(--attractor-stroke)\" stroke-width=\"1.5\" marker-end=\"url(#arrPurple)\"/>\n\n        <!-- Codex Actor -->\n        <g class=\"node\" data-id=\"codex\" onclick=\"showDetail('codex')\" filter=\"url(#ds)\">\n          <rect x=\"526\" y=\"198\" width=\"178\" height=\"56\" rx=\"8\" fill=\"var(--attractor-fill)\" stroke=\"var(--attractor-stroke)\" stroke-width=\"2\"/>\n          <text x=\"615\" y=\"222\" text-anchor=\"middle\" font-size=\"13\" font-weight=\"700\" fill=\"var(--text)\">Codex (Attractor)</text>\n          <text x=\"615\" y=\"240\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">Creates codex-... branch</text>\n        </g>\n\n        <!-- Info boundary box around Codex -->\n        <rect x=\"518\" y=\"190\" width=\"194\" height=\"72\" rx=\"6\" fill=\"none\" stroke=\"var(--red)\" stroke-width=\"1.5\" stroke-dasharray=\"4,3\" opacity=\"0.45\"/>\n        <text x=\"615\" y=\"186\" text-anchor=\"middle\" font-size=\"8.5\" font-weight=\"700\" fill=\"var(--red)\" opacity=\"0.6\" letter-spacing=\"0.3\">INFORMATION BOUNDARY</text>\n\n        <!-- Codex -> Gate 0 -->\n        <path d=\"M615,254 L615,282\" stroke=\"var(--attractor-stroke)\" stroke-width=\"1.5\" fill=\"none\" marker-end=\"url(#arrPurple)\"/>\n\n        <!-- Step 6: Gate 0 -->\n        <g class=\"node\" data-id=\"step-gate0\" onclick=\"showDetail('step-gate0')\" filter=\"url(#ds)\">\n          <rect x=\"260\" y=\"284\" width=\"340\" height=\"56\" rx=\"8\" fill=\"var(--factory-fill)\" stroke=\"var(--factory-stroke)\" stroke-width=\"1.5\"/>\n          <circle cx=\"280\" cy=\"302\" r=\"10\" fill=\"var(--factory-stroke)\"/><text x=\"280\" y=\"306\" text-anchor=\"middle\" font-size=\"10\" font-weight=\"700\" fill=\"white\">4</text>\n          <text x=\"438\" y=\"304\" text-anchor=\"middle\" font-size=\"12\" font-weight=\"600\" fill=\"var(--text)\">Gate 0: Adversarial Review (Agent Team)</text>\n          <text x=\"430\" y=\"326\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">Tool agents (parallel) + semantic reviewer &#x2022; fail-fast on CRITICAL &#x2022; then merge</text>\n        </g>\n\n        <!-- Gate 0 -> Restore + Gate 1 -->\n        <path d=\"M430,340 L430,364\" stroke=\"var(--factory-stroke)\" stroke-width=\"1.5\" fill=\"none\" marker-end=\"url(#arrBlue)\"/>\n\n        <!-- Step 8-9: Restore + Gate 1 -->\n        <g class=\"node\" data-id=\"step-gate1\" onclick=\"showDetail('step-gate1')\" filter=\"url(#ds)\">\n          <rect x=\"56\" y=\"366\" width=\"300\" height=\"56\" rx=\"8\" fill=\"var(--product-fill)\" stroke=\"var(--product-stroke)\" stroke-width=\"1.5\"/>\n          <circle cx=\"76\" cy=\"384\" r=\"10\" fill=\"var(--product-stroke)\"/><text x=\"76\" y=\"388\" text-anchor=\"middle\" font-size=\"10\" font-weight=\"700\" fill=\"white\">8</text>\n          <text x=\"214\" y=\"386\" text-anchor=\"middle\" font-size=\"12\" font-weight=\"600\" fill=\"var(--text)\">Restore Holdout + Gate 1</text>\n          <text x=\"206\" y=\"406\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">restore_holdout.py &#x2022; make lint &#x2022; typecheck &#x2022; test</text>\n        </g>\n\n        <!-- Step 10-11: Gate 2 + Gate 3 -->\n        <g class=\"node\" data-id=\"step-gate23\" onclick=\"showDetail('step-gate23')\" filter=\"url(#ds)\">\n          <rect x=\"370\" y=\"366\" width=\"334\" height=\"56\" rx=\"8\" fill=\"var(--product-fill)\" stroke=\"var(--product-stroke)\" stroke-width=\"1.5\"/>\n          <circle cx=\"390\" cy=\"384\" r=\"10\" fill=\"var(--product-stroke)\"/><text x=\"390\" y=\"388\" text-anchor=\"middle\" font-size=\"10\" font-weight=\"700\" fill=\"white\">10</text>\n          <text x=\"545\" y=\"386\" text-anchor=\"middle\" font-size=\"12\" font-weight=\"600\" fill=\"var(--text)\">Gate 2 (NFR) + Gate 3 (Holdout)</text>\n          <text x=\"537\" y=\"406\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">nfr_checks.py &#x2022; run_scenarios.py &#x2022; satisfaction score</text>\n        </g>\n\n        <!-- Arrows between gate rows -->\n        <line x1=\"356\" y1=\"394\" x2=\"370\" y2=\"394\" stroke=\"var(--product-stroke)\" stroke-width=\"1.5\" marker-end=\"url(#arrGreen)\"/>\n\n        <!-- Gates -> LLM Judge -->\n        <path d=\"M206,422 L206,448\" stroke=\"var(--factory-stroke)\" stroke-width=\"1.5\" fill=\"none\" marker-end=\"url(#arrBlue)\"/>\n        <path d=\"M537,422 L537,448\" stroke=\"var(--factory-stroke)\" stroke-width=\"1.5\" fill=\"none\" marker-end=\"url(#arrBlue)\"/>\n\n        <!-- Step 12: LLM-as-Judge -->\n        <g class=\"node\" data-id=\"step-judge\" onclick=\"showDetail('step-judge')\" filter=\"url(#ds)\">\n          <rect x=\"160\" y=\"450\" width=\"440\" height=\"52\" rx=\"8\" fill=\"var(--factory-fill)\" stroke=\"var(--factory-stroke)\" stroke-width=\"2\"/>\n          <circle cx=\"180\" cy=\"470\" r=\"10\" fill=\"var(--factory-stroke)\"/><text x=\"180\" y=\"474\" text-anchor=\"middle\" font-size=\"10\" font-weight=\"700\" fill=\"white\">12</text>\n          <text x=\"388\" y=\"472\" text-anchor=\"middle\" font-size=\"13\" font-weight=\"700\" fill=\"var(--text)\">LLM-as-Judge: Holistic Evaluation</text>\n          <text x=\"380\" y=\"490\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">Trajectory &#x2022; systemic issues &#x2022; gaming detection &#x2022; go/no-go</text>\n        </g>\n\n        <!-- Judge -> Decision diamond -->\n        <path d=\"M380,502 L380,524\" stroke=\"var(--factory-stroke)\" stroke-width=\"1.5\" fill=\"none\" marker-end=\"url(#arrBlue)\"/>\n\n        <!-- Decision diamond -->\n        <g class=\"node\" data-id=\"step-decision\" onclick=\"showDetail('step-decision')\">\n          <polygon points=\"380,526 418,550 380,574 342,550\" fill=\"var(--factory-fill)\" stroke=\"var(--factory-stroke)\" stroke-width=\"2\"/>\n          <text x=\"380\" y=\"554\" text-anchor=\"middle\" font-size=\"11\" font-weight=\"700\" fill=\"var(--text)\">13</text>\n        </g>\n\n        <!-- Satisfied path -> PR -->\n        <g class=\"node\" data-id=\"step-pr\" onclick=\"showDetail('step-pr')\" filter=\"url(#ds)\">\n          <rect x=\"478\" y=\"534\" width=\"218\" height=\"44\" rx=\"8\" fill=\"var(--human-fill)\" stroke=\"var(--human-stroke)\" stroke-width=\"2\"/>\n          <text x=\"587\" y=\"553\" text-anchor=\"middle\" font-size=\"12\" font-weight=\"700\" fill=\"var(--text)\">Create PR</text>\n          <text x=\"587\" y=\"569\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">Accept / Merge Gate (human)</text>\n        </g>\n        <line x1=\"418\" y1=\"550\" x2=\"476\" y2=\"550\" stroke=\"var(--human-stroke)\" stroke-width=\"1.5\" marker-end=\"url(#arr)\"/>\n        <text x=\"440\" y=\"542\" font-size=\"9\" fill=\"var(--green)\" font-weight=\"700\">SATISFIED</text>\n\n        <!-- Feedback loop arrow: left side, back to step 1 -->\n        <path d=\"M342,550 L66,550 L66,226 L56,226\" stroke=\"var(--orange)\" stroke-width=\"2.5\" fill=\"none\" stroke-dasharray=\"7,4\"/>\n        <polygon points=\"56,219 70,226 56,233\" fill=\"var(--orange)\"/>\n        <text x=\"82\" y=\"544\" font-size=\"9\" fill=\"var(--orange)\" font-weight=\"700\">FEEDBACK LOOP</text>\n        <text x=\"56\" y=\"500\" font-size=\"8.5\" fill=\"var(--orange)\" opacity=\"0.7\" transform=\"rotate(-90,56,500)\">compile feedback &#x2192; loop</text>\n\n        <!-- ===== CI BACKGROUND ===== -->\n        <g class=\"node\" data-id=\"ci\" onclick=\"showDetail('ci')\" filter=\"url(#ds)\">\n          <rect x=\"56\" y=\"614\" width=\"648\" height=\"54\" rx=\"10\" fill=\"var(--ci-fill)\" stroke=\"var(--ci-stroke)\" stroke-width=\"1.5\" stroke-dasharray=\"6,3\"/>\n          <text x=\"380\" y=\"636\" text-anchor=\"middle\" font-size=\"13\" font-weight=\"700\" fill=\"var(--text)\">CI Validation (Background)</text>\n          <text x=\"380\" y=\"654\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-secondary)\">Runs on push to factory/** or df-crank-** &#x2022; Gates 1-3 &#x2022; feedback compilation</text>\n        </g>\n        <!-- CI dashed link to loop -->\n        <path d=\"M380,614 L380,598\" stroke=\"var(--ci-stroke)\" stroke-width=\"1\" stroke-dasharray=\"3,3\" marker-end=\"url(#arr)\"/>\n        <text x=\"395\" y=\"610\" font-size=\"8\" fill=\"var(--text-muted)\">reads results</text>\n\n        <!-- Step numbers guide at bottom -->\n        <text x=\"380\" y=\"698\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--text-muted)\">1-2: branch + strip &#x2022; 3: invoke Codex &#x2022; 4: Gate 0 agent team &#x2022; 5: merge &#x2022; 6-7: restore + Gate 1 &#x2022; 8-9: Gates 2-3 &#x2022; 10: LLM judge &#x2022; 11-12: PR + review pack</text>\n      </svg>\n    </div>\n\n    <!-- Right Column -->\n    <div>\n      <!-- Detail Panel -->\n      <div class=\"panel\" id=\"detailPanel\">\n        <div class=\"panel-header\"><h2>Component Detail</h2></div>\n        <div class=\"panel-empty\" id=\"panelEmpty\">Click any component in the diagram to see its details, key files, and information boundary notes.</div>\n        <div class=\"panel-body\" id=\"panelBody\" style=\"display:none\"></div>\n      </div>\n\n      <!-- Layered Defense -->\n      <div class=\"sidebar-section\">\n        <div class=\"sidebar-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n          <h3>Layered Defense</h3><span class=\"chevron\">&#9660;</span>\n        </div>\n        <div class=\"sidebar-body\">\n          <div class=\"defense-layer\">\n            <div class=\"defense-num\">1</div>\n            <div class=\"defense-text\"><strong>Gate 0: Tool Agents</strong> &mdash; Deterministic, parallel. ruff (lint), radon (complexity), vulture (dead code), bandit (security), check_test_quality.py (vacuous tests). Fast, cheap, catches obvious violations in seconds.</div>\n          </div>\n          <div class=\"defense-layer\">\n            <div class=\"defense-num\">2</div>\n            <div class=\"defense-text\"><strong>Gate 0: Semantic Reviewer</strong> &mdash; LLM judgment, runs in parallel with tool agents. Catches subtle gaming, architectural dishonesty, spec violations, integration gaps the tools miss.</div>\n          </div>\n          <div class=\"defense-layer\">\n            <div class=\"defense-num\">3</div>\n            <div class=\"defense-text\"><strong>Gate 3: Holdout Scenarios</strong> &mdash; Ground truth. The attractor never sees these criteria. Verifies actual behavior against human-authored expectations.</div>\n          </div>\n        </div>\n      </div>\n\n      <!-- Information Boundaries -->\n      <div class=\"sidebar-section\">\n        <div class=\"sidebar-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n          <h3>Information Boundaries</h3><span class=\"chevron\">&#9660;</span>\n        </div>\n        <div class=\"sidebar-body\">\n          <div class=\"boundary-item\">\n            <div class=\"boundary-label\" style=\"color:var(--green)\">Codex CAN see</div>\n            <div class=\"boundary-desc\">/specs/, feedback_iter_N.md, its own code, src/, tests/, Makefile</div>\n          </div>\n          <div class=\"boundary-item\">\n            <div class=\"boundary-label\" style=\"color:var(--red)\">Codex NEVER sees</div>\n            <div class=\"boundary-desc\">/scenarios/ (stripped), pr_review_pack.html, pr_diff_data.json, adversarial findings</div>\n          </div>\n          <div class=\"boundary-item\">\n            <div class=\"boundary-label\" style=\"color:var(--blue)\">Mechanism</div>\n            <div class=\"boundary-desc\">Branch stripping &mdash; scenarios physically absent from the pushed branch. Not filesystem hiding; a real information gate.</div>\n          </div>\n        </div>\n      </div>\n\n      <!-- Agent Teams -->\n      <div class=\"sidebar-section\">\n        <div class=\"sidebar-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">\n          <h3>Claude Code Agent Teams</h3><span class=\"chevron\">&#9660;</span>\n        </div>\n        <div class=\"sidebar-body\">\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--blue)\"></div><div><div class=\"agent-name\">Main Orchestrator</div><div class=\"agent-role\">Drives convergence loop, invokes Codex via browser, holistic decisions</div></div></div>\n          <div style=\"margin:8px 0 4px;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px\">Gate 0 Agent Team (parallel)</div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--blue)\"></div><div><div class=\"agent-name\">ruff-agent</div><div class=\"agent-role\">Lint violations, style, import issues</div></div></div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--blue)\"></div><div><div class=\"agent-name\">radon-agent</div><div class=\"agent-role\">Cyclomatic complexity &gt; threshold</div></div></div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--blue)\"></div><div><div class=\"agent-name\">vulture-agent</div><div class=\"agent-role\">Unreachable code, unused functions</div></div></div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--blue)\"></div><div><div class=\"agent-name\">bandit-agent</div><div class=\"agent-role\">Security vulnerabilities</div></div></div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--blue)\"></div><div><div class=\"agent-name\">test-quality-agent</div><div class=\"agent-role\">Vacuous tests, stub assertions, mock abuse</div></div></div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--red)\"></div><div><div class=\"agent-name\">adversarial-reviewer</div><div class=\"agent-role\">Semantic review &mdash; gaming, architectural dishonesty, spec violations</div></div></div>\n          <div style=\"margin:8px 0 4px;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px\">PR Review Pack</div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--purple)\"></div><div><div class=\"agent-name\">Diff Analysis Agent</div><div class=\"agent-role\">Pass 1 &mdash; deterministic file-to-zone mapping</div></div></div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--green)\"></div><div><div class=\"agent-name\">Semantic Analysis Agent</div><div class=\"agent-role\">Pass 2 &mdash; what-changed summaries, decisions, findings</div></div></div>\n          <div style=\"margin:8px 0 4px;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px\">Documentation</div>\n          <div class=\"agent-item\"><div class=\"agent-dot\" style=\"background:var(--orange)\"></div><div><div class=\"agent-name\">Documentation Sweep</div><div class=\"agent-role\">Ensures all affected documentation layers are updated before PR ships</div></div></div>\n        </div>\n      </div>\n    </div>\n\n  </div>\n\n  <div class=\"footer\">Architecture as of PR #5 (factory/v1 &rarr; main) &mdash; Gate 0 agent team + PR review pack skill added</div>\n\n</div>\n\n<script>\nconst C = {\n  human: {\n    title: 'Human (Project Lead)',\n    desc: 'The single human in the loop. Authors specifications that define what the system should do and scenarios that define how to evaluate it. Invokes the factory via the /factory-orchestrate skill in Claude Code. Reviews the final PR at the accept/merge gate \\u2014 the only point where a human decision is required.',\n    files: [\n      { n: '/specs/*.md', c: 'human' },\n      { n: '/scenarios/*.md', c: 'human' },\n    ],\n    tags: [{ t: 'Accept/Merge Gate', c: 'gate' }],\n    boundary: 'Owns scenarios \\u2014 the ground truth that the attractor never sees. The merge decision is always human; the factory never auto-merges.'\n  },\n  orchestrator: {\n    title: 'Claude Code (Orchestrator)',\n    desc: 'The factory orchestrator. Runs the entire convergence loop via the /factory-orchestrate skill. Uses browser automation to invoke Codex through ChatGPT Plus \\u2014 no API key needed. Drives adversarial review (Gate 0), makes holistic judgment calls (LLM-as-Judge), creates PRs. CI provides background validation; Claude Code orchestrates.',\n    files: [\n      { n: '.claude/skills/factory-orchestrate/', c: 'factory' },\n      { n: 'scripts/strip_holdout.py', c: 'factory' },\n      { n: 'scripts/restore_holdout.py', c: 'factory' },\n      { n: 'scripts/compile_feedback.py', c: 'factory' },\n      { n: 'docs/code_quality_standards.md', c: 'factory' },\n      { n: 'CLAUDE.md', c: 'factory' },\n    ],\n    tags: [{ t: 'Gate 0', c: 'gate' }, { t: 'LLM-as-Judge', c: 'gate' }, { t: 'Orchestrator', c: 'info' }],\n    boundary: 'Full visibility \\u2014 sees everything including scenarios, adversarial findings, and all gate outputs across all iterations.'\n  },\n  codex: {\n    title: 'Codex (Attractor)',\n    desc: 'The code generator. Invoked via browser automation through the ChatGPT Plus UI. Works on a stripped branch where scenarios have been physically removed. Reads specs and iteration feedback to produce code. Creates its own codex-... branch. Never touches factory infrastructure.',\n    files: [\n      { n: '/specs/*.md (reads)', c: 'human' },\n      { n: 'artifacts/factory/feedback_iter_N.md (reads)', c: 'factory' },\n      { n: 'src/, tests/, configs/, Makefile (writes)', c: 'product' },\n      { n: '.github/codex/prompts/factory_fix.md', c: 'factory' },\n    ],\n    tags: [{ t: 'Information Boundary', c: 'boundary' }, { t: 'Attractor', c: 'info' }],\n    boundary: 'NEVER sees /scenarios/, pr_review_pack.html, pr_diff_data.json, or adversarial findings. Branch stripping creates a real information gate \\u2014 files do not exist on the branch Codex works on.'\n  },\n  'step-branch': {\n    title: 'Steps 1\\u20133: Branch + Strip + Push',\n    desc: 'Creates a new df-crank-vXX branch. Runs strip_holdout.py to remove /scenarios/ and review pack artifacts. Commits with marker [factory:holdout-stripped]. Pushes the stripped branch to origin. This is where the information boundary is created.',\n    files: [\n      { n: 'scripts/strip_holdout.py', c: 'factory' },\n      { n: 'scripts/restore_holdout.py', c: 'factory' },\n    ],\n    tags: [{ t: 'Information Boundary', c: 'boundary' }, { t: 'Branch Stripping', c: 'info' }],\n    boundary: 'Scenarios physically absent from the pushed branch. Not filesystem hiding \\u2014 a real gate. There is nothing to read, no path to guess, no hidden directory to discover.'\n  },\n  'step-codex': {\n    title: 'Step 4: Invoke Codex via Browser',\n    desc: 'Claude Code uses browser automation (MCP tools) to invoke Codex through the ChatGPT Plus UI. No API key needed \\u2014 browser automation is the primary path. Codex reads specs and prior feedback, produces code on its own codex-... branch.',\n    files: [\n      { n: '.claude/skills/factory-orchestrate/', c: 'factory' },\n      { n: '.github/codex/prompts/factory_fix.md', c: 'factory' },\n    ],\n    tags: [{ t: 'Browser Automation', c: 'info' }],\n    boundary: 'Codex works on the stripped branch \\u2014 cannot access scenarios or adversarial findings by design.'\n  },\n  'step-gate0': {\n    title: 'Gate 0: Adversarial Review (Agent Team)',\n    desc: 'Runs as a parallel agent team before merge. Tool agents (ruff, radon, vulture, bandit, check_test_quality.py) run deterministic checks simultaneously. The semantic adversarial reviewer reads the diff against code_quality_standards.md, adversarial_review.md, and /specs/. All agents have full authority \\u2014 any CRITICAL finding from any agent blocks the pipeline. No point sending to CI or later gates if Gate 0 finds issues.',\n    files: [\n      { n: 'scripts/nfr_checks.py (tool agents)', c: 'factory' },\n      { n: 'scripts/check_test_quality.py (tool agent)', c: 'factory' },\n      { n: '.github/codex/prompts/adversarial_review.md', c: 'factory' },\n      { n: 'docs/code_quality_standards.md', c: 'factory' },\n    ],\n    tags: [{ t: 'Gate 0', c: 'gate' }, { t: 'Agent Team', c: 'info' }, { t: 'Fail-Fast', c: 'boundary' }],\n    boundary: 'Layered defense: tool agents catch cheap/obvious violations fast, semantic reviewer catches subtle gaming and architectural dishonesty. Both run in parallel. Gate 3 holdout scenarios verify actual behavior as ground truth.'\n  },\n  'step-gate1': {\n    title: 'Steps 8\\u20139: Restore Holdout + Gate 1',\n    desc: 'Restores holdout scenarios from origin/main using restore_holdout.py (intentionally does NOT restore review pack artifacts). Then runs deterministic Gate 1: make lint (ruff), make typecheck (mypy), make test (pytest). If any fail, Gates 2\\u20133 are skipped.',\n    files: [\n      { n: 'scripts/restore_holdout.py', c: 'factory' },\n      { n: 'Makefile (lint, typecheck, test)', c: 'product' },\n    ],\n    tags: [{ t: 'Gate 1', c: 'gate' }, { t: 'Deterministic', c: 'info' }],\n    boundary: 'Scenarios restored here \\u2014 but only after Codex can no longer see the branch.'\n  },\n  'step-gate23': {\n    title: 'Steps 10\\u201311: Gate 2 + Gate 3',\n    desc: 'Gate 2: NFR checks via nfr_checks.py \\u2014 code quality (ruff extended), complexity (radon), dead code (vulture), security (bandit). Non-blocking; feeds into LLM evaluation. Gate 3: Behavioral scenarios via run_scenarios.py \\u2014 executes holdout scenarios. Produces a satisfaction score: passed / total.',\n    files: [\n      { n: 'scripts/nfr_checks.py', c: 'factory' },\n      { n: 'scripts/run_scenarios.py', c: 'factory' },\n      { n: '/scenarios/*.md', c: 'human' },\n    ],\n    tags: [{ t: 'Gate 2 (non-blocking)', c: 'gate' }, { t: 'Gate 3 (holdout)', c: 'gate' }, { t: 'Defense Layer 3', c: 'boundary' }],\n    boundary: 'Gate 3 is the ground truth \\u2014 scenarios the attractor never saw. Defense layer 3: verifies actual behavior against human-authored expectations.'\n  },\n  'step-judge': {\n    title: 'Step 12: LLM-as-Judge',\n    desc: 'Claude Code reasons holistically through ALL gate outputs. Not just \"score >= threshold\" \\u2014 considers trajectory across iterations, systemic issues, Gate 2 warnings, whether fixes are real or whether Codex is gaming. Makes the holistic go/no-go decision.',\n    files: [\n      { n: 'artifacts/factory/feedback_iter_*.md', c: 'factory' },\n      { n: 'artifacts/factory/scenario_results.json', c: 'factory' },\n    ],\n    tags: [{ t: 'LLM-as-Judge', c: 'gate' }, { t: 'Holistic Decision', c: 'info' }],\n    boundary: 'Full visibility into all gates, all iterations, all findings. The judge sees everything the attractor does not.'\n  },\n  'step-decision': {\n    title: 'Step 13: Converge or Loop',\n    desc: 'The decision point. If the LLM-as-Judge is satisfied: create a PR with factory-converged and accept-merge-gate labels. If not: compile detailed feedback into feedback_iter_N.md and loop back to step 1 with a new branch version.',\n    files: [\n      { n: 'artifacts/factory/feedback_iter_N.md', c: 'factory' },\n      { n: 'scripts/compile_feedback.py', c: 'factory' },\n    ],\n    tags: [{ t: 'Decision Point', c: 'info' }],\n    boundary: 'Feedback file is visible to Codex in the next iteration \\u2014 but stripped of scenario details and adversarial findings.'\n  },\n  'step-pr': {\n    title: 'Accept / Merge Gate + PR Review Pack',\n    desc: 'The single human decision point. The factory creates a PR, then generates a PR review pack via the /pr-review-pack skill \\u2014 a self-contained interactive HTML file. Joey reviews the report, not the code. The review pack provides architecture diagrams, adversarial findings, CI performance, key decisions, convergence status, and post-merge items.',\n    files: [\n      { n: '.claude/skills/pr-review-pack/ (skill)', c: 'factory' },\n      { n: 'docs/pr_review_pack.html (output)', c: 'factory' },\n      { n: 'docs/pr_diff_data.json (output)', c: 'factory' },\n    ],\n    tags: [{ t: 'Human Gate', c: 'gate' }, { t: 'Never Auto-Merges', c: 'boundary' }],\n    boundary: 'Code was never reviewed by humans during production. The PR review pack is the artifact that communicates factory status to the human. Without it, the accept/merge gate is a rubber stamp.'\n  },\n  ci: {\n    title: 'CI Validation (Background)',\n    desc: 'GitHub Actions (.github/workflows/factory.yaml) runs validation on every push to factory/** or df-crank-** branches. Executes Gates 1\\u20133 plus feedback compilation. CI validates \\u2014 it does not orchestrate. Claude Code reads CI results as input to its decisions.',\n    files: [\n      { n: '.github/workflows/factory.yaml', c: 'ci' },\n      { n: 'scripts/run_scenarios.py', c: 'factory' },\n      { n: 'scripts/compile_feedback.py', c: 'factory' },\n      { n: 'scripts/nfr_checks.py', c: 'factory' },\n    ],\n    tags: [{ t: 'Gates 1\\u20133', c: 'gate' }, { t: 'Background Validation', c: 'info' }],\n    boundary: 'Runs on pushed branches. CI does not orchestrate \\u2014 it provides signal that the orchestrator consumes.'\n  }\n};\n\nfunction showDetail(id) {\n  const c = C[id];\n  if (!c) return;\n  document.querySelectorAll('.node').forEach(n => {\n    n.classList.remove('active','dimmed');\n    if (n.dataset.id !== id) n.classList.add('dimmed');\n  });\n  const active = document.querySelector('.node[data-id=\"'+id+'\"]');\n  if (active) active.classList.add('active');\n  document.getElementById('panelEmpty').style.display = 'none';\n  const body = document.getElementById('panelBody');\n  body.style.display = 'block';\n  const tags = c.tags.map(t => '<span class=\"detail-tag '+t.c+'\">'+t.t+'</span>').join('');\n  const files = c.files.map(f => '<li class=\"'+f.c+'\">'+f.n+'</li>').join('');\n  body.innerHTML =\n    '<div class=\"detail-title\">'+c.title+'</div>'+\n    '<div class=\"detail-desc\">'+c.desc+'</div>'+\n    (tags ? '<div style=\"margin-bottom:14px\">'+tags+'</div>' : '')+\n    (c.files.length ? '<div class=\"detail-section\"><div class=\"detail-section-title\">Key Files</div><ul class=\"detail-list\">'+files+'</ul></div>' : '')+\n    (c.boundary ? '<div class=\"detail-section\"><div class=\"detail-section-title\">Information Boundary</div><div style=\"font-size:12px;color:var(--text-secondary);line-height:1.6\">'+c.boundary+'</div></div>' : '');\n}\n\ndocument.getElementById('archSvg').addEventListener('click', function(e) {\n  if (!e.target.closest('.node')) {\n    document.querySelectorAll('.node').forEach(n => n.classList.remove('active','dimmed'));\n    document.getElementById('panelEmpty').style.display = 'block';\n    document.getElementById('panelBody').style.display = 'none';\n  }\n});\n\nfunction setTheme(m) {\n  document.querySelectorAll('.theme-toggle button').forEach(b => b.classList.remove('active'));\n  const btns = document.querySelectorAll('.theme-toggle button');\n  if (m==='light') { document.documentElement.setAttribute('data-theme','light'); btns[0].classList.add('active'); }\n  else if (m==='dark') { document.documentElement.setAttribute('data-theme','dark'); btns[1].classList.add('active'); }\n  else { document.documentElement.removeAttribute('data-theme'); btns[2].classList.add('active'); applySys(); }\n  localStorage.setItem('archTheme',m);\n}\nfunction applySys() {\n  if (window.matchMedia('(prefers-color-scheme:dark)').matches) document.documentElement.setAttribute('data-theme','dark');\n  else document.documentElement.removeAttribute('data-theme');\n}\n(function(){\n  var s = localStorage.getItem('archTheme') || 'system';\n  setTheme(s);\n  window.matchMedia('(prefers-color-scheme:dark)').addEventListener('change', function(){\n    if ((localStorage.getItem('archTheme')||'system')==='system') applySys();\n  });\n})();\n</script>\n</body>\n</html>\n"
    },
    "docs/factory_validation_strategy.md": {
      "additions": 2,
      "deletions": 2,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/docs/factory_validation_strategy.md b/docs/factory_validation_strategy.md\nindex 3308f50..2dca5ff 100644\n--- a/docs/factory_validation_strategy.md\n+++ b/docs/factory_validation_strategy.md\n@@ -10,7 +10,7 @@ How we validate the factory's own components and their integration.\n | Feedback compiler | Script | `scripts/compile_feedback.py` | `tests/test_factory_compile_feedback.py` + lint + typecheck |\n | Factory orchestrator | Workflow | `.github/workflows/factory.yaml` | CI dry-run + manual trigger |\n | Attractor prompt | Markdown | `.github/codex/prompts/factory_fix.md` | Human review + adversarial review |\n-| Adversarial review | Markdown | `.github/codex/prompts/adversarial_review.md` | Human review |\n+| Adversarial review | Markdown | `.claude/skills/factory-orchestrate/review-prompts/adversarial_review.md` | Human review |\n | Satisfaction dashboard | Streamlit | `src/dashboard/pages/factory.py` | lint + manual verification |\n | Scenario files | Markdown | `scenarios/*.md` | Format validator in CI |\n | Factory CI | Workflow | `.github/workflows/ci.yaml` (factory-self-test job) | Self-referential (runs on itself) |\n@@ -38,7 +38,7 @@ How we validate the factory's own components and their integration.\n   - End-to-end integration (1 test)\n \n ### Layer 3: Adversarial Review (Manual, Per PR)\n-- Review guidelines at `.github/codex/prompts/adversarial_review.md`\n+- Review guidelines at `.claude/skills/factory-orchestrate/review-prompts/adversarial_review.md`\n - Checks for: vacuous tests, gaming, architectural dishonesty, spec violations\n - Applied to attractor output (product code), not to factory infrastructure\n \n",
      "raw": "# Factory Validation Strategy\n\nHow we validate the factory's own components and their integration.\n\n## Component Inventory\n\n| Component | Type | Location | Validated By |\n|-----------|------|----------|-------------|\n| Scenario runner | Script | `scripts/run_scenarios.py` | `tests/test_factory_run_scenarios.py` + lint + typecheck |\n| Feedback compiler | Script | `scripts/compile_feedback.py` | `tests/test_factory_compile_feedback.py` + lint + typecheck |\n| Factory orchestrator | Workflow | `.github/workflows/factory.yaml` | CI dry-run + manual trigger |\n| Attractor prompt | Markdown | `.github/codex/prompts/factory_fix.md` | Human review + adversarial review |\n| Adversarial review | Markdown | `.claude/skills/factory-orchestrate/review-prompts/adversarial_review.md` | Human review |\n| Satisfaction dashboard | Streamlit | `src/dashboard/pages/factory.py` | lint + manual verification |\n| Scenario files | Markdown | `scenarios/*.md` | Format validator in CI |\n| Factory CI | Workflow | `.github/workflows/ci.yaml` (factory-self-test job) | Self-referential (runs on itself) |\n\n## Validation Layers\n\n### Layer 1: Static Analysis (Automated, Every Push)\n- **ruff check** on all factory Python scripts\n- **mypy** on factory scripts (with `--ignore-missing-imports`)\n- **Scenario format validator** \u2014 ensures all `.md` files in `/scenarios/` have required sections\n- **Factory integrity check** \u2014 verifies protected files exist and are referenced in CLAUDE.md\n\n### Layer 2: Unit Tests (Automated, Every Push)\n- `test_factory_run_scenarios.py` \u2014 19 tests covering:\n  - Scenario markdown parsing (7 tests)\n  - Scenario execution with real bash commands (11 tests)\n  - Dataclass serialization (1 test)\n- `test_factory_compile_feedback.py` \u2014 29 tests covering:\n  - Results loading and missing file handling (3 tests)\n  - CI log loading and truncation (3 tests)\n  - Iteration counting (3 tests)\n  - Feedback history loading (3 tests)\n  - Root cause inference from error patterns (7 tests)\n  - Feedback compilation output structure (9 tests)\n  - End-to-end integration (1 test)\n\n### Layer 3: Adversarial Review (Manual, Per PR)\n- Review guidelines at `.claude/skills/factory-orchestrate/review-prompts/adversarial_review.md`\n- Checks for: vacuous tests, gaming, architectural dishonesty, spec violations\n- Applied to attractor output (product code), not to factory infrastructure\n\n### Layer 4: Integration Testing (Manual, Pre-Factory-Crank)\n- `make factory-local` \u2014 runs one full iteration without Codex\n- Verifies: scenario discovery \u2192 execution \u2192 result JSON \u2192 feedback compilation\n- This is the integration test for the factory pipeline\n\n## What's NOT Tested (Known Gaps)\n\n| Gap | Risk | Mitigation | When to Fix |\n|-----|------|-----------|-------------|\n| factory.yaml workflow logic | Can't unit test GH Actions | Manual trigger + review | Post-first-crank |\n| Codex invocation | Browser automation via ChatGPT Plus | Test browser path first; API key is fallback | First crank |\n| Branch stripping | strip/restore scripts tested; regex edge cases possible | Adversarial review + tests | Post-first-crank |\n| Dashboard data display | Needs Streamlit runtime | Manual `make dashboard` | Post-first-crank |\n| Adversarial review effectiveness | New, unproven | Track false negative rate | Ongoing |\n| Factory workflow concurrency | Multiple factory runs on same branch | Lock via GH concurrency groups | Post-first-crank |\n\n## Test Hygiene Rules\n\n### For Factory Tests\n1. **No mocking factory internals.** Tests import and exercise real functions.\n2. **Use `tmp_path` fixtures** for file operations \u2014 never touch the real filesystem.\n3. **Real bash execution** in scenario runner tests \u2014 subprocess.run, not mocked.\n4. **Every assertion tests a meaningful property** \u2014 not just \"doesn't crash.\"\n\n### For Product Tests (Enforced by Anti-Gaming Rules)\n1. No mocking the system under test.\n2. No stub implementations (`return True`, `pass`, hardcoded lookup tables).\n3. No patching away tested logic.\n4. No test-only config shortcuts that trivialize behavior.\n\n## How to Run Factory Validation Locally\n\n```bash\n# Full factory self-test\nruff check scripts/run_scenarios.py scripts/compile_feedback.py\nmypy scripts/run_scenarios.py scripts/compile_feedback.py --ignore-missing-imports\npytest tests/test_factory_run_scenarios.py tests/test_factory_compile_feedback.py -v\n\n# Integration test (no Codex)\nmake factory-local\n\n# Dashboard manual check\nmake dashboard\n# Navigate to \"Factory\" page in sidebar\n```\n",
      "base": "# Factory Validation Strategy\n\nHow we validate the factory's own components and their integration.\n\n## Component Inventory\n\n| Component | Type | Location | Validated By |\n|-----------|------|----------|-------------|\n| Scenario runner | Script | `scripts/run_scenarios.py` | `tests/test_factory_run_scenarios.py` + lint + typecheck |\n| Feedback compiler | Script | `scripts/compile_feedback.py` | `tests/test_factory_compile_feedback.py` + lint + typecheck |\n| Factory orchestrator | Workflow | `.github/workflows/factory.yaml` | CI dry-run + manual trigger |\n| Attractor prompt | Markdown | `.github/codex/prompts/factory_fix.md` | Human review + adversarial review |\n| Adversarial review | Markdown | `.github/codex/prompts/adversarial_review.md` | Human review |\n| Satisfaction dashboard | Streamlit | `src/dashboard/pages/factory.py` | lint + manual verification |\n| Scenario files | Markdown | `scenarios/*.md` | Format validator in CI |\n| Factory CI | Workflow | `.github/workflows/ci.yaml` (factory-self-test job) | Self-referential (runs on itself) |\n\n## Validation Layers\n\n### Layer 1: Static Analysis (Automated, Every Push)\n- **ruff check** on all factory Python scripts\n- **mypy** on factory scripts (with `--ignore-missing-imports`)\n- **Scenario format validator** \u2014 ensures all `.md` files in `/scenarios/` have required sections\n- **Factory integrity check** \u2014 verifies protected files exist and are referenced in CLAUDE.md\n\n### Layer 2: Unit Tests (Automated, Every Push)\n- `test_factory_run_scenarios.py` \u2014 19 tests covering:\n  - Scenario markdown parsing (7 tests)\n  - Scenario execution with real bash commands (11 tests)\n  - Dataclass serialization (1 test)\n- `test_factory_compile_feedback.py` \u2014 29 tests covering:\n  - Results loading and missing file handling (3 tests)\n  - CI log loading and truncation (3 tests)\n  - Iteration counting (3 tests)\n  - Feedback history loading (3 tests)\n  - Root cause inference from error patterns (7 tests)\n  - Feedback compilation output structure (9 tests)\n  - End-to-end integration (1 test)\n\n### Layer 3: Adversarial Review (Manual, Per PR)\n- Review guidelines at `.github/codex/prompts/adversarial_review.md`\n- Checks for: vacuous tests, gaming, architectural dishonesty, spec violations\n- Applied to attractor output (product code), not to factory infrastructure\n\n### Layer 4: Integration Testing (Manual, Pre-Factory-Crank)\n- `make factory-local` \u2014 runs one full iteration without Codex\n- Verifies: scenario discovery \u2192 execution \u2192 result JSON \u2192 feedback compilation\n- This is the integration test for the factory pipeline\n\n## What's NOT Tested (Known Gaps)\n\n| Gap | Risk | Mitigation | When to Fix |\n|-----|------|-----------|-------------|\n| factory.yaml workflow logic | Can't unit test GH Actions | Manual trigger + review | Post-first-crank |\n| Codex invocation | Browser automation via ChatGPT Plus | Test browser path first; API key is fallback | First crank |\n| Branch stripping | strip/restore scripts tested; regex edge cases possible | Adversarial review + tests | Post-first-crank |\n| Dashboard data display | Needs Streamlit runtime | Manual `make dashboard` | Post-first-crank |\n| Adversarial review effectiveness | New, unproven | Track false negative rate | Ongoing |\n| Factory workflow concurrency | Multiple factory runs on same branch | Lock via GH concurrency groups | Post-first-crank |\n\n## Test Hygiene Rules\n\n### For Factory Tests\n1. **No mocking factory internals.** Tests import and exercise real functions.\n2. **Use `tmp_path` fixtures** for file operations \u2014 never touch the real filesystem.\n3. **Real bash execution** in scenario runner tests \u2014 subprocess.run, not mocked.\n4. **Every assertion tests a meaningful property** \u2014 not just \"doesn't crash.\"\n\n### For Product Tests (Enforced by Anti-Gaming Rules)\n1. No mocking the system under test.\n2. No stub implementations (`return True`, `pass`, hardcoded lookup tables).\n3. No patching away tested logic.\n4. No test-only config shortcuts that trivialize behavior.\n\n## How to Run Factory Validation Locally\n\n```bash\n# Full factory self-test\nruff check scripts/run_scenarios.py scripts/compile_feedback.py\nmypy scripts/run_scenarios.py scripts/compile_feedback.py --ignore-missing-imports\npytest tests/test_factory_run_scenarios.py tests/test_factory_compile_feedback.py -v\n\n# Integration test (no Codex)\nmake factory-local\n\n# Dashboard manual check\nmake dashboard\n# Navigate to \"Factory\" page in sidebar\n```\n"
    },
    "requirements.in": {
      "additions": 1,
      "deletions": 0,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/requirements.in b/requirements.in\nindex 926cad3..3c29971 100644\n--- a/requirements.in\n+++ b/requirements.in\n@@ -11,3 +11,4 @@ matplotlib\n pandas\n pypdf\n requests\n+pygame\n",
      "raw": "numpy\ntorch\ngymnasium\nopencv-python-headless\npyyaml\ntensorboard\nimageio\nimageio-ffmpeg\nstreamlit\nmatplotlib\npandas\npypdf\nrequests\npygame\n",
      "base": "numpy\ntorch\ngymnasium\nopencv-python-headless\npyyaml\ntensorboard\nimageio\nimageio-ffmpeg\nstreamlit\nmatplotlib\npandas\npypdf\nrequests\n"
    },
    "requirements.txt": {
      "additions": 4,
      "deletions": 51,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/requirements.txt b/requirements.txt\nindex d5caa9b..9b144ea 100644\n--- a/requirements.txt\n+++ b/requirements.txt\n@@ -1,8 +1,8 @@\n #\n-# This file is autogenerated by pip-compile with Python 3.10\n+# This file is autogenerated by pip-compile with Python 3.13\n # by the following command:\n #\n-#    pip-compile requirements.in\n+#    pip-compile --output-file=requirements.txt requirements.in\n #\n absl-py==2.4.0\n     # via tensorboard\n@@ -26,10 +26,6 @@ cloudpickle==3.1.2\n     # via gymnasium\n contourpy==1.3.2\n     # via matplotlib\n-cuda-bindings==12.9.4\n-    # via torch\n-cuda-pathfinder==1.3.4\n-    # via cuda-bindings\n cycler==0.12.1\n     # via matplotlib\n farama-notifications==0.0.4\n@@ -91,45 +87,6 @@ numpy==2.2.6\n     #   pydeck\n     #   streamlit\n     #   tensorboard\n-nvidia-cublas-cu12==12.8.4.1\n-    # via\n-    #   nvidia-cudnn-cu12\n-    #   nvidia-cusolver-cu12\n-    #   torch\n-nvidia-cuda-cupti-cu12==12.8.90\n-    # via torch\n-nvidia-cuda-nvrtc-cu12==12.8.93\n-    # via torch\n-nvidia-cuda-runtime-cu12==12.8.90\n-    # via torch\n-nvidia-cudnn-cu12==9.10.2.21\n-    # via torch\n-nvidia-cufft-cu12==11.3.3.83\n-    # via torch\n-nvidia-cufile-cu12==1.13.1.3\n-    # via torch\n-nvidia-curand-cu12==10.3.9.90\n-    # via torch\n-nvidia-cusolver-cu12==11.7.3.90\n-    # via torch\n-nvidia-cusparse-cu12==12.5.8.93\n-    # via\n-    #   nvidia-cusolver-cu12\n-    #   torch\n-nvidia-cusparselt-cu12==0.7.1\n-    # via torch\n-nvidia-nccl-cu12==2.27.5\n-    # via torch\n-nvidia-nvjitlink-cu12==12.8.93\n-    # via\n-    #   nvidia-cufft-cu12\n-    #   nvidia-cusolver-cu12\n-    #   nvidia-cusparse-cu12\n-    #   torch\n-nvidia-nvshmem-cu12==3.4.5\n-    # via torch\n-nvidia-nvtx-cu12==12.8.90\n-    # via torch\n opencv-python-headless==4.13.0.92\n     # via -r requirements.in\n packaging==26.0\n@@ -156,6 +113,8 @@ pyarrow==23.0.1\n     # via streamlit\n pydeck==0.9.1\n     # via streamlit\n+pygame==2.6.1\n+    # via -r requirements.in\n pyparsing==3.3.2\n     # via matplotlib\n pypdf==6.7.1\n@@ -200,23 +159,17 @@ torch==2.10.0\n     # via -r requirements.in\n tornado==6.5.4\n     # via streamlit\n-triton==3.6.0\n-    # via torch\n typing-extensions==4.15.0\n     # via\n     #   altair\n     #   grpcio\n     #   gymnasium\n-    #   pypdf\n-    #   referencing\n     #   streamlit\n     #   torch\n tzdata==2025.3\n     # via pandas\n urllib3==2.6.3\n     # via requests\n-watchdog==6.0.0\n-    # via streamlit\n werkzeug==3.1.5\n     # via tensorboard\n \n",
      "raw": "#\n# This file is autogenerated by pip-compile with Python 3.13\n# by the following command:\n#\n#    pip-compile --output-file=requirements.txt requirements.in\n#\nabsl-py==2.4.0\n    # via tensorboard\naltair==6.0.0\n    # via streamlit\nattrs==25.4.0\n    # via\n    #   jsonschema\n    #   referencing\nblinker==1.9.0\n    # via streamlit\ncachetools==6.2.6\n    # via streamlit\ncertifi==2026.1.4\n    # via requests\ncharset-normalizer==3.4.4\n    # via requests\nclick==8.3.1\n    # via streamlit\ncloudpickle==3.1.2\n    # via gymnasium\ncontourpy==1.3.2\n    # via matplotlib\ncycler==0.12.1\n    # via matplotlib\nfarama-notifications==0.0.4\n    # via gymnasium\nfilelock==3.24.2\n    # via torch\nfonttools==4.61.1\n    # via matplotlib\nfsspec==2026.2.0\n    # via torch\ngitdb==4.0.12\n    # via gitpython\ngitpython==3.1.46\n    # via streamlit\ngrpcio==1.78.0\n    # via tensorboard\ngymnasium==1.2.3\n    # via -r requirements.in\nidna==3.11\n    # via requests\nimageio==2.37.2\n    # via -r requirements.in\nimageio-ffmpeg==0.6.0\n    # via -r requirements.in\njinja2==3.1.6\n    # via\n    #   altair\n    #   pydeck\n    #   torch\njsonschema==4.26.0\n    # via altair\njsonschema-specifications==2025.9.1\n    # via jsonschema\nkiwisolver==1.4.9\n    # via matplotlib\nmarkdown==3.10.2\n    # via tensorboard\nmarkupsafe==3.0.3\n    # via\n    #   jinja2\n    #   werkzeug\nmatplotlib==3.10.8\n    # via -r requirements.in\nmpmath==1.3.0\n    # via sympy\nnarwhals==2.16.0\n    # via altair\nnetworkx==3.4.2\n    # via torch\nnumpy==2.2.6\n    # via\n    #   -r requirements.in\n    #   contourpy\n    #   gymnasium\n    #   imageio\n    #   matplotlib\n    #   opencv-python-headless\n    #   pandas\n    #   pydeck\n    #   streamlit\n    #   tensorboard\nopencv-python-headless==4.13.0.92\n    # via -r requirements.in\npackaging==26.0\n    # via\n    #   altair\n    #   matplotlib\n    #   streamlit\n    #   tensorboard\npandas==2.3.3\n    # via\n    #   -r requirements.in\n    #   streamlit\npillow==12.1.1\n    # via\n    #   imageio\n    #   matplotlib\n    #   streamlit\n    #   tensorboard\nprotobuf==6.33.5\n    # via\n    #   streamlit\n    #   tensorboard\npyarrow==23.0.1\n    # via streamlit\npydeck==0.9.1\n    # via streamlit\npygame==2.6.1\n    # via -r requirements.in\npyparsing==3.3.2\n    # via matplotlib\npypdf==6.7.1\n    # via -r requirements.in\npython-dateutil==2.9.0.post0\n    # via\n    #   matplotlib\n    #   pandas\npytz==2025.2\n    # via pandas\npyyaml==6.0.3\n    # via -r requirements.in\nreferencing==0.37.0\n    # via\n    #   jsonschema\n    #   jsonschema-specifications\nrequests==2.32.5\n    # via\n    #   -r requirements.in\n    #   streamlit\nrpds-py==0.30.0\n    # via\n    #   jsonschema\n    #   referencing\nsix==1.17.0\n    # via python-dateutil\nsmmap==5.0.2\n    # via gitdb\nstreamlit==1.54.0\n    # via -r requirements.in\nsympy==1.14.0\n    # via torch\ntenacity==9.1.4\n    # via streamlit\ntensorboard==2.20.0\n    # via -r requirements.in\ntensorboard-data-server==0.7.2\n    # via tensorboard\ntoml==0.10.2\n    # via streamlit\ntorch==2.10.0\n    # via -r requirements.in\ntornado==6.5.4\n    # via streamlit\ntyping-extensions==4.15.0\n    # via\n    #   altair\n    #   grpcio\n    #   gymnasium\n    #   streamlit\n    #   torch\ntzdata==2025.3\n    # via pandas\nurllib3==2.6.3\n    # via requests\nwerkzeug==3.1.5\n    # via tensorboard\n\n# The following packages are considered to be unsafe in a requirements file:\n# setuptools\n",
      "base": "#\n# This file is autogenerated by pip-compile with Python 3.10\n# by the following command:\n#\n#    pip-compile requirements.in\n#\nabsl-py==2.4.0\n    # via tensorboard\naltair==6.0.0\n    # via streamlit\nattrs==25.4.0\n    # via\n    #   jsonschema\n    #   referencing\nblinker==1.9.0\n    # via streamlit\ncachetools==6.2.6\n    # via streamlit\ncertifi==2026.1.4\n    # via requests\ncharset-normalizer==3.4.4\n    # via requests\nclick==8.3.1\n    # via streamlit\ncloudpickle==3.1.2\n    # via gymnasium\ncontourpy==1.3.2\n    # via matplotlib\ncuda-bindings==12.9.4\n    # via torch\ncuda-pathfinder==1.3.4\n    # via cuda-bindings\ncycler==0.12.1\n    # via matplotlib\nfarama-notifications==0.0.4\n    # via gymnasium\nfilelock==3.24.2\n    # via torch\nfonttools==4.61.1\n    # via matplotlib\nfsspec==2026.2.0\n    # via torch\ngitdb==4.0.12\n    # via gitpython\ngitpython==3.1.46\n    # via streamlit\ngrpcio==1.78.0\n    # via tensorboard\ngymnasium==1.2.3\n    # via -r requirements.in\nidna==3.11\n    # via requests\nimageio==2.37.2\n    # via -r requirements.in\nimageio-ffmpeg==0.6.0\n    # via -r requirements.in\njinja2==3.1.6\n    # via\n    #   altair\n    #   pydeck\n    #   torch\njsonschema==4.26.0\n    # via altair\njsonschema-specifications==2025.9.1\n    # via jsonschema\nkiwisolver==1.4.9\n    # via matplotlib\nmarkdown==3.10.2\n    # via tensorboard\nmarkupsafe==3.0.3\n    # via\n    #   jinja2\n    #   werkzeug\nmatplotlib==3.10.8\n    # via -r requirements.in\nmpmath==1.3.0\n    # via sympy\nnarwhals==2.16.0\n    # via altair\nnetworkx==3.4.2\n    # via torch\nnumpy==2.2.6\n    # via\n    #   -r requirements.in\n    #   contourpy\n    #   gymnasium\n    #   imageio\n    #   matplotlib\n    #   opencv-python-headless\n    #   pandas\n    #   pydeck\n    #   streamlit\n    #   tensorboard\nnvidia-cublas-cu12==12.8.4.1\n    # via\n    #   nvidia-cudnn-cu12\n    #   nvidia-cusolver-cu12\n    #   torch\nnvidia-cuda-cupti-cu12==12.8.90\n    # via torch\nnvidia-cuda-nvrtc-cu12==12.8.93\n    # via torch\nnvidia-cuda-runtime-cu12==12.8.90\n    # via torch\nnvidia-cudnn-cu12==9.10.2.21\n    # via torch\nnvidia-cufft-cu12==11.3.3.83\n    # via torch\nnvidia-cufile-cu12==1.13.1.3\n    # via torch\nnvidia-curand-cu12==10.3.9.90\n    # via torch\nnvidia-cusolver-cu12==11.7.3.90\n    # via torch\nnvidia-cusparse-cu12==12.5.8.93\n    # via\n    #   nvidia-cusolver-cu12\n    #   torch\nnvidia-cusparselt-cu12==0.7.1\n    # via torch\nnvidia-nccl-cu12==2.27.5\n    # via torch\nnvidia-nvjitlink-cu12==12.8.93\n    # via\n    #   nvidia-cufft-cu12\n    #   nvidia-cusolver-cu12\n    #   nvidia-cusparse-cu12\n    #   torch\nnvidia-nvshmem-cu12==3.4.5\n    # via torch\nnvidia-nvtx-cu12==12.8.90\n    # via torch\nopencv-python-headless==4.13.0.92\n    # via -r requirements.in\npackaging==26.0\n    # via\n    #   altair\n    #   matplotlib\n    #   streamlit\n    #   tensorboard\npandas==2.3.3\n    # via\n    #   -r requirements.in\n    #   streamlit\npillow==12.1.1\n    # via\n    #   imageio\n    #   matplotlib\n    #   streamlit\n    #   tensorboard\nprotobuf==6.33.5\n    # via\n    #   streamlit\n    #   tensorboard\npyarrow==23.0.1\n    # via streamlit\npydeck==0.9.1\n    # via streamlit\npyparsing==3.3.2\n    # via matplotlib\npypdf==6.7.1\n    # via -r requirements.in\npython-dateutil==2.9.0.post0\n    # via\n    #   matplotlib\n    #   pandas\npytz==2025.2\n    # via pandas\npyyaml==6.0.3\n    # via -r requirements.in\nreferencing==0.37.0\n    # via\n    #   jsonschema\n    #   jsonschema-specifications\nrequests==2.32.5\n    # via\n    #   -r requirements.in\n    #   streamlit\nrpds-py==0.30.0\n    # via\n    #   jsonschema\n    #   referencing\nsix==1.17.0\n    # via python-dateutil\nsmmap==5.0.2\n    # via gitdb\nstreamlit==1.54.0\n    # via -r requirements.in\nsympy==1.14.0\n    # via torch\ntenacity==9.1.4\n    # via streamlit\ntensorboard==2.20.0\n    # via -r requirements.in\ntensorboard-data-server==0.7.2\n    # via tensorboard\ntoml==0.10.2\n    # via streamlit\ntorch==2.10.0\n    # via -r requirements.in\ntornado==6.5.4\n    # via streamlit\ntriton==3.6.0\n    # via torch\ntyping-extensions==4.15.0\n    # via\n    #   altair\n    #   grpcio\n    #   gymnasium\n    #   pypdf\n    #   referencing\n    #   streamlit\n    #   torch\ntzdata==2025.3\n    # via pandas\nurllib3==2.6.3\n    # via requests\nwatchdog==6.0.0\n    # via streamlit\nwerkzeug==3.1.5\n    # via tensorboard\n\n# The following packages are considered to be unsafe in a requirements file:\n# setuptools\n"
    },
    "scenarios/13_play_module_imports.md": {
      "additions": 26,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/scenarios/13_play_module_imports.md b/scenarios/13_play_module_imports.md\nnew file mode 100644\nindex 0000000..d468c2d\n--- /dev/null\n+++ b/scenarios/13_play_module_imports.md\n@@ -0,0 +1,26 @@\n+# Scenario: Play Module Importable\n+\n+## Category\n+integration\n+\n+## Preconditions\n+- `src/play/play_minipong.py` exists\n+- pygame is installed\n+\n+## Behavioral Expectation\n+The play module is importable without side effects (no window opened on import). It must expose the main entry point and import game env + agent dependencies cleanly.\n+\n+## Evaluation Method\n+```bash\n+python -c \"\n+import src.play.play_minipong as play\n+assert hasattr(play, 'main'), 'play_minipong must have a main() function'\n+print('PASS: play module imports cleanly')\n+\"\n+```\n+\n+## Pass Criteria\n+Script exits with code 0 and prints PASS message. No pygame window opened.\n+\n+## Evidence Required\n+- stdout/stderr from the evaluation command\n",
      "raw": "# Scenario: Play Module Importable\n\n## Category\nintegration\n\n## Preconditions\n- `src/play/play_minipong.py` exists\n- pygame is installed\n\n## Behavioral Expectation\nThe play module is importable without side effects (no window opened on import). It must expose the main entry point and import game env + agent dependencies cleanly.\n\n## Evaluation Method\n```bash\npython -c \"\nimport src.play.play_minipong as play\nassert hasattr(play, 'main'), 'play_minipong must have a main() function'\nprint('PASS: play module imports cleanly')\n\"\n```\n\n## Pass Criteria\nScript exits with code 0 and prints PASS message. No pygame window opened.\n\n## Evidence Required\n- stdout/stderr from the evaluation command\n",
      "base": ""
    },
    "scenarios/14_play_makefile_targets.md": {
      "additions": 52,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/scenarios/14_play_makefile_targets.md b/scenarios/14_play_makefile_targets.md\nnew file mode 100644\nindex 0000000..f3a9e76\n--- /dev/null\n+++ b/scenarios/14_play_makefile_targets.md\n@@ -0,0 +1,52 @@\n+# Scenario: Play Makefile Targets Exist\n+\n+## Category\n+integration\n+\n+## Preconditions\n+- Makefile exists at repo root\n+\n+## Behavioral Expectation\n+The Makefile defines `play`, `play-debug`, and `play-agent-vs-agent` targets. Each target invokes the correct Python module with the expected arguments.\n+\n+## Evaluation Method\n+```bash\n+python -c \"\n+import re\n+\n+with open('Makefile') as f:\n+    content = f.read()\n+\n+# Check targets exist\n+for target in ['play:', 'play-debug:', 'play-agent-vs-agent:']:\n+    assert target in content, f'Missing Makefile target: {target}'\n+\n+# Check play target runs the right module\n+assert 'src.play.play_minipong' in content, 'play target must run src.play.play_minipong'\n+\n+# Check play-debug passes --debug flag\n+lines = content.split('\\n')\n+in_debug_target = False\n+found_debug_flag = False\n+for line in lines:\n+    if line.startswith('play-debug:') or line.startswith('play-debug :'):\n+        in_debug_target = True\n+        continue\n+    if in_debug_target:\n+        if line.startswith('\\t') or line.startswith(' '):\n+            if '--debug' in line:\n+                found_debug_flag = True\n+                break\n+        elif line.strip() and not line.startswith('\\t') and not line.startswith(' '):\n+            break\n+assert found_debug_flag, 'play-debug target must pass --debug flag'\n+\n+print('PASS: all play Makefile targets present and correct')\n+\"\n+```\n+\n+## Pass Criteria\n+Script exits with code 0 and prints PASS message.\n+\n+## Evidence Required\n+- stdout/stderr from the evaluation command\n",
      "raw": "# Scenario: Play Makefile Targets Exist\n\n## Category\nintegration\n\n## Preconditions\n- Makefile exists at repo root\n\n## Behavioral Expectation\nThe Makefile defines `play`, `play-debug`, and `play-agent-vs-agent` targets. Each target invokes the correct Python module with the expected arguments.\n\n## Evaluation Method\n```bash\npython -c \"\nimport re\n\nwith open('Makefile') as f:\n    content = f.read()\n\n# Check targets exist\nfor target in ['play:', 'play-debug:', 'play-agent-vs-agent:']:\n    assert target in content, f'Missing Makefile target: {target}'\n\n# Check play target runs the right module\nassert 'src.play.play_minipong' in content, 'play target must run src.play.play_minipong'\n\n# Check play-debug passes --debug flag\nlines = content.split('\\n')\nin_debug_target = False\nfound_debug_flag = False\nfor line in lines:\n    if line.startswith('play-debug:') or line.startswith('play-debug :'):\n        in_debug_target = True\n        continue\n    if in_debug_target:\n        if line.startswith('\\t') or line.startswith(' '):\n            if '--debug' in line:\n                found_debug_flag = True\n                break\n        elif line.strip() and not line.startswith('\\t') and not line.startswith(' '):\n            break\nassert found_debug_flag, 'play-debug target must pass --debug flag'\n\nprint('PASS: all play Makefile targets present and correct')\n\"\n```\n\n## Pass Criteria\nScript exits with code 0 and prints PASS message.\n\n## Evidence Required\n- stdout/stderr from the evaluation command\n",
      "base": ""
    },
    "scenarios/15_two_player_controls.md": {
      "additions": 41,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/scenarios/15_two_player_controls.md b/scenarios/15_two_player_controls.md\nnew file mode 100644\nindex 0000000..a3ba34c\n--- /dev/null\n+++ b/scenarios/15_two_player_controls.md\n@@ -0,0 +1,41 @@\n+# Scenario: Two-Player Keyboard Controls\n+\n+## Category\n+environment\n+\n+## Preconditions\n+- `src/play/play_minipong.py` exists and is importable\n+- Play module exposes an internal game state or testable action-mapping function\n+\n+## Behavioral Expectation\n+The play module maps keyboard inputs to paddle actions correctly:\n+- Left player: Q=UP, A=DOWN, no key=STAY\n+- Right player: P=UP, L=DOWN, no key=STAY\n+\n+The action mapping must be decoupled from the pygame event loop so it can be tested without a display.\n+\n+## Evaluation Method\n+```bash\n+python -c \"\n+from src.play.play_minipong import get_action_from_keys\n+\n+# Simulate key states as a dict or set of pressed keys\n+# Left player: Q=UP(0), A=DOWN(1), neither=STAY(2)\n+assert get_action_from_keys('left', pressed={'q'}) == 0, 'Q should map to UP(0) for left'\n+assert get_action_from_keys('left', pressed={'a'}) == 1, 'A should map to DOWN(1) for left'\n+assert get_action_from_keys('left', pressed=set()) == 2, 'No key should map to STAY(2) for left'\n+\n+# Right player: P=UP(0), L=DOWN(1), neither=STAY(2)\n+assert get_action_from_keys('right', pressed={'p'}) == 0, 'P should map to UP(0) for right'\n+assert get_action_from_keys('right', pressed={'l'}) == 1, 'L should map to DOWN(1) for right'\n+assert get_action_from_keys('right', pressed=set()) == 2, 'No key should map to STAY(2) for right'\n+\n+print('PASS: two-player keyboard controls map correctly')\n+\"\n+```\n+\n+## Pass Criteria\n+Script exits with code 0 and prints PASS message.\n+\n+## Evidence Required\n+- stdout/stderr from the evaluation command\n",
      "raw": "# Scenario: Two-Player Keyboard Controls\n\n## Category\nenvironment\n\n## Preconditions\n- `src/play/play_minipong.py` exists and is importable\n- Play module exposes an internal game state or testable action-mapping function\n\n## Behavioral Expectation\nThe play module maps keyboard inputs to paddle actions correctly:\n- Left player: Q=UP, A=DOWN, no key=STAY\n- Right player: P=UP, L=DOWN, no key=STAY\n\nThe action mapping must be decoupled from the pygame event loop so it can be tested without a display.\n\n## Evaluation Method\n```bash\npython -c \"\nfrom src.play.play_minipong import get_action_from_keys\n\n# Simulate key states as a dict or set of pressed keys\n# Left player: Q=UP(0), A=DOWN(1), neither=STAY(2)\nassert get_action_from_keys('left', pressed={'q'}) == 0, 'Q should map to UP(0) for left'\nassert get_action_from_keys('left', pressed={'a'}) == 1, 'A should map to DOWN(1) for left'\nassert get_action_from_keys('left', pressed=set()) == 2, 'No key should map to STAY(2) for left'\n\n# Right player: P=UP(0), L=DOWN(1), neither=STAY(2)\nassert get_action_from_keys('right', pressed={'p'}) == 0, 'P should map to UP(0) for right'\nassert get_action_from_keys('right', pressed={'l'}) == 1, 'L should map to DOWN(1) for right'\nassert get_action_from_keys('right', pressed=set()) == 2, 'No key should map to STAY(2) for right'\n\nprint('PASS: two-player keyboard controls map correctly')\n\"\n```\n\n## Pass Criteria\nScript exits with code 0 and prints PASS message.\n\n## Evidence Required\n- stdout/stderr from the evaluation command\n",
      "base": ""
    },
    "scenarios/16_agent_takeover_toggle.md": {
      "additions": 57,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/scenarios/16_agent_takeover_toggle.md b/scenarios/16_agent_takeover_toggle.md\nnew file mode 100644\nindex 0000000..c5fcd6f\n--- /dev/null\n+++ b/scenarios/16_agent_takeover_toggle.md\n@@ -0,0 +1,57 @@\n+# Scenario: Agent Takeover Toggle Logic\n+\n+## Category\n+environment\n+\n+## Preconditions\n+- `src/play/play_minipong.py` exists and is importable\n+- Play module exposes a testable game state class or controller\n+\n+## Behavioral Expectation\n+The agent takeover toggle works correctly:\n+1. Both sides start as human-controlled.\n+2. Toggling agent on a side switches it to AI control.\n+3. Toggling again switches it back to human control.\n+4. Both sides can be agent-controlled simultaneously.\n+5. State survives game restart (the toggle is not reset when R is pressed).\n+\n+## Evaluation Method\n+```bash\n+python -c \"\n+from src.play.play_minipong import GameController\n+\n+gc = GameController()\n+\n+# Both sides start as human\n+assert gc.get_controller('left') == 'human', 'Left should start as human'\n+assert gc.get_controller('right') == 'human', 'Right should start as human'\n+\n+# Toggle left to agent\n+gc.toggle_agent('left')\n+assert gc.get_controller('left') == 'agent', 'Left should be agent after toggle'\n+assert gc.get_controller('right') == 'human', 'Right should still be human'\n+\n+# Toggle right to agent (both agent)\n+gc.toggle_agent('right')\n+assert gc.get_controller('left') == 'agent', 'Left should still be agent'\n+assert gc.get_controller('right') == 'agent', 'Right should be agent after toggle'\n+\n+# Toggle left back to human\n+gc.toggle_agent('left')\n+assert gc.get_controller('left') == 'human', 'Left should be human after second toggle'\n+assert gc.get_controller('right') == 'agent', 'Right should still be agent'\n+\n+# Simulate restart \u2014 agent state must persist\n+gc.restart()\n+assert gc.get_controller('left') == 'human', 'Left should remain human after restart'\n+assert gc.get_controller('right') == 'agent', 'Right should remain agent after restart'\n+\n+print('PASS: agent takeover toggle logic is correct')\n+\"\n+```\n+\n+## Pass Criteria\n+Script exits with code 0 and prints PASS message.\n+\n+## Evidence Required\n+- stdout/stderr from the evaluation command\n",
      "raw": "# Scenario: Agent Takeover Toggle Logic\n\n## Category\nenvironment\n\n## Preconditions\n- `src/play/play_minipong.py` exists and is importable\n- Play module exposes a testable game state class or controller\n\n## Behavioral Expectation\nThe agent takeover toggle works correctly:\n1. Both sides start as human-controlled.\n2. Toggling agent on a side switches it to AI control.\n3. Toggling again switches it back to human control.\n4. Both sides can be agent-controlled simultaneously.\n5. State survives game restart (the toggle is not reset when R is pressed).\n\n## Evaluation Method\n```bash\npython -c \"\nfrom src.play.play_minipong import GameController\n\ngc = GameController()\n\n# Both sides start as human\nassert gc.get_controller('left') == 'human', 'Left should start as human'\nassert gc.get_controller('right') == 'human', 'Right should start as human'\n\n# Toggle left to agent\ngc.toggle_agent('left')\nassert gc.get_controller('left') == 'agent', 'Left should be agent after toggle'\nassert gc.get_controller('right') == 'human', 'Right should still be human'\n\n# Toggle right to agent (both agent)\ngc.toggle_agent('right')\nassert gc.get_controller('left') == 'agent', 'Left should still be agent'\nassert gc.get_controller('right') == 'agent', 'Right should be agent after toggle'\n\n# Toggle left back to human\ngc.toggle_agent('left')\nassert gc.get_controller('left') == 'human', 'Left should be human after second toggle'\nassert gc.get_controller('right') == 'agent', 'Right should still be agent'\n\n# Simulate restart \u2014 agent state must persist\ngc.restart()\nassert gc.get_controller('left') == 'human', 'Left should remain human after restart'\nassert gc.get_controller('right') == 'agent', 'Right should remain agent after restart'\n\nprint('PASS: agent takeover toggle logic is correct')\n\"\n```\n\n## Pass Criteria\nScript exits with code 0 and prints PASS message.\n\n## Evidence Required\n- stdout/stderr from the evaluation command\n",
      "base": ""
    },
    "scenarios/17_player_status_tags.md": {
      "additions": 76,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/scenarios/17_player_status_tags.md b/scenarios/17_player_status_tags.md\nnew file mode 100644\nindex 0000000..d358b6d\n--- /dev/null\n+++ b/scenarios/17_player_status_tags.md\n@@ -0,0 +1,76 @@\n+# Scenario: Player Status Tags Reflect True State\n+\n+## Category\n+environment\n+\n+## Preconditions\n+- `src/play/play_minipong.py` exists and is importable\n+- Play module exposes a testable game state class or controller\n+\n+## Behavioral Expectation\n+The player status tag must accurately reflect who is currently controlling each paddle at all times:\n+- Human left: \"Keyboard: Up:Q, Down:A\"\n+- Human right: \"Keyboard: Up:P, Down:L\"\n+- Agent: \"AI Agent\"\n+- Debug mode agent: \"Policy: <policy_name>\"\n+\n+Tags must update immediately when a takeover toggle occurs and survive game restarts.\n+\n+## Evaluation Method\n+```bash\n+python -c \"\n+from src.play.play_minipong import GameController\n+\n+# Normal mode (no debug)\n+gc = GameController(debug=False)\n+\n+# Both human initially\n+left_tag = gc.get_status_tag('left')\n+right_tag = gc.get_status_tag('right')\n+assert 'Keyboard' in left_tag, f'Left human tag should contain Keyboard, got: {left_tag}'\n+assert 'Up:Q' in left_tag, f'Left human tag should show Q key, got: {left_tag}'\n+assert 'Down:A' in left_tag, f'Left human tag should show A key, got: {left_tag}'\n+assert 'Keyboard' in right_tag, f'Right human tag should contain Keyboard, got: {right_tag}'\n+assert 'Up:P' in right_tag, f'Right human tag should show P key, got: {right_tag}'\n+assert 'Down:L' in right_tag, f'Right human tag should show L key, got: {right_tag}'\n+\n+# Toggle left to agent\n+gc.toggle_agent('left')\n+left_tag = gc.get_status_tag('left')\n+assert left_tag == 'AI Agent', f'Left agent tag should be AI Agent, got: {left_tag}'\n+right_tag = gc.get_status_tag('right')\n+assert 'Keyboard' in right_tag, f'Right should still show Keyboard, got: {right_tag}'\n+\n+# Toggle back to human \u2014 tag must revert\n+gc.toggle_agent('left')\n+left_tag = gc.get_status_tag('left')\n+assert 'Keyboard' in left_tag, f'Left should revert to Keyboard tag, got: {left_tag}'\n+\n+# Restart \u2014 tags must persist state\n+gc.toggle_agent('right')\n+gc.restart()\n+right_tag = gc.get_status_tag('right')\n+assert right_tag == 'AI Agent', f'Right agent tag should survive restart, got: {right_tag}'\n+\n+# Debug mode shows policy name\n+gc_debug = GameController(debug=True, checkpoint_path='checkpoint_50000.pt')\n+gc_debug.toggle_agent('left')\n+left_tag = gc_debug.get_status_tag('left')\n+assert 'Policy:' in left_tag, f'Debug agent tag should contain Policy:, got: {left_tag}'\n+assert 'checkpoint_50000' in left_tag, f'Debug tag should show checkpoint name, got: {left_tag}'\n+\n+# Debug mode with no checkpoint falls back to random\n+gc_no_ckpt = GameController(debug=True)\n+gc_no_ckpt.toggle_agent('left')\n+left_tag = gc_no_ckpt.get_status_tag('left')\n+assert 'random' in left_tag.lower(), f'Debug tag without checkpoint should show random, got: {left_tag}'\n+\n+print('PASS: player status tags accurately reflect true state in all modes')\n+\"\n+```\n+\n+## Pass Criteria\n+Script exits with code 0 and prints PASS message.\n+\n+## Evidence Required\n+- stdout/stderr from the evaluation command\n",
      "raw": "# Scenario: Player Status Tags Reflect True State\n\n## Category\nenvironment\n\n## Preconditions\n- `src/play/play_minipong.py` exists and is importable\n- Play module exposes a testable game state class or controller\n\n## Behavioral Expectation\nThe player status tag must accurately reflect who is currently controlling each paddle at all times:\n- Human left: \"Keyboard: Up:Q, Down:A\"\n- Human right: \"Keyboard: Up:P, Down:L\"\n- Agent: \"AI Agent\"\n- Debug mode agent: \"Policy: <policy_name>\"\n\nTags must update immediately when a takeover toggle occurs and survive game restarts.\n\n## Evaluation Method\n```bash\npython -c \"\nfrom src.play.play_minipong import GameController\n\n# Normal mode (no debug)\ngc = GameController(debug=False)\n\n# Both human initially\nleft_tag = gc.get_status_tag('left')\nright_tag = gc.get_status_tag('right')\nassert 'Keyboard' in left_tag, f'Left human tag should contain Keyboard, got: {left_tag}'\nassert 'Up:Q' in left_tag, f'Left human tag should show Q key, got: {left_tag}'\nassert 'Down:A' in left_tag, f'Left human tag should show A key, got: {left_tag}'\nassert 'Keyboard' in right_tag, f'Right human tag should contain Keyboard, got: {right_tag}'\nassert 'Up:P' in right_tag, f'Right human tag should show P key, got: {right_tag}'\nassert 'Down:L' in right_tag, f'Right human tag should show L key, got: {right_tag}'\n\n# Toggle left to agent\ngc.toggle_agent('left')\nleft_tag = gc.get_status_tag('left')\nassert left_tag == 'AI Agent', f'Left agent tag should be AI Agent, got: {left_tag}'\nright_tag = gc.get_status_tag('right')\nassert 'Keyboard' in right_tag, f'Right should still show Keyboard, got: {right_tag}'\n\n# Toggle back to human \u2014 tag must revert\ngc.toggle_agent('left')\nleft_tag = gc.get_status_tag('left')\nassert 'Keyboard' in left_tag, f'Left should revert to Keyboard tag, got: {left_tag}'\n\n# Restart \u2014 tags must persist state\ngc.toggle_agent('right')\ngc.restart()\nright_tag = gc.get_status_tag('right')\nassert right_tag == 'AI Agent', f'Right agent tag should survive restart, got: {right_tag}'\n\n# Debug mode shows policy name\ngc_debug = GameController(debug=True, checkpoint_path='checkpoint_50000.pt')\ngc_debug.toggle_agent('left')\nleft_tag = gc_debug.get_status_tag('left')\nassert 'Policy:' in left_tag, f'Debug agent tag should contain Policy:, got: {left_tag}'\nassert 'checkpoint_50000' in left_tag, f'Debug tag should show checkpoint name, got: {left_tag}'\n\n# Debug mode with no checkpoint falls back to random\ngc_no_ckpt = GameController(debug=True)\ngc_no_ckpt.toggle_agent('left')\nleft_tag = gc_no_ckpt.get_status_tag('left')\nassert 'random' in left_tag.lower(), f'Debug tag without checkpoint should show random, got: {left_tag}'\n\nprint('PASS: player status tags accurately reflect true state in all modes')\n\"\n```\n\n## Pass Criteria\nScript exits with code 0 and prints PASS message.\n\n## Evidence Required\n- stdout/stderr from the evaluation command\n",
      "base": ""
    },
    "scenarios/18_continuous_play.md": {
      "additions": 48,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/scenarios/18_continuous_play.md b/scenarios/18_continuous_play.md\nnew file mode 100644\nindex 0000000..18f0593\n--- /dev/null\n+++ b/scenarios/18_continuous_play.md\n@@ -0,0 +1,48 @@\n+# Scenario: Continuous Play (Multi-Rally)\n+\n+## Category\n+environment\n+\n+## Preconditions\n+- MiniPong environment and play module are importable\n+\n+## Behavioral Expectation\n+The game does NOT end after a single point. After a score, the ball resets to center and play continues. The game tracks cumulative scores for both sides. An episode ends when a configurable score limit is reached (default 11).\n+\n+## Evaluation Method\n+```bash\n+python -c \"\n+from src.envs.minipong import MiniPongEnv, MiniPongConfig\n+\n+# Use a multi-point config \u2014 game should not end after 1 point\n+config = MiniPongConfig(max_steps=5000, score_limit=11)\n+env = MiniPongEnv(config=config)\n+obs, info = env.reset(seed=42)\n+\n+total_steps = 0\n+points_scored = 0\n+max_score_seen = 0\n+\n+for _ in range(3000):\n+    action = env.action_space.sample()\n+    obs, reward, terminated, truncated, info = env.step(action)\n+    total_steps += 1\n+    if reward != 0:\n+        points_scored += 1\n+    current_max = max(info.get('agent_score', 0), info.get('opponent_score', 0))\n+    max_score_seen = max(max_score_seen, current_max)\n+    if terminated or truncated:\n+        break\n+\n+# Must have scored multiple points in a single episode\n+assert points_scored > 1, f'Expected multiple points in one episode, got {points_scored}'\n+assert max_score_seen > 1, f'Expected cumulative score > 1, got {max_score_seen}'\n+print(f'PASS: continuous play works \u2014 {points_scored} points scored, max score {max_score_seen} in {total_steps} steps')\n+\"\n+```\n+\n+## Pass Criteria\n+Script exits with code 0. Multiple points scored in a single episode without premature termination.\n+\n+## Evidence Required\n+- stdout showing points scored and max score achieved\n",
      "raw": "# Scenario: Continuous Play (Multi-Rally)\n\n## Category\nenvironment\n\n## Preconditions\n- MiniPong environment and play module are importable\n\n## Behavioral Expectation\nThe game does NOT end after a single point. After a score, the ball resets to center and play continues. The game tracks cumulative scores for both sides. An episode ends when a configurable score limit is reached (default 11).\n\n## Evaluation Method\n```bash\npython -c \"\nfrom src.envs.minipong import MiniPongEnv, MiniPongConfig\n\n# Use a multi-point config \u2014 game should not end after 1 point\nconfig = MiniPongConfig(max_steps=5000, score_limit=11)\nenv = MiniPongEnv(config=config)\nobs, info = env.reset(seed=42)\n\ntotal_steps = 0\npoints_scored = 0\nmax_score_seen = 0\n\nfor _ in range(3000):\n    action = env.action_space.sample()\n    obs, reward, terminated, truncated, info = env.step(action)\n    total_steps += 1\n    if reward != 0:\n        points_scored += 1\n    current_max = max(info.get('agent_score', 0), info.get('opponent_score', 0))\n    max_score_seen = max(max_score_seen, current_max)\n    if terminated or truncated:\n        break\n\n# Must have scored multiple points in a single episode\nassert points_scored > 1, f'Expected multiple points in one episode, got {points_scored}'\nassert max_score_seen > 1, f'Expected cumulative score > 1, got {max_score_seen}'\nprint(f'PASS: continuous play works \u2014 {points_scored} points scored, max score {max_score_seen} in {total_steps} steps')\n\"\n```\n\n## Pass Criteria\nScript exits with code 0. Multiple points scored in a single episode without premature termination.\n\n## Evidence Required\n- stdout showing points scored and max score achieved\n",
      "base": ""
    },
    "scenarios/19_agent_observation_flip.md": {
      "additions": 48,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/scenarios/19_agent_observation_flip.md b/scenarios/19_agent_observation_flip.md\nnew file mode 100644\nindex 0000000..2203665\n--- /dev/null\n+++ b/scenarios/19_agent_observation_flip.md\n@@ -0,0 +1,48 @@\n+# Scenario: Right-Side Agent Receives Flipped Observation\n+\n+## Category\n+environment\n+\n+## Preconditions\n+- `src/play/play_minipong.py` is importable\n+- Play module exposes a function to prepare observations for the agent\n+\n+## Behavioral Expectation\n+When the agent controls the RIGHT side, the observation must be horizontally flipped so the agent always \"sees\" itself on the left side (matching the training perspective where the agent is always the left paddle).\n+\n+## Evaluation Method\n+```bash\n+python -c \"\n+import numpy as np\n+from src.envs.minipong import MiniPongEnv\n+from src.play.play_minipong import prepare_agent_obs\n+\n+env = MiniPongEnv(render_mode='rgb_array')\n+obs, _ = env.reset(seed=42)\n+\n+# For left side, observation should be unchanged\n+obs_left = prepare_agent_obs(obs, side='left')\n+assert np.array_equal(obs, obs_left), 'Left-side obs should be unmodified'\n+\n+# For right side, observation should be horizontally flipped\n+obs_right = prepare_agent_obs(obs, side='right')\n+expected_flip = np.flip(obs, axis=1)\n+assert np.array_equal(obs_right, expected_flip), 'Right-side obs should be horizontally flipped'\n+\n+# Verify they are actually different (non-symmetric frame)\n+# Step a few times to get an asymmetric frame\n+for _ in range(10):\n+    obs, _, _, _, _ = env.step(0)\n+obs_left = prepare_agent_obs(obs, side='left')\n+obs_right = prepare_agent_obs(obs, side='right')\n+assert not np.array_equal(obs_left, obs_right), 'Left and right obs should differ for asymmetric frames'\n+\n+print('PASS: right-side agent receives correctly flipped observation')\n+\"\n+```\n+\n+## Pass Criteria\n+Script exits with code 0 and prints PASS message.\n+\n+## Evidence Required\n+- stdout/stderr from the evaluation command\n",
      "raw": "# Scenario: Right-Side Agent Receives Flipped Observation\n\n## Category\nenvironment\n\n## Preconditions\n- `src/play/play_minipong.py` is importable\n- Play module exposes a function to prepare observations for the agent\n\n## Behavioral Expectation\nWhen the agent controls the RIGHT side, the observation must be horizontally flipped so the agent always \"sees\" itself on the left side (matching the training perspective where the agent is always the left paddle).\n\n## Evaluation Method\n```bash\npython -c \"\nimport numpy as np\nfrom src.envs.minipong import MiniPongEnv\nfrom src.play.play_minipong import prepare_agent_obs\n\nenv = MiniPongEnv(render_mode='rgb_array')\nobs, _ = env.reset(seed=42)\n\n# For left side, observation should be unchanged\nobs_left = prepare_agent_obs(obs, side='left')\nassert np.array_equal(obs, obs_left), 'Left-side obs should be unmodified'\n\n# For right side, observation should be horizontally flipped\nobs_right = prepare_agent_obs(obs, side='right')\nexpected_flip = np.flip(obs, axis=1)\nassert np.array_equal(obs_right, expected_flip), 'Right-side obs should be horizontally flipped'\n\n# Verify they are actually different (non-symmetric frame)\n# Step a few times to get an asymmetric frame\nfor _ in range(10):\n    obs, _, _, _, _ = env.step(0)\nobs_left = prepare_agent_obs(obs, side='left')\nobs_right = prepare_agent_obs(obs, side='right')\nassert not np.array_equal(obs_left, obs_right), 'Left and right obs should differ for asymmetric frames'\n\nprint('PASS: right-side agent receives correctly flipped observation')\n\"\n```\n\n## Pass Criteria\nScript exits with code 0 and prints PASS message.\n\n## Evidence Required\n- stdout/stderr from the evaluation command\n",
      "base": ""
    },
    "scenarios/20_pygame_dependency.md": {
      "additions": 26,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/scenarios/20_pygame_dependency.md b/scenarios/20_pygame_dependency.md\nnew file mode 100644\nindex 0000000..ff17078\n--- /dev/null\n+++ b/scenarios/20_pygame_dependency.md\n@@ -0,0 +1,26 @@\n+# Scenario: pygame Listed in Dependencies\n+\n+## Category\n+integration\n+\n+## Preconditions\n+- `requirements.in` exists at repo root\n+\n+## Behavioral Expectation\n+pygame is listed as a dependency in `requirements.in` so the play module can be installed cleanly.\n+\n+## Evaluation Method\n+```bash\n+python -c \"\n+with open('requirements.in') as f:\n+    content = f.read().lower()\n+assert 'pygame' in content, 'pygame must be listed in requirements.in'\n+print('PASS: pygame is in requirements.in')\n+\"\n+```\n+\n+## Pass Criteria\n+Script exits with code 0 and prints PASS message.\n+\n+## Evidence Required\n+- stdout/stderr from the evaluation command\n",
      "raw": "# Scenario: pygame Listed in Dependencies\n\n## Category\nintegration\n\n## Preconditions\n- `requirements.in` exists at repo root\n\n## Behavioral Expectation\npygame is listed as a dependency in `requirements.in` so the play module can be installed cleanly.\n\n## Evaluation Method\n```bash\npython -c \"\nwith open('requirements.in') as f:\n    content = f.read().lower()\nassert 'pygame' in content, 'pygame must be listed in requirements.in'\nprint('PASS: pygame is in requirements.in')\n\"\n```\n\n## Pass Criteria\nScript exits with code 0 and prints PASS message.\n\n## Evidence Required\n- stdout/stderr from the evaluation command\n",
      "base": ""
    },
    "scripts/check_test_quality.py": {
      "additions": 28,
      "deletions": 5,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/scripts/check_test_quality.py b/scripts/check_test_quality.py\nindex 1d0c946..9a0eec8 100644\n--- a/scripts/check_test_quality.py\n+++ b/scripts/check_test_quality.py\n@@ -13,8 +13,9 @@ from __future__ import annotations\n \n import argparse\n import ast\n+import json\n import re\n-from dataclasses import dataclass\n+from dataclasses import asdict, dataclass\n from pathlib import Path\n \n \n@@ -198,6 +199,11 @@ def main() -> int:\n         action=\"store_true\",\n         help=\"Treat warnings as errors\",\n     )\n+    parser.add_argument(\n+        \"--json\",\n+        action=\"store_true\",\n+        help=\"Output results as JSON (for automation)\",\n+    )\n     parser.add_argument(\n         \"--path\",\n         type=str,\n@@ -220,15 +226,32 @@ def main() -> int:\n         findings = check_file(path)\n         all_findings.extend(findings)\n \n-    if not all_findings:\n-        print(\"No test quality issues found.\")\n-        return 0\n-\n     # Group by severity\n     critical = [f for f in all_findings if f.severity == \"CRITICAL\"]\n     warnings = [f for f in all_findings if f.severity == \"WARNING\"]\n     nits = [f for f in all_findings if f.severity == \"NIT\"]\n \n+    if args.json:\n+        result = {\n+            \"name\": \"test_quality\",\n+            \"tool\": \"check_test_quality.py\",\n+            \"status\": \"failed\" if critical else \"passed\",\n+            \"summary\": (\n+                f\"{len(all_findings)} findings ({len(critical)} critical)\"\n+                if critical\n+                else f\"{len(all_findings)} findings\"\n+                if all_findings\n+                else \"Clean\"\n+            ),\n+            \"findings\": [asdict(f) for f in all_findings],\n+        }\n+        print(json.dumps(result, indent=2))\n+        return 1 if critical else 0\n+\n+    if not all_findings:\n+        print(\"No test quality issues found.\")\n+        return 0\n+\n     for finding in all_findings:\n         print(\n             f\"[{finding.severity}] {finding.file}:{finding.line} \"\n",
      "raw": "#!/usr/bin/env python3\n\"\"\"Test quality checker \u2014 detects vacuous tests and gaming patterns.\n\nScans test files for anti-patterns that indicate tests pass by\nconstruction rather than exercising real behavior.\n\nUsage:\n    python scripts/check_test_quality.py\n    python scripts/check_test_quality.py --strict\n\"\"\"\n\nfrom __future__ import annotations\n\nimport argparse\nimport ast\nimport json\nimport re\nfrom dataclasses import asdict, dataclass\nfrom pathlib import Path\n\n\n@dataclass\nclass Finding:\n    \"\"\"A test quality finding.\"\"\"\n\n    file: str\n    line: int\n    severity: str  # CRITICAL, WARNING, NIT\n    pattern: str\n    detail: str\n\n\ndef check_file(path: Path) -> list[Finding]:\n    \"\"\"Check a single test file for anti-patterns.\"\"\"\n    findings: list[Finding] = []\n    content = path.read_text()\n    lines = content.splitlines()\n\n    try:\n        tree = ast.parse(content, filename=str(path))\n    except SyntaxError:\n        findings.append(Finding(\n            file=str(path),\n            line=0,\n            severity=\"CRITICAL\",\n            pattern=\"syntax_error\",\n            detail=\"File has syntax errors \u2014 cannot be parsed\",\n        ))\n        return findings\n\n    # Pattern 1: assert True / assert False / assert 1\n    for i, line in enumerate(lines, 1):\n        stripped = line.strip()\n        if re.match(\n            r\"assert\\s+(True|1|not\\s+False|not\\s+0)\\s*$\",\n            stripped,\n        ):\n            findings.append(Finding(\n                file=str(path),\n                line=i,\n                severity=\"CRITICAL\",\n                pattern=\"tautological_assert\",\n                detail=f\"Tautological assertion: {stripped}\",\n            ))\n\n    # Pattern 2: Test functions with no assertions\n    for node in ast.walk(tree):\n        if isinstance(node, ast.FunctionDef) and node.name.startswith(\n            \"test_\"\n        ):\n            has_assert = False\n            for child in ast.walk(node):\n                if isinstance(child, ast.Assert):\n                    has_assert = True\n                    break\n                # pytest.raises counts as an assertion\n                if isinstance(child, ast.Attribute) and (\n                    child.attr == \"raises\"\n                ):\n                    has_assert = True\n                    break\n                # Check for assert method calls\n                if isinstance(child, ast.Call):\n                    func = child.func\n                    if isinstance(func, ast.Attribute):\n                        if func.attr.startswith(\"assert\"):\n                            has_assert = True\n                            break\n            if not has_assert:\n                findings.append(Finding(\n                    file=str(path),\n                    line=node.lineno,\n                    severity=\"WARNING\",\n                    pattern=\"no_assertions\",\n                    detail=(\n                        f\"Test '{node.name}' has no assertions \"\n                        \"\u2014 may pass vacuously\"\n                    ),\n                ))\n\n    # Pattern 3: Excessive mocking (more than 3 @patch decorators)\n    for node in ast.walk(tree):\n        if isinstance(node, ast.FunctionDef) and node.name.startswith(\n            \"test_\"\n        ):\n            patch_count = 0\n            for decorator in node.decorator_list:\n                if isinstance(decorator, ast.Call):\n                    func = decorator.func\n                    if isinstance(func, ast.Attribute):\n                        if func.attr == \"patch\":\n                            patch_count += 1\n                    elif isinstance(func, ast.Name):\n                        if func.id == \"patch\":\n                            patch_count += 1\n                elif isinstance(decorator, ast.Attribute):\n                    if decorator.attr == \"patch\":\n                        patch_count += 1\n            if patch_count >= 3:\n                findings.append(Finding(\n                    file=str(path),\n                    line=node.lineno,\n                    severity=\"WARNING\",\n                    pattern=\"excessive_mocking\",\n                    detail=(\n                        f\"Test '{node.name}' has {patch_count} \"\n                        \"@patch decorators \u2014 likely testing mocks, \"\n                        \"not real code\"\n                    ),\n                ))\n\n    # Pattern 4: Stub implementations in src/ (not test files)\n    # This is only checked for non-test files\n    if \"/tests/\" not in str(path):\n        for node in ast.walk(tree):\n            if isinstance(node, ast.FunctionDef):\n                body = node.body\n                # Function body is just `pass`\n                if (\n                    len(body) == 1\n                    and isinstance(body[0], ast.Pass)\n                ):\n                    findings.append(Finding(\n                        file=str(path),\n                        line=node.lineno,\n                        severity=\"WARNING\",\n                        pattern=\"stub_implementation\",\n                        detail=(\n                            f\"Function '{node.name}' is a stub \"\n                            \"(just `pass`)\"\n                        ),\n                    ))\n                # Function body is just `return True`\n                if (\n                    len(body) == 1\n                    and isinstance(body[0], ast.Return)\n                    and isinstance(body[0].value, ast.Constant)\n                    and body[0].value.value is True\n                ):\n                    findings.append(Finding(\n                        file=str(path),\n                        line=node.lineno,\n                        severity=\"CRITICAL\",\n                        pattern=\"hardcoded_return\",\n                        detail=(\n                            f\"Function '{node.name}' always \"\n                            \"returns True \u2014 likely a stub\"\n                        ),\n                    ))\n\n    # Pattern 5: Hardcoded lookup tables in src/\n    if \"/tests/\" not in str(path):\n        for i, line in enumerate(lines, 1):\n            # Detect `return x in {literal, literal, ...}`\n            if re.search(\n                r\"return\\s+\\w+\\s+in\\s+\\{[\\d,\\s]+\\}\",\n                line,\n            ):\n                findings.append(Finding(\n                    file=str(path),\n                    line=i,\n                    severity=\"WARNING\",\n                    pattern=\"lookup_table\",\n                    detail=(\n                        \"Function uses hardcoded set membership \"\n                        \"\u2014 may be overfitted to test inputs\"\n                    ),\n                ))\n\n    return findings\n\n\ndef main() -> int:\n    parser = argparse.ArgumentParser(\n        description=\"Check test quality for anti-patterns\"\n    )\n    parser.add_argument(\n        \"--strict\",\n        action=\"store_true\",\n        help=\"Treat warnings as errors\",\n    )\n    parser.add_argument(\n        \"--json\",\n        action=\"store_true\",\n        help=\"Output results as JSON (for automation)\",\n    )\n    parser.add_argument(\n        \"--path\",\n        type=str,\n        default=None,\n        help=\"Specific path to check (default: tests/ and src/)\",\n    )\n    args = parser.parse_args()\n\n    repo_root = Path(__file__).resolve().parent.parent\n    if args.path:\n        paths = list(Path(args.path).rglob(\"*.py\"))\n    else:\n        paths = (\n            list((repo_root / \"tests\").rglob(\"*.py\"))\n            + list((repo_root / \"src\").rglob(\"*.py\"))\n        )\n\n    all_findings: list[Finding] = []\n    for path in paths:\n        findings = check_file(path)\n        all_findings.extend(findings)\n\n    # Group by severity\n    critical = [f for f in all_findings if f.severity == \"CRITICAL\"]\n    warnings = [f for f in all_findings if f.severity == \"WARNING\"]\n    nits = [f for f in all_findings if f.severity == \"NIT\"]\n\n    if args.json:\n        result = {\n            \"name\": \"test_quality\",\n            \"tool\": \"check_test_quality.py\",\n            \"status\": \"failed\" if critical else \"passed\",\n            \"summary\": (\n                f\"{len(all_findings)} findings ({len(critical)} critical)\"\n                if critical\n                else f\"{len(all_findings)} findings\"\n                if all_findings\n                else \"Clean\"\n            ),\n            \"findings\": [asdict(f) for f in all_findings],\n        }\n        print(json.dumps(result, indent=2))\n        return 1 if critical else 0\n\n    if not all_findings:\n        print(\"No test quality issues found.\")\n        return 0\n\n    for finding in all_findings:\n        print(\n            f\"[{finding.severity}] {finding.file}:{finding.line} \"\n            f\"({finding.pattern}): {finding.detail}\"\n        )\n\n    print(f\"\\nTotal: {len(critical)} critical, \"\n          f\"{len(warnings)} warnings, {len(nits)} nits\")\n\n    if critical:\n        return 1\n    if args.strict and warnings:\n        return 1\n    return 0\n\n\nif __name__ == \"__main__\":\n    raise SystemExit(main())\n",
      "base": "#!/usr/bin/env python3\n\"\"\"Test quality checker \u2014 detects vacuous tests and gaming patterns.\n\nScans test files for anti-patterns that indicate tests pass by\nconstruction rather than exercising real behavior.\n\nUsage:\n    python scripts/check_test_quality.py\n    python scripts/check_test_quality.py --strict\n\"\"\"\n\nfrom __future__ import annotations\n\nimport argparse\nimport ast\nimport re\nfrom dataclasses import dataclass\nfrom pathlib import Path\n\n\n@dataclass\nclass Finding:\n    \"\"\"A test quality finding.\"\"\"\n\n    file: str\n    line: int\n    severity: str  # CRITICAL, WARNING, NIT\n    pattern: str\n    detail: str\n\n\ndef check_file(path: Path) -> list[Finding]:\n    \"\"\"Check a single test file for anti-patterns.\"\"\"\n    findings: list[Finding] = []\n    content = path.read_text()\n    lines = content.splitlines()\n\n    try:\n        tree = ast.parse(content, filename=str(path))\n    except SyntaxError:\n        findings.append(Finding(\n            file=str(path),\n            line=0,\n            severity=\"CRITICAL\",\n            pattern=\"syntax_error\",\n            detail=\"File has syntax errors \u2014 cannot be parsed\",\n        ))\n        return findings\n\n    # Pattern 1: assert True / assert False / assert 1\n    for i, line in enumerate(lines, 1):\n        stripped = line.strip()\n        if re.match(\n            r\"assert\\s+(True|1|not\\s+False|not\\s+0)\\s*$\",\n            stripped,\n        ):\n            findings.append(Finding(\n                file=str(path),\n                line=i,\n                severity=\"CRITICAL\",\n                pattern=\"tautological_assert\",\n                detail=f\"Tautological assertion: {stripped}\",\n            ))\n\n    # Pattern 2: Test functions with no assertions\n    for node in ast.walk(tree):\n        if isinstance(node, ast.FunctionDef) and node.name.startswith(\n            \"test_\"\n        ):\n            has_assert = False\n            for child in ast.walk(node):\n                if isinstance(child, ast.Assert):\n                    has_assert = True\n                    break\n                # pytest.raises counts as an assertion\n                if isinstance(child, ast.Attribute) and (\n                    child.attr == \"raises\"\n                ):\n                    has_assert = True\n                    break\n                # Check for assert method calls\n                if isinstance(child, ast.Call):\n                    func = child.func\n                    if isinstance(func, ast.Attribute):\n                        if func.attr.startswith(\"assert\"):\n                            has_assert = True\n                            break\n            if not has_assert:\n                findings.append(Finding(\n                    file=str(path),\n                    line=node.lineno,\n                    severity=\"WARNING\",\n                    pattern=\"no_assertions\",\n                    detail=(\n                        f\"Test '{node.name}' has no assertions \"\n                        \"\u2014 may pass vacuously\"\n                    ),\n                ))\n\n    # Pattern 3: Excessive mocking (more than 3 @patch decorators)\n    for node in ast.walk(tree):\n        if isinstance(node, ast.FunctionDef) and node.name.startswith(\n            \"test_\"\n        ):\n            patch_count = 0\n            for decorator in node.decorator_list:\n                if isinstance(decorator, ast.Call):\n                    func = decorator.func\n                    if isinstance(func, ast.Attribute):\n                        if func.attr == \"patch\":\n                            patch_count += 1\n                    elif isinstance(func, ast.Name):\n                        if func.id == \"patch\":\n                            patch_count += 1\n                elif isinstance(decorator, ast.Attribute):\n                    if decorator.attr == \"patch\":\n                        patch_count += 1\n            if patch_count >= 3:\n                findings.append(Finding(\n                    file=str(path),\n                    line=node.lineno,\n                    severity=\"WARNING\",\n                    pattern=\"excessive_mocking\",\n                    detail=(\n                        f\"Test '{node.name}' has {patch_count} \"\n                        \"@patch decorators \u2014 likely testing mocks, \"\n                        \"not real code\"\n                    ),\n                ))\n\n    # Pattern 4: Stub implementations in src/ (not test files)\n    # This is only checked for non-test files\n    if \"/tests/\" not in str(path):\n        for node in ast.walk(tree):\n            if isinstance(node, ast.FunctionDef):\n                body = node.body\n                # Function body is just `pass`\n                if (\n                    len(body) == 1\n                    and isinstance(body[0], ast.Pass)\n                ):\n                    findings.append(Finding(\n                        file=str(path),\n                        line=node.lineno,\n                        severity=\"WARNING\",\n                        pattern=\"stub_implementation\",\n                        detail=(\n                            f\"Function '{node.name}' is a stub \"\n                            \"(just `pass`)\"\n                        ),\n                    ))\n                # Function body is just `return True`\n                if (\n                    len(body) == 1\n                    and isinstance(body[0], ast.Return)\n                    and isinstance(body[0].value, ast.Constant)\n                    and body[0].value.value is True\n                ):\n                    findings.append(Finding(\n                        file=str(path),\n                        line=node.lineno,\n                        severity=\"CRITICAL\",\n                        pattern=\"hardcoded_return\",\n                        detail=(\n                            f\"Function '{node.name}' always \"\n                            \"returns True \u2014 likely a stub\"\n                        ),\n                    ))\n\n    # Pattern 5: Hardcoded lookup tables in src/\n    if \"/tests/\" not in str(path):\n        for i, line in enumerate(lines, 1):\n            # Detect `return x in {literal, literal, ...}`\n            if re.search(\n                r\"return\\s+\\w+\\s+in\\s+\\{[\\d,\\s]+\\}\",\n                line,\n            ):\n                findings.append(Finding(\n                    file=str(path),\n                    line=i,\n                    severity=\"WARNING\",\n                    pattern=\"lookup_table\",\n                    detail=(\n                        \"Function uses hardcoded set membership \"\n                        \"\u2014 may be overfitted to test inputs\"\n                    ),\n                ))\n\n    return findings\n\n\ndef main() -> int:\n    parser = argparse.ArgumentParser(\n        description=\"Check test quality for anti-patterns\"\n    )\n    parser.add_argument(\n        \"--strict\",\n        action=\"store_true\",\n        help=\"Treat warnings as errors\",\n    )\n    parser.add_argument(\n        \"--path\",\n        type=str,\n        default=None,\n        help=\"Specific path to check (default: tests/ and src/)\",\n    )\n    args = parser.parse_args()\n\n    repo_root = Path(__file__).resolve().parent.parent\n    if args.path:\n        paths = list(Path(args.path).rglob(\"*.py\"))\n    else:\n        paths = (\n            list((repo_root / \"tests\").rglob(\"*.py\"))\n            + list((repo_root / \"src\").rglob(\"*.py\"))\n        )\n\n    all_findings: list[Finding] = []\n    for path in paths:\n        findings = check_file(path)\n        all_findings.extend(findings)\n\n    if not all_findings:\n        print(\"No test quality issues found.\")\n        return 0\n\n    # Group by severity\n    critical = [f for f in all_findings if f.severity == \"CRITICAL\"]\n    warnings = [f for f in all_findings if f.severity == \"WARNING\"]\n    nits = [f for f in all_findings if f.severity == \"NIT\"]\n\n    for finding in all_findings:\n        print(\n            f\"[{finding.severity}] {finding.file}:{finding.line} \"\n            f\"({finding.pattern}): {finding.detail}\"\n        )\n\n    print(f\"\\nTotal: {len(critical)} critical, \"\n          f\"{len(warnings)} warnings, {len(nits)} nits\")\n\n    if critical:\n        return 1\n    if args.strict and warnings:\n        return 1\n    return 0\n\n\nif __name__ == \"__main__\":\n    raise SystemExit(main())\n"
    },
    "scripts/run_gate0.py": {
      "additions": 294,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/scripts/run_gate0.py b/scripts/run_gate0.py\nnew file mode 100644\nindex 0000000..1471641\n--- /dev/null\n+++ b/scripts/run_gate0.py\n@@ -0,0 +1,294 @@\n+#!/usr/bin/env python3\n+\"\"\"Gate 0 Tier 1 \u2014 Deterministic tool runner.\n+\n+Runs all 5 tool checks in parallel, aggregates results into a single\n+JSON artifact. This is the deterministic tier of Gate 0 \u2014 fast, cheap,\n+binary pass/fail. Tier 2 (LLM semantic agents) builds on this output.\n+\n+Checks:\n+    1. code_quality  \u2014 ruff extended rules (C90, S, SIM, RET, PTH, ERA)\n+    2. complexity    \u2014 radon cyclomatic complexity\n+    3. dead_code     \u2014 vulture unused code detection\n+    4. security      \u2014 bandit vulnerability patterns\n+    5. test_quality  \u2014 AST-based vacuous test / gaming detection\n+\n+Usage:\n+    python scripts/run_gate0.py                    # run all, human output\n+    python scripts/run_gate0.py --json             # JSON to stdout\n+    python scripts/run_gate0.py --output path.json # write to file\n+\n+Exit codes:\n+    0 \u2014 no CRITICAL findings\n+    1 \u2014 at least one CRITICAL finding (Gate 0 tier 1 fails)\n+\"\"\"\n+\n+from __future__ import annotations\n+\n+import argparse\n+import json\n+import subprocess\n+import sys\n+import time\n+from concurrent.futures import ThreadPoolExecutor, as_completed\n+from datetime import UTC, datetime\n+from pathlib import Path\n+\n+REPO_ROOT = Path(__file__).resolve().parent.parent\n+DEFAULT_OUTPUT = REPO_ROOT / \"artifacts\" / \"factory\" / \"gate0_results.json\"\n+\n+# Each check: (name, command, description)\n+CHECKS: list[tuple[str, list[str], str]] = [\n+    (\n+        \"code_quality\",\n+        [sys.executable, \"scripts/nfr_checks.py\", \"--check\", \"code_quality\", \"--json\"],\n+        \"Extended ruff rules (complexity, security, simplification)\",\n+    ),\n+    (\n+        \"complexity\",\n+        [sys.executable, \"scripts/nfr_checks.py\", \"--check\", \"complexity\", \"--json\"],\n+        \"Radon cyclomatic complexity (grade C+ flagged)\",\n+    ),\n+    (\n+        \"dead_code\",\n+        [sys.executable, \"scripts/nfr_checks.py\", \"--check\", \"dead_code\", \"--json\"],\n+        \"Vulture unused code detection (80%+ confidence)\",\n+    ),\n+    (\n+        \"security\",\n+        [sys.executable, \"scripts/nfr_checks.py\", \"--check\", \"security\", \"--json\"],\n+        \"Bandit security vulnerability patterns\",\n+    ),\n+    (\n+        \"test_quality\",\n+        [sys.executable, \"scripts/check_test_quality.py\", \"--json\"],\n+        \"AST-based vacuous test and gaming pattern detection\",\n+    ),\n+]\n+\n+\n+def _run_check(\n+    name: str, cmd: list[str], description: str\n+) -> dict:\n+    \"\"\"Run a single check subprocess, return parsed result.\"\"\"\n+    start = time.monotonic()\n+    try:\n+        result = subprocess.run(\n+            cmd,\n+            cwd=str(REPO_ROOT),\n+            capture_output=True,\n+            text=True,\n+            timeout=120,\n+        )\n+        elapsed = time.monotonic() - start\n+\n+        # Parse JSON output\n+        stdout = result.stdout.strip()\n+        if not stdout:\n+            return {\n+                \"name\": name,\n+                \"tool\": description,\n+                \"status\": \"passed\",\n+                \"summary\": \"Clean\",\n+                \"findings\": [],\n+                \"elapsed_s\": round(elapsed, 2),\n+            }\n+\n+        parsed = json.loads(stdout)\n+\n+        # nfr_checks.py returns a list of NFRResult dicts\n+        # check_test_quality.py returns a single dict\n+        if isinstance(parsed, list):\n+            # Take the first (and only) result from nfr_checks.py --check X\n+            if parsed:\n+                check_result = parsed[0]\n+            else:\n+                check_result = {\n+                    \"name\": name,\n+                    \"status\": \"passed\",\n+                    \"summary\": \"Clean\",\n+                    \"findings\": [],\n+                }\n+        else:\n+            check_result = parsed\n+\n+        check_result[\"elapsed_s\"] = round(elapsed, 2)\n+        return check_result\n+\n+    except subprocess.TimeoutExpired:\n+        return {\n+            \"name\": name,\n+            \"tool\": description,\n+            \"status\": \"error\",\n+            \"summary\": \"Timeout after 120s\",\n+            \"findings\": [\n+                {\n+                    \"severity\": \"WARNING\",\n+                    \"message\": f\"Check '{name}' timed out after 120s\",\n+                }\n+            ],\n+            \"elapsed_s\": 120.0,\n+        }\n+    except json.JSONDecodeError as e:\n+        return {\n+            \"name\": name,\n+            \"tool\": description,\n+            \"status\": \"error\",\n+            \"summary\": f\"JSON parse error: {e}\",\n+            \"findings\": [\n+                {\n+                    \"severity\": \"WARNING\",\n+                    \"message\": f\"Could not parse JSON output: {e}\",\n+                }\n+            ],\n+            \"elapsed_s\": round(time.monotonic() - start, 2),\n+        }\n+    except Exception as e:\n+        return {\n+            \"name\": name,\n+            \"tool\": description,\n+            \"status\": \"error\",\n+            \"summary\": f\"Error: {e}\",\n+            \"findings\": [\n+                {\n+                    \"severity\": \"WARNING\",\n+                    \"message\": f\"Check failed: {e}\",\n+                }\n+            ],\n+            \"elapsed_s\": round(time.monotonic() - start, 2),\n+        }\n+\n+\n+def run_all() -> dict:\n+    \"\"\"Run all checks in parallel, return aggregated result.\"\"\"\n+    start = time.monotonic()\n+    checks: dict[str, dict] = {}\n+\n+    with ThreadPoolExecutor(max_workers=len(CHECKS)) as pool:\n+        futures = {\n+            pool.submit(_run_check, name, cmd, desc): name\n+            for name, cmd, desc in CHECKS\n+        }\n+        for future in as_completed(futures):\n+            name = futures[future]\n+            checks[name] = future.result()\n+\n+    total_elapsed = time.monotonic() - start\n+\n+    # Aggregate\n+    all_findings = []\n+    for check in checks.values():\n+        all_findings.extend(check.get(\"findings\", []))\n+\n+    critical_count = sum(\n+        1\n+        for f in all_findings\n+        if f.get(\"severity\") == \"CRITICAL\"\n+    )\n+    warning_count = sum(\n+        1\n+        for f in all_findings\n+        if f.get(\"severity\") == \"WARNING\"\n+    )\n+    passed_count = sum(\n+        1 for c in checks.values() if c.get(\"status\") == \"passed\"\n+    )\n+    failed_count = sum(\n+        1 for c in checks.values() if c.get(\"status\") == \"failed\"\n+    )\n+\n+    return {\n+        \"timestamp\": datetime.now(UTC).isoformat(),\n+        \"tier\": \"deterministic\",\n+        \"total_elapsed_s\": round(total_elapsed, 2),\n+        \"checks\": checks,\n+        \"summary\": {\n+            \"total_checks\": len(CHECKS),\n+            \"passed\": passed_count,\n+            \"failed\": failed_count,\n+            \"error\": len(CHECKS) - passed_count - failed_count,\n+            \"critical_findings\": critical_count,\n+            \"warning_findings\": warning_count,\n+            \"has_critical\": critical_count > 0,\n+        },\n+    }\n+\n+\n+def main() -> int:\n+    parser = argparse.ArgumentParser(\n+        description=\"Gate 0 Tier 1 \u2014 run all deterministic tool checks in parallel\"\n+    )\n+    parser.add_argument(\n+        \"--json\",\n+        action=\"store_true\",\n+        help=\"Output as JSON to stdout\",\n+    )\n+    parser.add_argument(\n+        \"--output\",\n+        type=str,\n+        default=None,\n+        help=f\"Write JSON to file (default when not --json: {DEFAULT_OUTPUT})\",\n+    )\n+    args = parser.parse_args()\n+\n+    results = run_all()\n+\n+    # Always write to file unless --json (stdout-only) is used\n+    output_path = args.output or (None if args.json else str(DEFAULT_OUTPUT))\n+    if output_path:\n+        Path(output_path).parent.mkdir(parents=True, exist_ok=True)\n+        Path(output_path).write_text(json.dumps(results, indent=2) + \"\\n\")\n+\n+    if args.json:\n+        print(json.dumps(results, indent=2))\n+    else:\n+        # Human-readable summary\n+        summary = results[\"summary\"]\n+        print(\"=\" * 60)\n+        print(\"GATE 0 TIER 1: Deterministic Tool Checks\")\n+        print(f\"  Elapsed: {results['total_elapsed_s']}s (parallel)\")\n+        print(\"=\" * 60)\n+\n+        for name, check in results[\"checks\"].items():\n+            status = check.get(\"status\", \"?\")\n+            icon = {\"passed\": \"PASS\", \"failed\": \"FAIL\", \"error\": \"ERR \", \"skipped\": \"SKIP\"}.get(\n+                status, \"????\"\n+            )\n+            elapsed = check.get(\"elapsed_s\", \"?\")\n+            print(f\"\\n[{icon}] {name} ({elapsed}s): {check.get('summary', '')}\")\n+\n+            for f in check.get(\"findings\", []):\n+                sev = f.get(\"severity\", \"?\")\n+                if sev == \"INFO\":\n+                    continue\n+                loc = \"\"\n+                if f.get(\"file\"):\n+                    loc = f\" {f['file']}\"\n+                    if f.get(\"line\"):\n+                        loc += f\":{f['line']}\"\n+                msg = f.get(\"message\") or f.get(\"detail\", \"\")\n+                print(f\"  [{sev}]{loc} {msg}\")\n+\n+        print(f\"\\n{'=' * 60}\")\n+        print(\n+            f\"Checks: {summary['passed']} passed, \"\n+            f\"{summary['failed']} failed, \"\n+            f\"{summary['error']} error\"\n+        )\n+        print(\n+            f\"Findings: {summary['critical_findings']} critical, \"\n+            f\"{summary['warning_findings']} warnings\"\n+        )\n+\n+        if summary[\"has_critical\"]:\n+            print(\"\\nGATE 0 TIER 1: FAILED (critical findings)\")\n+        else:\n+            print(\"\\nGATE 0 TIER 1: PASSED\")\n+\n+        if output_path:\n+            print(f\"\\nResults written to {output_path}\")\n+\n+    return 1 if results[\"summary\"][\"has_critical\"] else 0\n+\n+\n+if __name__ == \"__main__\":\n+    sys.exit(main())\n",
      "raw": "#!/usr/bin/env python3\n\"\"\"Gate 0 Tier 1 \u2014 Deterministic tool runner.\n\nRuns all 5 tool checks in parallel, aggregates results into a single\nJSON artifact. This is the deterministic tier of Gate 0 \u2014 fast, cheap,\nbinary pass/fail. Tier 2 (LLM semantic agents) builds on this output.\n\nChecks:\n    1. code_quality  \u2014 ruff extended rules (C90, S, SIM, RET, PTH, ERA)\n    2. complexity    \u2014 radon cyclomatic complexity\n    3. dead_code     \u2014 vulture unused code detection\n    4. security      \u2014 bandit vulnerability patterns\n    5. test_quality  \u2014 AST-based vacuous test / gaming detection\n\nUsage:\n    python scripts/run_gate0.py                    # run all, human output\n    python scripts/run_gate0.py --json             # JSON to stdout\n    python scripts/run_gate0.py --output path.json # write to file\n\nExit codes:\n    0 \u2014 no CRITICAL findings\n    1 \u2014 at least one CRITICAL finding (Gate 0 tier 1 fails)\n\"\"\"\n\nfrom __future__ import annotations\n\nimport argparse\nimport json\nimport subprocess\nimport sys\nimport time\nfrom concurrent.futures import ThreadPoolExecutor, as_completed\nfrom datetime import UTC, datetime\nfrom pathlib import Path\n\nREPO_ROOT = Path(__file__).resolve().parent.parent\nDEFAULT_OUTPUT = REPO_ROOT / \"artifacts\" / \"factory\" / \"gate0_results.json\"\n\n# Each check: (name, command, description)\nCHECKS: list[tuple[str, list[str], str]] = [\n    (\n        \"code_quality\",\n        [sys.executable, \"scripts/nfr_checks.py\", \"--check\", \"code_quality\", \"--json\"],\n        \"Extended ruff rules (complexity, security, simplification)\",\n    ),\n    (\n        \"complexity\",\n        [sys.executable, \"scripts/nfr_checks.py\", \"--check\", \"complexity\", \"--json\"],\n        \"Radon cyclomatic complexity (grade C+ flagged)\",\n    ),\n    (\n        \"dead_code\",\n        [sys.executable, \"scripts/nfr_checks.py\", \"--check\", \"dead_code\", \"--json\"],\n        \"Vulture unused code detection (80%+ confidence)\",\n    ),\n    (\n        \"security\",\n        [sys.executable, \"scripts/nfr_checks.py\", \"--check\", \"security\", \"--json\"],\n        \"Bandit security vulnerability patterns\",\n    ),\n    (\n        \"test_quality\",\n        [sys.executable, \"scripts/check_test_quality.py\", \"--json\"],\n        \"AST-based vacuous test and gaming pattern detection\",\n    ),\n]\n\n\ndef _run_check(\n    name: str, cmd: list[str], description: str\n) -> dict:\n    \"\"\"Run a single check subprocess, return parsed result.\"\"\"\n    start = time.monotonic()\n    try:\n        result = subprocess.run(\n            cmd,\n            cwd=str(REPO_ROOT),\n            capture_output=True,\n            text=True,\n            timeout=120,\n        )\n        elapsed = time.monotonic() - start\n\n        # Parse JSON output\n        stdout = result.stdout.strip()\n        if not stdout:\n            return {\n                \"name\": name,\n                \"tool\": description,\n                \"status\": \"passed\",\n                \"summary\": \"Clean\",\n                \"findings\": [],\n                \"elapsed_s\": round(elapsed, 2),\n            }\n\n        parsed = json.loads(stdout)\n\n        # nfr_checks.py returns a list of NFRResult dicts\n        # check_test_quality.py returns a single dict\n        if isinstance(parsed, list):\n            # Take the first (and only) result from nfr_checks.py --check X\n            if parsed:\n                check_result = parsed[0]\n            else:\n                check_result = {\n                    \"name\": name,\n                    \"status\": \"passed\",\n                    \"summary\": \"Clean\",\n                    \"findings\": [],\n                }\n        else:\n            check_result = parsed\n\n        check_result[\"elapsed_s\"] = round(elapsed, 2)\n        return check_result\n\n    except subprocess.TimeoutExpired:\n        return {\n            \"name\": name,\n            \"tool\": description,\n            \"status\": \"error\",\n            \"summary\": \"Timeout after 120s\",\n            \"findings\": [\n                {\n                    \"severity\": \"WARNING\",\n                    \"message\": f\"Check '{name}' timed out after 120s\",\n                }\n            ],\n            \"elapsed_s\": 120.0,\n        }\n    except json.JSONDecodeError as e:\n        return {\n            \"name\": name,\n            \"tool\": description,\n            \"status\": \"error\",\n            \"summary\": f\"JSON parse error: {e}\",\n            \"findings\": [\n                {\n                    \"severity\": \"WARNING\",\n                    \"message\": f\"Could not parse JSON output: {e}\",\n                }\n            ],\n            \"elapsed_s\": round(time.monotonic() - start, 2),\n        }\n    except Exception as e:\n        return {\n            \"name\": name,\n            \"tool\": description,\n            \"status\": \"error\",\n            \"summary\": f\"Error: {e}\",\n            \"findings\": [\n                {\n                    \"severity\": \"WARNING\",\n                    \"message\": f\"Check failed: {e}\",\n                }\n            ],\n            \"elapsed_s\": round(time.monotonic() - start, 2),\n        }\n\n\ndef run_all() -> dict:\n    \"\"\"Run all checks in parallel, return aggregated result.\"\"\"\n    start = time.monotonic()\n    checks: dict[str, dict] = {}\n\n    with ThreadPoolExecutor(max_workers=len(CHECKS)) as pool:\n        futures = {\n            pool.submit(_run_check, name, cmd, desc): name\n            for name, cmd, desc in CHECKS\n        }\n        for future in as_completed(futures):\n            name = futures[future]\n            checks[name] = future.result()\n\n    total_elapsed = time.monotonic() - start\n\n    # Aggregate\n    all_findings = []\n    for check in checks.values():\n        all_findings.extend(check.get(\"findings\", []))\n\n    critical_count = sum(\n        1\n        for f in all_findings\n        if f.get(\"severity\") == \"CRITICAL\"\n    )\n    warning_count = sum(\n        1\n        for f in all_findings\n        if f.get(\"severity\") == \"WARNING\"\n    )\n    passed_count = sum(\n        1 for c in checks.values() if c.get(\"status\") == \"passed\"\n    )\n    failed_count = sum(\n        1 for c in checks.values() if c.get(\"status\") == \"failed\"\n    )\n\n    return {\n        \"timestamp\": datetime.now(UTC).isoformat(),\n        \"tier\": \"deterministic\",\n        \"total_elapsed_s\": round(total_elapsed, 2),\n        \"checks\": checks,\n        \"summary\": {\n            \"total_checks\": len(CHECKS),\n            \"passed\": passed_count,\n            \"failed\": failed_count,\n            \"error\": len(CHECKS) - passed_count - failed_count,\n            \"critical_findings\": critical_count,\n            \"warning_findings\": warning_count,\n            \"has_critical\": critical_count > 0,\n        },\n    }\n\n\ndef main() -> int:\n    parser = argparse.ArgumentParser(\n        description=\"Gate 0 Tier 1 \u2014 run all deterministic tool checks in parallel\"\n    )\n    parser.add_argument(\n        \"--json\",\n        action=\"store_true\",\n        help=\"Output as JSON to stdout\",\n    )\n    parser.add_argument(\n        \"--output\",\n        type=str,\n        default=None,\n        help=f\"Write JSON to file (default when not --json: {DEFAULT_OUTPUT})\",\n    )\n    args = parser.parse_args()\n\n    results = run_all()\n\n    # Always write to file unless --json (stdout-only) is used\n    output_path = args.output or (None if args.json else str(DEFAULT_OUTPUT))\n    if output_path:\n        Path(output_path).parent.mkdir(parents=True, exist_ok=True)\n        Path(output_path).write_text(json.dumps(results, indent=2) + \"\\n\")\n\n    if args.json:\n        print(json.dumps(results, indent=2))\n    else:\n        # Human-readable summary\n        summary = results[\"summary\"]\n        print(\"=\" * 60)\n        print(\"GATE 0 TIER 1: Deterministic Tool Checks\")\n        print(f\"  Elapsed: {results['total_elapsed_s']}s (parallel)\")\n        print(\"=\" * 60)\n\n        for name, check in results[\"checks\"].items():\n            status = check.get(\"status\", \"?\")\n            icon = {\"passed\": \"PASS\", \"failed\": \"FAIL\", \"error\": \"ERR \", \"skipped\": \"SKIP\"}.get(\n                status, \"????\"\n            )\n            elapsed = check.get(\"elapsed_s\", \"?\")\n            print(f\"\\n[{icon}] {name} ({elapsed}s): {check.get('summary', '')}\")\n\n            for f in check.get(\"findings\", []):\n                sev = f.get(\"severity\", \"?\")\n                if sev == \"INFO\":\n                    continue\n                loc = \"\"\n                if f.get(\"file\"):\n                    loc = f\" {f['file']}\"\n                    if f.get(\"line\"):\n                        loc += f\":{f['line']}\"\n                msg = f.get(\"message\") or f.get(\"detail\", \"\")\n                print(f\"  [{sev}]{loc} {msg}\")\n\n        print(f\"\\n{'=' * 60}\")\n        print(\n            f\"Checks: {summary['passed']} passed, \"\n            f\"{summary['failed']} failed, \"\n            f\"{summary['error']} error\"\n        )\n        print(\n            f\"Findings: {summary['critical_findings']} critical, \"\n            f\"{summary['warning_findings']} warnings\"\n        )\n\n        if summary[\"has_critical\"]:\n            print(\"\\nGATE 0 TIER 1: FAILED (critical findings)\")\n        else:\n            print(\"\\nGATE 0 TIER 1: PASSED\")\n\n        if output_path:\n            print(f\"\\nResults written to {output_path}\")\n\n    return 1 if results[\"summary\"][\"has_critical\"] else 0\n\n\nif __name__ == \"__main__\":\n    sys.exit(main())\n",
      "base": ""
    },
    "specs/env.md": {
      "additions": 11,
      "deletions": 1,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/specs/env.md b/specs/env.md\nindex 0e9b256..15b75af 100644\n--- a/specs/env.md\n+++ b/specs/env.md\n@@ -39,6 +39,16 @@ Via `MiniPongConfig` dataclass:\n - `ball_size`: 3\n - `max_steps`: 1200\n - `reward_shaping`: False\n+- `score_limit`: 1 (default \u2014 terminates after 1 point, preserving existing RL training behavior; set higher for multi-rally interactive play, e.g., 11)\n+\n+## Multi-Rally Mode\n+\n+When `score_limit > 1`, a point does NOT end the episode. Instead:\n+- The ball resets to center with a new random velocity (using the episode's RNG).\n+- Cumulative scores (`agent_score`, `opponent_score`) are tracked across rallies within the episode.\n+- The episode terminates when either side reaches `score_limit`.\n+- `episode_reason` is set to `\"score_limit\"` when the game ends via score limit.\n+- With `score_limit=1`, behavior is identical to the current single-point termination (backward compatible).\n \n ## Info Dict\n \n@@ -48,7 +58,7 @@ Every step and reset returns an info dict containing:\n - `misses`: total misses this episode\n - `agent_score`: agent's cumulative score\n - `opponent_score`: opponent's cumulative score\n-- `episode_reason`: why episode ended (\"running\", \"max_steps\", \"score_limit\")\n+- `episode_reason`: why episode ended (\"running\", \"max_steps\", \"score_limit\", \"agent_miss\", \"opponent_miss\")\n \n ## Rendering\n \n",
      "raw": "# MiniPong Environment Spec\n\n## Overview\n\nCustom \"MiniPong\" Gymnasium environment implemented in pure Python + NumPy with deterministic physics. Supports `render_mode=\"rgb_array\"` and returns pixel observations (uint8).\n\n## Action Space\n\nDiscrete(3): UP (0), DOWN (1), STAY (2)\n\n## Observation Space\n\nPixel image only (uint8). Default 84x84 grayscale (single channel). Shape: `(84, 84, 1)`.\n\nThe policy receives ONLY pixel observations. No privileged info dict data is consumed by the agent.\n\n## Reward\n\n- +1 when opponent misses (agent scores)\n- -1 when agent misses (opponent scores)\n- Optional light reward shaping behind a config flag (`reward_shaping: bool`)\n\n## Physics\n\nDeterministic given seed:\n- Ball spawn position and velocity determined by RNG seeded at reset\n- Paddle speed is a fixed config parameter\n- Ball bounces off top/bottom walls\n- Ball resets to center after scoring\n\n## Configuration\n\nVia `MiniPongConfig` dataclass:\n- `width`: 84\n- `height`: 84\n- `paddle_height`: 16\n- `paddle_width`: 3\n- `paddle_speed`: 3\n- `ball_size`: 3\n- `max_steps`: 1200\n- `reward_shaping`: False\n- `score_limit`: 1 (default \u2014 terminates after 1 point, preserving existing RL training behavior; set higher for multi-rally interactive play, e.g., 11)\n\n## Multi-Rally Mode\n\nWhen `score_limit > 1`, a point does NOT end the episode. Instead:\n- The ball resets to center with a new random velocity (using the episode's RNG).\n- Cumulative scores (`agent_score`, `opponent_score`) are tracked across rallies within the episode.\n- The episode terminates when either side reaches `score_limit`.\n- `episode_reason` is set to `\"score_limit\"` when the game ends via score limit.\n- With `score_limit=1`, behavior is identical to the current single-point termination (backward compatible).\n\n## Info Dict\n\nEvery step and reset returns an info dict containing:\n- `rally_length`: current rally count\n- `hits`: total paddle hits this episode\n- `misses`: total misses this episode\n- `agent_score`: agent's cumulative score\n- `opponent_score`: opponent's cumulative score\n- `episode_reason`: why episode ended (\"running\", \"max_steps\", \"score_limit\", \"agent_miss\", \"opponent_miss\")\n\n## Rendering\n\n`render_mode=\"rgb_array\"` produces frames suitable for video recording. Frame shape matches observation space.\n\n## Determinism\n\nGiven the same seed, `reset()` and a fixed sequence of actions must produce identical observations, rewards, and info dicts. This is load-bearing for reproducible evaluation.\n\n## Registration\n\nEnvironment should be registered with Gymnasium as `MiniPong-v0` for standard API usage.\n",
      "base": "# MiniPong Environment Spec\n\n## Overview\n\nCustom \"MiniPong\" Gymnasium environment implemented in pure Python + NumPy with deterministic physics. Supports `render_mode=\"rgb_array\"` and returns pixel observations (uint8).\n\n## Action Space\n\nDiscrete(3): UP (0), DOWN (1), STAY (2)\n\n## Observation Space\n\nPixel image only (uint8). Default 84x84 grayscale (single channel). Shape: `(84, 84, 1)`.\n\nThe policy receives ONLY pixel observations. No privileged info dict data is consumed by the agent.\n\n## Reward\n\n- +1 when opponent misses (agent scores)\n- -1 when agent misses (opponent scores)\n- Optional light reward shaping behind a config flag (`reward_shaping: bool`)\n\n## Physics\n\nDeterministic given seed:\n- Ball spawn position and velocity determined by RNG seeded at reset\n- Paddle speed is a fixed config parameter\n- Ball bounces off top/bottom walls\n- Ball resets to center after scoring\n\n## Configuration\n\nVia `MiniPongConfig` dataclass:\n- `width`: 84\n- `height`: 84\n- `paddle_height`: 16\n- `paddle_width`: 3\n- `paddle_speed`: 3\n- `ball_size`: 3\n- `max_steps`: 1200\n- `reward_shaping`: False\n\n## Info Dict\n\nEvery step and reset returns an info dict containing:\n- `rally_length`: current rally count\n- `hits`: total paddle hits this episode\n- `misses`: total misses this episode\n- `agent_score`: agent's cumulative score\n- `opponent_score`: opponent's cumulative score\n- `episode_reason`: why episode ended (\"running\", \"max_steps\", \"score_limit\")\n\n## Rendering\n\n`render_mode=\"rgb_array\"` produces frames suitable for video recording. Frame shape matches observation space.\n\n## Determinism\n\nGiven the same seed, `reset()` and a fixed sequence of actions must produce identical observations, rewards, and info dicts. This is load-bearing for reproducible evaluation.\n\n## Registration\n\nEnvironment should be registered with Gymnasium as `MiniPong-v0` for standard API usage.\n"
    },
    "specs/pong_interfaces.md": {
      "additions": 123,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/specs/pong_interfaces.md b/specs/pong_interfaces.md\nnew file mode 100644\nindex 0000000..ec5be81\n--- /dev/null\n+++ b/specs/pong_interfaces.md\n@@ -0,0 +1,123 @@\n+# Pong Interfaces Spec\n+\n+## Overview\n+\n+MiniPong must be playable interactively by humans via a pygame window, with support for two-player same-keyboard play and agent takeover of either side.\n+\n+## Dependencies\n+\n+Add `pygame` to `requirements.in`. The interactive player is a first-class module at `src/play/play_minipong.py`, runnable via `make play`.\n+\n+## Human \u2014 Two Players\n+\n+The packaged MiniPong game must be playable by 2 players on the same keyboard (or one player using two hands to play against himself).\n+\n+### Controls\n+\n+| Player | Up Key | Down Key | Side |\n+|--------|--------|----------|------|\n+| Left   | `Q`    | `A`      | Left paddle |\n+| Right  | `P`    | `L`      | Right paddle |\n+\n+Keys were selected based on QWERTY key positions and natural left-right / up-down dynamics.\n+\n+If no key is pressed for a given side, that paddle stays in place (STAY action).\n+\n+### Rendering\n+\n+- The game renders in a pygame window at a scaled resolution (minimum 6x the 84x84 game pixels = 504x504).\n+- White paddles and ball on black background, matching the existing `rgb_array` rendering.\n+- The window title must include \"MiniPong\".\n+- The game runs at 30 FPS (matching `render_fps` metadata).\n+\n+### Scoring\n+\n+- The game must NOT end after a single point. Episodes continue with the ball resetting to center after each score, tracking cumulative score for both sides.\n+- A HUD displays the current score for each side.\n+- The game ends when a player reaches a configurable score limit (default 11) or the player presses ESC/Q-key-combo to quit.\n+\n+### Game Flow\n+\n+- `ESC` quits the game.\n+- `R` restarts the game (resets scores to 0-0).\n+- After a point is scored, the ball resets to center and play continues automatically.\n+\n+## Agent Takeover\n+\n+While playing, a human may choose any side (left or right) to be taken over by a trained agent. This includes having two agents play each other.\n+\n+### Takeover Controls\n+\n+| Combination | Effect |\n+|-------------|--------|\n+| `Shift+A`   | Toggle agent control of the LEFT side |\n+| `Shift+L`   | Toggle agent control of the RIGHT side |\n+\n+Pressing the same combination again toggles control back to human (for the respective side).\n+\n+### Agent Policy\n+\n+- The agent loads a trained DQN checkpoint. The checkpoint path is configurable via command-line argument (`--checkpoint`).\n+- If no checkpoint is provided, the agent falls back to a random policy.\n+- The agent receives the same 84x84 grayscale pixel observation that the training pipeline uses.\n+- For the RIGHT side agent, the observation must be horizontally flipped so the agent always \"sees\" itself on the left (matching training perspective).\n+\n+## Player Status Tags\n+\n+Each side (left and right) must display a status tag indicating who is currently controlling that paddle.\n+\n+### Placement\n+\n+- Left player tag: top-left corner of the screen, outside/above the playing area.\n+- Right player tag: top-right corner of the screen, outside/above the playing area.\n+\n+### Content\n+\n+When controlled by a human:\n+```\n+Keyboard: Up:Q, Down:A\n+```\n+(or `Up:P, Down:L` for the right side)\n+\n+When controlled by an agent:\n+```\n+AI Agent\n+```\n+\n+When in debug mode (activated via `--debug` flag):\n+```\n+Policy: <policy_name>\n+```\n+where `<policy_name>` is the checkpoint filename (e.g., `checkpoint_50000.pt`) or `random` if no checkpoint.\n+\n+### Tag Accuracy\n+\n+The tag must reflect the **true current state** of who is controlling each paddle at all times. Specifically:\n+- The tag must update immediately when a takeover toggle occurs (same frame).\n+- The tag must never show \"AI Agent\" when the human is controlling the paddle, or vice versa.\n+- The tag state must survive game restarts (R key) \u2014 if the agent was controlling the left side, it continues to do so after restart.\n+\n+## Makefile Integration\n+\n+| Target | Command |\n+|--------|---------|\n+| `make play` | `python -m src.play.play_minipong` |\n+| `make play-debug` | `python -m src.play.play_minipong --debug` |\n+| `make play-agent-vs-agent` | Launch with both sides set to agent (convenience target) |\n+\n+## Module Structure\n+\n+```\n+src/play/\n+    __init__.py\n+    play_minipong.py      # Main interactive game loop\n+```\n+\n+The play module imports from `src.envs.minipong` for the game physics and from `src.rl.networks` / `src.agents.dqn_agent` for the trained policy.\n+\n+## Non-Functional Requirements\n+\n+- The game must run at 30 FPS on CPU without frame drops.\n+- pygame is the only additional dependency (already added to requirements.in).\n+- The play module must not break any existing imports or tests.\n+- All code must pass `ruff` and `mypy` checks.\n",
      "raw": "# Pong Interfaces Spec\n\n## Overview\n\nMiniPong must be playable interactively by humans via a pygame window, with support for two-player same-keyboard play and agent takeover of either side.\n\n## Dependencies\n\nAdd `pygame` to `requirements.in`. The interactive player is a first-class module at `src/play/play_minipong.py`, runnable via `make play`.\n\n## Human \u2014 Two Players\n\nThe packaged MiniPong game must be playable by 2 players on the same keyboard (or one player using two hands to play against himself).\n\n### Controls\n\n| Player | Up Key | Down Key | Side |\n|--------|--------|----------|------|\n| Left   | `Q`    | `A`      | Left paddle |\n| Right  | `P`    | `L`      | Right paddle |\n\nKeys were selected based on QWERTY key positions and natural left-right / up-down dynamics.\n\nIf no key is pressed for a given side, that paddle stays in place (STAY action).\n\n### Rendering\n\n- The game renders in a pygame window at a scaled resolution (minimum 6x the 84x84 game pixels = 504x504).\n- White paddles and ball on black background, matching the existing `rgb_array` rendering.\n- The window title must include \"MiniPong\".\n- The game runs at 30 FPS (matching `render_fps` metadata).\n\n### Scoring\n\n- The game must NOT end after a single point. Episodes continue with the ball resetting to center after each score, tracking cumulative score for both sides.\n- A HUD displays the current score for each side.\n- The game ends when a player reaches a configurable score limit (default 11) or the player presses ESC/Q-key-combo to quit.\n\n### Game Flow\n\n- `ESC` quits the game.\n- `R` restarts the game (resets scores to 0-0).\n- After a point is scored, the ball resets to center and play continues automatically.\n\n## Agent Takeover\n\nWhile playing, a human may choose any side (left or right) to be taken over by a trained agent. This includes having two agents play each other.\n\n### Takeover Controls\n\n| Combination | Effect |\n|-------------|--------|\n| `Shift+A`   | Toggle agent control of the LEFT side |\n| `Shift+L`   | Toggle agent control of the RIGHT side |\n\nPressing the same combination again toggles control back to human (for the respective side).\n\n### Agent Policy\n\n- The agent loads a trained DQN checkpoint. The checkpoint path is configurable via command-line argument (`--checkpoint`).\n- If no checkpoint is provided, the agent falls back to a random policy.\n- The agent receives the same 84x84 grayscale pixel observation that the training pipeline uses.\n- For the RIGHT side agent, the observation must be horizontally flipped so the agent always \"sees\" itself on the left (matching training perspective).\n\n## Player Status Tags\n\nEach side (left and right) must display a status tag indicating who is currently controlling that paddle.\n\n### Placement\n\n- Left player tag: top-left corner of the screen, outside/above the playing area.\n- Right player tag: top-right corner of the screen, outside/above the playing area.\n\n### Content\n\nWhen controlled by a human:\n```\nKeyboard: Up:Q, Down:A\n```\n(or `Up:P, Down:L` for the right side)\n\nWhen controlled by an agent:\n```\nAI Agent\n```\n\nWhen in debug mode (activated via `--debug` flag):\n```\nPolicy: <policy_name>\n```\nwhere `<policy_name>` is the checkpoint filename (e.g., `checkpoint_50000.pt`) or `random` if no checkpoint.\n\n### Tag Accuracy\n\nThe tag must reflect the **true current state** of who is controlling each paddle at all times. Specifically:\n- The tag must update immediately when a takeover toggle occurs (same frame).\n- The tag must never show \"AI Agent\" when the human is controlling the paddle, or vice versa.\n- The tag state must survive game restarts (R key) \u2014 if the agent was controlling the left side, it continues to do so after restart.\n\n## Makefile Integration\n\n| Target | Command |\n|--------|---------|\n| `make play` | `python -m src.play.play_minipong` |\n| `make play-debug` | `python -m src.play.play_minipong --debug` |\n| `make play-agent-vs-agent` | Launch with both sides set to agent (convenience target) |\n\n## Module Structure\n\n```\nsrc/play/\n    __init__.py\n    play_minipong.py      # Main interactive game loop\n```\n\nThe play module imports from `src.envs.minipong` for the game physics and from `src.rl.networks` / `src.agents.dqn_agent` for the trained policy.\n\n## Non-Functional Requirements\n\n- The game must run at 30 FPS on CPU without frame drops.\n- pygame is the only additional dependency (already added to requirements.in).\n- The play module must not break any existing imports or tests.\n- All code must pass `ruff` and `mypy` checks.\n",
      "base": ""
    },
    "src/envs/minipong.py": {
      "additions": 46,
      "deletions": 8,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/src/envs/minipong.py b/src/envs/minipong.py\nindex b7cdb13..ed8aeb8 100644\n--- a/src/envs/minipong.py\n+++ b/src/envs/minipong.py\n@@ -20,6 +20,7 @@ class MiniPongConfig:\n     ball_size: int = 3\n     max_steps: int = 1200\n     reward_shaping: bool = False\n+    score_limit: int = 1\n \n \n class MiniPongEnv(gym.Env[np.ndarray, int]):\n@@ -45,6 +46,7 @@ class MiniPongEnv(gym.Env[np.ndarray, int]):\n         self.misses = 0\n         self.rally_length = 0\n         self.episode_reason = \"running\"\n+        self._manual_opponent_action: int | None = None\n \n         self.agent_y = 0.0\n         self.opponent_y = 0.0\n@@ -63,14 +65,14 @@ class MiniPongEnv(gym.Env[np.ndarray, int]):\n         self.hits = 0\n         self.misses = 0\n         self.rally_length = 0\n+        self.agent_score = 0\n+        self.opponent_score = 0\n         self.episode_reason = \"running\"\n+        self._manual_opponent_action = None\n \n         self.agent_y = (self.config.height - self.config.paddle_height) / 2\n         self.opponent_y = self.agent_y\n-        self.ball_x = self.config.width / 2\n-        self.ball_y = self.config.height / 2\n-        self.ball_vx = float(self._rng.choice([-2, 2]))\n-        self.ball_vy = float(self._rng.choice([-1, 1]))\n+        self._reset_ball()\n         return self._obs(), self._info()\n \n     def step(self, action: int) -> tuple[np.ndarray, float, bool, bool, dict[str, Any]]:\n@@ -100,8 +102,7 @@ class MiniPongEnv(gym.Env[np.ndarray, int]):\n                 reward -= 1.0\n                 self.opponent_score += 1\n                 self.misses += 1\n-                self.episode_reason = \"agent_miss\"\n-                return self._obs(), reward, True, False, self._info()\n+                return self._finish_point(reward=reward, scorer=\"opponent\")\n \n         if self.ball_vx > 0 and self.ball_x + self.config.ball_size >= right_x:\n             if self.opponent_y <= self.ball_y <= self.opponent_y + self.config.paddle_height:\n@@ -110,8 +111,7 @@ class MiniPongEnv(gym.Env[np.ndarray, int]):\n             else:\n                 reward += 1.0\n                 self.agent_score += 1\n-                self.episode_reason = \"opponent_miss\"\n-                return self._obs(), reward, True, False, self._info()\n+                return self._finish_point(reward=reward, scorer=\"agent\")\n \n         truncated = self.steps >= self.config.max_steps\n         if truncated:\n@@ -133,6 +133,16 @@ class MiniPongEnv(gym.Env[np.ndarray, int]):\n         )\n \n     def _move_opponent(self) -> None:\n+        if self._manual_opponent_action is not None:\n+            if self._manual_opponent_action == 0:\n+                self.opponent_y -= self.config.paddle_speed\n+            elif self._manual_opponent_action == 1:\n+                self.opponent_y += self.config.paddle_speed\n+            self.opponent_y = float(\n+                np.clip(self.opponent_y, 0, self.config.height - self.config.paddle_height)\n+            )\n+            return\n+\n         center = self.opponent_y + self.config.paddle_height / 2\n         target = self.ball_y + self.config.ball_size / 2\n         if target > center:\n@@ -143,6 +153,34 @@ class MiniPongEnv(gym.Env[np.ndarray, int]):\n             np.clip(self.opponent_y, 0, self.config.height - self.config.paddle_height)\n         )\n \n+    def set_opponent_action(self, action: int | None) -> None:\n+        self._manual_opponent_action = action\n+\n+    def _reset_ball(self) -> None:\n+        self.ball_x = self.config.width / 2\n+        self.ball_y = self.config.height / 2\n+        self.ball_vx = float(self._rng.choice([-2, 2]))\n+        self.ball_vy = float(self._rng.choice([-1, 1]))\n+\n+    def _finish_point(\n+        self, reward: float, scorer: str\n+    ) -> tuple[np.ndarray, float, bool, bool, dict[str, Any]]:\n+        if self.config.score_limit <= 1:\n+            self.episode_reason = \"opponent_miss\" if scorer == \"agent\" else \"agent_miss\"\n+            return self._obs(), reward, True, False, self._info()\n+\n+        if (\n+            self.agent_score >= self.config.score_limit\n+            or self.opponent_score >= self.config.score_limit\n+        ):\n+            self.episode_reason = \"score_limit\"\n+            return self._obs(), reward, True, False, self._info()\n+\n+        self.rally_length = 0\n+        self.episode_reason = \"running\"\n+        self._reset_ball()\n+        return self._obs(), reward, False, False, self._info()\n+\n     def _obs(self) -> np.ndarray:\n         frame = np.zeros((self.config.height, self.config.width), dtype=np.uint8)\n         left_x = 4\n",
      "raw": "\"\"\"Open-source deterministic MiniPong environment.\"\"\"\n\nfrom __future__ import annotations\n\nfrom dataclasses import dataclass\nfrom typing import Any\n\nimport gymnasium as gym\nimport numpy as np\nfrom gymnasium import spaces\n\n\n@dataclass\nclass MiniPongConfig:\n    width: int = 84\n    height: int = 84\n    paddle_height: int = 16\n    paddle_width: int = 3\n    paddle_speed: int = 3\n    ball_size: int = 3\n    max_steps: int = 1200\n    reward_shaping: bool = False\n    score_limit: int = 1\n\n\nclass MiniPongEnv(gym.Env[np.ndarray, int]):\n    metadata = {\"render_modes\": [\"rgb_array\"], \"render_fps\": 30}\n\n    def __init__(\n        self, render_mode: str | None = None, config: MiniPongConfig | None = None\n    ) -> None:\n        self.config = config or MiniPongConfig()\n        self.render_mode = render_mode\n        self.action_space = spaces.Discrete(3)\n        self.observation_space = spaces.Box(\n            low=0,\n            high=255,\n            shape=(self.config.height, self.config.width, 1),\n            dtype=np.uint8,\n        )\n        self._rng = np.random.default_rng(0)\n        self.steps = 0\n        self.agent_score = 0\n        self.opponent_score = 0\n        self.hits = 0\n        self.misses = 0\n        self.rally_length = 0\n        self.episode_reason = \"running\"\n        self._manual_opponent_action: int | None = None\n\n        self.agent_y = 0.0\n        self.opponent_y = 0.0\n        self.ball_x = 0.0\n        self.ball_y = 0.0\n        self.ball_vx = 0.0\n        self.ball_vy = 0.0\n\n    def reset(\n        self, *, seed: int | None = None, options: dict[str, Any] | None = None\n    ) -> tuple[np.ndarray, dict[str, Any]]:\n        super().reset(seed=seed)\n        if seed is not None:\n            self._rng = np.random.default_rng(seed)\n        self.steps = 0\n        self.hits = 0\n        self.misses = 0\n        self.rally_length = 0\n        self.agent_score = 0\n        self.opponent_score = 0\n        self.episode_reason = \"running\"\n        self._manual_opponent_action = None\n\n        self.agent_y = (self.config.height - self.config.paddle_height) / 2\n        self.opponent_y = self.agent_y\n        self._reset_ball()\n        return self._obs(), self._info()\n\n    def step(self, action: int) -> tuple[np.ndarray, float, bool, bool, dict[str, Any]]:\n        self.steps += 1\n        self._move_agent(int(action))\n        self._move_opponent()\n        reward = 0.0\n\n        self.ball_x += self.ball_vx\n        self.ball_y += self.ball_vy\n\n        if self.ball_y <= 0 or self.ball_y >= self.config.height - self.config.ball_size:\n            self.ball_vy *= -1\n            self.ball_y = np.clip(self.ball_y, 0, self.config.height - self.config.ball_size)\n\n        left_x = 4\n        right_x = self.config.width - 4 - self.config.paddle_width\n\n        if self.ball_vx < 0 and self.ball_x <= left_x + self.config.paddle_width:\n            if self.agent_y <= self.ball_y <= self.agent_y + self.config.paddle_height:\n                self.ball_vx = abs(self.ball_vx)\n                self.hits += 1\n                self.rally_length += 1\n                if self.config.reward_shaping:\n                    reward += 0.01\n            else:\n                reward -= 1.0\n                self.opponent_score += 1\n                self.misses += 1\n                return self._finish_point(reward=reward, scorer=\"opponent\")\n\n        if self.ball_vx > 0 and self.ball_x + self.config.ball_size >= right_x:\n            if self.opponent_y <= self.ball_y <= self.opponent_y + self.config.paddle_height:\n                self.ball_vx = -abs(self.ball_vx)\n                self.rally_length += 1\n            else:\n                reward += 1.0\n                self.agent_score += 1\n                return self._finish_point(reward=reward, scorer=\"agent\")\n\n        truncated = self.steps >= self.config.max_steps\n        if truncated:\n            self.episode_reason = \"max_steps\"\n        return self._obs(), reward, False, truncated, self._info()\n\n    def render(self) -> np.ndarray:\n        gray = self._obs().squeeze(-1)\n        rgb = np.repeat(gray[..., None], 3, axis=2)\n        return rgb\n\n    def _move_agent(self, action: int) -> None:\n        if action == 0:\n            self.agent_y -= self.config.paddle_speed\n        elif action == 1:\n            self.agent_y += self.config.paddle_speed\n        self.agent_y = float(\n            np.clip(self.agent_y, 0, self.config.height - self.config.paddle_height)\n        )\n\n    def _move_opponent(self) -> None:\n        if self._manual_opponent_action is not None:\n            if self._manual_opponent_action == 0:\n                self.opponent_y -= self.config.paddle_speed\n            elif self._manual_opponent_action == 1:\n                self.opponent_y += self.config.paddle_speed\n            self.opponent_y = float(\n                np.clip(self.opponent_y, 0, self.config.height - self.config.paddle_height)\n            )\n            return\n\n        center = self.opponent_y + self.config.paddle_height / 2\n        target = self.ball_y + self.config.ball_size / 2\n        if target > center:\n            self.opponent_y += self.config.paddle_speed * 0.9\n        else:\n            self.opponent_y -= self.config.paddle_speed * 0.9\n        self.opponent_y = float(\n            np.clip(self.opponent_y, 0, self.config.height - self.config.paddle_height)\n        )\n\n    def set_opponent_action(self, action: int | None) -> None:\n        self._manual_opponent_action = action\n\n    def _reset_ball(self) -> None:\n        self.ball_x = self.config.width / 2\n        self.ball_y = self.config.height / 2\n        self.ball_vx = float(self._rng.choice([-2, 2]))\n        self.ball_vy = float(self._rng.choice([-1, 1]))\n\n    def _finish_point(\n        self, reward: float, scorer: str\n    ) -> tuple[np.ndarray, float, bool, bool, dict[str, Any]]:\n        if self.config.score_limit <= 1:\n            self.episode_reason = \"opponent_miss\" if scorer == \"agent\" else \"agent_miss\"\n            return self._obs(), reward, True, False, self._info()\n\n        if (\n            self.agent_score >= self.config.score_limit\n            or self.opponent_score >= self.config.score_limit\n        ):\n            self.episode_reason = \"score_limit\"\n            return self._obs(), reward, True, False, self._info()\n\n        self.rally_length = 0\n        self.episode_reason = \"running\"\n        self._reset_ball()\n        return self._obs(), reward, False, False, self._info()\n\n    def _obs(self) -> np.ndarray:\n        frame = np.zeros((self.config.height, self.config.width), dtype=np.uint8)\n        left_x = 4\n        right_x = self.config.width - 4 - self.config.paddle_width\n        ay = int(self.agent_y)\n        oy = int(self.opponent_y)\n        bx = int(self.ball_x)\n        by = int(self.ball_y)\n        frame[ay : ay + self.config.paddle_height, left_x : left_x + self.config.paddle_width] = 255\n        frame[oy : oy + self.config.paddle_height, right_x : right_x + self.config.paddle_width] = (\n            255\n        )\n        frame[by : by + self.config.ball_size, bx : bx + self.config.ball_size] = 255\n        return frame[..., None]\n\n    def _info(self) -> dict[str, Any]:\n        return {\n            \"rally_length\": self.rally_length,\n            \"hits\": self.hits,\n            \"misses\": self.misses,\n            \"agent_score\": self.agent_score,\n            \"opponent_score\": self.opponent_score,\n            \"episode_reason\": self.episode_reason,\n        }\n",
      "base": "\"\"\"Open-source deterministic MiniPong environment.\"\"\"\n\nfrom __future__ import annotations\n\nfrom dataclasses import dataclass\nfrom typing import Any\n\nimport gymnasium as gym\nimport numpy as np\nfrom gymnasium import spaces\n\n\n@dataclass\nclass MiniPongConfig:\n    width: int = 84\n    height: int = 84\n    paddle_height: int = 16\n    paddle_width: int = 3\n    paddle_speed: int = 3\n    ball_size: int = 3\n    max_steps: int = 1200\n    reward_shaping: bool = False\n\n\nclass MiniPongEnv(gym.Env[np.ndarray, int]):\n    metadata = {\"render_modes\": [\"rgb_array\"], \"render_fps\": 30}\n\n    def __init__(\n        self, render_mode: str | None = None, config: MiniPongConfig | None = None\n    ) -> None:\n        self.config = config or MiniPongConfig()\n        self.render_mode = render_mode\n        self.action_space = spaces.Discrete(3)\n        self.observation_space = spaces.Box(\n            low=0,\n            high=255,\n            shape=(self.config.height, self.config.width, 1),\n            dtype=np.uint8,\n        )\n        self._rng = np.random.default_rng(0)\n        self.steps = 0\n        self.agent_score = 0\n        self.opponent_score = 0\n        self.hits = 0\n        self.misses = 0\n        self.rally_length = 0\n        self.episode_reason = \"running\"\n\n        self.agent_y = 0.0\n        self.opponent_y = 0.0\n        self.ball_x = 0.0\n        self.ball_y = 0.0\n        self.ball_vx = 0.0\n        self.ball_vy = 0.0\n\n    def reset(\n        self, *, seed: int | None = None, options: dict[str, Any] | None = None\n    ) -> tuple[np.ndarray, dict[str, Any]]:\n        super().reset(seed=seed)\n        if seed is not None:\n            self._rng = np.random.default_rng(seed)\n        self.steps = 0\n        self.hits = 0\n        self.misses = 0\n        self.rally_length = 0\n        self.episode_reason = \"running\"\n\n        self.agent_y = (self.config.height - self.config.paddle_height) / 2\n        self.opponent_y = self.agent_y\n        self.ball_x = self.config.width / 2\n        self.ball_y = self.config.height / 2\n        self.ball_vx = float(self._rng.choice([-2, 2]))\n        self.ball_vy = float(self._rng.choice([-1, 1]))\n        return self._obs(), self._info()\n\n    def step(self, action: int) -> tuple[np.ndarray, float, bool, bool, dict[str, Any]]:\n        self.steps += 1\n        self._move_agent(int(action))\n        self._move_opponent()\n        reward = 0.0\n\n        self.ball_x += self.ball_vx\n        self.ball_y += self.ball_vy\n\n        if self.ball_y <= 0 or self.ball_y >= self.config.height - self.config.ball_size:\n            self.ball_vy *= -1\n            self.ball_y = np.clip(self.ball_y, 0, self.config.height - self.config.ball_size)\n\n        left_x = 4\n        right_x = self.config.width - 4 - self.config.paddle_width\n\n        if self.ball_vx < 0 and self.ball_x <= left_x + self.config.paddle_width:\n            if self.agent_y <= self.ball_y <= self.agent_y + self.config.paddle_height:\n                self.ball_vx = abs(self.ball_vx)\n                self.hits += 1\n                self.rally_length += 1\n                if self.config.reward_shaping:\n                    reward += 0.01\n            else:\n                reward -= 1.0\n                self.opponent_score += 1\n                self.misses += 1\n                self.episode_reason = \"agent_miss\"\n                return self._obs(), reward, True, False, self._info()\n\n        if self.ball_vx > 0 and self.ball_x + self.config.ball_size >= right_x:\n            if self.opponent_y <= self.ball_y <= self.opponent_y + self.config.paddle_height:\n                self.ball_vx = -abs(self.ball_vx)\n                self.rally_length += 1\n            else:\n                reward += 1.0\n                self.agent_score += 1\n                self.episode_reason = \"opponent_miss\"\n                return self._obs(), reward, True, False, self._info()\n\n        truncated = self.steps >= self.config.max_steps\n        if truncated:\n            self.episode_reason = \"max_steps\"\n        return self._obs(), reward, False, truncated, self._info()\n\n    def render(self) -> np.ndarray:\n        gray = self._obs().squeeze(-1)\n        rgb = np.repeat(gray[..., None], 3, axis=2)\n        return rgb\n\n    def _move_agent(self, action: int) -> None:\n        if action == 0:\n            self.agent_y -= self.config.paddle_speed\n        elif action == 1:\n            self.agent_y += self.config.paddle_speed\n        self.agent_y = float(\n            np.clip(self.agent_y, 0, self.config.height - self.config.paddle_height)\n        )\n\n    def _move_opponent(self) -> None:\n        center = self.opponent_y + self.config.paddle_height / 2\n        target = self.ball_y + self.config.ball_size / 2\n        if target > center:\n            self.opponent_y += self.config.paddle_speed * 0.9\n        else:\n            self.opponent_y -= self.config.paddle_speed * 0.9\n        self.opponent_y = float(\n            np.clip(self.opponent_y, 0, self.config.height - self.config.paddle_height)\n        )\n\n    def _obs(self) -> np.ndarray:\n        frame = np.zeros((self.config.height, self.config.width), dtype=np.uint8)\n        left_x = 4\n        right_x = self.config.width - 4 - self.config.paddle_width\n        ay = int(self.agent_y)\n        oy = int(self.opponent_y)\n        bx = int(self.ball_x)\n        by = int(self.ball_y)\n        frame[ay : ay + self.config.paddle_height, left_x : left_x + self.config.paddle_width] = 255\n        frame[oy : oy + self.config.paddle_height, right_x : right_x + self.config.paddle_width] = (\n            255\n        )\n        frame[by : by + self.config.ball_size, bx : bx + self.config.ball_size] = 255\n        return frame[..., None]\n\n    def _info(self) -> dict[str, Any]:\n        return {\n            \"rally_length\": self.rally_length,\n            \"hits\": self.hits,\n            \"misses\": self.misses,\n            \"agent_score\": self.agent_score,\n            \"opponent_score\": self.opponent_score,\n            \"episode_reason\": self.episode_reason,\n        }\n"
    },
    "src/play/__init__.py": {
      "additions": 5,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/src/play/__init__.py b/src/play/__init__.py\nnew file mode 100644\nindex 0000000..21f3567\n--- /dev/null\n+++ b/src/play/__init__.py\n@@ -0,0 +1,5 @@\n+\"\"\"Interactive play utilities for MiniPong.\"\"\"\n+\n+from src.play.play_minipong import GameController, get_action_from_keys, prepare_agent_obs\n+\n+__all__ = [\"GameController\", \"get_action_from_keys\", \"prepare_agent_obs\"]\n",
      "raw": "\"\"\"Interactive play utilities for MiniPong.\"\"\"\n\nfrom src.play.play_minipong import GameController, get_action_from_keys, prepare_agent_obs\n\n__all__ = [\"GameController\", \"get_action_from_keys\", \"prepare_agent_obs\"]\n",
      "base": ""
    },
    "src/play/play_minipong.py": {
      "additions": 208,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/src/play/play_minipong.py b/src/play/play_minipong.py\nnew file mode 100644\nindex 0000000..04477ad\n--- /dev/null\n+++ b/src/play/play_minipong.py\n@@ -0,0 +1,208 @@\n+\"\"\"Interactive pygame interface for MiniPong.\"\"\"\n+\n+from __future__ import annotations\n+\n+import argparse\n+from dataclasses import dataclass\n+from pathlib import Path\n+from typing import Any, Literal\n+\n+import numpy as np\n+import torch\n+\n+from src.envs.minipong import MiniPongConfig, MiniPongEnv\n+from src.rl.networks import create_q_network\n+\n+Side = Literal[\"left\", \"right\"]\n+Action = int\n+\n+\n+@dataclass\n+class GameController:\n+    left_agent_enabled: bool = False\n+    right_agent_enabled: bool = False\n+    debug: bool = False\n+    checkpoint_path: str = \"\"\n+\n+    def toggle_agent(self, side: Side) -> bool:\n+        if side == \"left\":\n+            self.left_agent_enabled = not self.left_agent_enabled\n+            return self.left_agent_enabled\n+        self.right_agent_enabled = not self.right_agent_enabled\n+        return self.right_agent_enabled\n+\n+    def get_controller(self, side: Side) -> Literal[\"agent\", \"human\"]:\n+        enabled = self.left_agent_enabled if side == \"left\" else self.right_agent_enabled\n+        return \"agent\" if enabled else \"human\"\n+\n+    def get_status_tag(self, side: Side) -> str:\n+        if self.get_controller(side) == \"agent\":\n+            if not self.debug:\n+                return \"AI Agent\"\n+            policy_name = Path(self.checkpoint_path).name if self.checkpoint_path else \"random\"\n+            return f\"Policy: {policy_name}\"\n+        if side == \"left\":\n+            return \"Keyboard: Up:Q, Down:A\"\n+        return \"Keyboard: Up:P, Down:L\"\n+\n+    def restart(self) -> None:\n+        return None\n+\n+\n+def get_action_from_keys(side: Side, pressed: set[str]) -> Action:\n+    if side == \"left\":\n+        if \"q\" in pressed:\n+            return 0\n+        if \"a\" in pressed:\n+            return 1\n+        return 2\n+    if \"p\" in pressed:\n+        return 0\n+    if \"l\" in pressed:\n+        return 1\n+    return 2\n+\n+\n+def prepare_agent_obs(obs: np.ndarray, side: Side) -> np.ndarray:\n+    if side == \"right\":\n+        return np.ascontiguousarray(np.flip(obs, axis=1))\n+    return obs\n+\n+\n+class AgentPolicy:\n+    def __init__(self, obs_shape: tuple[int, int, int], checkpoint: str) -> None:\n+        self.device = torch.device(\"cuda\" if torch.cuda.is_available() else \"cpu\")\n+        self.network = create_q_network(obs_shape, 3).to(self.device)\n+        self.network.eval()\n+        self.policy_name = \"random\"\n+\n+        if checkpoint:\n+            checkpoint_path = Path(checkpoint)\n+            data = torch.load(checkpoint_path, map_location=self.device, weights_only=True)\n+            state = data[\"model\"] if isinstance(data, dict) and \"model\" in data else data\n+            self.network.load_state_dict(state)\n+            self.policy_name = checkpoint_path.name\n+\n+    def act(self, obs: np.ndarray) -> int:\n+        if self.policy_name == \"random\":\n+            return int(np.random.randint(3))\n+        with torch.no_grad():\n+            obs_tensor = torch.tensor(obs[None], dtype=torch.float32, device=self.device)\n+            q_values = self.network(obs_tensor)\n+            return int(torch.argmax(q_values, dim=1).item())\n+\n+\n+def _pressed_key_names(pygame: Any) -> set[str]:\n+    keys = pygame.key.get_pressed()\n+    pressed: set[str] = set()\n+    keymap = {\n+        pygame.K_q: \"q\",\n+        pygame.K_a: \"a\",\n+        pygame.K_p: \"p\",\n+        pygame.K_l: \"l\",\n+    }\n+    for code, name in keymap.items():\n+        if keys[code]:\n+            pressed.add(name)\n+    return pressed\n+\n+\n+def run_game(debug: bool, checkpoint: str, left_agent: bool, right_agent: bool) -> None:\n+    import pygame\n+\n+    scale = 6\n+    header_height = 80\n+    fps = 30\n+\n+    env = MiniPongEnv(render_mode=\"rgb_array\", config=MiniPongConfig(score_limit=11))\n+    obs, info = env.reset(seed=0)\n+\n+    controller = GameController(\n+        left_agent_enabled=left_agent,\n+        right_agent_enabled=right_agent,\n+        debug=debug,\n+        checkpoint_path=checkpoint,\n+    )\n+    policy = AgentPolicy(obs.shape, checkpoint)\n+\n+    pygame.init()\n+    window_size = (env.config.width * scale, env.config.height * scale + header_height)\n+    screen = pygame.display.set_mode(window_size)\n+    pygame.display.set_caption(\"MiniPong\")\n+    clock = pygame.time.Clock()\n+    font = pygame.font.SysFont(None, 26)\n+\n+    running = True\n+    while running:\n+        for event in pygame.event.get():\n+            if event.type == pygame.QUIT:\n+                running = False\n+            elif event.type == pygame.KEYDOWN:\n+                if event.key == pygame.K_ESCAPE:\n+                    running = False\n+                elif event.key == pygame.K_r:\n+                    controller.restart()\n+                    obs, info = env.reset(seed=0)\n+                elif event.key == pygame.K_a and (event.mod & pygame.KMOD_SHIFT):\n+                    controller.toggle_agent(\"left\")\n+                elif event.key == pygame.K_l and (event.mod & pygame.KMOD_SHIFT):\n+                    controller.toggle_agent(\"right\")\n+\n+        pressed = _pressed_key_names(pygame)\n+\n+        left_action = get_action_from_keys(\"left\", pressed)\n+        if controller.get_controller(\"left\") == \"agent\":\n+            left_action = int(policy.act(prepare_agent_obs(obs, \"left\")))\n+\n+        right_action = get_action_from_keys(\"right\", pressed)\n+        if controller.get_controller(\"right\") == \"agent\":\n+            right_action = int(policy.act(prepare_agent_obs(obs, \"right\")))\n+\n+        env.set_opponent_action(right_action)\n+        obs, _, terminated, truncated, info = env.step(left_action)\n+        if terminated or truncated:\n+            controller.restart()\n+            obs, info = env.reset(seed=0)\n+\n+        frame = env.render()\n+        surface = pygame.surfarray.make_surface(np.transpose(frame, (1, 0, 2)))\n+        surface = pygame.transform.scale(\n+            surface, (env.config.width * scale, env.config.height * scale)\n+        )\n+\n+        screen.fill((0, 0, 0))\n+        screen.blit(surface, (0, header_height))\n+\n+        score_text = f\"Left {info['agent_score']} : {info['opponent_score']} Right\"\n+        screen.blit(font.render(score_text, True, (255, 255, 255)), (10, 10))\n+\n+        left_tag = controller.get_status_tag(\"left\")\n+        right_tag = controller.get_status_tag(\"right\")\n+        screen.blit(font.render(left_tag, True, (255, 255, 255)), (10, 42))\n+        right_surface = font.render(right_tag, True, (255, 255, 255))\n+        screen.blit(right_surface, (window_size[0] - right_surface.get_width() - 10, 42))\n+\n+        pygame.display.flip()\n+        clock.tick(fps)\n+\n+    pygame.quit()\n+\n+\n+def main() -> None:\n+    parser = argparse.ArgumentParser(description=\"Play MiniPong interactively\")\n+    parser.add_argument(\"--checkpoint\", default=\"\", help=\"Path to trained checkpoint (.pt)\")\n+    parser.add_argument(\"--debug\", action=\"store_true\", help=\"Show policy names in status tags\")\n+    parser.add_argument(\"--left-agent\", action=\"store_true\", help=\"Start with left side on agent\")\n+    parser.add_argument(\"--right-agent\", action=\"store_true\", help=\"Start with right side on agent\")\n+    args = parser.parse_args()\n+\n+    run_game(\n+        debug=args.debug,\n+        checkpoint=args.checkpoint,\n+        left_agent=args.left_agent,\n+        right_agent=args.right_agent,\n+    )\n+\n+\n+if __name__ == \"__main__\":\n+    main()\n",
      "raw": "\"\"\"Interactive pygame interface for MiniPong.\"\"\"\n\nfrom __future__ import annotations\n\nimport argparse\nfrom dataclasses import dataclass\nfrom pathlib import Path\nfrom typing import Any, Literal\n\nimport numpy as np\nimport torch\n\nfrom src.envs.minipong import MiniPongConfig, MiniPongEnv\nfrom src.rl.networks import create_q_network\n\nSide = Literal[\"left\", \"right\"]\nAction = int\n\n\n@dataclass\nclass GameController:\n    left_agent_enabled: bool = False\n    right_agent_enabled: bool = False\n    debug: bool = False\n    checkpoint_path: str = \"\"\n\n    def toggle_agent(self, side: Side) -> bool:\n        if side == \"left\":\n            self.left_agent_enabled = not self.left_agent_enabled\n            return self.left_agent_enabled\n        self.right_agent_enabled = not self.right_agent_enabled\n        return self.right_agent_enabled\n\n    def get_controller(self, side: Side) -> Literal[\"agent\", \"human\"]:\n        enabled = self.left_agent_enabled if side == \"left\" else self.right_agent_enabled\n        return \"agent\" if enabled else \"human\"\n\n    def get_status_tag(self, side: Side) -> str:\n        if self.get_controller(side) == \"agent\":\n            if not self.debug:\n                return \"AI Agent\"\n            policy_name = Path(self.checkpoint_path).name if self.checkpoint_path else \"random\"\n            return f\"Policy: {policy_name}\"\n        if side == \"left\":\n            return \"Keyboard: Up:Q, Down:A\"\n        return \"Keyboard: Up:P, Down:L\"\n\n    def restart(self) -> None:\n        return None\n\n\ndef get_action_from_keys(side: Side, pressed: set[str]) -> Action:\n    if side == \"left\":\n        if \"q\" in pressed:\n            return 0\n        if \"a\" in pressed:\n            return 1\n        return 2\n    if \"p\" in pressed:\n        return 0\n    if \"l\" in pressed:\n        return 1\n    return 2\n\n\ndef prepare_agent_obs(obs: np.ndarray, side: Side) -> np.ndarray:\n    if side == \"right\":\n        return np.ascontiguousarray(np.flip(obs, axis=1))\n    return obs\n\n\nclass AgentPolicy:\n    def __init__(self, obs_shape: tuple[int, int, int], checkpoint: str) -> None:\n        self.device = torch.device(\"cuda\" if torch.cuda.is_available() else \"cpu\")\n        self.network = create_q_network(obs_shape, 3).to(self.device)\n        self.network.eval()\n        self.policy_name = \"random\"\n\n        if checkpoint:\n            checkpoint_path = Path(checkpoint)\n            data = torch.load(checkpoint_path, map_location=self.device, weights_only=True)\n            state = data[\"model\"] if isinstance(data, dict) and \"model\" in data else data\n            self.network.load_state_dict(state)\n            self.policy_name = checkpoint_path.name\n\n    def act(self, obs: np.ndarray) -> int:\n        if self.policy_name == \"random\":\n            return int(np.random.randint(3))\n        with torch.no_grad():\n            obs_tensor = torch.tensor(obs[None], dtype=torch.float32, device=self.device)\n            q_values = self.network(obs_tensor)\n            return int(torch.argmax(q_values, dim=1).item())\n\n\ndef _pressed_key_names(pygame: Any) -> set[str]:\n    keys = pygame.key.get_pressed()\n    pressed: set[str] = set()\n    keymap = {\n        pygame.K_q: \"q\",\n        pygame.K_a: \"a\",\n        pygame.K_p: \"p\",\n        pygame.K_l: \"l\",\n    }\n    for code, name in keymap.items():\n        if keys[code]:\n            pressed.add(name)\n    return pressed\n\n\ndef run_game(debug: bool, checkpoint: str, left_agent: bool, right_agent: bool) -> None:\n    import pygame\n\n    scale = 6\n    header_height = 80\n    fps = 30\n\n    env = MiniPongEnv(render_mode=\"rgb_array\", config=MiniPongConfig(score_limit=11))\n    obs, info = env.reset(seed=0)\n\n    controller = GameController(\n        left_agent_enabled=left_agent,\n        right_agent_enabled=right_agent,\n        debug=debug,\n        checkpoint_path=checkpoint,\n    )\n    policy = AgentPolicy(obs.shape, checkpoint)\n\n    pygame.init()\n    window_size = (env.config.width * scale, env.config.height * scale + header_height)\n    screen = pygame.display.set_mode(window_size)\n    pygame.display.set_caption(\"MiniPong\")\n    clock = pygame.time.Clock()\n    font = pygame.font.SysFont(None, 26)\n\n    running = True\n    while running:\n        for event in pygame.event.get():\n            if event.type == pygame.QUIT:\n                running = False\n            elif event.type == pygame.KEYDOWN:\n                if event.key == pygame.K_ESCAPE:\n                    running = False\n                elif event.key == pygame.K_r:\n                    controller.restart()\n                    obs, info = env.reset(seed=0)\n                elif event.key == pygame.K_a and (event.mod & pygame.KMOD_SHIFT):\n                    controller.toggle_agent(\"left\")\n                elif event.key == pygame.K_l and (event.mod & pygame.KMOD_SHIFT):\n                    controller.toggle_agent(\"right\")\n\n        pressed = _pressed_key_names(pygame)\n\n        left_action = get_action_from_keys(\"left\", pressed)\n        if controller.get_controller(\"left\") == \"agent\":\n            left_action = int(policy.act(prepare_agent_obs(obs, \"left\")))\n\n        right_action = get_action_from_keys(\"right\", pressed)\n        if controller.get_controller(\"right\") == \"agent\":\n            right_action = int(policy.act(prepare_agent_obs(obs, \"right\")))\n\n        env.set_opponent_action(right_action)\n        obs, _, terminated, truncated, info = env.step(left_action)\n        if terminated or truncated:\n            controller.restart()\n            obs, info = env.reset(seed=0)\n\n        frame = env.render()\n        surface = pygame.surfarray.make_surface(np.transpose(frame, (1, 0, 2)))\n        surface = pygame.transform.scale(\n            surface, (env.config.width * scale, env.config.height * scale)\n        )\n\n        screen.fill((0, 0, 0))\n        screen.blit(surface, (0, header_height))\n\n        score_text = f\"Left {info['agent_score']} : {info['opponent_score']} Right\"\n        screen.blit(font.render(score_text, True, (255, 255, 255)), (10, 10))\n\n        left_tag = controller.get_status_tag(\"left\")\n        right_tag = controller.get_status_tag(\"right\")\n        screen.blit(font.render(left_tag, True, (255, 255, 255)), (10, 42))\n        right_surface = font.render(right_tag, True, (255, 255, 255))\n        screen.blit(right_surface, (window_size[0] - right_surface.get_width() - 10, 42))\n\n        pygame.display.flip()\n        clock.tick(fps)\n\n    pygame.quit()\n\n\ndef main() -> None:\n    parser = argparse.ArgumentParser(description=\"Play MiniPong interactively\")\n    parser.add_argument(\"--checkpoint\", default=\"\", help=\"Path to trained checkpoint (.pt)\")\n    parser.add_argument(\"--debug\", action=\"store_true\", help=\"Show policy names in status tags\")\n    parser.add_argument(\"--left-agent\", action=\"store_true\", help=\"Start with left side on agent\")\n    parser.add_argument(\"--right-agent\", action=\"store_true\", help=\"Start with right side on agent\")\n    args = parser.parse_args()\n\n    run_game(\n        debug=args.debug,\n        checkpoint=args.checkpoint,\n        left_agent=args.left_agent,\n        right_agent=args.right_agent,\n    )\n\n\nif __name__ == \"__main__\":\n    main()\n",
      "base": ""
    },
    "tests/test_env_minipong_score_limit.py": {
      "additions": 44,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/tests/test_env_minipong_score_limit.py b/tests/test_env_minipong_score_limit.py\nnew file mode 100644\nindex 0000000..0c98655\n--- /dev/null\n+++ b/tests/test_env_minipong_score_limit.py\n@@ -0,0 +1,44 @@\n+from __future__ import annotations\n+\n+from src.envs.minipong import MiniPongConfig, MiniPongEnv\n+\n+\n+def _force_left_miss(env: MiniPongEnv) -> tuple[float, bool, bool, dict[str, object]]:\n+    env.ball_vx = -2.0\n+    env.ball_x = 0.0\n+    env.ball_y = env.config.height - env.config.ball_size\n+    _, reward, terminated, truncated, info = env.step(2)\n+    return reward, terminated, truncated, info\n+\n+\n+def test_score_limit_one_keeps_single_rally_termination() -> None:\n+    env = MiniPongEnv(config=MiniPongConfig(score_limit=1))\n+    env.reset(seed=0)\n+\n+    reward, terminated, truncated, info = _force_left_miss(env)\n+\n+    assert reward == -1.0\n+    assert terminated is True\n+    assert truncated is False\n+    assert info[\"episode_reason\"] == \"agent_miss\"\n+\n+\n+def test_score_limit_multi_rally_resets_ball_and_continues() -> None:\n+    env = MiniPongEnv(config=MiniPongConfig(score_limit=2))\n+    env.reset(seed=0)\n+\n+    reward, terminated, truncated, info = _force_left_miss(env)\n+\n+    assert reward == -1.0\n+    assert terminated is False\n+    assert truncated is False\n+    assert info[\"opponent_score\"] == 1\n+    assert info[\"episode_reason\"] == \"running\"\n+    assert env.ball_x == env.config.width / 2\n+    assert env.ball_y == env.config.height / 2\n+\n+    reward, terminated, _, info = _force_left_miss(env)\n+    assert reward == -1.0\n+    assert terminated is True\n+    assert info[\"opponent_score\"] == 2\n+    assert info[\"episode_reason\"] == \"score_limit\"\n",
      "raw": "from __future__ import annotations\n\nfrom src.envs.minipong import MiniPongConfig, MiniPongEnv\n\n\ndef _force_left_miss(env: MiniPongEnv) -> tuple[float, bool, bool, dict[str, object]]:\n    env.ball_vx = -2.0\n    env.ball_x = 0.0\n    env.ball_y = env.config.height - env.config.ball_size\n    _, reward, terminated, truncated, info = env.step(2)\n    return reward, terminated, truncated, info\n\n\ndef test_score_limit_one_keeps_single_rally_termination() -> None:\n    env = MiniPongEnv(config=MiniPongConfig(score_limit=1))\n    env.reset(seed=0)\n\n    reward, terminated, truncated, info = _force_left_miss(env)\n\n    assert reward == -1.0\n    assert terminated is True\n    assert truncated is False\n    assert info[\"episode_reason\"] == \"agent_miss\"\n\n\ndef test_score_limit_multi_rally_resets_ball_and_continues() -> None:\n    env = MiniPongEnv(config=MiniPongConfig(score_limit=2))\n    env.reset(seed=0)\n\n    reward, terminated, truncated, info = _force_left_miss(env)\n\n    assert reward == -1.0\n    assert terminated is False\n    assert truncated is False\n    assert info[\"opponent_score\"] == 1\n    assert info[\"episode_reason\"] == \"running\"\n    assert env.ball_x == env.config.width / 2\n    assert env.ball_y == env.config.height / 2\n\n    reward, terminated, _, info = _force_left_miss(env)\n    assert reward == -1.0\n    assert terminated is True\n    assert info[\"opponent_score\"] == 2\n    assert info[\"episode_reason\"] == \"score_limit\"\n",
      "base": ""
    },
    "tests/test_env_minipong_smoke.py": {
      "additions": 28,
      "deletions": 0,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/tests/test_env_minipong_smoke.py b/tests/test_env_minipong_smoke.py\nindex 5fd1b0d..56951bf 100644\n--- a/tests/test_env_minipong_smoke.py\n+++ b/tests/test_env_minipong_smoke.py\n@@ -9,3 +9,31 @@ def test_minipong_smoke() -> None:\n     assert obs.shape == (84, 84, 1)\n     assert obs.dtype.name == \"uint8\"\n     assert \"hits\" in info\n+\n+\n+def test_set_opponent_action_manual_and_restore_ai() -> None:\n+    env = MiniPongEnv()\n+    env.reset(seed=0)\n+    start_y = env.opponent_y\n+\n+    env.set_opponent_action(0)\n+    env.step(2)\n+    assert env.opponent_y < start_y\n+\n+    manual_y = env.opponent_y\n+    env.set_opponent_action(None)\n+    env.ball_y = env.opponent_y + 40\n+    env.step(2)\n+    assert env.opponent_y > manual_y\n+\n+\n+def test_reset_clears_manual_opponent_action() -> None:\n+    env = MiniPongEnv()\n+    env.reset(seed=0)\n+    env.set_opponent_action(0)\n+    env.reset(seed=1)\n+\n+    start_y = env.opponent_y\n+    env.ball_y = env.opponent_y + 40\n+    env.step(2)\n+    assert env.opponent_y > start_y\n",
      "raw": "from __future__ import annotations\n\nfrom src.envs.minipong import MiniPongEnv\n\n\ndef test_minipong_smoke() -> None:\n    env = MiniPongEnv()\n    obs, info = env.reset(seed=0)\n    assert obs.shape == (84, 84, 1)\n    assert obs.dtype.name == \"uint8\"\n    assert \"hits\" in info\n\n\ndef test_set_opponent_action_manual_and_restore_ai() -> None:\n    env = MiniPongEnv()\n    env.reset(seed=0)\n    start_y = env.opponent_y\n\n    env.set_opponent_action(0)\n    env.step(2)\n    assert env.opponent_y < start_y\n\n    manual_y = env.opponent_y\n    env.set_opponent_action(None)\n    env.ball_y = env.opponent_y + 40\n    env.step(2)\n    assert env.opponent_y > manual_y\n\n\ndef test_reset_clears_manual_opponent_action() -> None:\n    env = MiniPongEnv()\n    env.reset(seed=0)\n    env.set_opponent_action(0)\n    env.reset(seed=1)\n\n    start_y = env.opponent_y\n    env.ball_y = env.opponent_y + 40\n    env.step(2)\n    assert env.opponent_y > start_y\n",
      "base": "from __future__ import annotations\n\nfrom src.envs.minipong import MiniPongEnv\n\n\ndef test_minipong_smoke() -> None:\n    env = MiniPongEnv()\n    obs, info = env.reset(seed=0)\n    assert obs.shape == (84, 84, 1)\n    assert obs.dtype.name == \"uint8\"\n    assert \"hits\" in info\n"
    },
    "tests/test_play_minipong.py": {
      "additions": 48,
      "deletions": 0,
      "status": "added",
      "binary": false,
      "diff": "diff --git a/tests/test_play_minipong.py b/tests/test_play_minipong.py\nnew file mode 100644\nindex 0000000..9be8681\n--- /dev/null\n+++ b/tests/test_play_minipong.py\n@@ -0,0 +1,48 @@\n+from __future__ import annotations\n+\n+import numpy as np\n+\n+from src.play.play_minipong import GameController, get_action_from_keys, prepare_agent_obs\n+\n+\n+def test_get_action_from_keys() -> None:\n+    assert get_action_from_keys(\"left\", {\"q\"}) == 0\n+    assert get_action_from_keys(\"left\", {\"a\"}) == 1\n+    assert get_action_from_keys(\"left\", set()) == 2\n+    assert get_action_from_keys(\"right\", {\"p\"}) == 0\n+    assert get_action_from_keys(\"right\", {\"l\"}) == 1\n+    assert get_action_from_keys(\"right\", set()) == 2\n+\n+\n+def test_prepare_agent_obs_flips_right_side() -> None:\n+    obs = np.arange(12, dtype=np.uint8).reshape(2, 6, 1)\n+    right = prepare_agent_obs(obs, \"right\")\n+    left = prepare_agent_obs(obs, \"left\")\n+\n+    assert np.array_equal(left, obs)\n+    assert np.array_equal(right[:, :, 0], np.fliplr(obs[:, :, 0]))\n+\n+\n+def test_game_controller_status_and_restart() -> None:\n+    controller = GameController(debug=True, checkpoint_path=\"models/checkpoint.pt\")\n+    assert controller.get_controller(\"left\") == \"human\"\n+    assert controller.get_status_tag(\"left\") == \"Keyboard: Up:Q, Down:A\"\n+\n+    controller.toggle_agent(\"left\")\n+    assert controller.get_controller(\"left\") == \"agent\"\n+    assert controller.get_status_tag(\"left\") == \"Policy: checkpoint.pt\"\n+\n+    nodebug = GameController(left_agent_enabled=True)\n+    assert nodebug.get_status_tag(\"left\") == \"AI Agent\"\n+\n+\n+def test_game_controller_restart_preserves_toggles() -> None:\n+    controller = GameController(left_agent_enabled=True, right_agent_enabled=False)\n+    controller.restart()\n+    assert controller.get_controller(\"left\") == \"agent\"\n+    assert controller.get_controller(\"right\") == \"human\"\n+\n+\n+def test_game_controller_debug_random_policy_name() -> None:\n+    controller = GameController(left_agent_enabled=True, debug=True)\n+    assert controller.get_status_tag(\"left\") == \"Policy: random\"\n",
      "raw": "from __future__ import annotations\n\nimport numpy as np\n\nfrom src.play.play_minipong import GameController, get_action_from_keys, prepare_agent_obs\n\n\ndef test_get_action_from_keys() -> None:\n    assert get_action_from_keys(\"left\", {\"q\"}) == 0\n    assert get_action_from_keys(\"left\", {\"a\"}) == 1\n    assert get_action_from_keys(\"left\", set()) == 2\n    assert get_action_from_keys(\"right\", {\"p\"}) == 0\n    assert get_action_from_keys(\"right\", {\"l\"}) == 1\n    assert get_action_from_keys(\"right\", set()) == 2\n\n\ndef test_prepare_agent_obs_flips_right_side() -> None:\n    obs = np.arange(12, dtype=np.uint8).reshape(2, 6, 1)\n    right = prepare_agent_obs(obs, \"right\")\n    left = prepare_agent_obs(obs, \"left\")\n\n    assert np.array_equal(left, obs)\n    assert np.array_equal(right[:, :, 0], np.fliplr(obs[:, :, 0]))\n\n\ndef test_game_controller_status_and_restart() -> None:\n    controller = GameController(debug=True, checkpoint_path=\"models/checkpoint.pt\")\n    assert controller.get_controller(\"left\") == \"human\"\n    assert controller.get_status_tag(\"left\") == \"Keyboard: Up:Q, Down:A\"\n\n    controller.toggle_agent(\"left\")\n    assert controller.get_controller(\"left\") == \"agent\"\n    assert controller.get_status_tag(\"left\") == \"Policy: checkpoint.pt\"\n\n    nodebug = GameController(left_agent_enabled=True)\n    assert nodebug.get_status_tag(\"left\") == \"AI Agent\"\n\n\ndef test_game_controller_restart_preserves_toggles() -> None:\n    controller = GameController(left_agent_enabled=True, right_agent_enabled=False)\n    controller.restart()\n    assert controller.get_controller(\"left\") == \"agent\"\n    assert controller.get_controller(\"right\") == \"human\"\n\n\ndef test_game_controller_debug_random_policy_name() -> None:\n    controller = GameController(left_agent_enabled=True, debug=True)\n    assert controller.get_status_tag(\"left\") == \"Policy: random\"\n",
      "base": ""
    }
  }
}