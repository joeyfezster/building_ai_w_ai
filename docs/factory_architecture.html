<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dark Factory Architecture — MiniPong</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --border: #30363d;
    --text: #e6edf3;
    --muted: #8b949e;
    --human: #f0883e;
    --factory: #58a6ff;
    --codex: #3fb950;
    --holdout: #f85149;
    --feedback: #bc8cff;
    --pass: #3fb950;
    --fail: #f85149;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; line-height: 1.6; }

  .header { text-align: center; padding: 40px 20px 20px; }
  .header h1 { font-size: 28px; font-weight: 600; }
  .header p { color: var(--muted); margin-top: 8px; font-size: 15px; }

  .tabs { display: flex; justify-content: center; gap: 8px; padding: 20px; flex-wrap: wrap; }
  .tab { padding: 10px 24px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); color: var(--muted); cursor: pointer; font-size: 14px; transition: all 0.2s; }
  .tab:hover { border-color: var(--factory); color: var(--text); }
  .tab.active { background: var(--factory); color: #fff; border-color: var(--factory); }

  .view { max-width: 1100px; margin: 0 auto; padding: 20px; display: none; }
  .view.active { display: block; }

  /* Architecture Diagram */
  .arch-flow { display: flex; flex-direction: column; gap: 0; align-items: center; }
  .arch-node { background: var(--surface); border: 2px solid var(--border); border-radius: 12px; padding: 24px; width: 100%; max-width: 800px; position: relative; }
  .arch-node h3 { font-size: 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
  .arch-node p { color: var(--muted); font-size: 14px; }
  .arch-node.human { border-color: var(--human); }
  .arch-node.human h3 { color: var(--human); }
  .arch-node.factory { border-color: var(--factory); }
  .arch-node.factory h3 { color: var(--factory); }
  .arch-node.codex { border-color: var(--codex); }
  .arch-node.codex h3 { color: var(--codex); }
  .arch-node.holdout { border-color: var(--holdout); }
  .arch-node.holdout h3 { color: var(--holdout); }
  .arch-node.feedback { border-color: var(--feedback); }
  .arch-node.feedback h3 { color: var(--feedback); }

  .arrow { width: 2px; height: 40px; background: var(--border); position: relative; }
  .arrow::after { content: ''; position: absolute; bottom: -6px; left: -5px; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 8px solid var(--border); }
  .arrow.colored { background: var(--feedback); }
  .arrow.colored::after { border-top-color: var(--feedback); }

  .loop-bracket { border: 2px dashed var(--feedback); border-radius: 16px; padding: 16px; margin: -8px 0; width: 100%; max-width: 840px; position: relative; }
  .loop-label { position: absolute; top: -12px; left: 24px; background: var(--bg); padding: 0 8px; color: var(--feedback); font-size: 13px; font-weight: 600; }

  .sub-steps { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
  .sub-step { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 12px; font-size: 13px; }
  .sub-step .label { font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
  .sub-step.l1 .label { color: var(--factory); }
  .sub-step.l15 .label { color: #d2a8ff; }
  .sub-step.l2 .label { color: var(--holdout); }

  /* Wiring Table */
  .wiring-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  .wiring-table th { text-align: left; padding: 12px 16px; background: var(--surface); border-bottom: 2px solid var(--border); font-size: 13px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .wiring-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: top; }
  .wiring-table tr:hover td { background: rgba(255,255,255,0.02); }

  .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
  .badge.human { background: rgba(240,136,62,0.15); color: var(--human); }
  .badge.factory { background: rgba(88,166,255,0.15); color: var(--factory); }
  .badge.codex { background: rgba(63,185,80,0.15); color: var(--codex); }
  .badge.holdout { background: rgba(248,81,73,0.15); color: var(--holdout); }

  /* Human Interaction Points */
  .interaction-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 16px; }
  .interaction-card h3 { color: var(--human); font-size: 16px; margin-bottom: 8px; }
  .interaction-card .when { color: var(--muted); font-size: 13px; margin-bottom: 12px; font-style: italic; }
  .interaction-card .action { font-size: 14px; }
  .interaction-card code { background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; font-size: 13px; }

  /* Validation Checklist */
  .check-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .check-item { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
  .check-item.pass { border-color: var(--pass); }
  .check-item.fail { border-color: var(--fail); }
  .check-item h4 { font-size: 14px; margin-bottom: 4px; }
  .check-item .status { font-size: 13px; font-weight: 600; }
  .check-item .status.pass { color: var(--pass); }
  .check-item .status.fail { color: var(--fail); }
  .check-item p { color: var(--muted); font-size: 13px; margin-top: 4px; }

  .section-title { font-size: 20px; font-weight: 600; margin: 32px 0 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }

  .legend { display: flex; gap: 24px; justify-content: center; padding: 16px; flex-wrap: wrap; }
  .legend-item { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--muted); }
  .legend-dot { width: 12px; height: 12px; border-radius: 50%; }

  .fs-shuffle { background: rgba(248,81,73,0.1); border: 1px dashed var(--holdout); border-radius: 8px; padding: 16px; margin-top: 16px; }
  .fs-shuffle h4 { color: var(--holdout); font-size: 14px; margin-bottom: 8px; }
  .fs-shuffle pre { font-size: 12px; color: var(--muted); white-space: pre-wrap; }
</style>
</head>
<body>

<div class="header">
  <h1>Dark Factory Architecture</h1>
  <p>MiniPong RL System — Convergence Loop Infrastructure</p>
</div>

<div class="legend">
  <div class="legend-item"><div class="legend-dot" style="background:var(--human)"></div> Human (Project Lead)</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--factory)"></div> Factory Orchestrator</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--codex)"></div> Codex (Attractor)</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--holdout)"></div> Holdout Scenarios</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--feedback)"></div> Feedback Loop</div>
</div>

<div class="tabs">
  <div class="tab active" onclick="showView('architecture')">Architecture</div>
  <div class="tab" onclick="showView('wiring')">Component Wiring</div>
  <div class="tab" onclick="showView('human')">Human Interaction</div>
  <div class="tab" onclick="showView('validation')">Validation Proof</div>
</div>

<!-- ─── ARCHITECTURE VIEW ─── -->
<div class="view active" id="view-architecture">
  <div class="arch-flow">

    <div class="arch-node human">
      <h3>HUMAN — Project Lead</h3>
      <p>Authors specs (/specs/*.md) and scenarios (/scenarios/*.md). Sets satisfaction threshold. Triggers factory. Escalates when loop stalls.</p>
      <div class="sub-steps">
        <div class="sub-step"><div class="label" style="color:var(--human)">Writes</div>/specs/ — what the system should do</div>
        <div class="sub-step"><div class="label" style="color:var(--human)">Writes</div>/scenarios/ — holdout evaluation criteria</div>
      </div>
    </div>
    <div class="arrow"></div>

    <div class="loop-bracket">
      <div class="loop-label">CONVERGENCE LOOP (up to N iterations)</div>

      <div class="arch-node factory" style="margin-bottom:0">
        <h3>FACTORY ORCHESTRATOR</h3>
        <p>.github/workflows/factory.yaml — runs the loop, controls iteration</p>
        <div class="sub-steps" style="grid-template-columns:1fr 1fr 1fr">
          <div class="sub-step l1"><div class="label">Gate 1: Deterministic CI</div>make lint + typecheck + test<br><em>If fail → skip remaining, go to feedback</em></div>
          <div class="sub-step l15"><div class="label">Gate 2: Structural Quality</div>vulture (dead code), radon (complexity), coverage, bandit (security)<br><em>Non-blocking but tracked</em></div>
          <div class="sub-step l2"><div class="label">Gate 3: Behavioral Scenarios</div>scripts/run_scenarios.py<br><em>12 holdout scenarios, satisfaction scoring</em></div>
        </div>
      </div>
      <div class="arrow" style="margin: 0 auto"></div>

      <div style="display:flex;gap:16px;width:100%;max-width:800px;margin:0 auto">
        <div class="arch-node holdout" style="flex:1">
          <h3>HOLDOUT SCENARIOS</h3>
          <p>/scenarios/*.md — Codex NEVER sees these. Filesystem shuffle hides them during Codex execution.</p>
        </div>
        <div class="arch-node feedback" style="flex:1">
          <h3>FEEDBACK COMPILER</h3>
          <p>scripts/compile_feedback.py → artifacts/factory/feedback_iter_N.md</p>
        </div>
      </div>
      <div class="arrow colored" style="margin: 0 auto"></div>

      <div class="arch-node codex">
        <h3>CODEX (Attractor)</h3>
        <p>openai/codex-action@v1 — reads /specs/ + feedback, writes code fixes. Non-interactive. Commits directly.</p>
        <div class="sub-steps">
          <div class="sub-step"><div class="label" style="color:var(--codex)">Reads</div>/specs/*.md + feedback_iter_N.md</div>
          <div class="sub-step"><div class="label" style="color:var(--codex)">Writes</div>src/, tests/, configs/, Makefile</div>
        </div>
      </div>
    </div>

    <div class="arrow colored"></div>
    <div class="arch-node factory" style="border-style:dashed">
      <h3>EXIT CONDITIONS</h3>
      <p>Satisfaction threshold met (default 80%) → post PR comment, await project lead's accept/merge decision.<br>Max iterations reached → tag project lead for escalation.</p>
    </div>

    <div class="fs-shuffle">
      <h4>Filesystem Shuffle — Scenario Isolation</h4>
      <pre>Before Codex runs:  mv /scenarios/ /tmp/factory_scenarios    (scenarios disappear)
Codex executes:     workspace has NO /scenarios/ directory    (hard gate)
After Codex:        cp -r /tmp/factory_scenarios /scenarios/  (scenarios restored)

Why: .codexignore doesn't exist. This is a filesystem-level gate, not an LLM instruction.</pre>
    </div>
  </div>
</div>

<!-- ─── WIRING VIEW ─── -->
<div class="view" id="view-wiring">
  <h2 class="section-title">Component Wiring — How Each File Maps to the Factory</h2>
  <table class="wiring-table">
    <thead>
      <tr><th>File</th><th>Owner</th><th>Dark Factory Role</th><th>Reads From</th><th>Writes To</th></tr>
    </thead>
    <tbody>
      <tr>
        <td><code>/specs/*.md</code></td>
        <td><span class="badge human">Human</span></td>
        <td>Source of truth — what the system should do. Codex reads these as requirements.</td>
        <td>—</td>
        <td>Codex prompt context</td>
      </tr>
      <tr>
        <td><code>/scenarios/*.md</code></td>
        <td><span class="badge holdout">Holdout</span></td>
        <td>Behavioral holdout set — ML-style validation split. Agent never sees evaluation criteria.</td>
        <td>—</td>
        <td>run_scenarios.py</td>
      </tr>
      <tr>
        <td><code>scripts/run_scenarios.py</code></td>
        <td><span class="badge factory">Factory</span></td>
        <td>Scenario evaluation engine. Parses scenario markdown, executes eval commands, produces JSON report.</td>
        <td>/scenarios/*.md</td>
        <td>artifacts/factory/scenario_results.json</td>
      </tr>
      <tr>
        <td><code>scripts/compile_feedback.py</code></td>
        <td><span class="badge factory">Factory</span></td>
        <td>Feedback generation. Reads scenario results + CI logs, infers root causes, produces structured feedback for Codex.</td>
        <td>scenario_results.json, ci_output.log, previous feedback</td>
        <td>artifacts/factory/feedback_iter_N.md</td>
      </tr>
      <tr>
        <td><code>.github/workflows/factory.yaml</code></td>
        <td><span class="badge factory">Factory</span></td>
        <td>Orchestrator. Implements the convergence loop: validate → scenarios → threshold check → feedback → Codex → repeat.</td>
        <td>All of the above</td>
        <td>PR comments, iteration state</td>
      </tr>
      <tr>
        <td><code>.github/codex/prompts/factory_fix.md</code></td>
        <td><span class="badge factory">Factory</span></td>
        <td>Codex prompt template. Instructions + constraints for each iteration. Lists protected files, fix priorities.</td>
        <td>—</td>
        <td>Codex context</td>
      </tr>
      <tr>
        <td><code>artifacts/factory/feedback_iter_N.md</code></td>
        <td><span class="badge factory">Factory</span></td>
        <td>Iteration feedback. Full error output, inferred causes, convergence trajectory. This is what Codex reads to fix things.</td>
        <td>compile_feedback.py</td>
        <td>Codex context</td>
      </tr>
      <tr>
        <td><code>CLAUDE.md</code></td>
        <td><span class="badge factory">Factory</span></td>
        <td>Repo-level context for Claude Code (escalation path). Documents the factory model, protected files, quick commands.</td>
        <td>—</td>
        <td>Claude Code context</td>
      </tr>
      <tr>
        <td><code>src/**</code></td>
        <td><span class="badge codex">Codex</span></td>
        <td>Product code. The "opaque weights" — correctness inferred from behavior, not inspection.</td>
        <td>specs</td>
        <td>Evaluated by scenarios</td>
      </tr>
      <tr>
        <td><code>Makefile</code></td>
        <td><span class="badge codex">Codex</span> / <span class="badge factory">Factory</span></td>
        <td>Build interface. Factory targets (run-scenarios, compile-feedback, factory-local) + product targets (lint, test, train-smoke).</td>
        <td>—</td>
        <td>—</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- ─── HUMAN INTERACTION VIEW ─── -->
<div class="view" id="view-human">
  <h2 class="section-title">Human Interaction Points</h2>
  <p style="color:var(--muted);margin-bottom:24px">The factory is designed to run autonomously. The project lead's involvement is limited to six distinct touchpoints:</p>

  <div class="interaction-card">
    <h3>1. Author Specs</h3>
    <div class="when">Before the factory runs — defines intent</div>
    <div class="action">
      Write or update files in <code>/specs/</code>. These are the requirements Codex reads. The specs define <em>what</em> the system should do.
      No code. No implementation details. Just behavioral contracts.
    </div>
  </div>

  <div class="interaction-card">
    <h3>2. Author Scenarios</h3>
    <div class="when">Before the factory runs — defines success criteria</div>
    <div class="action">
      Write or update files in <code>/scenarios/</code>. Each scenario is a behavioral expectation with a runnable evaluation command.
      These are the holdout set — Codex never sees them. This is how you define "done" without reviewing code.
    </div>
  </div>

  <div class="interaction-card">
    <h3>3. Trigger the Factory</h3>
    <div class="when">When specs and scenarios are ready</div>
    <div class="action">
      GitHub Actions UI: <code>Actions → Dark Factory → Run workflow</code><br>
      Or CLI: <code>gh workflow run factory.yaml -f max_iterations=5 -f satisfaction_threshold=0.80</code><br>
      Or: push to a <code>factory/*</code> branch.
    </div>
  </div>

  <div class="interaction-card">
    <h3>4. Review Satisfaction Report</h3>
    <div class="when">After the factory converges or stalls</div>
    <div class="action">
      The factory posts a PR comment with the satisfaction score and iteration count.
      If converged: review the score, decide if it's good enough. You don't read the code.
      If stalled: read <code>artifacts/factory/feedback_iter_N.md</code> to understand what's stuck.
    </div>
  </div>

  <div class="interaction-card">
    <h3>5. Escalate to Interactive Debug</h3>
    <div class="when">When the factory stalls for 3+ iterations with no improvement</div>
    <div class="action">
      Open the repo in Claude Code (desktop). It reads <code>CLAUDE.md</code> automatically.
      Point it at the latest feedback file. Claude Code does interactive debugging — the thing the factory loop can't do.
      Fix the issue, push, let the factory resume.
    </div>
  </div>

  <div class="interaction-card">
    <h3>6. Accept / Promote / Ship</h3>
    <div class="when">After the factory converges and the satisfaction report looks right</div>
    <div class="action">
      Merge the factory branch into main. This is the irreversible human gate — the decision that the product is ready.
      Review the satisfaction dashboard (scenario pass/fail matrix, convergence trajectory).
      Do NOT review code. The satisfaction score is your signal.
    </div>
  </div>

  <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px;margin-top:24px">
    <h3 style="color:var(--factory);margin-bottom:12px">What the Project Lead Does NOT Do</h3>
    <ul style="color:var(--muted);font-size:14px;padding-left:20px">
      <li>Read diffs or code changes</li>
      <li>Review PRs for code quality</li>
      <li>Debug test failures manually</li>
      <li>Write any production code</li>
      <li>Approve individual Codex commits</li>
    </ul>
    <p style="margin-top:12px;font-size:14px">Code is opaque weights. Correctness is inferred from behavior. This is the validation constraint.</p>
  </div>
</div>

<!-- ─── VALIDATION VIEW ─── -->
<div class="view" id="view-validation">
  <h2 class="section-title">Factory Validation — What's Built and Proven</h2>
  <p style="color:var(--muted);margin-bottom:24px">Current status: factory infrastructure complete. Running against main branch (no MiniPong code yet).</p>

  <div class="check-grid">
    <div class="check-item pass">
      <h4>CLAUDE.md</h4>
      <div class="status pass">COMPLETE</div>
      <p>Repo-level context with factory operating model, protected files, quick commands</p>
    </div>
    <div class="check-item pass">
      <h4>/specs/ (6 files)</h4>
      <div class="status pass">COMPLETE</div>
      <p>system.md, env.md, rl.md, training.md, dashboard.md, proof.md</p>
    </div>
    <div class="check-item pass">
      <h4>/scenarios/ (12 files)</h4>
      <div class="status pass">COMPLETE</div>
      <p>5 environment, 2 training, 1 pipeline, 1 dashboard, 3 integration</p>
    </div>
    <div class="check-item pass">
      <h4>run_scenarios.py</h4>
      <div class="status pass">COMPLETE — passes ruff + mypy</div>
      <p>Parses scenarios, executes eval commands, produces JSON report with satisfaction score</p>
    </div>
    <div class="check-item pass">
      <h4>compile_feedback.py</h4>
      <div class="status pass">COMPLETE — passes ruff + mypy</div>
      <p>Reads results + CI logs, infers root causes, produces structured feedback markdown</p>
    </div>
    <div class="check-item pass">
      <h4>factory.yaml workflow</h4>
      <div class="status pass">COMPLETE</div>
      <p>Convergence loop with FS shuffle, Codex invocation, PR comments, stall detection</p>
    </div>
    <div class="check-item pass">
      <h4>factory_fix.md prompt</h4>
      <div class="status pass">COMPLETE</div>
      <p>Codex instructions: read specs, read feedback, fix priorities, protected file list</p>
    </div>
    <div class="check-item pass">
      <h4>Makefile targets</h4>
      <div class="status pass">COMPLETE</div>
      <p>run-scenarios, compile-feedback, factory-local, factory-status</p>
    </div>
    <div class="check-item pass">
      <h4>docs/dark_factory.md</h4>
      <div class="status pass">COMPLETE</div>
      <p>Full operating manual: architecture, scenario writing, feedback reading, escalation</p>
    </div>
    <div class="check-item pass">
      <h4>ProjectLeadAsks.md</h4>
      <div class="status pass">COMPLETE</div>
      <p>OpenAI API key, satisfaction threshold, branch strategy, token budget</p>
    </div>
  </div>

  <h2 class="section-title">Smoke Test Results — Iteration 1 (main branch)</h2>
  <p style="color:var(--muted);margin-bottom:16px">Expected: most scenarios fail because the MiniPong code is on the Codex branch, not main. This proves the factory detects missing functionality correctly.</p>

  <div class="check-grid">
    <div class="check-item fail">
      <h4>Environment Determinism</h4>
      <div class="status fail">FAIL — ModuleNotFoundError</div>
      <p>src.envs.minipong doesn't exist on main (expected)</p>
    </div>
    <div class="check-item fail">
      <h4>Observation Space</h4>
      <div class="status fail">FAIL — ModuleNotFoundError</div>
      <p>Same root cause — no MiniPong env on main</p>
    </div>
    <div class="check-item fail">
      <h4>Reward Structure</h4>
      <div class="status fail">FAIL — ModuleNotFoundError</div>
      <p>Same root cause</p>
    </div>
    <div class="check-item fail">
      <h4>Rendering</h4>
      <div class="status fail">FAIL — ModuleNotFoundError</div>
      <p>Same root cause</p>
    </div>
    <div class="check-item fail">
      <h4>Info Dict</h4>
      <div class="status fail">FAIL — ModuleNotFoundError</div>
      <p>Same root cause</p>
    </div>
    <div class="check-item fail">
      <h4>Training Artifacts</h4>
      <div class="status fail">FAIL — No artifacts</div>
      <p>Training pipeline not on main</p>
    </div>
    <div class="check-item fail">
      <h4>Eval Videos</h4>
      <div class="status fail">FAIL — No videos</div>
      <p>Training pipeline not on main</p>
    </div>
    <div class="check-item pass">
      <h4>verify-learning cmd</h4>
      <div class="status pass">PASS</div>
      <p>Command exists and runs (with relaxed thresholds)</p>
    </div>
    <div class="check-item pass">
      <h4>Dashboard Loads</h4>
      <div class="status pass">PASS</div>
      <p>Module is importable</p>
    </div>
    <div class="check-item pass">
      <h4>env-smoke</h4>
      <div class="status pass">PASS</div>
      <p>Makefile target works (existing atari env)</p>
    </div>
    <div class="check-item pass">
      <h4>Lint + Typecheck</h4>
      <div class="status pass">PASS</div>
      <p>Codebase passes ruff and mypy</p>
    </div>
    <div class="check-item pass">
      <h4>Full CPU Pipeline</h4>
      <div class="status pass">PASS</div>
      <p>Pipeline commands exist (with relaxed thresholds)</p>
    </div>
  </div>

  <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px;margin-top:24px">
    <h3 style="margin-bottom:12px">Satisfaction: 42% (5/12) — Expected for main branch</h3>
    <p style="color:var(--muted);font-size:14px">
      The 7 failures are all because the MiniPong code from PR #4 hasn't been merged yet.
      When the factory runs against the Codex branch, these should start passing — and the factory loop will iterate until 80%+ are satisfied.
    </p>
    <p style="color:var(--muted);font-size:14px;margin-top:8px">
      <strong>Feedback compiler correctly identified:</strong> 5 import errors (missing module), 2 assertion failures (missing artifacts).
      Root cause inference is working.
    </p>
  </div>
</div>

<script>
function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('view-' + id).classList.add('active');
  event.target.classList.add('active');
}
</script>
</body>
</html>
