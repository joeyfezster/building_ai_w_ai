<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PR #6: [Factory] df-crank-v01 converged at 100%</title>
<style>
  :root {
    --green: #22c55e; --green-bg: #f0fdf4; --green-border: #86efac;
    --yellow: #eab308; --yellow-bg: #fefce8;
    --orange: #f97316; --orange-bg: #fff7ed;
    --red: #ef4444; --red-bg: #fef2f2;
    --gray: #6b7280; --gray-bg: #f9fafb; --gray-border: #e5e7eb;
    --blue: #3b82f6; --blue-bg: #eff6ff;
    --purple: #8b5cf6; --purple-bg: #f5f3ff;
    --text: #1f2937; --text-secondary: #6b7280; --text-muted: #9ca3af;
    --border: #e5e7eb; --bg: #f3f4f6;
    --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
  }
  /* ‚îÄ‚îÄ Dark theme overrides ‚îÄ‚îÄ */
  [data-theme="dark"] {
    --text: #e5e7eb; --text-secondary: #9ca3af; --text-muted: #6b7280;
    --border: #374151; --bg: #111827;
    --gray-bg: #1f2937; --gray-border: #374151; --gray: #9ca3af;
    --green-bg: #064e3b; --green-border: #10b981;
    --yellow-bg: #713f12; --red-bg: #7f1d1d; --orange-bg: #7c2d12;
    --blue-bg: #1e3a5f; --purple-bg: #2e1065;
  }
  [data-theme="dark"] .header,
  [data-theme="dark"] .section,
  [data-theme="dark"] .gate,
  [data-theme="dark"] .tab-panel,
  [data-theme="dark"] .tab-bar { background: #1f2937; }
  [data-theme="dark"] .tab-btn { color: #9ca3af; }
  [data-theme="dark"] .tab-btn:hover { background: #374151; }
  [data-theme="dark"] .tab-btn.active { color: #60a5fa; background: #1f2937; }
  [data-theme="dark"] th { background: #1f2937; color: #9ca3af; }
  [data-theme="dark"] tr:nth-child(even) td { background: rgba(255,255,255,0.02); }
  [data-theme="dark"] tr.expandable:hover,
  [data-theme="dark"] .section-header:hover,
  [data-theme="dark"] .decision-header:hover,
  [data-theme="dark"] .pm-header:hover,
  [data-theme="dark"] .scenario-card:hover { background: #374151; }
  [data-theme="dark"] .history-event { background: #1f2937; border-color: #374151; }
  [data-theme="dark"] tr.detail-row td,
  [data-theme="dark"] .adv-detail-row td { background: #1a2332; }
  [data-theme="dark"] .arch-legend { background: #1f2937; }
  [data-theme="dark"] .conv-card { border-color: #374151; }
  [data-theme="dark"] .decision-card { border-color: #374151; }
  [data-theme="dark"] .pm-item { border-color: #374151; }
  [data-theme="dark"] .scenario-card { border-color: #374151; }
  [data-theme="dark"] .arch-floating { background: rgba(31,41,55,0.95); }
  [data-theme="dark"] .code-block { background: #0f172a; }
  [data-theme="dark"] .gate-popover { background: #1f2937; border-color: #374151; }
  [data-theme="dark"] .badge.pass { background: #064e3b; color: #34d399; }
  [data-theme="dark"] .badge.fail { background: #7f1d1d; color: #fca5a5; }
  [data-theme="dark"] .health-tag.normal { background: #064e3b; color: #34d399; }
  [data-theme="dark"] .health-tag.acceptable { background: #713f12; color: #fde047; }
  [data-theme="dark"] .health-tag.watch { background: #7c2d12; color: #fdba74; }
  [data-theme="dark"] .health-tag.refactor { background: #7f1d1d; color: #fca5a5; }
  [data-theme="dark"] .grade.a { background: #064e3b; color: #34d399; }
  [data-theme="dark"] .grade.b { background: #713f12; color: #fde047; }
  [data-theme="dark"] .grade.c { background: #7c2d12; color: #fdba74; }
  [data-theme="dark"] .grade.f { background: #7f1d1d; color: #fca5a5; }
  [data-theme="dark"] .grade.na { background: #374151; color: #9ca3af; }
  [data-theme="dark"] .priority.low { background: #1e3a5f; color: #93c5fd; }
  [data-theme="dark"] .priority.medium { background: #713f12; color: #fde047; }
  [data-theme="dark"] .priority.cosmetic { background: #374151; color: #9ca3af; }
  [data-theme="dark"] .status-badge.pass { background: #064e3b; color: #34d399; }
  [data-theme="dark"] .status-badge.info { background: #1e3a5f; color: #93c5fd; }
  [data-theme="dark"] .status-badge.warn { background: #713f12; color: #fde047; }
  [data-theme="dark"] .status-badge.fail { background: #7f1d1d; color: #fca5a5; }
  [data-theme="dark"] .zone-tag { background: #1e3a5f; color: #93c5fd; }
  [data-theme="dark"] .zone-tag.factory { background: #1e3a5f; color: #93c5fd; }
  [data-theme="dark"] .zone-tag.product { background: #064e3b; color: #6ee7b7; }
  [data-theme="dark"] .zone-tag.infra { background: #2e1065; color: #c4b5fd; }
  [data-theme="dark"] .scenario-box.failure { background: #3b1111; border-left-color: #ef4444; }
  [data-theme="dark"] .scenario-box.success { background: #052e16; border-left-color: #22c55e; }
  [data-theme="dark"] .ci-check-item:hover { background: #374151; }
  [data-theme="dark"] .conv-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
  [data-theme="dark"] .history-event:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.25); }
  [data-theme="dark"] .file-path-link { border-bottom-color: #6b7280; }
  [data-theme="dark"] .file-path-link:hover { border-bottom-color: #60a5fa; color: #60a5fa; }
  [data-theme="dark"] .stat { background: #1f2937; }
  [data-theme="dark"] .stat.green { background: #064e3b; color: #34d399; }
  [data-theme="dark"] .stat.red { background: #7f1d1d; color: #fca5a5; }
  [data-theme="dark"] #arch-diagram { background: #1a2332; border-color: #374151; }
  [data-theme="dark"] .history-timeline::before { background: #374151; }
  [data-theme="dark"] .history-legend { background: #1f2937; }
  [data-theme="dark"] .conv-card-detail { border-top-color: #374151; }

  /* ‚îÄ‚îÄ Light theme diff modal overrides ‚îÄ‚îÄ */
  :root:not([data-theme="dark"]) .file-modal { background: #ffffff; }
  :root:not([data-theme="dark"]) .file-modal-header { background: #f5f5f5; border-bottom-color: #e0e0e0; }
  :root:not([data-theme="dark"]) .file-modal-header h3 { color: #333333; }
  :root:not([data-theme="dark"]) .file-modal-toolbar { background: #fafafa; border-bottom-color: #e0e0e0; }
  :root:not([data-theme="dark"]) .file-modal-tab { color: #666666; }
  :root:not([data-theme="dark"]) .file-modal-tab:hover { color: #333333; background: #f0f0f0; }
  :root:not([data-theme="dark"]) .file-modal-tab.active { color: #1d4ed8; background: #ffffff; border-bottom-color: var(--blue); }
  :root:not([data-theme="dark"]) .file-modal-body { background: #ffffff; }
  :root:not([data-theme="dark"]) .file-modal-close { color: #999999; }
  :root:not([data-theme="dark"]) .file-modal-close:hover { background: #e0e0e0; color: #333333; }
  :root:not([data-theme="dark"]) .file-modal-github { background: #f0f0f0; border-color: #e0e0e0; color: #333333; }
  :root:not([data-theme="dark"]) .file-modal-github:hover { background: #e0e0e0; color: #111111; }
  :root:not([data-theme="dark"]) .fm-stats .fm-add { color: #166534; }
  :root:not([data-theme="dark"]) .fm-stats .fm-del { color: #991b1b; }
  :root:not([data-theme="dark"]) .diff-unified .diff-add { background: rgba(34,197,94,0.12); color: #166534; }
  :root:not([data-theme="dark"]) .diff-unified .diff-del { background: rgba(239,68,68,0.12); color: #991b1b; }
  :root:not([data-theme="dark"]) .diff-unified .diff-ctx { color: #333333; }
  :root:not([data-theme="dark"]) .diff-unified .diff-hunk { background: rgba(59,130,246,0.08); color: #2563eb; }
  :root:not([data-theme="dark"]) .diff-unified .diff-ln { color: #999999; border-right-color: #e0e0e0; }
  :root:not([data-theme="dark"]) .diff-split .diff-add { background: rgba(34,197,94,0.12); color: #166534; }
  :root:not([data-theme="dark"]) .diff-split .diff-del { background: rgba(239,68,68,0.12); color: #991b1b; }
  :root:not([data-theme="dark"]) .diff-split .diff-ctx { color: #333333; }
  :root:not([data-theme="dark"]) .diff-split .diff-empty { background: #f9f9f9; }
  :root:not([data-theme="dark"]) .diff-split .diff-ln { color: #999999; }
  :root:not([data-theme="dark"]) .diff-split .diff-sep { background: #e0e0e0; }
  :root:not([data-theme="dark"]) .diff-split .diff-hunk td { background: rgba(59,130,246,0.06); color: #2563eb; }
  :root:not([data-theme="dark"]) .diff-raw td { color: #333333; }
  :root:not([data-theme="dark"]) .diff-raw .diff-ln { color: #999999; border-right-color: #e0e0e0; }
  :root:not([data-theme="dark"]) .diff-new-file-banner { background: rgba(34,197,94,0.08); color: #166534; border-bottom-color: #e0e0e0; }
  :root:not([data-theme="dark"]) .diff-deleted-file-banner { background: rgba(239,68,68,0.08); color: #991b1b; border-bottom-color: #e0e0e0; }
  :root:not([data-theme="dark"]) .diff-loading { color: #999999; }
  :root:not([data-theme="dark"]) .diff-error { color: #991b1b; }

  /* ‚îÄ‚îÄ Theme toggle ‚îÄ‚îÄ */
  .theme-toggle { display: inline-flex; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-left: 12px; vertical-align: middle; }
  .theme-toggle button { border: none; background: transparent; padding: 4px 10px; font-size: 14px; cursor: pointer; color: var(--text-secondary); transition: background 0.15s, color 0.15s; line-height: 1; }
  .theme-toggle button:hover { background: var(--gray-bg); }
  .theme-toggle button.active { background: var(--blue); color: white; }
  .theme-toggle button:not(:last-child) { border-right: 1px solid var(--border); }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: var(--text); background: var(--bg); line-height: 1.5; font-size: 14px; }
  .container { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }

  /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
  .tab-bar { display: flex; gap: 0; background: white; border-radius: 12px 12px 0 0; border: 1px solid var(--border); border-bottom: none; overflow: hidden; }
  .tab-btn { padding: 12px 24px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; background: transparent; color: var(--text-secondary); border-bottom: 2px solid transparent; transition: all 0.15s; }
  .tab-btn:hover { background: var(--gray-bg); }
  .tab-btn.active { color: var(--blue); border-bottom-color: var(--blue); background: white; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .tab-panel { background: white; border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; margin-bottom: 16px; }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .header { background: white; border-radius: 12px; padding: 24px; margin-bottom: 16px; border: 1px solid var(--border); }
  .header h1 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
  .header .meta { font-size: 13px; color: var(--text-secondary); font-family: var(--mono); }
  .header .meta a { color: var(--blue); text-decoration: none; }
  .stats { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
  .stat { background: var(--gray-bg); border-radius: 8px; padding: 6px 14px; font-size: 13px; font-weight: 500; }
  .stat .num { font-weight: 700; font-size: 15px; }
  .stat.green { background: var(--green-bg); color: #166534; }
  .stat.red { background: #fef2f2; color: #991b1b; }

  /* ‚îÄ‚îÄ Gate (removed ‚Äî readiness info lives in status badges) ‚îÄ‚îÄ */
  .gate .check-row { display: flex; justify-content: space-between; align-items: center; padding: 7px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
  .gate .check-row:last-child { border-bottom: none; }
  .badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
  .badge.pass { background: var(--green-bg); color: #166534; }
  .badge.fail { background: var(--red-bg); color: #991b1b; }

  /* ‚îÄ‚îÄ Sections ‚îÄ‚îÄ */
  .section { background: white; border-radius: 12px; margin-bottom: 16px; border: 1px solid var(--border); overflow: hidden; }
  .section-header { padding: 14px 24px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; transition: background 0.15s; }
  .section-header:hover { background: var(--gray-bg); }
  .section-header h2 { font-size: 14px; font-weight: 700; }
  .section-header .chevron { font-size: 16px; color: var(--text-secondary); transition: transform 0.2s; }
  .section.collapsed .section-body { display: none; }
  .section.collapsed .chevron { transform: rotate(-90deg); }
  .section-body { padding: 0 24px 20px; font-size: 13px; }

  /* ‚îÄ‚îÄ Architecture Diagram ‚îÄ‚îÄ */
  .arch-controls { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
  .arch-toggle { padding: 5px 14px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid var(--border); background: white; color: var(--text-secondary); }
  .arch-toggle.active { background: var(--blue); color: white; border-color: var(--blue); }
  .arch-hint { font-size: 11px; color: var(--text-muted); margin-left: 8px; }
  .zone-box { cursor: pointer; transition: opacity 0.3s, filter 0.3s; }
  .zone-box:hover { filter: brightness(0.95); }
  .zone-box.dimmed { opacity: 0.12; }
  .zone-box.highlighted { stroke-width: 3; filter: brightness(0.92); }
  .zone-label { font-size: 11px; font-weight: 600; pointer-events: none; }
  .zone-sublabel { font-size: 9px; fill: #6b7280; pointer-events: none; }
  .zone-file-count { font-size: 10px; font-weight: 700; fill: white; pointer-events: none; }
  .zone-count-bg { pointer-events: none; }
  .arch-row-label { font-size: 10px; font-weight: 700; fill: #9ca3af; text-transform: uppercase; letter-spacing: 1px; }

  /* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 8px 12px; background: var(--gray-bg); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-secondary); border-bottom: 2px solid var(--border); }
  td { padding: 8px 12px; border-bottom: 1px solid var(--border); vertical-align: top; }
  tr:last-child td { border-bottom: none; }
  tr.expandable { cursor: pointer; }
  tr.expandable:hover { background: var(--gray-bg); }
  tr.detail-row { display: none; }
  tr.detail-row.open { display: table-row; }
  tr.detail-row td { background: #fafbfc; padding: 12px 20px; }

  /* ‚îÄ‚îÄ Grade pills ‚îÄ‚îÄ */
  .grade { display: inline-block; width: 28px; height: 28px; line-height: 28px; text-align: center; border-radius: 6px; font-weight: 700; font-size: 12px; }
  .grade.a { background: var(--green-bg); color: #166534; }
  .grade.b { background: var(--yellow-bg); color: #854d0e; }
  .grade.c { background: var(--orange-bg); color: #9a3412; }
  .grade.f { background: var(--red-bg); color: #991b1b; }
  .grade.na { background: var(--gray-bg); color: var(--gray); }

  /* ‚îÄ‚îÄ Timing ‚îÄ‚îÄ */
  .time-label { font-family: var(--mono); font-size: 15px; font-weight: 700; }
  .time-label.normal { color: #166534; }
  .time-label.acceptable { color: #854d0e; }
  .time-label.watch { color: #f97316; }
  .time-label.refactor { color: #ef4444; }
  [data-theme="dark"] .time-label.normal { color: #34d399; }
  [data-theme="dark"] .time-label.acceptable { color: #fde047; }
  [data-theme="dark"] .time-label.watch { color: #fdba74; }
  [data-theme="dark"] .time-label.refactor { color: #fca5a5; }
  .time-health-sub { font-size: 10px; font-weight: 500; color: var(--text-muted); margin-top: 1px; }
  .health-tag { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; padding: 2px 8px; border-radius: 4px; }
  .health-tag.normal { background: var(--green-bg); color: #166534; }
  .health-tag.acceptable { background: var(--yellow-bg); color: #854d0e; }
  .health-tag.watch { background: var(--orange-bg); color: #9a3412; }
  .health-tag.refactor { background: var(--red-bg); color: #991b1b; }

  /* ‚îÄ‚îÄ Decision cards ‚îÄ‚îÄ */
  .decision-card { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
  .decision-header { padding: 12px 16px; cursor: pointer; display: flex; gap: 12px; align-items: flex-start; transition: background 0.15s; }
  .decision-header:hover { background: var(--gray-bg); }
  .decision-num { font-weight: 700; color: var(--blue); font-size: 14px; min-width: 24px; }
  .decision-title { font-weight: 600; font-size: 13px; }
  .decision-rationale { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
  .decision-body { display: none; padding: 0 16px 16px; border-top: 1px solid var(--border); }
  .decision-card.open .decision-body { display: block; }
  .decision-zones { display: flex; gap: 6px; flex-wrap: wrap; margin: 10px 0; }
  .zone-tag { font-size: 11px; padding: 2px 8px; border-radius: 4px; font-weight: 600; background: var(--blue-bg); color: #1d4ed8; }
  .decision-files { margin-top: 10px; }
  .decision-files table { font-size: 12px; }
  .decision-files td { padding: 4px 8px; }

  /* ‚îÄ‚îÄ Convergence ‚îÄ‚îÄ */
  .convergence-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .conv-card { border: 1px solid var(--border); border-radius: 8px; padding: 14px; cursor: pointer; transition: box-shadow 0.2s; }
  .conv-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .conv-card h4 { font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-secondary); margin-bottom: 8px; }
  .conv-status { font-size: 20px; font-weight: 700; }
  .conv-status.passing { color: #166534; }
  .conv-status.warning { color: #854d0e; }
  .conv-status.failing { color: #991b1b; }
  .conv-detail { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
  .conv-card-detail { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary); }
  .conv-card.open .conv-card-detail { display: block; }
  .conv-card-detail ul { margin: 4px 0 0 16px; list-style: disc; }
  .conv-card-detail li { margin-bottom: 2px; }

  /* ‚îÄ‚îÄ Post-merge ‚îÄ‚îÄ */
  .pm-item { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
  .pm-header { padding: 10px 16px; cursor: pointer; display: flex; gap: 10px; align-items: center; transition: background 0.15s; }
  .pm-header:hover { background: var(--gray-bg); }
  .pm-body { display: none; padding: 0 16px 16px; border-top: 1px solid var(--border); }
  .pm-item.open .pm-body { display: block; }
  .priority { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 4px; white-space: nowrap; }
  .priority.low { background: var(--blue-bg); color: #1d4ed8; }
  .priority.medium { background: var(--yellow-bg); color: #854d0e; }
  .priority.cosmetic { background: var(--gray-bg); color: var(--gray); }
  .code-block { background: #1e293b; color: #e2e8f0; padding: 12px 16px; border-radius: 6px; font-family: var(--mono); font-size: 12px; line-height: 1.6; overflow-x: auto; margin: 8px 0; white-space: pre; }
  .scenario-box { padding: 10px 14px; border-radius: 6px; margin: 6px 0; font-size: 12px; }
  .scenario-box.failure { background: var(--red-bg); border-left: 3px solid var(--red); }
  .scenario-box.success { background: var(--green-bg); border-left: 3px solid var(--green); }
  .scenario-label { font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px; }

  /* ‚îÄ‚îÄ Spec & Scenarios ‚îÄ‚îÄ */
  .spec-list { list-style: none; padding: 0; }
  .spec-list li { padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px; display: flex; gap: 8px; align-items: center; }
  .spec-list li:last-child { border-bottom: none; }
  .scenario-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
  .scenario-card { border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; font-size: 12px; cursor: pointer; transition: background 0.15s; }
  .scenario-card:hover { background: var(--gray-bg); }
  .scenario-card .name { font-weight: 600; }
  .scenario-card .status { font-size: 11px; margin-top: 2px; }
  .scenario-card-detail { display: none; margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border); font-size: 11px; color: var(--text-secondary); }
  .scenario-card.open .scenario-card-detail { display: block; }
  .scenario-card-detail dt { font-weight: 600; color: var(--text); margin-top: 4px; }
  .scenario-card-detail dd { margin-left: 0; margin-bottom: 2px; }
  .scenario-category { display: inline-block; padding: 1px 7px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-left: 6px; }
  .scenario-category.cat-environment { background: #dcfce7; color: #166534; }
  .scenario-category.cat-training { background: #dbeafe; color: #1d4ed8; }
  .scenario-category.cat-pipeline { background: #f3e8ff; color: #6d28d9; }
  .scenario-category.cat-integration { background: #fff7ed; color: #9a3412; }
  [data-theme="dark"] .scenario-category.cat-environment { background: #064e3b; color: #6ee7b7; }
  [data-theme="dark"] .scenario-category.cat-training { background: #1e3a5f; color: #93c5fd; }
  [data-theme="dark"] .scenario-category.cat-pipeline { background: #2e1065; color: #c4b5fd; }
  [data-theme="dark"] .scenario-category.cat-integration { background: #7c2d12; color: #fdba74; }
  .scenario-legend { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 10px; font-size: 11px; color: var(--text-secondary); }
  .scenario-card.zone-dimmed { opacity: 0.35; }
  .scenario-card.zone-glow { box-shadow: 0 0 0 2px var(--blue); }

  /* ‚îÄ‚îÄ Factory History ‚îÄ‚îÄ */
  .history-timeline { position: relative; padding-left: 24px; }
  .history-timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: var(--border); }
  .history-event { position: relative; margin-bottom: 16px; padding: 12px 16px; background: white; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: box-shadow 0.2s; }
  .history-event:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  .history-event::before { content: ''; position: absolute; left: -20px; top: 16px; width: 10px; height: 10px; border-radius: 50%; background: var(--blue); border: 2px solid white; }
  .history-event.intervention::before { background: var(--orange); }
  .history-event .event-title { font-weight: 600; font-size: 13px; }
  .history-event .event-detail { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
  .history-event .event-meta { font-size: 11px; color: var(--text-muted); margin-top: 4px; font-family: var(--mono); }
  .history-event-detail { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary); }
  .history-event.open .history-event-detail { display: block; }
  .event-agent { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; background: var(--blue-bg); color: #1d4ed8; margin-left: 4px; }
  .event-agent.human { background: var(--orange-bg); color: #9a3412; }
  .history-legend { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 16px; padding: 10px 14px; background: var(--gray-bg); border-radius: 6px; font-size: 11px; color: var(--text-secondary); }
  .history-legend-item { display: flex; align-items: center; gap: 6px; }
  .history-legend-dot { width: 10px; height: 10px; border-radius: 50%; }

  /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
  .footer { text-align: center; padding: 16px; font-size: 11px; color: var(--text-muted); }

  /* ‚îÄ‚îÄ Zone tag color variants ‚îÄ‚îÄ */
  .zone-tag.factory { background: var(--blue-bg); color: #1d4ed8; }
  .zone-tag.product { background: #dcfce7; color: #166534; }
  .zone-tag.infra { background: var(--purple-bg); color: #6d28d9; }

  /* ‚îÄ‚îÄ Architecture legend ‚îÄ‚îÄ */
  .arch-legend { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 10px; padding: 10px 14px; background: var(--gray-bg); border-radius: 6px; font-size: 11px; color: var(--text-secondary); }
  .arch-legend-item { display: flex; align-items: center; gap: 6px; }
  .arch-legend-swatch { width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.1); }
  .arch-legend-circle { width: 14px; height: 14px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 700; color: white; }

  /* ‚îÄ‚îÄ What Changed zone detail blocks ‚îÄ‚îÄ */
  .wc-zone-detail { display: none; padding: 8px 0; }
  .wc-zone-detail.active { display: block; }
  .wc-zone-detail h4 { font-size: 13px; font-weight: 700; margin-bottom: 6px; }

  /* ‚îÄ‚îÄ Adversarial review enhancements ‚îÄ‚îÄ */
  .adv-scroll { max-height: 500px; overflow-y: auto; }
  .adv-row { cursor: pointer; transition: max-height 0.3s ease, opacity 0.3s ease; }
  .adv-row:hover { background: var(--gray-bg); }
  .adv-row.collapsed-row { max-height: 24px; opacity: 0.5; overflow: hidden; }
  .adv-no-match { display: none; padding: 16px; text-align: center; color: var(--text-muted); font-size: 13px; font-style: italic; }
  .adv-no-match.visible { display: block; }
  .adv-detail-row { display: none; }
  .adv-detail-row.open { display: table-row; }
  .adv-detail-row td { background: #fafbfc; padding: 12px 20px; font-size: 12px; border-bottom: 1px solid var(--border); }

  /* ‚îÄ‚îÄ CI sub-check drill-down ‚îÄ‚îÄ */
  .ci-check-item { padding: 6px 0; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }
  .ci-check-item:last-child { border-bottom: none; }
  .ci-check-item:hover { background: #f0f4f8; }
  .ci-check-summary { font-size: 12px; display: flex; align-items: center; gap: 6px; }
  .ci-check-summary .chevron-sm { font-size: 10px; color: var(--text-muted); transition: transform 0.2s; display: inline-block; }
  .ci-check-item.open .chevron-sm { transform: rotate(90deg); }
  .ci-check-detail { display: none; padding: 6px 0 4px 20px; font-size: 11px; color: var(--text-secondary); }
  .ci-check-item.open .ci-check-detail { display: block; }

  /* ‚îÄ‚îÄ Floating architecture diagram ‚îÄ‚îÄ */
  .arch-floating { position: fixed; top: 16px; right: 16px; width: 40%; max-width: 480px; z-index: 100; background: rgba(255,255,255,0.95); border-radius: 10px; border: 1px solid var(--border); box-shadow: 0 8px 32px rgba(0,0,0,0.12); padding: 10px; transition: opacity 0.3s ease, transform 0.3s ease; opacity: 0; transform: translateX(40px); pointer-events: none; }
  .arch-floating.visible { opacity: 1; transform: translateX(0); pointer-events: auto; }
  .arch-floating svg { width: 100%; height: auto; }
  .arch-floating-close { position: absolute; top: 6px; right: 10px; background: none; border: none; font-size: 16px; cursor: pointer; color: var(--text-muted); z-index: 101; padding: 2px 6px; border-radius: 4px; }
  .arch-floating-close:hover { background: var(--gray-bg); color: var(--text); }

  /* ‚îÄ‚îÄ File path modal ‚îÄ‚îÄ */
  .file-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.45); z-index: 200; justify-content: center; align-items: center; }
  .file-modal-overlay.visible { display: flex; }
  .file-modal { background: #1e1e1e; border-radius: 10px; width: 95vw; max-width: 1400px; height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.4); display: flex; flex-direction: column; }
  .file-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: #2d2d2d; border-bottom: 1px solid #404040; flex-shrink: 0; }
  .file-modal-header h3 { font-size: 13px; font-family: var(--mono); font-weight: 500; color: #cccccc; }
  .file-modal-header .fm-stats { font-size: 11px; font-family: var(--mono); margin-left: 12px; }
  .file-modal-header .fm-stats .fm-add { color: #3fb950; }
  .file-modal-header .fm-stats .fm-del { color: #f85149; }
  .file-modal-close { background: none; border: none; font-size: 18px; cursor: pointer; color: #808080; padding: 2px 8px; border-radius: 4px; }
  .file-modal-close:hover { background: #404040; color: #cccccc; }
  .file-modal-toolbar { display: flex; justify-content: space-between; align-items: center; padding: 6px 16px; background: #252526; border-bottom: 1px solid #404040; flex-shrink: 0; }
  .file-modal-tabs { display: flex; gap: 0; }
  .file-modal-tab { padding: 6px 14px; font-size: 11px; font-weight: 600; cursor: pointer; border: none; background: none; color: #808080; border-bottom: 2px solid transparent; border-radius: 4px 4px 0 0; }
  .file-modal-tab:hover { color: #cccccc; background: #2d2d2d; }
  .file-modal-tab.active { color: #ffffff; border-bottom-color: var(--blue); background: #1e1e1e; }
  .file-modal-github { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: #2d2d2d; border: 1px solid #404040; border-radius: 4px; color: #cccccc; text-decoration: none; font-size: 11px; font-weight: 500; }
  .file-modal-github:hover { background: #404040; color: white; }
  .file-modal-body { flex: 1; overflow: auto; background: #1e1e1e; }

  /* ‚îÄ‚îÄ Diff rendering ‚îÄ‚îÄ */
  .diff-view { font-family: var(--mono); font-size: 12px; line-height: 1.55; }
  .diff-unified { width: 100%; border-collapse: collapse; }
  .diff-unified td { padding: 0 12px; white-space: pre-wrap; word-break: break-all; vertical-align: top; border: none; }
  .diff-new-file-banner { padding: 8px 16px; background: rgba(63,185,80,0.1); color: #3fb950; font-size: 12px; font-weight: 500; border-bottom: 1px solid #333333; }
  .diff-deleted-file-banner { padding: 8px 16px; background: rgba(248,81,73,0.1); color: #f85149; font-size: 12px; font-weight: 500; border-bottom: 1px solid #333333; }
  .diff-unified .diff-ln { width: 50px; min-width: 50px; text-align: right; color: #636363; user-select: none; padding-right: 8px; font-size: 11px; border-right: 1px solid #333333; }
  .diff-unified .diff-add { background: rgba(63,185,80,0.15); color: #3fb950; }
  .diff-unified .diff-del { background: rgba(248,81,73,0.15); color: #f85149; }
  .diff-unified .diff-ctx { color: #cccccc; }
  .diff-unified .diff-hunk { background: rgba(56,139,253,0.12); color: #58a6ff; padding: 6px 12px; font-style: italic; }
  .diff-split { width: 100%; border-collapse: collapse; }
  .diff-split td { padding: 0 6px; white-space: pre; vertical-align: top; border: none; font-family: var(--mono); font-size: 12px; line-height: 1.55; }
  .diff-split-wrapper { overflow-x: auto; }
  .diff-split .diff-ln { width: 40px; min-width: 40px; text-align: right; color: #636363; user-select: none; padding-right: 6px; font-size: 11px; }
  .diff-split .diff-sep { width: 2px; min-width: 2px; background: #2d2d2d; padding: 0; }
  .diff-split .diff-code-left, .diff-split .diff-code-right { min-width: 0; max-width: 50vw; white-space: pre; overflow-x: auto; }
  .diff-split .diff-add { background: rgba(63,185,80,0.15); color: #3fb950; }
  .diff-split .diff-del { background: rgba(248,81,73,0.15); color: #f85149; }
  .diff-split .diff-ctx { color: #cccccc; }
  .diff-split .diff-empty { background: #161616; }
  .diff-split .diff-hunk td { background: rgba(56,139,253,0.08); color: #58a6ff; font-style: italic; padding: 4px 8px; }
  .diff-raw { color: #cccccc; }
  .diff-raw table { width: 100%; border-collapse: collapse; }
  .diff-raw td { padding: 0 12px; white-space: pre-wrap; word-break: break-all; vertical-align: top; border: none; font-family: var(--mono); font-size: 12px; line-height: 1.55; }
  .diff-raw .diff-ln { width: 50px; min-width: 50px; text-align: right; color: #636363; user-select: none; padding-right: 8px; font-size: 11px; border-right: 1px solid #333333; }
  .diff-loading { color: #808080; text-align: center; padding: 60px 20px; font-size: 13px; }
  .diff-error { color: #f85149; text-align: center; padding: 40px 20px; font-size: 13px; }
  .file-path-link { color: inherit; text-decoration: none; border-bottom: 1px dashed var(--text-muted); cursor: pointer; transition: border-color 0.15s; }
  .file-path-link:hover { border-bottom-color: var(--blue); color: var(--blue); }

  /* ‚îÄ‚îÄ CI Chevron rotation ‚îÄ‚îÄ */
  .ci-chevron { display: inline-block; transition: transform 0.2s; }
  tr.expandable.ci-open .ci-chevron { transform: rotate(180deg); }

  /* ‚îÄ‚îÄ Status badges ‚îÄ‚îÄ */
  .status-row { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
  .status-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; }
  .status-badge.pass { background: var(--green-bg); color: #166534; }
  .status-badge.info { background: var(--blue-bg); color: #1d4ed8; }
  .status-badge.warn { background: var(--yellow-bg); color: #854d0e; }
  .status-badge.fail { background: #fef2f2; color: #991b1b; }
  .gate-popover { display: none; position: absolute; background: white; border: 1px solid var(--border); border-radius: 6px; padding: 10px 14px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); font-size: 12px; z-index: 50; max-width: 300px; }
  .gate-popover.visible { display: block; }
  .gate-clickable { cursor: pointer; border-bottom: 1px dashed var(--text-muted); }
  .gate-clickable:hover { color: var(--blue); border-bottom-color: var(--blue); }
  .unverified-flag { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 9px; font-weight: 700; background: var(--orange-bg); color: #9a3412; margin-left: 6px; text-transform: uppercase; }

  @media (max-width: 768px) {
    .stats { flex-direction: column; gap: 8px; }
    .convergence-grid { grid-template-columns: 1fr; }
    .scenario-grid { grid-template-columns: 1fr; }
    .container { padding: 12px 8px; }
    .arch-floating { width: 60%; }
    .file-modal { width: 98vw; height: 95vh; }
  }
</style>
</head>
<body>
<div class="container">

  <!-- ‚ïê‚ïê DATA INJECTION POINT ‚ïê‚ïê -->
  <!-- The rendering script injects the ReviewPackData JSON here -->

  <!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
  <div class="header">
    <h1 id="pr-title">PR #6: [Factory] df-crank-v01 converged at 100%</h1>
    <div class="meta">
      <a id="pr-url" href="https://github.com/joeyfezster/building_ai_w_ai/pull/6" target="_blank">https://github.com/joeyfezster/building_ai_w_ai/pull/6</a><br>
      <span id="pr-branch-info">df-crank-v01-eval-videos &rarr; main</span>
      &nbsp;|&nbsp; HEAD: <code id="pr-sha">bce032a</code>
    </div>
    <div class="stats" id="pr-stats">
      <span class="stat green"><span class="num">+16</span> additions</span>
      <span class="stat red"><span class="num">&minus;2</span> deletions</span>
      <span class="stat"><span class="num">2</span> files</span>
      <span class="stat"><span class="num">2</span> commits</span>
    </div>
    <div class="status-row" id="pr-status-row">
      <span class="status-badge pass">‚úì CI 5/5</span>
      <span class="status-badge pass">‚úì 12/12 Scenarios</span>
      <span class="status-badge info">‚ö† Gate 2: 1 warn</span>
      <span class="status-badge pass">‚úì 1/1 comments resolved</span>
      <div class="theme-toggle" style="margin-left:auto">
        <button onclick="setTheme('light')" title="Light theme" data-theme-btn="light">&#x2600;</button>
        <button onclick="setTheme('dark')" title="Dark theme" data-theme-btn="dark">&#x1F319;</button>
        <button onclick="setTheme('system')" title="System theme" data-theme-btn="system">&#x2699;</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê TAB BAR ‚ïê‚ïê -->
  <div class="tab-bar" id="tab-bar">
    <button class="tab-btn active" onclick="switchTab('review')">Review</button>
    <button class="tab-btn" onclick="switchTab('history')">Factory History</button>
  </div>

  <!-- ‚ïê‚ïê TAB 1: REVIEW ‚ïê‚ïê -->
  <div id="tab-review" class="tab-content active">
    <div class="tab-panel" style="padding:20px 24px">

    <!-- Section: Architecture -->
    <div class="section" style="border:none;margin-bottom:0">
      <div class="section-header" onclick="this.parentElement.classList.toggle('collapsed')">
        <h2>Architecture</h2>
        <span class="chevron">&#x25BC;</span>
      </div>
      <div class="section-body">
        <div class="arch-controls">
          <button class="arch-toggle active" onclick="setArchView('update',this)">Update (this PR)</button>
          <button class="arch-toggle" onclick="setArchView('baseline',this)">Baseline (before merge)</button>
          <span class="arch-hint">Click a zone to filter findings &bull; Click background to reset</span>
        </div>
        <svg id="arch-diagram" viewBox="0 0 780 360" style="width:100%;max-width:780px;background:#fafbfc;border-radius:8px;border:1px solid var(--border)">
          <defs><marker id="arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6 Z" fill="#9ca3af"/></marker></defs>
          <text x="720" y="60" text-anchor="end" class="arch-row-label">Factory</text>
          <text x="720" y="170" text-anchor="end" class="arch-row-label">Product</text>
          <text x="720" y="280" text-anchor="end" class="arch-row-label">Infra</text>
          <rect class="zone-box" data-zone="factory" x="20" y="20" width="120" height="80" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5" style="cursor:pointer;opacity:0.6"/>
          <text x="80.0" y="56.0" text-anchor="middle" class="zone-label" fill="#1d4ed8" style="pointer-events:none">Factory</text>
          <text x="80.0" y="70.0" text-anchor="middle" class="zone-sublabel" style="pointer-events:none">Convergence loop</text>
          <rect class="zone-box" data-zone="environment" x="20" y="130" width="120" height="80" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5" style="cursor:pointer;opacity:0.6"/>
          <text x="80.0" y="166.0" text-anchor="middle" class="zone-label" fill="#166534" style="pointer-events:none">Environment</text>
          <text x="80.0" y="180.0" text-anchor="middle" class="zone-sublabel" style="pointer-events:none">MiniPong env</text>
          <rect class="zone-box" data-zone="rl-core" x="160" y="130" width="120" height="80" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5" style="cursor:pointer;opacity:0.6"/>
          <text x="220.0" y="166.0" text-anchor="middle" class="zone-label" fill="#166534" style="pointer-events:none">RL Core</text>
          <text x="220.0" y="180.0" text-anchor="middle" class="zone-sublabel" style="pointer-events:none">DQN components</text>
          <rect class="zone-box" data-zone="agent" x="300" y="130" width="120" height="80" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5" style="cursor:pointer;opacity:0.6"/>
          <text x="360.0" y="166.0" text-anchor="middle" class="zone-label" fill="#166534" style="pointer-events:none">Agent</text>
          <text x="360.0" y="180.0" text-anchor="middle" class="zone-sublabel" style="pointer-events:none">DQN agent</text>
          <rect class="zone-box" data-zone="training" x="440" y="130" width="120" height="80" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5" style="cursor:pointer;opacity:1"/>
          <text x="500.0" y="166.0" text-anchor="middle" class="zone-label" fill="#166534" style="pointer-events:none">Training</text>
          <text x="500.0" y="180.0" text-anchor="middle" class="zone-sublabel" style="pointer-events:none">Pipeline, eval, video</text>
          <circle class="zone-count-bg" cx="552" cy="138" r="10" fill="#22c55e"/>
          <text class="zone-file-count" x="552" y="142" text-anchor="middle" fill="white" style="pointer-events:none">2</text>
          <rect class="zone-box" data-zone="observability" x="580" y="130" width="120" height="80" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5" style="cursor:pointer;opacity:0.6"/>
          <text x="640.0" y="166.0" text-anchor="middle" class="zone-label" fill="#166534" style="pointer-events:none">Observability</text>
          <text x="640.0" y="180.0" text-anchor="middle" class="zone-sublabel" style="pointer-events:none">Logging, metrics</text>
          <rect class="zone-box" data-zone="dashboard" x="20" y="240" width="120" height="80" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5" style="cursor:pointer;opacity:0.6"/>
          <text x="80.0" y="276.0" text-anchor="middle" class="zone-label" fill="#166534" style="pointer-events:none">Dashboard</text>
          <text x="80.0" y="290.0" text-anchor="middle" class="zone-sublabel" style="pointer-events:none">Streamlit app</text>
          <rect class="zone-box" data-zone="tests" x="160" y="240" width="120" height="80" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5" style="cursor:pointer;opacity:0.6"/>
          <text x="220.0" y="276.0" text-anchor="middle" class="zone-label" fill="#166534" style="pointer-events:none">Tests</text>
          <text x="220.0" y="290.0" text-anchor="middle" class="zone-sublabel" style="pointer-events:none">pytest suite</text>
          <rect class="zone-box" data-zone="config" x="300" y="240" width="120" height="80" rx="8" fill="#f3e8ff" stroke="#8b5cf6" stroke-width="1.5" style="cursor:pointer;opacity:0.6"/>
          <text x="360.0" y="276.0" text-anchor="middle" class="zone-label" fill="#6d28d9" style="pointer-events:none">Config</text>
          <text x="360.0" y="290.0" text-anchor="middle" class="zone-sublabel" style="pointer-events:none">Build, deps</text>
          <rect class="zone-box" data-zone="docker" x="440" y="240" width="120" height="80" rx="8" fill="#f3e8ff" stroke="#8b5cf6" stroke-width="1.5" style="cursor:pointer;opacity:0.6"/>
          <text x="500.0" y="276.0" text-anchor="middle" class="zone-label" fill="#6d28d9" style="pointer-events:none">Docker/Infra</text>
          <text x="500.0" y="290.0" text-anchor="middle" class="zone-sublabel" style="pointer-events:none">Containers</text>
          <line x1="80" y1="100" x2="80" y2="130" stroke="#9ca3af" stroke-width="1.5" marker-end="url(#arrowhead)"/>
          <line x1="80" y1="210" x2="160" y2="170" stroke="#9ca3af" stroke-width="1.5" marker-end="url(#arrowhead)"/>
          <line x1="280" y1="170" x2="300" y2="170" stroke="#9ca3af" stroke-width="1.5" marker-end="url(#arrowhead)"/>
          <line x1="420" y1="170" x2="440" y2="170" stroke="#9ca3af" stroke-width="1.5" marker-end="url(#arrowhead)"/>
          <line x1="560" y1="170" x2="580" y2="170" stroke="#9ca3af" stroke-width="1.5" marker-end="url(#arrowhead)"/>
          
          
          
          
          
          
        </svg>
        <div id="zone-filter-info" style="margin-top:8px;font-size:12px;color:var(--blue);font-weight:600;display:none"></div>
        <div class="arch-legend">
          <div class="arch-legend-item"><div class="arch-legend-circle" style="background:#3b82f6">3</div> Blue circle = files changed in zone</div>
          <div class="arch-legend-item"><div class="arch-legend-swatch" style="background:#dbeafe;border-color:#3b82f6"></div> Factory infrastructure</div>
          <div class="arch-legend-item"><div class="arch-legend-swatch" style="background:#dcfce7;border-color:#22c55e"></div> Product code</div>
          <div class="arch-legend-item"><div class="arch-legend-swatch" style="background:#f3e8ff;border-color:#8b5cf6"></div> Infrastructure &amp; docs</div>
          <div class="arch-legend-item" style="margin-left:auto;font-style:italic">Click zone to filter &bull; click background to reset</div>
        </div>
      </div>
    </div>

    </div><!-- end tab-panel -->

    <!-- Section: Spec & Scenarios -->
    <div class="section">
      <div class="section-header" onclick="this.parentElement.classList.toggle('collapsed')">
        <h2>Spec &amp; Scenarios</h2>
        <span class="chevron">&#x25BC;</span>
      </div>
      <div class="section-body">
        <h3 style="font-size:13px;margin-bottom:8px">Specifications</h3>
        <ul class="spec-list" id="spec-list">
          <li>üéØ <code class="file-path-link" onclick="openFileModal('specs/training.md')">specs/training.md</code> &mdash; Training pipeline: entry point, artifact outputs, evaluation loop</li>
          <li>üèÜ <code class="file-path-link" onclick="openFileModal('specs/proof.md')">specs/proof.md</code> &mdash; Learning &amp;amp; video proof: verification command, video recording points</li>
        </ul>
        <h3 style="font-size:13px;margin:14px 0 8px">Scenarios</h3>
        <div class="scenario-legend" id="scenario-legend">
          <span class="scenario-category cat-environment">environment</span> <span class="scenario-category cat-integration">integration</span> <span class="scenario-category cat-pipeline">pipeline</span> <span class="scenario-category cat-training">training</span>
        </div>
        <div class="scenario-grid" id="scenario-grid">
          <div class="scenario-card" data-zone="environment" onclick="this.classList.toggle('open')">
  <div class="name">Environment Determinism
    <span class="scenario-category cat-environment">environment</span>
  </div>
  <div class="status" style="color:var(--green)">&#x2713; Passing</div>
  <div class="scenario-card-detail">
    <dl>
      <dt>What</dt><dd>Same seed produces identical observations and rewards</dd>
      <dt>How</dt><dd>Reset two envs with same seed, compare 10 steps</dd>
      <dt>Result</dt><dd>PASS: determinism verified for 3 seeds</dd>
    </dl>
  </div>
</div>
          <div class="scenario-card" data-zone="environment" onclick="this.classList.toggle('open')">
  <div class="name">Environment Observation Space
    <span class="scenario-category cat-environment">environment</span>
  </div>
  <div class="status" style="color:var(--green)">&#x2713; Passing</div>
  <div class="scenario-card-detail">
    <dl>
      <dt>What</dt><dd>Observations are uint8 84x84 arrays</dd>
      <dt>How</dt><dd>Check dtype, shape, and value range after reset and step</dd>
      <dt>Result</dt><dd>PASS: observations are uint8 (84, 84, 1)</dd>
    </dl>
  </div>
</div>
          <div class="scenario-card" data-zone="environment" onclick="this.classList.toggle('open')">
  <div class="name">Environment Reward Structure
    <span class="scenario-category cat-environment">environment</span>
  </div>
  <div class="status" style="color:var(--green)">&#x2713; Passing</div>
  <div class="scenario-card-detail">
    <dl>
      <dt>What</dt><dd>+1/-1 rewards observed, scores in info dict</dd>
      <dt>How</dt><dd>Run random episode, check reward values and info keys</dd>
      <dt>Result</dt><dd>PASS: rewards correct with agent/opponent scores</dd>
    </dl>
  </div>
</div>
          <div class="scenario-card" data-zone="environment" onclick="this.classList.toggle('open')">
  <div class="name">Environment Rendering
    <span class="scenario-category cat-environment">environment</span>
  </div>
  <div class="status" style="color:var(--green)">&#x2713; Passing</div>
  <div class="scenario-card-detail">
    <dl>
      <dt>What</dt><dd>render() returns uint8 RGB frames</dd>
      <dt>How</dt><dd>Create env with render_mode=rgb_array, check frame properties</dd>
      <dt>Result</dt><dd>PASS: rendering works, non-black frames</dd>
    </dl>
  </div>
</div>
          <div class="scenario-card" data-zone="environment" onclick="this.classList.toggle('open')">
  <div class="name">Environment Info Dict
    <span class="scenario-category cat-environment">environment</span>
  </div>
  <div class="status" style="color:var(--green)">&#x2713; Passing</div>
  <div class="scenario-card-detail">
    <dl>
      <dt>What</dt><dd>Info dict contains all 6 required keys</dd>
      <dt>How</dt><dd>Check rally_length, hits, misses, agent_score, opponent_score, episode_reason in reset and step</dd>
      <dt>Result</dt><dd>PASS: all required keys present</dd>
    </dl>
  </div>
</div>
          <div class="scenario-card" data-zone="training" onclick="this.classList.toggle('open')">
  <div class="name">Training Artifacts
    <span class="scenario-category cat-training">training</span>
  </div>
  <div class="status" style="color:var(--green)">&#x2713; Passing</div>
  <div class="scenario-card-detail">
    <dl>
      <dt>What</dt><dd>Training produces tensorboard, JSONL, checkpoints, eval metrics</dd>
      <dt>How</dt><dd>Run train_dqn with test config, check artifact directories</dd>
      <dt>Result</dt><dd>PASS: all 4 artifact types present</dd>
    </dl>
  </div>
</div>
          <div class="scenario-card" data-zone="training" onclick="this.classList.toggle('open')">
  <div class="name">Evaluation Videos
    <span class="scenario-category cat-training">training</span>
  </div>
  <div class="status" style="color:var(--green)">&#x2713; Passing</div>
  <div class="scenario-card-detail">
    <dl>
      <dt>What</dt><dd>Training produces MP4 evaluation videos</dd>
      <dt>How</dt><dd>Run train_dqn, check for non-trivial MP4 files in videos/</dd>
      <dt>Result</dt><dd>PASS: evaluation videos produced (was FAIL before this PR)</dd>
    </dl>
  </div>
</div>
          <div class="scenario-card" data-zone="training" onclick="this.classList.toggle('open')">
  <div class="name">verify-learning Command
    <span class="scenario-category cat-pipeline">pipeline</span>
  </div>
  <div class="status" style="color:var(--green)">&#x2713; Passing</div>
  <div class="scenario-card-detail">
    <dl>
      <dt>What</dt><dd>verify_learning runs without errors</dd>
      <dt>How</dt><dd>Train then run verify_learning with relaxed thresholds</dd>
      <dt>Result</dt><dd>PASS: command runs successfully</dd>
    </dl>
  </div>
</div>
          <div class="scenario-card" data-zone="dashboard" onclick="this.classList.toggle('open')">
  <div class="name">Dashboard Loads
    <span class="scenario-category cat-environment">environment</span>
  </div>
  <div class="status" style="color:var(--green)">&#x2713; Passing</div>
  <div class="scenario-card-detail">
    <dl>
      <dt>What</dt><dd>Dashboard module is importable</dd>
      <dt>How</dt><dd>Import src/dashboard/app.py via importlib</dd>
      <dt>Result</dt><dd>PASS: dashboard module importable</dd>
    </dl>
  </div>
</div>
          <div class="scenario-card" data-zone="environment config" onclick="this.classList.toggle('open')">
  <div class="name">env-smoke Makefile Target
    <span class="scenario-category cat-integration">integration</span>
  </div>
  <div class="status" style="color:var(--green)">&#x2713; Passing</div>
  <div class="scenario-card-detail">
    <dl>
      <dt>What</dt><dd>make env-smoke runs successfully</dd>
      <dt>How</dt><dd>Run make env-smoke and check exit code</dd>
      <dt>Result</dt><dd>PASS: env-smoke exits 0</dd>
    </dl>
  </div>
</div>
          <div class="scenario-card" data-zone="config" onclick="this.classList.toggle('open')">
  <div class="name">Lint and Typecheck
    <span class="scenario-category cat-integration">integration</span>
  </div>
  <div class="status" style="color:var(--green)">&#x2713; Passing</div>
  <div class="scenario-card-detail">
    <dl>
      <dt>What</dt><dd>make lint and make typecheck both pass</dd>
      <dt>How</dt><dd>Run both targets and check exit codes</dd>
      <dt>Result</dt><dd>PASS: ruff and mypy clean</dd>
    </dl>
  </div>
</div>
          <div class="scenario-card" data-zone="training" onclick="this.classList.toggle('open')">
  <div class="name">Full CPU Pipeline
    <span class="scenario-category cat-integration">integration</span>
  </div>
  <div class="status" style="color:var(--green)">&#x2713; Passing</div>
  <div class="scenario-card-detail">
    <dl>
      <dt>What</dt><dd>End-to-end train + evaluate + verify chain completes</dd>
      <dt>How</dt><dd>Run all three commands sequentially</dd>
      <dt>Result</dt><dd>PASS: full pipeline completes</dd>
    </dl>
  </div>
</div>
        </div>
      </div>
    </div>

    <!-- Section: What Changed -->
    <div class="section">
      <div class="section-header" onclick="this.parentElement.classList.toggle('collapsed')">
        <h2>What Changed</h2>
        <span class="chevron">&#x25BC;</span>
      </div>
      <div class="section-body" id="what-changed-body">
        <p style="margin-bottom:4px;font-size:11px;color:var(--text-muted)">Generated from <code>git diff</code> by delegated diff-reading agent. Code diffs are ground truth.</p>
        <div class="wc-default" id="wc-default">
          <p><strong>Infrastructure:</strong> No infrastructure changes in this PR.</p>
          <p><strong>Product:</strong> Wired the existing <code>record_video()</code> function into the training evaluation loop. Each evaluation checkpoint now produces an MP4 video at <code>artifacts/{run_id}/videos/eval_step_{step}.mp4</code>. Also parameterized <code>frame_stack</code> in <code>record_video()</code> to match the training config instead of hardcoding 4.</p>
        </div>
        <div class="wc-zone-detail" data-zone="training">
  <h4>Training Pipeline</h4>
  <p><strong>train_dqn.py:</strong> Added import of <code>record_video</code> and a call after each evaluation checkpoint. Videos are recorded using the first eval seed and the training config's frame_stack setting.<br><br><strong>record_video.py:</strong> Added <code>frame_stack</code> parameter (default 4 for backward compatibility). The environment wrapper now uses this parameter instead of a hardcoded value, preventing shape mismatches when loading checkpoints trained with different frame_stack values.</p>
</div>
      </div>
    </div>

    <!-- Section: Adversarial Review -->
    <div class="section">
      <div class="section-header" onclick="this.parentElement.classList.toggle('collapsed')">
        <h2 id="adv-header">Adversarial Review</h2>
        <span class="chevron">&#x25BC;</span>
      </div>
      <div class="section-body">
        <div class="adv-scroll">
        <div id="adv-no-match" class="adv-no-match">No adversarial findings in this zone.</div>
        <table id="adv-table">
          <thead><tr><th>File</th><th>Grade</th><th>Zone</th><th>Notable</th></tr></thead>
          <tbody>
            <tr class="adv-row" data-zones="training" data-grade-sort="3" onclick="toggleAdvDetail(this)">
  <td><code class="file-path-link" onclick="event.stopPropagation();openFileModal('src/train/train_dqn.py')">src/train/train_dqn.py</code></td>
  <td><span class="grade a">A</span></td>
  <td><span class="zone-tag product">training</span></td>
  <td>Clean integration ‚Äî import + call at the right place</td>
</tr>
<tr class="adv-detail-row" data-zones="training">
  <td colspan="4">The <code>record_video()</code> call is placed inside the existing evaluation block, after checkpoint save and metrics evaluation. It correctly passes <code>frame_stack</code> from config and uses the first eval seed. No architectural concerns. The inline <code>import torch</code> at line 83 is pre-existing and not introduced by this PR.</td>
</tr>
            <tr class="adv-row" data-zones="training" data-grade-sort="3" onclick="toggleAdvDetail(this)">
  <td><code class="file-path-link" onclick="event.stopPropagation();openFileModal('src/train/record_video.py')">src/train/record_video.py</code></td>
  <td><span class="grade a">A</span></td>
  <td><span class="zone-tag product">training</span></td>
  <td>Backward-compatible parameter addition</td>
</tr>
<tr class="adv-detail-row" data-zones="training">
  <td colspan="4">New <code>frame_stack</code> parameter has default value of 4, maintaining backward compatibility with existing callers (CLI entry point doesn't pass it). The function signature change is minimal and correct.</td>
</tr>
            
          </tbody>
        </table>
        </div>
      </div>
    </div>

    <!-- Section: CI Performance -->
    <div class="section">
      <div class="section-header" onclick="this.parentElement.classList.toggle('collapsed')">
        <h2>CI Performance</h2>
        <span class="chevron">&#x25BC;</span>
      </div>
      <div class="section-body">
        <table>
          <thead><tr><th>Check</th><th>Status</th><th>Time</th><th></th></tr></thead>
          <tbody id="ci-table-body">
            <tr class="expandable" onclick="toggleCIDetail(this)">
  <td><strong>factory-self-test</strong> <small style="color:var(--text-muted)">(push)</small></td>
  <td><span class="badge pass">pass</span></td>
  <td><span class="time-label normal">16s</span><br><span class="time-health-sub">normal</span></td>
  <td class="ci-chevron">&#x25BC;</td>
</tr>
<tr class="detail-row">
  <td colspan="4">
    <p><strong>Coverage:</strong> Factory script validation</p>
    <p><strong>Gates:</strong> Factory infrastructure integrity</p>
    <div class="ci-check-item" onclick="event.stopPropagation();this.classList.toggle('open')">
  <div class="ci-check-summary"><span class="ci-sub-chevron">&#x25B6;</span> Lint factory scripts</div>
  <div class="ci-check-detail">Validates factory Python scripts pass ruff</div>
</div>
<div class="ci-check-item" onclick="event.stopPropagation();this.classList.toggle('open')">
  <div class="ci-check-summary"><span class="ci-sub-chevron">&#x25B6;</span> Scenario runner smoke</div>
  <div class="ci-check-detail">Verifies run_scenarios.py and compile_feedback.py are importable</div>
</div>
    <div style="margin-top:6px">Zones: <span class="zone-tag product">factory</span></div>
    
  </td>
</tr>
            <tr class="expandable" onclick="toggleCIDetail(this)">
  <td><strong>factory-self-test</strong> <small style="color:var(--text-muted)">(PR)</small></td>
  <td><span class="badge pass">pass</span></td>
  <td><span class="time-label normal">17s</span><br><span class="time-health-sub">normal</span></td>
  <td class="ci-chevron">&#x25BC;</td>
</tr>
<tr class="detail-row">
  <td colspan="4">
    <p><strong>Coverage:</strong> Factory script validation (PR context)</p>
    <p><strong>Gates:</strong> Factory infrastructure integrity</p>
    <div class="ci-check-item" onclick="event.stopPropagation();this.classList.toggle('open')">
  <div class="ci-check-summary"><span class="ci-sub-chevron">&#x25B6;</span> Lint factory scripts</div>
  <div class="ci-check-detail">Validates factory Python scripts pass ruff</div>
</div>
    <div style="margin-top:6px">Zones: <span class="zone-tag product">factory</span></div>
    
  </td>
</tr>
            <tr class="expandable" onclick="toggleCIDetail(this)">
  <td><strong>validate</strong> <small style="color:var(--text-muted)">(push)</small></td>
  <td><span class="badge pass">pass</span></td>
  <td><span class="time-label watch">6m 9s</span><br><span class="time-health-sub">watch</span></td>
  <td class="ci-chevron">&#x25BC;</td>
</tr>
<tr class="detail-row">
  <td colspan="4">
    <p><strong>Coverage:</strong> Product code validation</p>
    <p><strong>Gates:</strong> Gate 1 (lint + typecheck + test), Docker build + smoke</p>
    <div class="ci-check-item" onclick="event.stopPropagation();this.classList.toggle('open')">
  <div class="ci-check-summary"><span class="ci-sub-chevron">&#x25B6;</span> Lint (ruff check)</div>
  <div class="ci-check-detail">All Python source passes ruff</div>
</div>
<div class="ci-check-item" onclick="event.stopPropagation();this.classList.toggle('open')">
  <div class="ci-check-summary"><span class="ci-sub-chevron">&#x25B6;</span> Typecheck (mypy src)</div>
  <div class="ci-check-detail">Strict type checking on all source</div>
</div>
<div class="ci-check-item" onclick="event.stopPropagation();this.classList.toggle('open')">
  <div class="ci-check-summary"><span class="ci-sub-chevron">&#x25B6;</span> Test (pytest)</div>
  <div class="ci-check-detail">Full test suite including training smoke</div>
</div>
    <div style="margin-top:6px">Zones: <span class="zone-tag product">training</span> <span class="zone-tag product">environment</span> <span class="zone-tag product">rl-core</span> <span class="zone-tag product">agent</span> <span class="zone-tag product">config</span> <span class="zone-tag product">docker</span></div>
    <div>Specs: <code>specs/system.md</code></div>
    
  </td>
</tr>
            <tr class="expandable" onclick="toggleCIDetail(this)">
  <td><strong>validate</strong> <small style="color:var(--text-muted)">(PR)</small></td>
  <td><span class="badge pass">pass</span></td>
  <td><span class="time-label watch">6m 16s</span><br><span class="time-health-sub">watch</span></td>
  <td class="ci-chevron">&#x25BC;</td>
</tr>
<tr class="detail-row">
  <td colspan="4">
    <p><strong>Coverage:</strong> Product code validation (PR context)</p>
    <p><strong>Gates:</strong> Gate 1</p>
        <div style="margin-top:6px">Zones: <span class="zone-tag product">training</span></div>
    
  </td>
</tr>
            <tr class="expandable" onclick="toggleCIDetail(this)">
  <td><strong>factory-loop</strong> <small style="color:var(--text-muted)">(push)</small></td>
  <td><span class="badge pass">pass</span></td>
  <td><span class="time-label watch">5m 13s</span><br><span class="time-health-sub">watch</span></td>
  <td class="ci-chevron">&#x25BC;</td>
</tr>
<tr class="detail-row">
  <td colspan="4">
    <p><strong>Coverage:</strong> Factory convergence loop</p>
    <p><strong>Gates:</strong> Gates 1-3 + feedback compilation</p>
        <div style="margin-top:6px">Zones: <span class="zone-tag product">factory</span></div>
    
  </td>
</tr>
            
          </tbody>
        </table>
        <p style="margin-top:10px;font-size:11px;color:var(--text-muted)">
          <strong>Thresholds:</strong> &#x2713; under 1m = normal &bull; &#x25CB; 1-5m = acceptable &bull; &#x26A0; 5-10m = watch &bull; &#x2716; over 10m = needs refactoring
        </p>
      </div>
    </div>

    <!-- Section: Key Decisions -->
    <div class="section">
      <div class="section-header" onclick="this.parentElement.classList.toggle('collapsed')">
        <h2>Key Decisions</h2>
        <span class="chevron">&#x25BC;</span>
      </div>
      <div class="section-body" id="decisions-container">
        <div class="decision-card" data-zones="training">
  <div class="decision-header" onclick="toggleDecision(this.parentElement)">
    <span class="decision-num">1</span>
    <div>
      <div class="decision-title">Wire existing record_video() rather than rewriting</div>
      <div class="decision-rationale">The video recording function was already implemented and tested ‚Äî it just wasn&#x27;t called from the training loop.</div>
    </div>
  </div>
  <div class="decision-body">
    <p>Rather than creating a new video recording mechanism or modifying the evaluation flow, we simply imported the existing <code>record_video()</code> function and called it at the same point where checkpoints and metrics are already saved. This is the minimal change that fixes the scenario failure.</p>
    <div class="decision-zones"><span class="zone-tag product">training</span></div>
    <div class="decision-files"><table style="width:100%;margin-top:8px"><thead><tr><th>File</th><th>Change</th></tr></thead><tbody><tr><td><code class="file-path-link" onclick="event.stopPropagation();openFileModal('src/train/train_dqn.py')">src/train/train_dqn.py</code></td><td>Added import and call to record_video() in eval block</td></tr>
<tr><td><code class="file-path-link" onclick="event.stopPropagation();openFileModal('src/train/record_video.py')">src/train/record_video.py</code></td><td>Added frame_stack parameter for config compatibility</td></tr>
</tbody></table></div>
  </div>
</div>
        <div class="decision-card" data-zones="training">
  <div class="decision-header" onclick="toggleDecision(this.parentElement)">
    <span class="decision-num">2</span>
    <div>
      <div class="decision-title">Parameterize frame_stack instead of hardcoding</div>
      <div class="decision-rationale">Hardcoded frame_stack=4 caused shape mismatches when training config used a different value.</div>
    </div>
  </div>
  <div class="decision-body">
    <p>The original <code>record_video()</code> hardcoded <code>frame_stack=4</code>. When the test suite runs with <code>frame_stack=2</code>, loading a checkpoint into a model with mismatched input channels causes a RuntimeError. Adding the parameter with default=4 maintains backward compatibility while allowing the training loop to pass the correct value.</p>
    <div class="decision-zones"><span class="zone-tag product">training</span></div>
    <div class="decision-files"><table style="width:100%;margin-top:8px"><thead><tr><th>File</th><th>Change</th></tr></thead><tbody><tr><td><code class="file-path-link" onclick="event.stopPropagation();openFileModal('src/train/record_video.py')">src/train/record_video.py</code></td><td>Added frame_stack parameter with default=4</td></tr>
</tbody></table></div>
  </div>
</div>
      </div>
    </div>

    <!-- Section: Convergence Result -->
    <div class="section">
      <div class="section-header" onclick="this.parentElement.classList.toggle('collapsed')">
        <h2>Convergence Result</h2>
        <span class="chevron">&#x25BC;</span>
      </div>
      <div class="section-body">
        <div class="convergence-grid" id="convergence-grid">
          <div class="conv-card" onclick="this.classList.toggle('open')">
  <div class="conv-name">Gate 0 ‚Äî Adversarial Review</div>
  <div class="conv-status passing">CLEAN</div>
  <div class="conv-detail">2 files reviewed, both grade A. No critical or warning findings.</div>
  <div class="conv-card-detail">Targeted fix with minimal blast radius. Both changes are straightforward: one import + function call, one parameter addition. No gaming patterns, no architectural concerns.</div>
</div>
          <div class="conv-card" onclick="this.classList.toggle('open')">
  <div class="conv-name">Gate 1 ‚Äî Deterministic</div>
  <div class="conv-status passing">ALL PASS</div>
  <div class="conv-detail">ruff clean, mypy clean, 56 tests pass</div>
  <div class="conv-card-detail"><strong>Lint:</strong> All checks passed<br><strong>Typecheck:</strong> No issues in 24 source files<br><strong>Tests:</strong> 56 passed, including test_training_smoke_cpu which exercises the new video recording path</div>
</div>
          <div class="conv-card" onclick="this.classList.toggle('open')">
  <div class="conv-name">Gate 2 ‚Äî NFR</div>
  <div class="conv-status warning">1 WARNING</div>
  <div class="conv-detail">1 cosmetic finding (RET504 in minipong.py:124, not in changed files)</div>
  <div class="conv-card-detail">RET504: Unnecessary assignment to <code>rgb</code> before <code>return</code> statement in <code>src/envs/minipong.py:124</code>. Pre-existing, not introduced by this PR. Non-blocking.</div>
</div>
          <div class="conv-card" onclick="this.classList.toggle('open')">
  <div class="conv-name">Gate 3 ‚Äî Scenarios</div>
  <div class="conv-status passing">12/12 PASS</div>
  <div class="conv-detail">100% satisfaction score. All behavioral scenarios pass.</div>
  <div class="conv-card-detail">All 12 holdout scenarios pass, including the previously failing Scenario 7 (Evaluation Produces Videos). Satisfaction trajectory: 42% ‚Üí 100%.</div>
</div>
          <div class="conv-card" onclick="this.classList.toggle('open')">
  <div class="conv-name">Overall</div>
  <div class="conv-status passing">CONVERGED</div>
  <div class="conv-detail">All gates green. 100% scenario satisfaction. Ready for accept/merge.</div>
  <div class="conv-card-detail">This is the first factory crank to converge. The fix is surgical (2 files, +14/-2 lines) and addresses the sole remaining gap between the factory v1 codebase and full scenario coverage.</div>
</div>
        </div>
      </div>
    </div>

    <!-- Section: Post-Merge Items -->
    <div class="section">
      <div class="section-header" onclick="this.parentElement.classList.toggle('collapsed')">
        <h2>Post-Merge Items</h2>
        <span class="chevron">&#x25BC;</span>
      </div>
      <div class="section-body" id="post-merge-container">
        <div class="pm-item">
  <div class="pm-header" onclick="this.parentElement.classList.toggle('open')">
    <span class="priority medium">MEDIUM</span>
    <span>Install Gate 2 tools: <code>radon</code>, <code>vulture</code>, <code>bandit</code></span>
  </div>
  <div class="pm-body">
    <p>Gate 2 NFR checks skipped 3 of 4 sub-checks because radon, vulture, and bandit are not installed in the py312 environment. These tools provide complexity analysis, dead code detection, and security scanning.</p>
    
    <div class="scenario-box failure">
      <div class="scenario-label">Failure scenario</div>
      Future cranks run Gate 2 with only 1 of 4 checks active, missing complexity or security issues that accumulate.
    </div>
    <div class="scenario-box success">
      <div class="scenario-label">Resolution</div>
      All 4 NFR checks run on every crank, catching complexity creep and security issues early.
    </div>
    <div style="margin-top:6px"><span class="zone-tag product">factory</span> <span class="zone-tag product">config</span></div>
  </div>
</div>
        <div class="pm-item">
  <div class="pm-header" onclick="this.parentElement.classList.toggle('open')">
    <span class="priority medium">MEDIUM</span>
    <span>Fix <code>requirements.txt</code> CUDA pinning for macOS ARM</span>
  </div>
  <div class="pm-body">
    <p>The compiled requirements.txt includes CUDA-specific packages (cuda-bindings, nvidia-*) that cannot install on macOS ARM. Currently, dependencies must be installed from requirements.in directly.</p>
    
    <div class="scenario-box failure">
      <div class="scenario-label">Failure scenario</div>
      New developers on macOS cannot run &lt;code&gt;make deps&lt;/code&gt; and must manually install packages.
    </div>
    <div class="scenario-box success">
      <div class="scenario-label">Resolution</div>
      Platform-aware requirements (e.g., separate requirements-cpu.txt or environment markers) allow &lt;code&gt;make deps&lt;/code&gt; to work on both CUDA and CPU platforms.
    </div>
    <div style="margin-top:6px"><span class="zone-tag product">config</span></div>
  </div>
</div>
        <div class="pm-item">
  <div class="pm-header" onclick="this.parentElement.classList.toggle('open')">
    <span class="priority low">LOW</span>
    <span>Fix cosmetic RET504 in <code>minipong.py:124</code></span>
  </div>
  <div class="pm-body">
    <p>Gate 2 flagged an unnecessary variable assignment before return. Pre-existing, cosmetic.</p>
    <div class="code-block">## src/envs/minipong.py, line 124
rgb = np.stack([obs] * 3, axis=-1)
return rgb  # could be: return np.stack([obs] * 3, axis=-1)</div>
    <div class="scenario-box failure">
      <div class="scenario-label">Failure scenario</div>
      Gate 2 continues to report this warning on every crank.
    </div>
    <div class="scenario-box success">
      <div class="scenario-label">Resolution</div>
      Clean Gate 2 output with zero findings.
    </div>
    <div style="margin-top:6px"><span class="zone-tag product">environment</span></div>
  </div>
</div>
        <div class="pm-item">
  <div class="pm-header" onclick="this.parentElement.classList.toggle('open')">
    <span class="priority low">LOW</span>
    <span>Scenario 9 (Dashboard) only checks importability</span>
  </div>
  <div class="pm-body">
    <p>The dashboard scenario verifies the module is importable but does not test rendering, data loading, or any functional behavior. The scenario is passing but coverage is shallow.</p>
    
    <div class="scenario-box failure">
      <div class="scenario-label">Failure scenario</div>
      Dashboard breaks silently ‚Äî scenario still passes because import succeeds even if rendering fails.
    </div>
    <div class="scenario-box success">
      <div class="scenario-label">Resolution</div>
      Add a deeper dashboard scenario that loads a test run and verifies chart rendering without errors.
    </div>
    <div style="margin-top:6px"><span class="zone-tag product">dashboard</span></div>
  </div>
</div>
      </div>
    </div>

  </div><!-- end tab-review -->

  <!-- ‚ïê‚ïê TAB 2: FACTORY HISTORY (conditional) ‚ïê‚ïê -->
  <div id="tab-history" class="tab-content">
    <div class="tab-panel" style="padding:20px 24px">
      <h2 style="font-size:15px;font-weight:700;margin-bottom:16px">Factory Convergence History</h2>
      <div class="history-legend">
        <div class="history-legend-item"><div class="history-legend-dot" style="background:var(--blue)"></div> Automated event</div>
        <div class="history-legend-item"><div class="history-legend-dot" style="background:var(--orange)"></div> Human/agent intervention</div>
        <div class="history-legend-item" style="margin-left:auto;font-style:italic">Click event to expand details</div>
      </div>
      <div class="convergence-grid" style="margin-bottom:20px" id="history-summary-cards">
        <div class="conv-card" onclick="this.classList.toggle('open')">
  <div class="conv-name">Iterations</div>
  <div class="conv-status passing">3 (factory/v1) + 1 targeted fix</div>
  <div class="conv-detail">Factory convergence iterations</div>
  <div class="conv-card-detail">Factory v1 achieved 42% satisfaction over 3 Codex iterations (limited by CI environment lacking video/GPU deps). After merging v1 to main, the first orchestrated crank identified the sole remaining gap (missing record_video() call) and fixed it, reaching 100%.</div>
</div>
        <div class="conv-card" onclick="this.classList.toggle('open')">
  <div class="conv-name">Satisfaction</div>
  <div class="conv-status passing">42% ‚Üí 100%</div>
  <div class="conv-detail">Scenario satisfaction trajectory</div>
  <div class="conv-card-detail">Factory v1 achieved 42% satisfaction over 3 Codex iterations (limited by CI environment lacking video/GPU deps). After merging v1 to main, the first orchestrated crank identified the sole remaining gap (missing record_video() call) and fixed it, reaching 100%.</div>
</div>
      </div>
      <h3 style="font-size:13px;font-weight:700;margin-bottom:12px">Timeline</h3>
      <div class="history-timeline" id="history-timeline">
        <div class="history-event " onclick="this.classList.toggle('open')">
  <div class="history-event-header">
    <div class="history-event-title">Factory v1: 3 Codex iterations</div>
    <span class="event-agent ">Codex (factory-loop)</span>
  </div>
  <div class="history-event-detail-summary">Codex built the MiniPong environment, DQN agent, training pipeline, dashboard, and test suite over 3 automated iterations.</div>
  <div class="history-event-meta">Commits: 7ae9e6f..4633ebe</div>
  <div class="history-event-detail">The factory-loop CI workflow ran 3 iterations of Codex, achieving 42% satisfaction (5/12 scenarios passing). The 7 failing scenarios were primarily due to the CI environment lacking gymnasium and video recording dependencies, not code defects.</div>
</div>
        <div class="history-event intervention" onclick="this.classList.toggle('open')">
  <div class="history-event-header">
    <div class="history-event-title">Factory v1 merged to main</div>
    <span class="event-agent human">Human (Joey)</span>
  </div>
  <div class="history-event-detail-summary">All factory infrastructure and product code merged as a single PR.</div>
  <div class="history-event-meta">Commit: 4633ebe . Feb 25</div>
  <div class="history-event-detail">Merged factory/v1 branch containing: convergence loop infrastructure, Gate 0 agent team, PR review pack skill, code quality standards, holdout isolation, and the full MiniPong RL product code.</div>
</div>
        <div class="history-event " onclick="this.classList.toggle('open')">
  <div class="history-event-header">
    <div class="history-event-title">Crank v01: Gap analysis + targeted fix</div>
    <span class="event-agent ">Claude Code (orchestrator)</span>
  </div>
  <div class="history-event-detail-summary">Claude Code orchestrator identified the video recording gap and applied a 2-file fix.</div>
  <div class="history-event-meta">Commit: eb850cc . Feb 25</div>
  <div class="history-event-detail">Fresh scenario run on main revealed 11/12 passing. Scenario 7 (Evaluation Produces Videos) failed because train_dqn.py never called record_video(). The fix: import record_video and call it at each eval checkpoint, plus add frame_stack parameter for config compatibility. All 12 scenarios now pass.</div>
</div>
      </div>
      <h3 style="font-size:13px;font-weight:700;margin:20px 0 12px">Gate Findings by Iteration</h3>
      <table id="gate-findings-table">
        <thead><tr><th>Phase</th><th>Gate 1</th><th>Gate 2</th><th>Gate 3</th><th>Action</th></tr></thead>
        <tbody>
          <tr>
  <td class="gate-clickable" onclick="showGatePopover(event, '3 automated Codex iterations via factory-loop CI workflow')">Factory v1 (CI)</td>
  <td class="gate-clickable" onclick="showGatePopover(event, 'Lint, typecheck, and tests all passing in CI')"><span class="badge pass">pass</span></td>
  <td class="gate-clickable" onclick="showGatePopover(event, 'RET504 unnecessary assignment in minipong.py:124')"><span class="badge info">1 finding</span></td>
  <td class="gate-clickable" onclick="showGatePopover(event, '42% satisfaction. 5 env scenarios failed (missing gymnasium in CI). 2 training scenarios failed (no video recording).')"><span class="badge fail">5/12</span></td>
  <td>Merged to main despite partial satisfaction ‚Äî CI env limitations, not code defects</td>
</tr>
          <tr>
  <td class="gate-clickable" onclick="showGatePopover(event, 'Claude Code orchestrated: gap analysis ‚Üí targeted fix ‚Üí full gate validation')">Crank v01 (local)</td>
  <td class="gate-clickable" onclick="showGatePopover(event, 'ruff clean, mypy clean, 56 tests pass')"><span class="badge pass">pass</span></td>
  <td class="gate-clickable" onclick="showGatePopover(event, 'Same pre-existing RET504 warning')"><span class="badge info">1 finding</span></td>
  <td class="gate-clickable" onclick="showGatePopover(event, '100% satisfaction. All scenarios pass including the previously failing Evaluation Produces Videos.')"><span class="badge pass">12/12</span></td>
  <td>PR created ‚Äî converged at 100%</td>
</tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    Generated by review pack agent &nbsp;|&nbsp; <span id="footer-date">2026-02-25T20:45:00Z</span> &nbsp;|&nbsp; HEAD: <span id="footer-sha">bce032a</span><br>
    <span style="font-size:10px">Deterministic rendering from structured data &bull; Code diffs are ground truth</span>
  </div>

</div>

<!-- Floating architecture diagram (populated by JS) -->
<div id="arch-floating" class="arch-floating">
  <button class="arch-floating-close" onclick="dismissFloatingDiagram()" title="Dismiss floating diagram">&times;</button>
  <div id="arch-floating-content"></div>
</div>

<!-- File diff modal -->
<div id="file-modal-overlay" class="file-modal-overlay" onclick="if(event.target===this)closeFileModal()">
  <div class="file-modal">
    <div class="file-modal-header">
      <div style="display:flex;align-items:center;gap:8px;overflow:hidden">
        <h3 id="file-modal-path" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></h3>
        <span id="file-modal-stats" class="fm-stats"></span>
      </div>
      <button class="file-modal-close" onclick="closeFileModal()">&times;</button>
    </div>
    <div class="file-modal-toolbar">
      <div class="file-modal-tabs">
        <button class="file-modal-tab active" data-view="side-by-side" onclick="setFileModalTab(this,'side-by-side')">Side-by-side</button>
        <button class="file-modal-tab" data-view="integrated" onclick="setFileModalTab(this,'integrated')">Unified</button>
        <button class="file-modal-tab" data-view="raw" onclick="setFileModalTab(this,'raw')">Raw file</button>
      </div>
      <a id="file-modal-github-link" class="file-modal-github" href="#" target="_blank">View on GitHub &rarr;</a>
    </div>
    <div class="file-modal-body" id="file-modal-body">
      <div class="diff-loading">Loading diff data&hellip;</div>
    </div>
  </div>
</div>

<!-- Gate popover -->
<div id="gate-popover" class="gate-popover"></div>

<script>
// Reference file content embedded by render_review_pack.py
// These files are not in the diff but are viewable in raw mode.
const REFERENCE_FILES = {"specs/training.md": "# Training Pipeline Spec\n\n## Overview\n\nThe training pipeline orchestrates DQN training on MiniPong, producing all artifacts needed for learning proof and observability.\n\n## Entry Point\n\n`python -m src.train.train_dqn --config configs/dqn_minipong.yaml --run-id <run_id>`\n\n## Config\n\nYAML config file specifying all hyperparameters. See `configs/dqn_minipong.yaml` for defaults:\n- `run_id`, `seed`, `frame_stack`\n- `total_steps`, `max_episode_steps`\n- Replay: `replay_capacity`, `replay_warmup_steps`, `batch_size`\n- RL: `gamma`, `lr`, `epsilon_start`, `epsilon_end`, `epsilon_decay_steps`, `target_update_period`\n- Eval: `eval_every_steps`, `eval_episodes`, `eval_seeds`\n\n## Training Loop\n\n1. Initialize environment, agent, replay buffer\n2. Collect transitions with epsilon-greedy policy\n3. After warmup, sample batches and update Q-network\n4. Periodically evaluate current policy (every `eval_every_steps`)\n5. Periodically save checkpoints\n6. Log metrics to TensorBoard and JSONL\n\n## Artifact Output\n\nAll artifacts saved under `artifacts/<run_id>/`:\n\n| Artifact | Path | Format |\n|----------|------|--------|\n| TensorBoard logs | `artifacts/<run_id>/tensorboard/` | TensorBoard event files |\n| Training log | `artifacts/<run_id>/logs.jsonl` | JSON Lines (one entry per step/episode) |\n| Checkpoints | `artifacts/<run_id>/checkpoints/*.pt` | PyTorch state dicts |\n| Eval metrics | `artifacts/<run_id>/eval/metrics_*.json` | JSON per evaluation |\n| Eval videos | `artifacts/<run_id>/videos/eval_step_<k>.mp4` | MP4 video |\n\n## Evaluation\n\n- Uses fixed seeds and fixed number of episodes\n- Records: mean return, hit rate, rally length, episode count\n- Saves evaluation videos at configurable intervals\n\n## Reproducibility\n\n- Training is seeded via config\n- Evaluation uses explicit seed list\n- All randomness flows through the configured RNG\n", "specs/proof.md": "# Learning Proof & Video Proof Spec\n\n## Learning Proof\n\n### Baseline\n\nCreate a random policy evaluation FIRST and store its metrics. This is the control \u2014 the agent before any learning.\n\n### Verification Criteria\n\nLearning verification passes when ALL of:\n1. Mean episode return improves over random baseline\n2. Hit rate improves over random baseline\n3. Improvement is observed for at least 2 distinct seeds\n\n### Runnable Command\n\n`make verify-learning` \u2014 returns non-zero exit code on failure.\n\nImplemented via: `python -m src.train.verify_learning --run-id <run_id> --min-return-gain <threshold> --min-hits-gain <threshold>`\n\n### Metrics\n\nComparison between random baseline and trained policy:\n- Mean episode return (higher is better)\n- Hit rate: hits / (hits + misses) (higher is better)\n- Per-seed breakdown to ensure consistency\n\n## Video Proof\n\n### Recording Points\n\nRecord evaluation videos at:\n1. Random baseline (step 0, untrained policy)\n2. Early checkpoint (~10% of training)\n3. Mid checkpoint (~50% of training)\n4. Late checkpoint (~100% of training)\n\n### Montage\n\nCreate either:\n- A montage video combining all checkpoint videos, OR\n- A folder with HTML index showing video progression side-by-side\n\nImplemented via: `src/train/make_montage.py`\n\n### Evidence\n\nVideos must visually demonstrate:\n- Random policy: ball passes paddle, no tracking behavior\n- Trained policy: paddle tracks ball, returns volleys, rallies extend\n\n### Artifact Locations\n\n- Individual videos: `artifacts/<run_id>/videos/eval_step_<k>.mp4`\n- Montage: `artifacts/<run_id>/videos/montage/` or `artifacts/<run_id>/videos/montage.mp4`\n"};
</script>
<script>
// Diff data embedded inline by render_review_pack.py
// Source: generate_diff_data.py (Pass 1, deterministic)
// Trust: raw git diff/show output, zero LLM involvement
const DIFF_DATA_INLINE = {
  "pr": 6,
  "base_branch": "main",
  "head_branch": "df-crank-v01-eval-videos",
  "head_sha": "bce032a",
  "head_sha_full": "bce032aa149f125641214933666551aa3a59380d",
  "total_files": 2,
  "total_additions": 16,
  "total_deletions": 2,
  "files": {
    "src/train/record_video.py": {
      "additions": 6,
      "deletions": 2,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/src/train/record_video.py b/src/train/record_video.py\nindex 8339ad2..1b4d97f 100644\n--- a/src/train/record_video.py\n+++ b/src/train/record_video.py\n@@ -15,9 +15,13 @@ from src.rl.replay import ReplayBuffer\n \n \n def record_video(\n-    checkpoint: Path | None, output_path: Path, seed: int = 0, max_steps: int = 1000\n+    checkpoint: Path | None,\n+    output_path: Path,\n+    seed: int = 0,\n+    max_steps: int = 1000,\n+    frame_stack: int = 4,\n ) -> None:\n-    env = wrap_env(MiniPongEnv(render_mode=\"rgb_array\"), frame_stack=4)\n+    env = wrap_env(MiniPongEnv(render_mode=\"rgb_array\"), frame_stack=frame_stack)\n     obs, _ = env.reset(seed=seed)\n     replay = ReplayBuffer(capacity=8)\n     agent = DQNAgent(obs.shape, env.action_space.n, replay, DQNConfig())\n",
      "raw": "\"\"\"Record evaluation video.\"\"\"\n\nfrom __future__ import annotations\n\nimport argparse\nfrom pathlib import Path\n\nimport imageio.v2 as imageio\nimport torch\n\nfrom src.agents.dqn_agent import DQNAgent, DQNConfig\nfrom src.envs.minipong import MiniPongEnv\nfrom src.envs.wrappers import wrap_env\nfrom src.rl.replay import ReplayBuffer\n\n\ndef record_video(\n    checkpoint: Path | None,\n    output_path: Path,\n    seed: int = 0,\n    max_steps: int = 1000,\n    frame_stack: int = 4,\n) -> None:\n    env = wrap_env(MiniPongEnv(render_mode=\"rgb_array\"), frame_stack=frame_stack)\n    obs, _ = env.reset(seed=seed)\n    replay = ReplayBuffer(capacity=8)\n    agent = DQNAgent(obs.shape, env.action_space.n, replay, DQNConfig())\n    if checkpoint is not None:\n        data = torch.load(checkpoint, map_location=agent.device)\n        agent.online.load_state_dict(data[\"model\"])\n    frames = []\n    done = False\n    trunc = False\n    steps = 0\n    while not done and not trunc and steps < max_steps:\n        action = agent.act(obs, epsilon=0.0) if checkpoint else env.action_space.sample()\n        obs, _, done, trunc, _ = env.step(action)\n        frame = env.unwrapped.render()\n        frames.append(frame)\n        steps += 1\n    output_path.parent.mkdir(parents=True, exist_ok=True)\n    imageio.mimsave(output_path, frames, fps=30)\n\n\ndef main() -> None:\n    parser = argparse.ArgumentParser()\n    parser.add_argument(\"--checkpoint\", default=\"\")\n    parser.add_argument(\"--output\", required=True)\n    parser.add_argument(\"--seed\", type=int, default=0)\n    args = parser.parse_args()\n    ckpt = Path(args.checkpoint) if args.checkpoint else None\n    record_video(ckpt, Path(args.output), seed=args.seed)\n\n\nif __name__ == \"__main__\":\n    main()\n",
      "base": "\"\"\"Record evaluation video.\"\"\"\n\nfrom __future__ import annotations\n\nimport argparse\nfrom pathlib import Path\n\nimport imageio.v2 as imageio\nimport torch\n\nfrom src.agents.dqn_agent import DQNAgent, DQNConfig\nfrom src.envs.minipong import MiniPongEnv\nfrom src.envs.wrappers import wrap_env\nfrom src.rl.replay import ReplayBuffer\n\n\ndef record_video(\n    checkpoint: Path | None, output_path: Path, seed: int = 0, max_steps: int = 1000\n) -> None:\n    env = wrap_env(MiniPongEnv(render_mode=\"rgb_array\"), frame_stack=4)\n    obs, _ = env.reset(seed=seed)\n    replay = ReplayBuffer(capacity=8)\n    agent = DQNAgent(obs.shape, env.action_space.n, replay, DQNConfig())\n    if checkpoint is not None:\n        data = torch.load(checkpoint, map_location=agent.device)\n        agent.online.load_state_dict(data[\"model\"])\n    frames = []\n    done = False\n    trunc = False\n    steps = 0\n    while not done and not trunc and steps < max_steps:\n        action = agent.act(obs, epsilon=0.0) if checkpoint else env.action_space.sample()\n        obs, _, done, trunc, _ = env.step(action)\n        frame = env.unwrapped.render()\n        frames.append(frame)\n        steps += 1\n    output_path.parent.mkdir(parents=True, exist_ok=True)\n    imageio.mimsave(output_path, frames, fps=30)\n\n\ndef main() -> None:\n    parser = argparse.ArgumentParser()\n    parser.add_argument(\"--checkpoint\", default=\"\")\n    parser.add_argument(\"--output\", required=True)\n    parser.add_argument(\"--seed\", type=int, default=0)\n    args = parser.parse_args()\n    ckpt = Path(args.checkpoint) if args.checkpoint else None\n    record_video(ckpt, Path(args.output), seed=args.seed)\n\n\nif __name__ == \"__main__\":\n    main()\n"
    },
    "src/train/train_dqn.py": {
      "additions": 10,
      "deletions": 0,
      "status": "modified",
      "binary": false,
      "diff": "diff --git a/src/train/train_dqn.py b/src/train/train_dqn.py\nindex ff5390b..86b8807 100644\n--- a/src/train/train_dqn.py\n+++ b/src/train/train_dqn.py\n@@ -15,6 +15,7 @@ from src.obs.logging import MetricsLogger\n from src.rl.replay import ReplayBuffer, Transition\n from src.rl.schedules import linear_schedule\n from src.train.evaluate import evaluate_policy\n+from src.train.record_video import record_video\n \n \n def train(config: dict) -> str:\n@@ -100,6 +101,15 @@ def train(config: dict) -> str:\n                     \"eval/mean_hits\": metrics[\"mean_hits\"],\n                 },\n             )\n+            eval_seeds = config.get(\"eval_seeds\", [])\n+            if eval_seeds:\n+                video_path = run_dir / \"videos\" / f\"eval_step_{step}.mp4\"\n+                record_video(\n+                    ckpt_path,\n+                    video_path,\n+                    seed=int(eval_seeds[0]),\n+                    frame_stack=int(config[\"frame_stack\"]),\n+                )\n \n     logger.close()\n     return run_id\n",
      "raw": "\"\"\"Train DQN on MiniPong.\"\"\"\n\nfrom __future__ import annotations\n\nimport argparse\nimport json\nfrom pathlib import Path\n\nimport yaml\n\nfrom src.agents.dqn_agent import DQNAgent, DQNConfig\nfrom src.envs.minipong import MiniPongEnv\nfrom src.envs.wrappers import wrap_env\nfrom src.obs.logging import MetricsLogger\nfrom src.rl.replay import ReplayBuffer, Transition\nfrom src.rl.schedules import linear_schedule\nfrom src.train.evaluate import evaluate_policy\nfrom src.train.record_video import record_video\n\n\ndef train(config: dict) -> str:\n    run_id = config.get(\"run_id\", \"local_run\")\n    run_dir = Path(\"artifacts\") / run_id\n    (run_dir / \"checkpoints\").mkdir(parents=True, exist_ok=True)\n    (run_dir / \"eval\").mkdir(exist_ok=True)\n    (run_dir / \"videos\").mkdir(exist_ok=True)\n\n    env = wrap_env(MiniPongEnv(), frame_stack=int(config[\"frame_stack\"]))\n    obs, _ = env.reset(seed=int(config[\"seed\"]))\n    replay = ReplayBuffer(capacity=int(config[\"replay_capacity\"]))\n    agent = DQNAgent(\n        obs.shape,\n        env.action_space.n,\n        replay,\n        DQNConfig(\n            lr=float(config[\"lr\"]),\n            gamma=float(config[\"gamma\"]),\n            batch_size=int(config[\"batch_size\"]),\n        ),\n    )\n    logger = MetricsLogger(run_dir)\n\n    episode_return = 0.0\n    total_steps = int(config[\"total_steps\"])\n    for step in range(1, total_steps + 1):\n        eps = linear_schedule(\n            step,\n            float(config[\"epsilon_start\"]),\n            float(config[\"epsilon_end\"]),\n            int(config[\"epsilon_decay_steps\"]),\n        )\n        action = agent.act(obs, epsilon=eps)\n        next_obs, reward, terminated, truncated, info = env.step(action)\n        done = terminated or truncated\n        agent.observe(\n            Transition(obs=obs, action=action, reward=reward, next_obs=next_obs, done=done)\n        )\n        episode_return += reward\n        obs = next_obs\n\n        loss = None\n        if step > int(config[\"replay_warmup_steps\"]) and len(replay) >= int(config[\"batch_size\"]):\n            loss = agent.update()\n        if step % int(config[\"target_update_period\"]) == 0:\n            agent.sync_target()\n\n        if done:\n            logger.log_metrics(\n                step,\n                {\n                    \"train/episode_return\": episode_return,\n                    \"train/hits\": info.get(\"hits\", 0),\n                    \"train/epsilon\": eps,\n                },\n            )\n            episode_return = 0.0\n            obs, _ = env.reset(seed=int(config[\"seed\"]) + step)\n\n        if loss is not None and step % 10 == 0:\n            logger.log_metrics(step, {\"train/loss\": loss, \"train/epsilon\": eps})\n\n        if step % int(config[\"eval_every_steps\"]) == 0:\n            ckpt_path = run_dir / \"checkpoints\" / f\"step_{step}.pt\"\n            import torch\n\n            torch.save({\"model\": agent.online.state_dict(), \"step\": step}, ckpt_path)\n            metrics = evaluate_policy(\n                ckpt_path,\n                int(config[\"eval_episodes\"]),\n                list(config[\"eval_seeds\"]),\n                int(config[\"frame_stack\"]),\n                int(config[\"max_episode_steps\"]),\n            )\n            (run_dir / \"eval\" / f\"metrics_step_{step}.json\").write_text(\n                json.dumps(metrics, indent=2), encoding=\"utf-8\"\n            )\n            logger.log_metrics(\n                step,\n                {\n                    \"eval/mean_return\": metrics[\"mean_return\"],\n                    \"eval/mean_hits\": metrics[\"mean_hits\"],\n                },\n            )\n            eval_seeds = config.get(\"eval_seeds\", [])\n            if eval_seeds:\n                video_path = run_dir / \"videos\" / f\"eval_step_{step}.mp4\"\n                record_video(\n                    ckpt_path,\n                    video_path,\n                    seed=int(eval_seeds[0]),\n                    frame_stack=int(config[\"frame_stack\"]),\n                )\n\n    logger.close()\n    return run_id\n\n\ndef main() -> None:\n    parser = argparse.ArgumentParser()\n    parser.add_argument(\"--config\", default=\"configs/dqn_minipong.yaml\")\n    parser.add_argument(\"--run-id\", default=\"\")\n    args = parser.parse_args()\n\n    config = yaml.safe_load(Path(args.config).read_text(encoding=\"utf-8\"))\n    if args.run_id:\n        config[\"run_id\"] = args.run_id\n    run_id = train(config)\n    print(run_id)\n\n\nif __name__ == \"__main__\":\n    main()\n",
      "base": "\"\"\"Train DQN on MiniPong.\"\"\"\n\nfrom __future__ import annotations\n\nimport argparse\nimport json\nfrom pathlib import Path\n\nimport yaml\n\nfrom src.agents.dqn_agent import DQNAgent, DQNConfig\nfrom src.envs.minipong import MiniPongEnv\nfrom src.envs.wrappers import wrap_env\nfrom src.obs.logging import MetricsLogger\nfrom src.rl.replay import ReplayBuffer, Transition\nfrom src.rl.schedules import linear_schedule\nfrom src.train.evaluate import evaluate_policy\n\n\ndef train(config: dict) -> str:\n    run_id = config.get(\"run_id\", \"local_run\")\n    run_dir = Path(\"artifacts\") / run_id\n    (run_dir / \"checkpoints\").mkdir(parents=True, exist_ok=True)\n    (run_dir / \"eval\").mkdir(exist_ok=True)\n    (run_dir / \"videos\").mkdir(exist_ok=True)\n\n    env = wrap_env(MiniPongEnv(), frame_stack=int(config[\"frame_stack\"]))\n    obs, _ = env.reset(seed=int(config[\"seed\"]))\n    replay = ReplayBuffer(capacity=int(config[\"replay_capacity\"]))\n    agent = DQNAgent(\n        obs.shape,\n        env.action_space.n,\n        replay,\n        DQNConfig(\n            lr=float(config[\"lr\"]),\n            gamma=float(config[\"gamma\"]),\n            batch_size=int(config[\"batch_size\"]),\n        ),\n    )\n    logger = MetricsLogger(run_dir)\n\n    episode_return = 0.0\n    total_steps = int(config[\"total_steps\"])\n    for step in range(1, total_steps + 1):\n        eps = linear_schedule(\n            step,\n            float(config[\"epsilon_start\"]),\n            float(config[\"epsilon_end\"]),\n            int(config[\"epsilon_decay_steps\"]),\n        )\n        action = agent.act(obs, epsilon=eps)\n        next_obs, reward, terminated, truncated, info = env.step(action)\n        done = terminated or truncated\n        agent.observe(\n            Transition(obs=obs, action=action, reward=reward, next_obs=next_obs, done=done)\n        )\n        episode_return += reward\n        obs = next_obs\n\n        loss = None\n        if step > int(config[\"replay_warmup_steps\"]) and len(replay) >= int(config[\"batch_size\"]):\n            loss = agent.update()\n        if step % int(config[\"target_update_period\"]) == 0:\n            agent.sync_target()\n\n        if done:\n            logger.log_metrics(\n                step,\n                {\n                    \"train/episode_return\": episode_return,\n                    \"train/hits\": info.get(\"hits\", 0),\n                    \"train/epsilon\": eps,\n                },\n            )\n            episode_return = 0.0\n            obs, _ = env.reset(seed=int(config[\"seed\"]) + step)\n\n        if loss is not None and step % 10 == 0:\n            logger.log_metrics(step, {\"train/loss\": loss, \"train/epsilon\": eps})\n\n        if step % int(config[\"eval_every_steps\"]) == 0:\n            ckpt_path = run_dir / \"checkpoints\" / f\"step_{step}.pt\"\n            import torch\n\n            torch.save({\"model\": agent.online.state_dict(), \"step\": step}, ckpt_path)\n            metrics = evaluate_policy(\n                ckpt_path,\n                int(config[\"eval_episodes\"]),\n                list(config[\"eval_seeds\"]),\n                int(config[\"frame_stack\"]),\n                int(config[\"max_episode_steps\"]),\n            )\n            (run_dir / \"eval\" / f\"metrics_step_{step}.json\").write_text(\n                json.dumps(metrics, indent=2), encoding=\"utf-8\"\n            )\n            logger.log_metrics(\n                step,\n                {\n                    \"eval/mean_return\": metrics[\"mean_return\"],\n                    \"eval/mean_hits\": metrics[\"mean_hits\"],\n                },\n            )\n\n    logger.close()\n    return run_id\n\n\ndef main() -> None:\n    parser = argparse.ArgumentParser()\n    parser.add_argument(\"--config\", default=\"configs/dqn_minipong.yaml\")\n    parser.add_argument(\"--run-id\", default=\"\")\n    args = parser.parse_args()\n\n    config = yaml.safe_load(Path(args.config).read_text(encoding=\"utf-8\"))\n    if args.run_id:\n        config[\"run_id\"] = args.run_id\n    run_id = train(config)\n    print(run_id)\n\n\nif __name__ == \"__main__\":\n    main()\n"
    }
  }
};
</script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA INJECTION POINT
// Replace this empty object with the ReviewPackData JSON
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DATA = {
  "header": {
    "title": "PR #6: [Factory] df-crank-v01 converged at 100%",
    "prNumber": 6,
    "prUrl": "https://github.com/joeyfezster/building_ai_w_ai/pull/6",
    "headBranch": "df-crank-v01-eval-videos",
    "baseBranch": "main",
    "headSha": "bce032a",
    "additions": 16,
    "deletions": 2,
    "filesChanged": 2,
    "commits": 2,
    "statusBadges": [
      {
        "label": "CI 5/5",
        "type": "pass",
        "icon": "\u2713"
      },
      {
        "label": "12/12 Scenarios",
        "type": "pass",
        "icon": "\u2713"
      },
      {
        "label": "Gate 2: 1 warn",
        "type": "info",
        "icon": "\u26a0"
      },
      {
        "label": "1/1 comments resolved",
        "type": "pass",
        "icon": "\u2713"
      }
    ],
    "generatedAt": "2026-02-25T20:45:00Z",
    "generatedBy": "dark factory review agent"
  },
  "architecture": {
    "zones": [
      {
        "id": "factory",
        "label": "Factory",
        "sublabel": "Convergence loop",
        "category": "factory",
        "fileCount": 0,
        "position": {
          "x": 20,
          "y": 20,
          "width": 120,
          "height": 80
        },
        "specs": [],
        "isModified": false
      },
      {
        "id": "environment",
        "label": "Environment",
        "sublabel": "MiniPong env",
        "category": "product",
        "fileCount": 0,
        "position": {
          "x": 20,
          "y": 130,
          "width": 120,
          "height": 80
        },
        "specs": [
          "specs/env.md"
        ],
        "isModified": false
      },
      {
        "id": "rl-core",
        "label": "RL Core",
        "sublabel": "DQN components",
        "category": "product",
        "fileCount": 0,
        "position": {
          "x": 160,
          "y": 130,
          "width": 120,
          "height": 80
        },
        "specs": [
          "specs/rl.md"
        ],
        "isModified": false
      },
      {
        "id": "agent",
        "label": "Agent",
        "sublabel": "DQN agent",
        "category": "product",
        "fileCount": 0,
        "position": {
          "x": 300,
          "y": 130,
          "width": 120,
          "height": 80
        },
        "specs": [
          "specs/rl.md"
        ],
        "isModified": false
      },
      {
        "id": "training",
        "label": "Training",
        "sublabel": "Pipeline, eval, video",
        "category": "product",
        "fileCount": 2,
        "position": {
          "x": 440,
          "y": 130,
          "width": 120,
          "height": 80
        },
        "specs": [
          "specs/training.md",
          "specs/proof.md"
        ],
        "isModified": true
      },
      {
        "id": "observability",
        "label": "Observability",
        "sublabel": "Logging, metrics",
        "category": "product",
        "fileCount": 0,
        "position": {
          "x": 580,
          "y": 130,
          "width": 120,
          "height": 80
        },
        "specs": [],
        "isModified": false
      },
      {
        "id": "dashboard",
        "label": "Dashboard",
        "sublabel": "Streamlit app",
        "category": "product",
        "fileCount": 0,
        "position": {
          "x": 20,
          "y": 240,
          "width": 120,
          "height": 80
        },
        "specs": [
          "specs/dashboard.md"
        ],
        "isModified": false
      },
      {
        "id": "tests",
        "label": "Tests",
        "sublabel": "pytest suite",
        "category": "product",
        "fileCount": 0,
        "position": {
          "x": 160,
          "y": 240,
          "width": 120,
          "height": 80
        },
        "specs": [],
        "isModified": false
      },
      {
        "id": "config",
        "label": "Config",
        "sublabel": "Build, deps",
        "category": "infra",
        "fileCount": 0,
        "position": {
          "x": 300,
          "y": 240,
          "width": 120,
          "height": 80
        },
        "specs": [],
        "isModified": false
      },
      {
        "id": "docker",
        "label": "Docker/Infra",
        "sublabel": "Containers",
        "category": "infra",
        "fileCount": 0,
        "position": {
          "x": 440,
          "y": 240,
          "width": 120,
          "height": 80
        },
        "specs": [],
        "isModified": false
      }
    ],
    "arrows": [
      {
        "from": {
          "x": 80,
          "y": 100
        },
        "to": {
          "x": 80,
          "y": 130
        }
      },
      {
        "from": {
          "x": 80,
          "y": 210
        },
        "to": {
          "x": 160,
          "y": 170
        }
      },
      {
        "from": {
          "x": 280,
          "y": 170
        },
        "to": {
          "x": 300,
          "y": 170
        }
      },
      {
        "from": {
          "x": 420,
          "y": 170
        },
        "to": {
          "x": 440,
          "y": 170
        }
      },
      {
        "from": {
          "x": 560,
          "y": 170
        },
        "to": {
          "x": 580,
          "y": 170
        }
      }
    ],
    "rowLabels": [
      {
        "text": "Factory",
        "position": {
          "x": 720,
          "y": 60
        }
      },
      {
        "text": "Product",
        "position": {
          "x": 720,
          "y": 170
        }
      },
      {
        "text": "Infra",
        "position": {
          "x": 720,
          "y": 280
        }
      }
    ]
  },
  "specs": [
    {
      "path": "specs/training.md",
      "icon": "\ud83c\udfaf",
      "description": "Training pipeline: entry point, artifact outputs, evaluation loop"
    },
    {
      "path": "specs/proof.md",
      "icon": "\ud83c\udfc6",
      "description": "Learning &amp; video proof: verification command, video recording points"
    }
  ],
  "scenarios": [
    {
      "name": "Environment Determinism",
      "category": "environment",
      "status": "passing",
      "zone": "environment",
      "detail": {
        "what": "Same seed produces identical observations and rewards",
        "how": "Reset two envs with same seed, compare 10 steps",
        "result": "PASS: determinism verified for 3 seeds"
      }
    },
    {
      "name": "Environment Observation Space",
      "category": "environment",
      "status": "passing",
      "zone": "environment",
      "detail": {
        "what": "Observations are uint8 84x84 arrays",
        "how": "Check dtype, shape, and value range after reset and step",
        "result": "PASS: observations are uint8 (84, 84, 1)"
      }
    },
    {
      "name": "Environment Reward Structure",
      "category": "environment",
      "status": "passing",
      "zone": "environment",
      "detail": {
        "what": "+1/-1 rewards observed, scores in info dict",
        "how": "Run random episode, check reward values and info keys",
        "result": "PASS: rewards correct with agent/opponent scores"
      }
    },
    {
      "name": "Environment Rendering",
      "category": "environment",
      "status": "passing",
      "zone": "environment",
      "detail": {
        "what": "render() returns uint8 RGB frames",
        "how": "Create env with render_mode=rgb_array, check frame properties",
        "result": "PASS: rendering works, non-black frames"
      }
    },
    {
      "name": "Environment Info Dict",
      "category": "environment",
      "status": "passing",
      "zone": "environment",
      "detail": {
        "what": "Info dict contains all 6 required keys",
        "how": "Check rally_length, hits, misses, agent_score, opponent_score, episode_reason in reset and step",
        "result": "PASS: all required keys present"
      }
    },
    {
      "name": "Training Artifacts",
      "category": "training",
      "status": "passing",
      "zone": "training",
      "detail": {
        "what": "Training produces tensorboard, JSONL, checkpoints, eval metrics",
        "how": "Run train_dqn with test config, check artifact directories",
        "result": "PASS: all 4 artifact types present"
      }
    },
    {
      "name": "Evaluation Videos",
      "category": "training",
      "status": "passing",
      "zone": "training",
      "detail": {
        "what": "Training produces MP4 evaluation videos",
        "how": "Run train_dqn, check for non-trivial MP4 files in videos/",
        "result": "PASS: evaluation videos produced (was FAIL before this PR)"
      }
    },
    {
      "name": "verify-learning Command",
      "category": "pipeline",
      "status": "passing",
      "zone": "training",
      "detail": {
        "what": "verify_learning runs without errors",
        "how": "Train then run verify_learning with relaxed thresholds",
        "result": "PASS: command runs successfully"
      }
    },
    {
      "name": "Dashboard Loads",
      "category": "environment",
      "status": "passing",
      "zone": "dashboard",
      "detail": {
        "what": "Dashboard module is importable",
        "how": "Import src/dashboard/app.py via importlib",
        "result": "PASS: dashboard module importable"
      }
    },
    {
      "name": "env-smoke Makefile Target",
      "category": "integration",
      "status": "passing",
      "zone": "environment config",
      "detail": {
        "what": "make env-smoke runs successfully",
        "how": "Run make env-smoke and check exit code",
        "result": "PASS: env-smoke exits 0"
      }
    },
    {
      "name": "Lint and Typecheck",
      "category": "integration",
      "status": "passing",
      "zone": "config",
      "detail": {
        "what": "make lint and make typecheck both pass",
        "how": "Run both targets and check exit codes",
        "result": "PASS: ruff and mypy clean"
      }
    },
    {
      "name": "Full CPU Pipeline",
      "category": "integration",
      "status": "passing",
      "zone": "training",
      "detail": {
        "what": "End-to-end train + evaluate + verify chain completes",
        "how": "Run all three commands sequentially",
        "result": "PASS: full pipeline completes"
      }
    }
  ],
  "whatChanged": {
    "defaultSummary": {
      "infrastructure": "No infrastructure changes in this PR.",
      "product": "Wired the existing <code>record_video()</code> function into the training evaluation loop. Each evaluation checkpoint now produces an MP4 video at <code>artifacts/{run_id}/videos/eval_step_{step}.mp4</code>. Also parameterized <code>frame_stack</code> in <code>record_video()</code> to match the training config instead of hardcoding 4."
    },
    "zoneDetails": [
      {
        "zoneId": "training",
        "title": "Training Pipeline",
        "description": "<strong>train_dqn.py:</strong> Added import of <code>record_video</code> and a call after each evaluation checkpoint. Videos are recorded using the first eval seed and the training config's frame_stack setting.<br><br><strong>record_video.py:</strong> Added <code>frame_stack</code> parameter (default 4 for backward compatibility). The environment wrapper now uses this parameter instead of a hardcoded value, preventing shape mismatches when loading checkpoints trained with different frame_stack values."
      }
    ]
  },
  "adversarialReview": {
    "overallGrade": "A",
    "findings": [
      {
        "file": "src/train/train_dqn.py",
        "grade": "A",
        "zones": "training",
        "notable": "Clean integration \u2014 import + call at the right place",
        "detail": "The <code>record_video()</code> call is placed inside the existing evaluation block, after checkpoint save and metrics evaluation. It correctly passes <code>frame_stack</code> from config and uses the first eval seed. No architectural concerns. The inline <code>import torch</code> at line 83 is pre-existing and not introduced by this PR.",
        "gradeSortOrder": 3
      },
      {
        "file": "src/train/record_video.py",
        "grade": "A",
        "zones": "training",
        "notable": "Backward-compatible parameter addition",
        "detail": "New <code>frame_stack</code> parameter has default value of 4, maintaining backward compatibility with existing callers (CLI entry point doesn't pass it). The function signature change is minimal and correct.",
        "gradeSortOrder": 3
      }
    ]
  },
  "ciPerformance": [
    {
      "name": "factory-self-test",
      "trigger": "(push)",
      "status": "pass",
      "time": "16s",
      "timeSeconds": 16,
      "healthTag": "normal",
      "detail": {
        "coverage": "Factory script validation",
        "gates": "Factory infrastructure integrity",
        "zones": [
          "factory"
        ],
        "specRefs": [],
        "checks": [
          {
            "label": "Lint factory scripts",
            "detail": "Validates factory Python scripts pass ruff",
            "zones": [
              "factory"
            ]
          },
          {
            "label": "Scenario runner smoke",
            "detail": "Verifies run_scenarios.py and compile_feedback.py are importable",
            "zones": [
              "factory"
            ]
          }
        ],
        "notes": null
      }
    },
    {
      "name": "factory-self-test",
      "trigger": "(PR)",
      "status": "pass",
      "time": "17s",
      "timeSeconds": 17,
      "healthTag": "normal",
      "detail": {
        "coverage": "Factory script validation (PR context)",
        "gates": "Factory infrastructure integrity",
        "zones": [
          "factory"
        ],
        "specRefs": [],
        "checks": [
          {
            "label": "Lint factory scripts",
            "detail": "Validates factory Python scripts pass ruff",
            "zones": [
              "factory"
            ]
          }
        ],
        "notes": null
      }
    },
    {
      "name": "validate",
      "trigger": "(push)",
      "status": "pass",
      "time": "6m 9s",
      "timeSeconds": 369,
      "healthTag": "watch",
      "detail": {
        "coverage": "Product code validation",
        "gates": "Gate 1 (lint + typecheck + test), Docker build + smoke",
        "zones": [
          "training",
          "environment",
          "rl-core",
          "agent",
          "config",
          "docker"
        ],
        "specRefs": [
          "specs/system.md"
        ],
        "checks": [
          {
            "label": "Lint (ruff check)",
            "detail": "All Python source passes ruff",
            "zones": [
              "training"
            ]
          },
          {
            "label": "Typecheck (mypy src)",
            "detail": "Strict type checking on all source",
            "zones": [
              "training"
            ]
          },
          {
            "label": "Test (pytest)",
            "detail": "Full test suite including training smoke",
            "zones": [
              "training",
              "tests"
            ]
          }
        ],
        "notes": null
      }
    },
    {
      "name": "validate",
      "trigger": "(PR)",
      "status": "pass",
      "time": "6m 16s",
      "timeSeconds": 376,
      "healthTag": "watch",
      "detail": {
        "coverage": "Product code validation (PR context)",
        "gates": "Gate 1",
        "zones": [
          "training"
        ],
        "specRefs": [],
        "checks": [],
        "notes": null
      }
    },
    {
      "name": "factory-loop",
      "trigger": "(push)",
      "status": "pass",
      "time": "5m 13s",
      "timeSeconds": 313,
      "healthTag": "watch",
      "detail": {
        "coverage": "Factory convergence loop",
        "gates": "Gates 1-3 + feedback compilation",
        "zones": [
          "factory"
        ],
        "specRefs": [],
        "checks": [],
        "notes": null
      }
    }
  ],
  "decisions": [
    {
      "number": 1,
      "title": "Wire existing record_video() rather than rewriting",
      "rationale": "The video recording function was already implemented and tested \u2014 it just wasn't called from the training loop.",
      "body": "Rather than creating a new video recording mechanism or modifying the evaluation flow, we simply imported the existing <code>record_video()</code> function and called it at the same point where checkpoints and metrics are already saved. This is the minimal change that fixes the scenario failure.",
      "zones": "training",
      "files": [
        {
          "path": "src/train/train_dqn.py",
          "change": "Added import and call to record_video() in eval block"
        },
        {
          "path": "src/train/record_video.py",
          "change": "Added frame_stack parameter for config compatibility"
        }
      ],
      "verified": true
    },
    {
      "number": 2,
      "title": "Parameterize frame_stack instead of hardcoding",
      "rationale": "Hardcoded frame_stack=4 caused shape mismatches when training config used a different value.",
      "body": "The original <code>record_video()</code> hardcoded <code>frame_stack=4</code>. When the test suite runs with <code>frame_stack=2</code>, loading a checkpoint into a model with mismatched input channels causes a RuntimeError. Adding the parameter with default=4 maintains backward compatibility while allowing the training loop to pass the correct value.",
      "zones": "training",
      "files": [
        {
          "path": "src/train/record_video.py",
          "change": "Added frame_stack parameter with default=4"
        }
      ],
      "verified": true
    }
  ],
  "convergence": {
    "gates": [
      {
        "name": "Gate 0 \u2014 Adversarial Review",
        "status": "passing",
        "statusText": "CLEAN",
        "summary": "2 files reviewed, both grade A. No critical or warning findings.",
        "detail": "Targeted fix with minimal blast radius. Both changes are straightforward: one import + function call, one parameter addition. No gaming patterns, no architectural concerns."
      },
      {
        "name": "Gate 1 \u2014 Deterministic",
        "status": "passing",
        "statusText": "ALL PASS",
        "summary": "ruff clean, mypy clean, 56 tests pass",
        "detail": "<strong>Lint:</strong> All checks passed<br><strong>Typecheck:</strong> No issues in 24 source files<br><strong>Tests:</strong> 56 passed, including test_training_smoke_cpu which exercises the new video recording path"
      },
      {
        "name": "Gate 2 \u2014 NFR",
        "status": "warning",
        "statusText": "1 WARNING",
        "summary": "1 cosmetic finding (RET504 in minipong.py:124, not in changed files)",
        "detail": "RET504: Unnecessary assignment to <code>rgb</code> before <code>return</code> statement in <code>src/envs/minipong.py:124</code>. Pre-existing, not introduced by this PR. Non-blocking."
      },
      {
        "name": "Gate 3 \u2014 Scenarios",
        "status": "passing",
        "statusText": "12/12 PASS",
        "summary": "100% satisfaction score. All behavioral scenarios pass.",
        "detail": "All 12 holdout scenarios pass, including the previously failing Scenario 7 (Evaluation Produces Videos). Satisfaction trajectory: 42% \u2192 100%."
      }
    ],
    "overall": {
      "status": "passing",
      "statusText": "CONVERGED",
      "summary": "All gates green. 100% scenario satisfaction. Ready for accept/merge.",
      "detail": "This is the first factory crank to converge. The fix is surgical (2 files, +14/-2 lines) and addresses the sole remaining gap between the factory v1 codebase and full scenario coverage."
    }
  },
  "postMergeItems": [
    {
      "priority": "medium",
      "title": "Install Gate 2 tools: <code>radon</code>, <code>vulture</code>, <code>bandit</code>",
      "description": "Gate 2 NFR checks skipped 3 of 4 sub-checks because radon, vulture, and bandit are not installed in the py312 environment. These tools provide complexity analysis, dead code detection, and security scanning.",
      "codeSnippet": null,
      "failureScenario": "Future cranks run Gate 2 with only 1 of 4 checks active, missing complexity or security issues that accumulate.",
      "successScenario": "All 4 NFR checks run on every crank, catching complexity creep and security issues early.",
      "zones": [
        "factory",
        "config"
      ]
    },
    {
      "priority": "medium",
      "title": "Fix <code>requirements.txt</code> CUDA pinning for macOS ARM",
      "description": "The compiled requirements.txt includes CUDA-specific packages (cuda-bindings, nvidia-*) that cannot install on macOS ARM. Currently, dependencies must be installed from requirements.in directly.",
      "codeSnippet": null,
      "failureScenario": "New developers on macOS cannot run <code>make deps</code> and must manually install packages.",
      "successScenario": "Platform-aware requirements (e.g., separate requirements-cpu.txt or environment markers) allow <code>make deps</code> to work on both CUDA and CPU platforms.",
      "zones": [
        "config"
      ]
    },
    {
      "priority": "low",
      "title": "Fix cosmetic RET504 in <code>minipong.py:124</code>",
      "description": "Gate 2 flagged an unnecessary variable assignment before return. Pre-existing, cosmetic.",
      "codeSnippet": {
        "file": "src/envs/minipong.py",
        "lineRange": "line 124",
        "code": "rgb = np.stack([obs] * 3, axis=-1)\nreturn rgb  # could be: return np.stack([obs] * 3, axis=-1)"
      },
      "failureScenario": "Gate 2 continues to report this warning on every crank.",
      "successScenario": "Clean Gate 2 output with zero findings.",
      "zones": [
        "environment"
      ]
    },
    {
      "priority": "low",
      "title": "Scenario 9 (Dashboard) only checks importability",
      "description": "The dashboard scenario verifies the module is importable but does not test rendering, data loading, or any functional behavior. The scenario is passing but coverage is shallow.",
      "codeSnippet": null,
      "failureScenario": "Dashboard breaks silently \u2014 scenario still passes because import succeeds even if rendering fails.",
      "successScenario": "Add a deeper dashboard scenario that loads a test run and verifies chart rendering without errors.",
      "zones": [
        "dashboard"
      ]
    }
  ],
  "factoryHistory": {
    "iterationCount": "3 (factory/v1) + 1 targeted fix",
    "satisfactionTrajectory": "42% \u2192 100%",
    "satisfactionDetail": "Factory v1 achieved 42% satisfaction over 3 Codex iterations (limited by CI environment lacking video/GPU deps). After merging v1 to main, the first orchestrated crank identified the sole remaining gap (missing record_video() call) and fixed it, reaching 100%.",
    "timeline": [
      {
        "title": "Factory v1: 3 Codex iterations",
        "detail": "Codex built the MiniPong environment, DQN agent, training pipeline, dashboard, and test suite over 3 automated iterations.",
        "meta": "Commits: 7ae9e6f..4633ebe",
        "expandedDetail": "The factory-loop CI workflow ran 3 iterations of Codex, achieving 42% satisfaction (5/12 scenarios passing). The 7 failing scenarios were primarily due to the CI environment lacking gymnasium and video recording dependencies, not code defects.",
        "type": "automated",
        "agent": {
          "label": "Codex (factory-loop)",
          "type": "automated"
        }
      },
      {
        "title": "Factory v1 merged to main",
        "detail": "All factory infrastructure and product code merged as a single PR.",
        "meta": "Commit: 4633ebe . Feb 25",
        "expandedDetail": "Merged factory/v1 branch containing: convergence loop infrastructure, Gate 0 agent team, PR review pack skill, code quality standards, holdout isolation, and the full MiniPong RL product code.",
        "type": "intervention",
        "agent": {
          "label": "Human (Joey)",
          "type": "human"
        }
      },
      {
        "title": "Crank v01: Gap analysis + targeted fix",
        "detail": "Claude Code orchestrator identified the video recording gap and applied a 2-file fix.",
        "meta": "Commit: eb850cc . Feb 25",
        "expandedDetail": "Fresh scenario run on main revealed 11/12 passing. Scenario 7 (Evaluation Produces Videos) failed because train_dqn.py never called record_video(). The fix: import record_video and call it at each eval checkpoint, plus add frame_stack parameter for config compatibility. All 12 scenarios now pass.",
        "type": "automated",
        "agent": {
          "label": "Claude Code (orchestrator)",
          "type": "automated"
        }
      }
    ],
    "gateFindings": [
      {
        "phase": "Factory v1 (CI)",
        "gate1": {
          "status": "pass",
          "label": "pass",
          "popover": "Lint, typecheck, and tests all passing in CI"
        },
        "gate2": {
          "status": "advisory",
          "label": "1 finding",
          "popover": "RET504 unnecessary assignment in minipong.py:124"
        },
        "gate3": {
          "status": "fail",
          "label": "5/12",
          "popover": "42% satisfaction. 5 env scenarios failed (missing gymnasium in CI). 2 training scenarios failed (no video recording)."
        },
        "action": "Merged to main despite partial satisfaction \u2014 CI env limitations, not code defects",
        "phasePopover": "3 automated Codex iterations via factory-loop CI workflow"
      },
      {
        "phase": "Crank v01 (local)",
        "gate1": {
          "status": "pass",
          "label": "pass",
          "popover": "ruff clean, mypy clean, 56 tests pass"
        },
        "gate2": {
          "status": "advisory",
          "label": "1 finding",
          "popover": "Same pre-existing RET504 warning"
        },
        "gate3": {
          "status": "pass",
          "label": "12/12",
          "popover": "100% satisfaction. All scenarios pass including the previously failing Evaluation Produces Videos."
        },
        "action": "PR created \u2014 converged at 100%",
        "phasePopover": "Claude Code orchestrated: gap analysis \u2192 targeted fix \u2192 full gate validation"
      }
    ]
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Theme switching (Light / Dark / System)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function initTheme() {
  const stored = localStorage.getItem('pr-pack-theme') || 'system';
  applyTheme(stored);
  updateThemeButtons(stored);
})();

function setTheme(theme) {
  localStorage.setItem('pr-pack-theme', theme);
  applyTheme(theme);
  updateThemeButtons(theme);
}

function applyTheme(theme) {
  if (theme === 'system') {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
  } else {
    document.documentElement.setAttribute('data-theme', theme);
  }
}

function updateThemeButtons(theme) {
  document.querySelectorAll('.theme-toggle button').forEach(btn => {
    btn.classList.toggle('active', btn.getAttribute('data-theme-btn') === theme);
  });
}

window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
  const stored = localStorage.getItem('pr-pack-theme') || 'system';
  if (stored === 'system') applyTheme('system');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Tab switching
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tab) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  event.target.classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CI job detail toggle
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleCIDetail(row) {
  const detail = row.nextElementSibling;
  if (detail && detail.classList.contains('detail-row')) {
    detail.classList.toggle('open');
    row.classList.toggle('ci-open');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Decision card toggle + zone highlighting
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleDecision(card) {
  const wasOpen = card.classList.contains('open');
  document.querySelectorAll('.decision-card').forEach(c => c.classList.remove('open'));
  if (!wasOpen) {
    card.classList.add('open');
    const zones = card.dataset.zones.split(' ');
    highlightZones(zones);
  } else {
    resetZones();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Adversarial review row toggle
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleAdvDetail(row) {
  const detail = row.nextElementSibling;
  if (detail && detail.classList.contains('adv-detail-row')) {
    detail.classList.toggle('open');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Architecture zone highlighting (cross-section filtering)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentActiveZones = null;

function highlightZones(activeZones) {
  currentActiveZones = activeZones;

  // 1. Highlight zones in main and floating diagrams
  ['#arch-diagram', '#arch-floating'].forEach(sel => {
    document.querySelectorAll(sel + ' .zone-box').forEach(box => {
      const zone = box.dataset.zone;
      if (activeZones.includes(zone)) {
        box.classList.remove('dimmed');
        box.classList.add('highlighted');
      } else {
        box.classList.add('dimmed');
        box.classList.remove('highlighted');
      }
    });
  });

  const info = document.getElementById('zone-filter-info');
  info.textContent = 'Showing zones: ' + activeZones.join(', ');
  info.style.display = 'block';

  // 2. Filter adversarial review rows
  let anyMatch = false;
  document.querySelectorAll('.adv-row').forEach(row => {
    const rowZones = row.dataset.zones.split(' ');
    const match = rowZones.some(z => activeZones.includes(z));
    row.classList.toggle('collapsed-row', !match);
    if (match) anyMatch = true;
    const detailRow = row.nextElementSibling;
    if (detailRow && detailRow.classList.contains('adv-detail-row')) {
      if (!match) {
        detailRow.style.display = 'none';
        detailRow.classList.remove('open');
      } else {
        detailRow.style.display = '';
      }
    }
  });
  const noMatch = document.getElementById('adv-no-match');
  if (noMatch) noMatch.classList.toggle('visible', !anyMatch);

  // 3. Filter scenario cards
  document.querySelectorAll('.scenario-card[data-zone]').forEach(card => {
    const cardZones = card.dataset.zone.split(' ');
    const match = cardZones.some(z => activeZones.includes(z));
    card.classList.toggle('zone-dimmed', !match);
    card.classList.toggle('zone-glow', match);
  });

  // 4. Filter What Changed section
  const wcDefault = document.getElementById('wc-default');
  if (wcDefault) wcDefault.style.display = 'none';
  document.querySelectorAll('.wc-zone-detail').forEach(d => {
    d.classList.toggle('active', activeZones.includes(d.dataset.zone));
  });
  if (!document.querySelector('.wc-zone-detail.active') && wcDefault) {
    wcDefault.style.display = '';
  }
}

function resetZones() {
  currentActiveZones = null;
  document.querySelectorAll('.zone-box').forEach(box => box.classList.remove('dimmed', 'highlighted'));
  document.getElementById('zone-filter-info').style.display = 'none';
  document.querySelectorAll('.adv-row').forEach(row => row.classList.remove('collapsed-row'));
  document.querySelectorAll('.adv-detail-row').forEach(row => row.style.display = '');
  const noMatch = document.getElementById('adv-no-match');
  if (noMatch) noMatch.classList.remove('visible');
  document.querySelectorAll('.scenario-card[data-zone]').forEach(card => card.classList.remove('zone-dimmed', 'zone-glow'));
  const wcDefault = document.getElementById('wc-default');
  if (wcDefault) wcDefault.style.display = '';
  document.querySelectorAll('.wc-zone-detail').forEach(d => d.classList.remove('active'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Zone click handlers
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function attachZoneClickHandlers(container) {
  container.querySelectorAll('.zone-box').forEach(box => {
    box.addEventListener('click', (e) => {
      e.stopPropagation();
      const zone = box.dataset.zone;
      if (currentActiveZones && currentActiveZones.length === 1 && currentActiveZones[0] === zone) {
        resetZones();
      } else {
        highlightZones([zone]);
      }
    });
  });
}

// Attach to main diagram
const mainDiagram = document.getElementById('arch-diagram');
if (mainDiagram) {
  attachZoneClickHandlers(mainDiagram);
  mainDiagram.addEventListener('click', (e) => {
    if (e.target.tagName === 'svg' || (e.target.tagName === 'text' && e.target.classList.contains('arch-row-label'))) {
      resetZones();
      document.querySelectorAll('.decision-card').forEach(c => c.classList.remove('open'));
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Architecture view toggle
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setArchView(view, btn) {
  document.querySelectorAll('.arch-toggle').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (view === 'baseline') {
    document.querySelectorAll('.zone-box').forEach(box => { box.style.opacity = '0.25'; });
    document.getElementById('zone-filter-info').textContent = 'Baseline view: before merge';
    document.getElementById('zone-filter-info').style.display = 'block';
  } else {
    document.querySelectorAll('.zone-box').forEach(box => {
      box.style.opacity = '1';
      box.classList.remove('dimmed', 'highlighted');
    });
    document.getElementById('zone-filter-info').style.display = 'none';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Sticky floating architecture diagram
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let floatingDismissed = false;

(function initFloatingDiagram() {
  const archSection = document.getElementById('arch-diagram');
  const floatingContainer = document.getElementById('arch-floating');
  const floatingContent = document.getElementById('arch-floating-content');
  if (!archSection || !floatingContainer) return;

  const svgClone = archSection.cloneNode(true);
  svgClone.removeAttribute('id');
  svgClone.style.width = '100%';
  svgClone.style.maxWidth = 'none';
  floatingContent.appendChild(svgClone);

  attachZoneClickHandlers(floatingContainer);
  svgClone.addEventListener('click', (e) => {
    if (e.target.tagName === 'svg' || (e.target.tagName === 'text' && e.target.classList.contains('arch-row-label'))) {
      resetZones();
    }
  });

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (floatingDismissed) return;
      floatingContainer.classList.toggle('visible', !entry.isIntersecting);
    });
  }, { threshold: 0.1 });
  observer.observe(archSection);
})();

function dismissFloatingDiagram() {
  floatingDismissed = true;
  document.getElementById('arch-floating').classList.remove('visible');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Diff data cache
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let diffDataCache = null;
let diffDataLoading = false;
let diffDataCallbacks = [];

function loadDiffData(cb) {
  if (diffDataCache) { cb(diffDataCache); return; }
  diffDataCallbacks.push(cb);
  if (diffDataLoading) return;
  diffDataLoading = true;
  Promise.resolve(new Response(JSON.stringify(DIFF_DATA_INLINE)))
    .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
    .then(data => {
      diffDataCache = data;
      diffDataCallbacks.forEach(fn => fn(data));
      diffDataCallbacks = [];
    })
    .catch(err => {
      diffDataCallbacks.forEach(fn => fn(null, err));
      diffDataCallbacks = [];
    })
    .finally(() => { diffDataLoading = false; });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// File diff modal
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentFilePath = null;
let currentFileData = null;
let currentView = 'side-by-side';

function openFileModal(path) {
  currentFilePath = path;
  const overlay = document.getElementById('file-modal-overlay');
  const pathEl = document.getElementById('file-modal-path');
  const statsEl = document.getElementById('file-modal-stats');
  const link = document.getElementById('file-modal-github-link');
  const body = document.getElementById('file-modal-body');

  pathEl.textContent = path;
  // Build GitHub URL from DATA if available
  const prUrl = (DATA.header && DATA.header.prUrl) || '';
  const headBranch = (DATA.header && DATA.header.headBranch) || 'main';
  const repoUrl = prUrl.replace(/\/pull\/\d+$/, '');
  link.href = repoUrl + '/blob/' + headBranch + '/' + path;

  document.querySelectorAll('.file-modal-tab').forEach(t => t.classList.remove('active'));
  const activeTab = document.querySelector('.file-modal-tab[data-view="' + currentView + '"]');
  if (activeTab) activeTab.classList.add('active');

  statsEl.innerHTML = '';
  body.innerHTML = '<div class="diff-loading">Loading diff data&hellip;</div>';
  overlay.classList.add('visible');
  document.body.style.overflow = 'hidden';

  loadDiffData((data, err) => {
    if (err || !data) {
      body.innerHTML = '<div class="diff-error">Failed to load diff data.</div>';
      return;
    }
    currentFileData = data.files[path] || null;
    if (!currentFileData) {
      // Check for embedded reference file content (spec files, etc.)
      var refContent = (typeof REFERENCE_FILES !== 'undefined') && REFERENCE_FILES[path];
      if (refContent) {
        currentFileData = { raw: refContent, diff: '', additions: 0, deletions: 0 };
        statsEl.innerHTML = '<span style="color:var(--text-secondary);font-size:12px">' +
          'Reference file &mdash; not modified in this PR</span>';
        // Default to raw view for reference files
        currentView = 'raw';
        document.querySelectorAll('.file-modal-tab').forEach(function(t) { t.classList.remove('active'); });
        var rawTab = document.querySelector('.file-modal-tab[data-view="raw"]');
        if (rawTab) rawTab.classList.add('active');
        renderDiffView('raw');
        return;
      }
      var ghLink = link.href;
      body.innerHTML = '<div style="text-align:center;padding:40px 20px">' +
        '<div style="font-size:14px;color:var(--text-secondary);margin-bottom:16px">' +
        'This file was not modified in this PR.</div>' +
        '<a href="' + escapeHtml(ghLink) + '" target="_blank" ' +
        'style="display:inline-block;padding:10px 24px;background:var(--blue);color:white;' +
        'border-radius:8px;text-decoration:none;font-weight:600;font-size:14px">' +
        'View on GitHub &rarr;</a></div>';
      return;
    }
    statsEl.innerHTML = '<span class="fm-add">+' + currentFileData.additions + '</span> <span class="fm-del">-' + currentFileData.deletions + '</span>';
    renderDiffView(currentView);
  });
}

function closeFileModal() {
  document.getElementById('file-modal-overlay').classList.remove('visible');
  document.body.style.overflow = '';
  currentFilePath = null;
  currentFileData = null;
}

function setFileModalTab(btn, view) {
  document.querySelectorAll('.file-modal-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  currentView = view;
  if (currentFileData) renderDiffView(view);
}

function escapeHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

function renderDiffView(view) {
  const body = document.getElementById('file-modal-body');
  if (!currentFileData) return;
  if (view === 'raw') renderRawView(body);
  else if (view === 'integrated') renderUnifiedView(body);
  else renderSplitView(body);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Syntax highlighting (lightweight, no deps)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function detectLanguage(filePath) {
  if (!filePath) return 'text';
  const ext = filePath.split('.').pop().toLowerCase();
  const map = {
    'py': 'python', 'yaml': 'yaml', 'yml': 'yaml', 'md': 'markdown',
    'sh': 'shell', 'bash': 'shell', 'js': 'javascript', 'ts': 'javascript',
    'jsx': 'javascript', 'tsx': 'javascript',
  };
  return map[ext] || 'text';
}

function highlightCode(text, language) {
  if (language === 'text') return text;

  if (language === 'python') {
    text = text.replace(/(&#39;&#39;&#39;[\s\S]*?&#39;&#39;&#39;|&quot;&quot;&quot;[\s\S]*?&quot;&quot;&quot;)/g, '<span style="color:#ce9178">$1</span>');
    text = text.replace(/((?<!\\)&#39;(?:[^\\]|\\.)*?&#39;|(?<!\\)&quot;(?:[^\\]|\\.)*?&quot;)/g, function(m) {
      if (m.indexOf('style=') !== -1) return m;
      return '<span style="color:#ce9178">' + m + '</span>';
    });
    text = text.replace(/(#[^\n]*)/g, function(m) {
      if (m.indexOf('style=') !== -1) return m;
      return '<span style="color:#6a9955">' + m + '</span>';
    });
    text = text.replace(/(@\w+)/g, '<span style="color:#dcdcaa">$1</span>');
    text = text.replace(/\b(True|False|None)\b/g, '<span style="color:#569cd6">$1</span>');
    text = text.replace(/\b(def|class|import|from|if|else|elif|for|while|return|yield|with|as|try|except|finally|raise|not|and|or|in|is|pass|break|continue|lambda|global|nonlocal|async|await|self)\b/g, function(m) {
      return '<span style="color:#c586c0">' + m + '</span>';
    });
    text = text.replace(/\b(\d+\.?\d*(?:e[+-]?\d+)?)\b/g, '<span style="color:#b5cea8">$1</span>');
    return text;
  }

  if (language === 'yaml') {
    text = text.replace(/(#[^\n]*)/g, '<span style="color:#6a9955">$1</span>');
    text = text.replace(/\b(true|false|yes|no|on|off)\b/gi, '<span style="color:#569cd6">$1</span>');
    text = text.replace(/^(\s*)([\w][\w.-]*?)(:)/gm, '$1<span style="color:#9cdcfe">$2</span>$3');
    text = text.replace(/(&#39;[^]*?&#39;|&quot;[^]*?&quot;)/g, function(m) {
      if (m.indexOf('style=') !== -1) return m;
      return '<span style="color:#ce9178">' + m + '</span>';
    });
    return text;
  }

  if (language === 'markdown') {
    text = text.replace(/^(#{1,6}\s.*)$/gm, '<span style="color:#569cd6">$1</span>');
    text = text.replace(/(\*\*[^*]+\*\*)/g, '<span style="color:#dcdcaa;font-weight:bold">$1</span>');
    text = text.replace(/(`[^`]+`)/g, '<span style="color:#ce9178">$1</span>');
    return text;
  }

  if (language === 'shell') {
    text = text.replace(/(#[^\n]*)/g, '<span style="color:#6a9955">$1</span>');
    text = text.replace(/(&#39;[^]*?&#39;|&quot;[^]*?&quot;)/g, function(m) {
      if (m.indexOf('style=') !== -1) return m;
      return '<span style="color:#ce9178">' + m + '</span>';
    });
    text = text.replace(/(\$\{?\w+\}?)/g, '<span style="color:#9cdcfe">$1</span>');
    text = text.replace(/\b(if|then|else|elif|fi|for|do|done|while|case|esac|echo|export|set|source|local|readonly|declare|unset|shift|eval|exec|trap|exit|return|function)\b/g, '<span style="color:#c586c0">$1</span>');
    return text;
  }

  if (language === 'javascript') {
    text = text.replace(/(&#39;[^]*?&#39;|&quot;[^]*?&quot;|`[^]*?`)/g, function(m) {
      if (m.indexOf('style=') !== -1) return m;
      return '<span style="color:#ce9178">' + m + '</span>';
    });
    text = text.replace(/(\/\/[^\n]*)/g, function(m) {
      if (m.indexOf('style=') !== -1) return m;
      return '<span style="color:#6a9955">' + m + '</span>';
    });
    text = text.replace(/\b(true|false|null|undefined|NaN|Infinity)\b/g, '<span style="color:#569cd6">$1</span>');
    text = text.replace(/\b(const|let|var|function|class|if|else|for|while|do|switch|case|break|continue|return|import|export|from|default|new|this|typeof|instanceof|in|of|try|catch|finally|throw|async|await|yield)\b/g, '<span style="color:#c586c0">$1</span>');
    return text;
  }

  return text;
}

// ‚îÄ‚îÄ Raw file view ‚îÄ‚îÄ
function renderRawView(container) {
  const raw = currentFileData.raw || '';
  if (!raw) {
    container.innerHTML = '<div class="diff-error">File was deleted or is binary.</div>';
    return;
  }
  const lang = detectLanguage(currentFilePath);
  const lines = raw.split('\n');
  let html = '<div class="diff-view diff-raw"><table>';
  for (let i = 0; i < lines.length; i++) {
    const escaped = escapeHtml(lines[i]);
    const highlighted = highlightCode(escaped, lang);
    html += '<tr><td class="diff-ln">' + (i + 1) + '</td><td>' + highlighted + '</td></tr>';
  }
  html += '</table></div>';
  container.innerHTML = html;
}

// ‚îÄ‚îÄ Unified (integrated) diff view ‚îÄ‚îÄ
function renderUnifiedView(container) {
  const diff = currentFileData.diff || '';
  if (!diff) { container.innerHTML = '<div class="diff-error">No diff available.</div>'; return; }
  const lines = diff.split('\n');
  let html = '<div class="diff-view"><table class="diff-unified">';
  let oldLn = 0, newLn = 0;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    if (line.startsWith('diff --git') || line.startsWith('index ') || line.startsWith('---') || line.startsWith('+++')) continue;
    if (isDiffMetaLine(line)) continue;
    if (line.startsWith('@@')) {
      const m = line.match(/@@ -(\d+)(?:,\d+)? \+(\d+)(?:,\d+)? @@(.*)/);
      if (m) { oldLn = parseInt(m[1]); newLn = parseInt(m[2]); html += '<tr><td class="diff-ln" colspan="2"></td><td class="diff-hunk">' + escapeHtml(line) + '</td></tr>'; }
      continue;
    }
    if (line.startsWith('+')) { html += '<tr class="diff-add"><td class="diff-ln"></td><td class="diff-ln">' + newLn + '</td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; newLn++; continue; }
    if (line.startsWith('-')) { html += '<tr class="diff-del"><td class="diff-ln">' + oldLn + '</td><td class="diff-ln"></td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; oldLn++; continue; }
    if (line.startsWith(' ') || line === '') { html += '<tr class="diff-ctx"><td class="diff-ln">' + oldLn + '</td><td class="diff-ln">' + newLn + '</td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; oldLn++; newLn++; }
  }
  html += '</table></div>';
  container.innerHTML = html;
}

const DIFF_SKIP_PATTERNS = [/^new file mode/, /^deleted file mode/, /^old mode/, /^new mode/, /^similarity index/, /^rename from/, /^rename to/, /^Binary files/];
function isDiffMetaLine(line) { return DIFF_SKIP_PATTERNS.some(p => p.test(line)); }

// ‚îÄ‚îÄ Side-by-side diff view ‚îÄ‚îÄ
function renderSplitView(container) {
  const diff = currentFileData.diff || '';
  if (!diff) { container.innerHTML = '<div class="diff-error">No diff available.</div>'; return; }

  const isNewFile = currentFileData.status === 'added' || (currentFileData.deletions === 0 && currentFileData.additions > 0);
  const isDeletedFile = currentFileData.status === 'deleted' || (currentFileData.additions === 0 && currentFileData.deletions > 0);

  if (isNewFile || isDeletedFile) {
    const bannerClass = isNewFile ? 'diff-new-file-banner' : 'diff-deleted-file-banner';
    const bannerText = isNewFile ? 'New file &mdash; showing additions' : 'Deleted file &mdash; showing deletions';
    const lines = diff.split('\n');
    let html = '<div class="' + bannerClass + '">' + bannerText + '</div><div class="diff-view diff-split-wrapper"><table class="diff-unified">';
    let ln = 0;
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      if (line.startsWith('diff --git') || line.startsWith('index ') || line.startsWith('---') || line.startsWith('+++')) continue;
      if (isDiffMetaLine(line)) continue;
      if (line.startsWith('@@')) { const m = line.match(/@@ -(\d+)(?:,\d+)? \+(\d+)(?:,\d+)? @@(.*)/); if (m) { ln = isNewFile ? parseInt(m[2]) : parseInt(m[1]); html += '<tr><td class="diff-ln"></td><td class="diff-hunk">' + escapeHtml(line) + '</td></tr>'; } continue; }
      if (isNewFile && line.startsWith('+')) { html += '<tr class="diff-add"><td class="diff-ln">' + ln + '</td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; ln++; }
      else if (isDeletedFile && line.startsWith('-')) { html += '<tr class="diff-del"><td class="diff-ln">' + ln + '</td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; ln++; }
      else if (line.startsWith(' ') || line === '') { html += '<tr class="diff-ctx"><td class="diff-ln">' + ln + '</td><td>' + escapeHtml(line.slice(1)) + '</td></tr>'; ln++; }
    }
    html += '</table></div>';
    container.innerHTML = html;
    return;
  }

  // Parse unified diff into side-by-side pairs
  const lines = diff.split('\n');
  const pairs = [];
  let oldLn = 0, newLn = 0;
  const addBuffer = [], delBuffer = [];

  function flushBuffers() {
    const max = Math.max(addBuffer.length, delBuffer.length);
    for (let j = 0; j < max; j++) {
      const hasOld = j < delBuffer.length, hasNew = j < addBuffer.length;
      pairs.push({ type: hasOld && hasNew ? 'change' : hasNew ? 'add' : 'del', oldLn: hasOld ? delBuffer[j].ln : null, newLn: hasNew ? addBuffer[j].ln : null, oldText: hasOld ? delBuffer[j].text : '', newText: hasNew ? addBuffer[j].text : '' });
    }
    addBuffer.length = 0; delBuffer.length = 0;
  }

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    if (line.startsWith('diff --git') || line.startsWith('index ') || line.startsWith('---') || line.startsWith('+++')) continue;
    if (isDiffMetaLine(line)) continue;
    if (line.startsWith('@@')) { flushBuffers(); const m = line.match(/@@ -(\d+)(?:,\d+)? \+(\d+)(?:,\d+)? @@(.*)/); if (m) { oldLn = parseInt(m[1]); newLn = parseInt(m[2]); pairs.push({ type: 'hunk', hunkText: line }); } continue; }
    if (line.startsWith('+')) { addBuffer.push({ ln: newLn, text: line.slice(1) }); newLn++; }
    else if (line.startsWith('-')) { delBuffer.push({ ln: oldLn, text: line.slice(1) }); oldLn++; }
    else { flushBuffers(); pairs.push({ type: 'ctx', oldLn: oldLn, newLn: newLn, oldText: line.slice(1), newText: line.slice(1) }); oldLn++; newLn++; }
  }
  flushBuffers();

  let html = '<div class="diff-view diff-split-wrapper"><table class="diff-split">';
  for (const p of pairs) {
    if (p.type === 'hunk') { html += '<tr class="diff-hunk"><td colspan="5" style="padding:4px 8px;background:rgba(56,139,253,0.08);color:#58a6ff;font-style:italic;font-size:11px">' + escapeHtml(p.hunkText) + '</td></tr>'; continue; }
    const leftCls = p.type === 'del' || p.type === 'change' ? ' diff-del' : p.type === 'add' ? ' diff-empty' : ' diff-ctx';
    const rightCls = p.type === 'add' || p.type === 'change' ? ' diff-add' : p.type === 'del' ? ' diff-empty' : ' diff-ctx';
    html += '<tr><td class="diff-ln' + leftCls + '">' + (p.oldLn != null ? p.oldLn : '') + '</td><td class="diff-code-left' + leftCls + '">' + (p.type === 'add' ? '' : escapeHtml(p.oldText)) + '</td><td class="diff-sep"></td><td class="diff-ln' + rightCls + '">' + (p.newLn != null ? p.newLn : '') + '</td><td class="diff-code-right' + rightCls + '">' + (p.type === 'del' ? '' : escapeHtml(p.newText)) + '</td></tr>';
  }
  html += '</table></div>';
  container.innerHTML = html;
}

// Close modal on Escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') { closeFileModal(); hideGatePopover(); }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Gate findings popover
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showGatePopover(event, text) {
  event.stopPropagation();
  const popover = document.getElementById('gate-popover');
  popover.textContent = '';
  const lines = text.split('\\n');
  lines.forEach((line, i) => {
    popover.appendChild(document.createTextNode(line));
    if (i < lines.length - 1) popover.appendChild(document.createElement('br'));
  });
  const rect = event.target.getBoundingClientRect();
  popover.style.left = rect.left + 'px';
  popover.style.top = (rect.bottom + 6) + 'px';
  popover.classList.add('visible');
  setTimeout(() => { hideGatePopover(); }, 5000);
}

function hideGatePopover() {
  document.getElementById('gate-popover').classList.remove('visible');
}

document.addEventListener('click', (e) => {
  if (!e.target.classList.contains('gate-clickable')) hideGatePopover();
});
</script>
</body>
</html>
